cscope 15 $HOME/workspace_luma/DSA_project/linux-6.6.38/odinfs-module-6.6.38/nova               0000586229
	@balloc.c

26 
	~<löux/fs.h
>

27 
	~<löux/bô›s.h
>

28 
	~"nova.h
"

29 
	~"öode.h
"

31 
	$nova_Æloc_block_‰ì_li°s
(
su≥r_block
 *
sb
)

33 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

34 
‰ì_li°
 *free_list;

35 
i
;

37 
sbi
->
‰ì_li°s
 = 
	`kˇŒoc
(sbi->
˝us
, (
‰ì_li°
),

38 
GFP_KERNEL
);

40 i‡(!
sbi
->
‰ì_li°s
)

41  -
ENOMEM
;

43 
i
 = 0; i < 
sbi
->
˝us
; i++) {

44 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
i
);

45 
‰ì_li°
->
block_‰ì_åì
 = 
RB_ROOT
;

46 
	`•ö_lock_öô
(&
‰ì_li°
->
s_lock
);

47 
‰ì_li°
->
ödex
 = 
i
;

51 
	}
}

53 
	$nova_dñëe_‰ì_li°s
(
su≥r_block
 *
sb
)

55 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

58 
	`k‰ì
(
sbi
->
‰ì_li°s
);

59 
sbi
->
‰ì_li°s
 = 
NULL
;

60 
	}
}

62 
	$nova_d©a_csum_öô_‰ì_li°
(
su≥r_block
 *
sb
,

63 
‰ì_li°
 *free_list)

65 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

66 
d©a_csum_blocks
;

72 
d©a_csum_blocks
 = ((
sbi
->
öôsize
 >> 
NOVA_STRIPE_SHIFT
)

73 * 
NOVA_DATA_CSUM_LEN
Ë>> 
PAGE_SHIFT
;

74 
‰ì_li°
->
csum_°¨t
 = fªe_li°->
block_°¨t
;

75 
‰ì_li°
->
block_°¨t
 +
d©a_csum_blocks
 / 
sbi
->
˝us
;

76 i‡(
d©a_csum_blocks
 % 
sbi
->
˝us
)

77 
‰ì_li°
->
block_°¨t
++;

79 
‰ì_li°
->
num_csum_blocks
 =

80 
‰ì_li°
->
block_°¨t
 - fªe_li°->
csum_°¨t
;

82 
‰ì_li°
->
ª∂iˇ_csum_°¨t
 = fªe_li°->
block_íd
 + 1 -

83 
‰ì_li°
->
num_csum_blocks
;

84 
‰ì_li°
->
block_íd
 -‰ì_li°->
num_csum_blocks
;

87 
	}
}

90 
	$nova_d©a_∑rôy_öô_‰ì_li°
(
su≥r_block
 *
sb
,

91 
‰ì_li°
 *free_list)

93 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

94 
blocksize
, 
tŸÆ_blocks
, 
∑rôy_blocks
;

100 
blocksize
 = 
sb
->
s_blocksize
;

101 
tŸÆ_blocks
 = 
sbi
->
öôsize
 / 
blocksize
;

102 
∑rôy_blocks
 = 
tŸÆ_blocks
 / (
blocksize
 / 
NOVA_STRIPE_SIZE
 + 1);

103 i‡(
tŸÆ_blocks
 % (
blocksize
 / 
NOVA_STRIPE_SIZE
 + 1))

104 
∑rôy_blocks
++;

106 
‰ì_li°
->
∑rôy_°¨t
 = fªe_li°->
block_°¨t
;

107 
‰ì_li°
->
block_°¨t
 +
∑rôy_blocks
 / 
sbi
->
˝us
;

108 i‡(
∑rôy_blocks
 % 
sbi
->
˝us
)

109 
‰ì_li°
->
block_°¨t
++;

111 
‰ì_li°
->
num_∑rôy_blocks
 =

112 
‰ì_li°
->
block_°¨t
 - fªe_li°->
∑rôy_°¨t
;

114 
‰ì_li°
->
ª∂iˇ_∑rôy_°¨t
 = fªe_li°->
block_íd
 + 1 -

115 
‰ì_li°
->
num_∑rôy_blocks
;

118 
	}
}

123 
	$nova_öô_‰ì_li°
(
su≥r_block
 *
sb
,

124 
‰ì_li°
 *‰ì_li°, 
ödex
)

126 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

127 
≥r_li°_blocks
;

129 
≥r_li°_blocks
 = 
sbi
->
num_blocks
 / sbi->
˝us
;

131 
‰ì_li°
->
block_°¨t
 = 
≥r_li°_blocks
 * 
ödex
;

132 
‰ì_li°
->
block_íd
 = fªe_li°->
block_°¨t
 +

133 
≥r_li°_blocks
 - 1;

134 i‡(
ödex
 == 0)

135 
‰ì_li°
->
block_°¨t
 +
sbi
->
hód_ª£rved_blocks
;

136 i‡(
ödex
 =
sbi
->
˝us
 - 1)

137 
‰ì_li°
->
block_íd
 -
sbi
->
èû_ª£rved_blocks
;

139 
	`nova_d©a_csum_öô_‰ì_li°
(
sb
, 
‰ì_li°
);

140 
	`nova_d©a_∑rôy_öô_‰ì_li°
(
sb
, 
‰ì_li°
);

141 
	}
}

143 
nova_ønge_node
 *
	$nova_Æloc_blocknode
(
su≥r_block
 *
sb
)

145  
	`nova_Æloc_ønge_node
(
sb
);

146 
	}
}

148 
	$nova_‰ì_blocknode
(
nova_ønge_node
 *
node
)

150 
	`nova_‰ì_ønge_node
(
node
);

151 
	}
}

154 
	$nova_öô_blockm≠
(
su≥r_block
 *
sb
, 
ªcovîy
)

156 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

157 
rb_roŸ
 *
åì
;

158 
nova_ønge_node
 *
blknode
;

159 
‰ì_li°
 *free_list;

160 
i
;

161 
ªt
;

164 
sbi
->
≥r_li°_blocks
 = sbi->
num_blocks
 / sbi->
˝us
;

165 
i
 = 0; i < 
sbi
->
˝us
; i++) {

166 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
i
);

167 
åì
 = &(
‰ì_li°
->
block_‰ì_åì
);

168 
	`nova_öô_‰ì_li°
(
sb
, 
‰ì_li°
, 
i
);

171 i‡(
ªcovîy
 == 0) {

172 
‰ì_li°
->
num_‰ì_blocks
 = fªe_li°->
block_íd
 -

173 
‰ì_li°
->
block_°¨t
 + 1;

175 
blknode
 = 
	`nova_Æloc_blocknode
(
sb
);

176 i‡(
blknode
 =
NULL
)

177 
	`BUG
();

178 
blknode
->
ønge_low
 = 
‰ì_li°
->
block_°¨t
;

179 
blknode
->
ønge_high
 = 
‰ì_li°
->
block_íd
;

180 
	`nova_upd©e_ønge_node_checksum
(
blknode
);

181 
ªt
 = 
	`nova_ö£π_blockåì
(
åì
, 
blknode
);

182 i‡(
ªt
) {

183 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

184 
	`nova_‰ì_blocknode
(
blknode
);

187 
‰ì_li°
->
fú°_node
 = 
blknode
;

188 
‰ì_li°
->
œ°_node
 = 
blknode
;

189 
‰ì_li°
->
num_blocknode
 = 1;

192 
	`nova_dbgv
("%s: freeÜist %d: block start %lu,Énd %lu, "

194 
__func__
, 
i
,

195 
‰ì_li°
->
block_°¨t
,

196 
‰ì_li°
->
block_íd
,

197 
‰ì_li°
->
num_‰ì_blocks
);

199 
	}
}

201 
ölöe
 
	$nova_rbåì_com∑ª_øngíode
(
nova_ønge_node
 *
cuº
,

202 
key
, 
node_ty≥
 
ty≥
)

204 i‡(
ty≥
 =
NODE_DIR
) {

205 i‡(
key
 < 
cuº
->
hash
)

207 i‡(
key
 > 
cuº
->
hash
)

213 i‡(
key
 < 
cuº
->
ønge_low
)

215 i‡(
key
 > 
cuº
->
ønge_high
)

219 
	}
}

221 
	$nova_föd_ønge_node
(
rb_roŸ
 *
åì
, 
key
,

222 
node_ty≥
 
ty≥
, 
nova_ønge_node
 **
ªt_node
)

224 
nova_ønge_node
 *
cuº
 = 
NULL
;

225 
rb_node
 *
ãmp
;

226 
compVÆ
;

227 
ªt
 = 0;

229 
ãmp
 = 
åì
->
rb_node
;

231 
ãmp
) {

232 
cuº
 = 
	`c⁄èöî_of
(
ãmp
, 
nova_ønge_node
, 
node
);

233 
compVÆ
 = 
	`nova_rbåì_com∑ª_øngíode
(
cuº
, 
key
, 
ty≥
);

235 i‡(
compVÆ
 == -1) {

236 
ãmp
 =Åemp->
rb_À·
;

237 } i‡(
compVÆ
 == 1) {

238 
ãmp
 =Åemp->
rb_right
;

240 
ªt
 = 1;

245 i‡(
cuº
 && !
	`nova_ønge_node_checksum_ok
(curr)) {

246 
	`nova_dbg
("%s: cuº faûed\n", 
__func__
);

250 *
ªt_node
 = 
cuº
;

251  
ªt
;

252 
	}
}

255 
	$nova_ö£π_ønge_node
(
rb_roŸ
 *
åì
,

256 
nova_ønge_node
 *
√w_node
, 
node_ty≥
 
ty≥
)

258 
nova_ønge_node
 *
cuº
;

259 
rb_node
 **
ãmp
, *
∑ª¡
;

260 
compVÆ
;

262 
ãmp
 = &(
åì
->
rb_node
);

263 
∑ª¡
 = 
NULL
;

265 *
ãmp
) {

266 
cuº
 = 
	`c⁄èöî_of
(*
ãmp
, 
nova_ønge_node
, 
node
);

267 
compVÆ
 = 
	`nova_rbåì_com∑ª_øngíode
(
cuº
,

268 
√w_node
->
ønge_low
, 
ty≥
);

269 
∑ª¡
 = *
ãmp
;

271 i‡(
compVÆ
 == -1) {

272 
ãmp
 = &((*ãmp)->
rb_À·
);

273 } i‡(
compVÆ
 == 1) {

274 
ãmp
 = &((*ãmp)->
rb_right
);

276 
	`nova_dbg
("%s:Åype %dÉntry %lu - %luálreadyÉxists: "

278 
__func__
, 
ty≥
, 
√w_node
->
ønge_low
,

279 
√w_node
->
ønge_high
, 
cuº
->
ønge_low
,

280 
cuº
->
ønge_high
);

281  -
EINVAL
;

285 
	`rb_lök_node
(&
√w_node
->
node
, 
∑ª¡
, 
ãmp
);

286 
	`rb_ö£π_cﬁ‹
(&
√w_node
->
node
, 
åì
);

289 
	}
}

291 
	$nova_de°roy_ønge_node_åì
(
su≥r_block
 *
sb
,

292 
rb_roŸ
 *
åì
)

294 
nova_ønge_node
 *
cuº
;

295 
rb_node
 *
ãmp
;

297 
ãmp
 = 
	`rb_fú°
(
åì
);

298 
ãmp
) {

299 
cuº
 = 
	`c⁄èöî_of
(
ãmp
, 
nova_ønge_node
, 
node
);

300 
ãmp
 = 
	`rb_√xt
(temp);

301 
	`rb_îa£
(&
cuº
->
node
, 
åì
);

302 
	`nova_‰ì_ønge_node
(
cuº
);

304 
	}
}

306 
	$nova_ö£π_blockåì
(
rb_roŸ
 *
åì
,

307 
nova_ønge_node
 *
√w_node
)

309 
ªt
;

311 
ªt
 = 
	`nova_ö£π_ønge_node
(
åì
, 
√w_node
, 
NODE_BLOCK
);

312 i‡(
ªt
)

313 
	`nova_dbg
("ERROR: %†Áûed %d\n", 
__func__
, 
ªt
);

315  
ªt
;

316 
	}
}

320 
	$nova_föd_‰ì_¶Ÿ
(
rb_roŸ
 *
åì
, 
ønge_low
,

321 
ønge_high
, 
nova_ønge_node
 **
¥ev
,

322 
nova_ønge_node
 **
√xt
)

324 
nova_ønge_node
 *
ªt_node
 = 
NULL
;

325 
rb_node
 *
tmp
;

326 
check_¥ev
 = 0, 
check_√xt
 = 0;

327 
ªt
;

329 
ªt
 = 
	`nova_föd_ønge_node
(
åì
, 
ønge_low
, 
NODE_BLOCK
, &
ªt_node
);

330 i‡(
ªt
) {

331 
	`nova_dbg
("%s ERROR: %lu - %luálready in freeÜist\n",

332 
__func__
, 
ønge_low
, 
ønge_high
);

333  -
EINVAL
;

336 i‡(!
ªt_node
) {

337 *
¥ev
 = *
√xt
 = 
NULL
;

338 } i‡(
ªt_node
->
ønge_high
 < 
ønge_low
) {

339 *
¥ev
 = 
ªt_node
;

340 
tmp
 = 
	`rb_√xt
(&
ªt_node
->
node
);

341 i‡(
tmp
) {

342 *
√xt
 = 
	`c⁄èöî_of
(
tmp
, 
nova_ønge_node
, 
node
);

343 
check_√xt
 = 1;

345 *
√xt
 = 
NULL
;

347 } i‡(
ªt_node
->
ønge_low
 > 
ønge_high
) {

348 *
√xt
 = 
ªt_node
;

349 
tmp
 = 
	`rb_¥ev
(&
ªt_node
->
node
);

350 i‡(
tmp
) {

351 *
¥ev
 = 
	`c⁄èöî_of
(
tmp
, 
nova_ønge_node
, 
node
);

352 
check_¥ev
 = 1;

354 *
¥ev
 = 
NULL
;

357 
	`nova_dbg
("%s ERROR: %lu - %lu overlaps withÉxisting "

359 
__func__
, 
ønge_low
, 
ønge_high
, 
ªt_node
->range_low,

360 
ªt_node
->
ønge_high
);

361  -
EINVAL
;

364 i‡(
check_¥ev
 && !
	`nova_ønge_node_checksum_ok
(*
¥ev
)) {

365 
	`nova_dbg
("%s:Öªv faûed\n", 
__func__
);

366  -
EIO
;

369 i‡(
check_√xt
 && !
	`nova_ønge_node_checksum_ok
(*
√xt
)) {

370 
	`nova_dbg
("%s:ÇexàÁûed\n", 
__func__
);

371  -
EIO
;

375 
	}
}

377 
	$nova_‰ì_blocks
(
su≥r_block
 *
sb
, 
blockƒ
,

378 
num
, 
bty≥
, 
log_∑ge
)

380 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

381 
rb_roŸ
 *
åì
;

382 
block_low
;

383 
block_high
;

384 
num_blocks
 = 0;

385 
nova_ønge_node
 *
¥ev
 = 
NULL
;

386 
nova_ønge_node
 *
√xt
 = 
NULL
;

387 
nova_ønge_node
 *
cuº_node
;

388 
‰ì_li°
 *free_list;

389 
˝uid
;

390 
√w_node_u£d
 = 0;

391 
ªt
;

392 
	`INIT_TIMING
(
‰ì_time
);

394 i‡(
num
 <= 0) {

395 
	`nova_dbg
("%†ERROR: fªê%d\n", 
__func__
, 
num
);

396  -
EINVAL
;

399 
	`NOVA_START_TIMING
(
‰ì_blocks_t
, 
‰ì_time
);

400 
˝uid
 = 
blockƒ
 / 
sbi
->
≥r_li°_blocks
;

403 
cuº_node
 = 
	`nova_Æloc_blocknode
(
sb
);

404 i‡(
cuº_node
 =
NULL
) {

406 
	`NOVA_END_TIMING
(
‰ì_blocks_t
, 
‰ì_time
);

407  -
ENOMEM
;

410 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
˝uid
);

411 
	`•ö_lock
(&
‰ì_li°
->
s_lock
);

413 
åì
 = &(
‰ì_li°
->
block_‰ì_åì
);

415 
num_blocks
 = 
	`nova_gë_numblocks
(
bty≥
Ë* 
num
;

416 
block_low
 = 
blockƒ
;

417 
block_high
 = 
blockƒ
 + 
num_blocks
 - 1;

419 
	`nova_dbgv
("Fªe: %lu - %lu\n", 
block_low
, 
block_high
);

421 i‡(
blockƒ
 < 
‰ì_li°
->
block_°¨t
 ||

422 
blockƒ
 + 
num
 > 
‰ì_li°
->
block_íd
 + 1) {

423 
	`nova_îr
(
sb
, "free blocks %luÅo %lu, freeÜist %d, "

425 
blockƒ
, blockƒ + 
num
 - 1,

426 
‰ì_li°
->
ödex
,

427 
‰ì_li°
->
block_°¨t
,

428 
‰ì_li°
->
block_íd
);

429 
ªt
 = -
EIO
;

430 
out
;

433 
ªt
 = 
	`nova_föd_‰ì_¶Ÿ
(
åì
, 
block_low
,

434 
block_high
, &
¥ev
, &
√xt
);

436 i‡(
ªt
) {

437 
	`nova_dbg
("%s: föd fªê¶Ÿ faû: %d\n", 
__func__
, 
ªt
);

438 
out
;

441 i‡(
¥ev
 && 
√xt
 && (
block_low
 =¥ev->
ønge_high
 + 1) &&

442 (
block_high
 + 1 =
√xt
->
ønge_low
)) {

444 
	`rb_îa£
(&
√xt
->
node
, 
åì
);

445 
‰ì_li°
->
num_blocknode
--;

446 
¥ev
->
ønge_high
 = 
√xt
->range_high;

447 
	`nova_upd©e_ønge_node_checksum
(
¥ev
);

448 i‡(
‰ì_li°
->
œ°_node
 =
√xt
)

449 
‰ì_li°
->
œ°_node
 = 
¥ev
;

450 
	`nova_‰ì_blocknode
(
√xt
);

451 
block_found
;

453 i‡(
¥ev
 && (
block_low
 =¥ev->
ønge_high
 + 1)) {

455 
¥ev
->
ønge_high
 +
num_blocks
;

456 
	`nova_upd©e_ønge_node_checksum
(
¥ev
);

457 
block_found
;

459 i‡(
√xt
 && (
block_high
 + 1 =√xt->
ønge_low
)) {

461 
√xt
->
ønge_low
 -
num_blocks
;

462 
	`nova_upd©e_ønge_node_checksum
(
√xt
);

463 
block_found
;

467 
cuº_node
->
ønge_low
 = 
block_low
;

468 
cuº_node
->
ønge_high
 = 
block_high
;

469 
	`nova_upd©e_ønge_node_checksum
(
cuº_node
);

470 
√w_node_u£d
 = 1;

471 
ªt
 = 
	`nova_ö£π_blockåì
(
åì
, 
cuº_node
);

472 i‡(
ªt
) {

473 
√w_node_u£d
 = 0;

474 
out
;

476 i‡(!
¥ev
)

477 
‰ì_li°
->
fú°_node
 = 
cuº_node
;

478 i‡(!
√xt
)

479 
‰ì_li°
->
œ°_node
 = 
cuº_node
;

481 
‰ì_li°
->
num_blocknode
++;

483 
block_found
:

484 
‰ì_li°
->
num_‰ì_blocks
 +
num_blocks
;

486 i‡(
log_∑ge
) {

487 
‰ì_li°
->
‰ì_log_cou¡
++;

488 
‰ì_li°
->
‰ìd_log_∑ges
 +
num_blocks
;

490 
‰ì_li°
->
‰ì_d©a_cou¡
++;

491 
‰ì_li°
->
‰ìd_d©a_∑ges
 +
num_blocks
;

494 
out
:

495 
	`•ö_u∆ock
(&
‰ì_li°
->
s_lock
);

496 i‡(
√w_node_u£d
 == 0)

497 
	`nova_‰ì_blocknode
(
cuº_node
);

499 
	`NOVA_END_TIMING
(
‰ì_blocks_t
, 
‰ì_time
);

500  
ªt
;

501 
	}
}

503 
	$nova_‰ì_d©a_blocks
(
su≥r_block
 *
sb
,

504 
nova_öode_öfo_hódî
 *
sih
, 
blockƒ
, 
num
)

506 
ªt
;

507 
	`INIT_TIMING
(
‰ì_time
);

509 
	`nova_dbgv
("Inode %lu: free %d data block from %luÅo %lu\n",

510 
sih
->
öo
, 
num
, 
blockƒ
, blocknr +Çum - 1);

511 i‡(
blockƒ
 == 0) {

512 
	`nova_dbg
("%s: ERROR: %lu, %d\n", 
__func__
, 
blockƒ
, 
num
);

513  -
EINVAL
;

515 
	`NOVA_START_TIMING
(
‰ì_d©a_t
, 
‰ì_time
);

516 
ªt
 = 
	`nova_‰ì_blocks
(
sb
, 
blockƒ
, 
num
, 
sih
->
i_blk_ty≥
, 0);

517 i‡(
ªt
) {

518 
	`nova_îr
(
sb
, "Inode %lu: free %d data block from %luÅo %lu "

520 
sih
->
öo
, 
num
, 
blockƒ
, blocknr +Çum - 1);

521 
	`nova_¥öt_nova_log
(
sb
, 
sih
);

523 
	`NOVA_END_TIMING
(
‰ì_d©a_t
, 
‰ì_time
);

525  
ªt
;

526 
	}
}

528 
	$nova_‰ì_log_blocks
(
su≥r_block
 *
sb
,

529 
nova_öode_öfo_hódî
 *
sih
, 
blockƒ
, 
num
)

531 
ªt
;

532 
	`INIT_TIMING
(
‰ì_time
);

534 
	`nova_dbgv
("Inode %lu: free %dÜog block from %luÅo %lu\n",

535 
sih
->
öo
, 
num
, 
blockƒ
, blocknr +Çum - 1);

536 i‡(
blockƒ
 == 0) {

537 
	`nova_dbg
("%s: ERROR: %lu, %d\n", 
__func__
, 
blockƒ
, 
num
);

538  -
EINVAL
;

540 
	`NOVA_START_TIMING
(
‰ì_log_t
, 
‰ì_time
);

541 
ªt
 = 
	`nova_‰ì_blocks
(
sb
, 
blockƒ
, 
num
, 
sih
->
i_blk_ty≥
, 1);

542 i‡(
ªt
) {

543 
	`nova_îr
(
sb
, "Inode %lu: free %dÜog block from %luÅo %lu "

545 
sih
->
öo
, 
num
, 
blockƒ
, blocknr +Çum - 1);

546 
	`nova_¥öt_nova_log
(
sb
, 
sih
);

548 
	`NOVA_END_TIMING
(
‰ì_log_t
, 
‰ì_time
);

550  
ªt
;

551 
	}
}

553 
	$nŸ_íough_blocks
(
‰ì_li°
 *free_list,

554 
num_blocks
, 
Æloc_ty≥
 
©y≥
)

556 
nova_ønge_node
 *
fú°
 = 
‰ì_li°
->
fú°_node
;

557 
nova_ønge_node
 *
œ°
 = 
‰ì_li°
->
œ°_node
;

559 i‡(
‰ì_li°
->
num_‰ì_blocks
 < 
num_blocks
 || !
fú°
 || !
œ°
) {

560 
	`nova_dbgv
("%s:Çum_free_blocks=%ld;Çum_blocks=%ld; "

562 
__func__
, 
‰ì_li°
->
num_‰ì_blocks
, 
num_blocks
,

563 
fú°
, 
œ°
);

567 i‡(
©y≥
 =
LOG
 &&

568 
œ°
->
ønge_high
 - 
fú°
->
ønge_low
 < 
DEAD_ZONE_BLOCKS
) {

569 
	`nova_dbgv
("%s:állocation would cause deadzone violation. "

571 
__func__
, 
œ°
->
ønge_high
, 
fú°
->
ønge_low
,

572 
DEAD_ZONE_BLOCKS
);

577 
	}
}

579 
nova_ønge_node
 *
	$nova_Æloc_blocknode_©omic
(
su≥r_block
 *
sb
)

581  
	`nova_Æloc_ønge_node_©omic
(
sb
);

582 
	}
}

584 
	#PAGES_PER_2MB
 512

	)

585 
	#PAGES_PER_2MB_MASK
 (512 - 1)

	)

586 
	#IS_DATABLOCKS_2MB_ALIGNED
(
numblocks
, 
©y≥
) \

587 (!(
num_blocks
 & 
PAGES_PER_2MB_MASK
Ë&& (
©y≥
 =
DATA
))

	)

590 
	$nova_Æloc_su≥Ωage
(
su≥r_block
 *
sb
,

591 
‰ì_li°
 *‰ì_li°, 
num_blocks
,

592 *
√w_blockƒ
, 
nova_Æloc_dúe˘i⁄
 
‰om_èû
)

594 
rb_roŸ
 *
åì
;

595 
rb_node
 *
ãmp
;

596 
nova_ønge_node
 *
cuº
;

597 
cuº_blocks
;

598 
boﬁ
 
found
 = 0;

599 
°ï
 = 0;

601 
À·_m¨gö
;

602 
right_m¨gö
;

604 
åì
 = &(
‰ì_li°
->
block_‰ì_åì
);

605 i‡(
‰om_èû
 =
ALLOC_FROM_HEAD
)

606 
ãmp
 = &(
‰ì_li°
->
fú°_node
->
node
);

608 
ãmp
 = &(
‰ì_li°
->
œ°_node
->
node
);

610 
ãmp
) {

611 
°ï
++;

612 
cuº
 = 
	`c⁄èöî_of
(
ãmp
, 
nova_ønge_node
, 
node
);

614 i‡(!
	`nova_ønge_node_checksum_ok
(
cuº
)) {

615 
	`nova_îr
(
sb
, "%†cuº faûed\n", 
__func__
);

616 
√xt
;

619 
cuº_blocks
 = 
cuº
->
ønge_high
 - cuº->
ønge_low
 + 1;

620 
À·_m¨gö
 = 
PAGES_PER_2MB
 -

621 (
cuº
->
ønge_low
 & 
PAGES_PER_2MB_MASK
);

624 i‡(
num_blocks
 > (
cuº_blocks
 - 
À·_m¨gö
)) {

625 i‡(((
cuº_blocks
 - 
À·_m¨gö
Ë& ~
PAGES_PER_2MB_MASK
) > 0)

626 
num_blocks
 = (
cuº_blocks
 - 
À·_m¨gö
Ë& ~
PAGES_PER_2MB_MASK
;

637 i‡((
cuº_blocks
 > 
À·_m¨gö
) && \

638 (
num_blocks
 <(
cuº_blocks
 - 
À·_m¨gö
))) {

639 
nova_ønge_node
 *
node
;

640 
ßved_ønge_high
 = 
cuº
->
ønge_high
;

642 *
√w_blockƒ
 = 
cuº
->
ønge_low
 + 
À·_m¨gö
;

643 
right_m¨gö
 = 
cuº_blocks
 - 
À·_m¨gö
 - 
num_blocks
;

644 
	`nova_dbgv
("curr:%p:Çum_blocks:%lu curr->range_low:%lu high:%lu",

645 
cuº
, 
num_blocks
, cuº->
ønge_low
, cuº->
ønge_high
);

647 i‡(
À·_m¨gö
) {

649 
cuº
->
ønge_high
 = cuº->
ønge_low
 + 
À·_m¨gö
 - 1;

650 
	`nova_upd©e_ønge_node_checksum
(
cuº
);

651 
	`nova_dbgv
("InsertÇode forÜeft_margin,Ñange_low:%lu high:%lu",

652 
cuº
->
ønge_low
, cuº->
ønge_high
);

655 i‡(
right_m¨gö
) {

656 i‡(
À·_m¨gö
) {

658 
node
 = 
	`nova_Æloc_blocknode_©omic
(
sb
);

659 i‡(
node
 =
NULL
) {

660 
	`nova_w¨n
("FailedÅoállocateÇew blockÇode.\n");

661  -
ENOMEM
;

663 
node
->
ønge_low
 = 
cuº
->ønge_low + 
À·_m¨gö
 + 
num_blocks
;

664 
node
->
ønge_high
 = 
ßved_ønge_high
;

665 
	`nova_upd©e_ønge_node_checksum
(
node
);

666 
	`nova_ö£π_blockåì
(
åì
, 
node
);

667 
‰ì_li°
->
num_blocknode
++;

668 i‡(
cuº
 =
‰ì_li°
->
œ°_node
)

669 
‰ì_li°
->
œ°_node
 = 
node
;

675 
cuº
->
ønge_low
 = cuº->ønge_low + 
num_blocks
;

676 
	`nova_upd©e_ønge_node_checksum
(
cuº
);

678 
	`nova_dbgv
("InsertÇode forÑight_margin,Ñange_low:%lu high:%lu",

679 
node
->
ønge_low
,Çode->
ønge_high
);

683 i‡(!
À·_m¨gö
 && !
right_m¨gö
) {

686 
node
 = 
NULL
;

687 i‡(
cuº
 =
‰ì_li°
->
fú°_node
) {

688 
ãmp
 = 
	`rb_√xt
(temp);

689 i‡(
ãmp
)

690 
node
 = 
	`c⁄èöî_of
(
ãmp
, 
nova_ønge_node
,Çode);

691 
‰ì_li°
->
fú°_node
 = 
node
;

693 i‡(
cuº
 =
‰ì_li°
->
œ°_node
) {

694 
ãmp
 = 
	`rb_¥ev
(temp);

695 i‡(
ãmp
)

696 
node
 = 
	`c⁄èöî_of
(
ãmp
, 
nova_ønge_node
,Çode);

697 
‰ì_li°
->
œ°_node
 = 
node
;

701 
	`rb_îa£
(&
cuº
->
node
, 
åì
);

702 
	`nova_‰ì_blocknode
(
cuº
);

703 
‰ì_li°
->
num_blocknode
--;

706 
found
 = 1;

709 
√xt
:

710 i‡(
‰om_èû
 =
ALLOC_FROM_HEAD
)

711 
ãmp
 = 
	`rb_√xt
(temp);

713 
ãmp
 = 
	`rb_¥ev
(temp);

716 
	`NOVA_STATS_ADD
(
Æloc_°ïs
, 
°ï
);

717  
found
 ? 
num_blocks
 : 0;

718 
	}
}

721 
	$nova_Æloc_blocks_ö_‰ì_li°
(
su≥r_block
 *
sb
,

722 
‰ì_li°
 *‰ì_li°, 
bty≥
,

723 
Æloc_ty≥
 
©y≥
, 
num_blocks
,

724 *
√w_blockƒ
, 
nova_Æloc_dúe˘i⁄
 
‰om_èû
)

726 
rb_roŸ
 *
åì
;

727 
nova_ønge_node
 *
cuº
, *
√xt
 = 
NULL
, *
¥ev
 = NULL;

728 
rb_node
 *
ãmp
, *
√xt_node
, *
¥ev_node
;

729 
cuº_blocks
;

730 
ªt_blocks
 = 0;

731 
boﬁ
 
found
 = 0;

732 
boﬁ
 
found_hugeblock
 = 0;

733 
°ï
 = 0;

735 i‡(!
‰ì_li°
->
fú°_node
 || fªe_li°->
num_‰ì_blocks
 == 0) {

736 
	`nova_dbgv
("%s: Can'tálloc. free_list->first_node=0x%p "

738 
__func__
, 
‰ì_li°
->
fú°_node
,

739 
‰ì_li°
->
num_‰ì_blocks
);

740  -
ENOSPC
;

743 i‡(
©y≥
 =
LOG
 && 
	`nŸ_íough_blocks
(
‰ì_li°
, 
num_blocks
,átype)) {

744 
	`nova_dbgv
("%s: Can'tálloc.Çot_enough_blocks() ==Årue",

745 
__func__
);

746  -
ENOSPC
;

749 
åì
 = &(
‰ì_li°
->
block_‰ì_åì
);

750 i‡(
‰om_èû
 =
ALLOC_FROM_HEAD
)

751 
ãmp
 = &(
‰ì_li°
->
fú°_node
->
node
);

753 
ãmp
 = &(
‰ì_li°
->
œ°_node
->
node
);

756 i‡(
	`IS_DATABLOCKS_2MB_ALIGNED
(
num_blocks
, 
©y≥
)) {

757 
ªt_blocks
 = 
	`nova_Æloc_su≥Ωage
(
sb
, 
‰ì_li°
,

758 
num_blocks
, 
√w_blockƒ
, 
‰om_èû
);

759 i‡(
ªt_blocks
 > 0 && *
√w_blockƒ
 != 0) {

760 
num_blocks
 = 
ªt_blocks
;

761 
found_hugeblock
 = 1;

762 
suc˚ss
;

767 
ãmp
) {

768 
°ï
++;

769 
cuº
 = 
	`c⁄èöî_of
(
ãmp
, 
nova_ønge_node
, 
node
);

771 i‡(!
	`nova_ønge_node_checksum_ok
(
cuº
)) {

772 
	`nova_îr
(
sb
, "%†cuº faûed\n", 
__func__
);

773 
√xt
;

776 
cuº_blocks
 = 
cuº
->
ønge_high
 - cuº->
ønge_low
 + 1;

778 i‡(
num_blocks
 >
cuº_blocks
) {

780 i‡(
bty≥
 > 0 && 
num_blocks
 > 
cuº_blocks
)

781 
√xt
;

784 i‡(
cuº
 =
‰ì_li°
->
fú°_node
) {

785 
√xt_node
 = 
	`rb_√xt
(
ãmp
);

786 i‡(
√xt_node
)

787 
√xt
 = 
	`c⁄èöî_of
(
√xt_node
,

788 
nova_ønge_node
, 
node
);

789 
‰ì_li°
->
fú°_node
 = 
√xt
;

792 i‡(
cuº
 =
‰ì_li°
->
œ°_node
) {

793 
¥ev_node
 = 
	`rb_¥ev
(
ãmp
);

794 i‡(
¥ev_node
)

795 
¥ev
 = 
	`c⁄èöî_of
(
¥ev_node
,

796 
nova_ønge_node
, 
node
);

797 
‰ì_li°
->
œ°_node
 = 
¥ev
;

800 
	`rb_îa£
(&
cuº
->
node
, 
åì
);

801 
‰ì_li°
->
num_blocknode
--;

802 
num_blocks
 = 
cuº_blocks
;

803 *
√w_blockƒ
 = 
cuº
->
ønge_low
;

804 
	`nova_‰ì_blocknode
(
cuº
);

805 
found
 = 1;

810 i‡(
‰om_èû
 =
ALLOC_FROM_HEAD
) {

811 *
√w_blockƒ
 = 
cuº
->
ønge_low
;

812 
cuº
->
ønge_low
 +
num_blocks
;

814 *
√w_blockƒ
 = 
cuº
->
ønge_high
 + 1 - 
num_blocks
;

815 
cuº
->
ønge_high
 -
num_blocks
;

818 
	`nova_upd©e_ønge_node_checksum
(
cuº
);

819 
found
 = 1;

821 
√xt
:

822 i‡(
‰om_èû
 =
ALLOC_FROM_HEAD
)

823 
ãmp
 = 
	`rb_√xt
(temp);

825 
ãmp
 = 
	`rb_¥ev
(temp);

828 i‡(
‰ì_li°
->
num_‰ì_blocks
 < 
num_blocks
) {

829 
	`nova_dbg
("%s: freeÜist %d has %lu free blocks, "

831 
__func__
, 
‰ì_li°
->
ödex
,

832 
‰ì_li°
->
num_‰ì_blocks
, 
num_blocks
);

833  -
ENOSPC
;

836 
suc˚ss
:

837 i‡((
found
 =1Ë|| (
found_hugeblock
 == 1))

838 
‰ì_li°
->
num_‰ì_blocks
 -
num_blocks
;

840 
	`nova_dbgv
("%s: C™'àÆloc. found = %d", 
__func__
, 
found
);

841  -
ENOSPC
;

844 
	`NOVA_STATS_ADD
(
Æloc_°ïs
, 
°ï
);

846  
num_blocks
;

847 
	}
}

850 
	$nova_gë_ˇndid©e_‰ì_li°
(
su≥r_block
 *
sb
)

852 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

853 
‰ì_li°
 *free_list;

854 
˝uid
 = 0;

855 
num_‰ì_blocks
 = 0;

856 
i
;

858 
i
 = 0; i < 
sbi
->
˝us
; i++) {

859 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
i
);

860 i‡(
‰ì_li°
->
num_‰ì_blocks
 >Çum_free_blocks) {

861 
˝uid
 = 
i
;

862 
num_‰ì_blocks
 = 
‰ì_li°
->num_free_blocks;

866  
˝uid
;

867 
	}
}

869 
	$nova_√w_blocks
(
su≥r_block
 *
sb
, *
blockƒ
,

870 
num
, 
bty≥
, 
zîo
,

871 
Æloc_ty≥
 
©y≥
, 
˝uid
, 
nova_Æloc_dúe˘i⁄
 
‰om_èû
)

873 
‰ì_li°
 *free_list;

874 *
bp
;

875 
num_blocks
 = 0;

876 
√w_blockƒ
 = 0;

877 
ªt_blocks
 = 0;

878 
ªåõd
 = 0;

879 
úq_Êags
 = 0;

880 
	`INIT_TIMING
(
Æloc_time
);

882 
num_blocks
 = 
num
 * 
	`nova_gë_numblocks
(
bty≥
);

883 i‡(
num_blocks
 == 0) {

884 
	`nova_dbg_vîbo£
("%s:Çum_block†=0", 
__func__
);

885  -
EINVAL
;

888 
	`NOVA_START_TIMING
(
√w_blocks_t
, 
Æloc_time
);

889 i‡(
˝uid
 =
ANY_CPU
)

890 
˝uid
 = 
	`nova_gë_˝uid
(
sb
);

892 
ªåy
:

893 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
˝uid
);

894 
	`•ö_lock
(&
‰ì_li°
->
s_lock
);

896 i‡(
	`nŸ_íough_blocks
(
‰ì_li°
, 
num_blocks
, 
©y≥
)) {

897 
	`nova_dbgv
("%s: cpu %d, free_blocks %lu,Ñequired %lu, "

899 
__func__
, 
˝uid
, 
‰ì_li°
->
num_‰ì_blocks
,

900 
num_blocks
, 
‰ì_li°
->
num_blocknode
);

902 i‡(
ªåõd
 >= 2)

904 
Æloc
;

906 
	`•ö_u∆ock
(&
‰ì_li°
->
s_lock
);

907 
˝uid
 = 
	`nova_gë_ˇndid©e_‰ì_li°
(
sb
);

908 
ªåõd
++;

909 
ªåy
;

911 
Æloc
:

912 
ªt_blocks
 = 
	`nova_Æloc_blocks_ö_‰ì_li°
(
sb
, 
‰ì_li°
, 
bty≥
, 
©y≥
,

913 
num_blocks
, &
√w_blockƒ
, 
‰om_èû
);

915 i‡(
ªt_blocks
 > 0) {

916 i‡(
©y≥
 =
LOG
) {

917 
‰ì_li°
->
Æloc_log_cou¡
++;

918 
‰ì_li°
->
Æloc_log_∑ges
 +
ªt_blocks
;

919 } i‡(
©y≥
 =
DATA
) {

920 
‰ì_li°
->
Æloc_d©a_cou¡
++;

921 
‰ì_li°
->
Æloc_d©a_∑ges
 +
ªt_blocks
;

925 
	`•ö_u∆ock
(&
‰ì_li°
->
s_lock
);

926 
	`NOVA_END_TIMING
(
√w_blocks_t
, 
Æloc_time
);

928 i‡(
ªt_blocks
 <0 || 
√w_blockƒ
 == 0) {

929 
	`nova_dbgv
("%s:ÇotábleÅoállocate %d blocks. "

931 
__func__
, 
num
, 
ªt_blocks
, 
√w_blockƒ
);

932  -
ENOSPC
;

935 i‡(
zîo
) {

936 
bp
 = 
	`nova_gë_block
(
sb
, 
	`nova_gë_block_off
(sb,

937 
√w_blockƒ
, 
bty≥
));

938 
	`nova_memu∆ock_ønge
(
sb
, 
bp
, 
PAGE_SIZE
 * 
ªt_blocks
, &
úq_Êags
);

939 
	`mem£t_¡
(
bp
, 0, 
PAGE_SIZE
 * 
ªt_blocks
);

940 
	`nova_memlock_ønge
(
sb
, 
bp
, 
PAGE_SIZE
 * 
ªt_blocks
, &
úq_Êags
);

942 *
blockƒ
 = 
√w_blockƒ
;

944 
	`nova_dbg_vîbo£
("AŒo¯%lu NVMM block†0x%lx\n", 
ªt_blocks
, *
blockƒ
);

945  
ªt_blocks
 / 
	`nova_gë_numblocks
(
bty≥
);

946 
	}
}

950 
	$nova_√w_d©a_blocks
(
su≥r_block
 *
sb
,

951 
nova_öode_öfo_hódî
 *
sih
, *
blockƒ
,

952 
°¨t_blk
, 
num
,

953 
nova_Æloc_öô
 
zîo
, 
˝u
,

954 
nova_Æloc_dúe˘i⁄
 
‰om_èû
)

956 
Æloˇãd
;

957 
	`INIT_TIMING
(
Æloc_time
);

959 
	`NOVA_START_TIMING
(
√w_d©a_blocks_t
, 
Æloc_time
);

960 
Æloˇãd
 = 
	`nova_√w_blocks
(
sb
, 
blockƒ
, 
num
,

961 
sih
->
i_blk_ty≥
, 
zîo
, 
DATA
, 
˝u
, 
‰om_èû
);

962 
	`NOVA_END_TIMING
(
√w_d©a_blocks_t
, 
Æloc_time
);

963 i‡(
Æloˇãd
 < 0) {

964 
	`nova_dbgv
("FAILED: Inode %lu, start blk %lu, "

966 
sih
->
öo
, 
°¨t_blk
, 
Æloˇãd
, *
blockƒ
,

967 *
blockƒ
 + 
Æloˇãd
 - 1);

969 
	`nova_dbgv
("Inode %lu, start blk %lu, "

971 
sih
->
öo
, 
°¨t_blk
, 
Æloˇãd
, *
blockƒ
,

972 *
blockƒ
 + 
Æloˇãd
 - 1);

974  
Æloˇãd
;

975 
	}
}

980 
	$nova_√w_log_blocks
(
su≥r_block
 *
sb
,

981 
nova_öode_öfo_hódî
 *
sih
,

982 *
blockƒ
, 
num
,

983 
nova_Æloc_öô
 
zîo
, 
˝u
,

984 
nova_Æloc_dúe˘i⁄
 
‰om_èû
)

986 
Æloˇãd
;

987 
	`INIT_TIMING
(
Æloc_time
);

989 
	`NOVA_START_TIMING
(
√w_log_blocks_t
, 
Æloc_time
);

990 
Æloˇãd
 = 
	`nova_√w_blocks
(
sb
, 
blockƒ
, 
num
,

991 
sih
->
i_blk_ty≥
, 
zîo
, 
LOG
, 
˝u
, 
‰om_èû
);

992 
	`NOVA_END_TIMING
(
√w_log_blocks_t
, 
Æloc_time
);

993 i‡(
Æloˇãd
 < 0) {

994 
	`nova_dbgv
("%s: ino %lu, failedÅoálloc %dÜog blocks",

995 
__func__
, 
sih
->
öo
, 
num
);

997 
	`nova_dbgv
("%s: ino %lu,álloc %d of %dÜog blocks %luÅo %lu\n",

998 
__func__
, 
sih
->
öo
, 
Æloˇãd
, 
num
, *
blockƒ
,

999 *
blockƒ
 + 
Æloˇãd
 - 1);

1001  
Æloˇãd
;

1002 
	}
}

1004 
	$nova_cou¡_‰ì_blocks
(
su≥r_block
 *
sb
)

1006 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1007 
‰ì_li°
 *free_list;

1008 
num_‰ì_blocks
 = 0;

1009 
i
;

1011 
i
 = 0; i < 
sbi
->
˝us
; i++) {

1012 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
i
);

1013 
num_‰ì_blocks
 +
‰ì_li°
->num_free_blocks;

1016  
num_‰ì_blocks
;

1017 
	}
}

	@balloc.h

1 #i‚de‡
__BALLOC_H


2 
	#__BALLOC_H


	)

4 
	~"öode.h
"

7 
	s‰ì_li°
 {

8 
•ölock_t
 
	ms_lock
;

9 
rb_roŸ
 
	mblock_‰ì_åì
;

10 
nova_ønge_node
 *
	mfú°_node
;

11 
nova_ønge_node
 *
	mœ°_node
;

13 
	mödex
;

16 
	mcsum_°¨t
;

17 
	mª∂iˇ_csum_°¨t
;

18 
	mnum_csum_blocks
;

21 
	m∑rôy_°¨t
;

22 
	mª∂iˇ_∑rôy_°¨t
;

23 
	mnum_∑rôy_blocks
;

28 
	mblock_°¨t
;

29 
	mblock_íd
;

31 
	mnum_‰ì_blocks
;

34 
	mnum_blocknode
;

36 
u32
 
	mcsum
;

39 
	mÆloc_log_cou¡
;

40 
	mÆloc_d©a_cou¡
;

41 
	m‰ì_log_cou¡
;

42 
	m‰ì_d©a_cou¡
;

43 
	mÆloc_log_∑ges
;

44 
	mÆloc_d©a_∑ges
;

45 
	m‰ìd_log_∑ges
;

46 
	m‰ìd_d©a_∑ges
;

48 
u64
 
	m∑ddög
[8];

51 
ölöe


52 
‰ì_li°
 *
	$nova_gë_‰ì_li°
(
su≥r_block
 *
sb
, 
˝u
)

54 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

56  &
sbi
->
‰ì_li°s
[
˝u
];

57 
	}
}

59 
	enova_Æloc_dúe˘i⁄
 {
	mALLOC_FROM_HEAD
 = 0,

60 
	mALLOC_FROM_TAIL
 = 1};

62 
	enova_Æloc_öô
 {
	mALLOC_NO_INIT
 = 0,

63 
	mALLOC_INIT_ZERO
 = 1};

65 
	eÆloc_ty≥
 {

66 
	mLOG
 = 1,

67 
	mDATA
,

72 
	enode_ty≥
 {

73 
	mNODE_BLOCK
 = 1,

74 
	mNODE_INODE
,

75 
	mNODE_DIR
,

80 
nova_Æloc_block_‰ì_li°s
(
su≥r_block
 *
sb
);

81 
nova_dñëe_‰ì_li°s
(
su≥r_block
 *
sb
);

82 
nova_ønge_node
 *
nova_Æloc_blocknode
(
su≥r_block
 *
sb
);

83 
nova_ønge_node
 *
nova_Æloc_öode_node
(
su≥r_block
 *
sb
);

84 
nova_ønge_node
 *
nova_Æloc_dú_node
(
su≥r_block
 *
sb
);

85 
vma_ôem
 *
nova_Æloc_vma_ôem
(
su≥r_block
 *
sb
);

86 
nova_‰ì_ønge_node
(
nova_ønge_node
 *
node
);

87 
nova_‰ì_¢≠shŸ_öfo
(
¢≠shŸ_öfo
 *
öfo
);

88 
nova_‰ì_blocknode
(
nova_ønge_node
 *
bnode
);

89 
nova_‰ì_öode_node
(
nova_ønge_node
 *
bnode
);

90 
nova_‰ì_dú_node
(
nova_ønge_node
 *
bnode
);

91 
nova_‰ì_vma_ôem
(
su≥r_block
 *
sb
,

92 
vma_ôem
 *
ôem
);

93 
nova_öô_blockm≠
(
su≥r_block
 *
sb
, 
ªcovîy
);

94 
nova_‰ì_d©a_blocks
(
su≥r_block
 *
sb
,

95 
nova_öode_öfo_hódî
 *
sih
, 
blockƒ
, 
num
);

96 
nova_‰ì_log_blocks
(
su≥r_block
 *
sb
,

97 
nova_öode_öfo_hódî
 *
sih
, 
blockƒ
, 
num
);

98 
nova_√w_d©a_blocks
(
su≥r_block
 *
sb
,

99 
nova_öode_öfo_hódî
 *
sih
, *
blockƒ
,

100 
°¨t_blk
, 
num
,

101 
nova_Æloc_öô
 
zîo
, 
˝u
,

102 
nova_Æloc_dúe˘i⁄
 
‰om_èû
);

103 
nova_√w_log_blocks
(
su≥r_block
 *
sb
,

104 
nova_öode_öfo_hódî
 *
sih
,

105 *
blockƒ
, 
num
,

106 
nova_Æloc_öô
 
zîo
, 
˝u
,

107 
nova_Æloc_dúe˘i⁄
 
‰om_èû
);

108 
nova_cou¡_‰ì_blocks
(
su≥r_block
 *
sb
);

109 
nova_£¨ch_öodëªe
(
nova_sb_öfo
 *
sbi
,

110 
öo
, 
nova_ønge_node
 **
ªt_node
);

111 
nova_ö£π_blockåì
(
rb_roŸ
 *
åì
,

112 
nova_ønge_node
 *
√w_node
);

113 
nova_ö£π_öodëªe
(
nova_sb_öfo
 *
sbi
,

114 
nova_ønge_node
 *
√w_node
, 
˝u
);

115 
nova_föd_‰ì_¶Ÿ
(
rb_roŸ
 *
åì
, 
ønge_low
,

116 
ønge_high
, 
nova_ønge_node
 **
¥ev
,

117 
nova_ønge_node
 **
√xt
);

119 
nova_ö£π_ønge_node
(
rb_roŸ
 *
åì
,

120 
nova_ønge_node
 *
√w_node
, 
node_ty≥
 
ty≥
);

121 
nova_föd_ønge_node
(
rb_roŸ
 *
åì
,

122 
key
, 
node_ty≥
 
ty≥
,

123 
nova_ønge_node
 **
ªt_node
);

124 
nova_de°roy_ønge_node_åì
(
su≥r_block
 *
sb
,

125 
rb_roŸ
 *
åì
);

	@bbuild.c

26 
	~<löux/fs.h
>

27 
	~<löux/bô›s.h
>

28 
	~<löux/¶ab.h
>

29 
	~<löux/øndom.h
>

30 
	~<löux/dñay.h
>

31 
	~<löux/sched/èsk.h
>

32 
	~"nova.h
"

33 
	~"jou∫Æ.h
"

34 
	~"su≥r.h
"

35 
	~"öode.h
"

36 
	~"log.h
"

38 
	$nova_öô_hódî
(
su≥r_block
 *
sb
,

39 
nova_öode_öfo_hódî
 *
sih
, 
u16
 
i_mode
)

41 
sih
->
log_∑ges
 = 0;

42 
sih
->
i_size
 = 0;

43 
sih
->
öo
 = 0;

44 
sih
->
i_blocks
 = 0;

45 
sih
->
pi_addr
 = 0;

46 
sih
->
Æãr_pi_addr
 = 0;

47 
	`INIT_RADIX_TREE
(&
sih
->
åì
, 
GFP_ATOMIC
);

48 
sih
->
rb_åì
 = 
RB_ROOT
;

49 
sih
->
vma_åì
 = 
RB_ROOT
;

50 
sih
->
num_vmas
 = 0;

51 
	`INIT_LIST_HEAD
(&
sih
->
li°
);

52 
sih
->
i_mode
 = i_mode;

53 
sih
->
i_Êags
 = 0;

54 
sih
->
vÆid_íåõs
 = 0;

55 
sih
->
num_íåõs
 = 0;

56 
sih
->
œ°_£èâr
 = 0;

57 
sih
->
œ°_lök_ch™ge
 = 0;

58 
sih
->
œ°_díåy
 = 0;

59 
sih
->
å™s_id
 = 0;

60 
sih
->
log_hód
 = 0;

61 
sih
->
log_èû
 = 0;

62 
sih
->
Æãr_log_hód
 = 0;

63 
sih
->
Æãr_log_èû
 = 0;

64 
sih
->
i_blk_ty≥
 = 
NOVA_DEFAULT_BLOCK_TYPE
;

65 
	}
}

67 
ölöe
 
	$£t_sˇn_bm
(
bô
,

68 
sögÀ_sˇn_bm
 *
sˇn_bm
)

70 
	`£t_bô
(
bô
, 
sˇn_bm
->
bôm≠
);

71 
	}
}

73 
ölöe
 
	$£t_bm
(
bô
, 
sˇn_bôm≠
 *
bm
,

74 
bm_ty≥
 
ty≥
)

76 
ty≥
) {

77 
BM_4K
:

78 
	`£t_sˇn_bm
(
bô
, &
bm
->
sˇn_bm_4K
);

80 
BM_2M
:

81 
	`£t_sˇn_bm
(
bô
, &
bm
->
sˇn_bm_2M
);

83 
BM_1G
:

84 
	`£t_sˇn_bm
(
bô
, &
bm
->
sˇn_bm_1G
);

89 
	}
}

91 
ölöe
 
	$gë_block_˝uid
(
nova_sb_öfo
 *
sbi
,

92 
blockƒ
)

94  
blockƒ
 / 
sbi
->
≥r_li°_blocks
;

95 
	}
}

97 
	$nova_Áûuª_ö£π_öodëªe
(
su≥r_block
 *
sb
,

98 
öo_low
, 
öo_high
)

100 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

101 
öode_m≠
 *inode_map;

102 
nova_ønge_node
 *
¥ev
 = 
NULL
, *
√xt
 = NULL;

103 
nova_ønge_node
 *
√w_node
;

104 
öã∫Æ_low
, 
öã∫Æ_high
;

105 
˝u
;

106 
rb_roŸ
 *
åì
;

107 
ªt
;

109 i‡(
öo_low
 > 
öo_high
) {

110 
	`nova_îr
(
sb
, "%s: inoÜow %lu, ino high %lu\n",

111 
__func__
, 
öo_low
, 
öo_high
);

112 
	`BUG
();

115 
˝u
 = 
öo_low
 % 
sbi
->
˝us
;

116 i‡(
öo_high
 % 
sbi
->
˝us
 !
˝u
) {

117 
	`nova_îr
(
sb
, "%s: inoÜow %lu, ino high %lu\n",

118 
__func__
, 
öo_low
, 
öo_high
);

119 
	`BUG
();

122 
öã∫Æ_low
 = 
öo_low
 / 
sbi
->
˝us
;

123 
öã∫Æ_high
 = 
öo_high
 / 
sbi
->
˝us
;

124 
öode_m≠
 = &
sbi
->
öode_m≠s
[
˝u
];

125 
åì
 = &
öode_m≠
->
öode_öu£_åì
;

126 
	`muãx_lock
(&
öode_m≠
->
öode_èbÀ_muãx
);

128 
ªt
 = 
	`nova_föd_‰ì_¶Ÿ
(
åì
, 
öã∫Æ_low
, 
öã∫Æ_high
,

129 &
¥ev
, &
√xt
);

130 i‡(
ªt
) {

131 
	`nova_dbg
("%s: ino %lu - %luálreadyÉxists!: %d\n",

132 
__func__
, 
öo_low
, 
öo_high
, 
ªt
);

133 
	`muãx_u∆ock
(&
öode_m≠
->
öode_èbÀ_muãx
);

134  
ªt
;

137 i‡(
¥ev
 && 
√xt
 && (
öã∫Æ_low
 =¥ev->
ønge_high
 + 1) &&

138 (
öã∫Æ_high
 + 1 =
√xt
->
ønge_low
)) {

140 
	`rb_îa£
(&
√xt
->
node
, 
åì
);

141 
öode_m≠
->
num_ønge_node_öode
--;

142 
¥ev
->
ønge_high
 = 
√xt
->range_high;

143 
	`nova_upd©e_ønge_node_checksum
(
¥ev
);

144 
	`nova_‰ì_öode_node
(
√xt
);

145 
föish
;

147 i‡(
¥ev
 && (
öã∫Æ_low
 =¥ev->
ønge_high
 + 1)) {

149 
¥ev
->
ønge_high
 +
öã∫Æ_high
 - 
öã∫Æ_low
 + 1;

150 
	`nova_upd©e_ønge_node_checksum
(
¥ev
);

151 
föish
;

153 i‡(
√xt
 && (
öã∫Æ_high
 + 1 =√xt->
ønge_low
)) {

155 
√xt
->
ønge_low
 -
öã∫Æ_high
 - 
öã∫Æ_low
 + 1;

156 
	`nova_upd©e_ønge_node_checksum
(
√xt
);

157 
föish
;

161 
√w_node
 = 
	`nova_Æloc_öode_node
(
sb
);

162 
	`NOVA_ASSERT
(
√w_node
);

163 
√w_node
->
ønge_low
 = 
öã∫Æ_low
;

164 
√w_node
->
ønge_high
 = 
öã∫Æ_high
;

165 
	`nova_upd©e_ønge_node_checksum
(
√w_node
);

166 
ªt
 = 
	`nova_ö£π_öodëªe
(
sbi
, 
√w_node
, 
˝u
);

167 i‡(
ªt
) {

168 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

169 
	`nova_‰ì_öode_node
(
√w_node
);

170 
föish
;

172 
öode_m≠
->
num_ønge_node_öode
++;

174 
föish
:

175 
	`muãx_u∆ock
(&
öode_m≠
->
öode_èbÀ_muãx
);

176  
ªt
;

177 
	}
}

179 
	$nova_de°roy_blocknode_åì
(
su≥r_block
 *
sb
, 
˝u
)

181 
‰ì_li°
 *free_list;

183 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
˝u
);

184 
	`nova_de°roy_ønge_node_åì
(
sb
, &
‰ì_li°
->
block_‰ì_åì
);

185 
	}
}

187 
	$nova_de°roy_blocknode_åìs
(
su≥r_block
 *
sb
)

189 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

190 
i
;

192 
i
 = 0; i < 
sbi
->
˝us
; i++)

193 
	`nova_de°roy_blocknode_åì
(
sb
, 
i
);

195 
	}
}

197 
	$nova_öô_blockm≠_‰om_öode
(
su≥r_block
 *
sb
)

199 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

200 
nova_öode
 *
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_BLOCKNODE_INO
);

201 
nova_öode_öfo_hódî
 
sih
;

202 
‰ì_li°
 *free_list;

203 
nova_ønge_node_lowhigh
 *
íåy
;

204 
nova_ønge_node
 *
blknode
;

205 
size_t
 
size
 = (
nova_ønge_node_lowhigh
);

206 
u64
 
cuº_p
;

207 
u64
 
˝uid
;

208 
ªt
 = 0;

211 
ªt
 = 
	`nova_gë_hód_èû
(
sb
, 
pi
, &
sih
);

212 i‡(
ªt
)

213 
out
;

215 
sih
.
öo
 = 
NOVA_BLOCKNODE_INO
;

216 
cuº_p
 = 
sih
.
log_hód
;

217 i‡(
cuº_p
 == 0) {

218 
	`nova_dbg
("%s:Öòhód i†0!\n", 
__func__
);

219  -
EINVAL
;

222 
cuº_p
 !
sih
.
log_èû
) {

223 i‡(
	`is_œ°_íåy
(
cuº_p
, 
size
))

224 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

226 i‡(
cuº_p
 == 0) {

227 
	`nova_dbg
("%s: cuº_∞i†NULL!\n", 
__func__
);

228 
	`NOVA_ASSERT
(0);

229 
ªt
 = -
EINVAL
;

233 
íåy
 = (
nova_ønge_node_lowhigh
 *)
	`nova_gë_block
(
sb
,

234 
cuº_p
);

235 
blknode
 = 
	`nova_Æloc_blocknode
(
sb
);

236 i‡(
blknode
 =
NULL
)

237 
	`NOVA_ASSERT
(0);

238 
blknode
->
ønge_low
 = 
	`À64_to_˝u
(
íåy
->range_low);

239 
blknode
->
ønge_high
 = 
	`À64_to_˝u
(
íåy
->range_high);

240 
	`nova_upd©e_ønge_node_checksum
(
blknode
);

241 
˝uid
 = 
	`gë_block_˝uid
(
sbi
, 
blknode
->
ønge_low
);

244 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
˝uid
);

245 
ªt
 = 
	`nova_ö£π_blockåì
(&
‰ì_li°
->
block_‰ì_åì
,

246 
blknode
);

247 i‡(
ªt
) {

248 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

249 
	`nova_‰ì_blocknode
(
blknode
);

250 
	`NOVA_ASSERT
(0);

251 
	`nova_de°roy_blocknode_åìs
(
sb
);

252 
out
;

254 
‰ì_li°
->
num_blocknode
++;

255 i‡(
‰ì_li°
->
num_blocknode
 == 1)

256 
‰ì_li°
->
fú°_node
 = 
blknode
;

257 
‰ì_li°
->
œ°_node
 = 
blknode
;

258 
‰ì_li°
->
num_‰ì_blocks
 +=

259 
blknode
->
ønge_high
 - blknode->
ønge_low
 + 1;

260 
cuº_p
 +(
nova_ønge_node_lowhigh
);

262 
out
:

263 
	`nova_‰ì_öode_log
(
sb
, 
pi
, &
sih
);

264  
ªt
;

265 
	}
}

267 
	$nova_de°roy_öode_åìs
(
su≥r_block
 *
sb
)

269 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

270 
öode_m≠
 *inode_map;

271 
i
;

273 
i
 = 0; i < 
sbi
->
˝us
; i++) {

274 
öode_m≠
 = &
sbi
->
öode_m≠s
[
i
];

275 
	`nova_de°roy_ønge_node_åì
(
sb
,

276 &
öode_m≠
->
öode_öu£_åì
);

278 
	}
}

280 
	#CPUID_MASK
 0xff00000000000000

	)

282 
	$nova_öô_öode_li°_‰om_öode
(
su≥r_block
 *
sb
)

284 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

285 
nova_öode
 *
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_INODELIST_INO
);

286 
nova_öode_öfo_hódî
 
sih
;

287 
nova_ønge_node_lowhigh
 *
íåy
;

288 
nova_ønge_node
 *
ønge_node
;

289 
öode_m≠
 *inode_map;

290 
size_t
 
size
 = (
nova_ønge_node_lowhigh
);

291 
num_öode_node
 = 0;

292 
u64
 
cuº_p
;

293 
˝uid
;

294 
ªt
;

297 
ªt
 = 
	`nova_gë_hód_èû
(
sb
, 
pi
, &
sih
);

298 i‡(
ªt
)

299 
out
;

301 
sih
.
öo
 = 
NOVA_INODELIST_INO
;

302 
sbi
->
s_öodes_u£d_cou¡
 = 0;

303 
cuº_p
 = 
sih
.
log_hód
;

304 i‡(
cuº_p
 == 0) {

305 
	`nova_dbg
("%s:Öòhód i†0!\n", 
__func__
);

306  -
EINVAL
;

309 
cuº_p
 !
sih
.
log_èû
) {

310 i‡(
	`is_œ°_íåy
(
cuº_p
, 
size
))

311 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

313 i‡(
cuº_p
 == 0) {

314 
	`nova_dbg
("%s: cuº_∞i†NULL!\n", 
__func__
);

315 
	`NOVA_ASSERT
(0);

318 
íåy
 = (
nova_ønge_node_lowhigh
 *)
	`nova_gë_block
(
sb
,

319 
cuº_p
);

320 
ønge_node
 = 
	`nova_Æloc_öode_node
(
sb
);

321 i‡(
ønge_node
 =
NULL
)

322 
	`NOVA_ASSERT
(0);

324 
˝uid
 = (
íåy
->
ønge_low
 & 
CPUID_MASK
) >> 56;

325 i‡(
˝uid
 >
sbi
->
˝us
) {

326 
	`nova_îr
(
sb
, "InvÆid cpuid %lu\n", 
˝uid
);

327 
	`nova_‰ì_öode_node
(
ønge_node
);

328 
	`NOVA_ASSERT
(0);

329 
	`nova_de°roy_öode_åìs
(
sb
);

330 
out
;

333 
ønge_node
->
ønge_low
 = 
íåy
->ønge_low & ~
CPUID_MASK
;

334 
ønge_node
->
ønge_high
 = 
íåy
->range_high;

335 
	`nova_upd©e_ønge_node_checksum
(
ønge_node
);

336 
ªt
 = 
	`nova_ö£π_öodëªe
(
sbi
, 
ønge_node
, 
˝uid
);

337 i‡(
ªt
) {

338 
	`nova_îr
(
sb
, "%†Áûed, %d\n", 
__func__
, 
˝uid
);

339 
	`nova_‰ì_öode_node
(
ønge_node
);

340 
	`NOVA_ASSERT
(0);

341 
	`nova_de°roy_öode_åìs
(
sb
);

342 
out
;

345 
sbi
->
s_öodes_u£d_cou¡
 +=

346 
ønge_node
->
ønge_high
 -Ñ™ge_node->
ønge_low
 + 1;

347 
num_öode_node
++;

349 
öode_m≠
 = &
sbi
->
öode_m≠s
[
˝uid
];

350 
öode_m≠
->
num_ønge_node_öode
++;

351 i‡(!
öode_m≠
->
fú°_öode_ønge
)

352 
öode_m≠
->
fú°_öode_ønge
 = 
ønge_node
;

354 
cuº_p
 +(
nova_ønge_node_lowhigh
);

357 
	`nova_dbg
("%s: %lu inodênodes\n", 
__func__
, 
num_öode_node
);

358 
out
:

359 
	`nova_‰ì_öode_log
(
sb
, 
pi
, &
sih
);

360  
ªt
;

361 
	}
}

363 
u64
 
	$nova_≠≥nd_ønge_node_íåy
(
su≥r_block
 *
sb
,

364 
nova_ønge_node
 *
cuº
, 
u64
 
èû
, 
˝uid
)

366 
u64
 
cuº_p
;

367 
size_t
 
size
 = (
nova_ønge_node_lowhigh
);

368 
nova_ønge_node_lowhigh
 *
íåy
;

369 
úq_Êags
 = 0;

371 
cuº_p
 = 
èû
;

373 i‡(!
	`nova_ønge_node_checksum_ok
(
cuº
)) {

374 
	`nova_dbg
("%s:Ñ™gênodêchecksum faûuª\n", 
__func__
);

375 
out
;

378 i‡(
cuº_p
 =0 || (
	`is_œ°_íåy
(cuº_p, 
size
) &&

379 
	`√xt_log_∑ge
(
sb
, 
cuº_p
) == 0)) {

380 
	`nova_dbg
("%s: inodêlogÑóche†íd?\n", 
__func__
);

381 
out
;

384 i‡(
	`is_œ°_íåy
(
cuº_p
, 
size
))

385 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

387 
íåy
 = (
nova_ønge_node_lowhigh
 *)
	`nova_gë_block
(
sb
, 
cuº_p
);

388 
	`nova_memu∆ock_ønge
(
sb
, 
íåy
, 
size
, &
úq_Êags
);

389 
íåy
->
ønge_low
 = 
	`˝u_to_À64
(
cuº
->range_low);

390 i‡(
˝uid
)

391 
íåy
->
ønge_low
 |
	`˝u_to_À64
(
˝uid
 << 56);

392 
íåy
->
ønge_high
 = 
	`˝u_to_À64
(
cuº
->range_high);

393 
	`nova_memlock_ønge
(
sb
, 
íåy
, 
size
, &
úq_Êags
);

394 
	`nova_dbgv
("appendÉntry blockÜow 0x%lx, high 0x%lx\n",

395 
cuº
->
ønge_low
, cuº->
ønge_high
);

397 
	`nova_Êush_buf„r
(
íåy
, (
nova_ønge_node_lowhigh
), 0);

398 
out
:

399  
cuº_p
;

400 
	}
}

402 
u64
 
	$nova_ßve_ønge_nodes_to_log
(
su≥r_block
 *
sb
,

403 
rb_roŸ
 *
åì
, 
u64
 
ãmp_èû
, 
˝uid
)

405 
nova_ønge_node
 *
cuº
;

406 
rb_node
 *
ãmp
;

407 
size_t
 
size
 = (
nova_ønge_node_lowhigh
);

408 
u64
 
cuº_íåy
 = 0;

411 
ãmp
 = 
	`rb_fú°
(
åì
);

412 
ãmp
) {

413 
cuº
 = 
	`c⁄èöî_of
(
ãmp
, 
nova_ønge_node
, 
node
);

414 
cuº_íåy
 = 
	`nova_≠≥nd_ønge_node_íåy
(
sb
, 
cuº
,

415 
ãmp_èû
, 
˝uid
);

416 
ãmp_èû
 = 
cuº_íåy
 + 
size
;

417 
ãmp
 = 
	`rb_√xt
(temp);

418 
	`rb_îa£
(&
cuº
->
node
, 
åì
);

419 
	`nova_‰ì_ønge_node
(
cuº
);

422  
ãmp_èû
;

423 
	}
}

425 
u64
 
	$nova_ßve_‰ì_li°_blocknodes
(
su≥r_block
 *
sb
, 
˝u
,

426 
u64
 
ãmp_èû
)

428 
‰ì_li°
 *free_list;

430 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
˝u
);

431 
ãmp_èû
 = 
	`nova_ßve_ønge_nodes_to_log
(
sb
,

432 &
‰ì_li°
->
block_‰ì_åì
, 
ãmp_èû
, 0);

433  
ãmp_èû
;

434 
	}
}

436 
	$nova_ßve_öode_li°_to_log
(
su≥r_block
 *
sb
)

438 
nova_öode
 *
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_INODELIST_INO
);

439 
nova_öode_öfo_hódî
 
sih
;

440 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

441 
num_blocks
;

442 
num_nodes
 = 0;

443 
öode_m≠
 *inode_map;

444 
i
;

445 
u64
 
ãmp_èû
;

446 
u64
 
√w_block
;

447 
Æloˇãd
;

448 
úq_Êags
 = 0;

450 
sih
.
öo
 = 
NOVA_INODELIST_INO
;

451 
sih
.
i_blk_ty≥
 = 
NOVA_DEFAULT_BLOCK_TYPE
;

452 
sih
.
i_blocks
 = 0;

454 
i
 = 0; i < 
sbi
->
˝us
; i++) {

455 
öode_m≠
 = &
sbi
->
öode_m≠s
[
i
];

456 
num_nodes
 +
öode_m≠
->
num_ønge_node_öode
;

459 
num_blocks
 = 
num_nodes
 / 
RANGENODE_PER_PAGE
;

460 i‡(
num_nodes
 % 
RANGENODE_PER_PAGE
)

461 
num_blocks
++;

463 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, &
sih
, 
num_blocks
,

464 &
√w_block
, 
ANY_CPU
, 0);

465 i‡(
Æloˇãd
 !
num_blocks
) {

466 
	`nova_dbg
("Eº‹ savög inodêli°: %d\n", 
Æloˇãd
);

470 
ãmp_èû
 = 
√w_block
;

471 
i
 = 0; i < 
sbi
->
˝us
; i++) {

472 
öode_m≠
 = &
sbi
->
öode_m≠s
[
i
];

473 
ãmp_èû
 = 
	`nova_ßve_ønge_nodes_to_log
(
sb
,

474 &
öode_m≠
->
öode_öu£_åì
, 
ãmp_èû
, 
i
);

477 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

478 
pi
->
Æãr_log_hód
 =Öi->
Æãr_log_èû
 = 0;

479 
pi
->
log_hód
 = 
√w_block
;

480 
	`nova_upd©e_èû
(
pi
, 
ãmp_èû
);

481 
	`nova_Êush_buf„r
(&
pi
->
log_hód
, 
CACHELINE_SIZE
, 0);

482 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

484 
	`nova_dbg
("%s: %lu inodeÇodes,Öi head 0x%llx,Åail 0x%llx\n",

485 
__func__
, 
num_nodes
, 
pi
->
log_hód
,Öi->
log_èû
);

486 
	}
}

488 
	$nova_ßve_blocknode_m≠pögs_to_log
(
su≥r_block
 *
sb
)

490 
nova_öode
 *
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_BLOCKNODE_INO
);

491 
nova_öode_öfo_hódî
 
sih
;

492 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

493 
‰ì_li°
 *free_list;

494 
num_blocknode
 = 0;

495 
num_∑ges
;

496 
Æloˇãd
;

497 
u64
 
√w_block
 = 0;

498 
u64
 
ãmp_èû
;

499 
i
;

500 
úq_Êags
 = 0;

502 
sih
.
öo
 = 
NOVA_BLOCKNODE_INO
;

503 
sih
.
i_blk_ty≥
 = 
NOVA_DEFAULT_BLOCK_TYPE
;

506 
i
 = 0; i < 
sbi
->
˝us
; i++) {

507 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
i
);

508 
num_blocknode
 +
‰ì_li°
->num_blocknode;

509 
	`nova_dbgv
("%s: fªêli° %d: %luÇodes\n", 
__func__
,

510 
i
, 
‰ì_li°
->
num_blocknode
);

513 
num_∑ges
 = 
num_blocknode
 / 
RANGENODE_PER_PAGE
;

514 i‡(
num_blocknode
 % 
RANGENODE_PER_PAGE
)

515 
num_∑ges
++;

517 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, &
sih
, 
num_∑ges
,

518 &
√w_block
, 
ANY_CPU
, 0);

519 i‡(
Æloˇãd
 !
num_∑ges
) {

520 
	`nova_dbg
("Eº‹ savög blocknodêm≠pögs: %d\n", 
Æloˇãd
);

524 
ãmp_èû
 = 
√w_block
;

525 
i
 = 0; i < 
sbi
->
˝us
; i++)

526 
ãmp_èû
 = 
	`nova_ßve_‰ì_li°_blocknodes
(
sb
, 
i
,Åemp_tail);

529 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

530 
pi
->
Æãr_log_hód
 =Öi->
Æãr_log_èû
 = 0;

531 
pi
->
log_hód
 = 
√w_block
;

532 
	`nova_upd©e_èû
(
pi
, 
ãmp_èû
);

533 
	`nova_Êush_buf„r
(&
pi
->
log_hód
, 
CACHELINE_SIZE
, 0);

534 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

536 
	`nova_dbg
("%s: %lu blocknodes, %luÜogÖages,Öi head 0x%llx,Åail 0x%llx\n",

537 
__func__
, 
num_blocknode
, 
num_∑ges
,

538 
pi
->
log_hód
,Öi->
log_èû
);

539 
	}
}

541 
	$nova_ö£π_blocknode_m≠
(
su≥r_block
 *
sb
,

542 
˝uid
, 
low
, 
high
)

544 
‰ì_li°
 *free_list;

545 
rb_roŸ
 *
åì
;

546 
nova_ønge_node
 *
blknode
 = 
NULL
;

547 
num_blocks
 = 0;

548 
ªt
;

550 
num_blocks
 = 
high
 - 
low
 + 1;

551 
	`nova_dbgv
("%s: cpu %d,Üow %lu, high %lu,Çum %lu\n",

552 
__func__
, 
˝uid
, 
low
, 
high
, 
num_blocks
);

553 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
˝uid
);

554 
åì
 = &(
‰ì_li°
->
block_‰ì_åì
);

556 
blknode
 = 
	`nova_Æloc_blocknode
(
sb
);

557 i‡(
blknode
 =
NULL
)

558  -
ENOMEM
;

559 
blknode
->
ønge_low
 = 
low
;

560 
blknode
->
ønge_high
 = 
high
;

561 
	`nova_upd©e_ønge_node_checksum
(
blknode
);

562 
ªt
 = 
	`nova_ö£π_blockåì
(
åì
, 
blknode
);

563 i‡(
ªt
) {

564 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

565 
	`nova_‰ì_blocknode
(
blknode
);

566 
out
;

568 i‡(!
‰ì_li°
->
fú°_node
)

569 
‰ì_li°
->
fú°_node
 = 
blknode
;

570 
‰ì_li°
->
œ°_node
 = 
blknode
;

571 
‰ì_li°
->
num_blocknode
++;

572 
‰ì_li°
->
num_‰ì_blocks
 +
num_blocks
;

573 
out
:

574  
ªt
;

575 
	}
}

577 
	$__nova_buûd_blocknode_m≠
(
su≥r_block
 *
sb
,

578 *
bôm≠
, 
bsize
, 
sˇÀ
)

580 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

581 
‰ì_li°
 *free_list;

582 
√xt
 = 0;

583 
low
 = 0;

584 
°¨t
, 
íd
;

585 
˝uid
 = 0;

587 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
˝uid
);

588 
°¨t
 = 
‰ì_li°
->
block_°¨t
;

589 
íd
 = 
‰ì_li°
->
block_íd
 + 1;

591 
√xt
 = 
	`föd_√xt_zîo_bô
(
bôm≠
, 
íd
, 
°¨t
);

592 i‡(
√xt
 =
bsize
)

594 i‡(
√xt
 =
íd
) {

595 i‡(
˝uid
 =
sbi
->
˝us
 - 1)

598 
˝uid
++;

599 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
˝uid
);

600 
°¨t
 = 
‰ì_li°
->
block_°¨t
;

601 
íd
 = 
‰ì_li°
->
block_íd
 + 1;

605 
low
 = 
√xt
;

606 
√xt
 = 
	`föd_√xt_bô
(
bôm≠
, 
íd
,Çext);

607 i‡(
	`nova_ö£π_blocknode_m≠
(
sb
, 
˝uid
,

608 
low
 << 
sˇÀ
, (
√xt
 << scale) - 1)) {

609 
	`nova_dbg
("Error: couldÇot insert %lu - %lu\n",

610 
low
 << 
sˇÀ
, ((
√xt
 << scale) - 1));

612 
°¨t
 = 
√xt
;

613 i‡(
√xt
 =
bsize
)

615 i‡(
√xt
 =
íd
) {

616 i‡(
˝uid
 =
sbi
->
˝us
 - 1)

619 
˝uid
++;

620 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
˝uid
);

621 
°¨t
 = 
‰ì_li°
->
block_°¨t
;

622 
íd
 = 
‰ì_li°
->
block_íd
 + 1;

626 
	}
}

628 
	$nova_upd©e_4K_m≠
(
su≥r_block
 *
sb
,

629 
sˇn_bôm≠
 *
bm
, *
bôm≠
,

630 
bsize
, 
sˇÀ
)

632 
√xt
 = 0;

633 
low
 = 0;

634 
i
;

637 
√xt
 = 
	`föd_√xt_bô
(
bôm≠
, 
bsize
,Çext);

638 i‡(
√xt
 =
bsize
)

640 
low
 = 
√xt
;

641 
√xt
 = 
	`föd_√xt_zîo_bô
(
bôm≠
, 
bsize
,Çext);

642 
i
 = (
low
 << 
sˇÀ
); i < (
√xt
 << scale); i++)

643 
	`£t_bm
(
i
, 
bm
, 
BM_4K
);

644 i‡(
√xt
 =
bsize
)

647 
	}
}

649 
sˇn_bôm≠
 *
	gglobÆ_bm
[
MAX_CPUS
];

651 
	$nova_buûd_blocknode_m≠
(
su≥r_block
 *
sb
,

652 
öôsize
)

654 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

655 
sˇn_bôm≠
 *
bm
;

656 
sˇn_bôm≠
 *
föÆ_bm
;

657 *
§c
, *
d°
;

658 
i
, 
j
;

659 
num
;

660 
ªt
;

662 
föÆ_bm
 = 
	`kzÆloc
((
sˇn_bôm≠
), 
GFP_KERNEL
);

663 i‡(!
föÆ_bm
)

664  -
ENOMEM
;

666 
föÆ_bm
->
sˇn_bm_4K
.
bôm≠_size
 =

667 (
öôsize
 >> (
PAGE_SHIFT
 + 0x3));

670 
föÆ_bm
->
sˇn_bm_4K
.
bôm≠
 = 
	`kvzÆloc
(föÆ_bm->sˇn_bm_4K.
bôm≠_size
,

671 
GFP_KERNEL
);

673 i‡(!
föÆ_bm
->
sˇn_bm_4K
.
bôm≠
) {

674 
	`k‰ì
(
föÆ_bm
);

675  -
ENOMEM
;

682 
i
 = 0; i < 
sbi
->
˝us
; i++) {

683 
bm
 = 
globÆ_bm
[
i
];

684 
	`nova_upd©e_4K_m≠
(
sb
, 
bm
, bm->
sˇn_bm_2M
.
bôm≠
,

685 
bm
->
sˇn_bm_2M
.
bôm≠_size
 * 8, 
PAGE_SHIFT_2M
 - 12);

686 
	`nova_upd©e_4K_m≠
(
sb
, 
bm
, bm->
sˇn_bm_1G
.
bôm≠
,

687 
bm
->
sˇn_bm_1G
.
bôm≠_size
 * 8, 
PAGE_SHIFT_1G
 - 12);

691 
num
 = 
föÆ_bm
->
sˇn_bm_4K
.
bôm≠_size
 / ();

692 i‡(
föÆ_bm
->
sˇn_bm_4K
.
bôm≠_size
 % ())

693 
num
++;

695 
i
 = 0; i < 
sbi
->
˝us
; i++) {

696 
bm
 = 
globÆ_bm
[
i
];

697 
§c
 = (*)
bm
->
sˇn_bm_4K
.
bôm≠
;

698 
d°
 = (*)
föÆ_bm
->
sˇn_bm_4K
.
bôm≠
;

700 
j
 = 0; j < 
num
; j++)

701 
d°
[
j
] |
§c
[j];

704 
ªt
 = 
	`__nova_buûd_blocknode_m≠
(
sb
, 
föÆ_bm
->
sˇn_bm_4K
.
bôm≠
,

705 
föÆ_bm
->
sˇn_bm_4K
.
bôm≠_size
 * 8, 
PAGE_SHIFT
 - 12);

707 
	`kv‰ì
(
föÆ_bm
->
sˇn_bm_4K
.
bôm≠
);

708 
	`k‰ì
(
föÆ_bm
);

710  
ªt
;

711 
	}
}

713 
	$‰ì_bm
(
su≥r_block
 *
sb
)

715 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

716 
sˇn_bôm≠
 *
bm
;

717 
i
;

719 
i
 = 0; i < 
sbi
->
˝us
; i++) {

720 
bm
 = 
globÆ_bm
[
i
];

721 i‡(
bm
) {

722 
	`kv‰ì
(
bm
->
sˇn_bm_4K
.
bôm≠
);

723 
	`kv‰ì
(
bm
->
sˇn_bm_2M
.
bôm≠
);

724 
	`kv‰ì
(
bm
->
sˇn_bm_1G
.
bôm≠
);

725 
	`k‰ì
(
bm
);

728 
	}
}

730 
	$Æloc_bm
(
su≥r_block
 *
sb
, 
öôsize
)

732 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

733 
sˇn_bôm≠
 *
bm
;

734 
i
;

736 
i
 = 0; i < 
sbi
->
˝us
; i++) {

737 
bm
 = 
	`kzÆloc
((
sˇn_bôm≠
), 
GFP_KERNEL
);

738 i‡(!
bm
)

739  -
ENOMEM
;

741 
globÆ_bm
[
i
] = 
bm
;

743 
bm
->
sˇn_bm_4K
.
bôm≠_size
 =

744 (
öôsize
 >> (
PAGE_SHIFT
 + 0x3));

745 
bm
->
sˇn_bm_2M
.
bôm≠_size
 =

746 (
öôsize
 >> (
PAGE_SHIFT_2M
 + 0x3));

747 
bm
->
sˇn_bm_1G
.
bôm≠_size
 =

748 (
öôsize
 >> (
PAGE_SHIFT_1G
 + 0x3));

751 
bm
->
sˇn_bm_4K
.
bôm≠
 = 
	`kvzÆloc
(bm->sˇn_bm_4K.
bôm≠_size
,

752 
GFP_KERNEL
);

753 
bm
->
sˇn_bm_2M
.
bôm≠
 = 
	`kvzÆloc
(bm->sˇn_bm_2M.
bôm≠_size
,

754 
GFP_KERNEL
);

755 
bm
->
sˇn_bm_1G
.
bôm≠
 = 
	`kvzÆloc
(bm->sˇn_bm_1G.
bôm≠_size
,

756 
GFP_KERNEL
);

758 i‡(!
bm
->
sˇn_bm_4K
.
bôm≠
 || !bm->
sˇn_bm_2M
.bitmap ||

759 !
bm
->
sˇn_bm_1G
.
bôm≠
)

760  -
ENOMEM
;

764 
	}
}

768 
	#MAX_PGOFF
 262144

	)

770 
	sèsk_rög
 {

771 
u64
 
	maddr0
[512];

772 
u64
 
	maddr1
[512];

773 
	mnum
;

774 
	möodes_u£d_cou¡
;

775 
u64
 *
	míåy_¨øy
;

776 
u64
 *
	mnvmm_¨øy
;

779 
èsk_rög
 *
	gèsk_rögs
;

780 
èsk_°ru˘
 **
	gthªads
;

781 
waô_queue_hód_t
 
	gföish_wq
;

782 *
	gföished
;

784 
	$nova_åavî£_öode_log
(
su≥r_block
 *
sb
,

785 
nova_öode
 *
pi
, 
sˇn_bôm≠
 *
bm
, 
u64
 
hód
)

787 
u64
 
cuº_p
;

788 
u64
 
√xt
;

790 
cuº_p
 = 
hód
;

792 i‡(
cuº_p
 == 0)

795 
	`BUG_ON
(
cuº_p
 & (
PAGE_SIZE
 - 1));

796 
	`£t_bm
(
cuº_p
 >> 
PAGE_SHIFT
, 
bm
, 
BM_4K
);

798 
√xt
 = 
	`√xt_log_∑ge
(
sb
, 
cuº_p
);

799 
√xt
 > 0) {

800 
cuº_p
 = 
√xt
;

801 
	`BUG_ON
(
cuº_p
 & (
PAGE_SIZE
 - 1));

802 
	`£t_bm
(
cuº_p
 >> 
PAGE_SHIFT
, 
bm
, 
BM_4K
);

803 
√xt
 = 
	`√xt_log_∑ge
(
sb
, 
cuº_p
);

807 
	}
}

809 
	$nova_åavî£_dú_öode_log
(
su≥r_block
 *
sb
,

810 
nova_öode
 *
pi
, 
sˇn_bôm≠
 *
bm
)

812 
	`nova_åavî£_öode_log
(
sb
, 
pi
, 
bm
,Öi->
log_hód
);

813 i‡(
mëad©a_csum
)

814 
	`nova_åavî£_öode_log
(
sb
, 
pi
, 
bm
,Öi->
Æãr_log_hód
);

815 
	}
}

817 
	$nova_check_ﬁd_íåy
(
su≥r_block
 *
sb
,

818 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
íåy_addr
,

819 
pgoff
, 
num_‰ì
,

820 
u64
 
ïoch_id
, 
èsk_rög
 *
rög
, 
ba£
,

821 
sˇn_bôm≠
 *
bm
)

823 
nova_fûe_wrôe_íåy
 *
íåy
;

824 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

825 
ﬁd_nvmm
, 
nvmm
;

826 
ödex
;

827 
i
;

828 
ªt
;

830 
íåy
 = (
nova_fûe_wrôe_íåy
 *)
íåy_addr
;

832 i‡(!
íåy
)

835 i‡(
mëad©a_csum
 == 0)

836 
íåyc
 = 
íåy
;

838 
íåyc
 = &
íåy_c›y
;

839 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

843 
ﬁd_nvmm
 = 
	`gë_nvmm
(
sb
, 
sih
, 
íåyc
, 
pgoff
);

845 
ªt
 = 
	`nova_≠≥nd_d©a_to_¢≠shŸ
(
sb
, 
íåyc
, 
ﬁd_nvmm
,

846 
num_‰ì
, 
ïoch_id
);

848 i‡(
ªt
 != 0)

849  
ªt
;

851 
ödex
 = 
pgoff
 - 
ba£
;

852 
i
 = 0; i < 
num_‰ì
; i++) {

853 
nvmm
 = 
rög
->
nvmm_¨øy
[
ödex
];

854 i‡(
nvmm
)

855 
	`£t_bm
(
nvmm
, 
bm
, 
BM_4K
);

856 
ödex
++;

859  
ªt
;

860 
	}
}

862 
	$nova_£t_rög_¨øy
(
su≥r_block
 *
sb
,

863 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

864 
nova_fûe_wrôe_íåy
 *
íåyc
, 
èsk_rög
 *
rög
,

865 
ba£
, 
sˇn_bôm≠
 *
bm
)

867 
°¨t
, 
íd
;

868 
pgoff
, 
ﬁd_pgoff
 = 0;

869 
ödex
;

870 
num_‰ì
 = 0;

871 
u64
 
ﬁd_íåy
 = 0;

872 
u64
 
ïoch_id
 = 
íåyc
->epoch_id;

874 
°¨t
 = 
íåyc
->
pgoff
;

875 i‡(
°¨t
 < 
ba£
)

876 
°¨t
 = 
ba£
;

878 
íd
 = 
íåyc
->
pgoff
 +É¡ryc->
num_∑ges
;

879 i‡(
íd
 > 
ba£
 + 
MAX_PGOFF
)

880 
íd
 = 
ba£
 + 
MAX_PGOFF
;

882 
pgoff
 = 
°¨t
;Ögof‡< 
íd
;Ögoff++) {

883 
ödex
 = 
pgoff
 - 
ba£
;

884 i‡(
rög
->
nvmm_¨øy
[
ödex
]) {

885 i‡(
rög
->
íåy_¨øy
[
ödex
] !
ﬁd_íåy
) {

886 i‡(
ﬁd_íåy
)

887 
	`nova_check_ﬁd_íåy
(
sb
, 
sih
, 
ﬁd_íåy
,

888 
ﬁd_pgoff
, 
num_‰ì
,

889 
ïoch_id
, 
rög
, 
ba£
,

890 
bm
);

892 
ﬁd_íåy
 = 
rög
->
íåy_¨øy
[
ödex
];

893 
ﬁd_pgoff
 = 
pgoff
;

894 
num_‰ì
 = 1;

896 
num_‰ì
++;

901 i‡(
ﬁd_íåy
)

902 
	`nova_check_ﬁd_íåy
(
sb
, 
sih
, 
ﬁd_íåy
, 
ﬁd_pgoff
,

903 
num_‰ì
, 
ïoch_id
, 
rög
, 
ba£
, 
bm
);

905 
pgoff
 = 
°¨t
;Ögof‡< 
íd
;Ögoff++) {

906 
ödex
 = 
pgoff
 - 
ba£
;

907 
rög
->
íåy_¨øy
[
ödex
] = (
u64
)
íåy
;

908 
rög
->
nvmm_¨øy
[
ödex
] = (
u64
)(
íåyc
->
block
 >> 
PAGE_SHIFT
)

909 + 
pgoff
 - 
íåyc
->pgoff;

913 
	}
}

915 
	$nova_£t_fûe_bm
(
su≥r_block
 *
sb
,

916 
nova_öode_öfo_hódî
 *
sih
, 
èsk_rög
 *
rög
,

917 
sˇn_bôm≠
 *
bm
, 
ba£
, 
œ°_blockƒ
)

919 
nvmm
, 
pgoff
;

921 i‡(
œ°_blockƒ
 >
ba£
 + 
MAX_PGOFF
)

922 
œ°_blockƒ
 = 
MAX_PGOFF
 - 1;

924 
œ°_blockƒ
 -
ba£
;

926 
pgoff
 = 0;Ögof‡<
œ°_blockƒ
;Ögoff++) {

927 
nvmm
 = 
rög
->
nvmm_¨øy
[
pgoff
];

928 i‡(
nvmm
) {

929 
	`£t_bm
(
nvmm
, 
bm
, 
BM_4K
);

930 
rög
->
nvmm_¨øy
[
pgoff
] = 0;

931 
rög
->
íåy_¨øy
[
pgoff
] = 0;

936 
	}
}

939 
	$nova_rög_£èâr_íåy
(
su≥r_block
 *
sb
,

940 
nova_öode_öfo_hódî
 *
sih
,

941 
nova_£èâr_logíåy
 *
íåy
, 
èsk_rög
 *
rög
,

942 
ba£
, 
d©a_bôs
, 
sˇn_bôm≠
 *
bm
)

944 
fú°_blockƒ
, 
œ°_blockƒ
;

945 
pgoff
, 
ﬁd_pgoff
 = 0;

946 
ödex
;

947 
num_‰ì
 = 0;

948 
u64
 
ﬁd_íåy
 = 0;

949 
loff_t
 
°¨t
, 
íd
;

950 
u64
 
ïoch_id
 = 
íåy
->epoch_id;

952 i‡(
sih
->
i_size
 <
íåy
->
size
)

953 
out
;

955 
°¨t
 = 
íåy
->
size
;

956 
íd
 = 
sih
->
i_size
;

958 
fú°_blockƒ
 = (
°¨t
 + (1UL << 
d©a_bôs
) - 1) >> data_bits;

960 i‡(
íd
 > 0)

961 
œ°_blockƒ
 = (
íd
 - 1Ë>> 
d©a_bôs
;

963 
œ°_blockƒ
 = 0;

965 i‡(
fú°_blockƒ
 > 
œ°_blockƒ
)

966 
out
;

968 i‡(
fú°_blockƒ
 < 
ba£
)

969 
fú°_blockƒ
 = 
ba£
;

971 i‡(
œ°_blockƒ
 > 
ba£
 + 
MAX_PGOFF
 - 1)

972 
œ°_blockƒ
 = 
ba£
 + 
MAX_PGOFF
 - 1;

974 
pgoff
 = 
fú°_blockƒ
;Ögof‡<
œ°_blockƒ
;Ögoff++) {

975 
ödex
 = 
pgoff
 - 
ba£
;

976 i‡(
rög
->
nvmm_¨øy
[
ödex
]) {

977 i‡(
rög
->
íåy_¨øy
[
ödex
] !
ﬁd_íåy
) {

978 i‡(
ﬁd_íåy
)

979 
	`nova_check_ﬁd_íåy
(
sb
, 
sih
, 
ﬁd_íåy
,

980 
ﬁd_pgoff
, 
num_‰ì
,

981 
ïoch_id
, 
rög
, 
ba£
,

982 
bm
);

984 
ﬁd_íåy
 = 
rög
->
íåy_¨øy
[
ödex
];

985 
ﬁd_pgoff
 = 
pgoff
;

986 
num_‰ì
 = 1;

988 
num_‰ì
++;

993 i‡(
ﬁd_íåy
)

994 
	`nova_check_ﬁd_íåy
(
sb
, 
sih
, 
ﬁd_íåy
, 
ﬁd_pgoff
,

995 
num_‰ì
, 
ïoch_id
, 
rög
, 
ba£
, 
bm
);

997 
pgoff
 = 
fú°_blockƒ
;Ögof‡<
œ°_blockƒ
;Ögoff++) {

998 
ödex
 = 
pgoff
 - 
ba£
;

999 
rög
->
nvmm_¨øy
[
ödex
] = 0;

1000 
rög
->
íåy_¨øy
[
ödex
] = 0;

1003 
out
:

1004 
sih
->
i_size
 = 
íåy
->
size
;

1005 
	}
}

1007 
	$nova_åavî£_fûe_wrôe_íåy
(
su≥r_block
 *
sb
,

1008 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

1009 
nova_fûe_wrôe_íåy
 *
íåyc
, 
èsk_rög
 *
rög
,

1010 
ba£
, 
sˇn_bôm≠
 *
bm
)

1012 
max_blockƒ
 = 0;

1013 
sih
->
i_size
 = 
íåyc
->
size
;

1015 i‡(
íåyc
->
num_∑ges
 !íåyc->
övÆid_∑ges
) {

1016 
max_blockƒ
 = 
íåyc
->
pgoff
 +É¡ryc->
num_∑ges
 - 1;

1017 i‡(
íåyc
->
pgoff
 < 
ba£
 + 
MAX_PGOFF
 &&

1018 
íåyc
->
pgoff
 +É¡ryc->
num_∑ges
 > 
ba£
)

1019 
	`nova_£t_rög_¨øy
(
sb
, 
sih
, 
íåy
, 
íåyc
,

1020 
rög
, 
ba£
, 
bm
);

1023  
max_blockƒ
;

1024 
	}
}

1026 
	$nova_åavî£_fûe_öode_log
(
su≥r_block
 *
sb
,

1027 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

1028 
èsk_rög
 *
rög
, 
sˇn_bôm≠
 *
bm
)

1030 
íåy_c›y
[
NOVA_MAX_ENTRY_LEN
];

1031 
ba£
 = 0;

1032 
œ°_blockƒ
 = 0, 
cuº_œ°
;

1033 
u64
 
öo
 = 
pi
->
nova_öo
;

1034 *
íåy
, *
íåyc
;

1035 
bty≥
;

1036 
d©a_bôs
;

1037 
u64
 
cuº_p
;

1038 
u64
 
√xt
;

1039 
u8
 
ty≥
;

1041 
bty≥
 = 
pi
->
i_blk_ty≥
;

1042 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
bty≥
];

1044 i‡(
mëad©a_csum
)

1045 
	`nova_åavî£_öode_log
(
sb
, 
pi
, 
bm
,Öi->
Æãr_log_hód
);

1047 
íåyc
 = (
mëad©a_csum
 =0Ë? 
NULL
 : 
íåy_c›y
;

1049 
agaö
:

1050 
cuº_p
 = 
pi
->
log_hód
;

1051 
	`nova_dbg_vîbo£
("Log head 0x%llx,Åail 0x%llx\n",

1052 
cuº_p
, 
pi
->
log_èû
);

1053 i‡(
cuº_p
 =0 || 
pi
->
log_èû
 == 0) {

1054 
	`nova_w¨n
("NULLÜogÖoöãr(sËö fûêöodê%Œu\n", 
öo
);

1055 
pi
->
log_hód
 = 0;

1056 
pi
->
log_èû
 = 0;

1057 
	`nova_Êush_buf„r
(
pi
, (
nova_öode
), 1);

1062 i‡(
ba£
 == 0) {

1063 
	`BUG_ON
(
cuº_p
 & (
PAGE_SIZE
 - 1));

1064 
	`£t_bm
(
cuº_p
 >> 
PAGE_SHIFT
, 
bm
, 
BM_4K
);

1067 
cuº_p
 !
pi
->
log_èû
) {

1068 i‡(
	`gŸo_√xt_∑ge
(
sb
, 
cuº_p
)) {

1069 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

1070 i‡(
ba£
 == 0) {

1071 
	`BUG_ON
(
cuº_p
 & (
PAGE_SIZE
 - 1));

1072 
	`£t_bm
(
cuº_p
 >> 
PAGE_SHIFT
, 
bm
, 
BM_4K
);

1076 i‡(
cuº_p
 == 0) {

1077 
	`nova_îr
(
sb
, "Fûêöodê%ŒuÜog i†NULL!\n", 
öo
);

1078 
	`BUG
();

1081 
íåy
 = (*)
	`nova_gë_block
(
sb
, 
cuº_p
);

1083 i‡(
mëad©a_csum
 == 0)

1084 
íåyc
 = 
íåy
;

1085 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

1088 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
íåyc
);

1089 
ty≥
) {

1090 
SET_ATTR
:

1091 
	`nova_rög_£èâr_íåy
(
sb
, 
sih
, 
	`SENTRY
(
íåyc
),

1092 
rög
, 
ba£
, 
d©a_bôs
,

1093 
bm
);

1094 
cuº_p
 +(
nova_£èâr_logíåy
);

1096 
LINK_CHANGE
:

1097 
cuº_p
 +(
nova_lök_ch™ge_íåy
);

1099 
FILE_WRITE
:

1100 
cuº_œ°
 = 
	`nova_åavî£_fûe_wrôe_íåy
(
sb
, 
sih
, 
	`WENTRY
(
íåy
),

1101 
	`WENTRY
(
íåyc
), 
rög
, 
ba£
, 
bm
);

1102 
cuº_p
 +(
nova_fûe_wrôe_íåy
);

1103 i‡(
œ°_blockƒ
 < 
cuº_œ°
)

1104 
œ°_blockƒ
 = 
cuº_œ°
;

1106 
MMAP_WRITE
:

1107 
cuº_p
 +(
nova_mm≠_íåy
);

1110 
	`nova_dbg
("%s: unknownÅype %d, 0x%llx\n",

1111 
__func__
, 
ty≥
, 
cuº_p
);

1112 
	`NOVA_ASSERT
(0);

1113 
	`BUG
();

1118 i‡(
ba£
 == 0) {

1120 
cuº_p
 &
PAGE_MASK
;

1121 
√xt
 = 
	`√xt_log_∑ge
(
sb
, 
cuº_p
);

1122 
√xt
 > 0) {

1123 
cuº_p
 = 
√xt
;

1124 
	`BUG_ON
(
cuº_p
 & (
PAGE_SIZE
 - 1));

1125 
	`£t_bm
(
cuº_p
 >> 
PAGE_SHIFT
, 
bm
, 
BM_4K
);

1126 
√xt
 = 
	`√xt_log_∑ge
(
sb
, 
cuº_p
);

1130 
	`nova_£t_fûe_bm
(
sb
, 
sih
, 
rög
, 
bm
, 
ba£
, 
œ°_blockƒ
);

1131 i‡(
œ°_blockƒ
 >
ba£
 + 
MAX_PGOFF
) {

1132 
ba£
 +
MAX_PGOFF
;

1133 
agaö
;

1137 
	}
}

1140 
	$nova_ªcovî_öode_∑ges
(
su≥r_block
 *
sb
,

1141 
nova_öode_öfo_hódî
 *
sih
, 
èsk_rög
 *
rög
,

1142 
nova_öode
 *
pi
, 
sˇn_bôm≠
 *
bm
)

1144 
nova_öo
;

1146 i‡(
pi
->
dñëed
 == 1)

1149 
nova_öo
 = 
pi
->nova_ino;

1150 
rög
->
öodes_u£d_cou¡
++;

1152 
sih
->
i_mode
 = 
	`__À16_to_˝u
(
pi
->i_mode);

1153 
sih
->
öo
 = 
nova_öo
;

1155 
	`nova_dbgv
("%s: inode %lu, head 0x%llx,Åail 0x%llx\n",

1156 
__func__
, 
nova_öo
, 
pi
->
log_hód
,Öi->
log_èû
);

1158 
	`__À16_to_˝u
(
pi
->
i_mode
Ë& 
S_IFMT
) {

1159 
S_IFDIR
:

1160 
	`nova_åavî£_dú_öode_log
(
sb
, 
pi
, 
bm
);

1162 
S_IFLNK
:

1165 
S_IFREG
:

1169 
	`nova_åavî£_fûe_öode_log
(
sb
, 
pi
, 
sih
, 
rög
, 
bm
);

1174 
	}
}

1176 
	$‰ì_ªsour˚s
(
su≥r_block
 *
sb
)

1178 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1179 
èsk_rög
 *
rög
;

1180 
i
;

1182 i‡(
èsk_rögs
) {

1183 
i
 = 0; i < 
sbi
->
˝us
; i++) {

1184 
rög
 = &
èsk_rögs
[
i
];

1185 
	`v‰ì
(
rög
->
íåy_¨øy
);

1186 
	`v‰ì
(
rög
->
nvmm_¨øy
);

1187 
rög
->
íåy_¨øy
 = 
NULL
;

1188 
rög
->
nvmm_¨øy
 = 
NULL
;

1192 
	`k‰ì
(
èsk_rögs
);

1193 
	`k‰ì
(
thªads
);

1194 
	`k‰ì
(
föished
);

1195 
	}
}

1197 
Áûuª_thªad_func
(*
d©a
);

1199 
	$Æloˇã_ªsour˚s
(
su≥r_block
 *
sb
, 
˝us
)

1201 
èsk_rög
 *
rög
;

1202 
i
;

1204 
èsk_rögs
 = 
	`kˇŒoc
(
˝us
, (
èsk_rög
), 
GFP_KERNEL
);

1205 i‡(!
èsk_rögs
)

1206 
Áû
;

1208 
i
 = 0; i < 
˝us
; i++) {

1209 
rög
 = &
èsk_rögs
[
i
];

1211 
rög
->
nvmm_¨øy
 = 
	`vzÆloc
((
u64
Ë* 
MAX_PGOFF
);

1212 i‡(!
rög
->
nvmm_¨øy
)

1213 
Áû
;

1215 
rög
->
íåy_¨øy
 = 
	`vmÆloc
((
u64
Ë* 
MAX_PGOFF
);

1216 i‡(!
rög
->
íåy_¨øy
)

1217 
Áû
;

1220 
thªads
 = 
	`kˇŒoc
(
˝us
, (
èsk_°ru˘
 *), 
GFP_KERNEL
);

1221 i‡(!
thªads
)

1222 
Áû
;

1224 
föished
 = 
	`kˇŒoc
(
˝us
, (), 
GFP_KERNEL
);

1225 i‡(!
föished
)

1226 
Áû
;

1228 
	`öô_waôqueue_hód
(&
föish_wq
);

1230 
i
 = 0; i < 
˝us
; i++) {

1231 
thªads
[
i
] = 
	`kthªad_¸óã
(
Áûuª_thªad_func
,

1232 
sb
, "recoveryÅhread");

1233 
	`kthªad_böd
(
thªads
[
i
], i);

1238 
Áû
:

1239 
	`‰ì_ªsour˚s
(
sb
);

1240  -
ENOMEM
;

1241 
	}
}

1243 
	$waô_to_föish
(
˝us
)

1245 
i
;

1247 
i
 = 0; i < 
˝us
; i++) {

1248 
föished
[
i
] == 0) {

1249 
	`waô_evít_öãºu±ibÀ_timeout
(
föish_wq
, 
Ál£
,

1250 
	`m£cs_to_jiffõs
(1));

1253 
	}
}

1257 
ölöe
 
	$nova_Áûuª_upd©e_öodëªe
(
su≥r_block
 *
sb
,

1258 
nova_öode
 *
pi
, *
öo_low
, *
öo_high
)

1260 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1262 i‡(*
öo_low
 == 0) {

1263 *
öo_low
 = *
öo_high
 = 
pi
->
nova_öo
;

1265 i‡(
pi
->
nova_öo
 =*
öo_high
 + 
sbi
->
˝us
) {

1266 *
öo_high
 = 
pi
->
nova_öo
;

1269 
	`nova_Áûuª_ö£π_öodëªe
(
sb
, *
öo_low
, *
öo_high
);

1270 *
öo_low
 = *
öo_high
 = 
pi
->
nova_öo
;

1275 
	}
}

1277 
	$Áûuª_thªad_func
(*
d©a
)

1279 
su≥r_block
 *
sb
 = 
d©a
;

1280 
nova_öode_öfo_hódî
 
sih
;

1281 
èsk_rög
 *
rög
;

1282 
nova_öode
 *
pi
, 
Áke_pi
;

1283 
num_öodes_≥r_∑ge
;

1284 
öo_low
, 
öo_high
;

1285 
œ°_blockƒ
;

1286 
d©a_bôs
;

1287 
u64
 
cuº
, 
cuº1
;

1288 
˝uid
 = 
	`nova_gë_˝uid
(
sb
);

1289 
i
;

1290 
max_size
 = 0;

1291 
u64
 
pi_addr
 = 0;

1292 
ªt
 = 0;

1293 
cou¡
;

1295 
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_INODETABLE_INO
);

1296 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
pi
->
i_blk_ty≥
];

1297 
num_öodes_≥r_∑ge
 = 1 << (
d©a_bôs
 - 
NOVA_INODE_BITS
);

1299 
rög
 = &
èsk_rögs
[
˝uid
];

1300 
	`nova_öô_hódî
(
sb
, &
sih
, 0);

1302 
cou¡
 = 0; cou¡ < 
rög
->
num
; count++) {

1303 
cuº
 = 
rög
->
addr0
[
cou¡
];

1304 
cuº1
 = 
rög
->
addr1
[
cou¡
];

1305 
öo_low
 = 
öo_high
 = 0;

1311 
i
 = 0; i < 512; i++)

1312 
	`£t_bm
((
cuº
 >> 
PAGE_SHIFT
Ë+ 
i
,

1313 
globÆ_bm
[
˝uid
], 
BM_4K
);

1315 i‡(
mëad©a_csum
) {

1316 
i
 = 0; i < 512; i++)

1317 
	`£t_bm
((
cuº1
 >> 
PAGE_SHIFT
Ë+ 
i
,

1318 
globÆ_bm
[
˝uid
], 
BM_4K
);

1321 
i
 = 0; i < 
num_öodes_≥r_∑ge
; i++) {

1322 
pi_addr
 = 
cuº
 + 
i
 * 
NOVA_INODE_SIZE
;

1323 
ªt
 = 
	`nova_gë_ª„ªn˚
(
sb
, 
pi_addr
, &
Áke_pi
,

1324 (**)&
pi
, (
nova_öode
));

1325 i‡(
ªt
) {

1326 
	`nova_dbg
("RecoverÖi @ 0x%llx failed\n",

1327 
pi_addr
);

1331 i‡(
Áke_pi
.
i_mode
 && fake_pi.
dñëed
 == 0) {

1332 i‡(
Áke_pi
.
vÆid
 == 0) {

1333 
ªt
 = 
	`nova_≠≥nd_öode_to_¢≠shŸ
(
sb
,

1334 
pi
);

1335 i‡(
ªt
 != 0) {

1337 
pi
->
dñëed
 = 1;

1338 
Áke_pi
.
dñëed
 = 1;

1343 
	`nova_ªcovî_öode_∑ges
(
sb
, &
sih
, 
rög
,

1344 &
Áke_pi
, 
globÆ_bm
[
˝uid
]);

1345 
	`nova_Áûuª_upd©e_öodëªe
(
sb
, 
pi
,

1346 &
öo_low
, &
öo_high
);

1347 i‡(
sih
.
i_size
 > 
max_size
)

1348 
max_size
 = 
sih
.
i_size
;

1352 i‡(
öo_low
 && 
öo_high
)

1353 
	`nova_Áûuª_ö£π_öodëªe
(
sb
, 
öo_low
, 
öo_high
);

1357 i‡(
max_size
) {

1358 
œ°_blockƒ
 = (
max_size
 - 1Ë>> 
PAGE_SHIFT
;

1359 
	`nova_dñëe_fûe_åì
(
sb
, &
sih
, 0, 
œ°_blockƒ
,

1360 
Ál£
, false, 0);

1363 
föished
[
˝uid
] = 1;

1364 
	`wake_up_öãºu±ibÀ
(&
föish_wq
);

1365 
	`do_exô
(
ªt
);

1367  
ªt
;

1368 
	}
}

1370 
	$nova_Áûuª_ªcovîy_¸awl
(
su≥r_block
 *
sb
)

1372 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1373 
nova_öode_öfo_hódî
 
sih
;

1374 
öode_èbÀ
 *inode_table;

1375 
èsk_rög
 *
rög
;

1376 
nova_öode
 *
pi
, 
Áke_pi
;

1377 
cuº_addr
;

1378 
u64
 
roŸ_addr
;

1379 
u64
 
cuº
;

1380 
num_èbÀs
;

1381 
vîsi⁄
;

1382 
ªt
 = 0;

1383 
cou¡
;

1384 
˝uid
;

1386 
roŸ_addr
 = 
	`nova_gë_ª£rved_öode_addr
(
sb
, 
NOVA_ROOT_INO
);

1388 
num_èbÀs
 = 1;

1389 i‡(
mëad©a_csum
)

1390 
num_èbÀs
 = 2;

1392 
˝uid
 = 0; cpuid < 
sbi
->
˝us
; cpuid++) {

1393 
rög
 = &
èsk_rögs
[
˝uid
];

1394 
vîsi⁄
 = 0; vîsi⁄ < 
num_èbÀs
; version++) {

1395 
öode_èbÀ
 = 
	`nova_gë_öode_èbÀ
(
sb
, 
vîsi⁄
,

1396 
˝uid
);

1397 i‡(!
öode_èbÀ
)

1398  -
EINVAL
;

1400 
cou¡
 = 0;

1401 
cuº
 = 
öode_èbÀ
->
log_hód
;

1402 
cuº
) {

1403 i‡(
rög
->
num
 >= 512) {

1404 
	`nova_îr
(
sb
, "%s:Ñing sizeÅoo small\n",

1405 
__func__
);

1406  -
EINVAL
;

1409 i‡(
vîsi⁄
 == 0)

1410 
rög
->
addr0
[
cou¡
] = 
cuº
;

1412 
rög
->
addr1
[
cou¡
] = 
cuº
;

1414 
cou¡
++;

1416 
cuº_addr
 = ()
	`nova_gë_block
(
sb
,

1417 
cuº
);

1419 
cuº_addr
 += 2097152 - 8;

1420 
cuº
 = *(
u64
 *)(
cuº_addr
);

1423 i‡(
cou¡
 > 
rög
->
num
)

1424 
rög
->
num
 = 
cou¡
;

1428 
˝uid
 = 0; cpuid < 
sbi
->
˝us
; cpuid++)

1429 
	`wake_up_¥o˚ss
(
thªads
[
˝uid
]);

1431 
	`nova_öô_hódî
(
sb
, &
sih
, 0);

1433 
ªt
 = 
	`nova_gë_ª„ªn˚
(
sb
, 
roŸ_addr
, &
Áke_pi
,

1434 (**)&
pi
, (
nova_öode
));

1435 i‡(
ªt
) {

1436 
	`nova_dbg
("RecoverÑootÖi failed\n");

1437  
ªt
;

1440 
	`nova_ªcovî_öode_∑ges
(
sb
, &
sih
, &
èsk_rögs
[0],

1441 &
Áke_pi
, 
globÆ_bm
[0]);

1443  
ªt
;

1444 
	}
}

1446 
	$nova_Áûuª_ªcovîy
(
su≥r_block
 *
sb
)

1448 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1449 
èsk_rög
 *
rög
;

1450 
nova_öode
 *
pi
;

1451 
jou∫Æ_±r_∑ú
 *
∑ú
;

1452 
ªt
;

1453 
i
;

1455 
sbi
->
s_öodes_u£d_cou¡
 = 0;

1458 i‡(
	`nova_öô_öode_öu£_li°
(
sb
) < 0)

1459  -
EINVAL
;

1462 
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_BLOCKNODE_INO
);

1463 
pi
->
log_hód
 =Öi->
log_èû
 = 0;

1464 
	`nova_Êush_buf„r
(&
pi
->
log_hód
, 
CACHELINE_SIZE
, 0);

1466 
i
 = 0; i < 
sbi
->
˝us
; i++) {

1467 
∑ú
 = 
	`nova_gë_jou∫Æ_poöãrs
(
sb
, 
i
);

1469 
	`£t_bm
(
∑ú
->
jou∫Æ_hód
 >> 
PAGE_SHIFT
, 
globÆ_bm
[
i
], 
BM_4K
);

1472 
i
 = 
NOVA_SNAPSHOT_INO
 % 
sbi
->
˝us
;

1473 
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_SNAPSHOT_INO
);

1475 
	`nova_åavî£_dú_öode_log
(
sb
, 
pi
, 
globÆ_bm
[
i
]);

1477 
	`PERSISTENT_BARRIER
();

1479 
ªt
 = 
	`Æloˇã_ªsour˚s
(
sb
, 
sbi
->
˝us
);

1480 i‡(
ªt
)

1481  
ªt
;

1483 
ªt
 = 
	`nova_Áûuª_ªcovîy_¸awl
(
sb
);

1485 
	`waô_to_föish
(
sbi
->
˝us
);

1487 
i
 = 0; i < 
sbi
->
˝us
; i++) {

1488 
rög
 = &
èsk_rögs
[
i
];

1489 
sbi
->
s_öodes_u£d_cou¡
 +
rög
->
öodes_u£d_cou¡
;

1492 
	`‰ì_ªsour˚s
(
sb
);

1494 
	`nova_dbg
("FailureÑecoveryÅotalÑecovered %lu\n",

1495 
sbi
->
s_öodes_u£d_cou¡
 - 
NOVA_NORMAL_INODE_START
);

1496  
ªt
;

1497 
	}
}

1502 
boﬁ
 
	$nova_åy_n‹mÆ_ªcovîy
(
su≥r_block
 *
sb
)

1504 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1505 
nova_öode
 *
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_BLOCKNODE_INO
);

1506 
ªt
;

1508 i‡(
pi
->
log_hód
 =0 ||Öi->
log_èû
 == 0)

1509  
Ál£
;

1511 
ªt
 = 
	`nova_öô_blockm≠_‰om_öode
(
sb
);

1512 i‡(
ªt
) {

1513 
	`nova_îr
(
sb
, "init blockmap failed, fall backÅo failureÑecovery\n");

1514  
Ál£
;

1517 
ªt
 = 
	`nova_öô_öode_li°_‰om_öode
(
sb
);

1518 i‡(
ªt
) {

1519 
	`nova_îr
(
sb
, "init inodeÜist failed, fall backÅo failureÑecovery\n");

1520 
	`nova_de°roy_blocknode_åìs
(
sb
);

1521  
Ál£
;

1524 i‡(
sbi
->
mou¡_¢≠shŸ
 == 0) {

1525 
ªt
 = 
	`nova_ª°‹e_¢≠shŸ_èbÀ
(
sb
, 0);

1526 i‡(
ªt
) {

1527 
	`nova_îr
(
sb
, "Restore snapshotÅable failed, fall backÅo failureÑecovery\n");

1528 
	`nova_de°roy_¢≠shŸ_öfos
(
sb
);

1529  
Ál£
;

1533  
åue
;

1534 
	}
}

1542 
	$nova_ªcovîy
(
su≥r_block
 *
sb
)

1544 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1545 
nova_su≥r_block
 *
su≥r
 = 
sbi
->
nova_sb
;

1546 
öôsize
 = 
	`À64_to_˝u
(
su≥r
->
s_size
);

1547 
boﬁ
 
vÆue
 = 
Ál£
;

1548 
ªt
 = 0;

1549 
	`INIT_TIMING
(
°¨t
);

1550 
	`INIT_TIMING
(
íd
);

1552 
	`nova_dbgv
("%s\n", 
__func__
);

1555 i‡(
mósuª_timög
 == 0)

1556 
	`ktime_gë_ts64
(&
°¨t
);

1558 
	`NOVA_START_TIMING
(
ªcovîy_t
, 
°¨t
);

1559 
sbi
->
num_blocks
 = (()(
öôsize
Ë>> 
PAGE_SHIFT
);

1562 
	`nova_öô_blockm≠
(
sb
, 1);

1564 
vÆue
 = 
	`nova_åy_n‹mÆ_ªcovîy
(
sb
);

1565 i‡(
vÆue
) {

1566 
	`nova_dbg
("NOVA: Normal shutdown\n");

1568 
	`nova_dbg
("NOVA: FailureÑecovery\n");

1569 
ªt
 = 
	`Æloc_bm
(
sb
, 
öôsize
);

1570 i‡(
ªt
)

1571 
out
;

1573 i‡(
sbi
->
mou¡_¢≠shŸ
 == 0) {

1575 
ªt
 = 
	`nova_ª°‹e_¢≠shŸ_èbÀ
(
sb
, 1);

1576 i‡(
ªt
) {

1577 
	`nova_dbg
("Initialize snapshot infos failed\n");

1578 
	`nova_de°roy_¢≠shŸ_öfos
(
sb
);

1579 
out
;

1583 
sbi
->
s_öodes_u£d_cou¡
 = 0;

1584 
ªt
 = 
	`nova_Áûuª_ªcovîy
(
sb
);

1585 i‡(
ªt
)

1586 
out
;

1588 
ªt
 = 
	`nova_buûd_blocknode_m≠
(
sb
, 
öôsize
);

1591 
out
:

1592 
	`NOVA_END_TIMING
(
ªcovîy_t
, 
°¨t
);

1593 i‡(
mósuª_timög
 == 0) {

1594 
	`ktime_gë_ts64
(&
íd
);

1595 
Timög°©s
[
ªcovîy_t
] +=

1596 (
íd
.
tv_£c
 - 
°¨t
.tv_sec) * 1000000000 +

1597 (
íd
.
tv_n£c
 - 
°¨t
.tv_nsec);

1600 i‡(!
vÆue
)

1601 
	`‰ì_bm
(
sb
);

1603 
sbi
->
s_ïoch_id
 = 
	`À64_to_˝u
(
su≥r
->s_epoch_id);

1604  
ªt
;

1605 
	}
}

	@checksum.c

18 
	~"nova.h
"

19 
	~"öode.h
"

21 
	$nova_gë_íåy_c›y
(
su≥r_block
 *
sb
, *
íåy
,

22 
u32
 *
íåy_csum
, 
size_t
 *
íåy_size
, *
íåy_c›y
)

24 
u8
 
ty≥
;

25 
nova_díåy
 *
díåy
;

26 
ªt
 = 0;

28 i‡(
	`mem˝y
(&
ty≥
, 
íåy
, (
u8
)Ë=
NULL
)

31 
ty≥
) {

32 
DIR_LOG
:

33 
díåy
 = 
	`DENTRY
(
íåy_c›y
);

34 i‡(
	`mem˝y
(
díåy
, 
íåy
, 
NOVA_DENTRY_HEADER_LEN
Ë=
NULL
)

35 
ªt
 = -1;

37 i‡(
ªt
 < 0 || 
díåy
->
de_Àn
 > 
NOVA_MAX_ENTRY_LEN
)

39 *
íåy_size
 = 
díåy
->
de_Àn
;

40 i‡(
	`mem˝y
((
u8
 *Ë
díåy
 + 
NOVA_DENTRY_HEADER_LEN
,

41 (
u8
 *Ë
íåy
 + 
NOVA_DENTRY_HEADER_LEN
,

42 *
íåy_size
 - 
NOVA_DENTRY_HEADER_LEN
Ë=
NULL
)

44 *
íåy_csum
 = 
díåy
->
csum
;

46 
FILE_WRITE
:

47 *
íåy_size
 = (
nova_fûe_wrôe_íåy
);

48 i‡(
	`mem˝y
(
íåy_c›y
, 
íåy
, *
íåy_size
Ë=
NULL
)

50 *
íåy_csum
 = 
	`WENTRY
(
íåy_c›y
)->
csum
;

52 
SET_ATTR
:

53 *
íåy_size
 = (
nova_£èâr_logíåy
);

54 i‡(
	`mem˝y
(
íåy_c›y
, 
íåy
, *
íåy_size
Ë=
NULL
)

56 *
íåy_csum
 = 
	`SENTRY
(
íåy_c›y
)->
csum
;

58 
LINK_CHANGE
:

59 *
íåy_size
 = (
nova_lök_ch™ge_íåy
);

60 i‡(
	`mem˝y
(
íåy_c›y
, 
íåy
, *
íåy_size
Ë=
NULL
)

62 *
íåy_csum
 = 
	`LCENTRY
(
íåy_c›y
)->
csum
;

64 
MMAP_WRITE
:

65 *
íåy_size
 = (
nova_mm≠_íåy
);

66 i‡(
	`mem˝y
(
íåy_c›y
, 
íåy
, *
íåy_size
Ë=
NULL
)

68 *
íåy_csum
 = 
	`MMENTRY
(
íåy_c›y
)->
csum
;

70 
SNAPSHOT_INFO
:

71 *
íåy_size
 = (
nova_¢≠shŸ_öfo_íåy
);

72 i‡(
	`mem˝y
(
íåy_c›y
, 
íåy
, *
íåy_size
Ë=
NULL
)

74 *
íåy_csum
 = 
	`SNENTRY
(
íåy_c›y
)->
csum
;

77 *
íåy_csum
 = 0;

78 *
íåy_size
 = 0;

79 
	`nova_dbg
("%s: unknown or unsupportedÉntryÅype (%d) for checksum, 0x%llx\n",

80 
__func__
, 
ty≥
, (
u64
)
íåy
);

81 
ªt
 = -
EINVAL
;

82 
	`dump_°ack
();

86  
ªt
;

87 
	}
}

90 
u32
 
	$nova_ˇlc_íåy_csum
(*
íåy
)

92 
u8
 
ty≥
;

93 
u32
 
csum
 = 0;

94 
size_t
 
íåy_Àn
, 
check_Àn
;

95 *
csum_addr
, *
ªmaö
;

96 
	`INIT_TIMING
(
ˇlc_time
);

98 
	`NOVA_START_TIMING
(
ˇlc_íåy_csum_t
, 
ˇlc_time
);

101 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
íåy
);

102 
ty≥
) {

104 
DIR_LOG
:

105 
íåy_Àn
 = 
	`DENTRY
(
íåy
)->
de_Àn
;

106 
csum_addr
 = &
	`DENTRY
(
íåy
)->
csum
;

108 
FILE_WRITE
:

109 
íåy_Àn
 = (
nova_fûe_wrôe_íåy
);

110 
csum_addr
 = &
	`WENTRY
(
íåy
)->
csum
;

112 
SET_ATTR
:

113 
íåy_Àn
 = (
nova_£èâr_logíåy
);

114 
csum_addr
 = &
	`SENTRY
(
íåy
)->
csum
;

116 
LINK_CHANGE
:

117 
íåy_Àn
 = (
nova_lök_ch™ge_íåy
);

118 
csum_addr
 = &
	`LCENTRY
(
íåy
)->
csum
;

120 
MMAP_WRITE
:

121 
íåy_Àn
 = (
nova_mm≠_íåy
);

122 
csum_addr
 = &
	`MMENTRY
(
íåy
)->
csum
;

124 
SNAPSHOT_INFO
:

125 
íåy_Àn
 = (
nova_¢≠shŸ_öfo_íåy
);

126 
csum_addr
 = &
	`SNENTRY
(
íåy
)->
csum
;

129 
íåy_Àn
 = 0;

130 
csum_addr
 = 
NULL
;

131 
	`nova_dbg
("%s: unknown or unsupportedÉntryÅype (%d) for checksum, 0x%llx\n",

132 
__func__
, 
ty≥
, (
u64
Ë
íåy
);

136 i‡(
íåy_Àn
 > 0) {

137 
check_Àn
 = ((
u8
 *Ë
csum_addr
Ë- ((u8 *Ë
íåy
);

138 
csum
 = 
	`nova_¸c32c
(
NOVA_INIT_CSUM
, 
íåy
, 
check_Àn
);

139 
check_Àn
 = 
íåy_Àn
 - (check_À¿+ 
NOVA_META_CSUM_LEN
);

140 i‡(
check_Àn
 > 0) {

141 
ªmaö
 = ((
u8
 *Ë
csum_addr
Ë+ 
NOVA_META_CSUM_LEN
;

142 
csum
 = 
	`nova_¸c32c
(csum, 
ªmaö
, 
check_Àn
);

145 i‡(
check_Àn
 < 0) {

146 
	`nova_dbg
("%s: checksumÑun-lengthÉrror %ld < 0",

147 
__func__
, 
check_Àn
);

151 
	`NOVA_END_TIMING
(
ˇlc_íåy_csum_t
, 
ˇlc_time
);

152  
csum
;

153 
	}
}

156 
	$nova_upd©e_íåy_csum
(*
íåy
)

158 
u8
 
ty≥
;

159 
u32
 
csum
;

160 
size_t
 
íåy_Àn
 = 
CACHELINE_SIZE
;

162 i‡(
mëad©a_csum
 == 0)

163 
Êush
;

165 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
íåy
);

166 
csum
 = 
	`nova_ˇlc_íåy_csum
(
íåy
);

168 
ty≥
) {

169 
DIR_LOG
:

170 
	`DENTRY
(
íåy
)->
csum
 = 
	`˝u_to_À32
(csum);

171 
íåy_Àn
 = 
	`DENTRY
(
íåy
)->
de_Àn
;

173 
FILE_WRITE
:

174 
	`WENTRY
(
íåy
)->
csum
 = 
	`˝u_to_À32
(csum);

175 
íåy_Àn
 = (
nova_fûe_wrôe_íåy
);

177 
SET_ATTR
:

178 
	`SENTRY
(
íåy
)->
csum
 = 
	`˝u_to_À32
(csum);

179 
íåy_Àn
 = (
nova_£èâr_logíåy
);

181 
LINK_CHANGE
:

182 
	`LCENTRY
(
íåy
)->
csum
 = 
	`˝u_to_À32
(csum);

183 
íåy_Àn
 = (
nova_lök_ch™ge_íåy
);

185 
MMAP_WRITE
:

186 
	`MMENTRY
(
íåy
)->
csum
 = 
	`˝u_to_À32
(csum);

187 
íåy_Àn
 = (
nova_mm≠_íåy
);

189 
SNAPSHOT_INFO
:

190 
	`SNENTRY
(
íåy
)->
csum
 = 
	`˝u_to_À32
(csum);

191 
íåy_Àn
 = (
nova_¢≠shŸ_öfo_íåy
);

194 
íåy_Àn
 = 0;

195 
	`nova_dbg
("%s: unknown or unsupportedÉntryÅype (%d), 0x%llx\n",

196 
__func__
, 
ty≥
, (
u64
Ë
íåy
);

200 
Êush
:

201 i‡(
íåy_Àn
 > 0)

202 
	`nova_Êush_buf„r
(
íåy
, 
íåy_Àn
, 0);

204 
	}
}

206 
	$nova_upd©e_Æãr_íåy
(
su≥r_block
 *
sb
, *
íåy
)

208 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

209 *
Æãr_íåy
;

210 
u64
 
cuº
, 
Æãr_cuº
;

211 
u32
 
íåy_csum
;

212 
size_t
 
size
;

213 
íåy_c›y
[
NOVA_MAX_ENTRY_LEN
];

214 
ªt
;

216 i‡(
mëad©a_csum
 == 0)

219 
cuº
 = 
	`nova_gë_addr_off
(
sbi
, 
íåy
);

220 
Æãr_cuº
 = 
	`Æãr_log_íåy
(
sb
, 
cuº
);

221 i‡(
Æãr_cuº
 == 0) {

222 
	`nova_îr
(
sb
, "%s:ÜogÖagêèûÉº‹ dëe˘ed\n", 
__func__
);

223  -
EIO
;

225 
Æãr_íåy
 = (*)
	`nova_gë_block
(
sb
, 
Æãr_cuº
);

227 
ªt
 = 
	`nova_gë_íåy_c›y
(
sb
, 
íåy
, &
íåy_csum
, &
size
, 
íåy_c›y
);

228 i‡(
ªt
)

229  
ªt
;

231 
ªt
 = 
	`mem˝y_to_pmem_noˇche
(
Æãr_íåy
, 
íåy_c›y
, 
size
);

232  
ªt
;

233 
	}
}

236 
	$nova_ª∑ú_íåy_¥
(
su≥r_block
 *
sb
, *
íåy
)

238 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

239 
ªt
;

240 
u64
 
íåy_off
, 
Æãr_off
;

241 *
íåy_¥
, *
Æãr_¥
;

242 
úq_Êags
 = 0;

244 
íåy_off
 = 
	`nova_gë_addr_off
(
sbi
, 
íåy
);

245 
Æãr_off
 = 
	`Æãr_log_íåy
(
sb
, 
íåy_off
);

246 i‡(
Æãr_off
 == 0) {

247 
	`nova_îr
(
sb
, "%s:ÜogÖagêèûÉº‹ dëe˘ed\n", 
__func__
);

248 
Áû
;

251 
íåy_¥
 = (*Ë
	`nova_gë_block
(
sb
, 
íåy_off
 & 
POISON_MASK
);

252 
Æãr_¥
 = (*Ë
	`nova_gë_block
(
sb
, 
Æãr_off
 & 
POISON_MASK
);

254 i‡(
íåy_¥
 =
NULL
 || 
Æãr_¥
 == NULL)

255 
	`BUG
();

257 
	`nova_memu∆ock_ønge
(
sb
, 
íåy_¥
, 
POISON_RADIUS
, &
úq_Êags
);

258 i‡(
	`mem˝y
(
íåy_¥
, 
Æãr_¥
, 
POISON_RADIUS
Ë=
NULL
)

259 
ªt
 = -1;

260 
	`nova_memlock_ønge
(
sb
, 
íåy_¥
, 
POISON_RADIUS
, &
úq_Êags
);

261 
	`nova_Êush_buf„r
(
íåy_¥
, 
POISON_RADIUS
, 0);

264 i‡(
ªt
 < 0)

265 
Áû
;

267 
	`nova_dbg
("%s:É¡ry medüÉº‹Ñïaúed\n", 
__func__
);

270 
Áû
:

271 
	`nova_îr
(
sb
, "%s: uƒecovîabÀ medüÉº‹ dëe˘ed\n", 
__func__
);

273 
	}
}

275 
	$nova_ª∑ú_íåy
(
su≥r_block
 *
sb
, *
bad
, *
good
,

276 
size_t
 
íåy_size
)

278 
ªt
;

279 
úq_Êags
 = 0;

281 
	`nova_memu∆ock_ønge
(
sb
, 
bad
, 
íåy_size
, &
úq_Êags
);

282 
ªt
 = 
	`mem˝y_to_pmem_noˇche
(
bad
, 
good
, 
íåy_size
);

283 
	`nova_memlock_ønge
(
sb
, 
bad
, 
íåy_size
, &
úq_Êags
);

285 i‡(
ªt
 == 0)

286 
	`nova_dbg
("%s:É¡ryÉº‹Ñïaúed\n", 
__func__
);

288  
ªt
;

289 
	}
}

292 
boﬁ
 
	$nova_vîify_íåy_csum
(
su≥r_block
 *
sb
, *
íåy
, *
íåyc
)

294 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

295 
ªt
 = 0;

296 
u64
 
íåy_off
, 
Æãr_off
;

297 *
Æãr
;

298 
size_t
 
íåy_size
, 
Æãr_size
;

299 
u32
 
íåy_csum
, 
Æãr_csum
;

300 
u32
 
íåy_csum_ˇlc
, 
Æãr_csum_ˇlc
;

301 
íåy_c›y
[
NOVA_MAX_ENTRY_LEN
];

302 
Æãr_c›y
[
NOVA_MAX_ENTRY_LEN
];

303 
	`INIT_TIMING
(
vîify_time
);

305 i‡(
mëad©a_csum
 == 0)

306  
åue
;

308 
	`NOVA_START_TIMING
(
vîify_íåy_csum_t
, 
vîify_time
);

310 
ªt
 = 
	`nova_gë_íåy_c›y
(
sb
, 
íåy
, &
íåy_csum
, &
íåy_size
,

311 
íåy_c›y
);

312 i‡(
ªt
 < 0) {

313 
ªt
 = 
	`nova_ª∑ú_íåy_¥
(
sb
, 
íåy
);

314 i‡(
ªt
 < 0)

315 
Áû
;

317 
ªt
 = 
	`nova_gë_íåy_c›y
(
sb
, 
íåy
, &
íåy_csum
, &
íåy_size
,

318 
íåy_c›y
);

319 i‡(
ªt
 < 0)

320 
Áû
;

323 
íåy_off
 = 
	`nova_gë_addr_off
(
sbi
, 
íåy
);

324 
Æãr_off
 = 
	`Æãr_log_íåy
(
sb
, 
íåy_off
);

325 i‡(
Æãr_off
 == 0) {

326 
	`nova_îr
(
sb
, "%s:ÜogÖagêèûÉº‹ dëe˘ed\n", 
__func__
);

327 
Áû
;

330 
Æãr
 = (*Ë
	`nova_gë_block
(
sb
, 
Æãr_off
);

331 
ªt
 = 
	`nova_gë_íåy_c›y
(
sb
, 
Æãr
, &
Æãr_csum
, &
Æãr_size
,

332 
Æãr_c›y
);

333 i‡(
ªt
 < 0) {

334 
ªt
 = 
	`nova_ª∑ú_íåy_¥
(
sb
, 
Æãr
);

335 i‡(
ªt
 < 0)

336 
Áû
;

338 
ªt
 = 
	`nova_gë_íåy_c›y
(
sb
, 
Æãr
, &
Æãr_csum
, &
Æãr_size
,

339 
Æãr_c›y
);

340 i‡(
ªt
 < 0)

341 
Áû
;

345 
íåy_csum
 = 
	`À32_to_˝u
(entry_csum);

346 
Æãr_csum
 = 
	`À32_to_˝u
(alter_csum);

347 
íåy_csum_ˇlc
 = 
	`nova_ˇlc_íåy_csum
(
íåy_c›y
);

348 
Æãr_csum_ˇlc
 = 
	`nova_ˇlc_íåy_csum
(
Æãr_c›y
);

350 i‡(
íåy_csum
 !
íåy_csum_ˇlc
 && 
Æãr_csum
 !
Æãr_csum_ˇlc
) {

351 
	`nova_îr
(
sb
, "%s: bothÉntryánd itsÑeplica fail checksum verification\n",

352 
__func__
);

353 
Áû
;

354 } i‡(
íåy_csum
 !
íåy_csum_ˇlc
) {

355 
	`nova_dbg
("%s:Éntry %p checksumÉrror,ÅryingÅoÑepair usingÅheÑeplica\n",

356 
__func__
, 
íåy
);

357 
ªt
 = 
	`nova_ª∑ú_íåy
(
sb
, 
íåy
, 
Æãr_c›y
, 
Æãr_size
);

358 i‡(
ªt
 != 0)

359 
Áû
;

361 
	`mem˝y
(
íåyc
, 
Æãr_c›y
, 
Æãr_size
);

362 } i‡(
Æãr_csum
 !
Æãr_csum_ˇlc
) {

363 
	`nova_dbg
("%s:ÉntryÑeplica %p checksumÉrror,ÅryingÅoÑepair usingÅheÖrimary\n",

364 
__func__
, 
Æãr
);

365 
ªt
 = 
	`nova_ª∑ú_íåy
(
sb
, 
Æãr
, 
íåy_c›y
, 
íåy_size
);

366 i‡(
ªt
 != 0)

367 
Áû
;

369 
	`mem˝y
(
íåyc
, 
íåy_c›y
, 
íåy_size
);

374 i‡(
	`memcmp
(
íåy_c›y
, 
Æãr_c›y
, 
íåy_size
)) {

375 
	`nova_dbg
("%s:ÉntryÑeplica %pÉrror,ÅryingÅoÑepair usingÅheÖrimary\n",

376 
__func__
, 
Æãr
);

377 
ªt
 = 
	`nova_ª∑ú_íåy
(
sb
, 
Æãr
, 
íåy_c›y
,

378 
íåy_size
);

379 i‡(
ªt
 != 0)

380 
Áû
;

383 
	`mem˝y
(
íåyc
, 
íåy_c›y
, 
íåy_size
);

386 
	`NOVA_END_TIMING
(
vîify_íåy_csum_t
, 
vîify_time
);

387  
åue
;

389 
Áû
:

390 
	`nova_îr
(
sb
, "%s: u«bÀÅÿª∑úÉ¡ryÉº‹s\n", 
__func__
);

392 
	`NOVA_END_TIMING
(
vîify_íåy_csum_t
, 
vîify_time
);

393  
Ál£
;

394 
	}
}

397 
	$nova_ª∑ú_öode_¥
(
su≥r_block
 *
sb
,

398 
nova_öode
 *
bad_pi
, nova_öodê*
good_pi
)

400 
ªt
;

401 *
bad_¥
, *
good_¥
;

402 
úq_Êags
 = 0;

404 
bad_¥
 = (*)((
u64
Ë
bad_pi
 & 
POISON_MASK
);

405 
good_¥
 = (*)((
u64
Ë
good_pi
 & 
POISON_MASK
);

407 i‡(
bad_¥
 =
NULL
 || 
good_¥
 == NULL)

408 
	`BUG
();

410 
	`nova_memu∆ock_ønge
(
sb
, 
bad_¥
, 
POISON_RADIUS
, &
úq_Êags
);

411 i‡(
	`mem˝y
(
bad_¥
, 
good_¥
, 
POISON_RADIUS
Ë=
NULL
)

412 
ªt
 = -1;

413 
	`nova_memlock_ønge
(
sb
, 
bad_¥
, 
POISON_RADIUS
, &
úq_Êags
);

414 
	`nova_Êush_buf„r
(
bad_¥
, 
POISON_RADIUS
, 0);

417 i‡(
ªt
 < 0)

418 
Áû
;

420 
	`nova_dbg
("%s: inodêmedüÉº‹Ñïaúed\n", 
__func__
);

423 
Áû
:

424 
	`nova_îr
(
sb
, "%s: uƒecovîabÀ medüÉº‹ dëe˘ed\n", 
__func__
);

426 
	}
}

428 
	$nova_ª∑ú_öode
(
su≥r_block
 *
sb
, 
nova_öode
 *
bad_pi
,

429 
nova_öode
 *
good_c›y
)

431 
ªt
;

432 
úq_Êags
 = 0;

434 
	`nova_memu∆ock_öode
(
sb
, 
bad_pi
, &
úq_Êags
);

435 
ªt
 = 
	`mem˝y_to_pmem_noˇche
(
bad_pi
, 
good_c›y
,

436 (
nova_öode
));

437 
	`nova_memlock_öode
(
sb
, 
bad_pi
, &
úq_Êags
);

439 i‡(
ªt
 == 0)

440 
	`nova_dbg
("%s: inodê%ŒuÉº‹Ñïaúed\n", 
__func__
,

441 
good_c›y
->
nova_öo
);

443  
ªt
;

444 
	}
}

452 
	$nova_check_öode_öãgrôy
(
su≥r_block
 *
sb
, 
u64
 
öo
, u64 
pi_addr
,

453 
u64
 
Æãr_pi_addr
, 
nova_öode
 *
pic
, 
check_ª∂iˇ
)

455 
nova_öode
 *
pi
, *
Æãr_pi
, 
Æãr_c›y
, *
Æãr_pic
;

456 
öode_bad
, 
Æãr_bad
;

457 
ªt
 = 0;

459 
pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
, 
pi_addr
);

461 i‡(
	`mem˝y
(
pic
, 
pi
, (
nova_öode
)Ë=
NULL
)

462 
ªt
 = -1;

464 i‡(
mëad©a_csum
 == 0)

465  
ªt
;

467 
Æãr_pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
, 
Æãr_pi_addr
);

469 i‡(
ªt
 < 0) {

470 
ªt
 = 
	`nova_ª∑ú_öode_¥
(
sb
, 
pi
, 
Æãr_pi
);

471 i‡(
ªt
 < 0)

472 
Áû
;

474 i‡(
	`mem˝y
(
pic
, 
pi
, (
nova_öode
)Ë=
NULL
)

475 
ªt
 = -1;

476 i‡(
ªt
 < 0)

477 
Áû
;

480 
öode_bad
 = 
	`nova_check_öode_checksum
(
pic
);

482 i‡(!
öode_bad
 && !
check_ª∂iˇ
)

485 
Æãr_pic
 = &
Æãr_c›y
;

486 i‡(
	`mem˝y
(
Æãr_pic
, 
Æãr_pi
, (
nova_öode
)Ë=
NULL
)

487 
ªt
 = -1;

488 i‡(
ªt
 < 0) {

489 i‡(
öode_bad
)

490 
Áû
;

491 
ªt
 = 
	`nova_ª∑ú_öode_¥
(
sb
, 
Æãr_pi
, 
pi
);

492 i‡(
ªt
 < 0)

493 
Áû
;

495 i‡(
	`mem˝y
(
Æãr_pic
, 
Æãr_pi
,

496 (
nova_öode
)Ë=
NULL
)

497 
ªt
 = -1;

498 i‡(
ªt
 < 0)

499 
Áû
;

502 
Æãr_bad
 = 
	`nova_check_öode_checksum
(
Æãr_pic
);

504 i‡(
öode_bad
 && 
Æãr_bad
) {

505 
	`nova_îr
(
sb
, "%s: both inodeánd itsÑeplica fail checksum verification\n",

506 
__func__
);

507 
Áû
;

508 } i‡(
öode_bad
) {

509 
	`nova_dbg
("%s: inode %llu checksumÉrror,ÅryingÅoÑepair usingÅheÑeplica\n",

510 
__func__
, 
öo
);

511 
	`nova_¥öt_öode
(
pi
);

512 
	`nova_¥öt_öode
(
Æãr_pi
);

513 
ªt
 = 
	`nova_ª∑ú_öode
(
sb
, 
pi
, 
Æãr_pic
);

514 i‡(
ªt
 != 0)

515 
Áû
;

517 
	`mem˝y
(
pic
, 
Æãr_pic
, (
nova_öode
));

518 } i‡(
Æãr_bad
) {

519 
	`nova_dbg
("%s: inodeÑeplica %llu checksumÉrror,ÅryingÅoÑepair usingÅheÖrimary\n",

520 
__func__
, 
öo
);

521 
ªt
 = 
	`nova_ª∑ú_öode
(
sb
, 
Æãr_pi
, 
pic
);

522 i‡(
ªt
 != 0)

523 
Áû
;

524 } i‡(
	`memcmp
(
pic
, 
Æãr_pic
, (
nova_öode
))) {

525 
	`nova_dbg
("%s: inodeÑeplica %llu is stale,ÅryingÅoÑepair usingÅheÖrimary\n",

526 
__func__
, 
öo
);

527 
ªt
 = 
	`nova_ª∑ú_öode
(
sb
, 
Æãr_pi
, 
pic
);

528 i‡(
ªt
 != 0)

529 
Áû
;

534 
Áû
:

535 
	`nova_îr
(
sb
, "%s: u«bÀÅÿª∑ú inodêîr‹s\n", 
__func__
);

537  -
EIO
;

538 
	}
}

540 
	$nova_upd©e_°rùe_csum
(
su≥r_block
 *
sb
, 
°Ωs
,

541 
°Ω_ƒ
, 
u8
 *
°Ω_±r
, 
zîo
)

543 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

544 
size_t
 
°Ω_size
 = 
NOVA_STRIPE_SIZE
;

545 
°Ω
;

546 
u32
 
csum
;

547 
u32
 
¸c
[8];

548 *
csum_addr
, *
csum_addr1
;

549 *
§c_addr
;

550 
úq_Êags
 = 0;

552 
°Ωs
 >= 8) {

553 i‡(
zîo
) {

554 
§c_addr
 = 
sbi
->
zîo_csum
;

555 
c›y
;

558 
¸c
[0] = 
	`˝u_to_À32
(
	`nova_¸c32c
(
NOVA_INIT_CSUM
,

559 
°Ω_±r
, 
°Ω_size
));

560 
¸c
[1] = 
	`˝u_to_À32
(
	`nova_¸c32c
(
NOVA_INIT_CSUM
,

561 
°Ω_±r
 + 
°Ω_size
, strp_size));

562 
¸c
[2] = 
	`˝u_to_À32
(
	`nova_¸c32c
(
NOVA_INIT_CSUM
,

563 
°Ω_±r
 + 
°Ω_size
 * 2, strp_size));

564 
¸c
[3] = 
	`˝u_to_À32
(
	`nova_¸c32c
(
NOVA_INIT_CSUM
,

565 
°Ω_±r
 + 
°Ω_size
 * 3, strp_size));

566 
¸c
[4] = 
	`˝u_to_À32
(
	`nova_¸c32c
(
NOVA_INIT_CSUM
,

567 
°Ω_±r
 + 
°Ω_size
 * 4, strp_size));

568 
¸c
[5] = 
	`˝u_to_À32
(
	`nova_¸c32c
(
NOVA_INIT_CSUM
,

569 
°Ω_±r
 + 
°Ω_size
 * 5, strp_size));

570 
¸c
[6] = 
	`˝u_to_À32
(
	`nova_¸c32c
(
NOVA_INIT_CSUM
,

571 
°Ω_±r
 + 
°Ω_size
 * 6, strp_size));

572 
¸c
[7] = 
	`˝u_to_À32
(
	`nova_¸c32c
(
NOVA_INIT_CSUM
,

573 
°Ω_±r
 + 
°Ω_size
 * 7, strp_size));

575 
§c_addr
 = 
¸c
;

576 
c›y
:

577 
csum_addr
 = 
	`nova_gë_d©a_csum_addr
(
sb
, 
°Ω_ƒ
, 0);

578 
csum_addr1
 = 
	`nova_gë_d©a_csum_addr
(
sb
, 
°Ω_ƒ
, 1);

580 
	`nova_memu∆ock_ønge
(
sb
, 
csum_addr
, 
NOVA_DATA_CSUM_LEN
 * 8, &
úq_Êags
);

581 i‡(
suµ‹t_˛wb
) {

582 
	`mem˝y
(
csum_addr
, 
§c_addr
, 
NOVA_DATA_CSUM_LEN
 * 8);

583 
	`mem˝y
(
csum_addr1
, 
§c_addr
, 
NOVA_DATA_CSUM_LEN
 * 8);

585 
	`mem˝y_to_pmem_noˇche
(
csum_addr
, 
§c_addr
,

586 
NOVA_DATA_CSUM_LEN
 * 8);

587 
	`mem˝y_to_pmem_noˇche
(
csum_addr1
, 
§c_addr
,

588 
NOVA_DATA_CSUM_LEN
 * 8);

590 
	`nova_memlock_ønge
(
sb
, 
csum_addr
, 
NOVA_DATA_CSUM_LEN
 * 8, &
úq_Êags
);

591 i‡(
suµ‹t_˛wb
) {

592 
	`nova_Êush_buf„r
(
csum_addr
,

593 
NOVA_DATA_CSUM_LEN
 * 8, 0);

594 
	`nova_Êush_buf„r
(
csum_addr1
,

595 
NOVA_DATA_CSUM_LEN
 * 8, 0);

598 
°Ω_ƒ
 += 8;

599 
°Ωs
 -= 8;

600 i‡(!
zîo
)

601 
°Ω_±r
 +
°Ω_size
 * 8;

604 
°Ω
 = 0; så∞< 
°Ωs
; strp++) {

605 i‡(
zîo
)

606 
csum
 = 
sbi
->
zîo_csum
[0];

608 
csum
 = 
	`nova_¸c32c
(
NOVA_INIT_CSUM
, 
°Ω_±r
, 
°Ω_size
);

610 
csum
 = 
	`˝u_to_À32
(csum);

611 
csum_addr
 = 
	`nova_gë_d©a_csum_addr
(
sb
, 
°Ω_ƒ
, 0);

612 
csum_addr1
 = 
	`nova_gë_d©a_csum_addr
(
sb
, 
°Ω_ƒ
, 1);

614 
	`nova_memu∆ock_ønge
(
sb
, 
csum_addr
, 
NOVA_DATA_CSUM_LEN
, &
úq_Êags
);

615 
	`mem˝y_to_pmem_noˇche
(
csum_addr
, &
csum
, 
NOVA_DATA_CSUM_LEN
);

616 
	`mem˝y_to_pmem_noˇche
(
csum_addr1
, &
csum
, 
NOVA_DATA_CSUM_LEN
);

617 
	`nova_memlock_ønge
(
sb
, 
csum_addr
, 
NOVA_DATA_CSUM_LEN
, &
úq_Êags
);

619 
°Ω_ƒ
 += 1;

620 i‡(!
zîo
)

621 
°Ω_±r
 +
°Ω_size
;

625 
	}
}

643 
	$nova_upd©e_block_csum
(
su≥r_block
 *
sb
,

644 
nova_öode_öfo_hódî
 *
sih
, 
u8
 *
block
, 
blockƒ
,

645 
size_t
 
off£t
, size_à
byãs
, 
zîo
)

647 
u8
 *
°Ω_±r
;

648 
size_t
 
blockoff
;

649 
°Ω_shi·
 = 
NOVA_STRIPE_SHIFT
;

650 
°Ω_ödex
, 
°Ω_off£t
;

651 
°Ωs
, 
°Ω_ƒ
;

652 
	`INIT_TIMING
(
block_csum_time
);

654 
	`NOVA_START_TIMING
(
block_csum_t
, 
block_csum_time
);

655 
blockoff
 = 
	`nova_gë_block_off
(
sb
, 
blockƒ
, 
sih
->
i_blk_ty≥
);

664 
°Ω_ödex
 = 
off£t
 >> 
°Ω_shi·
;

665 
°Ω_off£t
 = 
off£t
 - (
°Ω_ödex
 << 
°Ω_shi·
);

667 
°Ωs
 = ((
°Ω_off£t
 + 
byãs
 - 1Ë>> 
°Ω_shi·
) + 1;

668 
°Ω_ƒ
 = (
blockoff
 + 
off£t
Ë>> 
°Ω_shi·
;

669 
°Ω_±r
 = 
block
 + (
°Ω_ödex
 << 
°Ω_shi·
);

671 
	`nova_upd©e_°rùe_csum
(
sb
, 
°Ωs
, 
°Ω_ƒ
, 
°Ω_±r
, 
zîo
);

673 
	`NOVA_END_TIMING
(
block_csum_t
, 
block_csum_time
);

676 
	}
}

678 
	$nova_upd©e_pgoff_csum
(
su≥r_block
 *
sb
,

679 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

680 
pgoff
, 
zîo
)

682 *
dax_mem
 = 
NULL
;

683 
u64
 
blockoff
;

684 
size_t
 
°Ω_size
 = 
NOVA_STRIPE_SIZE
;

685 
°Ω_shi·
 = 
NOVA_STRIPE_SHIFT
;

686 
°Ω_ƒ
;

687 
cou¡
;

689 
cou¡
 = 
blk_ty≥_to_size
[
sih
->
i_blk_ty≥
] / 
°Ω_size
;

691 
blockoff
 = 
	`nova_föd_nvmm_block
(
sb
, 
sih
, 
íåy
, 
pgoff
);

694 i‡(
blockoff
 == 0)

697 
dax_mem
 = 
	`nova_gë_block
(
sb
, 
blockoff
);

699 
°Ω_ƒ
 = 
blockoff
 >> 
°Ω_shi·
;

701 
	`nova_upd©e_°rùe_csum
(
sb
, 
cou¡
, 
°Ω_ƒ
, 
dax_mem
, 
zîo
);

704 
	}
}

716 
boﬁ
 
	$nova_vîify_d©a_csum
(
su≥r_block
 *
sb
,

717 
nova_öode_öfo_hódî
 *
sih
, 
blockƒ
,

718 
size_t
 
off£t
, size_à
byãs
)

720 *
block±r
, *
°Ω_±r
;

721 
size_t
 
blockoff
, 
blocksize
 = 
	`nova_öode_blk_size
(
sih
);

722 
size_t
 
°Ω_size
 = 
NOVA_STRIPE_SIZE
;

723 
°Ω_shi·
 = 
NOVA_STRIPE_SHIFT
;

724 
°Ω_ödex
;

725 
°Ω
, 
°Ωs
, 
°Ω_ƒ
;

726 *
°rù
 = 
NULL
;

727 
u32
 
csum_ˇlc
, 
csum_nvmm0
, 
csum_nvmm1
;

728 
u32
 *
csum_addr0
, *
csum_addr1
;

729 
îr‹
;

730 
boﬁ
 
m©ch
;

731 
úq_Êags
 = 0;

732 
	`INIT_TIMING
(
vîify_time
);

734 
	`NOVA_START_TIMING
(
vîify_d©a_csum_t
, 
vîify_time
);

739 
°Ωs
 = ((
off£t
 + 
byãs
 - 1Ë>> 
°Ω_shi·
)

740 - (
off£t
 >> 
°Ω_shi·
) + 1;

742 
blockoff
 = 
	`nova_gë_block_off
(
sb
, 
blockƒ
, 
sih
->
i_blk_ty≥
);

743 
block±r
 = 
	`nova_gë_block
(
sb
, 
blockoff
);

749 
°Ω_ƒ
 = (
blockoff
 + 
off£t
Ë>> 
°Ω_shi·
;

750 
°Ω_ödex
 = 
off£t
 >> 
°Ω_shi·
;

751 
°Ω_±r
 = 
block±r
 + (
°Ω_ödex
 << 
°Ω_shi·
);

753 
°rù
 = 
	`kmÆloc
(
°Ω_size
, 
GFP_KERNEL
);

754 i‡(
°rù
 =
NULL
)

755  
Ál£
;

757 
m©ch
 = 
åue
;

758 
°Ω
 = 0; så∞< 
°Ωs
; strp++) {

759 
csum_addr0
 = 
	`nova_gë_d©a_csum_addr
(
sb
, 
°Ω_ƒ
, 0);

760 
csum_nvmm0
 = 
	`À32_to_˝u
(*
csum_addr0
);

762 
csum_addr1
 = 
	`nova_gë_d©a_csum_addr
(
sb
, 
°Ω_ƒ
, 1);

763 
csum_nvmm1
 = 
	`À32_to_˝u
(*
csum_addr1
);

765 i‡(
	`mem˝y
(
°rù
, 
°Ω_±r
, 
°Ω_size
Ë=
NULL
)

766 
îr‹
 = -1;

767 i‡(
îr‹
 < 0) {

768 
	`nova_dbg
("%s: mediaÉrror in data strip detected!\n",

769 
__func__
);

770 
m©ch
 = 
Ál£
;

772 
csum_ˇlc
 = 
	`nova_¸c32c
(
NOVA_INIT_CSUM
, 
°rù
,

773 
°Ω_size
);

774 
m©ch
 = (
csum_ˇlc
 =
csum_nvmm0
) ||

775 (
csum_ˇlc
 =
csum_nvmm1
);

778 i‡(!
m©ch
) {

787 
	`nova_dbg
("%s:Çova data corruption detected! inode %lu, strp %lu of %lu, block offset %lu, stripeÇr %lu, csum calc 0x%08x, csumÇvmm 0x%08x, csumÇvmmÑeplica 0x%08x\n",

788 
__func__
, 
sih
->
öo
, 
°Ω
, 
°Ωs
, 
blockoff
,

789 
°Ω_ƒ
, 
csum_ˇlc
, 
csum_nvmm0
, 
csum_nvmm1
);

791 i‡(
d©a_∑rôy
 == 0) {

792 
	`nova_dbg
("%s:Ço dataÑedundancyávailable, canÇotÑepair data corruption!\n",

793 
__func__
);

797 
	`nova_dbg
("%s:Çov®d©®ªcovîy begös\n", 
__func__
);

799 
îr‹
 = 
	`nova_ª°‹e_d©a
(
sb
, 
blockƒ
, 
°Ω_ödex
,

800 
°rù
, 
îr‹
, 
csum_nvmm0
, 
csum_nvmm1
,

801 &
csum_ˇlc
);

802 i‡(
îr‹
) {

803 
	`nova_dbg
("%s:Çova dataÑecovery fails!\n",

804 
__func__
);

805 
	`dump_°ack
();

812 
	`nova_dbg
("%s:Çov®d©®ªcovîy suc˚ss!\n", 
__func__
);

813 
m©ch
 = 
åue
;

820 i‡(
csum_nvmm0
 !
csum_nvmm1
) {

824 
	`nova_dbg
("%s:Çova checksum corruption detected! inode %lu, strp %lu of %lu, block offset %lu, stripeÇr %lu, csum calc 0x%08x, csumÇvmm 0x%08x, csumÇvmmÑeplica 0x%08x\n",

825 
__func__
, 
sih
->
öo
, 
°Ω
, 
°Ωs
, 
blockoff
,

826 
°Ω_ƒ
, 
csum_ˇlc
, 
csum_nvmm0
, 
csum_nvmm1
);

828 
	`nova_memu∆ock_ønge
(
sb
, 
csum_addr0
,

829 
NOVA_DATA_CSUM_LEN
, &
úq_Êags
);

830 i‡(
csum_nvmm0
 !
csum_ˇlc
) {

831 
csum_nvmm0
 = 
	`˝u_to_À32
(
csum_ˇlc
);

832 
	`mem˝y_to_pmem_noˇche
(
csum_addr0
, &
csum_nvmm0
,

833 
NOVA_DATA_CSUM_LEN
);

836 i‡(
csum_nvmm1
 !
csum_ˇlc
) {

837 
csum_nvmm1
 = 
	`˝u_to_À32
(
csum_ˇlc
);

838 
	`mem˝y_to_pmem_noˇche
(
csum_addr1
, &
csum_nvmm1
,

839 
NOVA_DATA_CSUM_LEN
);

841 
	`nova_memlock_ønge
(
sb
, 
csum_addr0
, 
NOVA_DATA_CSUM_LEN
, &
úq_Êags
);

843 
	`nova_dbg
("%s:Çova checksum corruptionÑepaired!\n",

844 
__func__
);

850 
°Ω_ƒ
 += 1;

851 
°Ω_ödex
 += 1;

852 
°Ω_±r
 +
°Ω_size
;

853 i‡(
°Ω_ödex
 =(
blocksize
 >> 
°Ω_shi·
)) {

854 
blockƒ
 += 1;

855 
blockoff
 +
blocksize
;

856 
°Ω_ödex
 = 0;

861 i‡(
°rù
 !
NULL
)

862 
	`k‰ì
(
°rù
);

864 
	`NOVA_END_TIMING
(
vîify_d©a_csum_t
, 
vîify_time
);

866  
m©ch
;

867 
	}
}

869 
	$nova_upd©e_åunˇãd_block_csum
(
su≥r_block
 *
sb
,

870 
öode
 *öode, 
loff_t
 
√wsize
) {

872 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

873 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

874 
off£t
 = 
√wsize
 & (
sb
->
s_blocksize
 - 1);

875 
pgoff
, 
Àngth
;

876 
u64
 
nvmm
;

877 *
nvmm_addr
, *
°Ω_addr
, *
èû_°Ω
 = 
NULL
;

878 
°Ω_size
 = 
NOVA_STRIPE_SIZE
;

879 
°Ω_shi·
 = 
NOVA_STRIPE_SHIFT
;

880 
°Ω_ödex
, 
°Ω_off£t
;

881 
°Ωs
, 
°Ω_ƒ
;

883 
Àngth
 = 
sb
->
s_blocksize
 - 
off£t
;

884 
pgoff
 = 
√wsize
 >> 
sb
->
s_blocksize_bôs
;

886 
nvmm
 = 
	`nova_föd_nvmm_block
(
sb
, 
sih
, 
NULL
, 
pgoff
);

887 i‡(
nvmm
 == 0)

888  -
EFAULT
;

890 
nvmm_addr
 = (*)
	`nova_gë_block
(
sb
, 
nvmm
);

892 
°Ω_ödex
 = 
off£t
 >> 
°Ω_shi·
;

893 
°Ω_off£t
 = 
off£t
 - (
°Ω_ödex
 << 
°Ω_shi·
);

895 
°Ωs
 = ((
°Ω_off£t
 + 
Àngth
 - 1Ë>> 
°Ω_shi·
) + 1;

896 
°Ω_ƒ
 = (
nvmm
 + 
off£t
Ë>> 
°Ω_shi·
;

897 
°Ω_addr
 = 
nvmm_addr
 + (
°Ω_ödex
 << 
°Ω_shi·
);

899 i‡(
°Ω_off£t
 > 0) {

901 
èû_°Ω
 = 
	`kzÆloc
(
°Ω_size
, 
GFP_KERNEL
);

902 i‡(
èû_°Ω
 =
NULL
)

903  -
ENOMEM
;

905 i‡(
	`mem˝y
(
èû_°Ω
, 
°Ω_addr
, 
°Ω_off£t
Ë=
NULL
)

906  -
EIO
;

908 
	`nova_upd©e_°rùe_csum
(
sb
, 1, 
°Ω_ƒ
, 
èû_°Ω
, 0);

910 
°Ωs
--;

911 
°Ω_ƒ
++;

914 i‡(
°Ωs
 > 0)

915 
	`nova_upd©e_°rùe_csum
(
sb
, 
°Ωs
, 
°Ω_ƒ
, 
NULL
, 1);

917 i‡(
èû_°Ω
 !
NULL
)

918 
	`k‰ì
(
èû_°Ω
);

921 
	}
}

	@dax.c

16 
	~<löux/moduÀ.h
>

17 
	~<löux/buf„r_hód.h
>

18 
	~<löux/˝u„©uª.h
>

19 
	~<asm/pgèbÀ.h
>

20 
	~<löux/vîsi⁄.h
>

21 
	~"nova.h
"

22 
	~"öode.h
"

26 
ölöe
 
	$nova_c›y_∑πül_block
(
su≥r_block
 *
sb
,

27 
nova_öode_öfo_hódî
 *
sih
,

28 
nova_fûe_wrôe_íåy
 *
íåy
, 
ödex
,

29 
size_t
 
off£t
, size_à
Àngth
, *
kmem
)

31 *
±r
;

32 
rc
 = 0;

33 
nvmm
;

35 
nvmm
 = 
	`gë_nvmm
(
sb
, 
sih
, 
íåy
, 
ödex
);

36 
±r
 = 
	`nova_gë_block
(
sb
, (
nvmm
 << 
PAGE_SHIFT
));

38 i‡(
±r
 !
NULL
) {

39 i‡(
suµ‹t_˛wb
) {

40 i‡(
	`mem˝y
(
kmem
 + 
off£t
, 
±r
 + off£t, 
Àngth
Ë=
NULL
)

41 
rc
 = -1;

43 
	`mem˝y_to_pmem_noˇche
(
kmem
 + 
off£t
, 
±r
 + offset,

44 
Àngth
);

48  
rc
;

49 
	}
}

51 
ölöe
 
	$nova_h™dÀ_∑πül_block
(
su≥r_block
 *
sb
,

52 
nova_öode_öfo_hódî
 *
sih
,

53 
nova_fûe_wrôe_íåy
 *
íåy
, 
ödex
,

54 
size_t
 
off£t
, size_à
Àngth
, *
kmem
)

56 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

57 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

58 
úq_Êags
 = 0;

60 
	`nova_memu∆ock_block
(
sb
, 
kmem
, &
úq_Êags
);

61 i‡(
íåy
 =
NULL
) {

63 i‡(
suµ‹t_˛wb
)

64 
	`mem£t
(
kmem
 + 
off£t
, 0, 
Àngth
);

66 
	`mem˝y_to_pmem_noˇche
(
kmem
 + 
off£t
,

67 
sbi
->
zî€d_∑ge
, 
Àngth
);

70 i‡(
mëad©a_csum
 == 0)

71 
íåyc
 = 
íåy
;

73 
íåyc
 = &
íåy_c›y
;

74 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

75  -
EIO
;

78 
	`nova_c›y_∑πül_block
(
sb
, 
sih
, 
íåyc
, 
ödex
,

79 
off£t
, 
Àngth
, 
kmem
);

82 
	`nova_memlock_block
(
sb
, 
kmem
, &
úq_Êags
);

83 i‡(
suµ‹t_˛wb
)

84 
	`nova_Êush_buf„r
(
kmem
 + 
off£t
, 
Àngth
, 0);

86 
	}
}

93 
	$nova_h™dÀ_hód_èû_blocks
(
su≥r_block
 *
sb
,

94 
öode
 *öode, 
loff_t
 
pos
, 
size_t
 
cou¡
, *
kmem
)

96 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

97 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

98 
size_t
 
off£t
, 
eblk_off£t
;

99 
°¨t_blk
, 
íd_blk
, 
num_blocks
;

100 
nova_fûe_wrôe_íåy
 *
íåy
;

101 
	`INIT_TIMING
(
∑πül_time
);

102 
ªt
 = 0;

104 
	`NOVA_START_TIMING
(
∑πül_block_t
, 
∑πül_time
);

105 
off£t
 = 
pos
 & (
sb
->
s_blocksize
 - 1);

106 
num_blocks
 = ((
cou¡
 + 
off£t
 - 1Ë>> 
sb
->
s_blocksize_bôs
) + 1;

108 
off£t
 = 
pos
 & (
	`nova_öode_blk_size
(
sih
) - 1);

109 
°¨t_blk
 = 
pos
 >> 
sb
->
s_blocksize_bôs
;

110 
íd_blk
 = 
°¨t_blk
 + 
num_blocks
 - 1;

112 
	`nova_dbg_vîbo£
("%s: %lu blocks\n", 
__func__
, 
num_blocks
);

116 
	`nova_dbg_vîbo£
("%s: sèπ off£à%lu sèπ blk %lu %p\n", 
__func__
,

117 
off£t
, 
°¨t_blk
, 
kmem
);

118 i‡(
off£t
 != 0) {

119 
íåy
 = 
	`nova_gë_wrôe_íåy
(
sb
, 
sih
, 
°¨t_blk
);

120 
ªt
 = 
	`nova_h™dÀ_∑πül_block
(
sb
, 
sih
, 
íåy
,

121 
°¨t_blk
, 0, 
off£t
, 
kmem
);

122 i‡(
ªt
 < 0)

123  
ªt
;

126 
kmem
 = (*)((*)kmem +

127 ((
num_blocks
 - 1Ë<< 
sb
->
s_blocksize_bôs
));

128 
eblk_off£t
 = (
pos
 + 
cou¡
Ë& (
	`nova_öode_blk_size
(
sih
) - 1);

129 
	`nova_dbg_vîbo£
("%s:Énd off£à%lu,Énd blk %lu %p\n", 
__func__
,

130 
eblk_off£t
, 
íd_blk
, 
kmem
);

131 i‡(
eblk_off£t
 != 0) {

132 
íåy
 = 
	`nova_gë_wrôe_íåy
(
sb
, 
sih
, 
íd_blk
);

134 
ªt
 = 
	`nova_h™dÀ_∑πül_block
(
sb
, 
sih
, 
íåy
, 
íd_blk
,

135 
eblk_off£t
,

136 
sb
->
s_blocksize
 - 
eblk_off£t
,

137 
kmem
);

138 i‡(
ªt
 < 0)

139  
ªt
;

141 
	`NOVA_END_TIMING
(
∑πül_block_t
, 
∑πül_time
);

143  
ªt
;

144 
	}
}

146 
	$nova_ªassign_fûe_åì
(
su≥r_block
 *
sb
,

147 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
begö_èû
)

149 *
addr
;

150 
nova_fûe_wrôe_íåy
 *
íåy
;

151 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

152 
u64
 
cuº_p
 = 
begö_èû
;

153 
size_t
 
íåy_size
 = (
nova_fûe_wrôe_íåy
);

155 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

157 
cuº_p
 && cuº_∞!
sih
->
log_èû
) {

158 i‡(
	`is_œ°_íåy
(
cuº_p
, 
íåy_size
))

159 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

161 i‡(
cuº_p
 == 0) {

162 
	`nova_îr
(
sb
, "%s: File inode %luÜog is NULL!\n",

163 
__func__
, 
sih
->
öo
);

164  -
EINVAL
;

167 
addr
 = (*Ë
	`nova_gë_block
(
sb
, 
cuº_p
);

168 
íåy
 = (
nova_fûe_wrôe_íåy
 *Ë
addr
;

170 i‡(
mëad©a_csum
 == 0)

171 
íåyc
 = 
íåy
;

172 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

173  -
EIO
;

175 i‡(
	`nova_gë_íåy_ty≥
(
íåyc
Ë!
FILE_WRITE
) {

176 
	`nova_dbg
("%s:ÉntryÅype isÇot write? %d\n",

177 
__func__
, 
	`nova_gë_íåy_ty≥
(
íåy
));

178 
cuº_p
 +
íåy_size
;

182 
	`nova_assign_wrôe_íåy
(
sb
, 
sih
, 
íåy
, 
íåyc
, 
åue
);

183 
cuº_p
 +
íåy_size
;

187 
	}
}

189 
	$nova_˛ónup_öcom∂ëe_wrôe
(
su≥r_block
 *
sb
,

190 
nova_öode_öfo_hódî
 *
sih
, 
blockƒ
,

191 
Æloˇãd
, 
u64
 
begö_èû
, u64 
íd_èû
)

193 *
addr
;

194 
nova_fûe_wrôe_íåy
 *
íåy
;

195 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

196 
u64
 
cuº_p
 = 
begö_èû
;

197 
size_t
 
íåy_size
 = (
nova_fûe_wrôe_íåy
);

199 i‡(
blockƒ
 > 0 && 
Æloˇãd
 > 0)

200 
	`nova_‰ì_d©a_blocks
(
sb
, 
sih
, 
blockƒ
, 
Æloˇãd
);

202 i‡(
begö_èû
 =0 || 
íd_èû
 == 0)

205 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

207 
cuº_p
 !
íd_èû
) {

208 i‡(
	`is_œ°_íåy
(
cuº_p
, 
íåy_size
))

209 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

211 i‡(
cuº_p
 == 0) {

212 
	`nova_îr
(
sb
, "%s: File inode %luÜog is NULL!\n",

213 
__func__
, 
sih
->
öo
);

214  -
EINVAL
;

217 
addr
 = (*Ë
	`nova_gë_block
(
sb
, 
cuº_p
);

218 
íåy
 = (
nova_fûe_wrôe_íåy
 *Ë
addr
;

220 i‡(
mëad©a_csum
 == 0)

221 
íåyc
 = 
íåy
;

226 i‡(
	`mem˝y
(
íåyc
, 
íåy
,

227 (
nova_fûe_wrôe_íåy
)Ë=
NULL
)

228  -
EIO
;

231 i‡(
	`nova_gë_íåy_ty≥
(
íåyc
Ë!
FILE_WRITE
) {

232 
	`nova_dbg
("%s:ÉntryÅype isÇot write? %d\n",

233 
__func__
, 
	`nova_gë_íåy_ty≥
(
íåy
));

234 
cuº_p
 +
íåy_size
;

238 
blockƒ
 = 
íåyc
->
block
 >> 
PAGE_SHIFT
;

239 
	`nova_‰ì_d©a_blocks
(
sb
, 
sih
, 
blockƒ
, 
íåyc
->
num_∑ges
);

240 
cuº_p
 +
íåy_size
;

244 
	}
}

246 
	$nova_öô_fûe_wrôe_íåy
(
su≥r_block
 *
sb
,

247 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

248 
u64
 
ïoch_id
, u64 
pgoff
, 
num_∑ges
, u64 
blockƒ
, 
u32
 
time
,

249 
u64
 
fûe_size
)

251 
	`mem£t
(
íåy
, 0, (
nova_fûe_wrôe_íåy
));

252 
íåy
->
íåy_ty≥
 = 
FILE_WRITE
;

253 
íåy
->
ªassig√d
 = 0;

254 
íåy
->
upd©ög
 = 0;

255 
íåy
->
ïoch_id
 =Époch_id;

256 
íåy
->
å™s_id
 = 
sih
->trans_id;

257 
íåy
->
pgoff
 = 
	`˝u_to_À64
(pgoff);

258 
íåy
->
num_∑ges
 = 
	`˝u_to_À32
(num_pages);

259 
íåy
->
övÆid_∑ges
 = 0;

260 
íåy
->
block
 = 
	`˝u_to_À64
(
	`nova_gë_block_off
(
sb
, 
blockƒ
,

261 
sih
->
i_blk_ty≥
));

262 
íåy
->
mtime
 = 
	`˝u_to_À32
(
time
);

264 
íåy
->
size
 = 
fûe_size
;

265 
	}
}

267 
	$nova_¥Ÿe˘_fûe_d©a
(
su≥r_block
 *
sb
, 
öode
 *inode,

268 
loff_t
 
pos
, 
size_t
 
cou¡
, c⁄° 
__u£r
 *
buf
, 
blockƒ
,

269 
boﬁ
 
ö∂a˚
)

271 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

272 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

273 
size_t
 
off£t
, 
eblk_off£t
, 
byãs
, 
À·
;

274 
°¨t_blk
, 
íd_blk
, 
num_blocks
, 
nvmm
, 
nvmmoff
;

275 
blocksize
 = 
sb
->
s_blocksize
;

276 
blocksize_bôs
 = 
sb
->
s_blocksize_bôs
;

277 
u8
 *
blockbuf
, *
block±r
;

278 
nova_fûe_wrôe_íåy
 *
íåy
;

279 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

280 
boﬁ
 
m≠≥d
, 
nvmm_ok
;

281 
ªt
 = 0;

282 
	`INIT_TIMING
(
¥Ÿe˘_fûe_d©a_time
);

283 
	`INIT_TIMING
(
mem˝y_time
);

285 
	`NOVA_START_TIMING
(
¥Ÿe˘_fûe_d©a_t
, 
¥Ÿe˘_fûe_d©a_time
);

287 
off£t
 = 
pos
 & (
blocksize
 - 1);

288 
num_blocks
 = ((
off£t
 + 
cou¡
 - 1Ë>> 
blocksize_bôs
) + 1;

289 
°¨t_blk
 = 
pos
 >> 
blocksize_bôs
;

290 
íd_blk
 = 
°¨t_blk
 + 
num_blocks
 - 1;

292 
	`NOVA_START_TIMING
(
¥Ÿe˘_mem˝y_t
, 
mem˝y_time
);

293 
blockbuf
 = 
	`kmÆloc
(
blocksize
, 
GFP_KERNEL
);

294 i‡(
blockbuf
 =
NULL
) {

295 
	`nova_îr
(
sb
, "%s: block buf„∏Æloˇti⁄Éº‹\n", 
__func__
);

296  -
ENOMEM
;

299 
byãs
 = 
blocksize
 - 
off£t
;

300 i‡(
byãs
 > 
cou¡
)

301 
byãs
 = 
cou¡
;

303 
À·
 = 
	`c›y_‰om_u£r
(
blockbuf
 + 
off£t
, 
buf
, 
byãs
);

304 
	`NOVA_END_TIMING
(
¥Ÿe˘_mem˝y_t
, 
mem˝y_time
);

305 i‡(
	`u∆ikñy
(
À·
 != 0)) {

306 
	`nova_îr
(
sb
, "%s:Çotáll data is copied from user!ÉxpectÅo copy %zu bytes,áctually copied %zu bytes\n",

307 
__func__
, 
byãs
, byã†- 
À·
);

308 
ªt
 = -
EFAULT
;

309 
out
;

312 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

314 i‡(
off£t
 != 0) {

315 
	`NOVA_STATS_ADD
(
¥Ÿe˘_hód
, 1);

316 
íåy
 = 
	`nova_gë_wrôe_íåy
(
sb
, 
sih
, 
°¨t_blk
);

317 i‡(
íåy
 !
NULL
) {

318 i‡(
mëad©a_csum
 == 0)

319 
íåyc
 = 
íåy
;

320 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

321  -
EIO
;

324 
nvmm
 = 
	`gë_nvmm
(
sb
, 
sih
, 
íåyc
, 
°¨t_blk
);

325 
nvmmoff
 = 
	`nova_gë_block_off
(
sb
, 
nvmm
, 
sih
->
i_blk_ty≥
);

326 
block±r
 = (
u8
 *Ë
	`nova_gë_block
(
sb
, 
nvmmoff
);

328 
m≠≥d
 = 
	`nova_föd_pgoff_ö_vma
(
öode
, 
°¨t_blk
);

329 i‡(
d©a_csum
 > 0 && !
m≠≥d
 && !
ö∂a˚
) {

330 
nvmm_ok
 = 
	`nova_vîify_d©a_csum
(
sb
, 
sih
, 
nvmm
,

331 0, 
off£t
);

332 i‡(!
nvmm_ok
) {

333 
ªt
 = -
EIO
;

334 
out
;

338 i‡(
	`mem˝y
(
blockbuf
, 
block±r
, 
off£t
Ë=
NULL
)

339 
ªt
 = -1;

340 i‡(
ªt
 < 0)

341 
out
;

343 
	`mem£t
(
blockbuf
, 0, 
off£t
);

354 i‡(
num_blocks
 == 1)

355 
eblk
;

358 i‡(
ö∂a˚
)

359 
	`nova_upd©e_block_csum_∑rôy
(
sb
, 
sih
, 
blockbuf
,

360 
blockƒ
, 
off£t
, 
byãs
);

362 
	`nova_upd©e_block_csum_∑rôy
(
sb
, 
sih
, 
blockbuf
,

363 
blockƒ
, 0, 
blocksize
);

365 
blockƒ
++;

366 
pos
 +
byãs
;

367 
buf
 +
byãs
;

368 
cou¡
 -
byãs
;

369 
off£t
 = 
pos
 & (
blocksize
 - 1);

371 
byãs
 = 
cou¡
 < 
blocksize
 ? count : blocksize;

372 
À·
 = 
	`c›y_‰om_u£r
(
blockbuf
, 
buf
, 
byãs
);

373 i‡(
	`u∆ikñy
(
À·
 != 0)) {

374 
	`nova_îr
(
sb
, "%s:Çotáll data is copied from user!ÉxpectÅo copy %zu bytes,áctually copied %zu bytes\n",

375 
__func__
, 
byãs
, byã†- 
À·
);

376 
ªt
 = -
EFAULT
;

377 
out
;

379 } 
cou¡
 > 
blocksize
);

381 
eblk
:

382 
eblk_off£t
 = (
pos
 + 
cou¡
Ë& (
blocksize
 - 1);

384 i‡(
eblk_off£t
 != 0) {

385 
	`NOVA_STATS_ADD
(
¥Ÿe˘_èû
, 1);

386 
íåy
 = 
	`nova_gë_wrôe_íåy
(
sb
, 
sih
, 
íd_blk
);

387 i‡(
íåy
 !
NULL
) {

388 i‡(
mëad©a_csum
 == 0)

389 
íåyc
 = 
íåy
;

390 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

391  -
EIO
;

394 
nvmm
 = 
	`gë_nvmm
(
sb
, 
sih
, 
íåyc
, 
íd_blk
);

395 
nvmmoff
 = 
	`nova_gë_block_off
(
sb
, 
nvmm
, 
sih
->
i_blk_ty≥
);

396 
block±r
 = (
u8
 *Ë
	`nova_gë_block
(
sb
, 
nvmmoff
);

398 
m≠≥d
 = 
	`nova_föd_pgoff_ö_vma
(
öode
, 
íd_blk
);

399 i‡(
d©a_csum
 > 0 && !
m≠≥d
 && !
ö∂a˚
) {

400 
nvmm_ok
 = 
	`nova_vîify_d©a_csum
(
sb
, 
sih
, 
nvmm
,

401 
eblk_off£t
, 
blocksize
 -Éblk_offset);

402 i‡(!
nvmm_ok
) {

403 
ªt
 = -
EIO
;

404 
out
;

408 i‡(
	`mem˝y
(
blockbuf
 + 
eblk_off£t
,

409 
block±r
 + 
eblk_off£t
,

410 
blocksize
 - 
eblk_off£t
Ë=
NULL
)

411 
ªt
 = -1;

412 i‡(
ªt
 < 0)

413 
out
;

415 
	`mem£t
(
blockbuf
 + 
eblk_off£t
, 0,

416 
blocksize
 - 
eblk_off£t
);

427 i‡(
ö∂a˚
)

428 
	`nova_upd©e_block_csum_∑rôy
(
sb
, 
sih
, 
blockbuf
, 
blockƒ
,

429 
off£t
, 
byãs
);

431 
	`nova_upd©e_block_csum_∑rôy
(
sb
, 
sih
, 
blockbuf
, 
blockƒ
,

432 0, 
blocksize
);

434 
out
:

435 i‡(
blockbuf
 !
NULL
)

436 
	`k‰ì
(
blockbuf
);

438 
	`NOVA_END_TIMING
(
¥Ÿe˘_fûe_d©a_t
, 
¥Ÿe˘_fûe_d©a_time
);

440  
ªt
;

441 
	}
}

443 
boﬁ
 
	$nova_gë_vîify_íåy
(
su≥r_block
 *
sb
,

444 
nova_fûe_wrôe_íåy
 *
íåy
,

445 
nova_fûe_wrôe_íåy
 *
íåyc
,

446 
locked
)

448 
ªt
 = 0;

450 i‡(
mëad©a_csum
 == 0)

451  
åue
;

453 i‡(
locked
 == 0) {

455 i‡(
	`mem˝y
(
íåyc
, 
íåy
,

456 (
nova_fûe_wrôe_íåy
)Ë=
NULL
)

457 
ªt
 = -1;

458 i‡(
ªt
 < 0)

459  
Ál£
;

461  
åue
;

464  
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
);

465 
	}
}

471 
	$nova_check_exi°ög_íåy
(
su≥r_block
 *
sb
,

472 
öode
 *öode, 
num_blocks
, 
°¨t_blk
,

473 
nova_fûe_wrôe_íåy
 **
ªt_íåy
,

474 
nova_fûe_wrôe_íåy
 *
ªt_íåyc
, 
check_√xt
, 
u64
 
ïoch_id
,

475 *
ö∂a˚
, 
locked
)

477 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

478 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

479 
nova_fûe_wrôe_íåy
 *
íåy
;

480 
nova_fûe_wrôe_íåy
 *
íåyc
;

481 
√xt_pgoff
;

482 
ít_blks
 = 0;

483 
	`INIT_TIMING
(
check_time
);

485 
	`NOVA_START_TIMING
(
check_íåy_t
, 
check_time
);

487 *
ªt_íåy
 = 
NULL
;

488 *
ö∂a˚
 = 0;

489 
íåy
 = 
	`nova_gë_wrôe_íåy
(
sb
, 
sih
, 
°¨t_blk
);

491 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : 
ªt_íåyc
;

493 i‡(
íåy
) {

494 i‡(
mëad©a_csum
 == 0)

495 
íåyc
 = 
íåy
;

496 i‡(!
	`nova_gë_vîify_íåy
(
sb
, 
íåy
, 
íåyc
, 
locked
))

497 
out
;

499 *
ªt_íåy
 = 
íåy
;

502 i‡(
íåyc
->
ªassig√d
 == 0)

503 
ít_blks
 = 
íåyc
->
num_∑ges
 -

504 (
°¨t_blk
 - 
íåyc
->
pgoff
);

506 
ít_blks
 = 1;

508 i‡(
ít_blks
 > 
num_blocks
)

509 
ít_blks
 = 
num_blocks
;

511 i‡(
íåyc
->
ïoch_id
 ==Époch_id)

512 *
ö∂a˚
 = 1;

514 } i‡(
check_√xt
) {

516 
íåy
 = 
	`nova_föd_√xt_íåy
(
sb
, 
sih
, 
°¨t_blk
);

517 i‡(
íåy
) {

518 i‡(
mëad©a_csum
 == 0)

519 
íåyc
 = 
íåy
;

520 i‡(!
	`nova_gë_vîify_íåy
(
sb
, 
íåy
, 
íåyc
,

521 
locked
))

522 
out
;

524 
√xt_pgoff
 = 
íåyc
->
pgoff
;

525 i‡(
√xt_pgoff
 <
°¨t_blk
) {

526 
	`nova_îr
(
sb
, "iblock %lu,ÉntryÖgoff %lu,ÇumÖages %lu\n",

527 
°¨t_blk
, 
√xt_pgoff
, 
íåy
->
num_∑ges
);

528 
	`nova_¥öt_öode_log
(
sb
, 
öode
);

529 
	`BUG
();

530 
ít_blks
 = 
num_blocks
;

531 
out
;

533 
ít_blks
 = 
√xt_pgoff
 - 
°¨t_blk
;

534 i‡(
ít_blks
 > 
num_blocks
)

535 
ít_blks
 = 
num_blocks
;

538 
ít_blks
 = 
num_blocks
;

542 i‡(
íåy
 && 
ít_blks
 == 0) {

543 
	`nova_dbg
("%s: %d\n", 
__func__
, 
check_√xt
);

544 
	`dump_°ack
();

547 
out
:

548 
	`NOVA_END_TIMING
(
check_íåy_t
, 
check_time
);

549  
ít_blks
;

550 
	}
}

557 
ssize_t
 
	$do_nova_ö∂a˚_fûe_wrôe
(
fûe
 *
fûp
,

558 c⁄° 
__u£r
 *
buf
, 
size_t
 
Àn
, 
loff_t
 *
µos
)

560 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

561 
öode
 *öodê
m≠pög
->
ho°
;

562 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

563 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

564 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

565 
nova_öode
 *
pi
, 
öode_c›y
;

566 
nova_fûe_wrôe_íåy
 *
íåy
;

567 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

568 
nova_fûe_wrôe_íåy
 
íåy_d©a
;

569 
nova_öode_upd©e
 
upd©e
;

570 
ssize_t
 
wrôãn
 = 0;

571 
loff_t
 
pos
;

572 
size_t
 
cou¡
, 
off£t
, 
c›õd
;

573 
°¨t_blk
, 
num_blocks
, 
ít_blks
 = 0;

574 
tŸÆ_blocks
;

575 
√w_blocks
 = 0;

576 
blockƒ
 = 0;

577 
d©a_bôs
;

578 
Æloˇãd
 = 0;

579 
ö∂a˚
 = 0;

580 
boﬁ
 
hﬁe_fûl
 = 
Ál£
;

581 
boﬁ
 
upd©e_log
 = 
Ál£
;

582 *
kmem
;

583 
u64
 
blk_off
;

584 
size_t
 
byãs
;

585 
°©us
 = 0;

586 
	`INIT_TIMING
(
ö∂a˚_wrôe_time
);

587 
	`INIT_TIMING
(
mem˝y_time
);

588 
°ï
 = 0;

589 
u64
 
begö_èû
 = 0;

590 
u64
 
ïoch_id
;

591 
u64
 
fûe_size
;

592 
u32
 
time
;

593 
ssize_t
 
ªt
;

594 
úq_Êags
 = 0;

596 i‡(
Àn
 == 0)

600 
	`NOVA_START_TIMING
(
ö∂a˚_wrôe_t
, 
ö∂a˚_wrôe_time
);

603 i‡(!
	`ac˚ss_ok
(
buf
, 
Àn
)) {

604 
ªt
 = -
EFAULT
;

605 
out
;

607 
pos
 = *
µos
;

609 i‡(
fûp
->
f_Êags
 & 
O_APPEND
)

610 
pos
 = 
	`i_size_ªad
(
öode
);

612 
cou¡
 = 
Àn
;

614 
pi
 = 
	`nova_gë_block
(
sb
, 
sih
->
pi_addr
);

619 i‡(
	`nova_check_öode_öãgrôy
(
sb
, 
sih
->
öo
, sih->
pi_addr
,

620 
sih
->
Æãr_pi_addr
, &
öode_c›y
, 0) < 0) {

621 
ªt
 = -
EIO
;

622 
out
;

625 
off£t
 = 
pos
 & (
sb
->
s_blocksize
 - 1);

626 
num_blocks
 = ((
cou¡
 + 
off£t
 - 1Ë>> 
sb
->
s_blocksize_bôs
) + 1;

627 
tŸÆ_blocks
 = 
num_blocks
;

631 
ªt
 = 
	`fûe_ªmove_¥ivs
(
fûp
);

632 i‡(
ªt
)

633 
out
;

636 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

638 
time
 = 
	`cuºít_time
(
öode
).
tv_£c
;

640 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

642 
	`nova_dbgv
("%s:Époch_id %llu, inode %lu, offset %lld, count %lu\n",

643 
__func__
, 
ïoch_id
, 
öode
->
i_öo
, 
pos
, 
cou¡
);

644 
upd©e
.
èû
 = 
sih
->
log_èû
;

645 
upd©e
.
Æãr_èû
 = 
sih
->
Æãr_log_èû
;

646 
num_blocks
 > 0) {

647 
hﬁe_fûl
 = 
Ál£
;

648 
off£t
 = 
pos
 & (
	`nova_öode_blk_size
(
sih
) - 1);

649 
°¨t_blk
 = 
pos
 >> 
sb
->
s_blocksize_bôs
;

651 
ít_blks
 = 
	`nova_check_exi°ög_íåy
(
sb
, 
öode
, 
num_blocks
,

652 
°¨t_blk
, &
íåy
, &
íåy_c›y
,

653 1, 
ïoch_id
, &
ö∂a˚
, 1);

655 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

657 i‡(
íåy
 && 
ö∂a˚
) {

659 
blockƒ
 = 
	`gë_nvmm
(
sb
, 
sih
, 
íåyc
, 
°¨t_blk
);

660 
blk_off
 = 
blockƒ
 << 
PAGE_SHIFT
;

661 
Æloˇãd
 = 
ít_blks
;

662 i‡(
d©a_csum
 || 
d©a_∑rôy
)

663 
	`nova_£t_wrôe_íåy_upd©ög
(
sb
, 
íåy
, 1);

666 
Æloˇãd
 = 
	`nova_√w_d©a_blocks
(
sb
, 
sih
, &
blockƒ
,

667 
°¨t_blk
, 
ít_blks
, 
ALLOC_NO_INIT
,

668 
ANY_CPU
, 
ALLOC_FROM_HEAD
);

670 
	`nova_dbg_vîbo£
("%s:álloc %d blocks @ %lu\n",

671 
__func__
, 
Æloˇãd
, 
blockƒ
);

673 i‡(
Æloˇãd
 <= 0) {

674 
	`nova_dbg
("%sálloc blocks failed!, %d\n",

675 
__func__
, 
Æloˇãd
);

676 
ªt
 = 
Æloˇãd
;

677 
out
;

680 
hﬁe_fûl
 = 
åue
;

681 
√w_blocks
 +
Æloˇãd
;

682 
blk_off
 = 
	`nova_gë_block_off
(
sb
, 
blockƒ
,

683 
sih
->
i_blk_ty≥
);

686 
°ï
++;

687 
byãs
 = 
sb
->
s_blocksize
 * 
Æloˇãd
 - 
off£t
;

688 i‡(
byãs
 > 
cou¡
)

689 
byãs
 = 
cou¡
;

691 
kmem
 = 
	`nova_gë_block
(
öode
->
i_sb
, 
blk_off
);

693 i‡(
hﬁe_fûl
 &&

694 (
off£t
 || ((off£à+ 
byãs
Ë& (
PAGE_SIZE
 - 1)) != 0)) {

695 
ªt
 = 
	`nova_h™dÀ_hód_èû_blocks
(
sb
, 
öode
,

696 
pos
, 
byãs
, 
kmem
);

697 i‡(
ªt
)

698 
out
;

704 
	`NOVA_START_TIMING
(
mem˝y_w_nvmm_t
, 
mem˝y_time
);

705 
	`nova_memu∆ock_ønge
(
sb
, 
kmem
 + 
off£t
, 
byãs
, &
úq_Êags
);

706 
c›õd
 = 
byãs
 - 
	`mem˝y_to_pmem_noˇche
(
kmem
 + 
off£t
,

707 
buf
, 
byãs
);

708 
	`nova_memlock_ønge
(
sb
, 
kmem
 + 
off£t
, 
byãs
, &
úq_Êags
);

709 
	`NOVA_END_TIMING
(
mem˝y_w_nvmm_t
, 
mem˝y_time
);

711 i‡(
d©a_csum
 > 0 || 
d©a_∑rôy
 > 0) {

712 
ªt
 = 
	`nova_¥Ÿe˘_fûe_d©a
(
sb
, 
öode
, 
pos
, 
byãs
,

713 
buf
, 
blockƒ
, !
hﬁe_fûl
);

714 i‡(
ªt
)

715 
out
;

718 i‡(
pos
 + 
c›õd
 > 
öode
->
i_size
)

719 
fûe_size
 = 
	`˝u_to_À64
(
pos
 + 
c›õd
);

721 
fûe_size
 = 
	`˝u_to_À64
(
öode
->
i_size
);

724 i‡(
hﬁe_fûl
) {

725 
	`nova_öô_fûe_wrôe_íåy
(
sb
, 
sih
, &
íåy_d©a
,

726 
ïoch_id
, 
°¨t_blk
, 
Æloˇãd
,

727 
blockƒ
, 
time
, 
fûe_size
);

729 
ªt
 = 
	`nova_≠≥nd_fûe_wrôe_íåy
(
sb
, 
pi
, 
öode
,

730 &
íåy_d©a
, &
upd©e
);

731 i‡(
ªt
) {

732 
	`nova_dbg
("%s:áppend inodeÉntry failed\n",

733 
__func__
);

734 
ªt
 = -
ENOSPC
;

735 
out
;

739 
nova_log_íåy_öfo
 
íåy_öfo
;

741 
íåy_öfo
.
ty≥
 = 
FILE_WRITE
;

742 
íåy_öfo
.
ïoch_id
 =Époch_id;

743 
íåy_öfo
.
å™s_id
 = 
sih
->trans_id;

744 
íåy_öfo
.
time
 =Åime;

745 
íåy_öfo
.
fûe_size
 = file_size;

746 
íåy_öfo
.
ö∂a˚
 = 1;

748 
	`nova_ö∂a˚_upd©e_wrôe_íåy
(
sb
, 
öode
, 
íåy
,

749 &
íåy_öfo
);

752 
	`nova_dbgv
("Wrôe: %p, %lu\n", 
kmem
, 
c›õd
);

753 i‡(
c›õd
 > 0) {

754 
°©us
 = 
c›õd
;

755 
wrôãn
 +
c›õd
;

756 
pos
 +
c›õd
;

757 
buf
 +
c›õd
;

758 
cou¡
 -
c›õd
;

759 
num_blocks
 -
Æloˇãd
;

761 i‡(
	`u∆ikñy
(
c›õd
 !
byãs
)) {

762 
	`nova_dbg
("%s ERROR!: %p, bytes %lu, copied %lu\n",

763 
__func__
, 
kmem
, 
byãs
, 
c›õd
);

764 i‡(
°©us
 >= 0)

765 
°©us
 = -
EFAULT
;

767 i‡(
°©us
 < 0)

770 i‡(
hﬁe_fûl
) {

771 
upd©e_log
 = 
åue
;

772 i‡(
begö_èû
 == 0)

773 
begö_èû
 = 
upd©e
.
cuº_íåy
;

777 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
sih
->
i_blk_ty≥
];

778 
sih
->
i_blocks
 +(
√w_blocks
 << (
d©a_bôs
 - 
sb
->
s_blocksize_bôs
));

780 
öode
->
i_blocks
 = 
sih
->i_blocks;

782 i‡(
upd©e_log
) {

783 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

784 
	`nova_upd©e_öode
(
sb
, 
öode
, 
pi
, &
upd©e
, 1);

785 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

786 
	`NOVA_STATS_ADD
(
ö∂a˚_√w_blocks
, 1);

789 
ªt
 = 
	`nova_ªassign_fûe_åì
(
sb
, 
sih
, 
begö_èû
);

790 i‡(
ªt
)

791 
out
;

794 
ªt
 = 
wrôãn
;

795 
	`NOVA_STATS_ADD
(
ö∂a˚_wrôe_bªaks
, 
°ï
);

796 
	`nova_dbgv
("blocks: %Œu, %lu\n", 
öode
->
i_blocks
, 
sih
->i_blocks);

798 *
µos
 = 
pos
;

799 i‡(
pos
 > 
öode
->
i_size
) {

800 
	`i_size_wrôe
(
öode
, 
pos
);

801 
sih
->
i_size
 = 
pos
;

804 
sih
->
å™s_id
++;

805 
out
:

806 i‡(
ªt
 < 0)

807 
	`nova_˛ónup_öcom∂ëe_wrôe
(
sb
, 
sih
, 
blockƒ
, 
Æloˇãd
,

808 
begö_èû
, 
upd©e
.
èû
);

810 
	`NOVA_END_TIMING
(
ö∂a˚_wrôe_t
, 
ö∂a˚_wrôe_time
);

811 
	`NOVA_STATS_ADD
(
ö∂a˚_wrôe_byãs
, 
wrôãn
);

812  
ªt
;

813 
	}
}

818 
ssize_t
 
	$nova_ö∂a˚_fûe_wrôe
(
fûe
 *
fûp
,

819 c⁄° 
__u£r
 *
buf
, 
size_t
 
Àn
, 
loff_t
 *
µos
)

821 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

822 
öode
 *öodê
m≠pög
->
ho°
;

823 
ªt
;

825 i‡(
Àn
 == 0)

828 
	`sb_°¨t_wrôe
(
öode
->
i_sb
);

829 
	`öode_lock
(
öode
);

831 
ªt
 = 
	`do_nova_ö∂a˚_fûe_wrôe
(
fûp
, 
buf
, 
Àn
, 
µos
);

833 
	`öode_u∆ock
(
öode
);

834 
	`sb_íd_wrôe
(
öode
->
i_sb
);

836  
ªt
;

837 
	}
}

840 
	$nova_check_ovîœp_vmas
(
su≥r_block
 *
sb
,

841 
nova_öode_öfo_hódî
 *
sih
,

842 
pgoff
, 
num_∑ges
)

844 
°¨t_pgoff
 = 0;

845 
num
 = 0;

846 
i
;

847 
vma_ôem
 *
ôem
;

848 
rb_node
 *
ãmp
;

849 
ªt
 = 0;

851 i‡(
sih
->
num_vmas
 == 0)

854 
ãmp
 = 
	`rb_fú°
(&
sih
->
vma_åì
);

855 
ãmp
) {

856 
ôem
 = 
	`c⁄èöî_of
(
ãmp
, 
vma_ôem
, 
node
);

857 
ãmp
 = 
	`rb_√xt
(temp);

858 
ªt
 = 
	`nova_gë_vma_ovîœp_ønge
(
sb
, 
sih
, 
ôem
->
vma
, 
pgoff
,

859 
num_∑ges
, &
°¨t_pgoff
, &
num
);

860 i‡(
ªt
) {

861 
i
 = 0; i < 
num
; i++) {

862 i‡(
	`nova_gë_wrôe_íåy
(
sb
, 
sih
,

863 
°¨t_pgoff
 + 
i
))

870 
	}
}

878 
	$nova_dax_gë_blocks
(
öode
 *öode, 
£˘‹_t
 
iblock
,

879 
max_blocks
, 
u32
 *
bno
, 
boﬁ
 *
√w
, boﬁ *
bound¨y
,

880 
¸óã
, 
boﬁ
 
èkög_lock
)

882 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

883 
nova_öode
 *
pi
;

884 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

885 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

886 
nova_fûe_wrôe_íåy
 *
íåy
 = 
NULL
;

887 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

888 
nova_fûe_wrôe_íåy
 
íåy_d©a
;

889 
nova_öode_upd©e
 
upd©e
;

890 
u32
 
time
;

891 
d©a_bôs
;

892 
nvmm
 = 0;

893 
blockƒ
 = 0;

894 
u64
 
ïoch_id
;

895 
num_blocks
 = 0;

896 
ö∂a˚
 = 0;

897 
Æloˇãd
 = 0;

898 
locked
 = 0;

899 
check_√xt
 = 1;

900 
ªt
 = 0;

901 
úq_Êags
 = 0;

902 
	`INIT_TIMING
(
gë_block_time
);

904 i‡(
max_blocks
 == 0)

907 
	`NOVA_START_TIMING
(
dax_gë_block_t
, 
gë_block_time
);

909 
	`nova_dbgv
("%s:Ögoff %llu,Çum %lu, create %d\n",

910 
__func__
, 
iblock
, 
max_blocks
, 
¸óã
);

912 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

914 i‡(
èkög_lock
)

915 
check_√xt
 = 0;

917 
agaö
:

918 
num_blocks
 = 
	`nova_check_exi°ög_íåy
(
sb
, 
öode
, 
max_blocks
,

919 
iblock
, &
íåy
, &
íåy_c›y
, 
check_√xt
,

920 
ïoch_id
, &
ö∂a˚
, 
locked
);

922 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

924 i‡(
íåy
) {

925 i‡(
¸óã
 =0 || 
ö∂a˚
) {

926 
nvmm
 = 
	`gë_nvmm
(
sb
, 
sih
, 
íåyc
, 
iblock
);

927 
	`nova_dbgv
("%s: foundÖgoff %llu, block %lu\n",

928 
__func__
, 
iblock
, 
nvmm
);

929 
out
;

933 i‡(
¸óã
 == 0) {

934 
num_blocks
 = 0;

935 
out1
;

938 i‡(
èkög_lock
 && 
locked
 == 0) {

939 
	`öode_lock
(
öode
);

940 
locked
 = 1;

942 
check_√xt
 = 1;

943 
agaö
;

946 
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

948 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

950 
time
 = 
	`cuºít_time
(
öode
).
tv_£c
;

951 
upd©e
.
èû
 = 
sih
->
log_èû
;

952 
upd©e
.
Æãr_èû
 = 
sih
->
Æãr_log_èû
;

955 
Æloˇãd
 = 
	`nova_√w_d©a_blocks
(
sb
, 
sih
, &
blockƒ
, 
iblock
,

956 
num_blocks
, 
ALLOC_INIT_ZERO
, 
ANY_CPU
,

957 
ALLOC_FROM_HEAD
);

958 i‡(
Æloˇãd
 <= 0) {

959 
	`nova_dbgv
("%†Ælo¯block†Áûed %d\n", 
__func__
,

960 
Æloˇãd
);

961 
ªt
 = 
Æloˇãd
;

962 
out
;

965 
num_blocks
 = 
Æloˇãd
;

967 
	`nova_öô_fûe_wrôe_íåy
(
sb
, 
sih
, &
íåy_d©a
,

968 
ïoch_id
, 
iblock
, 
num_blocks
,

969 
blockƒ
, 
time
, 
öode
->
i_size
);

971 
ªt
 = 
	`nova_≠≥nd_fûe_wrôe_íåy
(
sb
, 
pi
, 
öode
,

972 &
íåy_d©a
, &
upd©e
);

973 i‡(
ªt
) {

974 
	`nova_dbgv
("%s:áµíd inodêíåy faûed\n", 
__func__
);

975 
ªt
 = -
ENOSPC
;

976 
out
;

979 
nvmm
 = 
blockƒ
;

980 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
sih
->
i_blk_ty≥
];

981 
sih
->
i_blocks
 +(
num_blocks
 << (
d©a_bôs
 - 
sb
->
s_blocksize_bôs
));

983 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

984 
	`nova_upd©e_öode
(
sb
, 
öode
, 
pi
, &
upd©e
, 1);

985 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

987 
ªt
 = 
	`nova_ªassign_fûe_åì
(
sb
, 
sih
, 
upd©e
.
cuº_íåy
);

988 i‡(
ªt
) {

989 
	`nova_dbgv
("%s:Çova_reassign_file_tree failed: %d\n",

990 
__func__
, 
ªt
);

991 
out
;

993 
öode
->
i_blocks
 = 
sih
->i_blocks;

994 
sih
->
å™s_id
++;

995 
	`NOVA_STATS_ADD
(
dax_√w_blocks
, 1);

998 
out
:

999 i‡(
ªt
 < 0) {

1000 
	`nova_˛ónup_öcom∂ëe_wrôe
(
sb
, 
sih
, 
blockƒ
, 
Æloˇãd
,

1001 0, 
upd©e
.
èû
);

1002 
num_blocks
 = 
ªt
;

1003 
out1
;

1006 *
bno
 = 
nvmm
;

1010 
out1
:

1011 i‡(
èkög_lock
 && 
locked
)

1012 
	`öode_u∆ock
(
öode
);

1014 
	`NOVA_END_TIMING
(
dax_gë_block_t
, 
gë_block_time
);

1015  
num_blocks
;

1016 
	}
}

1018 
	$nova_iom≠_begö
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

1019 
Êags
, 
iom≠
 *iom≠, 
boﬁ
 
èkög_lock
)

1021 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
öode
->
i_sb
);

1022 
blkbôs
 = 
öode
->
i_blkbôs
;

1023 
fú°_block
 = 
off£t
 >> 
blkbôs
;

1024 
max_blocks
 = (
Àngth
 + (1 << 
blkbôs
) - 1) >> blkbits;

1025 
boﬁ
 
√w
 = 
Ál£
, 
bound¨y
 = false;

1026 
u32
 
bno
;

1027 
ªt
;

1029 
ªt
 = 
	`nova_dax_gë_blocks
(
öode
, 
fú°_block
, 
max_blocks
, &
bno
, &
√w
,

1030 &
bound¨y
, 
Êags
 & 
IOMAP_WRITE
, 
èkög_lock
);

1031 i‡(
ªt
 < 0) {

1032 
	`nova_dbgv
("%s:Çova_dax_gë_block†Áûed %d", 
__func__
, 
ªt
);

1033  
ªt
;

1036 
iom≠
->
Êags
 = 0;

1037 
iom≠
->
bdev
 = 
öode
->
i_sb
->
s_bdev
;

1038 
iom≠
->
dax_dev
 = 
sbi
->
s_dax_dev
;

1039 
iom≠
->
off£t
 = (
u64
)
fú°_block
 << 
blkbôs
;

1041 i‡(
ªt
 == 0) {

1042 
iom≠
->
ty≥
 = 
IOMAP_HOLE
;

1043 
iom≠
->
addr
 = 
IOMAP_NULL_ADDR
;

1044 
iom≠
->
Àngth
 = 1 << 
blkbôs
;

1046 
iom≠
->
ty≥
 = 
IOMAP_MAPPED
;

1047 
iom≠
->
addr
 = (
u64
)
bno
 << 
blkbôs
;

1048 
iom≠
->
Àngth
 = (
u64
)
ªt
 << 
blkbôs
;

1049 
iom≠
->
Êags
 |
IOMAP_F_MERGED
;

1052 i‡(
√w
)

1053 
iom≠
->
Êags
 |
IOMAP_F_NEW
;

1055 
	}
}

1057 
	$nova_iom≠_íd
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

1058 
ssize_t
 
wrôãn
, 
Êags
, 
iom≠
 *iomap)

1060 i‡(
iom≠
->
ty≥
 =
IOMAP_MAPPED
 &&

1061 
wrôãn
 < 
Àngth
 &&

1062 (
Êags
 & 
IOMAP_WRITE
))

1063 
	`åunˇã_∑geˇche
(
öode
, inode->
i_size
);

1065 
	}
}

1068 
	$nova_iom≠_begö_lock
(
öode
 *öode, 
loff_t
 
off£t
,

1069 
loff_t
 
Àngth
, 
Êags
, 
iom≠
 *iom≠, iom≠ *
§cm≠
)

1071  
	`nova_iom≠_begö
(
öode
, 
off£t
, 
Àngth
, 
Êags
, 
iom≠
, 
åue
);

1072 
	}
}

1074 
iom≠_›s
 
	gnova_iom≠_›s_lock
 = {

1075 .
iom≠_begö
 = 
nova_iom≠_begö_lock
,

1076 .
	giom≠_íd
 = 
nova_iom≠_íd
,

1082 
vm_Áu…_t
 
	$nova_dax_huge_Áu…
(
vm_Áu…
 *
vmf
,

1083 
‹dî
)

1085 
vm_Áu…_t
 
ªt
;

1086 
îr‹
 = 0;

1087 
p‚_t
 
p‚
;

1088 
	`INIT_TIMING
(
Áu…_time
);

1089 
addªss_•a˚
 *
m≠pög
 = 
vmf
->
vma
->
vm_fûe
->
f_m≠pög
;

1090 
öode
 *öodê
m≠pög
->
ho°
;

1092 
	`NOVA_START_TIMING
(
pmd_Áu…_t
, 
Áu…_time
);

1094 
	`nova_dbgv
("%s: inode %lu,Ögoff %lu\n",

1095 
__func__
, 
öode
->
i_öo
, 
vmf
->
pgoff
);

1097 i‡(
vmf
->
Êags
 & 
FAULT_FLAG_WRITE
)

1098 
	`fûe_upd©e_time
(
vmf
->
vma
->
vm_fûe
);

1101 
ªt
 = 
	`dax_iom≠_Áu…
(
vmf
, 
‹dî
, &
p‚
, &
îr‹
, &
nova_iom≠_›s_lock
);

1103 
	`NOVA_END_TIMING
(
pmd_Áu…_t
, 
Áu…_time
);

1104  
ªt
;

1105 
	}
}

1107 
vm_Áu…_t
 
	$nova_dax_Áu…
(
vm_Áu…
 *
vmf
)

1109 
addªss_•a˚
 *
m≠pög
 = 
vmf
->
vma
->
vm_fûe
->
f_m≠pög
;

1110 
öode
 *öodê
m≠pög
->
ho°
;

1112 
	`nova_dbgv
("%s: inode %lu,Ögoff %lu, flags 0x%x\n",

1113 
__func__
, 
öode
->
i_öo
, 
vmf
->
pgoff
, vmf->
Êags
);

1116  
	`nova_dax_huge_Áu…
(
vmf
, 0);

1117 
	}
}

1119 
vm_Áu…_t
 
	$nova_dax_p‚_mkwrôe
(
vm_Áu…
 *
vmf
)

1121 
addªss_•a˚
 *
m≠pög
 = 
vmf
->
vma
->
vm_fûe
->
f_m≠pög
;

1122 
öode
 *öodê
m≠pög
->
ho°
;

1124 
	`nova_dbgv
("%s: inode %lu,Ögoff %lu, flags 0x%x\n",

1125 
__func__
, 
öode
->
i_öo
, 
vmf
->
pgoff
, vmf->
Êags
);

1128  
	`nova_dax_huge_Áu…
(
vmf
, 0);

1129 
	}
}

1131 
ölöe
 
	$nova_rbåì_com∑ª_vma
(
vma_ôem
 *
cuº
,

1132 
vm_¨ó_°ru˘
 *
vma
)

1134 i‡(
vma
 < 
cuº
->vma)

1136 i‡(
vma
 > 
cuº
->vma)

1140 
	}
}

1142 
	$nova_≠≥nd_wrôe_mm≠_to_log
(
su≥r_block
 *
sb
,

1143 
öode
 *öode, 
vma_ôem
 *
ôem
)

1145 
vm_¨ó_°ru˘
 *
vma
 = 
ôem
->vma;

1146 
nova_öode
 *
pi
;

1147 
nova_mm≠_íåy
 
d©a
;

1148 
nova_öode_upd©e
 
upd©e
;

1149 
num_∑ges
;

1150 
u64
 
ïoch_id
;

1151 
ªt
;

1152 
úq_Êags
 = 0;

1155 i‡(
d©a_csum
 =0 && 
d©a_∑rôy
 == 0)

1158 
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

1159 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

1160 
upd©e
.
èû
 = upd©e.
Æãr_èû
 = 0;

1162 
	`mem£t
(&
d©a
, 0, (
nova_mm≠_íåy
));

1163 
d©a
.
íåy_ty≥
 = 
MMAP_WRITE
;

1164 
d©a
.
ïoch_id
 =Époch_id;

1165 
d©a
.
pgoff
 = 
	`˝u_to_À64
(
vma
->
vm_pgoff
);

1166 
num_∑ges
 = (
vma
->
vm_íd
 - vma->
vm_°¨t
Ë>> 
PAGE_SHIFT
;

1167 
d©a
.
num_∑ges
 = 
	`˝u_to_À64
(num_pages);

1168 
d©a
.
övÆid
 = 0;

1170 
	`nova_dbgv
("%s : Appending mmapÜogÉntry for inode %lu,Ögoff %llu, %lluÖages\n",

1171 
__func__
, 
öode
->
i_öo
,

1172 
d©a
.
pgoff
, d©a.
num_∑ges
);

1174 
ªt
 = 
	`nova_≠≥nd_mm≠_íåy
(
sb
, 
pi
, 
öode
, &
d©a
, &
upd©e
, 
ôem
);

1175 i‡(
ªt
) {

1176 
	`nova_dbg
("%s:áµíd wrôêmm≠É¡ry faûuª\n", 
__func__
);

1177 
out
;

1180 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

1181 
	`nova_upd©e_öode
(
sb
, 
öode
, 
pi
, &
upd©e
, 1);

1182 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

1183 
out
:

1184  
ªt
;

1185 
	}
}

1187 
	$nova_ö£π_wrôe_vma
(
vm_¨ó_°ru˘
 *
vma
)

1189 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

1190 
öode
 *öodê
m≠pög
->
ho°
;

1191 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

1192 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

1193 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1194 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1195 
Êags
 = 
VM_SHARED
 | 
VM_WRITE
;

1196 
vma_ôem
 *
ôem
, *
cuº
;

1197 
rb_node
 **
ãmp
, *
∑ª¡
;

1198 
compVÆ
;

1199 
ö£π
 = 0;

1200 
ªt
;

1201 
	`INIT_TIMING
(
ö£π_vma_time
);

1204 i‡((
vma
->
vm_Êags
 & 
Êags
) != flags)

1207 
	`NOVA_START_TIMING
(
ö£π_vma_t
, 
ö£π_vma_time
);

1209 
ôem
 = 
	`nova_Æloc_vma_ôem
(
sb
);

1210 i‡(!
ôem
) {

1211 
	`NOVA_END_TIMING
(
ö£π_vma_t
, 
ö£π_vma_time
);

1212  -
ENOMEM
;

1215 
ôem
->
vma
 = vma;

1217 
	`nova_dbgv
("Inode %lu insert vma %p, start 0x%lx,Énd 0x%lx,Ögoff %lu\n",

1218 
öode
->
i_öo
, 
vma
, vma->
vm_°¨t
, vma->
vm_íd
,

1219 
vma
->
vm_pgoff
);

1221 
	`öode_lock
(
öode
);

1224 
ªt
 = 
	`nova_≠≥nd_wrôe_mm≠_to_log
(
sb
, 
öode
, 
ôem
);

1225 i‡(
ªt
)

1226 
out
;

1228 
ãmp
 = &(
sih
->
vma_åì
.
rb_node
);

1229 
∑ª¡
 = 
NULL
;

1231 *
ãmp
) {

1232 
cuº
 = 
	`c⁄èöî_of
(*
ãmp
, 
vma_ôem
, 
node
);

1233 
compVÆ
 = 
	`nova_rbåì_com∑ª_vma
(
cuº
, 
vma
);

1234 
∑ª¡
 = *
ãmp
;

1236 i‡(
compVÆ
 == -1) {

1237 
ãmp
 = &((*ãmp)->
rb_À·
);

1238 } i‡(
compVÆ
 == 1) {

1239 
ãmp
 = &((*ãmp)->
rb_right
);

1241 
	`nova_dbg
("%s: vma %pálreadyÉxists\n",

1242 
__func__
, 
vma
);

1243 
	`k‰ì
(
ôem
);

1244 
out
;

1248 
	`rb_lök_node
(&
ôem
->
node
, 
∑ª¡
, 
ãmp
);

1249 
	`rb_ö£π_cﬁ‹
(&
ôem
->
node
, &
sih
->
vma_åì
);

1251 
sih
->
num_vmas
++;

1252 i‡(
sih
->
num_vmas
 == 1)

1253 
ö£π
 = 1;

1255 
sih
->
å™s_id
++;

1256 
out
:

1257 
	`öode_u∆ock
(
öode
);

1259 i‡(
ö£π
) {

1260 
	`muãx_lock
(&
sbi
->
vma_muãx
);

1261 
	`li°_add_èû
(&
sih
->
li°
, &
sbi
->
mm≠_sih_li°
);

1262 
	`muãx_u∆ock
(&
sbi
->
vma_muãx
);

1265 
	`NOVA_END_TIMING
(
ö£π_vma_t
, 
ö£π_vma_time
);

1266  
ªt
;

1267 
	}
}

1269 
	$nova_ªmove_wrôe_vma
(
vm_¨ó_°ru˘
 *
vma
)

1271 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

1272 
öode
 *öodê
m≠pög
->
ho°
;

1273 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

1274 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

1275 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1276 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1277 
vma_ôem
 *
cuº
 = 
NULL
;

1278 
rb_node
 *
ãmp
;

1279 
compVÆ
;

1280 
found
 = 0;

1281 
ªmove
 = 0;

1282 
	`INIT_TIMING
(
ªmove_vma_time
);

1285 
	`NOVA_START_TIMING
(
ªmove_vma_t
, 
ªmove_vma_time
);

1286 
	`öode_lock
(
öode
);

1288 
ãmp
 = 
sih
->
vma_åì
.
rb_node
;

1289 
ãmp
) {

1290 
cuº
 = 
	`c⁄èöî_of
(
ãmp
, 
vma_ôem
, 
node
);

1291 
compVÆ
 = 
	`nova_rbåì_com∑ª_vma
(
cuº
, 
vma
);

1293 i‡(
compVÆ
 == -1) {

1294 
ãmp
 =Åemp->
rb_À·
;

1295 } i‡(
compVÆ
 == 1) {

1296 
ãmp
 =Åemp->
rb_right
;

1298 
	`nova_ª£t_vma_csum_∑rôy
(
sb
, 
cuº
);

1299 
	`rb_îa£
(&
cuº
->
node
, &
sih
->
vma_åì
);

1300 
found
 = 1;

1305 i‡(
found
) {

1306 
sih
->
num_vmas
--;

1307 i‡(
sih
->
num_vmas
 == 0)

1308 
ªmove
 = 1;

1311 
	`öode_u∆ock
(
öode
);

1313 i‡(
found
) {

1314 
	`nova_dbgv
("Inode %luÑemove vma %p, start 0x%lx,Énd 0x%lx,Ögoff %lu\n",

1315 
öode
->
i_öo
, 
cuº
->
vma
, cuº->vma->
vm_°¨t
,

1316 
cuº
->
vma
->
vm_íd
, cuº->vma->
vm_pgoff
);

1317 
	`nova_‰ì_vma_ôem
(
sb
, 
cuº
);

1320 i‡(
ªmove
) {

1321 
	`muãx_lock
(&
sbi
->
vma_muãx
);

1322 
	`li°_dñ
(&
sih
->
li°
);

1323 
	`muãx_u∆ock
(&
sbi
->
vma_muãx
);

1326 
	`NOVA_END_TIMING
(
ªmove_vma_t
, 
ªmove_vma_time
);

1328 
	}
}

1331 
	$nova_ª°‹e_∑ge_wrôe
(
vm_¨ó_°ru˘
 *
vma
,

1332 
addªss
)

1334 
mm_°ru˘
 *
mm
 = 
vma
->
vm_mm
;

1337 
	`down_wrôe
(&
mm
->
mm≠_£m
);

1339 
	`nova_dbgv
("Restore vma %p write, start 0x%lx,Énd 0x%lx,áddress 0x%lx\n",

1340 
vma
, vma->
vm_°¨t
, vma->
vm_íd
, 
addªss
);

1343 
	`nova_mm≠_to_√w_blocks
(
vma
, 
addªss
);

1345 
	`up_wrôe
(&
mm
->
mm≠_£m
);

1348 
	}
}

1351 
	$nova_vma_›í
(
vm_¨ó_°ru˘
 *
vma
)

1353 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

1354 
öode
 *öodê
m≠pög
->
ho°
;

1356 
	`nova_dbg_mm≠4k
("[%s:%d] inode %lu, MMAP 4KPAGE vm_start(0x%lx), vm_end(0x%lx), vmÖgoff %lu, %lu blocks, vm_flags(0x%lx), vm_page_prot(0x%lx)\n",

1357 
__func__
, 
__LINE__
,

1358 
öode
->
i_öo
, 
vma
->
vm_°¨t
, vma->
vm_íd
,

1359 
vma
->
vm_pgoff
,

1360 (
vma
->
vm_íd
 - vma->
vm_°¨t
Ë>> 
PAGE_SHIFT
,

1361 
vma
->
vm_Êags
,

1362 
	`pg¥Ÿ_vÆ
(
vma
->
vm_∑ge_¥Ÿ
));

1364 
	`nova_ö£π_wrôe_vma
(
vma
);

1365 
	}
}

1367 
	$nova_vma_˛o£
(
vm_¨ó_°ru˘
 *
vma
)

1369 
	`nova_dbgv
("[%s:%d] MMAP 4KPAGE vm_start(0x%lx), vm_end(0x%lx), vm_flags(0x%lx), vm_page_prot(0x%lx)\n",

1370 
__func__
, 
__LINE__
, 
vma
->
vm_°¨t
, vma->
vm_íd
,

1371 
vma
->
vm_Êags
, 
	`pg¥Ÿ_vÆ
(vma->
vm_∑ge_¥Ÿ
));

1374 
	`nova_ªmove_wrôe_vma
(
vma
);

1375 
	}
}

1377 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gnova_dax_vm_›s
 = {

1378 .
Áu…
 = 
nova_dax_Áu…
,

1379 .
	ghuge_Áu…
 = 
nova_dax_huge_Áu…
,

1380 .
	g∑ge_mkwrôe
 = 
nova_dax_Áu…
,

1381 .
	gp‚_mkwrôe
 = 
nova_dax_p‚_mkwrôe
,

1382 .
	g›í
 = 
nova_vma_›í
,

1383 .
	g˛o£
 = 
nova_vma_˛o£
,

	@dir.c

18 
	~<löux/fs.h
>

19 
	~<löux/∑gem≠.h
>

20 
	~"nova.h
"

21 
	~"öode.h
"

23 
	#DT2IF
(
dt
Ë(((dtË<< 12Ë& 
S_IFMT
)

	)

24 
	#IF2DT
(
sif
Ë(((sifË& 
S_IFMT
Ë>> 12)

	)

26 
nova_díåy
 *
	$nova_föd_díåy
(
su≥r_block
 *
sb
,

27 
nova_öode
 *
pi
, 
öode
 *öode, c⁄° *
«me
,

28 
«me_Àn
)

30 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

31 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

32 
nova_díåy
 *
dúíåy
 = 
NULL
;

33 
nova_ønge_node
 *
ªt_node
 = 
NULL
;

34 
hash
;

35 
found
 = 0;

37 
hash
 = 
	`BKDRHash
(
«me
, 
«me_Àn
);

39 
found
 = 
	`nova_föd_ønge_node
(&
sih
->
rb_åì
, 
hash
,

40 
NODE_DIR
, &
ªt_node
);

41 i‡(
found
 =1 && 
hash
 =
ªt_node
->hash)

42 
dúíåy
 = 
ªt_node
->direntry;

44  
dúíåy
;

45 
	}
}

47 
	$nova_ö£π_dú_åì
(
su≥r_block
 *
sb
,

48 
nova_öode_öfo_hódî
 *
sih
, c⁄° *
«me
,

49 
«mñí
, 
nova_díåy
 *
dúíåy
)

51 
nova_ønge_node
 *
node
 = 
NULL
;

52 
hash
;

53 
ªt
;

55 
hash
 = 
	`BKDRHash
(
«me
, 
«mñí
);

56 
	`nova_dbgv
("%s: in£π %†hash %lu\n", 
__func__
, 
«me
, 
hash
);

59 
node
 = 
	`nova_Æloc_dú_node
(
sb
);

60 i‡(!
node
)

61  -
ENOMEM
;

63 
node
->
hash
 = hash;

64 
node
->
dúíåy
 = direntry;

65 
ªt
 = 
	`nova_ö£π_ønge_node
(&
sih
->
rb_åì
, 
node
, 
NODE_DIR
);

66 i‡(
ªt
) {

67 
	`nova_‰ì_dú_node
(
node
);

68 
	`nova_dbg
("%†ERROR %d: %s\n", 
__func__
, 
ªt
, 
«me
);

71  
ªt
;

72 
	}
}

74 
	$nova_check_díåy_m©ch
(
su≥r_block
 *
sb
,

75 
nova_díåy
 *
díåy
, c⁄° *
«me
, 
«mñí
)

77 i‡(
díåy
->
«me_Àn
 !
«mñí
)

78  -
EINVAL
;

80  
	`°∫cmp
(
díåy
->
«me
,Çame, 
«mñí
);

81 
	}
}

83 
	$nova_ªmove_dú_åì
(
su≥r_block
 *
sb
,

84 
nova_öode_öfo_hódî
 *
sih
, c⁄° *
«me
, 
«mñí
,

85 
ª∂ay
, 
nova_díåy
 **
¸óã_díåy
)

87 
nova_díåy
 *
íåy
;

88 
nova_díåy
 *
íåyc
, 
íåy_c›y
;

89 
nova_ønge_node
 *
ªt_node
 = 
NULL
;

90 
hash
;

91 
found
 = 0;

93 
hash
 = 
	`BKDRHash
(
«me
, 
«mñí
);

94 
found
 = 
	`nova_föd_ønge_node
(&
sih
->
rb_åì
, 
hash
,

95 
NODE_DIR
, &
ªt_node
);

96 i‡(
found
 == 0) {

97 
	`nova_dbg
("%sÅargetÇot found: %s,Üength %d, "

98 "hash %lu\n", 
__func__
, 
«me
, 
«mñí
, 
hash
);

99  -
EINVAL
;

102 
íåy
 = 
ªt_node
->
dúíåy
;

103 
	`rb_îa£
(&
ªt_node
->
node
, &
sih
->
rb_åì
);

104 
	`nova_‰ì_dú_node
(
ªt_node
);

106 i‡(
ª∂ay
 == 0) {

107 i‡(!
íåy
) {

108 
	`nova_dbg
("%s ERROR: %s,Üength %d, hash %lu\n",

109 
__func__
, 
«me
, 
«mñí
, 
hash
);

110  -
EINVAL
;

113 i‡(
mëad©a_csum
 == 0)

114 
íåyc
 = 
íåy
;

116 
íåyc
 = &
íåy_c›y
;

117 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

118  -
EINVAL
;

121 i‡(
íåyc
->
öo
 =0 ||É¡ryc->
övÆid
 ||

122 
	`nova_check_díåy_m©ch
(
sb
, 
íåyc
, 
«me
, 
«mñí
)) {

123 
	`nova_dbg
("%s dentryÇot match: %s,Üength %d, hash %lu\n",

124 
__func__
, 
«me
, 
«mñí
, 
hash
);

126 
	`nova_dbg
("dentry:Åype %d, inode %llu,Çame %s,Çamelen %u,ÑecÜen %u\n",

127 
íåy
->
íåy_ty≥
, 
	`À64_to_˝u
”¡ry->
öo
),

128 
íåy
->
«me
,É¡ry->
«me_Àn
,

129 
	`À16_to_˝u
(
íåy
->
de_Àn
));

130  -
EINVAL
;

133 i‡(
¸óã_díåy
)

134 *
¸óã_díåy
 = 
íåy
;

138 
	}
}

140 
	$nova_dñëe_dú_åì
(
su≥r_block
 *
sb
,

141 
nova_öode_öfo_hódî
 *
sih
)

143 
	`INIT_TIMING
(
dñëe_time
);

145 
	`NOVA_START_TIMING
(
dñëe_dú_åì_t
, 
dñëe_time
);

147 
	`nova_dbgv
("%s: dñëêdú %lu\n", 
__func__
, 
sih
->
öo
);

148 
	`nova_de°roy_ønge_node_åì
(
sb
, &
sih
->
rb_åì
);

149 
	`NOVA_END_TIMING
(
dñëe_dú_åì_t
, 
dñëe_time
);

150 
	}
}

154 
	$nova_öô_díåy
(
su≥r_block
 *
sb
,

155 
nova_díåy
 *
de_íåy
, 
u64
 
£lf_öo
, u64 
∑ª¡_öo
,

156 
u64
 
ïoch_id
)

158 *
°¨t
 = 
de_íåy
;

159 
nova_öode_log_∑ge
 *
cuº_∑ge
 = 
°¨t
;

160 
Àngth
;

161 
de_Àn
;

162 
time•ec64
 
now
;

165 
de_Àn
 = 
	`NOVA_DIR_LOG_REC_LEN
(1);

166 
	`mem£t
(
de_íåy
, 0, 
de_Àn
);

167 
de_íåy
->
íåy_ty≥
 = 
DIR_LOG
;

168 
de_íåy
->
ïoch_id
 =Époch_id;

169 
de_íåy
->
å™s_id
 = 0;

170 
de_íåy
->
öo
 = 
	`˝u_to_À64
(
£lf_öo
);

171 
de_íåy
->
«me_Àn
 = 1;

172 
de_íåy
->
de_Àn
 = 
	`˝u_to_À16
(de_len);

176 
	`ktime_gë_cﬂr£_ªÆ_ts64
(&
now
);

177 
de_íåy
->
mtime
 = 
now
.
tv_£c
;

179 
de_íåy
->
löks_cou¡
 = 1;

180 
	`°∫˝y
(
de_íåy
->
«me
, ".\0", 2);

181 
	`nova_upd©e_íåy_csum
(
de_íåy
);

183 
Àngth
 = 
de_Àn
;

185 
de_íåy
 = (
nova_díåy
 *)((*)de_íåy + 
Àngth
);

186 
de_Àn
 = 
	`NOVA_DIR_LOG_REC_LEN
(2);

187 
	`mem£t
(
de_íåy
, 0, 
de_Àn
);

188 
de_íåy
->
íåy_ty≥
 = 
DIR_LOG
;

189 
de_íåy
->
ïoch_id
 =Époch_id;

190 
de_íåy
->
å™s_id
 = 0;

191 
de_íåy
->
öo
 = 
	`˝u_to_À64
(
∑ª¡_öo
);

192 
de_íåy
->
«me_Àn
 = 2;

193 
de_íåy
->
de_Àn
 = 
	`˝u_to_À16
(de_len);

197 
	`ktime_gë_cﬂr£_ªÆ_ts64
(&
now
);

198 
de_íåy
->
mtime
 = 
now
.
tv_£c
;

200 
de_íåy
->
löks_cou¡
 = 2;

201 
	`°∫˝y
(
de_íåy
->
«me
, "..\0", 3);

202 
	`nova_upd©e_íåy_csum
(
de_íåy
);

203 
Àngth
 +
de_Àn
;

205 
	`nova_£t_∑ge_num_íåõs
(
sb
, 
cuº_∑ge
, 2, 1);

207 
	`nova_Êush_buf„r
(
°¨t
, 
Àngth
, 0);

208  
Àngth
;

209 
	}
}

215 
	$nova_≠≥nd_dú_öô_íåõs
(
su≥r_block
 *
sb
,

216 
nova_öode
 *
pi
, 
u64
 
£lf_öo
, u64 
∑ª¡_öo
, u64 
ïoch_id
)

218 
nova_öode_öfo_hódî
 
sih
;

219 
nova_öode
 *
Æãr_pi
;

220 
u64
 
Æãr_pi_addr
 = 0;

221 
Æloˇãd
;

222 
ªt
;

223 
u64
 
√w_block
;

224 
Àngth
;

225 
nova_díåy
 *
de_íåy
;

226 
úq_Êags
 = 0;

228 
sih
.
öo
 = 
£lf_öo
;

229 
sih
.
i_blk_ty≥
 = 
NOVA_DEFAULT_BLOCK_TYPE
;

231 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, &
sih
, 1, &
√w_block
,

232 
ANY_CPU
, 0);

233 i‡(
Æloˇãd
 != 1) {

234 
	`nova_îr
(
sb
, "ERROR:Ço inodeÜogÖageávailable\n");

235  -
ENOMEM
;

238 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

240 
pi
->
log_èû
 =Öi->
log_hód
 = 
√w_block
;

242 
de_íåy
 = (
nova_díåy
 *)
	`nova_gë_block
(
sb
, 
√w_block
);

244 
Àngth
 = 
	`nova_öô_díåy
(
sb
, 
de_íåy
, 
£lf_öo
, 
∑ª¡_öo
, 
ïoch_id
);

246 
	`nova_upd©e_èû
(
pi
, 
√w_block
 + 
Àngth
);

248 
	`nova_Êush_buf„r
(&(
pi
->
log_hód
), 
CACHELINE_SIZE
, 0);

249 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

251 i‡(
mëad©a_csum
 == 0)

254 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, &
sih
, 1, &
√w_block
,

255 
ANY_CPU
, 1);

256 i‡(
Æloˇãd
 != 1) {

257 
	`nova_îr
(
sb
, "ERROR:Ço inodeÜogÖageávailable\n");

258  -
ENOMEM
;

260 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

261 
pi
->
Æãr_log_èû
 =Öi->
Æãr_log_hód
 = 
√w_block
;

263 
de_íåy
 = (
nova_díåy
 *)
	`nova_gë_block
(
sb
, 
√w_block
);

265 
Àngth
 = 
	`nova_öô_díåy
(
sb
, 
de_íåy
, 
£lf_öo
, 
∑ª¡_öo
, 
ïoch_id
);

267 
	`nova_upd©e_Æãr_èû
(
pi
, 
√w_block
 + 
Àngth
);

268 
	`nova_upd©e_Æãr_∑ges
(
sb
, 
pi
,Öi->
log_hód
,

269 
pi
->
Æãr_log_hód
);

270 
	`nova_upd©e_öode_checksum
(
pi
);

271 
	`nova_Êush_buf„r
(
pi
, (
nova_öode
), 0);

272 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

275 
ªt
 = 
	`nova_gë_Æãr_öode_addªss
(
sb
, 
£lf_öo
, &
Æãr_pi_addr
);

276 i‡(
ªt
)

277  
ªt
;

279 
Æãr_pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
, 
Æãr_pi_addr
);

280 i‡(!
Æãr_pi
)

281  -
EINVAL
;

283 
	`nova_memu∆ock_öode
(
sb
, 
Æãr_pi
, &
úq_Êags
);

284 
	`mem˝y_to_pmem_noˇche
(
Æãr_pi
, 
pi
, (
nova_öode
));

285 
	`nova_memlock_öode
(
sb
, 
Æãr_pi
, &
úq_Êags
);

288 
	}
}

293 
	$nova_add_díåy
(
díåy
 *díåy, 
u64
 
öo
, 
öc_lök
,

294 
nova_öode_upd©e
 *
upd©e
, 
u64
 
ïoch_id
)

296 
öode
 *
dú
 = 
díåy
->
d_∑ª¡
->
d_öode
;

297 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

298 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
dú
);

299 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

300 
nova_öode
 *
pidú
;

301 c⁄° *
«me
 = 
díåy
->
d_«me
.name;

302 
«mñí
 = 
díåy
->
d_«me
.
Àn
;

303 
nova_díåy
 *
dúíåy
;

304 
logÀn
;

305 
ªt
;

306 
u64
 
cuº_íåy
;

307 
	`INIT_TIMING
(
add_díåy_time
);

309 
	`nova_dbg_vîbo£
("%s: dir %luÇew inode %llu\n",

310 
__func__
, 
dú
->
i_öo
, 
öo
);

311 
	`nova_dbg_vîbo£
("%s: %†%d\n", 
__func__
, 
«me
, 
«mñí
);

312 
	`NOVA_START_TIMING
(
add_díåy_t
, 
add_díåy_time
);

313 i‡(
«mñí
 == 0)

314  -
EINVAL
;

316 
pidú
 = 
	`nova_gë_öode
(
sb
, 
dú
);

324 
dú
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(dir);

326 
logÀn
 = 
	`NOVA_DIR_LOG_REC_LEN
(
«mñí
);

327 
ªt
 = 
	`nova_≠≥nd_díåy
(
sb
, 
pidú
, 
dú
, 
díåy
,

328 
öo
, 
logÀn
, 
upd©e
,

329 
öc_lök
, 
ïoch_id
);

331 i‡(
ªt
) {

332 
	`nova_dbg
("%s:áµíd dúÉ¡ry faûuª\n", 
__func__
);

333  
ªt
;

336 
cuº_íåy
 = 
upd©e
->curr_entry;

337 
dúíåy
 = (
nova_díåy
 *)
	`nova_gë_block
(
sb
, 
cuº_íåy
);

338 
sih
->
œ°_díåy
 = 
cuº_íåy
;

339 
ªt
 = 
	`nova_ö£π_dú_åì
(
sb
, 
sih
, 
«me
, 
«mñí
, 
dúíåy
);

341 
sih
->
å™s_id
++;

342 
	`NOVA_END_TIMING
(
add_díåy_t
, 
add_díåy_time
);

343  
ªt
;

344 
	}
}

346 
	$nova_ˇn_ö∂a˚_upd©e_díåy
(
su≥r_block
 *
sb
,

347 
nova_díåy
 *
díåy
, 
u64
 
ïoch_id
)

349 
nova_díåy
 *
díåyc
, 
íåy_c›y
;

351 i‡(
mëad©a_csum
 == 0)

352 
díåyc
 = 
díåy
;

354 
díåyc
 = &
íåy_c›y
;

355 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
díåy
, 
díåyc
))

359 i‡(
díåy
 && 
díåyc
->
ïoch_id
 ==Époch_id)

363 
	}
}

365 
	$nova_ö∂a˚_upd©e_díåy
(
su≥r_block
 *
sb
,

366 
öode
 *
dú
, 
nova_díåy
 *
díåy
, 
lök_ch™ge
,

367 
u64
 
ïoch_id
)

369 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
dú
);

370 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

371 
nova_log_íåy_öfo
 
íåy_öfo
;

373 
íåy_öfo
.
ty≥
 = 
DIR_LOG
;

374 
íåy_öfo
.
lök_ch™ge
 =Üink_change;

375 
íåy_öfo
.
ïoch_id
 =Époch_id;

376 
íåy_öfo
.
å™s_id
 = 
sih
->trans_id;

377 
íåy_öfo
.
ö∂a˚
 = 1;

379  
	`nova_ö∂a˚_upd©e_log_íåy
(
sb
, 
dú
, 
díåy
,

380 &
íåy_öfo
);

381 
	}
}

386 
	$nova_ªmove_díåy
(
díåy
 *díåy, 
dec_lök
,

387 
nova_öode_upd©e
 *
upd©e
, 
u64
 
ïoch_id
)

389 
öode
 *
dú
 = 
díåy
->
d_∑ª¡
->
d_öode
;

390 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

391 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

392 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
dú
);

393 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

394 
nova_öode
 *
pidú
;

395 
q°r
 *
íåy
 = &
díåy
->
d_«me
;

396 
nova_díåy
 *
ﬁd_díåy
 = 
NULL
;

397 
logÀn
;

398 
ªt
;

399 
u64
 
cuº_íåy
;

400 
	`INIT_TIMING
(
ªmove_díåy_time
);

402 
	`NOVA_START_TIMING
(
ªmove_díåy_t
, 
ªmove_díåy_time
);

404 
upd©e
->
¸óã_díåy
 = 
NULL
;

405 
upd©e
->
dñëe_díåy
 = 
NULL
;

407 i‡(!
díåy
->
d_«me
.
Àn
) {

408 
ªt
 = -
EINVAL
;

409 
out
;

412 
ªt
 = 
	`nova_ªmove_dú_åì
(
sb
, 
sih
, 
íåy
->
«me
,É¡ry->
Àn
, 0,

413 &
ﬁd_díåy
);

415 i‡(
ªt
)

416 
out
;

418 
pidú
 = 
	`nova_gë_öode
(
sb
, 
dú
);

421 
dú
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(dir);

423 i‡(
	`nova_ˇn_ö∂a˚_upd©e_díåy
(
sb
, 
ﬁd_díåy
, 
ïoch_id
)) {

424 
	`nova_ö∂a˚_upd©e_díåy
(
sb
, 
dú
, 
ﬁd_díåy
,

425 
dec_lök
, 
ïoch_id
);

426 
cuº_íåy
 = 
	`nova_gë_addr_off
(
sbi
, 
ﬁd_díåy
);

428 
sih
->
œ°_díåy
 = 
cuº_íåy
;

432 i‡(
upd©e
->
èû
 == 0) {

433 
upd©e
->
èû
 = 
sih
->
log_èû
;

434 
upd©e
->
Æãr_èû
 = 
sih
->
Æãr_log_èû
;

436 
sih
->
å™s_id
++;

437 
out
;

440 
logÀn
 = 
	`NOVA_DIR_LOG_REC_LEN
(
íåy
->
Àn
);

441 
ªt
 = 
	`nova_≠≥nd_díåy
(
sb
, 
pidú
, 
dú
, 
díåy
,

442 0, 
logÀn
, 
upd©e
,

443 
dec_lök
, 
ïoch_id
);

445 i‡(
ªt
) {

446 
	`nova_dbg
("%s:áµíd dúÉ¡ry faûuª\n", 
__func__
);

447 
out
;

450 
upd©e
->
¸óã_díåy
 = 
ﬁd_díåy
;

451 
cuº_íåy
 = 
upd©e
->curr_entry;

452 
upd©e
->
dñëe_díåy
 = (
nova_díåy
 *)
	`nova_gë_block
(
sb
,

453 
cuº_íåy
);

454 
sih
->
œ°_díåy
 = 
cuº_íåy
;

455 
sih
->
å™s_id
++;

456 
out
:

457 
	`NOVA_END_TIMING
(
ªmove_díåy_t
, 
ªmove_díåy_time
);

458  
ªt
;

459 
	}
}

462 
	$nova_övÆid©e_díåõs
(
su≥r_block
 *
sb
,

463 
nova_öode_upd©e
 *
upd©e
)

465 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

466 
nova_díåy
 *
¸óã_díåy
;

467 
nova_díåy
 *
¸óã_díåyc
, 
íåy_c›y
;

468 
nova_díåy
 *
dñëe_díåy
;

469 
u64
 
¸óã_cuº
, 
dñëe_cuº
;

470 
ªt
;

472 
¸óã_díåy
 = 
upd©e
->create_dentry;

473 
dñëe_díåy
 = 
upd©e
->delete_dentry;

475 i‡(!
¸óã_díåy
)

478 
	`nova_ªassign_logíåy
(
sb
, 
¸óã_díåy
, 
DIR_LOG
);

480 i‡(
mëad©a_csum
 == 0)

481 
¸óã_díåyc
 = 
¸óã_díåy
;

483 
¸óã_díåyc
 = &
íåy_c›y
;

484 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
¸óã_díåy
, 
¸óã_díåyc
))

488 i‡(!
	`ﬁd_íåy_‰ìabÀ
(
sb
, 
¸óã_díåyc
->
ïoch_id
))

491 
¸óã_cuº
 = 
	`nova_gë_addr_off
(
sbi
, 
¸óã_díåy
);

492 
dñëe_cuº
 = 
	`nova_gë_addr_off
(
sbi
, 
dñëe_díåy
);

494 
	`nova_övÆid©e_logíåy
(
sb
, 
¸óã_díåy
, 
DIR_LOG
, 0);

496 
ªt
 = 
	`nova_övÆid©e_logíåy
(
sb
, 
dñëe_díåy
, 
DIR_LOG
, 0);

498  
ªt
;

499 
	}
}

501 
	$nova_ªaddú_¶ow_rbåì
(
fûe
 *file,

502 
dú_c⁄ãxt
 *
˘x
)

504 
öode
 *öodê
	`fûe_öode
(
fûe
);

505 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

506 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

507 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

508 
nova_ønge_node
 *
cuº
;

509 
nova_öode
 *
chûd_pi
;

510 
nova_díåy
 *
íåy
;

511 
nova_díåy
 *
íåyc
, 
íåy_c›y
;

512 
pos
 = 
˘x
->pos;

513 
rb_node
 *
ãmp
 = 
NULL
;

514 
found
 = 0;

515 
u64
 
pi_addr
;

516 
öo_t
 
öo
;

517 
ªt
;

519 i‡(
pos
 == 0)

520 
ãmp
 = 
	`rb_fú°
(&
sih
->
rb_åì
);

521 i‡(
pos
 =
READDIR_END
)

524 
found
 = 
	`nova_föd_ønge_node
(&
sih
->
rb_åì
, 
pos
,

525 
NODE_DIR
, &
cuº
);

526 i‡(
found
 =1 && 
pos
 =
cuº
->
hash
)

527 
ãmp
 = &
cuº
->
node
;

530 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

532 
ãmp
) {

533 
cuº
 = 
	`c⁄èöî_of
(
ãmp
, 
nova_ønge_node
, 
node
);

534 
íåy
 = 
cuº
->
dúíåy
;

536 i‡(
mëad©a_csum
 == 0)

537 
íåyc
 = 
íåy
;

538 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

539  -
EIO
;

541 
pos
 = 
	`BKDRHash
(
íåyc
->
«me
,É¡ryc->
«me_Àn
);

542 
˘x
->
pos
 =Öos;

543 
öo
 = 
	`__À64_to_˝u
(
íåyc
->ino);

544 i‡(
öo
 == 0)

547 
ªt
 = 
	`nova_gë_öode_addªss
(
sb
, 
öo
, 0, &
pi_addr
,

550 i‡(
ªt
) {

551 
	`nova_dbg
("%s: get child inode %luáddress failed %d\n",

552 
__func__
, 
öo
, 
ªt
);

553 
˘x
->
pos
 = 
READDIR_END
;

554  
ªt
;

557 
chûd_pi
 = 
	`nova_gë_block
(
sb
, 
pi_addr
);

558 
	`nova_dbgv
("ctx: ino %llu,Çame %s,Çame_len %u, de_len %u, csum 0x%x\n",

559 (
u64
)
öo
, 
íåy
->
«me
,É¡ry->
«me_Àn
,

560 
íåy
->
de_Àn
,É¡ry->
csum
);

561 i‡(!
	`dú_emô
(
˘x
, 
íåyc
->
«me
,É¡ryc->
«me_Àn
,

562 
öo
, 
	`IF2DT
(
	`À16_to_˝u
(
chûd_pi
->
i_mode
)))) {

563 
	`nova_dbgv
("Hîe:Öo†%Œu\n", 
˘x
->
pos
);

566 
ãmp
 = 
	`rb_√xt
(temp);

569 
˘x
->
pos
 = 
READDIR_END
;

571 
	}
}

573 
	$nova_ªaddú_¶ow
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

575 
ªt
;

576 
	`INIT_TIMING
(
ªaddú_time
);

578 
	`NOVA_START_TIMING
(
ªaddú_t
, 
ªaddú_time
);

580 
ªt
 = 
	`nova_ªaddú_¶ow_rbåì
(
fûe
, 
˘x
);

582 
	`NOVA_END_TIMING
(
ªaddú_t
, 
ªaddú_time
);

583  
ªt
;

584 
	}
}

586 
u64
 
	$nova_föd_√xt_díåy_addr
(
su≥r_block
 *
sb
,

587 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
pos
)

589 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

590 
nova_díåy
 *
íåy
 = 
NULL
;

591 
nova_ønge_node
 *
ªt_node
 = 
NULL
;

592 
found
 = 0;

593 
u64
 
addr
 = 0;

595 
found
 = 
	`nova_föd_ønge_node
(&
sih
->
rb_åì
, 
pos
,

596 
NODE_DIR
, &
ªt_node
);

597 i‡(
found
 =1 && 
pos
 =
ªt_node
->
hash
) {

598 
íåy
 = 
ªt_node
->
dúíåy
;

599 
addr
 = 
	`nova_gë_addr_off
(
sbi
, 
íåy
);

602  
addr
;

603 
	}
}

605 
	$nova_ªaddú_Á°
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

607 
öode
 *öodê
	`fûe_öode
(
fûe
);

608 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

609 
nova_öode
 *
pidú
;

610 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

611 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

612 
nova_öode
 *
chûd_pi
;

613 
nova_öode
 *
¥ev_chûd_pi
 = 
NULL
;

614 
nova_díåy
 *
íåy
 = 
NULL
;

615 
nova_díåy
 *
íåyc
, 
íåy_c›y
;

616 
nova_díåy
 *
¥ev_íåy
 = 
NULL
;

617 
nova_díåy
 *
¥ev_íåyc
, 
¥ev_íåy_c›y
;

618 
de_Àn
;

619 
u64
 
pi_addr
;

620 
pos
 = 0;

621 
öo_t
 
öo
;

622 *
addr
;

623 
u64
 
cuº_p
;

624 
u8
 
ty≥
;

625 
ªt
;

626 
	`INIT_TIMING
(
ªaddú_time
);

628 
	`NOVA_START_TIMING
(
ªaddú_t
, 
ªaddú_time
);

629 
pidú
 = 
	`nova_gë_öode
(
sb
, 
öode
);

630 
	`nova_dbgv
("%s: ino %llu, size %llu,Öos 0x%llx\n",

631 
__func__
, (
u64
)
öode
->
i_öo
,

632 
pidú
->
i_size
, 
˘x
->
pos
);

634 i‡(
sih
->
log_hód
 == 0) {

635 
	`nova_îr
(
sb
, "Dú %luÜog i†NULL!\n", 
öode
->
i_öo
);

636  -
ENOSPC
;

639 
pos
 = 
˘x
->pos;

641 i‡(
pos
 == 0)

642 
cuº_p
 = 
sih
->
log_hód
;

643 i‡(
pos
 =
READDIR_END
)

644 
out
;

646 
cuº_p
 = 
	`nova_föd_√xt_díåy_addr
(
sb
, 
sih
, 
pos
);

647 i‡(
cuº_p
 == 0)

648 
out
;

651 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

652 
¥ev_íåyc
 = (
mëad©a_csum
 =0Ë? 
¥ev_íåy
 : &
¥ev_íåy_c›y
;

654 
cuº_p
 !
sih
->
log_èû
) {

655 i‡(
	`gŸo_√xt_∑ge
(
sb
, 
cuº_p
))

656 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

659 i‡(
cuº_p
 == 0) {

660 
	`nova_îr
(
sb
, "Dú %luÜog i†NULL!\n", 
öode
->
i_öo
);

661 
	`BUG
();

662  -
EINVAL
;

665 
addr
 = (*)
	`nova_gë_block
(
sb
, 
cuº_p
);

666 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
addr
);

667 
ty≥
) {

668 
SET_ATTR
:

669 
cuº_p
 +(
nova_£èâr_logíåy
);

671 
LINK_CHANGE
:

672 
cuº_p
 +(
nova_lök_ch™ge_íåy
);

674 
DIR_LOG
:

677 
	`nova_dbg
("%s: unknownÅype %d, 0x%llx\n",

678 
__func__
, 
ty≥
, 
cuº_p
);

679 
	`BUG
();

680  -
EINVAL
;

683 
íåy
 = (
nova_díåy
 *)
	`nova_gë_block
(
sb
, 
cuº_p
);

684 
	`nova_dbgv
("curr_p: 0x%llx,Åype %d, ino %llu,Çame %s,Çamelen %u,ÑecÜen %u\n",

685 
cuº_p
, 
íåy
->
íåy_ty≥
, 
	`À64_to_˝u
”¡ry->
öo
),

686 
íåy
->
«me
,É¡ry->
«me_Àn
,

687 
	`À16_to_˝u
(
íåy
->
de_Àn
));

689 i‡(
mëad©a_csum
 == 0)

690 
íåyc
 = 
íåy
;

691 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

692  -
EIO
;

694 
de_Àn
 = 
	`À16_to_˝u
(
íåyc
->de_len);

695 i‡(
íåyc
->
öo
 > 0 &&É¡ryc->
övÆid
 == 0

696 && 
íåyc
->
ªassig√d
 == 0) {

697 
öo
 = 
	`__À64_to_˝u
(
íåyc
->ino);

698 
pos
 = 
	`BKDRHash
(
íåyc
->
«me
,É¡ryc->
«me_Àn
);

700 
ªt
 = 
	`nova_gë_öode_addªss
(
sb
, 
öo
, 0,

701 &
pi_addr
, 0, 0);

702 i‡(
ªt
) {

703 
	`nova_dbg
("%s: get child inode %luáddress failed %d\n",

704 
__func__
, 
öo
, 
ªt
);

705 
˘x
->
pos
 = 
READDIR_END
;

706  
ªt
;

709 
chûd_pi
 = 
	`nova_gë_block
(
sb
, 
pi_addr
);

710 
	`nova_dbgv
("ctx: ino %llu,Çame %s,Çame_len %u, de_len %u\n",

711 (
u64
)
öo
, 
íåy
->
«me
,É¡ry->
«me_Àn
,

712 
íåy
->
de_Àn
);

713 i‡(
¥ev_íåy
 && !
	`dú_emô
(
˘x
, 
¥ev_íåyc
->
«me
,

714 
¥ev_íåyc
->
«me_Àn
, 
öo
,

715 
	`IF2DT
(
	`À16_to_˝u
(
¥ev_chûd_pi
->
i_mode
)))) {

716 
	`nova_dbgv
("Hîe:Öo†%Œu\n", 
˘x
->
pos
);

719 
¥ev_íåy
 = 
íåy
;

721 i‡(
mëad©a_csum
 == 0)

722 
¥ev_íåyc
 = 
¥ev_íåy
;

724 
	`mem˝y
(
¥ev_íåyc
, 
íåyc
,

725 (
nova_díåy
));

727 
¥ev_chûd_pi
 = 
chûd_pi
;

729 
˘x
->
pos
 =Öos;

730 
cuº_p
 +
de_Àn
;

733 i‡(
¥ev_íåy
 && !
	`dú_emô
(
˘x
, 
¥ev_íåyc
->
«me
,

734 
¥ev_íåyc
->
«me_Àn
, 
öo
,

735 
	`IF2DT
(
	`À16_to_˝u
(
¥ev_chûd_pi
->
i_mode
))))

738 
˘x
->
pos
 = 
READDIR_END
;

739 
out
:

740 
	`NOVA_END_TIMING
(
ªaddú_t
, 
ªaddú_time
);

741 
	`nova_dbgv
("%†ªtu∫\n", 
__func__
);

743 
	}
}

745 
	$nova_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

747 
öode
 *öodê
	`fûe_öode
(
fûe
);

748 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

749 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

751 i‡(
sbi
->
mou¡_¢≠shŸ
 == 0)

752  
	`nova_ªaddú_Á°
(
fûe
, 
˘x
);

754  
	`nova_ªaddú_¶ow
(
fûe
, 
˘x
);

755 
	}
}

757 c⁄° 
fûe_›î©i⁄s
 
	gnova_dú_›î©i⁄s
 = {

758 .
Œ£ek
 = 
gíîic_fûe_Œ£ek
,

759 .
	gªad
 = 
gíîic_ªad_dú
,

761 .
	gôî©e_sh¨ed
 = 
nova_ªaddú
,

762 .
	gfsync
 = 
no›_fsync
,

763 .
	gu∆ocked_io˘l
 = 
nova_io˘l
,

764 #ifde‡
CONFIG_COMPAT


765 .
	gcom∑t_io˘l
 = 
nova_com∑t_io˘l
,

	@file.c

18 
	~<löux/¶ab.h
>

19 
	~<löux/uio.h
>

20 
	~<löux/uac˚ss.h
>

21 
	~<löux/ÁŒoc.h
>

22 
	~<asm/mm™.h
>

23 
	~"nova.h
"

24 
	~"öode.h
"

27 
ölöe
 
	$nova_ˇn_£t_blocksize_höt
(
öode
 *inode,

28 
nova_öode
 *
pi
, 
loff_t
 
√w_size
)

30 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

31 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

36 i‡(
sih
->
i_size
 > 0)

39 
	}
}

41 
	$nova_£t_blocksize_höt
(
su≥r_block
 *
sb
, 
öode
 *inode,

42 
nova_öode
 *
pi
, 
loff_t
 
√w_size
)

44 
block_ty≥
;

45 
úq_Êags
 = 0;

47 i‡(!
	`nova_ˇn_£t_blocksize_höt
(
öode
, 
pi
, 
√w_size
))

50 i‡(
√w_size
 >= 0x40000000) {

51 
block_ty≥
 = 
NOVA_BLOCK_TYPE_1G
;

52 
höt_£t
;

55 i‡(
√w_size
 >= 0x200000) {

56 
block_ty≥
 = 
NOVA_BLOCK_TYPE_2M
;

57 
höt_£t
;

61 
block_ty≥
 = 
NOVA_BLOCK_TYPE_4K
;

63 
höt_£t
:

64 
	`nova_dbg_vîbo£
(

66 
√w_size
, 
pi
->
i_size
);

67 
	`nova_dbg_vîbo£
("SëtögÅhêhöàtÿ0x%x\n", 
block_ty≥
);

68 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

69 
pi
->
i_blk_ty≥
 = 
block_ty≥
;

70 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

72 
	}
}

74 
loff_t
 
	$nova_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
‹igö
)

76 
öode
 *öodê
fûe
->
f_∑th
.
díåy
->
d_öode
;

77 
ªtvÆ
;

79 i‡(
‹igö
 !
SEEK_DATA
 && origö !
SEEK_HOLE
)

80  
	`gíîic_fûe_Œ£ek
(
fûe
, 
off£t
, 
‹igö
);

82 
	`öode_lock
(
öode
);

83 
‹igö
) {

84 
SEEK_DATA
:

85 
ªtvÆ
 = 
	`nova_föd_ªgi⁄
(
öode
, &
off£t
, 0);

86 i‡(
ªtvÆ
) {

87 
	`öode_u∆ock
(
öode
);

88  
ªtvÆ
;

91 
SEEK_HOLE
:

92 
ªtvÆ
 = 
	`nova_föd_ªgi⁄
(
öode
, &
off£t
, 1);

93 i‡(
ªtvÆ
) {

94 
	`öode_u∆ock
(
öode
);

95  
ªtvÆ
;

100 i‡((
off£t
 < 0 && !(
fûe
->
f_mode
 & 
FMODE_UNSIGNED_OFFSET
)) ||

101 
off£t
 > 
öode
->
i_sb
->
s_maxbyãs
) {

102 
	`öode_u∆ock
(
öode
);

103  -
ENXIO
;

106 i‡(
off£t
 !
fûe
->
f_pos
) {

107 
fûe
->
f_pos
 = 
off£t
;

108 
fûe
->
f_vîsi⁄
 = 0;

111 
	`öode_u∆ock
(
öode
);

112  
off£t
;

113 
	}
}

120 
	$nova_fsync
(
fûe
 *fûe, 
loff_t
 
°¨t
,Üoff_à
íd
, 
d©async
)

122 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

123 
öode
 *öodê
fûe
->
f_∑th
.
díåy
->
d_öode
;

124 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

125 
°¨t_pgoff
, 
íd_pgoff
;

126 
ªt
 = 0;

127 
	`INIT_TIMING
(
fsync_time
);

129 
	`NOVA_START_TIMING
(
fsync_t
, 
fsync_time
);

131 i‡(
d©async
)

132 
	`NOVA_STATS_ADD
(
fd©async
, 1);

135 i‡(!
	`m≠pög_m≠≥d
(
m≠pög
))

136 
≥rsi°
;

138 
°¨t_pgoff
 = 
°¨t
 >> 
PAGE_SHIFT
;

139 
íd_pgoff
 = (
íd
 + 1Ë>> 
PAGE_SHIFT
;

140 
	`nova_dbgv
("%s: msyncÖgoffÑange %luÅo %lu\n",

141 
__func__
, 
°¨t_pgoff
, 
íd_pgoff
);

148 
	`nova_ª£t_m≠pög_csum_∑rôy
(
sb
, 
öode
, 
m≠pög
,

149 
°¨t_pgoff
, 
íd_pgoff
);

151 
ªt
 = 
	`gíîic_fûe_fsync
(
fûe
, 
°¨t
, 
íd
, 
d©async
);

153 
≥rsi°
:

154 
	`PERSISTENT_BARRIER
();

155 
	`NOVA_END_TIMING
(
fsync_t
, 
fsync_time
);

157  
ªt
;

158 
	}
}

161 
	$nova_Êush
(
fûe
 *fûe, 
Ê_ow√r_t
 
id
)

163 
	`PERSISTENT_BARRIER
();

165 
	}
}

167 
	$nova_›í
(
öode
 *öode, 
fûe
 *
fûp
)

169  
	`gíîic_fûe_›í
(
öode
, 
fûp
);

170 
	}
}

172 
	$nova_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,

173 
loff_t
 
Àn
)

175 
öode
 *öodê
fûe
->
f_∑th
.
díåy
->
d_öode
;

176 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

177 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

178 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

179 
nova_öode
 *
pi
;

180 
nova_fûe_wrôe_íåy
 *
íåy
;

181 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

182 
nova_fûe_wrôe_íåy
 
íåy_d©a
;

183 
nova_öode_upd©e
 
upd©e
;

184 
°¨t_blk
, 
num_blocks
, 
ít_blks
 = 0;

185 
tŸÆ_blocks
 = 0;

186 
blockƒ
 = 0;

187 
blockoff
;

188 
d©a_bôs
;

189 
loff_t
 
√w_size
;

190 
ªt
 = 0;

191 
ö∂a˚
 = 0;

192 
blocksize_mask
;

193 
Æloˇãd
 = 0;

194 
boﬁ
 
upd©e_log
 = 
Ál£
;

195 
	`INIT_TIMING
(
ÁŒoˇã_time
);

196 
u64
 
begö_èû
 = 0;

197 
u64
 
ïoch_id
;

198 
u32
 
time
;

199 
úq_Êags
 = 0;

207 i‡(
mode
 & ~
FALLOC_FL_KEEP_SIZE
)

208  -
EOPNOTSUPP
;

210 i‡(
	`S_ISDIR
(
öode
->
i_mode
))

211  -
ENODEV
;

213 
√w_size
 = 
Àn
 + 
off£t
;

214 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
Ë&& 
√w_size
 > 
öode
->
i_size
) {

215 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

216 i‡(
ªt
)

217  
ªt
;

219 
√w_size
 = 
öode
->
i_size
;

222 
	`nova_dbgv
("%s: inode %lu, offset %lld, count %lld, mode 0x%x\n",

223 
__func__
, 
öode
->
i_öo
, 
off£t
, 
Àn
, 
mode
);

225 
	`NOVA_START_TIMING
(
ÁŒoˇã_t
, 
ÁŒoˇã_time
);

226 
	`öode_lock
(
öode
);

228 
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

229 i‡(!
pi
) {

230 
ªt
 = -
EACCES
;

231 
out
;

235 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

237 
time
 = 
	`cuºít_time
(
öode
).
tv_£c
;

239 
blocksize_mask
 = 
sb
->
s_blocksize
 - 1;

240 
°¨t_blk
 = 
off£t
 >> 
sb
->
s_blocksize_bôs
;

241 
blockoff
 = 
off£t
 & 
blocksize_mask
;

242 
num_blocks
 = (
blockoff
 + 
Àn
 + 
blocksize_mask
Ë>> 
sb
->
s_blocksize_bôs
;

244 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

245 
upd©e
.
èû
 = 
sih
->
log_èû
;

246 
upd©e
.
Æãr_èû
 = 
sih
->
Æãr_log_èû
;

247 
num_blocks
 > 0) {

248 
ít_blks
 = 
	`nova_check_exi°ög_íåy
(
sb
, 
öode
, 
num_blocks
,

249 
°¨t_blk
, &
íåy
, &
íåy_c›y
,

250 1, 
ïoch_id
, &
ö∂a˚
, 1);

252 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

254 i‡(
íåy
 && 
ö∂a˚
) {

255 i‡(
íåyc
->
size
 < 
√w_size
) {

257 
	`nova_memu∆ock_ønge
(
sb
, 
íåy
, 
CACHELINE_SIZE
, &
úq_Êags
);

258 
íåy
->
size
 = 
√w_size
;

259 
	`nova_upd©e_íåy_csum
(
íåy
);

260 
	`nova_upd©e_Æãr_íåy
(
sb
, 
íåy
);

261 
	`nova_memlock_ønge
(
sb
, 
íåy
, 
CACHELINE_SIZE
, &
úq_Êags
);

263 
Æloˇãd
 = 
ít_blks
;

264 
√xt
;

268 
Æloˇãd
 = 
	`nova_√w_d©a_blocks
(
sb
, 
sih
, &
blockƒ
, 
°¨t_blk
,

269 
ít_blks
, 
ALLOC_INIT_ZERO
, 
ANY_CPU
,

270 
ALLOC_FROM_HEAD
);

271 
	`nova_dbgv
("%s:áŒo¯%d block†@ %lu\n", 
__func__
,

272 
Æloˇãd
, 
blockƒ
);

274 i‡(
Æloˇãd
 <= 0) {

275 
	`nova_dbg
("%sálloc %lu blocks failed!, %d\n",

276 
__func__
, 
ít_blks
, 
Æloˇãd
);

277 
ªt
 = 
Æloˇãd
;

278 
out
;

282 
	`nova_öô_fûe_wrôe_íåy
(
sb
, 
sih
, &
íåy_d©a
, 
ïoch_id
,

283 
°¨t_blk
, 
Æloˇãd
, 
blockƒ
,

284 
time
, 
√w_size
);

286 
ªt
 = 
	`nova_≠≥nd_fûe_wrôe_íåy
(
sb
, 
pi
, 
öode
,

287 &
íåy_d©a
, &
upd©e
);

288 i‡(
ªt
) {

289 
	`nova_dbg
("%s:áµíd inodêíåy faûed\n", 
__func__
);

290 
ªt
 = -
ENOSPC
;

291 
out
;

294 
íåy
 = 
	`nova_gë_block
(
sb
, 
upd©e
.
cuº_íåy
);

295 
	`nova_ª£t_csum_∑rôy_ønge
(
sb
, 
sih
, 
íåy
, 
°¨t_blk
,

296 
°¨t_blk
 + 
Æloˇãd
, 1, 0);

298 
upd©e_log
 = 
åue
;

299 i‡(
begö_èû
 == 0)

300 
begö_èû
 = 
upd©e
.
cuº_íåy
;

302 
tŸÆ_blocks
 +
Æloˇãd
;

303 
√xt
:

304 
num_blocks
 -
Æloˇãd
;

305 
°¨t_blk
 +
Æloˇãd
;

308 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
sih
->
i_blk_ty≥
];

309 
sih
->
i_blocks
 +(
tŸÆ_blocks
 << (
d©a_bôs
 - 
sb
->
s_blocksize_bôs
));

311 
öode
->
i_blocks
 = 
sih
->i_blocks;

313 i‡(
upd©e_log
) {

314 
sih
->
log_èû
 = 
upd©e
.
èû
;

315 
sih
->
Æãr_log_èû
 = 
upd©e
.
Æãr_èû
;

317 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

318 
	`nova_upd©e_èû
(
pi
, 
upd©e
.
èû
);

319 i‡(
mëad©a_csum
)

320 
	`nova_upd©e_Æãr_èû
(
pi
, 
upd©e
.
Æãr_èû
);

321 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

324 
ªt
 = 
	`nova_ªassign_fûe_åì
(
sb
, 
sih
, 
begö_èû
);

325 i‡(
ªt
)

326 
out
;

330 
	`nova_dbgv
("blocks: %Œu, %lu\n", 
öode
->
i_blocks
, 
sih
->i_blocks);

332 i‡(
ªt
 || (
mode
 & 
FALLOC_FL_KEEP_SIZE
)) {

333 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

334 
pi
->
i_Êags
 |
	`˝u_to_À32
(
NOVA_EOFBLOCKS_FL
);

335 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

336 
sih
->
i_Êags
 |
	`˝u_to_À32
(
NOVA_EOFBLOCKS_FL
);

339 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
Ë&& 
√w_size
 > 
öode
->
i_size
) {

340 
öode
->
i_size
 = 
√w_size
;

341 
sih
->
i_size
 = 
√w_size
;

344 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

345 
	`nova_upd©e_öode_checksum
(
pi
);

346 
	`nova_upd©e_Æãr_öode
(
sb
, 
öode
, 
pi
);

347 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

349 
sih
->
å™s_id
++;

350 
out
:

351 i‡(
ªt
 < 0)

352 
	`nova_˛ónup_öcom∂ëe_wrôe
(
sb
, 
sih
, 
blockƒ
, 
Æloˇãd
,

353 
begö_èû
, 
upd©e
.
èû
);

355 
	`öode_u∆ock
(
öode
);

356 
	`NOVA_END_TIMING
(
ÁŒoˇã_t
, 
ÁŒoˇã_time
);

357  
ªt
;

358 
	}
}

360 
	$nova_iom≠_begö_nﬁock
(
öode
 *öode, 
loff_t
 
off£t
,

361 
loff_t
 
Àngth
, 
Êags
, 
iom≠
 *iom≠, iom≠ *
§cm≠
)

363  
	`nova_iom≠_begö
(
öode
, 
off£t
, 
Àngth
, 
Êags
, 
iom≠
, 
Ál£
);

364 
	}
}

366 
iom≠_›s
 
	gnova_iom≠_›s_nﬁock
 = {

367 .
iom≠_begö
 = 
nova_iom≠_begö_nﬁock
,

368 .
	giom≠_íd
 = 
nova_iom≠_íd
,

371 
ssize_t
 
	$nova_dax_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

373 
öode
 *öodê
iocb
->
ki_fûp
->
f_m≠pög
->
ho°
;

374 
ssize_t
 
ªt
;

375 
	`INIT_TIMING
(
ªad_ôî_time
);

377 i‡(!
	`iov_ôî_cou¡
(
to
))

380 
	`NOVA_START_TIMING
(
ªad_ôî_t
, 
ªad_ôî_time
);

381 
	`öode_lock_sh¨ed
(
öode
);

382 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
to
, &
nova_iom≠_›s_nﬁock
);

383 
	`öode_u∆ock_sh¨ed
(
öode
);

385 
	`fûe_ac˚s£d
(
iocb
->
ki_fûp
);

386 
	`NOVA_END_TIMING
(
ªad_ôî_t
, 
ªad_ôî_time
);

387  
ªt
;

388 
	}
}

390 
	$nova_upd©e_ôî_csum_∑rôy
(
su≥r_block
 *
sb
,

391 
öode
 *öode, 
loff_t
 
off£t
, 
size_t
 
cou¡
)

393 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

394 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

395 
°¨t_pgoff
, 
íd_pgoff
;

396 
loff_t
 
íd
;

398 i‡(
d©a_csum
 =0 && 
d©a_∑rôy
 == 0)

401 
íd
 = 
off£t
 + 
cou¡
;

403 
°¨t_pgoff
 = 
off£t
 >> 
sb
->
s_blocksize_bôs
;

404 
íd_pgoff
 = 
íd
 >> 
sb
->
s_blocksize_bôs
;

405 i‡(
íd
 & (
	`nova_öode_blk_size
(
sih
) - 1))

406 
íd_pgoff
++;

408 
	`nova_ª£t_csum_∑rôy_ønge
(
sb
, 
sih
, 
NULL
, 
°¨t_pgoff
,

409 
íd_pgoff
, 0, 0);

412 
	}
}

414 
ssize_t
 
	$nova_dax_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

416 
fûe
 *fûê
iocb
->
ki_fûp
;

417 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

418 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

419 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

420 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

421 
loff_t
 
off£t
;

422 
size_t
 
cou¡
;

423 
ssize_t
 
ªt
;

424 
	`INIT_TIMING
(
wrôe_ôî_time
);

426 
	`NOVA_START_TIMING
(
wrôe_ôî_t
, 
wrôe_ôî_time
);

427 
	`öode_lock
(
öode
);

428 
ªt
 = 
	`gíîic_wrôe_checks
(
iocb
, 
‰om
);

429 i‡(
ªt
 <= 0)

430 
out_u∆ock
;

432 
ªt
 = 
	`fûe_ªmove_¥ivs
(
fûe
);

433 i‡(
ªt
)

434 
out_u∆ock
;

436 
ªt
 = 
	`fûe_upd©e_time
(
fûe
);

437 i‡(
ªt
)

438 
out_u∆ock
;

440 
cou¡
 = 
	`iov_ôî_cou¡
(
‰om
);

441 
off£t
 = 
iocb
->
ki_pos
;

443 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
‰om
, &
nova_iom≠_›s_nﬁock
);

444 i‡(
ªt
 > 0 && 
iocb
->
ki_pos
 > 
	`i_size_ªad
(
öode
)) {

445 
	`i_size_wrôe
(
öode
, 
iocb
->
ki_pos
);

446 
sih
->
i_size
 = 
iocb
->
ki_pos
;

447 
	`m¨k_öode_dúty
(
öode
);

450 
	`nova_upd©e_ôî_csum_∑rôy
(
sb
, 
öode
, 
off£t
, 
cou¡
);

452 
out_u∆ock
:

453 
	`öode_u∆ock
(
öode
);

454 i‡(
ªt
 > 0)

455 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

456 
	`NOVA_END_TIMING
(
wrôe_ôî_t
, 
wrôe_ôî_time
);

457  
ªt
;

458 
	}
}

460 
ssize_t


461 
	$do_dax_m≠pög_ªad
(
fûe
 *
fûp
, 
__u£r
 *
buf
,

462 
size_t
 
Àn
, 
loff_t
 *
µos
)

464 
öode
 *öodê
fûp
->
f_m≠pög
->
ho°
;

465 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

466 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

467 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

468 
nova_fûe_wrôe_íåy
 *
íåy
;

469 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

470 
pgoff_t
 
ödex
, 
íd_ödex
;

471 
off£t
;

472 
loff_t
 
isize
, 
pos
;

473 
size_t
 
c›õd
 = 0, 
îr‹
 = 0;

474 
	`INIT_TIMING
(
mem˝y_time
);

476 
pos
 = *
µos
;

477 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

478 
off£t
 = 
pos
 & ~
PAGE_MASK
;

480 i‡(!
	`ac˚ss_ok
(
buf
, 
Àn
)) {

481 
îr‹
 = -
EFAULT
;

482 
out
;

485 
isize
 = 
	`i_size_ªad
(
öode
);

486 i‡(!
isize
)

487 
out
;

489 
	`nova_dbgv
("%s: inode %lu, offset %lld, count %lu, size %lld\n",

490 
__func__
, 
öode
->
i_öo
, 
pos
, 
Àn
, 
isize
);

492 i‡(
Àn
 > 
isize
 - 
pos
)

493 
Àn
 = 
isize
 - 
pos
;

495 i‡(
Àn
 <= 0)

496 
out
;

498 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

500 
íd_ödex
 = (
isize
 - 1Ë>> 
PAGE_SHIFT
;

502 
ƒ
, 
À·
;

503 
nvmm
;

504 *
dax_mem
 = 
NULL
;

505 
zîo
 = 0;

508 i‡(
ödex
 >
íd_ödex
) {

509 i‡(
ödex
 > 
íd_ödex
)

510 
out
;

511 
ƒ
 = ((
isize
 - 1Ë& ~
PAGE_MASK
) + 1;

512 i‡(
ƒ
 <
off£t
)

513 
out
;

516 
íåy
 = 
	`nova_gë_wrôe_íåy
(
sb
, 
sih
, 
ödex
);

517 i‡(
	`u∆ikñy
(
íåy
 =
NULL
)) {

518 
	`nova_dbgv
("RequiredÉxtentÇot found:Ögoff %lu, inode size %lld\n",

519 
ödex
, 
isize
);

520 
ƒ
 = 
PAGE_SIZE
;

521 
zîo
 = 1;

522 
mem˝y
;

525 i‡(
mëad©a_csum
 == 0)

526 
íåyc
 = 
íåy
;

527 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

528  -
EIO
;

531 i‡(
ödex
 < 
íåyc
->
pgoff
 ||

532 
ödex
 - 
íåyc
->
pgoff
 >íåyc->
num_∑ges
) {

533 
	`nova_îr
(
sb
, "%s ERROR: %lu,ÉntryÖgoff %llu,Çum %u, blocknr %llu\n",

534 
__func__
, 
ödex
, 
íåy
->
pgoff
,

535 
íåy
->
num_∑ges
,É¡ry->
block
 >> 
PAGE_SHIFT
);

536  -
EINVAL
;

538 i‡(
íåyc
->
ªassig√d
 == 0) {

539 
ƒ
 = (
íåyc
->
num_∑ges
 - (
ödex
 -É¡ryc->
pgoff
))

540 * 
PAGE_SIZE
;

542 
ƒ
 = 
PAGE_SIZE
;

545 
nvmm
 = 
	`gë_nvmm
(
sb
, 
sih
, 
íåyc
, 
ödex
);

546 
dax_mem
 = 
	`nova_gë_block
(
sb
, (
nvmm
 << 
PAGE_SHIFT
));

548 
mem˝y
:

549 
ƒ
 =Ç∏- 
off£t
;

550 i‡(
ƒ
 > 
Àn
 - 
c›õd
)

551 
ƒ
 = 
Àn
 - 
c›õd
;

553 i‡((!
zîo
Ë&& (
d©a_csum
 > 0)) {

554 i‡(
	`nova_föd_pgoff_ö_vma
(
öode
, 
ödex
))

555 
skù_vîify
;

557 i‡(!
	`nova_vîify_d©a_csum
(
sb
, 
sih
, 
nvmm
, 
off£t
, 
ƒ
)) {

558 
	`nova_îr
(
sb
, "%s:Çova data checksumándÑecovery fail! inode %lu, offset %lu,ÉntryÖgoff %lu, %uÖages,Ögoff %lu\n",

559 
__func__
, 
öode
->
i_öo
, 
off£t
,

560 
íåy
->
pgoff
,É¡ry->
num_∑ges
, 
ödex
);

561 
îr‹
 = -
EIO
;

562 
out
;

565 
skù_vîify
:

566 
	`NOVA_START_TIMING
(
mem˝y_r_nvmm_t
, 
mem˝y_time
);

568 i‡(!
zîo
)

569 
À·
 = 
	`__c›y_to_u£r
(
buf
 + 
c›õd
,

570 
dax_mem
 + 
off£t
, 
ƒ
);

572 
À·
 = 
	`__˛ór_u£r
(
buf
 + 
c›õd
, 
ƒ
);

574 
	`NOVA_END_TIMING
(
mem˝y_r_nvmm_t
, 
mem˝y_time
);

576 i‡(
À·
) {

577 
	`nova_dbg
("%s ERROR!: bytes %lu,Üeft %lu\n",

578 
__func__
, 
ƒ
, 
À·
);

579 
îr‹
 = -
EFAULT
;

580 
out
;

583 
c›õd
 +(
ƒ
 - 
À·
);

584 
off£t
 +(
ƒ
 - 
À·
);

585 
ödex
 +
off£t
 >> 
PAGE_SHIFT
;

586 
off£t
 &~
PAGE_MASK
;

587 } 
c›õd
 < 
Àn
);

589 
out
:

590 *
µos
 = 
pos
 + 
c›õd
;

591 i‡(
fûp
)

592 
	`fûe_ac˚s£d
(
fûp
);

594 
	`NOVA_STATS_ADD
(
ªad_byãs
, 
c›õd
);

596 
	`nova_dbgv
("%†ªtu∫ed %zu\n", 
__func__
, 
c›õd
);

597  
c›õd
 ? c›õd : 
îr‹
;

598 
	}
}

605 
ssize_t
 
	$nova_dax_fûe_ªad
(
fûe
 *
fûp
, 
__u£r
 *
buf
,

606 
size_t
 
Àn
, 
loff_t
 *
µos
)

608 
öode
 *öodê
fûp
->
f_m≠pög
->
ho°
;

609 
ssize_t
 
ªs
;

610 
	`INIT_TIMING
(
dax_ªad_time
);

612 
	`NOVA_START_TIMING
(
dax_ªad_t
, 
dax_ªad_time
);

613 
	`öode_lock_sh¨ed
(
öode
);

614 
ªs
 = 
	`do_dax_m≠pög_ªad
(
fûp
, 
buf
, 
Àn
, 
µos
);

615 
	`öode_u∆ock_sh¨ed
(
öode
);

616 
	`NOVA_END_TIMING
(
dax_ªad_t
, 
dax_ªad_time
);

617  
ªs
;

618 
	}
}

623 
ssize_t
 
	$do_nova_cow_fûe_wrôe
(
fûe
 *
fûp
,

624 c⁄° 
__u£r
 *
buf
, 
size_t
 
Àn
, 
loff_t
 *
µos
)

626 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

627 
öode
 *öodê
m≠pög
->
ho°
;

628 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

629 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

630 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

631 
nova_öode
 *
pi
, 
öode_c›y
;

632 
nova_fûe_wrôe_íåy
 
íåy_d©a
;

633 
nova_öode_upd©e
 
upd©e
;

634 
ssize_t
 
wrôãn
 = 0;

635 
loff_t
 
pos
;

636 
size_t
 
cou¡
, 
off£t
, 
c›õd
;

637 
°¨t_blk
, 
num_blocks
;

638 
tŸÆ_blocks
;

639 
blockƒ
 = 0;

640 
d©a_bôs
;

641 
Æloˇãd
 = 0;

642 *
kmem
;

643 
u64
 
fûe_size
;

644 
size_t
 
byãs
;

645 
°©us
 = 0;

646 
	`INIT_TIMING
(
cow_wrôe_time
);

647 
	`INIT_TIMING
(
mem˝y_time
);

648 
°ï
 = 0;

649 
ssize_t
 
ªt
;

650 
u64
 
begö_èû
 = 0;

651 
åy_ö∂a˚
 = 0;

652 
u64
 
ïoch_id
;

653 
u32
 
time
;

654 
úq_Êags
 = 0;

657 i‡(
Àn
 == 0)

660 
	`NOVA_START_TIMING
(
do_cow_wrôe_t
, 
cow_wrôe_time
);

662 i‡(!
	`ac˚ss_ok
(
buf
, 
Àn
)) {

663 
ªt
 = -
EFAULT
;

664 
out
;

666 
pos
 = *
µos
;

668 i‡(
fûp
->
f_Êags
 & 
O_APPEND
)

669 
pos
 = 
	`i_size_ªad
(
öode
);

671 
cou¡
 = 
Àn
;

673 
pi
 = 
	`nova_gë_block
(
sb
, 
sih
->
pi_addr
);

678 i‡(
	`nova_check_öode_öãgrôy
(
sb
, 
sih
->
öo
, sih->
pi_addr
,

679 
sih
->
Æãr_pi_addr
, &
öode_c›y
, 0) < 0) {

680 
ªt
 = -
EIO
;

681 
out
;

684 
off£t
 = 
pos
 & (
sb
->
s_blocksize
 - 1);

685 
num_blocks
 = ((
cou¡
 + 
off£t
 - 1Ë>> 
sb
->
s_blocksize_bôs
) + 1;

686 
tŸÆ_blocks
 = 
num_blocks
;

687 
°¨t_blk
 = 
pos
 >> 
sb
->
s_blocksize_bôs
;

689 i‡(
	`nova_check_ovîœp_vmas
(
sb
, 
sih
, 
°¨t_blk
, 
num_blocks
)) {

690 
	`nova_dbgv
("COW write overlaps with vma: inode %lu,Ögoff %lu, %lu blocks\n",

691 
öode
->
i_öo
, 
°¨t_blk
, 
num_blocks
);

692 
	`NOVA_STATS_ADD
(
cow_ovîœp_mm≠
, 1);

693 
åy_ö∂a˚
 = 1;

694 
ªt
 = -
EACCES
;

695 
out
;

700 
ªt
 = 
	`fûe_ªmove_¥ivs
(
fûp
);

701 i‡(
ªt
)

702 
out
;

705 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

707 
time
 = 
	`cuºít_time
(
öode
).
tv_£c
;

709 
	`nova_dbgv
("%s: inode %lu, offset %lld, count %lu\n",

710 
__func__
, 
öode
->
i_öo
, 
pos
, 
cou¡
);

712 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

713 
upd©e
.
èû
 = 
sih
->
log_èû
;

714 
upd©e
.
Æãr_èû
 = 
sih
->
Æãr_log_èû
;

715 
num_blocks
 > 0) {

716 
off£t
 = 
pos
 & (
	`nova_öode_blk_size
(
sih
) - 1);

717 
°¨t_blk
 = 
pos
 >> 
sb
->
s_blocksize_bôs
;

720 
Æloˇãd
 = 
	`nova_√w_d©a_blocks
(
sb
, 
sih
, &
blockƒ
, 
°¨t_blk
,

721 
num_blocks
, 
ALLOC_NO_INIT
, 
ANY_CPU
,

722 
ALLOC_FROM_HEAD
);

724 
	`nova_dbg_vîbo£
("%s:áŒo¯%d block†@ %lu\n", 
__func__
,

725 
Æloˇãd
, 
blockƒ
);

727 i‡(
Æloˇãd
 <= 0) {

728 
	`nova_dbg
("%†Ælo¯block†Áûed %d\n", 
__func__
,

729 
Æloˇãd
);

730 
ªt
 = 
Æloˇãd
;

731 
out
;

734 
°ï
++;

735 
byãs
 = 
sb
->
s_blocksize
 * 
Æloˇãd
 - 
off£t
;

736 i‡(
byãs
 > 
cou¡
)

737 
byãs
 = 
cou¡
;

739 
kmem
 = 
	`nova_gë_block
(
öode
->
i_sb
,

740 
	`nova_gë_block_off
(
sb
, 
blockƒ
, 
sih
->
i_blk_ty≥
));

742 i‡(
off£t
 || ((off£à+ 
byãs
Ë& (
PAGE_SIZE
 - 1)) != 0) {

743 
ªt
 = 
	`nova_h™dÀ_hód_èû_blocks
(
sb
, 
öode
, 
pos
,

744 
byãs
, 
kmem
);

745 i‡(
ªt
)

746 
out
;

750 
	`NOVA_START_TIMING
(
mem˝y_w_nvmm_t
, 
mem˝y_time
);

751 
	`nova_memu∆ock_ønge
(
sb
, 
kmem
 + 
off£t
, 
byãs
, &
úq_Êags
);

752 
c›õd
 = 
byãs
 - 
	`mem˝y_to_pmem_noˇche
(
kmem
 + 
off£t
,

753 
buf
, 
byãs
);

754 
	`nova_memlock_ønge
(
sb
, 
kmem
 + 
off£t
, 
byãs
, &
úq_Êags
);

755 
	`NOVA_END_TIMING
(
mem˝y_w_nvmm_t
, 
mem˝y_time
);

757 i‡(
d©a_csum
 > 0 || 
d©a_∑rôy
 > 0) {

758 
ªt
 = 
	`nova_¥Ÿe˘_fûe_d©a
(
sb
, 
öode
, 
pos
, 
byãs
,

759 
buf
, 
blockƒ
, 
Ál£
);

760 i‡(
ªt
)

761 
out
;

764 i‡(
pos
 + 
c›õd
 > 
öode
->
i_size
)

765 
fûe_size
 = 
	`˝u_to_À64
(
pos
 + 
c›õd
);

767 
fûe_size
 = 
	`˝u_to_À64
(
öode
->
i_size
);

769 
	`nova_öô_fûe_wrôe_íåy
(
sb
, 
sih
, &
íåy_d©a
, 
ïoch_id
,

770 
°¨t_blk
, 
Æloˇãd
, 
blockƒ
, 
time
,

771 
fûe_size
);

773 
ªt
 = 
	`nova_≠≥nd_fûe_wrôe_íåy
(
sb
, 
pi
, 
öode
,

774 &
íåy_d©a
, &
upd©e
);

775 i‡(
ªt
) {

776 
	`nova_dbg
("%s:áµíd inodêíåy faûed\n", 
__func__
);

777 
ªt
 = -
ENOSPC
;

778 
out
;

781 
	`nova_dbgv
("Wrôe: %p, %lu\n", 
kmem
, 
c›õd
);

782 i‡(
c›õd
 > 0) {

783 
°©us
 = 
c›õd
;

784 
wrôãn
 +
c›õd
;

785 
pos
 +
c›õd
;

786 
buf
 +
c›õd
;

787 
cou¡
 -
c›õd
;

788 
num_blocks
 -
Æloˇãd
;

790 i‡(
	`u∆ikñy
(
c›õd
 !
byãs
)) {

791 
	`nova_dbg
("%s ERROR!: %p, bytes %lu, copied %lu\n",

792 
__func__
, 
kmem
, 
byãs
, 
c›õd
);

793 i‡(
°©us
 >= 0)

794 
°©us
 = -
EFAULT
;

796 i‡(
°©us
 < 0)

799 i‡(
begö_èû
 == 0)

800 
begö_èû
 = 
upd©e
.
cuº_íåy
;

803 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
sih
->
i_blk_ty≥
];

804 
sih
->
i_blocks
 +(
tŸÆ_blocks
 << (
d©a_bôs
 - 
sb
->
s_blocksize_bôs
));

806 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

807 
	`nova_upd©e_öode
(
sb
, 
öode
, 
pi
, &
upd©e
, 1);

808 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

811 
ªt
 = 
	`nova_ªassign_fûe_åì
(
sb
, 
sih
, 
begö_èû
);

812 i‡(
ªt
)

813 
out
;

815 
öode
->
i_blocks
 = 
sih
->i_blocks;

817 
ªt
 = 
wrôãn
;

818 
	`NOVA_STATS_ADD
(
cow_wrôe_bªaks
, 
°ï
);

819 
	`nova_dbgv
("blocks: %Œu, %lu\n", 
öode
->
i_blocks
, 
sih
->i_blocks);

821 *
µos
 = 
pos
;

822 i‡(
pos
 > 
öode
->
i_size
) {

823 
	`i_size_wrôe
(
öode
, 
pos
);

824 
sih
->
i_size
 = 
pos
;

827 
sih
->
å™s_id
++;

828 
out
:

829 i‡(
ªt
 < 0)

830 
	`nova_˛ónup_öcom∂ëe_wrôe
(
sb
, 
sih
, 
blockƒ
, 
Æloˇãd
,

831 
begö_èû
, 
upd©e
.
èû
);

833 
	`NOVA_END_TIMING
(
do_cow_wrôe_t
, 
cow_wrôe_time
);

834 
	`NOVA_STATS_ADD
(
cow_wrôe_byãs
, 
wrôãn
);

836 i‡(
åy_ö∂a˚
)

837  
	`do_nova_ö∂a˚_fûe_wrôe
(
fûp
, 
buf
, 
Àn
, 
µos
);

839  
ªt
;

840 
	}
}

845 
ssize_t
 
	$nova_cow_fûe_wrôe
(
fûe
 *
fûp
,

846 c⁄° 
__u£r
 *
buf
, 
size_t
 
Àn
, 
loff_t
 *
µos
)

848 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

849 
öode
 *öodê
m≠pög
->
ho°
;

850 
ªt
;

851 
	`INIT_TIMING
(
time
);

854 i‡(
Àn
 == 0)

857 
	`NOVA_START_TIMING
(
cow_wrôe_t
, 
time
);

859 
	`sb_°¨t_wrôe
(
öode
->
i_sb
);

860 
	`öode_lock
(
öode
);

862 
ªt
 = 
	`do_nova_cow_fûe_wrôe
(
fûp
, 
buf
, 
Àn
, 
µos
);

864 
	`öode_u∆ock
(
öode
);

865 
	`sb_íd_wrôe
(
öode
->
i_sb
);

867 
	`NOVA_END_TIMING
(
cow_wrôe_t
, 
time
);

868  
ªt
;

869 
	}
}

872 
ssize_t
 
	$nova_dax_fûe_wrôe
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
,

873 
size_t
 
Àn
, 
loff_t
 *
µos
)

875 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

876 
öode
 *öodê
m≠pög
->
ho°
;

878 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_COW
))

879  
	`nova_cow_fûe_wrôe
(
fûp
, 
buf
, 
Àn
, 
µos
);

881  
	`nova_ö∂a˚_fûe_wrôe
(
fûp
, 
buf
, 
Àn
, 
µos
);

882 
	}
}

884 
ssize_t
 
	$do_nova_dax_fûe_wrôe
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
,

885 
size_t
 
Àn
, 
loff_t
 *
µos
)

887 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

888 
öode
 *öodê
m≠pög
->
ho°
;

890 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_COW
))

891  
	`do_nova_cow_fûe_wrôe
(
fûp
, 
buf
, 
Àn
, 
µos
);

893  
	`do_nova_ö∂a˚_fûe_wrôe
(
fûp
, 
buf
, 
Àn
, 
µos
);

894 
	}
}

897 
	$nova_dax_fûe_mm≠
(
fûe
 *fûe, 
vm_¨ó_°ru˘
 *
vma
)

899 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

901 
	`fûe_ac˚s£d
(
fûe
);

904 
	`vm_Êags_£t
(
vma
, 
VM_MIXEDMAP
 | 
VM_HUGEPAGE
);

906 
vma
->
vm_›s
 = &
nova_dax_vm_›s
;

908 
	`nova_ö£π_wrôe_vma
(
vma
);

910 
	`nova_dbg_mm≠4k
("[%s:%d] inode %lu, MMAP 4KPAGE vm_start(0x%lx), vm_end(0x%lx), vmÖgoff %lu, %lu blocks, vm_flags(0x%lx), vm_page_prot(0x%lx)\n",

911 
__func__
, 
__LINE__
,

912 
öode
->
i_öo
, 
vma
->
vm_°¨t
, vma->
vm_íd
,

913 
vma
->
vm_pgoff
,

914 (
vma
->
vm_íd
 - vma->
vm_°¨t
Ë>> 
PAGE_SHIFT
,

915 
vma
->
vm_Êags
,

916 
	`pg¥Ÿ_vÆ
(
vma
->
vm_∑ge_¥Ÿ
));

919 
	}
}

921 c⁄° 
fûe_›î©i⁄s
 
	gnova_dax_fûe_›î©i⁄s
 = {

922 .
Œ£ek
 = 
nova_Œ£ek
,

923 .
	gªad
 = 
nova_dax_fûe_ªad
,

924 .
	gwrôe
 = 
nova_dax_fûe_wrôe
,

925 .
	gªad_ôî
 = 
nova_dax_ªad_ôî
,

926 .
	gwrôe_ôî
 = 
nova_dax_wrôe_ôî
,

927 .
	gmm≠
 = 
nova_dax_fûe_mm≠
,

928 .
	gmm≠_suµ‹ãd_Êags
 = 
MAP_SYNC
,

929 .
	g›í
 = 
nova_›í
,

930 .
	gfsync
 = 
nova_fsync
,

931 .
	gÊush
 = 
nova_Êush
,

932 .
	gu∆ocked_io˘l
 = 
nova_io˘l
,

933 .
	gÁŒoˇã
 = 
nova_ÁŒoˇã
,

934 #ifde‡
CONFIG_COMPAT


935 .
	gcom∑t_io˘l
 = 
nova_com∑t_io˘l
,

940 
ssize_t
 
	$nova_wøp_rw_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

942 
fûe
 *
fûp
 = 
iocb
->
ki_fûp
;

943 
öode
 *öodê
fûp
->
f_m≠pög
->
ho°
;

944 
ssize_t
 
ªt
 = -
EIO
;

945 
ssize_t
 
wrôãn
 = 0;

946 
£g
;

947 
ƒ_£gs
 = 
ôî
->nr_segs;

949 c⁄° 
iovec
 *
iv
 = 
	`ôî_iov
(
ôî
);

950 
	`INIT_TIMING
(
wøp_ôî_time
);

952 
	`NOVA_START_TIMING
(
wøp_ôî_t
, 
wøp_ôî_time
);

954 
	`nova_dbgv
("%†%s: %lu segs\n", 
__func__
,

955 
	`iov_ôî_rw
(
ôî
Ë=
READ
 ? "read" : "write",

956 
ƒ_£gs
);

958 i‡(
	`iov_ôî_rw
(
ôî
Ë=
WRITE
) {

959 
	`sb_°¨t_wrôe
(
öode
->
i_sb
);

960 
	`öode_lock
(
öode
);

962 
	`öode_lock_sh¨ed
(
öode
);

966 
iv
 = 
	`ôî_iov
(
ôî
);

967 
£g
 = 0; seg < 
ƒ_£gs
; seg++) {

968 i‡(
	`iov_ôî_rw
(
ôî
Ë=
READ
) {

969 
ªt
 = 
	`do_dax_m≠pög_ªad
(
fûp
, 
iv
->
iov_ba£
,

970 
iv
->
iov_Àn
, &
iocb
->
ki_pos
);

971 } i‡(
	`iov_ôî_rw
(
ôî
Ë=
WRITE
) {

972 
ªt
 = 
	`do_nova_dax_fûe_wrôe
(
fûp
, 
iv
->
iov_ba£
,

973 
iv
->
iov_Àn
, &
iocb
->
ki_pos
);

975 
	`BUG
();

977 i‡(
ªt
 < 0)

978 
îr
;

980 i‡(
ôî
->
cou¡
 > 
iv
->
iov_Àn
)

981 
ôî
->
cou¡
 -
iv
->
iov_Àn
;

983 
ôî
->
cou¡
 = 0;

985 
wrôãn
 +
ªt
;

986 
ôî
->
ƒ_£gs
--;

987 
iv
++;

989 
ªt
 = 
wrôãn
;

990 
îr
:

991 i‡(
	`iov_ôî_rw
(
ôî
Ë=
WRITE
) {

992 
	`öode_u∆ock
(
öode
);

993 
	`sb_íd_wrôe
(
öode
->
i_sb
);

995 
	`öode_u∆ock_sh¨ed
(
öode
);

998 
	`NOVA_END_TIMING
(
wøp_ôî_t
, 
wøp_ôî_time
);

999  
ªt
;

1000 
	}
}

1004 c⁄° 
fûe_›î©i⁄s
 
	gnova_wøp_fûe_›î©i⁄s
 = {

1005 .
Œ£ek
 = 
nova_Œ£ek
,

1006 .
	gªad
 = 
nova_dax_fûe_ªad
,

1007 .
	gwrôe
 = 
nova_dax_fûe_wrôe
,

1008 .
	gªad_ôî
 = 
nova_wøp_rw_ôî
,

1009 .
	gwrôe_ôî
 = 
nova_wøp_rw_ôî
,

1010 .
	gmm≠
 = 
nova_dax_fûe_mm≠
,

1011 .
	ggë_unm≠≥d_¨ó
 = 
thp_gë_unm≠≥d_¨ó
,

1012 .
	g›í
 = 
nova_›í
,

1013 .
	gfsync
 = 
nova_fsync
,

1014 .
	gÊush
 = 
nova_Êush
,

1015 .
	gu∆ocked_io˘l
 = 
nova_io˘l
,

1016 .
	gÁŒoˇã
 = 
nova_ÁŒoˇã
,

1017 #ifde‡
CONFIG_COMPAT


1018 .
	gcom∑t_io˘l
 = 
nova_com∑t_io˘l
,

1022 c⁄° 
öode_›î©i⁄s
 
	gnova_fûe_öode_›î©i⁄s
 = {

1023 .
£èâr
 = 
nova_nŸify_ch™ge
,

1024 .
	ggë©å
 = 
nova_gë©å
,

1025 .
	ggë_a˛
 = 
NULL
,

	@gc.c

18 
	~"nova.h
"

19 
	~"öode.h
"

21 
boﬁ
 
	$cuº_log_íåy_övÆid
(
su≥r_block
 *
sb
,

22 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

23 
u64
 
cuº_p
, 
size_t
 *
Àngth
)

25 
nova_fûe_wrôe_íåy
 *
íåy
;

26 
nova_díåy
 *
díåy
;

27 
nova_£èâr_logíåy
 *
£èâr_íåy
;

28 
nova_lök_ch™ge_íåy
 *
lökc_íåy
;

29 
nova_mm≠_íåy
 *
mm≠_íåy
;

30 
nova_¢≠shŸ_öfo_íåy
 *
¢_íåy
;

31 
íåy_c›y
[
NOVA_MAX_ENTRY_LEN
];

32 *
addr
, *
íåyc
;

33 
u8
 
ty≥
;

34 
boﬁ
 
ªt
 = 
åue
;

36 
addr
 = (*)
	`nova_gë_block
(
sb
, 
cuº_p
);

41 i‡(
mëad©a_csum
 == 0)

42 
íåyc
 = 
addr
;

44 
íåyc
 = 
íåy_c›y
;

45 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
addr
, 
íåyc
))

46  
åue
;

49 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
íåyc
);

50 
ty≥
) {

51 
SET_ATTR
:

52 
£èâr_íåy
 = (
nova_£èâr_logíåy
 *Ë
íåyc
;

53 i‡(
£èâr_íåy
->
övÆid
 == 0)

54 
ªt
 = 
Ál£
;

55 *
Àngth
 = (
nova_£èâr_logíåy
);

57 
LINK_CHANGE
:

58 
lökc_íåy
 = (
nova_lök_ch™ge_íåy
 *Ë
íåyc
;

59 i‡(
lökc_íåy
->
övÆid
 == 0)

60 
ªt
 = 
Ál£
;

61 *
Àngth
 = (
nova_lök_ch™ge_íåy
);

63 
FILE_WRITE
:

64 
íåy
 = (
nova_fûe_wrôe_íåy
 *Ë
íåyc
;

65 i‡(
íåy
->
num_∑ges
 !íåy->
övÆid_∑ges
)

66 
ªt
 = 
Ál£
;

67 *
Àngth
 = (
nova_fûe_wrôe_íåy
);

69 
DIR_LOG
:

70 
díåy
 = (
nova_díåy
 *Ë
íåyc
;

71 i‡(
díåy
->
övÆid
 == 0)

72 
ªt
 = 
Ál£
;

73 i‡(
sih
->
œ°_díåy
 =
cuº_p
)

74 
ªt
 = 
Ál£
;

75 *
Àngth
 = 
	`À16_to_˝u
(
díåy
->
de_Àn
);

77 
MMAP_WRITE
:

78 
mm≠_íåy
 = (
nova_mm≠_íåy
 *Ë
íåyc
;

79 i‡(
mm≠_íåy
->
övÆid
 == 0)

80 
ªt
 = 
Ál£
;

81 *
Àngth
 = (
nova_mm≠_íåy
);

83 
SNAPSHOT_INFO
:

84 
¢_íåy
 = (
nova_¢≠shŸ_öfo_íåy
 *Ë
íåyc
;

85 i‡(
¢_íåy
->
dñëed
 == 0)

86 
ªt
 = 
Ál£
;

87 *
Àngth
 = (
nova_¢≠shŸ_öfo_íåy
);

89 
NEXT_PAGE
:

91 *
Àngth
 = 
PAGE_SIZE
 - 
	`ENTRY_LOC
(
cuº_p
);

94 
	`nova_dbg
("%s: unknownÅype %d, 0x%llx\n",

95 
__func__
, 
ty≥
, 
cuº_p
);

96 
	`NOVA_ASSERT
(0);

97 *
Àngth
 = 
PAGE_SIZE
 - 
	`ENTRY_LOC
(
cuº_p
);

101  
ªt
;

102 
	}
}

104 
boﬁ
 
	$cuº_∑ge_övÆid
(
su≥r_block
 *
sb
,

105 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

106 
u64
 
∑ge_hód
)

108 
nova_öode_log_∑ge
 *
cuº_∑ge
;

109 
nova_öode_∑ge_èû
 
∑ge_èû
;

110 
num_íåõs
;

111 
övÆid_íåõs
;

112 
boﬁ
 
ªt
;

113 
	`INIT_TIMING
(
check_time
);

114 
rc
 = 0;

116 
	`NOVA_START_TIMING
(
check_övÆid_t
, 
check_time
);

118 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)

119 
	`nova_gë_block
(
sb
, 
∑ge_hód
);

120 i‡(
	`mem˝y
(&
∑ge_èû
, &
cuº_∑ge
->page_tail,

121 (
nova_öode_∑ge_èû
)Ë=
NULL
)

122 
rc
 = -1;

124 i‡(
rc
) {

126 
	`nova_îr
(
sb
, "checkÖage failed\n");

127  
Ál£
;

130 
num_íåõs
 = 
	`À32_to_˝u
(
∑ge_èû
.num_entries);

131 
övÆid_íåõs
 = 
	`À32_to_˝u
(
∑ge_èû
.invalid_entries);

133 
ªt
 = (
övÆid_íåõs
 =
num_íåõs
);

134 i‡(!
ªt
) {

135 
sih
->
num_íåõs
 +=Çum_entries;

136 
sih
->
vÆid_íåõs
 +
num_íåõs
 - 
övÆid_íåõs
;

139 
	`NOVA_END_TIMING
(
check_övÆid_t
, 
check_time
);

140  
ªt
;

141 
	}
}

143 
	$‰ì_cuº_∑ge
(
su≥r_block
 *
sb
,

144 
nova_öode_öfo_hódî
 *
sih
,

145 
nova_öode_log_∑ge
 *
cuº_∑ge
,

146 
nova_öode_log_∑ge
 *
œ°_∑ge
, 
u64
 
cuº_hód
)

148 
u8
 
bty≥
 = 
sih
->
i_blk_ty≥
;

149 
úq_Êags
 = 0;

151 
	`nova_memu∆ock_block
(
sb
, 
œ°_∑ge
, &
úq_Êags
);

152 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
œ°_∑ge
,

153 
cuº_∑ge
->
∑ge_èû
.
√xt_∑ge
, 1);

154 
	`nova_memlock_block
(
sb
, 
œ°_∑ge
, &
úq_Êags
);

155 
	`nova_‰ì_log_blocks
(
sb
, 
sih
,

156 
	`nova_gë_blockƒ
(
sb
, 
cuº_hód
, 
bty≥
), 1);

157 
	}
}

159 
	$nova_gc_assign_fûe_íåy
(
su≥r_block
 *
sb
,

160 
nova_öode_öfo_hódî
 *
sih
,

161 
nova_fûe_wrôe_íåy
 *
ﬁd_íåy
,

162 
nova_fûe_wrôe_íåy
 *
√w_íåy
)

164 
nova_fûe_wrôe_íåy
 *
ãmp
;

165 **
≥¡ry
;

166 
°¨t_pgoff
 = 
ﬁd_íåy
->
pgoff
;

167 
num
 = 
ﬁd_íåy
->
num_∑ges
;

168 
cuº_pgoff
;

169 
i
;

170 
ªt
 = 0;

172 
i
 = 0; i < 
num
; i++) {

173 
cuº_pgoff
 = 
°¨t_pgoff
 + 
i
;

175 
≥¡ry
 = 
	`ødix_åì_lookup_¶Ÿ
(&
sih
->
åì
, 
cuº_pgoff
);

176 i‡(
≥¡ry
) {

177 
ãmp
 = 
	`ødix_åì_dîef_¶Ÿ
(
≥¡ry
);

178 i‡(
ãmp
 =
ﬁd_íåy
)

179 
	`ødix_åì_ª∂a˚_¶Ÿ
(&
sih
->
åì
, 
≥¡ry
,

180 
√w_íåy
);

184  
ªt
;

185 
	}
}

187 
	$nova_gc_assign_díåy
(
su≥r_block
 *
sb
,

188 
nova_öode_öfo_hódî
 *
sih
, 
nova_díåy
 *
ﬁd_díåy
,

189 
nova_díåy
 *
√w_díåy
)

191 
nova_ønge_node
 *
ªt_node
 = 
NULL
;

192 
hash
;

193 
found
 = 0;

194 
ªt
 = 0;

196 
hash
 = 
	`BKDRHash
(
ﬁd_díåy
->
«me
, old_díåy->
«me_Àn
);

197 
	`nova_dbgv
("%s:ássig¿%†hash %lu\n", 
__func__
,

198 
ﬁd_díåy
->
«me
, 
hash
);

201 
found
 = 
	`nova_föd_ønge_node
(&
sih
->
rb_åì
, 
hash
,

202 
NODE_DIR
, &
ªt_node
);

203 i‡(
found
 =1 && 
hash
 =
ªt_node
->hash) {

204 i‡(
ªt_node
->
dúíåy
 =
ﬁd_díåy
)

205 
ªt_node
->
dúíåy
 = 
√w_díåy
;

208  
ªt
;

209 
	}
}

211 
	$nova_gc_assign_mm≠_íåy
(
su≥r_block
 *
sb
,

212 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
cuº_p
, u64 
√w_cuº
)

214 
vma_ôem
 *
ôem
;

215 
rb_node
 *
ãmp
;

216 
ªt
 = 0;

218 i‡(
sih
->
num_vmas
 == 0)

219  
ªt
;

221 
ãmp
 = 
	`rb_fú°
(&
sih
->
vma_åì
);

222 
ãmp
) {

223 
ôem
 = 
	`c⁄èöî_of
(
ãmp
, 
vma_ôem
, 
node
);

224 
ãmp
 = 
	`rb_√xt
(temp);

225 i‡(
ôem
->
mm≠_íåy
 =
cuº_p
) {

226 
ôem
->
mm≠_íåy
 = 
√w_cuº
;

231  
ªt
;

232 
	}
}

234 
	$nova_gc_assign_¢≠shŸ_íåy
(
su≥r_block
 *
sb
,

235 
nova_öode_öfo_hódî
 *
sih
,

236 
nova_¢≠shŸ_öfo_íåy
 *
ﬁd_íåy
, 
u64
 
cuº_p
, u64 
√w_cuº
)

238 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

239 
¢≠shŸ_öfo
 *
öfo
;

240 
ªt
 = 0;

242 
öfo
 = 
	`ødix_åì_lookup
(&
sbi
->
¢≠shŸ_öfo_åì
,

243 
ﬁd_íåy
->
ïoch_id
);

245 i‡(
öfo
 && info->
¢≠shŸ_íåy
 =
cuº_p
)

246 
öfo
->
¢≠shŸ_íåy
 = 
√w_cuº
;

248  
ªt
;

249 
	}
}

251 
	$nova_gc_assign_√w_íåy
(
su≥r_block
 *
sb
,

252 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

253 
u64
 
cuº_p
, u64 
√w_cuº
)

255 
nova_fûe_wrôe_íåy
 *
ﬁd_íåy
, *
√w_íåy
;

256 
nova_díåy
 *
ﬁd_díåy
, *
√w_díåy
;

257 *
addr
, *
√w_addr
;

258 
u8
 
ty≥
;

259 
ªt
 = 0;

261 
addr
 = (*)
	`nova_gë_block
(
sb
, 
cuº_p
);

262 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
addr
);

263 
ty≥
) {

264 
SET_ATTR
:

265 
sih
->
œ°_£èâr
 = 
√w_cuº
;

267 
LINK_CHANGE
:

268 
sih
->
œ°_lök_ch™ge
 = 
√w_cuº
;

270 
MMAP_WRITE
:

271 
ªt
 = 
	`nova_gc_assign_mm≠_íåy
(
sb
, 
sih
, 
cuº_p
, 
√w_cuº
);

273 
SNAPSHOT_INFO
:

274 
ªt
 = 
	`nova_gc_assign_¢≠shŸ_íåy
(
sb
, 
sih
, 
addr
,

275 
cuº_p
, 
√w_cuº
);

277 
FILE_WRITE
:

278 
√w_addr
 = (*)
	`nova_gë_block
(
sb
, 
√w_cuº
);

279 
ﬁd_íåy
 = (
nova_fûe_wrôe_íåy
 *)
addr
;

280 
√w_íåy
 = (
nova_fûe_wrôe_íåy
 *)
√w_addr
;

281 
ªt
 = 
	`nova_gc_assign_fûe_íåy
(
sb
, 
sih
, 
ﬁd_íåy
, 
√w_íåy
);

283 
DIR_LOG
:

284 
√w_addr
 = (*)
	`nova_gë_block
(
sb
, 
√w_cuº
);

285 
ﬁd_díåy
 = (
nova_díåy
 *)
addr
;

286 
√w_díåy
 = (
nova_díåy
 *)
√w_addr
;

287 i‡(
sih
->
œ°_díåy
 =
cuº_p
)

288 
sih
->
œ°_díåy
 = 
√w_cuº
;

289 
ªt
 = 
	`nova_gc_assign_díåy
(
sb
, 
sih
, 
ﬁd_díåy
, 
√w_díåy
);

292 
	`nova_dbg
("%s: unknownÅype %d, 0x%llx\n",

293 
__func__
, 
ty≥
, 
cuº_p
);

294 
	`NOVA_ASSERT
(0);

298  
ªt
;

299 
	}
}

302 
	$nova_öode_log_th‹ough_gc
(
su≥r_block
 *
sb
,

303 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

304 
blocks
, 
checked_∑ges
)

306 
nova_öode_log_∑ge
 *
cuº_∑ge
 = 
NULL
;

307 
size_t
 
Àngth
;

308 
nova_öode
 *
Æãr_pi
;

309 
u64
 
öo
 = 
pi
->
nova_öo
;

310 
u64
 
cuº_p
, 
√w_cuº
;

311 
u64
 
ﬁd_cuº_p
;

312 
u64
 
èû_block
;

313 
u64
 
ﬁd_hód
;

314 
u64
 
√w_hód
 = 0;

315 
u64
 
√xt
;

316 
Æloˇãd
;

317 
exãnded
 = 0;

318 
ªt
;

319 
úq_Êags
 = 0;

320 
	`INIT_TIMING
(
gc_time
);

322 
	`NOVA_START_TIMING
(
th‹ough_gc_t
, 
gc_time
);

324 
cuº_p
 = 
sih
->
log_hód
;

325 
ﬁd_cuº_p
 = 
cuº_p
;

326 
ﬁd_hód
 = 
sih
->
log_hód
;

327 
	`nova_dbg_vîbo£
("Log head 0x%llx,Åail 0x%llx\n",

328 
cuº_p
, 
sih
->
log_èû
);

329 i‡(
cuº_p
 =0 && 
sih
->
log_èû
 == 0)

330 
out
;

332 i‡(
cuº_p
 >> 
PAGE_SHIFT
 =
sih
->
log_èû
 >> PAGE_SHIFT)

333 
out
;

335 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, 
sih
, 
blocks
,

336 &
√w_hód
, 
ANY_CPU
, 0);

337 i‡(
Æloˇãd
 !
blocks
) {

338 
	`nova_îr
(
sb
, "%s: ERROR:Ço inodeÜogÖageávailable\n",

339 
__func__
);

340 
out
;

343 
√w_cuº
 = 
√w_hód
;

344 
cuº_p
 !
sih
->
log_èû
) {

345 
ﬁd_cuº_p
 = 
cuº_p
;

346 i‡(
	`gŸo_√xt_∑ge
(
sb
, 
cuº_p
))

347 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

349 i‡(
cuº_p
 >> 
PAGE_SHIFT
 =
sih
->
log_èû
 >> PAGE_SHIFT) {

354 i‡(
cuº_p
 == 0) {

355 
	`nova_îr
(
sb
, "Fûêöodê%ŒuÜog i†NULL!\n", 
öo
);

356 
	`BUG
();

359 
Àngth
 = 0;

360 
ªt
 = 
	`cuº_log_íåy_övÆid
(
sb
, 
pi
, 
sih
, 
cuº_p
, &
Àngth
);

361 i‡(!
ªt
) {

362 
exãnded
 = 0;

363 
√w_cuº
 = 
	`nova_gë_≠≥nd_hód
(
sb
, 
pi
, 
sih
,

364 
√w_cuº
, 
Àngth
, 
MAIN_LOG
,

365 1, &
exãnded
);

366 i‡(
exãnded
)

367 
blocks
++;

369 
	`nova_memu∆ock_block
(
sb
, 
	`nova_gë_block
(sb, 
√w_cuº
), &
úq_Êags
);

370 
	`mem˝y_to_pmem_noˇche
(
	`nova_gë_block
(
sb
, 
√w_cuº
),

371 
	`nova_gë_block
(
sb
, 
cuº_p
), 
Àngth
);

372 
	`nova_öc_∑ge_num_íåõs
(
sb
, 
√w_cuº
);

373 
	`nova_memlock_block
(
sb
, 
	`nova_gë_block
(sb, 
√w_cuº
), &
úq_Êags
);

374 
	`nova_gc_assign_√w_íåy
(
sb
, 
pi
, 
sih
, 
cuº_p
, 
√w_cuº
);

375 
√w_cuº
 +
Àngth
;

378 
cuº_p
 +
Àngth
;

382 
èû_block
 = 
	`BLOCK_OFF
(
sih
->
log_èû
);

383 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
	`nova_gë_block
(
sb
,

384 
	`BLOCK_OFF
(
√w_cuº
));

385 
√xt
 = 
	`√xt_log_∑ge
(
sb
, 
√w_cuº
);

386 i‡(
√xt
 > 0)

387 
	`nova_‰ì_c⁄tiguous_log_blocks
(
sb
, 
sih
, 
√xt
);

389 
	`nova_memu∆ock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

390 
	`nova_£t_√xt_∑ge_Êag
(
sb
, 
√w_cuº
);

391 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
cuº_∑ge
, 
èû_block
, 0);

392 
	`nova_memlock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

395 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

396 
pi
->
log_hód
 = 
√w_hód
;

397 
	`nova_upd©e_öode_checksum
(
pi
);

398 i‡(
mëad©a_csum
 && 
sih
->
Æãr_pi_addr
) {

399 
Æãr_pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
,

400 
sih
->
Æãr_pi_addr
);

401 
	`mem˝y_to_pmem_noˇche
(
Æãr_pi
, 
pi
, (
nova_öode
));

403 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

404 
	`nova_Êush_buf„r
(
pi
, (
nova_öode
), 1);

405 
sih
->
log_hód
 = 
√w_hód
;

408 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
	`nova_gë_block
(
sb
,

409 
	`BLOCK_OFF
(
ﬁd_cuº_p
));

410 
√xt
 = 
	`√xt_log_∑ge
(
sb
, 
ﬁd_cuº_p
);

411 i‡(
√xt
 !
èû_block
) {

412 
	`nova_îr
(
sb
, "OldÜogÉrror: old curr_p 0x%lx,Çext 0x%lx ",

413 "cuº_∞0x%lx,Åaû block 0x%lx\n", 
ﬁd_cuº_p
,

414 
√xt
, 
cuº_p
, 
èû_block
);

415 
	`BUG
();

417 
	`nova_memu∆ock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

418 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
cuº_∑ge
, 0, 1);

419 
	`nova_memlock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

422 
	`nova_‰ì_c⁄tiguous_log_blocks
(
sb
, 
sih
, 
ﬁd_hód
);

424 
sih
->
log_∑ges
 = sih->log_∑ge†+ 
blocks
 - 
checked_∑ges
;

425 
	`NOVA_STATS_ADD
(
th‹ough_gc_∑ges
, 
checked_∑ges
 - 
blocks
);

426 
	`NOVA_STATS_ADD
(
th‹ough_checked_∑ges
, 
checked_∑ges
);

427 
out
:

428 
	`NOVA_END_TIMING
(
th‹ough_gc_t
, 
gc_time
);

429  
blocks
;

430 
	}
}

433 
	$nova_öode_Æãr_log_th‹ough_gc
(
su≥r_block
 *
sb
,

434 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

435 
blocks
, 
checked_∑ges
)

437 
nova_öode_log_∑ge
 *
Æãr_cuº_∑ge
 = 
NULL
;

438 
nova_öode
 *
Æãr_pi
;

439 
u64
 
öo
 = 
pi
->
nova_öo
;

440 
u64
 
cuº_p
, 
√w_cuº
;

441 
u64
 
Æãr_cuº_p
;

442 
u64
 
ﬁd_Æãr_cuº_p
;

443 
u64
 
Æãr_èû_block
;

444 
u64
 
Æãr_ﬁd_hód
;

445 
u64
 
√w_hód
 = 0;

446 
u64
 
Æãr_√xt
;

447 
Æloˇãd
;

448 
úq_Êags
 = 0;

449 
	`INIT_TIMING
(
gc_time
);

451 
	`NOVA_START_TIMING
(
th‹ough_gc_t
, 
gc_time
);

453 
cuº_p
 = 
sih
->
log_hód
;

454 
Æãr_ﬁd_hód
 = 
sih
->
Æãr_log_hód
;

455 
	`nova_dbg_vîbo£
("Log head 0x%llx,Åail 0x%llx\n",

456 
cuº_p
, 
sih
->
log_èû
);

457 i‡(
cuº_p
 =0 && 
sih
->
log_èû
 == 0)

458 
out
;

460 i‡(
cuº_p
 >> 
PAGE_SHIFT
 =
sih
->
log_èû
 >> PAGE_SHIFT)

461 
out
;

463 i‡(
Æãr_ﬁd_hód
 >> 
PAGE_SHIFT
 =
sih
->
Æãr_log_èû
 >> PAGE_SHIFT)

464 
out
;

466 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, 
sih
, 
blocks
,

467 &
√w_hód
, 
ANY_CPU
, 1);

468 i‡(
Æloˇãd
 !
blocks
) {

469 
	`nova_îr
(
sb
, "%s: ERROR:Ço inodeÜogÖageávailable\n",

470 
__func__
);

471 
out
;

474 
√w_cuº
 = 
√w_hód
;

476 
	`nova_memu∆ock_block
(
sb
, 
	`nova_gë_block
(sb, 
√w_cuº
), &
úq_Êags
);

477 
	`mem˝y_to_pmem_noˇche
(
	`nova_gë_block
(
sb
, 
√w_cuº
),

478 
	`nova_gë_block
(
sb
, 
cuº_p
), 
LOG_BLOCK_TAIL
);

480 
	`nova_£t_Æãr_∑ge_addªss
(
sb
, 
cuº_p
, 
√w_cuº
);

481 
	`nova_memlock_block
(
sb
, 
	`nova_gë_block
(sb, 
√w_cuº
), &
úq_Êags
);

483 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

485 i‡(
cuº_p
 >> 
PAGE_SHIFT
 =
sih
->
log_èû
 >> PAGE_SHIFT) {

490 
√w_cuº
 = 
	`√xt_log_∑ge
(
sb
,Çew_curr);

492 i‡(
cuº_p
 == 0) {

493 
	`nova_îr
(
sb
, "Fûêöodê%ŒuÜog i†NULL!\n", 
öo
);

494 
	`BUG
();

499 
Æãr_èû_block
 = 
	`BLOCK_OFF
(
sih
->
Æãr_log_èû
);

500 
Æãr_cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
	`nova_gë_block
(
sb
,

501 
	`BLOCK_OFF
(
√w_cuº
));

502 
Æãr_√xt
 = 
	`√xt_log_∑ge
(
sb
, 
√w_cuº
);

503 i‡(
Æãr_√xt
 > 0)

504 
	`nova_‰ì_c⁄tiguous_log_blocks
(
sb
, 
sih
, 
Æãr_√xt
);

505 
	`nova_memu∆ock_block
(
sb
, 
Æãr_cuº_∑ge
, &
úq_Êags
);

506 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
Æãr_cuº_∑ge
, 
Æãr_èû_block
, 0);

507 
	`nova_memlock_block
(
sb
, 
Æãr_cuº_∑ge
, &
úq_Êags
);

510 
Æãr_cuº_p
 = 
sih
->
Æãr_log_hód
;

512 
ﬁd_Æãr_cuº_p
 = 
Æãr_cuº_p
;

513 
Æãr_cuº_p
 = 
	`√xt_log_∑ge
(
sb
,álter_curr_p);

515 i‡(
Æãr_cuº_p
 >> 
PAGE_SHIFT
 ==

516 
sih
->
Æãr_log_èû
 >> 
PAGE_SHIFT
)

519 i‡(
Æãr_cuº_p
 == 0) {

520 
	`nova_îr
(
sb
, "Fûêöodê%ŒuÜog i†NULL!\n", 
öo
);

521 
	`BUG
();

526 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

527 
pi
->
Æãr_log_hód
 = 
√w_hód
;

528 
	`nova_upd©e_öode_checksum
(
pi
);

529 i‡(
mëad©a_csum
 && 
sih
->
Æãr_pi_addr
) {

530 
Æãr_pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
,

531 
sih
->
Æãr_pi_addr
);

532 
	`mem˝y_to_pmem_noˇche
(
Æãr_pi
, 
pi
, (
nova_öode
));

534 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

535 
	`nova_Êush_buf„r
(
pi
, (
nova_öode
), 1);

536 
sih
->
Æãr_log_hód
 = 
√w_hód
;

539 
Æãr_cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
	`nova_gë_block
(
sb
,

540 
	`BLOCK_OFF
(
ﬁd_Æãr_cuº_p
));

541 
Æãr_√xt
 = 
	`√xt_log_∑ge
(
sb
, 
ﬁd_Æãr_cuº_p
);

542 i‡(
Æãr_√xt
 !
Æãr_èû_block
) {

543 
	`nova_îr
(
sb
, "OldÜogÉrror: old curr_p 0x%lx,Çext 0x%lx ",

544 "cuº_∞0x%lx,Åaû block 0x%lx\n", 
ﬁd_Æãr_cuº_p
,

545 
Æãr_√xt
, 
Æãr_cuº_p
, 
Æãr_èû_block
);

546 
	`BUG
();

548 
	`nova_memu∆ock_block
(
sb
, 
Æãr_cuº_∑ge
, &
úq_Êags
);

549 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
Æãr_cuº_∑ge
, 0, 1);

550 
	`nova_memlock_block
(
sb
, 
Æãr_cuº_∑ge
, &
úq_Êags
);

553 
	`nova_‰ì_c⁄tiguous_log_blocks
(
sb
, 
sih
, 
Æãr_ﬁd_hód
);

555 
sih
->
log_∑ges
 = sih->log_∑ge†+ 
blocks
 - 
checked_∑ges
;

556 
	`NOVA_STATS_ADD
(
th‹ough_gc_∑ges
, 
checked_∑ges
 - 
blocks
);

557 
	`NOVA_STATS_ADD
(
th‹ough_checked_∑ges
, 
checked_∑ges
);

558 
out
:

559 
	`NOVA_END_TIMING
(
th‹ough_gc_t
, 
gc_time
);

560  
blocks
;

561 
	}
}

566 
	$nova_öode_log_Á°_gc
(
su≥r_block
 *
sb
,

567 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

568 
u64
 
cuº_èû
, u64 
√w_block
, u64 
Æãr_√w_block
,

569 
num_∑ges
, 
f‹˚_th‹ough
)

571 
nova_öode
 *
Æãr_pi
;

572 
u64
 
cuº
, 
√xt
, 
possibÀ_hód
 = 0;

573 
u64
 
Æãr_cuº
, 
Æãr_√xt
 = 0, 
Æãr_possibÀ_hód
 = 0;

574 
found_hód
 = 0;

575 
nova_öode_log_∑ge
 *
œ°_∑ge
 = 
NULL
;

576 
nova_öode_log_∑ge
 *
cuº_∑ge
 = 
NULL
;

577 
nova_öode_log_∑ge
 *
Æãr_œ°_∑ge
 = 
NULL
;

578 
nova_öode_log_∑ge
 *
Æãr_cuº_∑ge
 = 
NULL
;

579 
fú°_√ed_‰ì
 = 0;

580 
num_logs
;

581 
u8
 
bty≥
 = 
sih
->
i_blk_ty≥
;

582 
blocks
;

583 
checked_∑ges
 = 0;

584 
‰ìd_∑ges
 = 0;

585 
úq_Êags
 = 0;

586 
	`INIT_TIMING
(
gc_time
);

588 
	`NOVA_START_TIMING
(
Á°_gc_t
, 
gc_time
);

589 
cuº
 = 
sih
->
log_hód
;

590 
Æãr_cuº
 = 
sih
->
Æãr_log_hód
;

591 
sih
->
vÆid_íåõs
 = 0;

592 
sih
->
num_íåõs
 = 0;

594 
num_logs
 = 1;

595 i‡(
mëad©a_csum
)

596 
num_logs
 = 2;

598 
	`nova_dbgv
("%s:Üog head 0x%llx,Åail 0x%llx\n",

599 
__func__
, 
cuº
, 
cuº_èû
);

601 i‡(
cuº
 >> 
PAGE_SHIFT
 =
sih
->
log_èû
 >> PAGE_SHIFT) {

603 i‡(
found_hód
 == 0) {

604 
possibÀ_hód
 = 
	`˝u_to_À64
(
cuº
);

605 
Æãr_possibÀ_hód
 = 
	`˝u_to_À64
(
Æãr_cuº
);

610 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)

611 
	`nova_gë_block
(
sb
, 
cuº
);

612 
√xt
 = 
	`√xt_log_∑ge
(
sb
, 
cuº
);

613 i‡(
√xt
 < 0)

616 i‡(
mëad©a_csum
) {

617 
Æãr_cuº_∑ge
 = (
nova_öode_log_∑ge
 *)

618 
	`nova_gë_block
(
sb
, 
Æãr_cuº
);

619 
Æãr_√xt
 = 
	`√xt_log_∑ge
(
sb
, 
Æãr_cuº
);

620 i‡(
Æãr_√xt
 < 0)

623 
	`nova_dbg_vîbo£
("cuº 0x%Œx,Çexà0x%Œx\n", 
cuº
, 
√xt
);

624 i‡(
	`cuº_∑ge_övÆid
(
sb
, 
pi
, 
sih
, 
cuº
)) {

625 
	`nova_dbg_vîbo£
("cuºÖagê%∞övÆid\n", 
cuº_∑ge
);

626 i‡(
cuº
 =
sih
->
log_hód
) {

628 
fú°_√ed_‰ì
 = 1;

629 
œ°_∑ge
 = 
cuº_∑ge
;

630 
Æãr_œ°_∑ge
 = 
Æãr_cuº_∑ge
;

632 
	`nova_dbg_vîbo£
("FreeÜog block 0x%llx\n",

633 
cuº
 >> 
PAGE_SHIFT
);

634 
	`‰ì_cuº_∑ge
(
sb
, 
sih
, 
cuº_∑ge
, 
œ°_∑ge
,

635 
cuº
);

636 i‡(
mëad©a_csum
)

637 
	`‰ì_cuº_∑ge
(
sb
, 
sih
, 
Æãr_cuº_∑ge
,

638 
Æãr_œ°_∑ge
, 
Æãr_cuº
);

640 
	`NOVA_STATS_ADD
(
Á°_gc_∑ges
, 1);

641 
‰ìd_∑ges
++;

643 i‡(
found_hód
 == 0) {

644 
possibÀ_hód
 = 
	`˝u_to_À64
(
cuº
);

645 
Æãr_possibÀ_hód
 = 
	`˝u_to_À64
(
Æãr_cuº
);

646 
found_hód
 = 1;

648 
œ°_∑ge
 = 
cuº_∑ge
;

649 
Æãr_œ°_∑ge
 = 
Æãr_cuº_∑ge
;

652 
cuº
 = 
√xt
;

653 
Æãr_cuº
 = 
Æãr_√xt
;

654 
checked_∑ges
++;

655 i‡(
cuº
 =0 || (
mëad©a_csum
 && 
Æãr_cuº
 == 0))

659 
	`NOVA_STATS_ADD
(
Á°_checked_∑ges
, 
checked_∑ges
);

660 
	`nova_dbgv
("checkedÖage†%lu, fªed %d\n", 
checked_∑ges
, 
‰ìd_∑ges
);

661 
checked_∑ges
 -
‰ìd_∑ges
;

664 i‡(
num_∑ges
 > 0) {

665 
cuº
 = 
	`BLOCK_OFF
(
cuº_èû
);

666 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)

667 
	`nova_gë_block
(
sb
, 
cuº
);

669 
	`nova_memu∆ock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

670 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
cuº_∑ge
, 
√w_block
, 1);

671 
	`nova_memlock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

673 i‡(
mëad©a_csum
) {

674 
Æãr_cuº
 = 
	`BLOCK_OFF
(
sih
->
Æãr_log_èû
);

676 
	`√xt_log_∑ge
(
sb
, 
Æãr_cuº
) > 0)

677 
Æãr_cuº
 = 
	`√xt_log_∑ge
(
sb
,álter_curr);

679 
Æãr_cuº_∑ge
 = (
nova_öode_log_∑ge
 *)

680 
	`nova_gë_block
(
sb
, 
Æãr_cuº
);

681 
	`nova_memu∆ock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

682 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
Æãr_cuº_∑ge
,

683 
Æãr_√w_block
, 1);

684 
	`nova_memlock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

688 
cuº
 = 
sih
->
log_hód
;

689 
Æãr_cuº
 = 
sih
->
Æãr_log_hód
;

691 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

692 
pi
->
log_hód
 = 
possibÀ_hód
;

693 
pi
->
Æãr_log_hód
 = 
Æãr_possibÀ_hód
;

694 
	`nova_upd©e_öode_checksum
(
pi
);

695 i‡(
mëad©a_csum
 && 
sih
->
Æãr_pi_addr
) {

696 
Æãr_pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
,

697 
sih
->
Æãr_pi_addr
);

698 
	`mem˝y_to_pmem_noˇche
(
Æãr_pi
, 
pi
, (
nova_öode
));

700 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

701 
sih
->
log_hód
 = 
possibÀ_hód
;

702 
sih
->
Æãr_log_hód
 = 
Æãr_possibÀ_hód
;

703 
	`nova_dbgv
("%s: %dÇew hód 0x%Œx\n", 
__func__
,

704 
found_hód
, 
possibÀ_hód
);

705 
sih
->
log_∑ges
 +(
num_∑ges
 - 
‰ìd_∑ges
Ë* 
num_logs
;

707 
	`nova_Êush_buf„r
(&
pi
->
log_hód
, 
CACHELINE_SIZE
, 1);

709 i‡(
fú°_√ed_‰ì
) {

710 
	`nova_dbg_vîbo£
("FreeÜog head block 0x%llx\n",

711 
cuº
 >> 
PAGE_SHIFT
);

712 
	`nova_‰ì_log_blocks
(
sb
, 
sih
,

713 
	`nova_gë_blockƒ
(
sb
, 
cuº
, 
bty≥
), 1);

714 i‡(
mëad©a_csum
)

715 
	`nova_‰ì_log_blocks
(
sb
, 
sih
,

716 
	`nova_gë_blockƒ
(
sb
, 
Æãr_cuº
, 
bty≥
), 1);

719 
	`NOVA_END_TIMING
(
Á°_gc_t
, 
gc_time
);

721 i‡(
sih
->
num_íåõs
 == 0)

729 
blocks
 = (
sih
->
vÆid_íåõs
 * 
checked_∑ges
Ë/ sih->
num_íåõs
;

730 i‡((
sih
->
vÆid_íåõs
 * 
checked_∑ges
Ë% sih->
num_íåõs
)

731 
blocks
++;

733 i‡(
f‹˚_th‹ough
 || (
blocks
 && block†* 2 < 
checked_∑ges
)) {

734 
	`nova_dbgv
("Thorough GC for inode %lu: checkedÖages %lu, validÖages %lu\n",

735 
sih
->
öo
,

736 
checked_∑ges
, 
blocks
);

737 
blocks
 = 
	`nova_öode_log_th‹ough_gc
(
sb
, 
pi
, 
sih
,

738 
blocks
, 
checked_∑ges
);

739 i‡(
mëad©a_csum
)

740 
	`nova_öode_Æãr_log_th‹ough_gc
(
sb
, 
pi
, 
sih
,

741 
blocks
, 
checked_∑ges
);

745 
	}
}

	@inode.c

18 
	~<löux/fs.h
>

19 
	~<löux/aio.h
>

20 
	~<löux/highuid.h
>

21 
	~<löux/moduÀ.h
>

22 
	~<löux/m∑ge.h
>

23 
	~<löux/backög-dev.h
>

24 
	~<löux/ty≥s.h
>

25 
	~<löux/øãlimô.h
>

26 
	~"nova.h
"

27 
	~"öode.h
"

29 
	gblk_ty≥_to_shi·
[
NOVA_BLOCK_TYPE_MAX
] = {12, 21, 30};

30 
uöt32_t
 
	gblk_ty≥_to_size
[
NOVA_BLOCK_TYPE_MAX
] = {0x1000, 0x200000, 0x40000000};

32 
	$nova_öô_öode_öu£_li°
(
su≥r_block
 *
sb
)

34 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

35 
nova_ønge_node
 *
ønge_node
;

36 
öode_m≠
 *inode_map;

37 
ønge_high
;

38 
i
;

39 
ªt
;

41 
sbi
->
s_öodes_u£d_cou¡
 = 
NOVA_NORMAL_INODE_START
;

43 
ønge_high
 = 
NOVA_NORMAL_INODE_START
 / 
sbi
->
˝us
;

44 i‡(
NOVA_NORMAL_INODE_START
 % 
sbi
->
˝us
)

45 
ønge_high
++;

47 
i
 = 0; i < 
sbi
->
˝us
; i++) {

48 
öode_m≠
 = &
sbi
->
öode_m≠s
[
i
];

49 
ønge_node
 = 
	`nova_Æloc_öode_node
(
sb
);

50 i‡(
ønge_node
 =
NULL
)

52  -
ENOMEM
;

54 
ønge_node
->
ønge_low
 = 0;

55 
ønge_node
->
ønge_high
 =Ñange_high;

56 
	`nova_upd©e_ønge_node_checksum
(
ønge_node
);

57 
ªt
 = 
	`nova_ö£π_öodëªe
(
sbi
, 
ønge_node
, 
i
);

58 i‡(
ªt
) {

59 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

60 
	`nova_‰ì_öode_node
(
ønge_node
);

61  
ªt
;

63 
öode_m≠
->
num_ønge_node_öode
 = 1;

64 
öode_m≠
->
fú°_öode_ønge
 = 
ønge_node
;

68 
	}
}

70 
	$nova_Æloc_öode_èbÀ
(
su≥r_block
 *
sb
,

71 
nova_öode_öfo_hódî
 *
sih
, 
vîsi⁄
)

73 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

74 
öode_èbÀ
 *inode_table;

75 
blockƒ
;

76 
u64
 
block
;

77 
Æloˇãd
;

78 
i
;

79 
úq_Êags
 = 0;

81 
i
 = 0; i < 
sbi
->
˝us
; i++) {

82 
öode_èbÀ
 = 
	`nova_gë_öode_èbÀ
(
sb
, 
vîsi⁄
, 
i
);

83 i‡(!
öode_èbÀ
)

84  -
EINVAL
;

87 
Æloˇãd
 = 
	`nova_√w_log_blocks
(
sb
, 
sih
, &
blockƒ
, 1,

88 
ALLOC_INIT_ZERO
, 
i
,

89 
vîsi⁄
 ? 
ALLOC_FROM_TAIL
 : 
ALLOC_FROM_HEAD
);

91 
	`nova_dbgv
("%s:áŒoˇãÜog @ 0x%lx\n", 
__func__
,

92 
blockƒ
);

93 i‡(
Æloˇãd
 !1 || 
blockƒ
 == 0)

94  -
ENOSPC
;

96 
block
 = 
	`nova_gë_block_off
(
sb
, 
blockƒ
, 
NOVA_BLOCK_TYPE_2M
);

97 
	`nova_memu∆ock_ønge
(
sb
, 
öode_èbÀ
, 
CACHELINE_SIZE
, &
úq_Êags
);

98 
öode_èbÀ
->
log_hód
 = 
block
;

99 
	`nova_memlock_ønge
(
sb
, 
öode_èbÀ
, 
CACHELINE_SIZE
, &
úq_Êags
);

100 
	`nova_Êush_buf„r
(
öode_èbÀ
, 
CACHELINE_SIZE
, 0);

104 
	}
}

106 
	$nova_öô_öode_èbÀ
(
su≥r_block
 *
sb
)

108 
nova_öode
 *
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_INODETABLE_INO
);

109 
nova_öode_öfo_hódî
 
sih
;

110 
num_èbÀs
;

111 
ªt
 = 0;

112 
i
;

113 
úq_Êags
 = 0;

115 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

116 
pi
->
i_mode
 = 0;

117 
pi
->
i_uid
 = 0;

118 
pi
->
i_gid
 = 0;

119 
pi
->
i_löks_cou¡
 = 
	`˝u_to_À16
(1);

120 
pi
->
i_Êags
 = 0;

121 
pi
->
nova_öo
 = 
NOVA_INODETABLE_INO
;

123 
pi
->
i_blk_ty≥
 = 
NOVA_BLOCK_TYPE_2M
;

124 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

126 
sih
.
öo
 = 
NOVA_INODETABLE_INO
;

127 
sih
.
i_blk_ty≥
 = 
NOVA_BLOCK_TYPE_2M
;

129 
num_èbÀs
 = 1;

130 i‡(
mëad©a_csum
)

131 
num_èbÀs
 = 2;

133 
i
 = 0; i < 
num_èbÀs
; i++) {

134 
ªt
 = 
	`nova_Æloc_öode_èbÀ
(
sb
, &
sih
, 
i
);

135 i‡(
ªt
)

136  
ªt
;

139 
	`PERSISTENT_BARRIER
();

140  
ªt
;

141 
	}
}

143 
ölöe
 
	$nova_ö£π_öodëªe
(
nova_sb_öfo
 *
sbi
,

144 
nova_ønge_node
 *
√w_node
, 
˝u
)

146 
rb_roŸ
 *
åì
;

147 
ªt
;

149 
åì
 = &
sbi
->
öode_m≠s
[
˝u
].
öode_öu£_åì
;

150 
ªt
 = 
	`nova_ö£π_ønge_node
(
åì
, 
√w_node
, 
NODE_INODE
);

151 i‡(
ªt
)

152 
	`nova_dbg
("ERROR: %†Áûed %d\n", 
__func__
, 
ªt
);

154  
ªt
;

155 
	}
}

157 
ölöe
 
	$nova_£¨ch_öodëªe
(
nova_sb_öfo
 *
sbi
,

158 
öo
, 
nova_ønge_node
 **
ªt_node
)

160 
rb_roŸ
 *
åì
;

161 
öã∫Æ_öo
;

162 
˝u
;

164 
˝u
 = 
öo
 % 
sbi
->
˝us
;

165 
åì
 = &
sbi
->
öode_m≠s
[
˝u
].
öode_öu£_åì
;

166 
öã∫Æ_öo
 = 
öo
 / 
sbi
->
˝us
;

167  
	`nova_föd_ønge_node
(
åì
, 
öã∫Æ_öo
,

168 
NODE_INODE
, 
ªt_node
);

169 
	}
}

174 
	$nova_gë_öode_addªss
(
su≥r_block
 *
sb
, 
u64
 
öo
, 
vîsi⁄
,

175 
u64
 *
pi_addr
, 
exãndabÀ
, 
exãnd_Æã∫©e
)

177 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

178 
nova_öode_öfo_hódî
 
sih
;

179 
öode_èbÀ
 *inode_table;

180 
d©a_bôs
;

181 
num_öodes_bôs
;

182 
u64
 
cuº
;

183 
su≥Ωage_cou¡
;

184 
u64
 
Æã∫©e_pi_addr
 = 0;

185 
u64
 
öã∫Æ_öo
;

186 
˝uid
;

187 
exãnded
 = 0;

188 
ödex
;

189 
i
 = 0;

190 
blockƒ
;

191 
cuº_addr
;

192 
Æloˇãd
;

193 
úq_Êags
 = 0;

195 i‡(
öo
 < 
NOVA_NORMAL_INODE_START
) {

196 *
pi_addr
 = 
	`nova_gë_ª£rved_öode_addr
(
sb
, 
öo
);

200 
sih
.
öo
 = 
NOVA_INODETABLE_INO
;

201 
sih
.
i_blk_ty≥
 = 
NOVA_BLOCK_TYPE_2M
;

202 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
sih
.
i_blk_ty≥
];

203 
num_öodes_bôs
 = 
d©a_bôs
 - 
NOVA_INODE_BITS
;

205 
˝uid
 = 
öo
 % 
sbi
->
˝us
;

206 
öã∫Æ_öo
 = 
öo
 / 
sbi
->
˝us
;

208 
öode_èbÀ
 = 
	`nova_gë_öode_èbÀ
(
sb
, 
vîsi⁄
, 
˝uid
);

209 
su≥Ωage_cou¡
 = 
öã∫Æ_öo
 >> 
num_öodes_bôs
;

210 
ödex
 = 
öã∫Æ_öo
 & ((1 << 
num_öodes_bôs
) - 1);

212 
cuº
 = 
öode_èbÀ
->
log_hód
;

213 i‡(
cuº
 == 0)

214  -
EINVAL
;

216 
i
 = 0; i < 
su≥Ωage_cou¡
; i++) {

217 i‡(
cuº
 == 0)

218  -
EINVAL
;

220 
cuº_addr
 = ()
	`nova_gë_block
(
sb
, 
cuº
);

222 
cuº_addr
 +
	`nova_öode_blk_size
(&
sih
) - 8;

223 
cuº
 = *(
u64
 *)(
cuº_addr
);

225 i‡(
cuº
 == 0) {

226 i‡(
exãndabÀ
 == 0)

227  -
EINVAL
;

229 
exãnded
 = 1;

231 
Æloˇãd
 = 
	`nova_√w_log_blocks
(
sb
, &
sih
, &
blockƒ
,

232 1, 
ALLOC_INIT_ZERO
, 
˝uid
,

233 
vîsi⁄
 ? 
ALLOC_FROM_TAIL
 : 
ALLOC_FROM_HEAD
);

235 i‡(
Æloˇãd
 != 1)

236  
Æloˇãd
;

238 
cuº
 = 
	`nova_gë_block_off
(
sb
, 
blockƒ
,

239 
NOVA_BLOCK_TYPE_2M
);

240 
	`nova_memu∆ock_ønge
(
sb
, (*)
cuº_addr
,

241 
CACHELINE_SIZE
, &
úq_Êags
);

242 *(
u64
 *)(
cuº_addr
Ë
cuº
;

243 
	`nova_memlock_ønge
(
sb
, (*)
cuº_addr
,

244 
CACHELINE_SIZE
, &
úq_Êags
);

245 
	`nova_Êush_buf„r
((*)
cuº_addr
,

246 
NOVA_INODE_SIZE
, 1);

251 i‡(
exãnded
 && 
exãnd_Æã∫©e
 && 
mëad©a_csum
)

252 
	`nova_gë_öode_addªss
(
sb
, 
öo
, 
vîsi⁄
 + 1,

253 &
Æã∫©e_pi_addr
, 
exãndabÀ
, 0);

255 *
pi_addr
 = 
cuº
 + 
ödex
 * 
NOVA_INODE_SIZE
;

258 
	}
}

260 
	$nova_gë_Æãr_öode_addªss
(
su≥r_block
 *
sb
, 
u64
 
öo
,

261 
u64
 *
Æãr_pi_addr
)

263 
ªt
;

265 i‡(
mëad©a_csum
 == 0) {

266 
	`nova_îr
(
sb
, "Accessálter inode whenÑeplica inode disabled\n");

270 i‡(
öo
 < 
NOVA_NORMAL_INODE_START
) {

271 *
Æãr_pi_addr
 = 
	`nova_gë_Æãr_ª£rved_öode_addr
(
sb
, 
öo
);

273 
ªt
 = 
	`nova_gë_öode_addªss
(
sb
, 
öo
, 1, 
Æãr_pi_addr
, 0, 0);

274 i‡(
ªt
)

275  
ªt
;

279 
	}
}

281 
	$nova_dñëe_fûe_åì
(
su≥r_block
 *
sb
,

282 
nova_öode_öfo_hódî
 *
sih
, 
°¨t_blockƒ
,

283 
œ°_blockƒ
, 
boﬁ
 
dñëe_nvmm
, boﬁ 
dñëe_dód
,

284 
u64
 
ïoch_id
)

286 
nova_fûe_wrôe_íåy
 *
íåy
;

287 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

288 
nova_fûe_wrôe_íåy
 *
ﬁd_íåy
 = 
NULL
;

289 
pgoff
 = 
°¨t_blockƒ
;

290 
ﬁd_pgoff
 = 0;

291 
num_‰ì
 = 0;

292 
‰ìd
 = 0;

293 *
ªt
;

294 
	`INIT_TIMING
(
dñëe_time
);

296 
	`NOVA_START_TIMING
(
dñëe_fûe_åì_t
, 
dñëe_time
);

298 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

302 
íåy
 = 
	`ødix_åì_lookup
(&
sih
->
åì
, 
pgoff
);

303 i‡(
íåy
) {

304 
ªt
 = 
	`ødix_åì_dñëe
(&
sih
->
åì
, 
pgoff
);

305 
	`BUG_ON
(!
ªt
 ||Ñë !
íåy
);

306 i‡(
íåy
 !
ﬁd_íåy
) {

307 i‡(
ﬁd_íåy
 && 
dñëe_nvmm
) {

308 
	`nova_‰ì_ﬁd_íåy
(
sb
, 
sih
,

309 
ﬁd_íåy
, 
ﬁd_pgoff
,

310 
num_‰ì
, 
dñëe_dód
,

311 
ïoch_id
);

312 
‰ìd
 +
num_‰ì
;

315 
ﬁd_íåy
 = 
íåy
;

316 
ﬁd_pgoff
 = 
pgoff
;

317 
num_‰ì
 = 1;

319 
num_‰ì
++;

321 
pgoff
++;

324 
íåy
 = 
	`nova_föd_√xt_íåy
(
sb
, 
sih
, 
pgoff
);

325 i‡(!
íåy
)

328 i‡(
mëad©a_csum
 == 0)

329 
íåyc
 = 
íåy
;

330 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

333 
pgoff
++;

334 
pgoff
 =Ögof‡> 
íåyc
->pgoff ?Ögoff :Éntryc->pgoff;

338 i‡(
ﬁd_íåy
 && 
dñëe_nvmm
) {

339 
	`nova_‰ì_ﬁd_íåy
(
sb
, 
sih
, 
ﬁd_íåy
, 
ﬁd_pgoff
,

340 
num_‰ì
, 
dñëe_dód
, 
ïoch_id
);

341 
‰ìd
 +
num_‰ì
;

344 
	`nova_dbgv
("Inode %lu: delete fileÅree fromÖgoff %luÅo %lu, %d blocks freed\n",

345 
sih
->
öo
, 
°¨t_blockƒ
, 
œ°_blockƒ
, 
‰ìd
);

347 
	`NOVA_END_TIMING
(
dñëe_fûe_åì_t
, 
dñëe_time
);

348  
‰ìd
;

349 
	}
}

351 
	$nova_‰ì_døm_ªsour˚
(
su≥r_block
 *
sb
,

352 
nova_öode_öfo_hódî
 *
sih
)

354 
œ°_blockƒ
;

355 
‰ìd
 = 0;

357 i‡(
sih
->
öo
 == 0)

360 i‡(!(
	`S_ISREG
(
sih
->
i_mode
)Ë&& !(
	`S_ISDIR
(sih->i_mode)))

363 i‡(
	`S_ISREG
(
sih
->
i_mode
)) {

364 
œ°_blockƒ
 = 
	`nova_gë_œ°_blockƒ
(
sb
, 
sih
);

365 
‰ìd
 = 
	`nova_dñëe_fûe_åì
(
sb
, 
sih
, 0,

366 
œ°_blockƒ
, 
Ál£
, false, 0);

368 
	`nova_dñëe_dú_åì
(
sb
, 
sih
);

369 
‰ìd
 = 1;

372  
‰ìd
;

373 
	}
}

375 
ölöe
 
	$check_eof_blocks
(
su≥r_block
 *
sb
,

376 
nova_öode
 *
pi
, 
öode
 *inode,

377 
nova_öode_öfo_hódî
 *
sih
)

379 
úq_Êags
 = 0;

380 i‡((
pi
->
i_Êags
 & 
	`˝u_to_À32
(
NOVA_EOFBLOCKS_FL
)) &&

381 (
öode
->
i_size
 + 
sb
->
s_blocksize
Ë> (
sih
->
i_blocks


382 << 
sb
->
s_blocksize_bôs
)) {

383 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

384 
pi
->
i_Êags
 &
	`˝u_to_À32
(~
NOVA_EOFBLOCKS_FL
);

385 
	`nova_upd©e_öode_checksum
(
pi
);

386 
	`nova_upd©e_Æãr_öode
(
sb
, 
öode
, 
pi
);

387 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

389 
	}
}

394 
	$nova_åunˇã_fûe_blocks
(
öode
 *öode, 
loff_t
 
°¨t
,

395 
loff_t
 
íd
, 
u64
 
ïoch_id
)

397 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

398 
nova_öode
 *
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

399 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

400 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

401 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
sih
->
i_blk_ty≥
];

402 
fú°_blockƒ
, 
œ°_blockƒ
;

403 
‰ìd
 = 0;

406 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

408 
	`nova_dbg_vîbo£
("åunˇã:Öò%∞iblock†%lx %Œx %Œx %Œx\n", 
pi
,

409 
sih
->
i_blocks
, 
°¨t
, 
íd
, 
pi
->
i_size
);

411 
fú°_blockƒ
 = (
°¨t
 + (1UL << 
d©a_bôs
) - 1) >> data_bits;

413 i‡(
íd
 == 0)

415 
œ°_blockƒ
 = (
íd
 - 1Ë>> 
d©a_bôs
;

417 i‡(
fú°_blockƒ
 > 
œ°_blockƒ
)

420 
‰ìd
 = 
	`nova_dñëe_fûe_åì
(
sb
, 
sih
, 
fú°_blockƒ
,

421 
œ°_blockƒ
, 
åue
, 
Ál£
, 
ïoch_id
);

423 
öode
->
i_blocks
 -(
‰ìd
 * (1 << (
d©a_bôs
 -

424 
sb
->
s_blocksize_bôs
)));

426 
sih
->
i_blocks
 = 
öode
->i_blocks;

428 
	`check_eof_blocks
(
sb
, 
pi
, 
öode
, 
sih
);

430 
	}
}

441 
	$nova_lookup_hﬁe_ö_ønge
(
su≥r_block
 *
sb
,

442 
nova_öode_öfo_hódî
 *
sih
,

443 
fú°_blockƒ
, 
œ°_blockƒ
,

444 *
d©a_found
, *
hﬁe_found
, 
hﬁe
)

446 
nova_fûe_wrôe_íåy
 *
íåy
;

447 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

448 
blocks
 = 0;

449 
pgoff
, 
ﬁd_pgoff
;

451 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

453 
pgoff
 = 
fú°_blockƒ
;

454 
pgoff
 <
œ°_blockƒ
) {

455 
ﬁd_pgoff
 = 
pgoff
;

456 
íåy
 = 
	`ødix_åì_lookup
(&
sih
->
åì
, 
pgoff
);

457 i‡(
íåy
) {

458 *
d©a_found
 = 1;

459 i‡(!
hﬁe
)

460 
d⁄e
;

461 
pgoff
++;

463 *
hﬁe_found
 = 1;

464 
íåy
 = 
	`nova_föd_√xt_íåy
(
sb
, 
sih
, 
pgoff
);

465 
pgoff
++;

466 i‡(
íåy
) {

467 i‡(
mëad©a_csum
 == 0)

468 
íåyc
 = 
íåy
;

469 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
,

470 
íåyc
))

471 
d⁄e
;

473 
pgoff
 =Ögof‡> 
íåyc
->pgoff ?

474 
pgoff
 : 
íåyc
->pgoff;

475 i‡(
pgoff
 > 
œ°_blockƒ
)

476 
pgoff
 = 
œ°_blockƒ
 + 1;

480 i‡(!*
hﬁe_found
 || !
hﬁe
)

481 
blocks
 +
pgoff
 - 
ﬁd_pgoff
;

483 
d⁄e
:

484  
blocks
;

485 
	}
}

488 
	$nova_ªad_öode
(
su≥r_block
 *
sb
, 
öode
 *inode,

489 
u64
 
pi_addr
)

491 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

492 
nova_öode
 *
pi
, 
Áke_pi
;

493 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

494 
ªt
 = -
EIO
;

495 
öo
;

497 
ªt
 = 
	`nova_gë_ª„ªn˚
(
sb
, 
pi_addr
, &
Áke_pi
,

498 (**)&
pi
, (
nova_öode
));

499 i‡(
ªt
) {

500 
	`nova_dbg
("%s:ÑeadÖi @ 0x%llx failed\n",

501 
__func__
, 
pi_addr
);

502 
bad_öode
;

505 
öode
->
i_mode
 = 
sih
->i_mode;

506 
	`i_uid_wrôe
(
öode
, 
	`À32_to_˝u
(
pi
->
i_uid
));

507 
	`i_gid_wrôe
(
öode
, 
	`À32_to_˝u
(
pi
->
i_gid
));

509 
öode
->
i_gíî©i⁄
 = 
	`À32_to_˝u
(
pi
->i_generation);

510 
	`nova_£t_öode_Êags
(
öode
, 
pi
, 
	`À32_to_˝u
’i->
i_Êags
));

511 
öo
 = 
öode
->
i_öo
;

514 i‡(
öode
->
i_mode
 =0 || 
pi
->
dñëed
 == 1) {

516 
ªt
 = -
ESTALE
;

517 
bad_öode
;

520 
öode
->
i_blocks
 = 
sih
->i_blocks;

521 
öode
->
i_m≠pög
->
a_›s
 = &
nova_a›s_dax
;

523 
öode
->
i_mode
 & 
S_IFMT
) {

524 
S_IFREG
:

525 
öode
->
i_›
 = &
nova_fûe_öode_›î©i⁄s
;

526 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DATA_COW
Ë&& 
w¥Ÿe˘
 == 0)

527 
öode
->
i_f›
 = &
nova_dax_fûe_›î©i⁄s
;

529 
öode
->
i_f›
 = &
nova_wøp_fûe_›î©i⁄s
;

531 
S_IFDIR
:

532 
öode
->
i_›
 = &
nova_dú_öode_›î©i⁄s
;

533 
öode
->
i_f›
 = &
nova_dú_›î©i⁄s
;

535 
S_IFLNK
:

536 
öode
->
i_›
 = &
nova_symlök_öode_›î©i⁄s
;

539 
öode
->
i_›
 = &
nova_•ecül_öode_›î©i⁄s
;

540 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

541 
	`À32_to_˝u
(
pi
->
dev
.
rdev
));

546 
öode
->
i_size
 = 
	`À64_to_˝u
(
sih
->i_size);

547 
öode
->
i_©ime
.
tv_£c
 = (
__s32
)
	`À32_to_˝u
(
pi
->i_atime);

549 
	`öode_£t_˘ime
(
öode
, (
__s32
)
	`À32_to_˝u
(
pi
->
i_˘ime
), 0);

551 
öode
->
i_mtime
.
tv_£c
 = (
__s32
)
	`À32_to_˝u
(
pi
->i_mtime);

554 
öode
->
i_©ime
.
tv_n£c
 = inode->
i_mtime
.tv_nsec = 0;

555 
	`£t_∆ök
(
öode
, 
	`À16_to_˝u
(
pi
->
i_löks_cou¡
));

558 
bad_öode
:

559 
	`make_bad_öode
(
öode
);

560  
ªt
;

561 
	}
}

563 
	$nova_gë_öode_Êags
(
öode
 *öode, 
nova_öode
 *
pi
)

565 
Êags
 = 
öode
->
i_Êags
;

566 
nova_Êags
 = 
	`À32_to_˝u
(
pi
->
i_Êags
);

568 
nova_Êags
 &~(
FS_SYNC_FL
 | 
FS_APPEND_FL
 | 
FS_IMMUTABLE_FL
 |

569 
FS_NOATIME_FL
 | 
FS_DIRSYNC_FL
);

570 i‡(
Êags
 & 
S_SYNC
)

571 
nova_Êags
 |
FS_SYNC_FL
;

572 i‡(
Êags
 & 
S_APPEND
)

573 
nova_Êags
 |
FS_APPEND_FL
;

574 i‡(
Êags
 & 
S_IMMUTABLE
)

575 
nova_Êags
 |
FS_IMMUTABLE_FL
;

576 i‡(
Êags
 & 
S_NOATIME
)

577 
nova_Êags
 |
FS_NOATIME_FL
;

578 i‡(
Êags
 & 
S_DIRSYNC
)

579 
nova_Êags
 |
FS_DIRSYNC_FL
;

581 
pi
->
i_Êags
 = 
	`˝u_to_À32
(
nova_Êags
);

582 
	}
}

584 
	$nova_öô_öode
(
öode
 *öode, 
nova_öode
 *
pi
)

586 
pi
->
i_mode
 = 
	`˝u_to_À16
(
öode
->i_mode);

587 
pi
->
i_uid
 = 
	`˝u_to_À32
(
	`i_uid_ªad
(
öode
));

588 
pi
->
i_gid
 = 
	`˝u_to_À32
(
	`i_gid_ªad
(
öode
));

589 
pi
->
i_löks_cou¡
 = 
	`˝u_to_À16
(
öode
->
i_∆ök
);

590 
pi
->
i_size
 = 
	`˝u_to_À64
(
öode
->i_size);

591 
pi
->
i_©ime
 = 
	`˝u_to_À32
(
öode
->i_©ime.
tv_£c
);

593 
pi
->
i_˘ime
 = 
	`˝u_to_À32
(
	`öode_gë_˘ime_£c
(
öode
));

594 
pi
->
i_mtime
 = 
	`˝u_to_À32
(
öode
->i_mtime.
tv_£c
);

595 
pi
->
i_gíî©i⁄
 = 
	`˝u_to_À32
(
öode
->i_generation);

596 
pi
->
log_hód
 = 0;

597 
pi
->
log_èû
 = 0;

598 
pi
->
Æãr_log_hód
 = 0;

599 
pi
->
Æãr_log_èû
 = 0;

600 
pi
->
dñëed
 = 0;

601 
pi
->
dñëe_ïoch_id
 = 0;

602 
	`nova_gë_öode_Êags
(
öode
, 
pi
);

604 i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode))

605 
pi
->
dev
.
rdev
 = 
	`˝u_to_À32
(
öode
->
i_rdev
);

606 
	}
}

608 
	$nova_Æloc_unu£d_öode
(
su≥r_block
 *
sb
, 
˝uid
,

609 *
öo
)

611 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

612 
öode_m≠
 *inode_map;

613 
nova_ønge_node
 *
i
, *
√xt_i
;

614 
rb_node
 *
ãmp
, *
√xt
;

615 
√xt_ønge_low
;

616 
√w_öo
;

617 
MAX_INODE
 = 1UL << 31;

619 
öode_m≠
 = &
sbi
->
öode_m≠s
[
˝uid
];

620 
i
 = 
öode_m≠
->
fú°_öode_ønge
;

621 
	`NOVA_ASSERT
(
i
);

622 i‡(!
	`nova_ønge_node_checksum_ok
(
i
)) {

623 
	`nova_dbg
("%s: fú°ÇodêÁûed\n", 
__func__
);

624  -
EIO
;

627 
ãmp
 = &
i
->
node
;

628 
√xt
 = 
	`rb_√xt
(
ãmp
);

630 i‡(!
√xt
) {

631 
√xt_i
 = 
NULL
;

632 
√xt_ønge_low
 = 
MAX_INODE
;

634 
√xt_i
 = 
	`c⁄èöî_of
(
√xt
, 
nova_ønge_node
, 
node
);

635 i‡(!
	`nova_ønge_node_checksum_ok
(
√xt_i
)) {

636 
	`nova_dbg
("%s: sec⁄dÇodêÁûed\n", 
__func__
);

637  -
EIO
;

639 
√xt_ønge_low
 = 
√xt_i
->
ønge_low
;

642 
√w_öo
 = 
i
->
ønge_high
 + 1;

644 i‡(
√xt_i
 && 
√w_öo
 =(
√xt_ønge_low
 - 1)) {

646 
i
->
ønge_high
 = 
√xt_i
->range_high;

647 
	`nova_upd©e_ønge_node_checksum
(
i
);

648 
	`rb_îa£
(&
√xt_i
->
node
, &
öode_m≠
->
öode_öu£_åì
);

649 
	`nova_‰ì_öode_node
(
√xt_i
);

650 
öode_m≠
->
num_ønge_node_öode
--;

651 } i‡(
√w_öo
 < (
√xt_ønge_low
 - 1)) {

653 
i
->
ønge_high
 = 
√w_öo
;

654 
	`nova_upd©e_ønge_node_checksum
(
i
);

656 
	`nova_dbg
("%s: ERROR:Çew inÿ%lu,Çexàlow %lu\n", 
__func__
,

657 
√w_öo
, 
√xt_ønge_low
);

658  -
ENOSPC
;

661 *
öo
 = 
√w_öo
 * 
sbi
->
˝us
 + 
˝uid
;

662 
sbi
->
s_öodes_u£d_cou¡
++;

663 
öode_m≠
->
Æloˇãd
++;

665 
	`nova_dbg_vîbo£
("AŒo¯öÿ%lu\n", *
öo
);

667 
	}
}

669 
	$nova_‰ì_öu£_öode
(
su≥r_block
 *
sb
, 
öo
)

671 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

672 
öode_m≠
 *inode_map;

673 
nova_ønge_node
 *
i
 = 
NULL
;

674 
nova_ønge_node
 *
cuº_node
;

675 
found
 = 0;

676 
˝uid
 = 
öo
 % 
sbi
->
˝us
;

677 
öã∫Æ_öo
 = 
öo
 / 
sbi
->
˝us
;

678 
ªt
 = 0;

680 
	`nova_dbg_vîbo£
("Fªêöu£ ino: %lu\n", 
öo
);

681 
öode_m≠
 = &
sbi
->
öode_m≠s
[
˝uid
];

683 
	`muãx_lock
(&
öode_m≠
->
öode_èbÀ_muãx
);

684 
found
 = 
	`nova_£¨ch_öodëªe
(
sbi
, 
öo
, &
i
);

685 i‡(!
found
) {

686 
	`nova_dbg
("%†ERROR: inÿ%luÇŸ found\n", 
__func__
, 
öo
);

687 
	`muãx_u∆ock
(&
öode_m≠
->
öode_èbÀ_muãx
);

688  -
EINVAL
;

691 i‡((
öã∫Æ_öo
 =
i
->
ønge_low
Ë&& (öã∫Æ_öÿ=i->
ønge_high
)) {

693 
	`rb_îa£
(&
i
->
node
, &
öode_m≠
->
öode_öu£_åì
);

694 
	`nova_‰ì_öode_node
(
i
);

695 
öode_m≠
->
num_ønge_node_öode
--;

696 
block_found
;

698 i‡((
öã∫Æ_öo
 =
i
->
ønge_low
Ë&& (öã∫Æ_öÿ< i->
ønge_high
)) {

700 
i
->
ønge_low
 = 
öã∫Æ_öo
 + 1;

701 
	`nova_upd©e_ønge_node_checksum
(
i
);

702 
block_found
;

704 i‡((
öã∫Æ_öo
 > 
i
->
ønge_low
Ë&& (öã∫Æ_öÿ=i->
ønge_high
)) {

706 
i
->
ønge_high
 = 
öã∫Æ_öo
 - 1;

707 
	`nova_upd©e_ønge_node_checksum
(
i
);

708 
block_found
;

710 i‡((
öã∫Æ_öo
 > 
i
->
ønge_low
Ë&& (öã∫Æ_öÿ< i->
ønge_high
)) {

712 
cuº_node
 = 
	`nova_Æloc_öode_node
(
sb
);

713 
	`NOVA_ASSERT
(
cuº_node
);

714 i‡(
cuº_node
 =
NULL
) {

716 
block_found
;

718 
cuº_node
->
ønge_low
 = 
öã∫Æ_öo
 + 1;

719 
cuº_node
->
ønge_high
 = 
i
->range_high;

720 
	`nova_upd©e_ønge_node_checksum
(
cuº_node
);

722 
i
->
ønge_high
 = 
öã∫Æ_öo
 - 1;

723 
	`nova_upd©e_ønge_node_checksum
(
i
);

725 
ªt
 = 
	`nova_ö£π_öodëªe
(
sbi
, 
cuº_node
, 
˝uid
);

726 i‡(
ªt
) {

727 
	`nova_‰ì_öode_node
(
cuº_node
);

728 
îr
;

730 
öode_m≠
->
num_ønge_node_öode
++;

731 
block_found
;

734 
îr
:

735 
	`nova_îr‹_mng
(
sb
, "U«bÀÅÿ‰ì inodê%lu\n", 
öo
);

736 
	`nova_îr‹_mng
(
sb
, "Found inuse block %lu - %lu\n",

737 
i
->
ønge_low
, i->
ønge_high
);

738 
	`muãx_u∆ock
(&
öode_m≠
->
öode_èbÀ_muãx
);

739  
ªt
;

741 
block_found
:

742 
sbi
->
s_öodes_u£d_cou¡
--;

743 
öode_m≠
->
‰ìd
++;

744 
	`muãx_u∆ock
(&
öode_m≠
->
öode_èbÀ_muãx
);

745  
ªt
;

746 
	}
}

748 
	$nova_‰ì_öode
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

749 
nova_öode_öfo_hódî
 *
sih
)

751 
îr
 = 0;

752 
	`INIT_TIMING
(
‰ì_time
);

754 
	`NOVA_START_TIMING
(
‰ì_öode_t
, 
‰ì_time
);

756 
	`nova_‰ì_öode_log
(
sb
, 
pi
, 
sih
);

758 
sih
->
log_∑ges
 = 0;

759 
sih
->
i_mode
 = 0;

760 
sih
->
pi_addr
 = 0;

761 
sih
->
Æãr_pi_addr
 = 0;

762 
sih
->
i_size
 = 0;

763 
sih
->
i_blocks
 = 0;

765 
îr
 = 
	`nova_‰ì_öu£_öode
(
sb
, 
pi
->
nova_öo
);

767 
	`NOVA_END_TIMING
(
‰ì_öode_t
, 
‰ì_time
);

768  
îr
;

769 
	}
}

771 
öode
 *
	$nova_igë
(
su≥r_block
 *
sb
, 
öo
)

773 
nova_öode_öfo
 *
si
;

774 
öode
 *inode;

775 
u64
 
pi_addr
;

776 
îr
;

778 
öode
 = 
	`igë_locked
(
sb
, 
öo
);

779 i‡(
	`u∆ikñy
(!
öode
))

780  
	`ERR_PTR
(-
ENOMEM
);

781 i‡(!(
öode
->
i_°©e
 & 
I_NEW
))

782  
öode
;

784 
si
 = 
	`NOVA_I
(
öode
);

786 
	`nova_dbgv
("%s: inodê%lu\n", 
__func__
, 
öo
);

788 
îr
 = 
	`nova_gë_öode_addªss
(
sb
, 
öo
, 0, &
pi_addr
, 0, 0);

789 i‡(
îr
) {

790 
	`nova_dbg
("%s: get inode %luáddress failed %d\n",

791 
__func__
, 
öo
, 
îr
);

792 
Áû
;

795 i‡(
pi_addr
 == 0) {

796 
	`nova_dbg
("%s: failedÅo getÖi_addr for inode %lu\n",

797 
__func__
, 
öo
);

798 
îr
 = -
EACCES
;

799 
Áû
;

802 
îr
 = 
	`nova_ªbuûd_öode
(
sb
, 
si
, 
öo
, 
pi_addr
, 1);

803 i‡(
îr
) {

804 
	`nova_dbg
("%s: faûedÅÿªbuûd inodê%lu\n", 
__func__
, 
öo
);

805 
Áû
;

808 
îr
 = 
	`nova_ªad_öode
(
sb
, 
öode
, 
pi_addr
);

809 i‡(
	`u∆ikñy
(
îr
)) {

810 
	`nova_dbg
("%s: faûedÅÿªad inodê%lu\n", 
__func__
, 
öo
);

811 
Áû
;

815 
öode
->
i_öo
 = 
öo
;

817 
	`u∆ock_√w_öode
(
öode
);

818  
öode
;

819 
Áû
:

820 
	`igë_Áûed
(
öode
);

821  
	`ERR_PTR
(
îr
);

822 
	}
}

824 
	$nova_gë_œ°_blockƒ
(
su≥r_block
 *
sb
,

825 
nova_öode_öfo_hódî
 *
sih
)

827 
nova_öode
 *
pi
, 
Áke_pi
;

828 
œ°_blockƒ
;

829 
bty≥
;

830 
d©a_bôs
;

831 
ªt
;

833 
ªt
 = 
	`nova_gë_ª„ªn˚
(
sb
, 
sih
->
pi_addr
, &
Áke_pi
,

834 (**)&
pi
, (
nova_öode
));

835 i‡(
ªt
) {

836 
	`nova_dbg
("%s:ÑeadÖi @ 0x%lx failed\n",

837 
__func__
, 
sih
->
pi_addr
);

838 
bty≥
 = 0;

840 
bty≥
 = 
sih
->
i_blk_ty≥
;

843 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
bty≥
];

845 i‡(
sih
->
i_size
 == 0)

846 
œ°_blockƒ
 = 0;

848 
œ°_blockƒ
 = (
sih
->
i_size
 - 1Ë>> 
d©a_bôs
;

850  
œ°_blockƒ
;

851 
	}
}

853 
	$nova_‰ì_öode_ªsour˚
(
su≥r_block
 *
sb
,

854 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
)

856 
œ°_blockƒ
;

857 
ªt
 = 0;

858 
‰ìd
 = 0;

859 
nova_öode
 *
Æãr_pi
;

860 
úq_Êags
 = 0;

862 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

863 
pi
->
dñëed
 = 1;

865 i‡(
pi
->
vÆid
) {

866 
	`nova_dbg
("%s: inode %lu still valid\n",

867 
__func__
, 
sih
->
öo
);

868 
pi
->
vÆid
 = 0;

870 
	`nova_upd©e_öode_checksum
(
pi
);

871 i‡(
mëad©a_csum
 && 
sih
->
Æãr_pi_addr
) {

872 
Æãr_pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
,

873 
sih
->
Æãr_pi_addr
);

874 
	`mem˝y_to_pmem_noˇche
(
Æãr_pi
, 
pi
, (
nova_öode
));

876 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

879 
	`__À16_to_˝u
(
pi
->
i_mode
Ë& 
S_IFMT
) {

880 
S_IFREG
:

881 
œ°_blockƒ
 = 
	`nova_gë_œ°_blockƒ
(
sb
, 
sih
);

882 
	`nova_dbgv
("%s: fûêöÿ%lu\n", 
__func__
, 
sih
->
öo
);

883 
‰ìd
 = 
	`nova_dñëe_fûe_åì
(
sb
, 
sih
, 0,

884 
œ°_blockƒ
, 
åue
,Årue, 0);

886 
S_IFDIR
:

887 
	`nova_dbgv
("%s: dú inÿ%lu\n", 
__func__
, 
sih
->
öo
);

888 
	`nova_dñëe_dú_åì
(
sb
, 
sih
);

890 
S_IFLNK
:

892 
	`nova_dbgv
("%s: symlink ino %lu\n",

893 
__func__
, 
sih
->
öo
);

894 
‰ìd
 = 
	`nova_dñëe_fûe_åì
(
sb
, 
sih
, 0, 0,

895 
åue
,Årue, 0);

898 
	`nova_dbgv
("%s: special ino %lu\n",

899 
__func__
, 
sih
->
öo
);

903 
	`nova_dbg_vîbo£
("%s: Fªed %d\n", 
__func__
, 
‰ìd
);

905 
ªt
 = 
	`nova_‰ì_öode
(
sb
, 
pi
, 
sih
);

906 i‡(
ªt
)

907 
	`nova_îr
(
sb
, "%s: free inode %lu failed\n",

908 
__func__
, 
sih
->
öo
);

910  
ªt
;

911 
	}
}

913 
	$nova_evi˘_öode
(
öode
 *inode)

915 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

916 
nova_öode
 *
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

917 
nova_öode_öfo_hódî
 *
sih
 = 
	`NOVA_IH
(
öode
);

918 
	`INIT_TIMING
(
evi˘_time
);

919 
de°roy
 = 0;

920 
ªt
;

922 
	`NOVA_START_TIMING
(
evi˘_öode_t
, 
evi˘_time
);

923 i‡(!
sih
) {

924 
	`nova_îr
(
sb
, "%s: ino %lu sih is NULL!\n",

925 
__func__
, 
öode
->
i_öo
);

926 
	`NOVA_ASSERT
(0);

927 
out
;

932 i‡(
pi
 &&Öi->
nova_öo
 !
öode
->
i_öo
) {

933 
	`nova_îr
(
sb
, "%s: inode %lu ino doesÇot match: %llu\n",

934 
__func__
, 
öode
->
i_öo
, 
pi
->
nova_öo
);

935 
	`nova_dbg
("inode size %llu,Öiáddr 0x%lx,Öi head 0x%llx,Åail 0x%llx, mode %u\n",

936 
öode
->
i_size
, 
sih
->
pi_addr
, sih->
log_hód
,

937 
sih
->
log_èû
, 
pi
->
i_mode
);

938 
	`nova_dbg
("sih: ino %lu, inode size %lu, mode %u, inode mode %u\n",

939 
sih
->
öo
, sih->
i_size
,

940 
sih
->
i_mode
, 
öode
->i_mode);

941 
	`nova_¥öt_öode_log
(
sb
, 
öode
);

945 i‡(
pi
 &&Öi->
vÆid
 == 0) {

946 
ªt
 = 
	`nova_≠≥nd_öode_to_¢≠shŸ
(
sb
, 
pi
);

947 i‡(
ªt
 == 0)

948 
out
;

951 
	`nova_dbg_vîbo£
("%s: %lu\n", 
__func__
, 
öode
->
i_öo
);

952 i‡(!
öode
->
i_∆ök
 && !
	`is_bad_öode
(inode)) {

953 i‡(
	`IS_APPEND
(
öode
Ë|| 
	`IS_IMMUTABLE
(inode))

954 
out
;

956 i‡(
pi
) {

957 
ªt
 = 
	`nova_‰ì_öode_ªsour˚
(
sb
, 
pi
, 
sih
);

958 i‡(
ªt
)

959 
out
;

962 
de°roy
 = 1;

963 
pi
 = 
NULL
;

966 
öode
->
i_mtime
 = 
	`öode_£t_˘ime_cuºít
(inode);

967 
öode
->
i_size
 = 0;

969 
out
:

970 i‡(
de°roy
 == 0) {

971 
	`nova_dbgv
("%s: de°royög %lu\n", 
__func__
, 
öode
->
i_öo
);

972 
	`nova_‰ì_døm_ªsour˚
(
sb
, 
sih
);

977 
	`åunˇã_öode_∑ges
(&
öode
->
i_d©a
, 0);

979 
	`˛ór_öode
(
öode
);

980 
	`NOVA_END_TIMING
(
evi˘_öode_t
, 
evi˘_time
);

981 
	}
}

984 
	$nova_dñëe_dód_öode
(
su≥r_block
 *
sb
, 
u64
 
öo
)

986 
nova_öode_öfo
 
si
;

987 
nova_öode_öfo_hódî
 *
sih
;

988 
nova_öode
 *
pi
;

989 
u64
 
pi_addr
 = 0;

990 
îr
;

992 i‡(
öo
 < 
NOVA_NORMAL_INODE_START
) {

993 
	`nova_dbg
("%s: invÆid inodê%Œu\n", 
__func__
, 
öo
);

994  -
EINVAL
;

997 
îr
 = 
	`nova_gë_öode_addªss
(
sb
, 
öo
, 0, &
pi_addr
, 0, 0);

998 i‡(
îr
) {

999 
	`nova_dbg
("%s: get inode %lluáddress failed %d\n",

1000 
__func__
, 
öo
, 
îr
);

1001  -
EINVAL
;

1004 i‡(
pi_addr
 == 0)

1005  -
EACCES
;

1007 
	`mem£t
(&
si
, 0, (
nova_öode_öfo
));

1008 
îr
 = 
	`nova_ªbuûd_öode
(
sb
, &
si
, 
öo
, 
pi_addr
, 0);

1009 i‡(
îr
)

1010  
îr
;

1012 
pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
, 
pi_addr
);

1013 
sih
 = &
si
.
hódî
;

1015 
	`nova_dbgv
("Delete dead inode %lu,Üog head 0x%llx,Åail 0x%llx\n",

1016 
sih
->
öo
, sih->
log_hód
, sih->
log_èû
);

1018  
	`nova_‰ì_öode_ªsour˚
(
sb
, 
pi
, 
sih
);

1019 
	}
}

1022 
u64
 
	$nova_√w_nova_öode
(
su≥r_block
 *
sb
, 
u64
 *
pi_addr
)

1024 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1025 
öode_m≠
 *inode_map;

1026 
‰ì_öo
 = 0;

1027 
m≠_id
;

1028 
u64
 
öo
 = 0;

1029 
ªt
;

1030 
	`INIT_TIMING
(
√w_öode_time
);

1032 
	`NOVA_START_TIMING
(
√w_nova_öode_t
, 
√w_öode_time
);

1033 
m≠_id
 = 
sbi
->map_id;

1034 
sbi
->
m≠_id
 = (sbi->m≠_id + 1Ë% sbi->
˝us
;

1036 
öode_m≠
 = &
sbi
->
öode_m≠s
[
m≠_id
];

1038 
	`muãx_lock
(&
öode_m≠
->
öode_èbÀ_muãx
);

1039 
ªt
 = 
	`nova_Æloc_unu£d_öode
(
sb
, 
m≠_id
, &
‰ì_öo
);

1040 i‡(
ªt
) {

1041 
	`nova_dbg
("%s:áŒo¯öodênumbî faûed %d\n", 
__func__
, 
ªt
);

1042 
	`muãx_u∆ock
(&
öode_m≠
->
öode_èbÀ_muãx
);

1046 
ªt
 = 
	`nova_gë_öode_addªss
(
sb
, 
‰ì_öo
, 0, 
pi_addr
, 1, 1);

1047 i‡(
ªt
) {

1048 
	`nova_dbg
("%s: gë inodêaddªs†Áûed %d\n", 
__func__
, 
ªt
);

1049 
	`muãx_u∆ock
(&
öode_m≠
->
öode_èbÀ_muãx
);

1053 
	`muãx_u∆ock
(&
öode_m≠
->
öode_èbÀ_muãx
);

1055 
öo
 = 
‰ì_öo
;

1057 
	`NOVA_END_TIMING
(
√w_nova_öode_t
, 
√w_öode_time
);

1058  
öo
;

1059 
	}
}

1061 
öode
 *
	$nova_√w_vfs_öode
(
nova_√w_öode_ty≥
 
ty≥
,

1062 
öode
 *
dú
, 
u64
 
pi_addr
, u64 
öo
, 
umode_t
 
mode
,

1063 
size_t
 
size
, 
dev_t
 
rdev
, c⁄° 
q°r
 *q°r, 
u64
 
ïoch_id
)

1065 
su≥r_block
 *
sb
;

1066 
nova_sb_öfo
 *
sbi
;

1067 
öode
 *inode;

1068 
nova_öode
 *
dúi
 = 
NULL
;

1069 
nova_öode_öfo
 *
si
;

1070 
nova_öode_öfo_hódî
 *
sih
 = 
NULL
;

1071 
nova_öode
 *
pi
;

1072 
nova_öode
 *
Æãr_pi
;

1073 
îrvÆ
;

1074 
u64
 
Æãr_pi_addr
 = 0;

1075 
úq_Êags
 = 0;

1076 
	`INIT_TIMING
(
√w_öode_time
);

1078 
	`NOVA_START_TIMING
(
√w_vfs_öode_t
, 
√w_öode_time
);

1079 
sb
 = 
dú
->
i_sb
;

1080 
sbi
 = (
nova_sb_öfo
 *)
sb
->
s_fs_öfo
;

1081 
öode
 = 
	`√w_öode
(
sb
);

1082 i‡(!
öode
) {

1083 
îrvÆ
 = -
ENOMEM
;

1084 
Áû2
;

1088 
	`öode_öô_ow√r
(&
n›_m¡_idm≠
, 
öode
, 
dú
, 
mode
);

1089 
öode
->
i_blocks
 = inode->
i_size
 = 0;

1091 
öode
->
i_mtime
 = inode->
i_©ime
 = 
	`öode_£t_˘ime_cuºít
(inode);

1093 
öode
->
i_gíî©i⁄
 = 
	`©omic_add_ªtu∫
(1, &
sbi
->
√xt_gíî©i⁄
);

1094 
öode
->
i_size
 = 
size
;

1096 
dúi
 = 
	`nova_gë_öode
(
sb
, 
dú
);

1097 i‡(!
dúi
) {

1098 
îrvÆ
 = -
EACCES
;

1099 
Áû1
;

1102 i‡(
mëad©a_csum
) {

1104 
îrvÆ
 = 
	`nova_gë_Æãr_öode_addªss
(
sb
, 
öo
, &
Æãr_pi_addr
);

1105 i‡(
îrvÆ
)

1106 
Áû1
;

1109 
pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
, 
pi_addr
);

1110 
	`nova_dbg_vîbo£
("%s:állocating inode %llu @ 0x%llx\n",

1111 
__func__
, 
öo
, 
pi_addr
);

1114 
öode
->
i_öo
 = 
öo
;

1116 
ty≥
) {

1117 
TYPE_CREATE
:

1118 
öode
->
i_›
 = &
nova_fûe_öode_›î©i⁄s
;

1119 
öode
->
i_m≠pög
->
a_›s
 = &
nova_a›s_dax
;

1120 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DATA_COW
Ë&& 
w¥Ÿe˘
 == 0)

1121 
öode
->
i_f›
 = &
nova_dax_fûe_›î©i⁄s
;

1123 
öode
->
i_f›
 = &
nova_wøp_fûe_›î©i⁄s
;

1125 
TYPE_MKNOD
:

1126 
	`öô_•ecül_öode
(
öode
, 
mode
, 
rdev
);

1127 
öode
->
i_›
 = &
nova_•ecül_öode_›î©i⁄s
;

1129 
TYPE_SYMLINK
:

1130 
öode
->
i_›
 = &
nova_symlök_öode_›î©i⁄s
;

1131 
öode
->
i_m≠pög
->
a_›s
 = &
nova_a›s_dax
;

1133 
TYPE_MKDIR
:

1134 
öode
->
i_›
 = &
nova_dú_öode_›î©i⁄s
;

1135 
öode
->
i_f›
 = &
nova_dú_›î©i⁄s
;

1136 
öode
->
i_m≠pög
->
a_›s
 = &
nova_a›s_dax
;

1137 
	`£t_∆ök
(
öode
, 2);

1140 
	`nova_dbg
("Unknow¿√w inodêty≥ %d\n", 
ty≥
);

1148 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

1149 
pi
->
i_blk_ty≥
 = 
NOVA_DEFAULT_BLOCK_TYPE
;

1150 
pi
->
i_Êags
 = 
	`nova_mask_Êags
(
mode
, 
dúi
->i_flags);

1151 
pi
->
nova_öo
 = 
öo
;

1152 
pi
->
i_¸óã_time
 = 
	`cuºít_time
(
öode
).
tv_£c
;

1153 
pi
->
¸óã_ïoch_id
 = 
ïoch_id
;

1154 
	`nova_öô_öode
(
öode
, 
pi
);

1156 i‡(
mëad©a_csum
) {

1157 
Æãr_pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
,

1158 
Æãr_pi_addr
);

1159 
	`mem˝y_to_pmem_noˇche
(
Æãr_pi
, 
pi
, (
nova_öode
));

1162 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

1164 
si
 = 
	`NOVA_I
(
öode
);

1165 
sih
 = &
si
->
hódî
;

1166 
	`nova_öô_hódî
(
sb
, 
sih
, 
öode
->
i_mode
);

1167 
sih
->
pi_addr
 =Öi_addr;

1168 
sih
->
Æãr_pi_addr
 =álter_pi_addr;

1169 
sih
->
öo
 = ino;

1170 
sih
->
i_blk_ty≥
 = 
NOVA_DEFAULT_BLOCK_TYPE
;

1172 
	`nova_£t_öode_Êags
(
öode
, 
pi
, 
	`À32_to_˝u
’i->
i_Êags
));

1173 
sih
->
i_Êags
 = 
	`À32_to_˝u
(
pi
->i_flags);

1175 i‡(
	`ö£π_öode_locked
(
öode
) < 0) {

1176 
	`nova_îr
(
sb
, "nova_√w_öodêÁûed inÿ%lx\n", 
öode
->
i_öo
);

1177 
îrvÆ
 = -
EINVAL
;

1178 
Áû1
;

1181 
	`nova_Êush_buf„r
(
pi
, 
NOVA_INODE_SIZE
, 0);

1182 
	`NOVA_END_TIMING
(
√w_vfs_öode_t
, 
√w_öode_time
);

1183  
öode
;

1184 
Áû1
:

1185 
	`make_bad_öode
(
öode
);

1186 
	`ùut
(
öode
);

1187 
Áû2
:

1188 
	`NOVA_END_TIMING
(
√w_vfs_öode_t
, 
√w_öode_time
);

1189  
	`ERR_PTR
(
îrvÆ
);

1190 
	}
}

1192 
	$nova_wrôe_öode
(
öode
 *öode, 
wrôeback_c⁄åﬁ
 *
wbc
)

1199 
	}
}

1207 
	$nova_dúty_öode
(
öode
 *öode, 
_Êags
)

1209 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1210 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1211 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

1212 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

1213 
nova_öode
 *
pi
, 
öode_c›y
;

1214 
úq_Êags
 = 0;

1216 i‡(
sbi
->
mou¡_¢≠shŸ
)

1219 
pi
 = 
	`nova_gë_block
(
sb
, 
sih
->
pi_addr
);

1222 i‡(
	`nova_check_öode_öãgrôy
(
sb
, 
sih
->
öo
, sih->
pi_addr
,

1223 
sih
->
Æãr_pi_addr
, &
öode_c›y
, 0) < 0)

1229 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

1230 
pi
->
i_©ime
 = 
	`˝u_to_À32
(
öode
->i_©ime.
tv_£c
);

1231 
	`nova_upd©e_öode_checksum
(
pi
);

1232 
	`nova_upd©e_Æãr_öode
(
sb
, 
öode
, 
pi
);

1233 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

1235 
	`nova_Êush_buf„r
(&
pi
->
i_©ime
, (pi->i_atime), 0);

1236 
	}
}

1238 
	$nova_£tsize
(
öode
 *öode, 
loff_t
 
ﬁdsize
,Üoff_à
√wsize
,

1239 
u64
 
ïoch_id
)

1241 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1242 
nova_öode_öfo_hódî
 *
sih
 = 
	`NOVA_IH
(
öode
);

1243 
	`INIT_TIMING
(
£tsize_time
);

1246 i‡(!(
	`S_ISREG
(
öode
->
i_mode
))) {

1247 
	`nova_îr
(
öode
->
i_sb
, "%s:wr⁄g fûêmodê%x\n", inode->
i_mode
);

1251 
	`NOVA_START_TIMING
(
£tsize_t
, 
£tsize_time
);

1253 
	`öode_dio_waô
(
öode
);

1255 
	`nova_dbgv
("%s: inode %lu, old size %llu,Çew size %llu\n",

1256 
__func__
, 
öode
->
i_öo
, 
ﬁdsize
, 
√wsize
);

1258 i‡(
√wsize
 !
ﬁdsize
) {

1259 
	`nova_˛ór_œ°_∑ge_èû
(
sb
, 
öode
, 
√wsize
);

1260 
	`i_size_wrôe
(
öode
, 
√wsize
);

1261 
sih
->
i_size
 = 
√wsize
;

1273 
	`åunˇã_∑geˇche
(
öode
, 
√wsize
);

1274 
	`nova_åunˇã_fûe_blocks
(
öode
, 
√wsize
, 
ﬁdsize
, 
ïoch_id
);

1275 
	`NOVA_END_TIMING
(
£tsize_t
, 
£tsize_time
);

1276 
	}
}

1280 
	$nova_gë©å
(
m¡_idm≠
 *
idm≠
, c⁄° 
∑th
 *path,

1281 
k°©
 *
°©
, 
u32
 
ªque°_mask
, 
quîy_Êags
)

1283 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

1284 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

1285 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

1286 
Êags
 = 
sih
->
i_Êags
;

1288 i‡(
Êags
 & 
FS_APPEND_FL
)

1289 
°©
->
©åibuãs
 |
STATX_ATTR_APPEND
;

1290 i‡(
Êags
 & 
FS_COMPR_FL
)

1291 
°©
->
©åibuãs
 |
STATX_ATTR_COMPRESSED
;

1292 i‡(
Êags
 & 
FS_IMMUTABLE_FL
)

1293 
°©
->
©åibuãs
 |
STATX_ATTR_IMMUTABLE
;

1294 i‡(
Êags
 & 
FS_NODUMP_FL
)

1295 
°©
->
©åibuãs
 |
STATX_ATTR_NODUMP
;

1298 
	`gíîic_fûœâr
(&
n›_m¡_idm≠
, 
ªque°_mask
, 
öode
, 
°©
);

1301 
°©
->
blocks
 = (
öode
->
i_blocks
 << inode->
i_sb
->
s_blocksize_bôs
) >> 9;

1303 
	}
}

1307 
	$nova_nŸify_ch™ge
(
m¡_idm≠
 *
idm≠
, 
díåy
 *dentry,

1308 
üâr
 *
©å
)

1310 
öode
 *öodê
díåy
->
d_öode
;

1311 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

1312 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

1313 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1314 
nova_öode
 *
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

1315 
ªt
;

1316 
ü_vÆid
 = 
©å
->ü_vÆid, 
©å_mask
;

1317 
loff_t
 
ﬁdsize
 = 
öode
->
i_size
;

1318 
u64
 
ïoch_id
;

1319 
	`INIT_TIMING
(
£èâr_time
);

1321 
	`NOVA_START_TIMING
(
£èâr_t
, 
£èâr_time
);

1322 i‡(!
pi
) {

1323 
ªt
 = -
EACCES
;

1324 
out
;

1328 
ªt
 = 
	`£èâr_¥ï¨e
(&
n›_m¡_idm≠
, 
díåy
, 
©å
);

1329 i‡(
ªt
)

1330 
out
;

1334 
	`£èâr_c›y
(&
n›_m¡_idm≠
, 
öode
, 
©å
);

1336 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

1338 
©å_mask
 = 
ATTR_MODE
 | 
ATTR_UID
 | 
ATTR_GID
 | 
ATTR_SIZE
 | 
ATTR_ATIME


1339 | 
ATTR_MTIME
 | 
ATTR_CTIME
;

1341 
ü_vÆid
 = ia_vÆid & 
©å_mask
;

1343 i‡(
ü_vÆid
 == 0)

1344 
out
;

1346 
ªt
 = 
	`nova_h™dÀ_£èâr_›î©i⁄
(
sb
, 
öode
, 
pi
, 
ü_vÆid
,

1347 
©å
, 
ïoch_id
);

1348 i‡(
ªt
)

1349 
out
;

1352 i‡((
ü_vÆid
 & 
ATTR_SIZE
Ë&& (
©å
->
ü_size
 !
ﬁdsize
 ||

1353 
pi
->
i_Êags
 & 
	`˝u_to_À32
(
NOVA_EOFBLOCKS_FL
))) {

1357 
	`nova_£tsize
(
öode
, 
ﬁdsize
, 
©å
->
ü_size
, 
ïoch_id
);

1360 
sih
->
å™s_id
++;

1361 
out
:

1362 
	`NOVA_END_TIMING
(
£èâr_t
, 
£èâr_time
);

1363  
ªt
;

1364 
	}
}

1366 
	$nova_£t_öode_Êags
(
öode
 *öode, 
nova_öode
 *
pi
,

1367 
Êags
)

1369 
öode
->
i_Êags
 &=

1370 ~(
S_SYNC
 | 
S_APPEND
 | 
S_IMMUTABLE
 | 
S_NOATIME
 | 
S_DIRSYNC
);

1371 i‡(
Êags
 & 
FS_SYNC_FL
)

1372 
öode
->
i_Êags
 |
S_SYNC
;

1373 i‡(
Êags
 & 
FS_APPEND_FL
)

1374 
öode
->
i_Êags
 |
S_APPEND
;

1375 i‡(
Êags
 & 
FS_IMMUTABLE_FL
)

1376 
öode
->
i_Êags
 |
S_IMMUTABLE
;

1377 i‡(
Êags
 & 
FS_NOATIME_FL
)

1378 
öode
->
i_Êags
 |
S_NOATIME
;

1379 i‡(
Êags
 & 
FS_DIRSYNC_FL
)

1380 
öode
->
i_Êags
 |
S_DIRSYNC
;

1381 i‡(!
pi
->
i_x©å
)

1382 
	`öode_has_no_x©å
(
öode
);

1383 
öode
->
i_Êags
 |
S_DAX
;

1384 
	}
}

1386 
ssize_t
 
	$nova_dúe˘_IO
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

1389  -
EIO
;

1390 
	}
}

1395 
	$nova_föd_ªgi⁄
(
öode
 *öode, 
loff_t
 *
off£t
, 
hﬁe
)

1397 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

1398 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

1399 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
sih
->
i_blk_ty≥
];

1400 
fú°_blockƒ
, 
œ°_blockƒ
;

1401 
blocks
 = 0, 
off£t_ö_block
;

1402 
d©a_found
 = 0, 
hﬁe_found
 = 0;

1404 i‡(*
off£t
 >
öode
->
i_size
)

1405  -
ENXIO
;

1407 i‡(!
öode
->
i_blocks
 || !
sih
->
i_size
) {

1408 i‡(
hﬁe
)

1409  
öode
->
i_size
;

1411  -
ENXIO
;

1414 
off£t_ö_block
 = *
off£t
 & ((1UL << 
d©a_bôs
) - 1);

1416 
fú°_blockƒ
 = *
off£t
 >> 
d©a_bôs
;

1417 
œ°_blockƒ
 = 
öode
->
i_size
 >> 
d©a_bôs
;

1419 
	`nova_dbg_vîbo£
("find_region offset %llx, first_blocknr %lx,Üast_blocknr %lx hole %d\n",

1420 *
off£t
, 
fú°_blockƒ
, 
œ°_blockƒ
, 
hﬁe
);

1422 
blocks
 = 
	`nova_lookup_hﬁe_ö_ønge
(
öode
->
i_sb
, 
sih
,

1423 
fú°_blockƒ
, 
œ°_blockƒ
, &
d©a_found
, &
hﬁe_found
, 
hﬁe
);

1426 i‡(!
hﬁe
 && !
d©a_found
 && 
hﬁe_found
)

1427  -
ENXIO
;

1429 i‡(
d©a_found
 && !
hﬁe_found
) {

1431 i‡(
hﬁe
)

1433 *
off£t
 = 
öode
->
i_size
;

1438 i‡(
hﬁe
 && 
hﬁe_found
 && !
blocks
) {

1440 i‡(!
d©a_found
)

1442 *
off£t
 = 
öode
->
i_size
;

1446 i‡(
off£t_ö_block
) {

1447 
blocks
--;

1448 *
off£t
 +(
blocks
 << 
d©a_bôs
) +

1449 ((1 << 
d©a_bôs
Ë- 
off£t_ö_block
);

1451 *
off£t
 +
blocks
 << 
d©a_bôs
;

1455 
	}
}

1457 
	$nova_wrôïages
(
addªss_•a˚
 *
m≠pög
,

1458 
wrôeback_c⁄åﬁ
 *
wbc
)

1460 
nova_sb_öfo
 *
sbi

	`NOVA_SB
(
m≠pög
->
ho°
->
i_sb
);

1461 
ªt
;

1463 
	`INIT_TIMING
(
wp_time
);

1465 
	`NOVA_START_TIMING
(
wrôe_∑ges_t
, 
wp_time
);

1466 
ªt
 = 
	`dax_wrôeback_m≠pög_ønge
(
m≠pög
, 
sbi
->
s_dax_dev
, 
wbc
);

1467 
	`NOVA_END_TIMING
(
wrôe_∑ges_t
, 
wp_time
);

1468  
ªt
;

1469 
	}
}

1471 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gnova_a›s_dax
 = {

1472 .
wrôïages
 = 
nova_wrôïages
,

1473 .
	gdúe˘_IO
 = 
nova_dúe˘_IO
,

	@inode.h

1 #i‚de‡
__INODE_H


2 
	#__INODE_H


	)

4 
	gnova_öode_öfo_hódî
;

5 
	gnova_öode
;

7 
	~"su≥r.h
"

8 
	~"log.h
"

10 
	enova_√w_öode_ty≥
 {

11 
	mTYPE_CREATE
 = 0,

12 
	mTYPE_MKNOD
,

13 
	mTYPE_SYMLINK
,

14 
	mTYPE_MKDIR


23 
	snova_öode
 {

26 
u8
 
	mi_rsvd
;

27 
u8
 
	mvÆid
;

28 
u8
 
	mdñëed
;

29 
u8
 
	mi_blk_ty≥
;

30 
__À32
 
	mi_Êags
;

31 
__À64
 
	mi_size
;

32 
__À32
 
	mi_˘ime
;

33 
__À32
 
	mi_mtime
;

34 
__À32
 
	mi_©ime
;

35 
__À16
 
	mi_mode
;

36 
__À16
 
	mi_löks_cou¡
;

38 
__À64
 
	mi_x©å
;

41 
__À32
 
	mi_uid
;

42 
__À32
 
	mi_gid
;

43 
__À32
 
	mi_gíî©i⁄
;

44 
__À32
 
	mi_¸óã_time
;

45 
__À64
 
	mnova_öo
;

47 
__À64
 
	mlog_hód
;

48 
__À64
 
	mlog_èû
;

51 
__À64
 
	mÆãr_log_hód
;

52 
__À64
 
	mÆãr_log_èû
;

54 
__À64
 
	m¸óã_ïoch_id
;

55 
__À64
 
	mdñëe_ïoch_id
;

58 
__À32
 
	mrdev
;

59 } 
	mdev
;

61 
__À32
 
	mcsum
;

64 } 
__©åibuã
((
__∑cked__
));

69 
	söode_èbÀ
 {

70 
__À64
 
	mlog_hód
;

76 
	snova_öode_öfo_hódî
 {

78 
ødix_åì_roŸ
 
	måì
;

79 
rb_roŸ
 
	mrb_åì
;

80 
rb_roŸ
 
	mvma_åì
;

81 
li°_hód
 
	mli°
;

82 
	mnum_vmas
;

83 
	mi_mode
;

84 
	mi_Êags
;

85 
	mlog_∑ges
;

86 
	mi_size
;

87 
	mi_blocks
;

88 
	möo
;

89 
	mpi_addr
;

90 
	mÆãr_pi_addr
;

91 
	mvÆid_íåõs
;

92 
	mnum_íåõs
;

93 
u64
 
	mœ°_£èâr
;

94 
u64
 
	mœ°_lök_ch™ge
;

95 
u64
 
	mœ°_díåy
;

96 
u64
 
	må™s_id
;

97 
u64
 
	mlog_hód
;

98 
u64
 
	mlog_èû
;

99 
u64
 
	mÆãr_log_hód
;

100 
u64
 
	mÆãr_log_èû
;

101 
u8
 
	mi_blk_ty≥
;

105 
	snova_öode_ªbuûd
 {

106 
u64
 
	mi_size
;

107 
u32
 
	mi_Êags
;

108 
u32
 
	mi_˘ime
;

109 
u32
 
	mi_mtime
;

110 
u32
 
	mi_©ime
;

111 
u32
 
	mi_uid
;

112 
u32
 
	mi_gid
;

113 
u32
 
	mi_gíî©i⁄
;

114 
u16
 
	mi_löks_cou¡
;

115 
u16
 
	mi_mode
;

116 
u64
 
	må™s_id
;

122 
	snova_öode_öfo
 {

123 
nova_öode_öfo_hódî
 
	mhódî
;

124 
öode
 
	mvfs_öode
;

128 
ölöe
 
nova_öode_öfo
 *
	$NOVA_I
(
öode
 *inode)

130  
	`c⁄èöî_of
(
öode
, 
nova_öode_öfo
, 
vfs_öode
);

131 
	}
}

133 
ölöe
 
nova_öode_öfo_hódî
 *
	$NOVA_IH
(
öode
 *inode)

135 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

136  &
si
->
hódî
;

137 
	}
}

139 
ölöe
 
nova_öode
 *
	$nova_gë_Æãr_öode
(
su≥r_block
 *
sb
,

140 
öode
 *inode)

142 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

143 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

144 
nova_öode
 
Áke_pi
;

145 *
addr
;

147 i‡(
mëad©a_csum
 == 0)

148  
NULL
;

150 
addr
 = 
	`nova_gë_block
(
sb
, 
sih
->
Æãr_pi_addr
);

151 i‡(
	`mem˝y
(&
Áke_pi
, 
addr
, (
nova_öode
)Ë=
NULL
)

152  
NULL
;

154  (
nova_öode
 *)
addr
;

155 
	}
}

157 
ölöe
 
	$nova_upd©e_Æãr_öode
(
su≥r_block
 *
sb
,

158 
öode
 *öode, 
nova_öode
 *
pi
)

160 
nova_öode
 *
Æãr_pi
;

162 i‡(
mëad©a_csum
 == 0)

165 
Æãr_pi
 = 
	`nova_gë_Æãr_öode
(
sb
, 
öode
);

166 i‡(!
Æãr_pi
)

167  -
EINVAL
;

169 
	`mem˝y_to_pmem_noˇche
(
Æãr_pi
, 
pi
, (
nova_öode
));

171 
	}
}

174 
ölöe
 
	$nova_upd©e_öode_checksum
(
nova_öode
 *
pi
)

176 
u32
 
¸c
 = 0;

178 i‡(
mëad©a_csum
 == 0)

179 
≥rsi°
;

181 
¸c
 = 
	`nova_¸c32c
(~0, (
__u8
 *)
pi
,

182 ((
nova_öode
Ë- (
__À32
)));

184 
pi
->
csum
 = 
¸c
;

185 
≥rsi°
:

186 
	`nova_Êush_buf„r
(
pi
, (
nova_öode
), 1);

188 
	}
}

190 
ölöe
 
	$nova_check_öode_checksum
(
nova_öode
 *
pi
)

192 
u32
 
¸c
 = 0;

194 i‡(
mëad©a_csum
 == 0)

197 
¸c
 = 
	`nova_¸c32c
(~0, (
__u8
 *)
pi
,

198 ((
nova_öode
Ë- (
__À32
)));

200 i‡(
pi
->
csum
 =
	`˝u_to_À32
(
¸c
))

204 
	}
}

208 
ölöe
 
	$nova_upd©e_èû
(
nova_öode
 *
pi
, 
u64
 
√w_èû
)

210 
	`INIT_TIMING
(
upd©e_time
);

212 
	`NOVA_START_TIMING
(
upd©e_èû_t
, 
upd©e_time
);

214 
	`PERSISTENT_BARRIER
();

215 
pi
->
log_èû
 = 
√w_èû
;

216 
	`nova_Êush_buf„r
(&
pi
->
log_èû
, 
CACHELINE_SIZE
, 1);

218 
	`NOVA_END_TIMING
(
upd©e_èû_t
, 
upd©e_time
);

219 
	}
}

221 
ölöe
 
	$nova_upd©e_Æãr_èû
(
nova_öode
 *
pi
, 
u64
 
√w_èû
)

223 
	`INIT_TIMING
(
upd©e_time
);

225 i‡(
mëad©a_csum
 == 0)

228 
	`NOVA_START_TIMING
(
upd©e_èû_t
, 
upd©e_time
);

230 
	`PERSISTENT_BARRIER
();

231 
pi
->
Æãr_log_èû
 = 
√w_èû
;

232 
	`nova_Êush_buf„r
(&
pi
->
Æãr_log_èû
, 
CACHELINE_SIZE
, 1);

234 
	`NOVA_END_TIMING
(
upd©e_èû_t
, 
upd©e_time
);

235 
	}
}

240 
ölöe
 
	$nova_upd©e_öode
(
su≥r_block
 *
sb
,

241 
öode
 *öode, 
nova_öode
 *
pi
,

242 
nova_öode_upd©e
 *
upd©e
, 
upd©e_Æãr
)

244 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

245 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

247 
sih
->
log_èû
 = 
upd©e
->
èû
;

248 
sih
->
Æãr_log_èû
 = 
upd©e
->
Æãr_èû
;

249 
	`nova_upd©e_èû
(
pi
, 
upd©e
->
èû
);

250 i‡(
mëad©a_csum
)

251 
	`nova_upd©e_Æãr_èû
(
pi
, 
upd©e
->
Æãr_èû
);

253 
	`nova_upd©e_öode_checksum
(
pi
);

254 i‡(
öode
 && 
upd©e_Æãr
)

255 
	`nova_upd©e_Æãr_öode
(
sb
, 
öode
, 
pi
);

256 
	}
}

259 
ölöe


260 
öode_èbÀ
 *
	$nova_gë_öode_èbÀ
(
su≥r_block
 *
sb
,

261 
vîsi⁄
, 
˝u
)

263 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

264 
èbÀ_°¨t
;

266 i‡(
˝u
 >
sbi
->
˝us
)

267  
NULL
;

269 i‡((
vîsi⁄
 & 0x1) == 0)

270 
èbÀ_°¨t
 = 
INODE_TABLE0_START
;

272 
èbÀ_°¨t
 = 
INODE_TABLE1_START
;

274  (
öode_èbÀ
 *)((*)
	`nova_gë_block
(
sb
,

275 
NOVA_DEF_BLOCK_SIZE_4K
 * 
èbÀ_°¨t
) +

276 
˝u
 * 
CACHELINE_SIZE
);

277 
	}
}

279 
ölöe
 

280 
	$nova_öode_blk_shi·
(
nova_öode_öfo_hódî
 *
sih
)

282  
blk_ty≥_to_shi·
[
sih
->
i_blk_ty≥
];

283 
	}
}

285 
ölöe
 
uöt32_t
 
	$nova_öode_blk_size
(
nova_öode_öfo_hódî
 *
sih
)

287  
blk_ty≥_to_size
[
sih
->
i_blk_ty≥
];

288 
	}
}

290 
ölöe
 
u64
 
	$nova_gë_ª£rved_öode_addr
(
su≥r_block
 *
sb
,

291 
u64
 
öode_numbî
)

293  (
NOVA_DEF_BLOCK_SIZE_4K
 * 
RESERVE_INODE_START
) +

294 
öode_numbî
 * 
NOVA_INODE_SIZE
;

295 
	}
}

297 
ölöe
 
u64
 
	$nova_gë_Æãr_ª£rved_öode_addr
(
su≥r_block
 *
sb
,

298 
u64
 
öode_numbî
)

300 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

302  
	`nova_gë_addr_off
(
sbi
, sbi->
ª∂iˇ_ª£rved_öodes_addr
) +

303 
öode_numbî
 * 
NOVA_INODE_SIZE
;

304 
	}
}

306 
ölöe
 
nova_öode
 *
	$nova_gë_ª£rved_öode
(
su≥r_block
 *
sb
,

307 
u64
 
öode_numbî
)

309 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

310 
u64
 
addr
;

312 
addr
 = 
	`nova_gë_ª£rved_öode_addr
(
sb
, 
öode_numbî
);

314  (
nova_öode
 *)(
sbi
->
vút_addr
 + 
addr
);

315 
	}
}

317 
ölöe
 
nova_öode
 *

318 
	$nova_gë_Æãr_ª£rved_öode
(
su≥r_block
 *
sb
,

319 
u64
 
öode_numbî
)

321 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

322 
u64
 
addr
;

324 
addr
 = 
	`nova_gë_Æãr_ª£rved_öode_addr
(
sb
, 
öode_numbî
);

326  (
nova_öode
 *)(
sbi
->
vút_addr
 + 
addr
);

327 
	}
}

332 
ölöe
 
nova_öode
 *
	$nova_gë_öode_by_öo
(
su≥r_block
 *
sb
,

333 
u64
 
öo
)

335 i‡(
öo
 =0 || inÿ>
NOVA_NORMAL_INODE_START
)

336  
NULL
;

338  
	`nova_gë_ª£rved_öode
(
sb
, 
öo
);

339 
	}
}

341 
ölöe
 
nova_öode
 *
	$nova_gë_öode
(
su≥r_block
 *
sb
,

342 
öode
 *inode)

344 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

345 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

346 
nova_öode
 
Áke_pi
;

347 *
addr
;

349 
addr
 = 
	`nova_gë_block
(
sb
, 
sih
->
pi_addr
);

350 i‡(
	`mem˝y
(&
Áke_pi
, 
addr
, (
nova_öode
)Ë=
NULL
)

351  
NULL
;

353  (
nova_öode
 *)
addr
;

354 
	}
}

358 c⁄° 
addªss_•a˚_›î©i⁄s
 
nova_a›s_dax
;

359 
nova_öô_öode_öu£_li°
(
su≥r_block
 *
sb
);

360 
nova_öô_öode_èbÀ
(
su≥r_block
 *
sb
);

361 
nova_gë_Æãr_öode_addªss
(
su≥r_block
 *
sb
, 
u64
 
öo
,

362 
u64
 *
Æãr_pi_addr
);

363 
nova_gë_œ°_blockƒ
(
su≥r_block
 *
sb
,

364 
nova_öode_öfo_hódî
 *
sih
);

365 
nova_gë_öode_addªss
(
su≥r_block
 *
sb
, 
u64
 
öo
, 
vîsi⁄
,

366 
u64
 *
pi_addr
, 
exãndabÀ
, 
exãnd_Æã∫©e
);

367 
nova_£t_blocksize_höt
(
su≥r_block
 *
sb
, 
öode
 *inode,

368 
nova_öode
 *
pi
, 
loff_t
 
√w_size
);

369 
öode
 *
nova_igë
(
su≥r_block
 *
sb
, 
öo
);

370 
nova_evi˘_öode
(
öode
 *inode);

371 
nova_wrôe_öode
(
öode
 *öode, 
wrôeback_c⁄åﬁ
 *
wbc
);

372 
nova_dúty_öode
(
öode
 *öode, 
Êags
);

377 
nova_nŸify_ch™ge
(
m¡_idm≠
 *
idm≠
, 
díåy
 *dentry,

378 
üâr
 *
©å
);

379 
nova_gë©å
(
m¡_idm≠
 *
idm≠
, c⁄° 
∑th
 *path,

380 
k°©
 *
°©
, 
u32
 
ªque°_mask
, 
quîy_Êags
);

381 
nova_£t_öode_Êags
(
öode
 *öode, 
nova_öode
 *
pi
,

382 
Êags
);

383 
nova_föd_ªgi⁄
(
öode
 *öode, 
loff_t
 *
off£t
,

384 
hﬁe
);

385 
nova_dñëe_fûe_åì
(
su≥r_block
 *
sb
,

386 
nova_öode_öfo_hódî
 *
sih
, 
°¨t_blockƒ
,

387 
œ°_blockƒ
, 
boﬁ
 
dñëe_nvmm
,

388 
boﬁ
 
dñëe_dód
, 
u64
 
åa¢_id
);

389 
u64
 
nova_√w_nova_öode
(
su≥r_block
 *
sb
, u64 *
pi_addr
);

390 
öode
 *
nova_√w_vfs_öode
(
nova_√w_öode_ty≥
,

391 
öode
 *
dú
, 
u64
 
pi_addr
, u64 
öo
, 
umode_t
 
mode
,

392 
size_t
 
size
, 
dev_t
 
rdev
, c⁄° 
q°r
 *q°r, 
u64
 
ïoch_id
);

	@ioctl.c

16 
	~<löux/ˇ∑bûôy.h
>

17 
	~<löux/time.h
>

18 
	~<löux/sched.h
>

19 
	~<löux/com∑t.h
>

20 
	~<löux/mou¡.h
>

21 
	~"nova.h
"

22 
	~"öode.h
"

24 
	$nova_io˘l
(
fûe
 *
fûp
, 
cmd
, 
¨g
)

26 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

27 
öode
 *öodê
m≠pög
->
ho°
;

28 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

29 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

30 
nova_öode
 *
pi
;

31 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

32 
nova_öode_upd©e
 
upd©e
;

33 
Êags
;

34 
ªt
;

35 
úq_Êags
 = 0;

37 
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

38 i‡(!
pi
)

39  -
EACCES
;

41 
cmd
) {

42 
FS_IOC_GETFLAGS
:

43 
Êags
 = (
sih
->
i_Êags
Ë& 
NOVA_FL_USER_VISIBLE
;

44  
	`put_u£r
(
Êags
, (
__u£r
 *)
¨g
);

45 
FS_IOC_SETFLAGS
: {

46 
ﬁdÊags
;

47 
u64
 
ﬁd_lökc
 = 0;

48 
u64
 
ïoch_id
;

50 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

51 i‡(
ªt
)

52  
ªt
;

55 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(&
n›_m¡_idm≠
, 
öode
)) {

56 
ªt
 = -
EPERM
;

57 
Êags_out
;

60 i‡(
	`gë_u£r
(
Êags
, (
__u£r
 *)
¨g
)) {

61 
ªt
 = -
EFAULT
;

62 
Êags_out
;

65 
	`öode_lock
(
öode
);

66 
ﬁdÊags
 = 
	`À32_to_˝u
(
pi
->
i_Êags
);

68 i‡((
Êags
 ^ 
ﬁdÊags
) &

69 (
FS_APPEND_FL
 | 
FS_IMMUTABLE_FL
)) {

70 i‡(!
	`ˇ∑bÀ
(
CAP_LINUX_IMMUTABLE
)) {

71 
ªt
 = -
EPERM
;

72 
Êags_out_u∆ock
;

76 i‡(!
	`S_ISDIR
(
öode
->
i_mode
))

77 
Êags
 &~
FS_DIRSYNC_FL
;

79 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

80 
Êags
 = fœg†& 
FS_FL_USER_MODIFIABLE
;

81 
Êags
 |
ﬁdÊags
 & ~
FS_FL_USER_MODIFIABLE
;

83 
	`öode_£t_˘ime_cuºít
(
öode
);

85 
	`nova_£t_öode_Êags
(
öode
, 
pi
, 
Êags
);

86 
sih
->
i_Êags
 = 
Êags
;

88 
upd©e
.
èû
 = 0;

89 
upd©e
.
Æãr_èû
 = 0;

90 
ªt
 = 
	`nova_≠≥nd_lök_ch™ge_íåy
(
sb
, 
pi
, 
öode
,

91 &
upd©e
, &
ﬁd_lökc
, 
ïoch_id
);

92 i‡(!
ªt
) {

93 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

94 
	`nova_upd©e_öode
(
sb
, 
öode
, 
pi
, &
upd©e
, 1);

95 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

96 
	`nova_övÆid©e_lök_ch™ge_íåy
(
sb
, 
ﬁd_lökc
);

98 
sih
->
å™s_id
++;

99 
Êags_out_u∆ock
:

100 
	`öode_u∆ock
(
öode
);

101 
Êags_out
:

102 
	`m¡_dr›_wrôe_fûe
(
fûp
);

103  
ªt
;

105 
FS_IOC_GETVERSION
:

106  
	`put_u£r
(
öode
->
i_gíî©i⁄
, (
__u£r
 *)
¨g
);

107 
FS_IOC_SETVERSION
: {

108 
u64
 
ﬁd_lökc
 = 0;

109 
u64
 
ïoch_id
;

110 
__u32
 
gíî©i⁄
;

113 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(&
n›_m¡_idm≠
, 
öode
))

114  -
EPERM
;

115 
ªt
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

116 i‡(
ªt
)

117  
ªt
;

118 i‡(
	`gë_u£r
(
gíî©i⁄
, (
__u£r
 *)
¨g
)) {

119 
ªt
 = -
EFAULT
;

120 
£tvîsi⁄_out
;

123 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

124 
	`öode_lock
(
öode
);

126 
	`öode_£t_˘ime_cuºít
(
öode
);

127 
öode
->
i_gíî©i⁄
 = 
gíî©i⁄
;

129 
upd©e
.
èû
 = 0;

130 
upd©e
.
Æãr_èû
 = 0;

131 
ªt
 = 
	`nova_≠≥nd_lök_ch™ge_íåy
(
sb
, 
pi
, 
öode
,

132 &
upd©e
, &
ﬁd_lökc
, 
ïoch_id
);

133 i‡(!
ªt
) {

134 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

135 
	`nova_upd©e_öode
(
sb
, 
öode
, 
pi
, &
upd©e
, 1);

136 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

137 
	`nova_övÆid©e_lök_ch™ge_íåy
(
sb
, 
ﬁd_lökc
);

139 
sih
->
å™s_id
++;

140 
	`öode_u∆ock
(
öode
);

141 
£tvîsi⁄_out
:

142 
	`m¡_dr›_wrôe_fûe
(
fûp
);

143  
ªt
;

145 
NOVA_PRINT_TIMING
: {

146 
	`nova_¥öt_timög_°©s
(
sb
);

149 
NOVA_CLEAR_STATS
: {

150 
	`nova_˛ór_°©s
(
sb
);

153 
NOVA_PRINT_LOG
: {

154 
	`nova_¥öt_öode_log
(
sb
, 
öode
);

157 
NOVA_PRINT_LOG_PAGES
: {

158 
	`nova_¥öt_öode_log_∑ges
(
sb
, 
öode
);

161 
NOVA_PRINT_FREE_LISTS
: {

162 
	`nova_¥öt_‰ì_li°s
(
sb
);

166  -
ENOTTY
;

168 
	}
}

170 #ifde‡
CONFIG_COMPAT


171 
	$nova_com∑t_io˘l
(
fûe
 *fûe, 
cmd
, 
¨g
)

173 
cmd
) {

174 
FS_IOC32_GETFLAGS
:

175 
cmd
 = 
FS_IOC_GETFLAGS
;

177 
FS_IOC32_SETFLAGS
:

178 
cmd
 = 
FS_IOC_SETFLAGS
;

180 
FS_IOC32_GETVERSION
:

181 
cmd
 = 
FS_IOC_GETVERSION
;

183 
FS_IOC32_SETVERSION
:

184 
cmd
 = 
FS_IOC_SETVERSION
;

187  -
ENOIOCTLCMD
;

189  
	`nova_io˘l
(
fûe
, 
cmd
, ()
	`com∑t_±r
(
¨g
));

190 
	}
}

	@journal.c

26 
	~<löux/moduÀ.h
>

27 
	~<löux/°rög.h
>

28 
	~<löux/öô.h
>

29 
	~<löux/vfs.h
>

30 
	~<löux/uac˚ss.h
>

31 
	~<löux/mm.h
>

32 
	~<löux/muãx.h
>

33 
	~<löux/sched.h
>

34 
	~"nova.h
"

35 
	~"jou∫Æ.h
"

39 
ölöe
 

40 
	$nova_¥öt_lôe_å™ß˘i⁄
(
nova_lôe_jou∫Æ_íåy
 *
íåy
)

42 
	`nova_dbg
("Entry %p: Type %llu, data1 0x%llx, data2 0x%llx\n, checksum %u\n",

43 
íåy
,É¡ry->
ty≥
,

44 
íåy
->
d©a1
,É¡ry->
d©a2
,É¡ry->
csum
);

45 
	}
}

47 
ölöe
 
	$nova_upd©e_jou∫Æ_íåy_csum
(
su≥r_block
 *
sb
,

48 
nova_lôe_jou∫Æ_íåy
 *
íåy
)

50 
u32
 
¸c
 = 0;

52 
¸c
 = 
	`nova_¸c32c
(~0, (
__u8
 *)
íåy
,

53 ((
nova_lôe_jou∫Æ_íåy
)

54 - (
__À32
)));

56 
íåy
->
csum
 = 
	`˝u_to_À32
(
¸c
);

58 
	}
}

60 
ölöe
 
	$nova_check_íåy_öãgrôy
(
su≥r_block
 *
sb
,

61 
nova_lôe_jou∫Æ_íåy
 *
íåy
)

63 
u32
 
¸c
 = 0;

65 
¸c
 = 
	`nova_¸c32c
(~0, (
__u8
 *)
íåy
,

66 ((
nova_lôe_jou∫Æ_íåy
)

67 - (
__À32
)));

69 i‡(
íåy
->
csum
 =
	`˝u_to_À32
(
¸c
))

73 
	}
}

79 
ölöe
 
u64
 
	$√xt_lôe_jou∫Æ
(
u64
 
cuº_p
)

81 
size_t
 
size
 = (
nova_lôe_jou∫Æ_íåy
);

83 i‡((
cuº_p
 & (
PAGE_SIZE
 - 1)Ë+ 
size
 >= PAGE_SIZE)

84  (
cuº_p
 & 
PAGE_MASK
);

86  
cuº_p
 + 
size
;

87 
	}
}

90 
	$nova_check_jou∫Æ_íåõs
(
su≥r_block
 *
sb
,

91 
jou∫Æ_±r_∑ú
 *
∑ú
)

93 
nova_lôe_jou∫Æ_íåy
 *
íåy
;

94 
u64
 
ãmp
;

95 
ªt
;

97 
ãmp
 = 
∑ú
->
jou∫Æ_hód
;

98 
ãmp
 !
∑ú
->
jou∫Æ_èû
) {

99 
íåy
 = (
nova_lôe_jou∫Æ_íåy
 *)
	`nova_gë_block
(
sb
,

100 
ãmp
);

101 
ªt
 = 
	`nova_check_íåy_öãgrôy
(
sb
, 
íåy
);

102 i‡(
ªt
) {

103 
	`nova_dbg
("E¡ry %∞checksum faûuª\n", 
íåy
);

104 
	`nova_¥öt_lôe_å™ß˘i⁄
(
íåy
);

105  
ªt
;

107 
ãmp
 = 
	`√xt_lôe_jou∫Æ
(temp);

111 
	}
}

115 
	$nova_undo_jou∫Æ_öode
(
su≥r_block
 *
sb
,

116 
nova_lôe_jou∫Æ_íåy
 *
íåy
)

118 
nova_öode
 *
pi
, *
Æãr_pi
;

119 
u64
 
pi_addr
, 
Æãr_pi_addr
;

121 i‡(
mëad©a_csum
 == 0)

124 
pi_addr
 = 
	`À64_to_˝u
(
íåy
->
d©a1
);

125 
Æãr_pi_addr
 = 
	`À64_to_˝u
(
íåy
->
d©a2
);

127 
pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
, 
pi_addr
);

128 
Æãr_pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
, 
Æãr_pi_addr
);

130 
	`mem˝y_to_pmem_noˇche
(
pi
, 
Æãr_pi
, (
nova_öode
));

131 
	}
}

133 
	$nova_undo_jou∫Æ_íåy
(
su≥r_block
 *
sb
,

134 
nova_lôe_jou∫Æ_íåy
 *
íåy
)

136 
u64
 
addr
, 
vÆue
;

138 
addr
 = 
	`À64_to_˝u
(
íåy
->
d©a1
);

139 
vÆue
 = 
	`À64_to_˝u
(
íåy
->
d©a2
);

141 *(
u64
 *)
	`nova_gë_block
(
sb
, 
addr
Ë(u64)
vÆue
;

142 
	`nova_Êush_buf„r
((*)
	`nova_gë_block
(
sb
, 
addr
), 
CACHELINE_SIZE
, 0);

143 
	}
}

145 
	$nova_undo_lôe_jou∫Æ_íåy
(
su≥r_block
 *
sb
,

146 
nova_lôe_jou∫Æ_íåy
 *
íåy
)

148 
u64
 
ty≥
;

150 
ty≥
 = 
	`À64_to_˝u
(
íåy
->type);

152 
ty≥
) {

153 
JOURNAL_INODE
:

154 
	`nova_undo_jou∫Æ_öode
(
sb
, 
íåy
);

156 
JOURNAL_ENTRY
:

157 
	`nova_undo_jou∫Æ_íåy
(
sb
, 
íåy
);

160 
	`nova_dbg
("%s: unknow¿d©®ty≥ %Œu\n", 
__func__
, 
ty≥
);

163 
	}
}

166 
	$nova_ªcovî_lôe_jou∫Æ
(
su≥r_block
 *
sb
,

167 
jou∫Æ_±r_∑ú
 *
∑ú
)

169 
nova_lôe_jou∫Æ_íåy
 *
íåy
;

170 
u64
 
ãmp
;

171 
úq_Êags
 = 0;

173 
	`nova_memu∆ock_jou∫Æ
(
sb
, &
úq_Êags
);

174 
ãmp
 = 
∑ú
->
jou∫Æ_hód
;

175 
ãmp
 !
∑ú
->
jou∫Æ_èû
) {

176 
íåy
 = (
nova_lôe_jou∫Æ_íåy
 *)
	`nova_gë_block
(
sb
,

177 
ãmp
);

178 
	`nova_undo_lôe_jou∫Æ_íåy
(
sb
, 
íåy
);

179 
ãmp
 = 
	`√xt_lôe_jou∫Æ
(temp);

182 
∑ú
->
jou∫Æ_èû
 =Öaú->
jou∫Æ_hód
;

183 
	`nova_memlock_jou∫Æ
(
sb
, &
úq_Êags
);

184 
	`nova_Êush_buf„r
(&
∑ú
->
jou∫Æ_hód
, 
CACHELINE_SIZE
, 1);

187 
	}
}

191 
u64
 
	$nova_≠≥nd_ª∂iˇ_öode_jou∫Æ
(
su≥r_block
 *
sb
,

192 
u64
 
cuº_p
, 
öode
 *inode)

194 
nova_lôe_jou∫Æ_íåy
 *
íåy
;

195 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

196 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

198 
íåy
 = (
nova_lôe_jou∫Æ_íåy
 *)
	`nova_gë_block
(
sb
,

199 
cuº_p
);

200 
íåy
->
ty≥
 = 
	`˝u_to_À64
(
JOURNAL_INODE
);

201 
íåy
->
∑ddög
 = 0;

202 
íåy
->
d©a1
 = 
	`˝u_to_À64
(
sih
->
pi_addr
);

203 
íåy
->
d©a2
 = 
	`˝u_to_À64
(
sih
->
Æãr_pi_addr
);

204 
	`nova_upd©e_jou∫Æ_íåy_csum
(
sb
, 
íåy
);

206 
cuº_p
 = 
	`√xt_lôe_jou∫Æ
(curr_p);

207  
cuº_p
;

208 
	}
}

211 
u64
 
	$nova_≠≥nd_íåy_jou∫Æ
(
su≥r_block
 *
sb
,

212 
u64
 
cuº_p
, *
fõld
)

214 
nova_lôe_jou∫Æ_íåy
 *
íåy
;

215 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

216 
u64
 *
Æig√d_fõld
;

217 
u64
 
addr
;

219 
íåy
 = (
nova_lôe_jou∫Æ_íåy
 *)
	`nova_gë_block
(
sb
,

220 
cuº_p
);

221 
íåy
->
ty≥
 = 
	`˝u_to_À64
(
JOURNAL_ENTRY
);

222 
íåy
->
∑ddög
 = 0;

224 
Æig√d_fõld
 = (
u64
 *)(()
fõld
 & ~7UL);

226 
addr
 = (
u64
)
	`nova_gë_addr_off
(
sbi
, 
Æig√d_fõld
);

227 
íåy
->
d©a1
 = 
	`˝u_to_À64
(
addr
);

228 
íåy
->
d©a2
 = 
	`˝u_to_À64
(*
Æig√d_fõld
);

229 
	`nova_upd©e_jou∫Æ_íåy_csum
(
sb
, 
íåy
);

231 
cuº_p
 = 
	`√xt_lôe_jou∫Æ
(curr_p);

232  
cuº_p
;

233 
	}
}

235 
u64
 
	$nova_jou∫Æ_öode_èû
(
su≥r_block
 *
sb
,

236 
u64
 
cuº_p
, 
nova_öode
 *
pi
)

238 
cuº_p
 = 
	`nova_≠≥nd_íåy_jou∫Æ
(
sb
, cuº_p, &
pi
->
log_èû
);

239 i‡(
mëad©a_csum
)

240 
cuº_p
 = 
	`nova_≠≥nd_íåy_jou∫Æ
(
sb
, curr_p,

241 &
pi
->
Æãr_log_èû
);

242  
cuº_p
;

243 
	}
}

246 
u64
 
	$nova_≠≥nd_öode_jou∫Æ
(
su≥r_block
 *
sb
,

247 
u64
 
cuº_p
, 
öode
 *öode, 
√w_öode
,

248 
övÆid©e
, 
is_dú
)

250 
nova_öode
 *
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

252 i‡(
mëad©a_csum
)

253  
	`nova_≠≥nd_ª∂iˇ_öode_jou∫Æ
(
sb
, 
cuº_p
, 
öode
);

255 i‡(!
pi
) {

256 
	`nova_îr
(
sb
, "%s: gë inodêÁûed\n", 
__func__
);

257  
cuº_p
;

260 i‡(
is_dú
)

261  
	`nova_jou∫Æ_öode_èû
(
sb
, 
cuº_p
, 
pi
);

263 i‡(
√w_öode
) {

264 
cuº_p
 = 
	`nova_≠≥nd_íåy_jou∫Æ
(
sb
, curr_p,

265 &
pi
->
vÆid
);

267 
cuº_p
 = 
	`nova_jou∫Æ_öode_èû
(
sb
, cuº_p, 
pi
);

268 i‡(
övÆid©e
) {

269 
cuº_p
 = 
	`nova_≠≥nd_íåy_jou∫Æ
(
sb
, curr_p,

270 &
pi
->
vÆid
);

271 
cuº_p
 = 
	`nova_≠≥nd_íåy_jou∫Æ
(
sb
, curr_p,

272 &
pi
->
dñëe_ïoch_id
);

276  
cuº_p
;

277 
	}
}

279 
u64
 
	$nova_≠≥nd_díåy_jou∫Æ
(
su≥r_block
 *
sb
,

280 
u64
 
cuº_p
, 
nova_díåy
 *
díåy
)

282 
cuº_p
 = 
	`nova_≠≥nd_íåy_jou∫Æ
(
sb
, cuº_p, &
díåy
->
öo
);

283 
cuº_p
 = 
	`nova_≠≥nd_íåy_jou∫Æ
(
sb
, cuº_p, &
díåy
->
csum
);

284  
cuº_p
;

285 
	}
}

287 
	$nova_Êush_jou∫Æ_ö_b©ch
(
su≥r_block
 *
sb
,

288 
u64
 
hód
, u64 
èû
)

290 *
jou∫Æ_íåy
;

293 i‡(
hód
 < 
èû
) {

294 
jou∫Æ_íåy
 = 
	`nova_gë_block
(
sb
, 
hód
);

295 
	`nova_Êush_buf„r
(
jou∫Æ_íåy
, 
èû
 - 
hód
, 0);

299 
jou∫Æ_íåy
 = 
	`nova_gë_block
(
sb
, 
hód
);

300 
	`nova_Êush_buf„r
(
jou∫Æ_íåy
,

301 
PAGE_SIZE
 - (
hód
 & ~
PAGE_MASK
), 0);

304 
jou∫Æ_íåy
 = 
	`nova_gë_block
(
sb
, 
èû
);

305 
	`nova_Êush_buf„r
((*)((
u64
)
jou∫Æ_íåy
 & 
PAGE_MASK
),

306 
èû
 & ~
PAGE_MASK
, 0);

308 
	`PERSISTENT_BARRIER
();

309 
	}
}

312 
u64
 
	$nova_¸óã_öode_å™ß˘i⁄
(
su≥r_block
 *
sb
,

313 
öode
 *öode, öodê*
dú
, 
˝u
,

314 
√w_öode
, 
övÆid©e
)

316 
jou∫Æ_±r_∑ú
 *
∑ú
;

317 
u64
 
ãmp
;

319 
∑ú
 = 
	`nova_gë_jou∫Æ_poöãrs
(
sb
, 
˝u
);

320 i‡(
∑ú
->
jou∫Æ_hód
 == 0 ||

321 
∑ú
->
jou∫Æ_hód
 !∑ú->
jou∫Æ_èû
)

322 
	`BUG
();

324 
ãmp
 = 
∑ú
->
jou∫Æ_hód
;

326 
ãmp
 = 
	`nova_≠≥nd_öode_jou∫Æ
(
sb
,Åemp, 
öode
,

327 
√w_öode
, 
övÆid©e
, 0);

329 
ãmp
 = 
	`nova_≠≥nd_öode_jou∫Æ
(
sb
,Åemp, 
dú
,

330 
√w_öode
, 
övÆid©e
, 1);

332 
	`nova_Êush_jou∫Æ_ö_b©ch
(
sb
, 
∑ú
->
jou∫Æ_hód
, 
ãmp
);

333 
∑ú
->
jou∫Æ_èû
 = 
ãmp
;

334 
	`nova_Êush_buf„r
(&
∑ú
->
jou∫Æ_hód
, 
CACHELINE_SIZE
, 1);

336 
	`nova_dbgv
("%s: head 0x%llx,Åail 0x%llx\n",

337 
__func__
, 
∑ú
->
jou∫Æ_hód
,Öaú->
jou∫Æ_èû
);

338  
ãmp
;

339 
	}
}

342 
u64
 
	$nova_¸óã_ª«me_å™ß˘i⁄
(
su≥r_block
 *
sb
,

343 
öode
 *
ﬁd_öode
, öodê*
ﬁd_dú
, öodê*
√w_öode
,

344 
öode
 *
√w_dú
, 
nova_díåy
 *
Áthî_íåy
,

345 
övÆid©e_√w_öode
, 
˝u
)

347 
jou∫Æ_±r_∑ú
 *
∑ú
;

348 
u64
 
ãmp
;

350 
∑ú
 = 
	`nova_gë_jou∫Æ_poöãrs
(
sb
, 
˝u
);

351 i‡(
∑ú
->
jou∫Æ_hód
 == 0 ||

352 
∑ú
->
jou∫Æ_hód
 !∑ú->
jou∫Æ_èû
)

353 
	`BUG
();

355 
ãmp
 = 
∑ú
->
jou∫Æ_hód
;

358 
ãmp
 = 
	`nova_≠≥nd_öode_jou∫Æ
(
sb
,Åemp, 
ﬁd_öode
, 0, 0, 0);

361 
ãmp
 = 
	`nova_≠≥nd_öode_jou∫Æ
(
sb
,Åemp, 
ﬁd_dú
, 0, 0, 1);

363 i‡(
√w_öode
) {

365 
ãmp
 = 
	`nova_≠≥nd_öode_jou∫Æ
(
sb
,Åemp, 
√w_öode
, 0,

366 
övÆid©e_√w_öode
, 0);

369 i‡(
√w_dú
)

370 
ãmp
 = 
	`nova_≠≥nd_öode_jou∫Æ
(
sb
,Åemp, 
√w_dú
, 0, 0, 1);

372 i‡(
Áthî_íåy
)

373 
ãmp
 = 
	`nova_≠≥nd_díåy_jou∫Æ
(
sb
,Åemp, 
Áthî_íåy
);

375 
	`nova_Êush_jou∫Æ_ö_b©ch
(
sb
, 
∑ú
->
jou∫Æ_hód
, 
ãmp
);

376 
∑ú
->
jou∫Æ_èû
 = 
ãmp
;

377 
	`nova_Êush_buf„r
(&
∑ú
->
jou∫Æ_hód
, 
CACHELINE_SIZE
, 1);

379 
	`nova_dbgv
("%s: head 0x%llx,Åail 0x%llx\n",

380 
__func__
, 
∑ú
->
jou∫Æ_hód
,Öaú->
jou∫Æ_èû
);

381  
ãmp
;

382 
	}
}

385 
u64
 
	$nova_¸óã_logíåy_å™ß˘i⁄
(
su≥r_block
 *
sb
,

386 *
íåy
, 
nova_íåy_ty≥
 
ty≥
, 
˝u
)

388 
jou∫Æ_±r_∑ú
 *
∑ú
;

389 
size_t
 
size
 = 0;

390 
i
, 
cou¡
;

391 
u64
 
ãmp
;

393 
∑ú
 = 
	`nova_gë_jou∫Æ_poöãrs
(
sb
, 
˝u
);

394 i‡(
∑ú
->
jou∫Æ_hód
 == 0 ||

395 
∑ú
->
jou∫Æ_hód
 !∑ú->
jou∫Æ_èû
)

396 
	`BUG
();

398 
size
 = 
	`nova_gë_log_íåy_size
(
sb
, 
ty≥
);

400 
ãmp
 = 
∑ú
->
jou∫Æ_hód
;

402 
cou¡
 = 
size
 / 8;

403 
i
 = 0; i < 
cou¡
; i++) {

404 
ãmp
 = 
	`nova_≠≥nd_íåy_jou∫Æ
(
sb
,Åemp,

405 (*)
íåy
 + 
i
 * 8);

407 
	`nova_Êush_jou∫Æ_ö_b©ch
(
sb
, 
∑ú
->
jou∫Æ_hód
, 
ãmp
);

408 
∑ú
->
jou∫Æ_èû
 = 
ãmp
;

409 
	`nova_Êush_buf„r
(&
∑ú
->
jou∫Æ_hód
, 
CACHELINE_SIZE
, 1);

411 
	`nova_dbgv
("%s: head 0x%llx,Åail 0x%llx\n",

412 
__func__
, 
∑ú
->
jou∫Æ_hód
,Öaú->
jou∫Æ_èû
);

413  
ãmp
;

414 
	}
}

417 
	$nova_commô_lôe_å™ß˘i⁄
(
su≥r_block
 *
sb
, 
u64
 
èû
, 
˝u
)

419 
jou∫Æ_±r_∑ú
 *
∑ú
;

421 
∑ú
 = 
	`nova_gë_jou∫Æ_poöãrs
(
sb
, 
˝u
);

422 i‡(
∑ú
->
jou∫Æ_èû
 !
èû
)

423 
	`BUG
();

425 
∑ú
->
jou∫Æ_hód
 = 
èû
;

426 
	`nova_Êush_buf„r
(&
∑ú
->
jou∫Æ_hód
, 
CACHELINE_SIZE
, 1);

427 
	}
}

432 
	$nova_lôe_jou∫Æ_so·_öô
(
su≥r_block
 *
sb
)

434 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

435 
jou∫Æ_±r_∑ú
 *
∑ú
;

436 
i
;

437 
ªt
 = 0;

439 
sbi
->
jou∫Æ_locks
 = 
	`kˇŒoc
(sbi->
˝us
, (
•ölock_t
),

440 
GFP_KERNEL
);

441 i‡(!
sbi
->
jou∫Æ_locks
)

442  -
ENOMEM
;

444 
i
 = 0; i < 
sbi
->
˝us
; i++)

445 
	`•ö_lock_öô
(&
sbi
->
jou∫Æ_locks
[
i
]);

447 
i
 = 0; i < 
sbi
->
˝us
; i++) {

448 
∑ú
 = 
	`nova_gë_jou∫Æ_poöãrs
(
sb
, 
i
);

449 i‡(
∑ú
->
jou∫Æ_hód
 =∑ú->
jou∫Æ_èû
)

453 
ªt
 = 
	`nova_check_jou∫Æ_íåõs
(
sb
, 
∑ú
);

454 i‡(
ªt
) {

455 
	`nova_îr
(
sb
, "Jou∫Æ %d checksum faûuª\n", 
i
);

456 
ªt
 = -
EINVAL
;

460 
ªt
 = 
	`nova_ªcovî_lôe_jou∫Æ
(
sb
, 
∑ú
);

463  
ªt
;

464 
	}
}

467 
	$nova_lôe_jou∫Æ_h¨d_öô
(
su≥r_block
 *
sb
)

469 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

470 
nova_öode_öfo_hódî
 
sih
;

471 
jou∫Æ_±r_∑ú
 *
∑ú
;

472 
blockƒ
 = 0;

473 
Æloˇãd
;

474 
i
;

475 
u64
 
block
;

476 
úq_Êags
 = 0;

478 
sih
.
öo
 = 
NOVA_LITEJOURNAL_INO
;

479 
sih
.
i_blk_ty≥
 = 
NOVA_BLOCK_TYPE_4K
;

481 
i
 = 0; i < 
sbi
->
˝us
; i++) {

482 
∑ú
 = 
	`nova_gë_jou∫Æ_poöãrs
(
sb
, 
i
);

484 
Æloˇãd
 = 
	`nova_√w_log_blocks
(
sb
, &
sih
, &
blockƒ
, 1,

485 
ALLOC_INIT_ZERO
, 
ANY_CPU
, 
ALLOC_FROM_HEAD
);

486 
	`nova_dbg_vîbo£
("%s:áŒoˇãÜog @ 0x%lx\n", 
__func__
,

487 
blockƒ
);

488 i‡(
Æloˇãd
 !1 || 
blockƒ
 == 0)

489  -
ENOSPC
;

491 
block
 = 
	`nova_gë_block_off
(
sb
, 
blockƒ
, 
NOVA_BLOCK_TYPE_4K
);

492 
	`nova_memu∆ock_ønge
(
sb
, 
∑ú
, 
CACHELINE_SIZE
, &
úq_Êags
);

493 
∑ú
->
jou∫Æ_hód
 =Öaú->
jou∫Æ_èû
 = 
block
;

494 
	`nova_Êush_buf„r
(
∑ú
, 
CACHELINE_SIZE
, 0);

495 
	`nova_memlock_ønge
(
sb
, 
∑ú
, 
CACHELINE_SIZE
, &
úq_Êags
);

498 
	`PERSISTENT_BARRIER
();

499  
	`nova_lôe_jou∫Æ_so·_öô
(
sb
);

500 
	}
}

	@journal.h

1 #i‚de‡
__JOURNAL_H


2 
	#__JOURNAL_H


	)

4 
	~<löux/ty≥s.h
>

5 
	~<löux/fs.h
>

6 
	~"nova.h
"

7 
	~"su≥r.h
"

12 
	#NOVA_MAX_JOURNAL_LENGTH
 128

	)

14 
	#JOURNAL_INODE
 1

	)

15 
	#JOURNAL_ENTRY
 2

	)

18 
	snova_lôe_jou∫Æ_íåy
 {

19 
__À64
 
	mty≥
;

20 
__À64
 
	md©a1
;

21 
__À64
 
	md©a2
;

22 
__À32
 
	m∑ddög
;

23 
__À32
 
	mcsum
;

24 } 
__©åibuã
((
__∑cked__
));

29 
	sjou∫Æ_±r_∑ú
 {

30 
__À64
 
	mjou∫Æ_hód
;

31 
__À64
 
	mjou∫Æ_èû
;

34 
ölöe


35 
jou∫Æ_±r_∑ú
 *
	$nova_gë_jou∫Æ_poöãrs
(
su≥r_block
 *
sb
,

36 
˝u
)

38 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

40 i‡(
˝u
 >
sbi
->
˝us
)

41 
	`BUG
();

43  (
jou∫Æ_±r_∑ú
 *)((*)
	`nova_gë_block
(
sb
,

44 
NOVA_DEF_BLOCK_SIZE_4K
 * 
JOURNAL_START
Ë+ 
˝u
 * 
CACHELINE_SIZE
);

45 
	}
}

48 
u64
 
nova_¸óã_öode_å™ß˘i⁄
(
su≥r_block
 *
sb
,

49 
öode
 *öode, öodê*
dú
, 
˝u
,

50 
√w_öode
, 
övÆid©e
);

51 
u64
 
nova_¸óã_ª«me_å™ß˘i⁄
(
su≥r_block
 *
sb
,

52 
öode
 *
ﬁd_öode
, öodê*
ﬁd_dú
, öodê*
√w_öode
,

53 
öode
 *
√w_dú
, 
nova_díåy
 *
Áthî_íåy
,

54 
övÆid©e_√w_öode
, 
˝u
);

55 
u64
 
nova_¸óã_logíåy_å™ß˘i⁄
(
su≥r_block
 *
sb
,

56 *
íåy
, 
nova_íåy_ty≥
 
ty≥
, 
˝u
);

57 
nova_commô_lôe_å™ß˘i⁄
(
su≥r_block
 *
sb
, 
u64
 
èû
, 
˝u
);

58 
nova_lôe_jou∫Æ_so·_öô
(
su≥r_block
 *
sb
);

59 
nova_lôe_jou∫Æ_h¨d_öô
(
su≥r_block
 *
sb
);

	@log.c

18 
	~"nova.h
"

19 
	~"jou∫Æ.h
"

20 
	~"öode.h
"

21 
	~"log.h
"

23 
	$nova_execuã_övÆid©e_ªassign_logíåy
(
su≥r_block
 *
sb
,

24 *
íåy
, 
nova_íåy_ty≥
 
ty≥
, 
ªassign
,

25 
num_‰ì
)

27 
nova_fûe_wrôe_íåy
 *
fw_íåy
;

28 
övÆid
 = 0;

30 
ty≥
) {

31 
FILE_WRITE
:

32 
fw_íåy
 = (
nova_fûe_wrôe_íåy
 *)
íåy
;

33 i‡(
ªassign
)

34 
fw_íåy
->
ªassig√d
 = 1;

35 i‡(
num_‰ì
)

36 
fw_íåy
->
övÆid_∑ges
 +
num_‰ì
;

37 i‡(
fw_íåy
->
övÆid_∑ges
 =fw_íåy->
num_∑ges
)

38 
övÆid
 = 1;

40 
DIR_LOG
:

41 i‡(
ªassign
) {

42 ((
nova_díåy
 *)
íåy
)->
ªassig√d
 = 1;

44 ((
nova_díåy
 *)
íåy
)->
övÆid
 = 1;

45 
övÆid
 = 1;

48 
SET_ATTR
:

49 ((
nova_£èâr_logíåy
 *)
íåy
)->
övÆid
 = 1;

50 
övÆid
 = 1;

52 
LINK_CHANGE
:

53 ((
nova_lök_ch™ge_íåy
 *)
íåy
)->
övÆid
 = 1;

54 
övÆid
 = 1;

56 
MMAP_WRITE
:

57 ((
nova_mm≠_íåy
 *)
íåy
)->
övÆid
 = 1;

58 
övÆid
 = 1;

60 
SNAPSHOT_INFO
:

61 ((
nova_¢≠shŸ_öfo_íåy
 *)
íåy
)->
dñëed
 = 1;

62 
övÆid
 = 1;

68 i‡(
övÆid
) {

69 
u64
 
addr
 = 
	`nova_gë_addr_off
(
	`NOVA_SB
(
sb
), 
íåy
);

71 
	`nova_öc_∑ge_övÆid_íåõs
(
sb
, 
addr
);

74 
	`nova_upd©e_íåy_csum
(
íåy
);

76 
	}
}

78 
	$nova_övÆid©e_ªassign_logíåy
(
su≥r_block
 *
sb
,

79 *
íåy
, 
nova_íåy_ty≥
 
ty≥
, 
ªassign
,

80 
num_‰ì
)

82 
úq_Êags
 = 0;

83 
	`nova_memu∆ock_ønge
(
sb
, 
íåy
, 
CACHELINE_SIZE
, &
úq_Êags
);

85 
	`nova_execuã_övÆid©e_ªassign_logíåy
(
sb
, 
íåy
, 
ty≥
,

86 
ªassign
, 
num_‰ì
);

87 
	`nova_upd©e_Æãr_íåy
(
sb
, 
íåy
);

88 
	`nova_memlock_ønge
(
sb
, 
íåy
, 
CACHELINE_SIZE
, &
úq_Êags
);

91 
	}
}

93 
	$nova_övÆid©e_logíåy
(
su≥r_block
 *
sb
, *
íåy
,

94 
nova_íåy_ty≥
 
ty≥
, 
num_‰ì
)

96  
	`nova_övÆid©e_ªassign_logíåy
(
sb
, 
íåy
, 
ty≥
, 0, 
num_‰ì
);

97 
	}
}

99 
	$nova_ªassign_logíåy
(
su≥r_block
 *
sb
, *
íåy
,

100 
nova_íåy_ty≥
 
ty≥
)

102  
	`nova_övÆid©e_ªassign_logíåy
(
sb
, 
íåy
, 
ty≥
, 1, 0);

103 
	}
}

105 
ölöe
 
	$nova_övÆid©e_wrôe_íåy
(
su≥r_block
 *
sb
,

106 
nova_fûe_wrôe_íåy
 *
íåy
, 
ªassign
,

107 
num_‰ì
)

109 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

111 i‡(!
íåy
)

114 i‡(
mëad©a_csum
 == 0)

115 
íåyc
 = 
íåy
;

117 
íåyc
 = &
íåy_c›y
;

118 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

119  -
EIO
;

122 i‡(
num_‰ì
 =0 && 
íåyc
->
ªassig√d
 == 1)

125  
	`nova_övÆid©e_ªassign_logíåy
(
sb
, 
íåy
, 
FILE_WRITE
,

126 
ªassign
, 
num_‰ì
);

127 
	}
}

129 
	$nova_‰ì_ﬁd_íåy
(
su≥r_block
 *
sb
,

130 
nova_öode_öfo_hódî
 *
sih
,

131 
nova_fûe_wrôe_íåy
 *
íåy
,

132 
pgoff
, 
num_‰ì
,

133 
boﬁ
 
dñëe_dód
, 
u64
 
ïoch_id
)

135 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

136 
ﬁd_nvmm
;

137 
ªt
;

138 
	`INIT_TIMING
(
‰ì_time
);

140 i‡(!
íåy
)

143 
	`NOVA_START_TIMING
(
‰ì_ﬁd_t
, 
‰ì_time
);

145 i‡(
mëad©a_csum
 == 0)

146 
íåyc
 = 
íåy
;

148 
íåyc
 = &
íåy_c›y
;

149 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

150  -
EIO
;

153 
ﬁd_nvmm
 = 
	`gë_nvmm
(
sb
, 
sih
, 
íåyc
, 
pgoff
);

155 i‡(!
dñëe_dód
) {

156 
ªt
 = 
	`nova_≠≥nd_d©a_to_¢≠shŸ
(
sb
, 
íåyc
, 
ﬁd_nvmm
,

157 
num_‰ì
, 
ïoch_id
);

158 i‡(
ªt
 == 0) {

159 
	`nova_övÆid©e_wrôe_íåy
(
sb
, 
íåy
, 1, 0);

160 
out
;

163 
	`nova_övÆid©e_wrôe_íåy
(
sb
, 
íåy
, 1, 
num_‰ì
);

166 
	`nova_dbgv
("%s:Ögoff %lu, free %u blocks\n",

167 
__func__
, 
pgoff
, 
num_‰ì
);

168 
	`nova_‰ì_d©a_blocks
(
sb
, 
sih
, 
ﬁd_nvmm
, 
num_‰ì
);

170 
out
:

171 
sih
->
i_blocks
 -
num_‰ì
;

173 
	`NOVA_END_TIMING
(
‰ì_ﬁd_t
, 
‰ì_time
);

174  
num_‰ì
;

175 
	}
}

177 
nova_fûe_wrôe_íåy
 *
	$nova_föd_√xt_íåy
(
su≥r_block
 *
sb
,

178 
nova_öode_öfo_hódî
 *
sih
, 
pgoff_t
 
pgoff
)

180 
nova_fûe_wrôe_íåy
 *
íåy
 = 
NULL
;

181 
nova_fûe_wrôe_íåy
 *
íåõs
[1];

182 
ƒ_íåõs
;

184 
ƒ_íåõs
 = 
	`ødix_åì_g™g_lookup
(&
sih
->
åì
,

185 (**)
íåõs
, 
pgoff
, 1);

186 i‡(
ƒ_íåõs
 == 1)

187 
íåy
 = 
íåõs
[0];

189  
íåy
;

190 
	}
}

196 
	$nova_˛ór_œ°_∑ge_èû
(
su≥r_block
 *
sb
,

197 
öode
 *öode, 
loff_t
 
√wsize
)

199 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

200 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

201 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

202 
off£t
 = 
√wsize
 & (
sb
->
s_blocksize
 - 1);

203 
pgoff
, 
Àngth
;

204 
u64
 
nvmm
;

205 *
nvmm_addr
;

206 
úq_Êags
 = 0;

208 i‡(
off£t
 =0 || 
√wsize
 > 
öode
->
i_size
)

211 
Àngth
 = 
sb
->
s_blocksize
 - 
off£t
;

212 
pgoff
 = 
√wsize
 >> 
sb
->
s_blocksize_bôs
;

214 
nvmm
 = 
	`nova_föd_nvmm_block
(
sb
, 
sih
, 
NULL
, 
pgoff
);

215 i‡(
nvmm
 == 0)

218 
nvmm_addr
 = (*)
	`nova_gë_block
(
sb
, 
nvmm
);

219 
	`nova_memu∆ock_ønge
(
sb
, 
nvmm_addr
 + 
off£t
, 
Àngth
, &
úq_Êags
);

220 
	`mem˝y_to_pmem_noˇche
(
nvmm_addr
 + 
off£t
, 
sbi
->
zî€d_∑ge
, 
Àngth
);

221 
	`nova_memlock_ønge
(
sb
, 
nvmm_addr
 + 
off£t
, 
Àngth
, &
úq_Êags
);

223 i‡(
d©a_csum
 > 0)

224 
	`nova_upd©e_åunˇãd_block_csum
(
sb
, 
öode
, 
√wsize
);

225 i‡(
d©a_∑rôy
 > 0)

226 
	`nova_upd©e_åunˇãd_block_∑rôy
(
sb
, 
öode
, 
√wsize
);

227 
	}
}

229 
	$nova_upd©e_£èâr_íåy
(
öode
 *inode,

230 
nova_£èâr_logíåy
 *
íåy
,

231 
nova_log_íåy_öfo
 *
íåy_öfo
)

233 
üâr
 *
©å
 = 
íåy_öfo
->attr;

234 
ü_vÆid
 = 
©å
->ü_vÆid, 
©å_mask
;

237 
©å_mask
 = 
ATTR_MODE
 | 
ATTR_UID
 | 
ATTR_GID
 | 
ATTR_SIZE
 |

238 
ATTR_ATIME
 | 
ATTR_MTIME
 | 
ATTR_CTIME
;

240 
íåy
->
íåy_ty≥
 = 
SET_ATTR
;

241 
íåy
->
©å
 = 
ü_vÆid
 & 
©å_mask
;

242 
íåy
->
mode
 = 
	`˝u_to_À16
(
öode
->
i_mode
);

243 
íåy
->
uid
 = 
	`˝u_to_À32
(
	`i_uid_ªad
(
öode
));

244 
íåy
->
gid
 = 
	`˝u_to_À32
(
	`i_gid_ªad
(
öode
));

245 
íåy
->
©ime
 = 
	`˝u_to_À32
(
öode
->
i_©ime
.
tv_£c
);

247 
íåy
->
˘ime
 = 
	`˝u_to_À32
(
	`öode_gë_˘ime_£c
(
öode
));

249 
íåy
->
mtime
 = 
	`˝u_to_À32
(
öode
->
i_mtime
.
tv_£c
);

250 
íåy
->
ïoch_id
 = 
	`˝u_to_À64
(
íåy_öfo
->epoch_id);

251 
íåy
->
å™s_id
 = 
	`˝u_to_À64
(
íåy_öfo
->trans_id);

252 
íåy
->
övÆid
 = 0;

254 i‡(
ü_vÆid
 & 
ATTR_SIZE
)

255 
íåy
->
size
 = 
	`˝u_to_À64
(
©å
->
ü_size
);

257 
íåy
->
size
 = 
	`˝u_to_À64
(
öode
->
i_size
);

259 
	`nova_upd©e_íåy_csum
(
íåy
);

260 
	}
}

262 
	$nova_upd©e_lök_ch™ge_íåy
(
öode
 *inode,

263 
nova_lök_ch™ge_íåy
 *
íåy
,

264 
nova_log_íåy_öfo
 *
íåy_öfo
)

266 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

267 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

269 
íåy
->
íåy_ty≥
 = 
LINK_CHANGE
;

270 
íåy
->
ïoch_id
 = 
	`˝u_to_À64
(
íåy_öfo
->epoch_id);

271 
íåy
->
å™s_id
 = 
	`˝u_to_À64
(
íåy_öfo
->trans_id);

272 
íåy
->
övÆid
 = 0;

273 
íåy
->
löks
 = 
	`˝u_to_À16
(
öode
->
i_∆ök
);

275 
íåy
->
˘ime
 = 
	`˝u_to_À32
(
	`öode_gë_˘ime_£c
(
öode
));

277 
íåy
->
Êags
 = 
	`˝u_to_À32
(
sih
->
i_Êags
);

278 
íåy
->
gíî©i⁄
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

280 
	`nova_upd©e_íåy_csum
(
íåy
);

281 
	}
}

283 
	$nova_upd©e_wrôe_íåy
(
su≥r_block
 *
sb
,

284 
nova_fûe_wrôe_íåy
 *
íåy
,

285 
nova_log_íåy_öfo
 *
íåy_öfo
)

287 
íåy
->
ïoch_id
 = 
	`˝u_to_À64
(
íåy_öfo
->epoch_id);

288 
íåy
->
å™s_id
 = 
	`˝u_to_À64
(
íåy_öfo
->trans_id);

289 
íåy
->
mtime
 = 
	`˝u_to_À32
(
íåy_öfo
->
time
);

290 
íåy
->
size
 = 
	`˝u_to_À64
(
íåy_öfo
->
fûe_size
);

291 
íåy
->
upd©ög
 = 0;

292 
	`nova_upd©e_íåy_csum
(
íåy
);

294 
	}
}

296 
	$nova_upd©e_ﬁd_díåy
(
su≥r_block
 *
sb
,

297 
öode
 *
dú
, 
nova_díåy
 *
díåy
,

298 
nova_log_íåy_öfo
 *
íåy_öfo
)

300 
löks_cou¡
;

301 
lök_ch™ge
 = 
íåy_öfo
->link_change;

302 
u64
 
addr
;

304 
díåy
->
ïoch_id
 = 
íåy_öfo
->epoch_id;

305 
díåy
->
å™s_id
 = 
íåy_öfo
->trans_id;

307 
díåy
->
öo
 = 
	`˝u_to_À64
(0);

308 
díåy
->
övÆid
 = 1;

309 
díåy
->
mtime
 = 
	`˝u_to_À32
(
dú
->
i_mtime
.
tv_£c
);

311 
löks_cou¡
 = 
	`˝u_to_À16
(
dú
->
i_∆ök
);

312 i‡(
löks_cou¡
 =0 && 
lök_ch™ge
 == -1)

313 
löks_cou¡
 = 0;

315 
löks_cou¡
 +
lök_ch™ge
;

316 
díåy
->
löks_cou¡
 = 
	`˝u_to_À16
(links_count);

318 
addr
 = 
	`nova_gë_addr_off
(
	`NOVA_SB
(
sb
), 
díåy
);

319 
	`nova_öc_∑ge_övÆid_íåõs
(
sb
, 
addr
);

322 
	`nova_upd©e_íåy_csum
(
díåy
);

325 
	}
}

327 
	$nova_upd©e_√w_díåy
(
su≥r_block
 *
sb
,

328 
öode
 *
dú
, 
nova_díåy
 *
íåy
,

329 
nova_log_íåy_öfo
 *
íåy_öfo
)

331 
díåy
 *díåy = 
íåy_öfo
->
d©a
;

332 
löks_cou¡
;

333 
lök_ch™ge
 = 
íåy_öfo
->link_change;

335 
íåy
->
íåy_ty≥
 = 
DIR_LOG
;

336 
íåy
->
ïoch_id
 = 
íåy_öfo
->epoch_id;

337 
íåy
->
å™s_id
 = 
íåy_öfo
->trans_id;

338 
íåy
->
öo
 = 
íåy_öfo
->ino;

339 
íåy
->
«me_Àn
 = 
díåy
->
d_«me
.
Àn
;

340 
	`mem˝y_to_pmem_noˇche
(
íåy
->
«me
, 
díåy
->
d_«me
.name,

341 
díåy
->
d_«me
.
Àn
);

342 
íåy
->
«me
[
díåy
->
d_«me
.
Àn
] = '\0';

343 
íåy
->
mtime
 = 
	`˝u_to_À32
(
dú
->
i_mtime
.
tv_£c
);

346 
löks_cou¡
 = 
	`˝u_to_À16
(
dú
->
i_∆ök
);

347 i‡(
löks_cou¡
 =0 && 
lök_ch™ge
 == -1)

348 
löks_cou¡
 = 0;

350 
löks_cou¡
 +
lök_ch™ge
;

351 
íåy
->
löks_cou¡
 = 
	`˝u_to_À16
(links_count);

354 
íåy
->
de_Àn
 = 
	`˝u_to_À16
(
íåy_öfo
->
fûe_size
);

357 
	`nova_upd©e_íåy_csum
(
íåy
);

360 
	}
}

362 
	$nova_upd©e_log_íåy
(
su≥r_block
 *
sb
, 
öode
 *inode,

363 *
íåy
, 
nova_log_íåy_öfo
 *
íåy_öfo
)

365 
nova_íåy_ty≥
 
ty≥
 = 
íåy_öfo
->type;

367 
ty≥
) {

368 
FILE_WRITE
:

369 i‡(
íåy_öfo
->
ö∂a˚
)

370 
	`nova_upd©e_wrôe_íåy
(
sb
, 
íåy
, 
íåy_öfo
);

372 
	`mem˝y_to_pmem_noˇche
(
íåy
, 
íåy_öfo
->
d©a
,

373 (
nova_fûe_wrôe_íåy
));

375 
DIR_LOG
:

376 i‡(
íåy_öfo
->
ö∂a˚
)

377 
	`nova_upd©e_ﬁd_díåy
(
sb
, 
öode
, 
íåy
, 
íåy_öfo
);

379 
	`nova_upd©e_√w_díåy
(
sb
, 
öode
, 
íåy
, 
íåy_öfo
);

381 
SET_ATTR
:

382 
	`nova_upd©e_£èâr_íåy
(
öode
, 
íåy
, 
íåy_öfo
);

384 
LINK_CHANGE
:

385 
	`nova_upd©e_lök_ch™ge_íåy
(
öode
, 
íåy
, 
íåy_öfo
);

387 
MMAP_WRITE
:

388 
	`mem˝y_to_pmem_noˇche
(
íåy
, 
íåy_öfo
->
d©a
,

389 (
nova_mm≠_íåy
));

391 
SNAPSHOT_INFO
:

392 
	`mem˝y_to_pmem_noˇche
(
íåy
, 
íåy_öfo
->
d©a
,

393 (
nova_¢≠shŸ_öfo_íåy
));

400 
	}
}

402 
	$nova_≠≥nd_log_íåy
(
su≥r_block
 *
sb
,

403 
nova_öode
 *
pi
, 
öode
 *inode,

404 
nova_öode_öfo_hódî
 *
sih
,

405 
nova_log_íåy_öfo
 *
íåy_öfo
)

407 *
íåy
, *
Æãr_íåy
;

408 
nova_íåy_ty≥
 
ty≥
 = 
íåy_öfo
->type;

409 
nova_öode_upd©e
 *
upd©e
 = 
íåy_öfo
->update;

410 
u64
 
èû
, 
Æãr_èû
;

411 
u64
 
cuº_p
, 
Æãr_cuº_p
;

412 
size_t
 
size
;

413 
exãnded
 = 0;

414 
úq_Êags
 = 0;

416 i‡(
ty≥
 =
DIR_LOG
)

417 
size
 = 
íåy_öfo
->
fûe_size
;

419 
size
 = 
	`nova_gë_log_íåy_size
(
sb
, 
ty≥
);

421 
èû
 = 
upd©e
->tail;

422 
Æãr_èû
 = 
upd©e
->alter_tail;

424 
cuº_p
 = 
	`nova_gë_≠≥nd_hód
(
sb
, 
pi
, 
sih
, 
èû
, 
size
,

425 
MAIN_LOG
, 0, &
exãnded
);

426 i‡(
cuº_p
 == 0)

427  -
ENOSPC
;

429 
	`nova_dbg_vîbo£
("%s: inode %luáttr changeÉntry @ 0x%llx\n",

430 
__func__
, 
sih
->
öo
, 
cuº_p
);

432 
íåy
 = 
	`nova_gë_block
(
sb
, 
cuº_p
);

434 
	`nova_memu∆ock_ønge
(
sb
, 
íåy
, 
size
, &
úq_Êags
);

435 
	`mem£t
(
íåy
, 0, 
size
);

436 
	`nova_upd©e_log_íåy
(
sb
, 
öode
, 
íåy
, 
íåy_öfo
);

437 
	`nova_öc_∑ge_num_íåõs
(
sb
, 
cuº_p
);

438 
	`nova_memlock_ønge
(
sb
, 
íåy
, 
size
, &
úq_Êags
);

439 
upd©e
->
cuº_íåy
 = 
cuº_p
;

440 
upd©e
->
èû
 = 
cuº_p
 + 
size
;

442 i‡(
mëad©a_csum
) {

443 
Æãr_cuº_p
 = 
	`nova_gë_≠≥nd_hód
(
sb
, 
pi
, 
sih
, 
Æãr_èû
,

444 
size
, 
ALTER_LOG
, 0, &
exãnded
);

445 i‡(
Æãr_cuº_p
 == 0)

446  -
ENOSPC
;

448 
Æãr_íåy
 = 
	`nova_gë_block
(
sb
, 
Æãr_cuº_p
);

449 
	`nova_memu∆ock_ønge
(
sb
, 
Æãr_íåy
, 
size
, &
úq_Êags
);

450 
	`mem£t
(
Æãr_íåy
, 0, 
size
);

451 
	`nova_upd©e_log_íåy
(
sb
, 
öode
, 
Æãr_íåy
, 
íåy_öfo
);

452 
	`nova_memlock_ønge
(
sb
, 
Æãr_íåy
, 
size
, &
úq_Êags
);

454 
upd©e
->
Æãr_íåy
 = 
Æãr_cuº_p
;

455 
upd©e
->
Æãr_èû
 = 
Æãr_cuº_p
 + 
size
;

458 
íåy_öfo
->
cuº_p
 = curr_p;

460 
	}
}

462 
	$nova_ö∂a˚_upd©e_log_íåy
(
su≥r_block
 *
sb
,

463 
öode
 *öode, *
íåy
,

464 
nova_log_íåy_öfo
 *
íåy_öfo
)

466 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

467 
nova_íåy_ty≥
 
ty≥
 = 
íåy_öfo
->type;

468 
u64
 
jou∫Æ_èû
;

469 
size_t
 
size
;

470 
˝u
;

471 
úq_Êags
 = 0;

472 
	`INIT_TIMING
(
upd©e_time
);

474 
	`NOVA_START_TIMING
(
upd©e_íåy_t
, 
upd©e_time
);

475 
size
 = 
	`nova_gë_log_íåy_size
(
sb
, 
ty≥
);

477 i‡(
mëad©a_csum
) {

478 
	`nova_memu∆ock_ønge
(
sb
, 
íåy
, 
size
, &
úq_Êags
);

479 
	`nova_upd©e_log_íåy
(
sb
, 
öode
, 
íåy
, 
íåy_öfo
);

481 
	`nova_upd©e_Æãr_íåy
(
sb
, 
íåy
);

482 
	`nova_memlock_ønge
(
sb
, 
íåy
, 
size
, &
úq_Êags
);

483 
out
;

486 
˝u
 = 
	`nova_gë_˝uid
(
sb
);

487 
	`•ö_lock
(&
sbi
->
jou∫Æ_locks
[
˝u
]);

488 
	`nova_memu∆ock_jou∫Æ
(
sb
, &
úq_Êags
);

489 
jou∫Æ_èû
 = 
	`nova_¸óã_logíåy_å™ß˘i⁄
(
sb
, 
íåy
, 
ty≥
, 
˝u
);

490 
	`nova_upd©e_log_íåy
(
sb
, 
öode
, 
íåy
, 
íåy_öfo
);

492 
	`PERSISTENT_BARRIER
();

494 
	`nova_commô_lôe_å™ß˘i⁄
(
sb
, 
jou∫Æ_èû
, 
˝u
);

495 
	`nova_memlock_jou∫Æ
(
sb
, &
úq_Êags
);

496 
	`•ö_u∆ock
(&
sbi
->
jou∫Æ_locks
[
˝u
]);

497 
out
:

498 
	`NOVA_END_TIMING
(
upd©e_íåy_t
, 
upd©e_time
);

500 
	}
}

503 
	$nova_≠≥nd_£èâr_íåy
(
su≥r_block
 *
sb
,

504 
nova_öode
 *
pi
, 
öode
 *öode, 
üâr
 *
©å
,

505 
nova_öode_upd©e
 *
upd©e
, 
u64
 *
œ°_£èâr
, u64 
ïoch_id
)

507 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

508 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

509 
nova_öode
 
öode_c›y
;

510 
nova_log_íåy_öfo
 
íåy_öfo
;

511 
	`INIT_TIMING
(
≠≥nd_time
);

512 
ªt
;

514 
	`NOVA_START_TIMING
(
≠≥nd_£èâr_t
, 
≠≥nd_time
);

515 
íåy_öfo
.
ty≥
 = 
SET_ATTR
;

516 
íåy_öfo
.
©å
 =áttr;

517 
íåy_öfo
.
upd©e
 = update;

518 
íåy_öfo
.
ïoch_id
 =Époch_id;

519 
íåy_öfo
.
å™s_id
 = 
sih
->trans_id;

521 i‡(
	`nova_check_öode_öãgrôy
(
sb
, 
sih
->
öo
, sih->
pi_addr
,

522 
sih
->
Æãr_pi_addr
, &
öode_c›y
, 0) < 0) {

523 
ªt
 = -
EIO
;

524 
out
;

527 
ªt
 = 
	`nova_≠≥nd_log_íåy
(
sb
, 
pi
, 
öode
, 
sih
, &
íåy_öfo
);

528 i‡(
ªt
) {

529 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

530 
out
;

533 *
œ°_£èâr
 = 
sih
->last_setattr;

534 
sih
->
œ°_£èâr
 = 
íåy_öfo
.
cuº_p
;

536 
out
:

537 
	`NOVA_END_TIMING
(
≠≥nd_£èâr_t
, 
≠≥nd_time
);

538  
ªt
;

539 
	}
}

542 
	$nova_övÆid©e_£èâr_íåy
(
su≥r_block
 *
sb
,

543 
u64
 
œ°_£èâr
)

545 
nova_£èâr_logíåy
 *
ﬁd_íåy
;

546 
nova_£èâr_logíåy
 *
ﬁd_íåyc
, 
ﬁd_íåy_c›y
;

547 *
addr
;

548 
ªt
;

550 
addr
 = (*)
	`nova_gë_block
(
sb
, 
œ°_£èâr
);

551 
ﬁd_íåy
 = (
nova_£èâr_logíåy
 *)
addr
;

553 i‡(
mëad©a_csum
 == 0)

554 
ﬁd_íåyc
 = 
ﬁd_íåy
;

556 
ﬁd_íåyc
 = &
ﬁd_íåy_c›y
;

557 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
ﬁd_íåy
, 
ﬁd_íåyc
))

558  -
EIO
;

562 i‡(!
	`ﬁd_íåy_‰ìabÀ
(
sb
, 
ﬁd_íåyc
->
ïoch_id
) ||

563 (
ﬁd_íåyc
->
©å
 & 
ATTR_SIZE
))

566 
ªt
 = 
	`nova_övÆid©e_logíåy
(
sb
, 
ﬁd_íåy
, 
SET_ATTR
, 0);

568  
ªt
;

569 
	}
}

572 
	$£èâr_c›y_to_nova_öode
(
su≥r_block
 *
sb
,

573 
öode
 *öode, 
nova_öode
 *
pi
, 
u64
 
ïoch_id
)

575 
pi
->
i_mode
 = 
	`˝u_to_À16
(
öode
->i_mode);

576 
pi
->
i_uid
 = 
	`˝u_to_À32
(
	`i_uid_ªad
(
öode
));

577 
pi
->
i_gid
 = 
	`˝u_to_À32
(
	`i_gid_ªad
(
öode
));

578 
pi
->
i_©ime
 = 
	`˝u_to_À32
(
öode
->i_©ime.
tv_£c
);

579 
pi
->
i_˘ime
 = 
	`˝u_to_À32
(
öode
->i_˘ime.
tv_£c
);

580 
pi
->
i_mtime
 = 
	`˝u_to_À32
(
öode
->i_mtime.
tv_£c
);

581 
pi
->
¸óã_ïoch_id
 = 
ïoch_id
;

583 
	`nova_upd©e_Æãr_öode
(
sb
, 
öode
, 
pi
);

584 
	}
}

587 
	$nova_ˇn_ö∂a˚_upd©e_£èâr
(
su≥r_block
 *
sb
,

588 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
ïoch_id
)

590 
u64
 
œ°_log
 = 0;

591 
nova_£èâr_logíåy
 *
íåy
 = 
NULL
;

593 
œ°_log
 = 
sih
->
œ°_£èâr
;

594 i‡(
œ°_log
) {

595 
íåy
 = (
nova_£èâr_logíåy
 *)
	`nova_gë_block
(
sb
,

596 
œ°_log
);

598 i‡(
íåy
->
©å
 & 
ATTR_SIZE
)

600 i‡(
íåy
->
ïoch_id
 ==Époch_id)

605 
	}
}

607 
	$nova_ö∂a˚_upd©e_£èâr_íåy
(
su≥r_block
 *
sb
,

608 
öode
 *öode, 
nova_öode_öfo_hódî
 *
sih
,

609 
üâr
 *
©å
, 
u64
 
ïoch_id
)

611 
nova_£èâr_logíåy
 *
íåy
 = 
NULL
;

612 
nova_log_íåy_öfo
 
íåy_öfo
;

613 
u64
 
œ°_log
 = 0;

615 
	`nova_dbgv
("%s : ModifyingÜastÜogÉntry for inode %lu\n",

616 
__func__
, 
öode
->
i_öo
);

617 
œ°_log
 = 
sih
->
œ°_£èâr
;

618 
íåy
 = (
nova_£èâr_logíåy
 *)
	`nova_gë_block
(
sb
,

619 
œ°_log
);

621 
íåy_öfo
.
ty≥
 = 
SET_ATTR
;

622 
íåy_öfo
.
©å
 =áttr;

623 
íåy_öfo
.
ïoch_id
 =Époch_id;

624 
íåy_öfo
.
å™s_id
 = 
sih
->trans_id;

626  
	`nova_ö∂a˚_upd©e_log_íåy
(
sb
, 
öode
, 
íåy
,

627 &
íåy_öfo
);

628 
	}
}

630 
	$nova_h™dÀ_£èâr_›î©i⁄
(
su≥r_block
 *
sb
, 
öode
 *inode,

631 
nova_öode
 *
pi
, 
ü_vÆid
, 
üâr
 *
©å
,

632 
u64
 
ïoch_id
)

634 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

635 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

636 
nova_öode_upd©e
 
upd©e
;

637 
u64
 
œ°_£èâr
 = 0;

638 
ªt
;

639 
úq_Êags
 = 0;

641 i‡(
ü_vÆid
 & 
ATTR_MODE
)

642 
sih
->
i_mode
 = 
öode
->i_mode;

651 i‡(!(
ü_vÆid
 & 
ATTR_SIZE
) &&

652 
	`nova_ˇn_ö∂a˚_upd©e_£èâr
(
sb
, 
sih
, 
ïoch_id
)) {

653 
	`nova_ö∂a˚_upd©e_£èâr_íåy
(
sb
, 
öode
, 
sih
,

654 
©å
, 
ïoch_id
);

657 
	`nova_dbgv
("%s : AppendingÜastÜogÉntry for inode ino = %lu\n",

658 
__func__
, 
öode
->
i_öo
);

659 
upd©e
.
èû
 = upd©e.
Æãr_èû
 = 0;

660 
ªt
 = 
	`nova_≠≥nd_£èâr_íåy
(
sb
, 
pi
, 
öode
, 
©å
, &
upd©e
,

661 &
œ°_£èâr
, 
ïoch_id
);

662 i‡(
ªt
) {

663 
	`nova_dbg
("%s:áppend setattrÉntry failure\n",

664 
__func__
);

665  
ªt
;

668 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

669 
	`nova_upd©e_öode
(
sb
, 
öode
, 
pi
, &
upd©e
, 1);

670 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

674 i‡(
œ°_£èâr
)

675 
	`nova_övÆid©e_£èâr_íåy
(
sb
, 
œ°_£èâr
);

678 
	}
}

681 
	$nova_övÆid©e_lök_ch™ge_íåy
(
su≥r_block
 *
sb
,

682 
u64
 
ﬁd_lök_ch™ge
)

684 
nova_lök_ch™ge_íåy
 *
ﬁd_íåy
;

685 
nova_lök_ch™ge_íåy
 *
ﬁd_íåyc
, 
ﬁd_íåy_c›y
;

686 *
addr
;

687 
ªt
;

689 i‡(
ﬁd_lök_ch™ge
 == 0)

692 
addr
 = (*)
	`nova_gë_block
(
sb
, 
ﬁd_lök_ch™ge
);

693 
ﬁd_íåy
 = (
nova_lök_ch™ge_íåy
 *)
addr
;

695 i‡(
mëad©a_csum
 == 0)

696 
ﬁd_íåyc
 = 
ﬁd_íåy
;

698 
ﬁd_íåyc
 = &
ﬁd_íåy_c›y
;

699 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
ﬁd_íåy
, 
ﬁd_íåyc
))

700  -
EIO
;

703 i‡(!
	`ﬁd_íåy_‰ìabÀ
(
sb
, 
ﬁd_íåyc
->
ïoch_id
))

706 
ªt
 = 
	`nova_övÆid©e_logíåy
(
sb
, 
ﬁd_íåy
, 
LINK_CHANGE
, 0);

708  
ªt
;

709 
	}
}

711 
	$nova_ˇn_ö∂a˚_upd©e_l˚¡ry
(
su≥r_block
 *
sb
,

712 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
ïoch_id
)

714 
u64
 
œ°_log
 = 0;

715 
nova_lök_ch™ge_íåy
 *
íåy
 = 
NULL
;

717 
œ°_log
 = 
sih
->
œ°_lök_ch™ge
;

718 i‡(
œ°_log
) {

719 
íåy
 = (
nova_lök_ch™ge_íåy
 *)
	`nova_gë_block
(
sb
,

720 
œ°_log
);

721 i‡(
íåy
->
ïoch_id
 ==Époch_id)

726 
	}
}

728 
	$nova_ö∂a˚_upd©e_l˚¡ry
(
su≥r_block
 *
sb
,

729 
öode
 *öode, 
nova_öode_öfo_hódî
 *
sih
,

730 
u64
 
ïoch_id
)

732 
nova_lök_ch™ge_íåy
 *
íåy
 = 
NULL
;

733 
nova_log_íåy_öfo
 
íåy_öfo
;

734 
u64
 
œ°_log
 = 0;

736 
œ°_log
 = 
sih
->
œ°_lök_ch™ge
;

737 
íåy
 = (
nova_lök_ch™ge_íåy
 *)
	`nova_gë_block
(
sb
,

738 
œ°_log
);

740 
íåy_öfo
.
ty≥
 = 
LINK_CHANGE
;

741 
íåy_öfo
.
ïoch_id
 =Époch_id;

742 
íåy_öfo
.
å™s_id
 = 
sih
->trans_id;

744  
	`nova_ö∂a˚_upd©e_log_íåy
(
sb
, 
öode
, 
íåy
,

745 &
íåy_öfo
);

746 
	}
}

749 
	$nova_≠≥nd_lök_ch™ge_íåy
(
su≥r_block
 *
sb
,

750 
nova_öode
 *
pi
, 
öode
 *inode,

751 
nova_öode_upd©e
 *
upd©e
, 
u64
 *
ﬁd_lökc
, u64 
ïoch_id
)

753 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

754 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

755 
nova_öode
 
öode_c›y
;

756 
nova_log_íåy_öfo
 
íåy_öfo
;

757 
ªt
 = 0;

758 
	`INIT_TIMING
(
≠≥nd_time
);

760 
	`NOVA_START_TIMING
(
≠≥nd_lök_ch™ge_t
, 
≠≥nd_time
);

762 i‡(
	`nova_check_öode_öãgrôy
(
sb
, 
sih
->
öo
, sih->
pi_addr
,

763 
sih
->
Æãr_pi_addr
, &
öode_c›y
, 0) < 0) {

764 
ªt
 = -
EIO
;

765 
out
;

768 i‡(
	`nova_ˇn_ö∂a˚_upd©e_l˚¡ry
(
sb
, 
sih
, 
ïoch_id
)) {

769 
	`nova_ö∂a˚_upd©e_l˚¡ry
(
sb
, 
öode
, 
sih
, 
ïoch_id
);

770 
upd©e
->
èû
 = 
sih
->
log_èû
;

771 
upd©e
->
Æãr_èû
 = 
sih
->
Æãr_log_èû
;

773 *
ﬁd_lökc
 = 0;

774 
sih
->
å™s_id
++;

775 
out
;

778 
íåy_öfo
.
ty≥
 = 
LINK_CHANGE
;

779 
íåy_öfo
.
upd©e
 = update;

780 
íåy_öfo
.
ïoch_id
 =Époch_id;

781 
íåy_öfo
.
å™s_id
 = 
sih
->trans_id;

783 
ªt
 = 
	`nova_≠≥nd_log_íåy
(
sb
, 
pi
, 
öode
, 
sih
, &
íåy_öfo
);

784 i‡(
ªt
) {

785 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

786 
out
;

789 *
ﬁd_lökc
 = 
sih
->
œ°_lök_ch™ge
;

790 
sih
->
œ°_lök_ch™ge
 = 
íåy_öfo
.
cuº_p
;

791 
sih
->
å™s_id
++;

792 
out
:

793 
	`NOVA_END_TIMING
(
≠≥nd_lök_ch™ge_t
, 
≠≥nd_time
);

794  
ªt
;

795 
	}
}

797 
	$nova_assign_wrôe_íåy
(
su≥r_block
 *
sb
,

798 
nova_öode_öfo_hódî
 *
sih
,

799 
nova_fûe_wrôe_íåy
 *
íåy
,

800 
nova_fûe_wrôe_íåy
 *
íåyc
,

801 
boﬁ
 
‰ì
)

803 
nova_fûe_wrôe_íåy
 *
ﬁd_íåy
;

804 
nova_fûe_wrôe_íåy
 *
°¨t_ﬁd_íåy
 = 
NULL
;

805 **
≥¡ry
;

806 
°¨t_pgoff
 = 
íåyc
->
pgoff
;

807 
°¨t_ﬁd_pgoff
 = 0;

808 
num
 = 
íåyc
->
num_∑ges
;

809 
num_‰ì
 = 0;

810 
cuº_pgoff
;

811 
i
;

812 
ªt
 = 0;

813 
	`INIT_TIMING
(
assign_time
);

815 
	`NOVA_START_TIMING
(
assign_t
, 
assign_time
);

816 
i
 = 0; i < 
num
; i++) {

817 
cuº_pgoff
 = 
°¨t_pgoff
 + 
i
;

819 
≥¡ry
 = 
	`ødix_åì_lookup_¶Ÿ
(&
sih
->
åì
, 
cuº_pgoff
);

820 i‡(
≥¡ry
) {

821 
ﬁd_íåy
 = 
	`ødix_åì_dîef_¶Ÿ
(
≥¡ry
);

822 i‡(
ﬁd_íåy
 !
°¨t_ﬁd_íåy
) {

823 i‡(
°¨t_ﬁd_íåy
 && 
‰ì
)

824 
	`nova_‰ì_ﬁd_íåy
(
sb
, 
sih
,

825 
°¨t_ﬁd_íåy
,

826 
°¨t_ﬁd_pgoff
,

827 
num_‰ì
, 
Ál£
,

828 
íåyc
->
ïoch_id
);

829 
	`nova_övÆid©e_wrôe_íåy
(
sb
,

830 
°¨t_ﬁd_íåy
, 1, 0);

832 
°¨t_ﬁd_íåy
 = 
ﬁd_íåy
;

833 
°¨t_ﬁd_pgoff
 = 
cuº_pgoff
;

834 
num_‰ì
 = 1;

836 
num_‰ì
++;

839 
	`ødix_åì_ª∂a˚_¶Ÿ
(&
sih
->
åì
, 
≥¡ry
, 
íåy
);

841 
ªt
 = 
	`ødix_åì_ö£π
(&
sih
->
åì
, 
cuº_pgoff
, 
íåy
);

842 i‡(
ªt
) {

843 
	`nova_dbg
("%s: ERROR %d\n", 
__func__
, 
ªt
);

844 
out
;

849 i‡(
°¨t_ﬁd_íåy
 && 
‰ì
)

850 
	`nova_‰ì_ﬁd_íåy
(
sb
, 
sih
, 
°¨t_ﬁd_íåy
,

851 
°¨t_ﬁd_pgoff
, 
num_‰ì
, 
Ál£
,

852 
íåyc
->
ïoch_id
);

854 
	`nova_övÆid©e_wrôe_íåy
(
sb
, 
°¨t_ﬁd_íåy
, 1, 0);

856 
out
:

857 
	`NOVA_END_TIMING
(
assign_t
, 
assign_time
);

859  
ªt
;

860 
	}
}

862 
	$nova_ö∂a˚_upd©e_wrôe_íåy
(
su≥r_block
 *
sb
,

863 
öode
 *öode, 
nova_fûe_wrôe_íåy
 *
íåy
,

864 
nova_log_íåy_öfo
 *
íåy_öfo
)

866  
	`nova_ö∂a˚_upd©e_log_íåy
(
sb
, 
öode
, 
íåy
,

867 
íåy_öfo
);

868 
	}
}

870 
	$nova_£t_wrôe_íåy_upd©ög
(
su≥r_block
 *
sb
,

871 
nova_fûe_wrôe_íåy
 *
íåy
, 
£t
)

873 
úq_Êags
 = 0;

874 
	`nova_memu∆ock_ønge
(
sb
, 
íåy
, (*íåy), &
úq_Êags
);

875 
íåy
->
upd©ög
 = 
£t
 ? 1 : 0;

876 
	`nova_upd©e_íåy_csum
(
íåy
);

877 
	`nova_upd©e_Æãr_íåy
(
sb
, 
íåy
);

878 
	`nova_memlock_ønge
(
sb
, 
íåy
, (*íåy), &
úq_Êags
);

881 
	}
}

889 
	$nova_≠≥nd_fûe_wrôe_íåy
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

890 
öode
 *öode, 
nova_fûe_wrôe_íåy
 *
d©a
,

891 
nova_öode_upd©e
 *
upd©e
)

893 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

894 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

895 
nova_log_íåy_öfo
 
íåy_öfo
;

896 
	`INIT_TIMING
(
≠≥nd_time
);

897 
ªt
;

899 
	`NOVA_START_TIMING
(
≠≥nd_fûe_íåy_t
, 
≠≥nd_time
);

901 
	`nova_upd©e_íåy_csum
(
d©a
);

903 
íåy_öfo
.
ty≥
 = 
FILE_WRITE
;

904 
íåy_öfo
.
upd©e
 = update;

905 
íåy_öfo
.
d©a
 = data;

906 
íåy_öfo
.
ïoch_id
 = 
d©a
->epoch_id;

907 
íåy_öfo
.
å™s_id
 = 
d©a
->trans_id;

908 
íåy_öfo
.
ö∂a˚
 = 0;

910 
ªt
 = 
	`nova_≠≥nd_log_íåy
(
sb
, 
pi
, 
öode
, 
sih
, &
íåy_öfo
);

911 i‡(
ªt
)

912 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

914 
	`NOVA_END_TIMING
(
≠≥nd_fûe_íåy_t
, 
≠≥nd_time
);

915  
ªt
;

916 
	}
}

918 
	$nova_≠≥nd_mm≠_íåy
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

919 
öode
 *öode, 
nova_mm≠_íåy
 *
d©a
,

920 
nova_öode_upd©e
 *
upd©e
, 
vma_ôem
 *
ôem
)

922 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

923 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

924 
nova_öode
 
öode_c›y
;

925 
nova_log_íåy_öfo
 
íåy_öfo
;

926 
	`INIT_TIMING
(
≠≥nd_time
);

927 
ªt
;

929 
	`NOVA_START_TIMING
(
≠≥nd_mm≠_íåy_t
, 
≠≥nd_time
);

931 
	`nova_upd©e_íåy_csum
(
d©a
);

933 
íåy_öfo
.
ty≥
 = 
MMAP_WRITE
;

934 
íåy_öfo
.
upd©e
 = update;

935 
íåy_öfo
.
d©a
 = data;

936 
íåy_öfo
.
ïoch_id
 = 
d©a
->epoch_id;

938 i‡(
	`nova_check_öode_öãgrôy
(
sb
, 
sih
->
öo
, sih->
pi_addr
,

939 
sih
->
Æãr_pi_addr
, &
öode_c›y
, 0) < 0) {

940 
ªt
 = -
EIO
;

941 
out
;

944 
ªt
 = 
	`nova_≠≥nd_log_íåy
(
sb
, 
pi
, 
öode
, 
sih
, &
íåy_öfo
);

945 i‡(
ªt
)

946 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

948 
ôem
->
mm≠_íåy
 = 
íåy_öfo
.
cuº_p
;

949 
out
:

950 
	`NOVA_END_TIMING
(
≠≥nd_mm≠_íåy_t
, 
≠≥nd_time
);

951  
ªt
;

952 
	}
}

954 
	$nova_≠≥nd_¢≠shŸ_öfo_íåy
(
su≥r_block
 *
sb
,

955 
nova_öode
 *
pi
, 
nova_öode_öfo
 *
si
,

956 
¢≠shŸ_öfo
 *
öfo
, 
nova_¢≠shŸ_öfo_íåy
 *
d©a
,

957 
nova_öode_upd©e
 *
upd©e
)

959 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

960 
nova_öode
 
öode_c›y
;

961 
nova_log_íåy_öfo
 
íåy_öfo
;

962 
	`INIT_TIMING
(
≠≥nd_time
);

963 
ªt
;

965 
	`NOVA_START_TIMING
(
≠≥nd_¢≠shŸ_öfo_t
, 
≠≥nd_time
);

967 
	`nova_upd©e_íåy_csum
(
d©a
);

969 
íåy_öfo
.
ty≥
 = 
SNAPSHOT_INFO
;

970 
íåy_öfo
.
upd©e
 = update;

971 
íåy_öfo
.
d©a
 = data;

972 
íåy_öfo
.
ïoch_id
 = 
d©a
->epoch_id;

973 
íåy_öfo
.
ö∂a˚
 = 0;

975 i‡(
	`nova_check_öode_öãgrôy
(
sb
, 
sih
->
öo
, sih->
pi_addr
,

976 
sih
->
Æãr_pi_addr
, &
öode_c›y
, 0) < 0) {

977 
ªt
 = -
EIO
;

978 
out
;

981 
ªt
 = 
	`nova_≠≥nd_log_íåy
(
sb
, 
pi
, 
NULL
, 
sih
, &
íåy_öfo
);

982 i‡(
ªt
)

983 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

985 
öfo
->
¢≠shŸ_íåy
 = 
íåy_öfo
.
cuº_p
;

986 
out
:

987 
	`NOVA_END_TIMING
(
≠≥nd_¢≠shŸ_öfo_t
, 
≠≥nd_time
);

988  
ªt
;

989 
	}
}

991 
	$nova_≠≥nd_díåy
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

992 
öode
 *
dú
, 
díåy
 *díåy, 
u64
 
öo
,

993 
de_Àn
, 
nova_öode_upd©e
 *
upd©e
,

994 
lök_ch™ge
, 
u64
 
ïoch_id
)

996 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
dú
);

997 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

998 
nova_öode
 
öode_c›y
;

999 
nova_log_íåy_öfo
 
íåy_öfo
;

1000 
	`INIT_TIMING
(
≠≥nd_time
);

1001 
ªt
;

1003 
	`NOVA_START_TIMING
(
≠≥nd_dú_íåy_t
, 
≠≥nd_time
);

1005 
íåy_öfo
.
ty≥
 = 
DIR_LOG
;

1006 
íåy_öfo
.
upd©e
 = update;

1007 
íåy_öfo
.
d©a
 = 
díåy
;

1008 
íåy_öfo
.
öo
 = ino;

1009 
íåy_öfo
.
lök_ch™ge
 =Üink_change;

1010 
íåy_öfo
.
fûe_size
 = 
de_Àn
;

1011 
íåy_öfo
.
ïoch_id
 =Époch_id;

1012 
íåy_öfo
.
å™s_id
 = 
sih
->trans_id;

1013 
íåy_öfo
.
ö∂a˚
 = 0;

1018 i‡(
	`nova_check_öode_öãgrôy
(
sb
, 
sih
->
öo
, sih->
pi_addr
,

1019 
sih
->
Æãr_pi_addr
, &
öode_c›y
, 0) < 0) {

1020 
ªt
 = -
EIO
;

1021 
out
;

1024 
ªt
 = 
	`nova_≠≥nd_log_íåy
(
sb
, 
pi
, 
dú
, 
sih
, &
íåy_öfo
);

1025 i‡(
ªt
)

1026 
	`nova_îr
(
sb
, "%†Áûed\n", 
__func__
);

1028 
dú
->
i_blocks
 = 
sih
->i_blocks;

1029 
out
:

1030 
	`NOVA_END_TIMING
(
≠≥nd_dú_íåy_t
, 
≠≥nd_time
);

1031  
ªt
;

1032 
	}
}

1034 
	$nova_upd©e_Æãr_∑ges
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

1035 
u64
 
cuº
, u64 
Æãr_cuº
)

1037 i‡(
cuº
 =0 || 
Æãr_cuº
 =0 || 
mëad©a_csum
 == 0)

1040 
cuº
 && 
Æãr_cuº
) {

1041 
	`nova_£t_Æãr_∑ge_addªss
(
sb
, 
cuº
, 
Æãr_cuº
);

1042 
cuº
 = 
	`√xt_log_∑ge
(
sb
, curr);

1043 
Æãr_cuº
 = 
	`√xt_log_∑ge
(
sb
,álter_curr);

1046 i‡(
cuº
 || 
Æãr_cuº
)

1047 
	`nova_dbg
("%s: curr 0x%llx,álter_curr 0x%llx\n",

1048 
__func__
, 
cuº
, 
Æãr_cuº
);

1051 
	}
}

1053 
	$nova_cﬂÀs˚_log_∑ges
(
su≥r_block
 *
sb
,

1054 
¥ev_blockƒ
, 
fú°_blockƒ
,

1055 
num_∑ges
)

1057 
√xt_blockƒ
;

1058 
u64
 
cuº_block
, 
√xt_∑ge
;

1059 
nova_öode_log_∑ge
 *
cuº_∑ge
;

1060 
i
;

1061 
úq_Êags
 = 0;

1063 i‡(
¥ev_blockƒ
) {

1065 
cuº_block
 = 
	`nova_gë_block_off
(
sb
, 
¥ev_blockƒ
,

1066 
NOVA_BLOCK_TYPE_4K
);

1067 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)

1068 
	`nova_gë_block
(
sb
, 
cuº_block
);

1069 
√xt_∑ge
 = 
	`nova_gë_block_off
(
sb
, 
fú°_blockƒ
,

1070 
NOVA_BLOCK_TYPE_4K
);

1071 
	`nova_memu∆ock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

1072 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
cuº_∑ge
, 
√xt_∑ge
, 0);

1073 
	`nova_memlock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

1076 
√xt_blockƒ
 = 
fú°_blockƒ
 + 1;

1077 
cuº_block
 = 
	`nova_gë_block_off
(
sb
, 
fú°_blockƒ
,

1078 
NOVA_BLOCK_TYPE_4K
);

1079 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)

1080 
	`nova_gë_block
(
sb
, 
cuº_block
);

1081 
i
 = 0; i < 
num_∑ges
 - 1; i++) {

1082 
√xt_∑ge
 = 
	`nova_gë_block_off
(
sb
, 
√xt_blockƒ
,

1083 
NOVA_BLOCK_TYPE_4K
);

1084 
	`nova_memu∆ock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

1085 
	`nova_£t_∑ge_num_íåõs
(
sb
, 
cuº_∑ge
, 0, 0);

1086 
	`nova_£t_∑ge_övÆid_íåõs
(
sb
, 
cuº_∑ge
, 0, 0);

1087 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
cuº_∑ge
, 
√xt_∑ge
, 0);

1088 
	`nova_memlock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

1089 
cuº_∑ge
++;

1090 
√xt_blockƒ
++;

1094 
	`nova_memu∆ock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

1095 
	`nova_£t_∑ge_num_íåõs
(
sb
, 
cuº_∑ge
, 0, 0);

1096 
	`nova_£t_∑ge_övÆid_íåõs
(
sb
, 
cuº_∑ge
, 0, 0);

1097 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
cuº_∑ge
, 0, 1);

1098 
	`nova_memlock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

1100 
	}
}

1103 
	$nova_Æloˇã_öode_log_∑ges
(
su≥r_block
 *
sb
,

1104 
nova_öode_öfo_hódî
 *
sih
, 
num_∑ges
,

1105 
u64
 *
√w_block
, 
˝uid
, 
nova_Æloc_dúe˘i⁄
 
‰om_èû
)

1107 
√w_öode_blockƒ
;

1108 
fú°_blockƒ
;

1109 
¥ev_blockƒ
;

1110 
Æloˇãd
;

1111 
ªt_∑ges
 = 0;

1113 
Æloˇãd
 = 
	`nova_√w_log_blocks
(
sb
, 
sih
, &
√w_öode_blockƒ
,

1114 
num_∑ges
, 
ALLOC_NO_INIT
, 
˝uid
, 
‰om_èû
);

1116 i‡(
Æloˇãd
 <= 0) {

1117 
	`nova_îr
(
sb
, "ERROR:Ço inodeÜogÖageávailable: %d %d\n",

1118 
num_∑ges
, 
Æloˇãd
);

1119  
Æloˇãd
;

1121 
ªt_∑ges
 +
Æloˇãd
;

1122 
num_∑ges
 -
Æloˇãd
;

1123 
	`nova_dbg_vîbo£
("Pi %lu: Alloc %dÜog blocks @ 0x%lx\n",

1124 
sih
->
öo
, 
Æloˇãd
, 
√w_öode_blockƒ
);

1127 
	`nova_cﬂÀs˚_log_∑ges
(
sb
, 0, 
√w_öode_blockƒ
, 
Æloˇãd
);

1128 
fú°_blockƒ
 = 
√w_öode_blockƒ
;

1129 
¥ev_blockƒ
 = 
√w_öode_blockƒ
 + 
Æloˇãd
 - 1;

1132 
num_∑ges
) {

1133 
Æloˇãd
 = 
	`nova_√w_log_blocks
(
sb
, 
sih
,

1134 &
√w_öode_blockƒ
, 
num_∑ges
,

1135 
ALLOC_NO_INIT
, 
˝uid
, 
‰om_èû
);

1137 
	`nova_dbg_vîbo£
("Alloc %dÜog blocks @ 0x%lx\n",

1138 
Æloˇãd
, 
√w_öode_blockƒ
);

1139 i‡(
Æloˇãd
 <= 0) {

1140 
	`nova_dbg
("%s:Ço inodeÜogÖageávailable: %lu %d\n",

1141 
__func__
, 
num_∑ges
, 
Æloˇãd
);

1145 
ªt_∑ges
 +
Æloˇãd
;

1146 
num_∑ges
 -
Æloˇãd
;

1147 
	`nova_cﬂÀs˚_log_∑ges
(
sb
, 
¥ev_blockƒ
, 
√w_öode_blockƒ
,

1148 
Æloˇãd
);

1149 
¥ev_blockƒ
 = 
√w_öode_blockƒ
 + 
Æloˇãd
 - 1;

1152 *
√w_block
 = 
	`nova_gë_block_off
(
sb
, 
fú°_blockƒ
,

1153 
NOVA_BLOCK_TYPE_4K
);

1155  
ªt_∑ges
;

1156 
	}
}

1158 
	$nova_öôülize_öode_log
(
su≥r_block
 *
sb
,

1159 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

1160 
log_id
)

1162 
u64
 
√w_block
;

1163 
Æloˇãd
;

1164 
úq_Êags
 = 0;

1166 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, 
sih
,

1167 1, &
√w_block
, 
ANY_CPU
,

1168 
log_id
 =
MAIN_LOG
 ? 0 : 1);

1169 i‡(
Æloˇãd
 != 1) {

1170 
	`nova_îr
(
sb
, "%s ERROR:Ço inodeÜogÖageávailable\n",

1171 
__func__
);

1172  -
ENOSPC
;

1175 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

1176 i‡(
log_id
 =
MAIN_LOG
) {

1177 
pi
->
log_èû
 = 
√w_block
;

1178 
	`nova_Êush_buf„r
(&
pi
->
log_èû
, 
CACHELINE_SIZE
, 0);

1179 
pi
->
log_hód
 = 
√w_block
;

1180 
sih
->
log_hód
 = sih->
log_èû
 = 
√w_block
;

1181 
sih
->
log_∑ges
 = 1;

1182 
	`nova_Êush_buf„r
(&
pi
->
log_hód
, 
CACHELINE_SIZE
, 1);

1184 
pi
->
Æãr_log_èû
 = 
√w_block
;

1185 
	`nova_Êush_buf„r
(&
pi
->
Æãr_log_èû
, 
CACHELINE_SIZE
, 0);

1186 
pi
->
Æãr_log_hód
 = 
√w_block
;

1187 
sih
->
Æãr_log_hód
 = sih->
Æãr_log_èû
 = 
√w_block
;

1188 
sih
->
log_∑ges
++;

1189 
	`nova_Êush_buf„r
(&
pi
->
Æãr_log_hód
, 
CACHELINE_SIZE
, 1);

1191 
	`nova_upd©e_öode_checksum
(
pi
);

1192 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

1195 
	}
}

1201 
u64
 
	$nova_exãnd_öode_log
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

1202 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
cuº_p
)

1204 
u64
 
√w_block
, 
Æãr_√w_block
 = 0;

1205 
Æloˇãd
;

1206 
num_∑ges
;

1207 
ªt
;

1208 
úq_Êags
 = 0;

1210 
	`nova_dbgv
("%s: inodê%lu, cuº 0x%Œx\n", 
__func__
, 
sih
->
öo
, 
cuº_p
);

1212 i‡(
cuº_p
 == 0) {

1213 
ªt
 = 
	`nova_öôülize_öode_log
(
sb
, 
pi
, 
sih
, 
MAIN_LOG
);

1214 i‡(
ªt
)

1217 i‡(
mëad©a_csum
) {

1218 
ªt
 = 
	`nova_öôülize_öode_log
(
sb
, 
pi
, 
sih
, 
ALTER_LOG
);

1219 i‡(
ªt
)

1222 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

1223 
	`nova_upd©e_Æãr_∑ges
(
sb
, 
pi
, 
sih
->
log_hód
,

1224 
sih
->
Æãr_log_hód
);

1225 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

1228  
sih
->
log_hód
;

1231 
num_∑ges
 = 
sih
->
log_∑ges
 >
EXTEND_THRESHOLD
 ?

1232 
EXTEND_THRESHOLD
 : 
sih
->
log_∑ges
;

1235 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, 
sih
,

1236 
num_∑ges
, &
√w_block
, 
ANY_CPU
, 0);

1237 
	`nova_dbg_vîbo£
("Link block %lluÅo block %llu\n",

1238 
cuº_p
 >> 
PAGE_SHIFT
,

1239 
√w_block
 >> 
PAGE_SHIFT
);

1240 i‡(
Æloˇãd
 <= 0) {

1241 
	`nova_îr
(
sb
, "%s ERROR:Ço inodeÜogÖageávailable\n",

1242 
__func__
);

1243 
	`nova_dbg
("cuº_∞0x%Œx, %luÖages\n", 
cuº_p
,

1244 
sih
->
log_∑ges
);

1248 i‡(
mëad©a_csum
) {

1249 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, 
sih
,

1250 
num_∑ges
, &
Æãr_√w_block
, 
ANY_CPU
, 1);

1251 i‡(
Æloˇãd
 <= 0) {

1252 
	`nova_îr
(
sb
, "%s ERROR:Ço inodeÜogÖageávailable\n",

1253 
__func__
);

1254 
	`nova_dbg
("cuº_∞0x%Œx, %luÖages\n", 
cuº_p
,

1255 
sih
->
log_∑ges
);

1259 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

1260 
	`nova_upd©e_Æãr_∑ges
(
sb
, 
pi
, 
√w_block
, 
Æãr_√w_block
);

1261 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

1265 
	`nova_öode_log_Á°_gc
(
sb
, 
pi
, 
sih
, 
cuº_p
,

1266 
√w_block
, 
Æãr_√w_block
, 
Æloˇãd
, 0);

1273  
√w_block
;

1274 
	}
}

1277 
u64
 
	$nova_≠≥nd_⁄e_log_∑ge
(
su≥r_block
 *
sb
,

1278 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
cuº_p
)

1280 
nova_öode_log_∑ge
 *
cuº_∑ge
;

1281 
u64
 
√w_block
;

1282 
u64
 
cuº_block
;

1283 
Æloˇãd
;

1284 
úq_Êags
 = 0;

1286 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, 
sih
, 1, &
√w_block
,

1287 
ANY_CPU
, 0);

1288 i‡(
Æloˇãd
 != 1) {

1289 
	`nova_îr
(
sb
, "%s: ERROR:Ço inodeÜogÖageávailable\n",

1290 
__func__
);

1294 i‡(
cuº_p
 == 0) {

1295 
cuº_p
 = 
√w_block
;

1298 
cuº_block
 = 
	`BLOCK_OFF
(
cuº_p
);

1299 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)

1300 
	`nova_gë_block
(
sb
, 
cuº_block
);

1301 
	`nova_memu∆ock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

1302 
	`nova_£t_√xt_∑ge_addªss
(
sb
, 
cuº_∑ge
, 
√w_block
, 1);

1303 
	`nova_memlock_block
(
sb
, 
cuº_∑ge
, &
úq_Êags
);

1306  
cuº_p
;

1307 
	}
}

1309 
u64
 
	$nova_gë_≠≥nd_hód
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

1310 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
èû
, 
size_t
 
size
, 
log_id
,

1311 
th‹ough_gc
, *
exãnded
)

1313 
u64
 
cuº_p
;

1314 
úq_Êags
 = 0;

1316 i‡(
èû
)

1317 
cuº_p
 = 
èû
;

1318 i‡(
log_id
 =
MAIN_LOG
)

1319 
cuº_p
 = 
sih
->
log_èû
;

1321 
cuº_p
 = 
sih
->
Æãr_log_èû
;

1323 i‡(
cuº_p
 =0 || (
	`is_œ°_íåy
(cuº_p, 
size
) &&

1324 
	`√xt_log_∑ge
(
sb
, 
cuº_p
) == 0)) {

1325 i‡(
	`is_œ°_íåy
(
cuº_p
, 
size
)) {

1326 
	`nova_memu∆ock_block
(
sb
, 
	`nova_gë_block
(sb, 
cuº_p
), &
úq_Êags
);

1327 
	`nova_£t_√xt_∑ge_Êag
(
sb
, 
cuº_p
);

1328 
	`nova_memlock_block
(
sb
, 
	`nova_gë_block
(sb, 
cuº_p
), &
úq_Êags
);

1332 i‡(
log_id
 !
MAIN_LOG
)

1335 i‡(
th‹ough_gc
 == 0) {

1336 
cuº_p
 = 
	`nova_exãnd_öode_log
(
sb
, 
pi
, 
sih
, curr_p);

1338 
cuº_p
 = 
	`nova_≠≥nd_⁄e_log_∑ge
(
sb
, 
sih
, curr_p);

1340 *
exãnded
 = 1;

1343 i‡(
cuº_p
 == 0)

1347 i‡(
	`is_œ°_íåy
(
cuº_p
, 
size
)) {

1348 
	`nova_memu∆ock_block
(
sb
, 
	`nova_gë_block
(sb, 
cuº_p
), &
úq_Êags
);

1349 
	`nova_£t_√xt_∑ge_Êag
(
sb
, 
cuº_p
);

1350 
	`nova_memlock_block
(
sb
, 
	`nova_gë_block
(sb, 
cuº_p
), &
úq_Êags
);

1351 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

1354  
cuº_p
;

1355 
	}
}

1357 
	$nova_‰ì_c⁄tiguous_log_blocks
(
su≥r_block
 *
sb
,

1358 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
hód
)

1360 
blockƒ
, 
°¨t_blockƒ
 = 0;

1361 
u64
 
cuº_block
 = 
hód
;

1362 
u8
 
bty≥
 = 
sih
->
i_blk_ty≥
;

1363 
num_‰ì
 = 0;

1364 
‰ìd
 = 0;

1366 
cuº_block
 > 0) {

1367 i‡(
	`ENTRY_LOC
(
cuº_block
)) {

1368 
	`nova_dbg
("%s: ERROR: invalid block %llu\n",

1369 
__func__
, 
cuº_block
);

1373 
blockƒ
 = 
	`nova_gë_blockƒ
(
sb
, 
	`À64_to_˝u
(
cuº_block
),

1374 
bty≥
);

1375 
	`nova_dbg_vîbo£
("%s: fªê∑gê%Œu\n", 
__func__
, 
cuº_block
);

1376 
cuº_block
 = 
	`√xt_log_∑ge
(
sb
, curr_block);

1378 i‡(
°¨t_blockƒ
 == 0) {

1379 
°¨t_blockƒ
 = 
blockƒ
;

1380 
num_‰ì
 = 1;

1382 i‡(
blockƒ
 =
°¨t_blockƒ
 + 
num_‰ì
) {

1383 
num_‰ì
++;

1386 
	`nova_‰ì_log_blocks
(
sb
, 
sih
, 
°¨t_blockƒ
,

1387 
num_‰ì
);

1388 
‰ìd
 +
num_‰ì
;

1389 
°¨t_blockƒ
 = 
blockƒ
;

1390 
num_‰ì
 = 1;

1394 i‡(
°¨t_blockƒ
) {

1395 
	`nova_‰ì_log_blocks
(
sb
, 
sih
, 
°¨t_blockƒ
, 
num_‰ì
);

1396 
‰ìd
 +
num_‰ì
;

1399  
‰ìd
;

1400 
	}
}

1402 
	$nova_‰ì_öode_log
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

1403 
nova_öode_öfo_hódî
 *
sih
)

1405 
nova_öode
 *
Æãr_pi
;

1406 
‰ìd
 = 0;

1407 
úq_Êags
 = 0;

1408 
	`INIT_TIMING
(
‰ì_time
);

1410 i‡(
sih
->
log_hód
 =0 || sih->
log_èû
 == 0)

1413 
	`NOVA_START_TIMING
(
‰ì_öode_log_t
, 
‰ì_time
);

1416 i‡(
pi
) {

1417 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

1418 
pi
->
log_hód
 =Öi->
log_èû
 = 0;

1419 
pi
->
Æãr_log_hód
 =Öi->
Æãr_log_èû
 = 0;

1420 
	`nova_upd©e_öode_checksum
(
pi
);

1421 i‡(
mëad©a_csum
) {

1422 
Æãr_pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
,

1423 
sih
->
Æãr_pi_addr
);

1424 i‡(
Æãr_pi
) {

1425 
	`mem˝y_to_pmem_noˇche
(
Æãr_pi
, 
pi
,

1426 (
nova_öode
));

1429 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

1432 
‰ìd
 = 
	`nova_‰ì_c⁄tiguous_log_blocks
(
sb
, 
sih
, sih->
log_hód
);

1433 i‡(
mëad©a_csum
)

1434 
‰ìd
 +
	`nova_‰ì_c⁄tiguous_log_blocks
(
sb
, 
sih
,

1435 
sih
->
Æãr_log_hód
);

1437 
	`NOVA_END_TIMING
(
‰ì_öode_log_t
, 
‰ì_time
);

1439 
	}
}

	@log.h

1 #i‚de‡
__LOG_H


2 
	#__LOG_H


	)

4 
	~"bÆloc.h
"

5 
	~"öode.h
"

10 
	#MAIN_LOG
 0

	)

11 
	#ALTER_LOG
 1

	)

13 
	#PAGE_OFFSET_MASK
 4095

	)

14 
	#BLOCK_OFF
(
p
Ë(’Ë& ~
PAGE_OFFSET_MASK
)

	)

16 
	#ENTRY_LOC
(
p
Ë(’Ë& 
PAGE_OFFSET_MASK
)

	)

18 
	#LOG_BLOCK_TAIL
 4064

	)

19 
	#PAGE_TAIL
(
p
Ë(
	`BLOCK_OFF
’Ë+ 
LOG_BLOCK_TAIL
)

	)

24 
	snova_öode_∑ge_èû
 {

25 
__À32
 
	mövÆid_íåõs
;

26 
__À32
 
	mnum_íåõs
;

27 
__À64
 
	mïoch_id
;

28 
__À64
 
	mÆãr_∑ge
;

29 
__À64
 
	m√xt_∑ge
;

30 } 
__©åibuã
((
__∑cked__
));

33 
	snova_öode_log_∑ge
 {

34 
	m∑ddög
[
LOG_BLOCK_TAIL
];

35 
nova_öode_∑ge_èû
 
	m∑ge_èû
;

36 } 
__©åibuã
((
__∑cked__
));

38 
	#EXTEND_THRESHOLD
 256

	)

40 
	enova_íåy_ty≥
 {

41 
	mFILE_WRITE
 = 1,

42 
	mDIR_LOG
,

43 
	mSET_ATTR
,

44 
	mLINK_CHANGE
,

45 
	mMMAP_WRITE
,

46 
	mSNAPSHOT_INFO
,

47 
	mNEXT_PAGE
,

50 
ölöe
 
u8
 
	$nova_gë_íåy_ty≥
(*
p
)

52 
u8
 
ty≥
;

54 i‡(
	`mem˝y
(&
ty≥
, 
p
, (
u8
)Ë=
NULL
)

57  
ty≥
;

58 
	}
}

60 
ölöe
 
	$nova_£t_íåy_ty≥
(*
p
, 
nova_íåy_ty≥
 
ty≥
)

62 *(
u8
 *)
p
 = 
ty≥
;

63 
	}
}

70 
	snova_fûe_wrôe_íåy
 {

71 
u8
 
	míåy_ty≥
;

72 
u8
 
	mªassig√d
;

73 
u8
 
	mupd©ög
;

74 
u8
 
	m∑ddög
;

75 
__À32
 
	mnum_∑ges
;

76 
__À64
 
	mblock
;

77 
__À64
 
	mpgoff
;

78 
__À32
 
	mövÆid_∑ges
;

80 
__À32
 
	mmtime
;

81 
__À64
 
	msize
;

82 
__À64
 
	mïoch_id
;

83 
__À64
 
	må™s_id
;

84 
__À32
 
	mcsum∑ddög
;

85 
__À32
 
	mcsum
;

86 } 
__©åibuã
((
__∑cked__
));

88 
	#WENTRY
(
íåy
Ë((
nova_fûe_wrôe_íåy
 *Ëíåy)

	)

95 
	snova_díåy
 {

96 
u8
 
	míåy_ty≥
;

97 
u8
 
	m«me_Àn
;

98 
u8
 
	mªassig√d
;

99 
u8
 
	mövÆid
;

100 
__À16
 
	mde_Àn
;

101 
__À16
 
	mlöks_cou¡
;

102 
__À32
 
	mmtime
;

103 
__À32
 
	mcsum
;

104 
__À64
 
	möo
;

105 
__À64
 
	m∑ddög
;

106 
__À64
 
	mïoch_id
;

107 
__À64
 
	må™s_id
;

108 
	m«me
[
NOVA_NAME_LEN
 + 1];

109 } 
__©åibuã
((
__∑cked__
));

111 
	#DENTRY
(
íåy
Ë((
nova_díåy
 *Ëíåy)

	)

113 
	#NOVA_DIR_PAD
 8

	)

114 
	#NOVA_DIR_ROUND
 (
NOVA_DIR_PAD
 - 1)

	)

115 
	#NOVA_DENTRY_HEADER_LEN
 48

	)

116 
	#NOVA_DIR_LOG_REC_LEN
(
«me_Àn
) \

117 (((
«me_Àn
 + 1Ë+ 
NOVA_DENTRY_HEADER_LEN
 \

118 + 
NOVA_DIR_ROUND
Ë& ~NOVA_DIR_ROUND)

	)

120 
	#NOVA_MAX_ENTRY_LEN
 
	`NOVA_DIR_LOG_REC_LEN
(
NOVA_NAME_LEN
)

	)

125 
	snova_£èâr_logíåy
 {

126 
u8
 
	míåy_ty≥
;

127 
u8
 
	m©å
;

128 
__À16
 
	mmode
;

129 
__À32
 
	muid
;

130 
__À32
 
	mgid
;

131 
__À32
 
	m©ime
;

132 
__À32
 
	mmtime
;

133 
__À32
 
	m˘ime
;

134 
__À64
 
	msize
;

135 
__À64
 
	mïoch_id
;

136 
__À64
 
	må™s_id
;

137 
u8
 
	mövÆid
;

138 
u8
 
	m∑ddögs
[3];

139 
__À32
 
	mcsum
;

140 } 
__©åibuã
((
__∑cked__
));

142 
	#SENTRY
(
íåy
Ë((
nova_£èâr_logíåy
 *Ëíåy)

	)

148 
	snova_lök_ch™ge_íåy
 {

149 
u8
 
	míåy_ty≥
;

150 
u8
 
	mövÆid
;

151 
__À16
 
	mlöks
;

152 
__À32
 
	m˘ime
;

153 
__À32
 
	mÊags
;

154 
__À32
 
	mgíî©i⁄
;

155 
__À64
 
	mïoch_id
;

156 
__À64
 
	må™s_id
;

157 
__À32
 
	mcsum∑ddög
;

158 
__À32
 
	mcsum
;

159 } 
__©åibuã
((
__∑cked__
));

161 
	#LCENTRY
(
íåy
Ë((
nova_lök_ch™ge_íåy
 *Ëíåy)

	)

167 
	snova_mm≠_íåy
 {

168 
u8
 
	míåy_ty≥
;

169 
u8
 
	mövÆid
;

170 
u8
 
	m∑ddögs
[6];

171 
__À64
 
	mïoch_id
;

172 
__À64
 
	mpgoff
;

173 
__À64
 
	mnum_∑ges
;

174 
__À32
 
	mcsum∑ddög
;

175 
__À32
 
	mcsum
;

176 } 
__©åibuã
((
__∑cked__
));

178 
	#MMENTRY
(
íåy
Ë((
nova_mm≠_íåy
 *Ëíåy)

	)

184 
	snova_¢≠shŸ_öfo_íåy
 {

185 
u8
 
	mty≥
;

186 
u8
 
	mdñëed
;

187 
u8
 
	m∑ddögs
[6];

188 
__À64
 
	mïoch_id
;

189 
__À64
 
	mtime°amp
;

190 
__À64
 
	mnvmm_∑ge_addr
;

191 
__À32
 
	mcsum∑ddög
;

192 
__À32
 
	mcsum
;

193 } 
__©åibuã
((
__∑cked__
));

195 
	#SNENTRY
(
íåy
Ë((
nova_¢≠shŸ_öfo_íåy
 *Ëíåy)

	)

202 
	snova_öode_upd©e
 {

203 
u64
 
	mhód
;

204 
u64
 
	mÆãr_hód
;

205 
u64
 
	mèû
;

206 
u64
 
	mÆãr_èû
;

207 
u64
 
	mcuº_íåy
;

208 
u64
 
	mÆãr_íåy
;

209 
nova_díåy
 *
	m¸óã_díåy
;

210 
nova_díåy
 *
	mdñëe_díåy
;

217 
	snova_log_íåy_öfo
 {

218 
nova_íåy_ty≥
 
	mty≥
;

219 
üâr
 *
	m©å
;

220 
nova_öode_upd©e
 *
	mupd©e
;

221 *
	md©a
;

222 
u64
 
	mïoch_id
;

223 
u64
 
	må™s_id
;

224 
u64
 
	mcuº_p
;

225 
u64
 
	mfûe_size
;

226 
u64
 
	möo
;

227 
u32
 
	mtime
;

228 
	mlök_ch™ge
;

229 
	mö∂a˚
;

234 
ölöe
 
size_t
 
	$nova_gë_log_íåy_size
(
su≥r_block
 *
sb
,

235 
nova_íåy_ty≥
 
ty≥
)

237 
size_t
 
size
 = 0;

239 
ty≥
) {

240 
FILE_WRITE
:

241 
size
 = (
nova_fûe_wrôe_íåy
);

243 
DIR_LOG
:

244 
size
 = 
NOVA_DENTRY_HEADER_LEN
;

246 
SET_ATTR
:

247 
size
 = (
nova_£èâr_logíåy
);

249 
LINK_CHANGE
:

250 
size
 = (
nova_lök_ch™ge_íåy
);

252 
MMAP_WRITE
:

253 
size
 = (
nova_mm≠_íåy
);

255 
SNAPSHOT_INFO
:

256 
size
 = (
nova_¢≠shŸ_öfo_íåy
);

262  
size
;

263 
	}
}

266 
nova_övÆid©e_logíåy
(
su≥r_block
 *
sb
, *
íåy
,

267 
nova_íåy_ty≥
 
ty≥
, 
num_‰ì
);

268 
nova_ªassign_logíåy
(
su≥r_block
 *
sb
, *
íåy
,

269 
nova_íåy_ty≥
 
ty≥
);

270 
nova_ö∂a˚_upd©e_log_íåy
(
su≥r_block
 *
sb
,

271 
öode
 *öode, *
íåy
,

272 
nova_log_íåy_öfo
 *
íåy_öfo
);

273 
nova_˛ór_œ°_∑ge_èû
(
su≥r_block
 *
sb
,

274 
öode
 *öode, 
loff_t
 
√wsize
);

275 
nova_‰ì_ﬁd_íåy
(
su≥r_block
 *
sb
,

276 
nova_öode_öfo_hódî
 *
sih
,

277 
nova_fûe_wrôe_íåy
 *
íåy
,

278 
pgoff
, 
num_‰ì
,

279 
boﬁ
 
dñëe_dód
, 
u64
 
ïoch_id
);

280 
nova_‰ì_öode_log
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

281 
nova_öode_öfo_hódî
 *
sih
);

282 
nova_upd©e_Æãr_∑ges
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

283 
u64
 
cuº
, u64 
Æãr_cuº
);

284 
nova_fûe_wrôe_íåy
 *
nova_föd_√xt_íåy
(
su≥r_block
 *
sb
,

285 
nova_öode_öfo_hódî
 *
sih
, 
pgoff_t
 
pgoff
);

286 
nova_Æloˇã_öode_log_∑ges
(
su≥r_block
 *
sb
,

287 
nova_öode_öfo_hódî
 *
sih
, 
num_∑ges
,

288 
u64
 *
√w_block
, 
˝uid
, 
nova_Æloc_dúe˘i⁄
 
‰om_èû
);

289 
nova_‰ì_c⁄tiguous_log_blocks
(
su≥r_block
 *
sb
,

290 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
hód
);

291 
u64
 
nova_gë_≠≥nd_hód
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

292 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
èû
, 
size_t
 
size
, 
log_id
,

293 
th‹ough_gc
, *
exãnded
);

294 
nova_h™dÀ_£èâr_›î©i⁄
(
su≥r_block
 *
sb
, 
öode
 *inode,

295 
nova_öode
 *
pi
, 
ü_vÆid
, 
üâr
 *
©å
,

296 
u64
 
ïoch_id
);

297 
nova_övÆid©e_lök_ch™ge_íåy
(
su≥r_block
 *
sb
,

298 
u64
 
ﬁd_lök_ch™ge
);

299 
nova_≠≥nd_lök_ch™ge_íåy
(
su≥r_block
 *
sb
,

300 
nova_öode
 *
pi
, 
öode
 *inode,

301 
nova_öode_upd©e
 *
upd©e
, 
u64
 *
ﬁd_lökc
, u64 
ïoch_id
);

302 
nova_£t_wrôe_íåy_upd©ög
(
su≥r_block
 *
sb
,

303 
nova_fûe_wrôe_íåy
 *
íåy
, 
£t
);

304 
nova_ö∂a˚_upd©e_wrôe_íåy
(
su≥r_block
 *
sb
,

305 
öode
 *öode, 
nova_fûe_wrôe_íåy
 *
íåy
,

306 
nova_log_íåy_öfo
 *
íåy_öfo
);

307 
nova_≠≥nd_mm≠_íåy
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

308 
öode
 *öode, 
nova_mm≠_íåy
 *
d©a
,

309 
nova_öode_upd©e
 *
upd©e
, 
vma_ôem
 *
ôem
);

310 
nova_≠≥nd_fûe_wrôe_íåy
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

311 
öode
 *öode, 
nova_fûe_wrôe_íåy
 *
d©a
,

312 
nova_öode_upd©e
 *
upd©e
);

313 
nova_≠≥nd_¢≠shŸ_öfo_íåy
(
su≥r_block
 *
sb
,

314 
nova_öode
 *
pi
, 
nova_öode_öfo
 *
si
,

315 
¢≠shŸ_öfo
 *
öfo
, 
nova_¢≠shŸ_öfo_íåy
 *
d©a
,

316 
nova_öode_upd©e
 *
upd©e
);

317 
nova_assign_wrôe_íåy
(
su≥r_block
 *
sb
,

318 
nova_öode_öfo_hódî
 *
sih
,

319 
nova_fûe_wrôe_íåy
 *
íåy
,

320 
nova_fûe_wrôe_íåy
 *
íåyc
, 
boﬁ
 
‰ì
);

323 
nova_¥öt_cuº_log_∑ge
(
su≥r_block
 *
sb
, 
u64
 
cuº
);

324 
nova_¥öt_nova_log
(
su≥r_block
 *
sb
,

325 
nova_öode_öfo_hódî
 *
sih
);

326 
nova_gë_nova_log_∑ges
(
su≥r_block
 *
sb
,

327 
nova_öode_öfo_hódî
 *
sih
, 
nova_öode
 *
pi
);

328 
nova_¥öt_nova_log_∑ges
(
su≥r_block
 *
sb
,

329 
nova_öode_öfo_hódî
 *
sih
);

	@mprotect.c

21 
	~<löux/moduÀ.h
>

22 
	~<löux/fs.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/io.h
>

26 
	~<asm/ébÊush.h
>

27 
	~<asm/éb.h
>

36 
	~"nova.h
"

37 
	~"öode.h
"

39 
	$nova_gë_vma_ovîœp_ønge
(
su≥r_block
 *
sb
,

40 
nova_öode_öfo_hódî
 *
sih
, 
vm_¨ó_°ru˘
 *
vma
,

41 
íåy_pgoff
, 
íåy_∑ges
,

42 *
°¨t_pgoff
, *
num_∑ges
)

44 
vma_pgoff
;

45 
vma_∑ges
;

46 
íd_pgoff
;

48 
vma_pgoff
 = 
vma
->
vm_pgoff
;

49 
vma_∑ges
 = (
vma
->
vm_íd
 - vma->
vm_°¨t
Ë>> 
sb
->
s_blocksize_bôs
;

51 i‡(
vma_pgoff
 + 
vma_∑ges
 <
íåy_pgoff
 ||

52 
íåy_pgoff
 + 
íåy_∑ges
 <
vma_pgoff
)

55 *
°¨t_pgoff
 = 
vma_pgoff
 > 
íåy_pgoff
 ? vma_pgoff :Éntry_pgoff;

56 
íd_pgoff
 = (
vma_pgoff
 + 
vma_∑ges
Ë> (
íåy_pgoff
 + 
íåy_∑ges
) ?

57 
íåy_pgoff
 + 
íåy_∑ges
 : 
vma_pgoff
 + 
vma_∑ges
;

58 *
num_∑ges
 = 
íd_pgoff
 - *
°¨t_pgoff
;

60 
	}
}

62 
	$nova_upd©e_dax_m≠pög
(
su≥r_block
 *
sb
,

63 
nova_öode_öfo_hódî
 *
sih
, 
vm_¨ó_°ru˘
 *
vma
,

64 
nova_fûe_wrôe_íåy
 *
íåy
, 
°¨t_pgoff
,

65 
num_∑ges
)

67 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

68 **
≥¡ry
;

69 
cuº_pgoff
;

70 
blockƒ
, 
°¨t_blockƒ
;

71 
vÆue
, 
√w_vÆue
;

72 
i
;

73 
ªt
 = 0;

74 
	`INIT_TIMING
(
upd©e_time
);

76 
	`NOVA_START_TIMING
(
upd©e_m≠pög_t
, 
upd©e_time
);

78 
°¨t_blockƒ
 = 
	`nova_gë_blockƒ
(
sb
, 
íåy
->
block
, 
sih
->
i_blk_ty≥
);

79 
	`xa_lock_úq
(&
m≠pög
->
i_∑ges
);

80 
i
 = 0; i < 
num_∑ges
; i++) {

81 
cuº_pgoff
 = 
°¨t_pgoff
 + 
i
;

82 
blockƒ
 = 
°¨t_blockƒ
 + 
i
;

84 
≥¡ry
 = 
	`ødix_åì_lookup_¶Ÿ
(&
m≠pög
->
i_∑ges
,

85 
cuº_pgoff
);

86 i‡(
≥¡ry
) {

87 
vÆue
 = ()
	`ødix_åì_dîef_¶Ÿ
(
≥¡ry
);

89 
√w_vÆue
 = (
blockƒ
 << 9Ë| (
vÆue
 & 0xff);

90 
	`nova_dbgv
("%s:Ögoff %lu,Éntry 0x%lx,Çew 0x%lx\n",

91 
__func__
, 
cuº_pgoff
,

92 
vÆue
, 
√w_vÆue
);

93 
	`ødix_åì_ª∂a˚_¶Ÿ
(&
sih
->
åì
, 
≥¡ry
,

94 (*)
√w_vÆue
);

95 
	`ødix_åì_èg_£t
(&
m≠pög
->
i_∑ges
, 
cuº_pgoff
,

96 
PAGECACHE_TAG_DIRTY
);

100 
	`xa_u∆ock_úq
(&
m≠pög
->
i_∑ges
);

102 
	`NOVA_END_TIMING
(
upd©e_m≠pög_t
, 
upd©e_time
);

103  
ªt
;

104 
	}
}

106 
	$nova_upd©e_íåy_p‚
(
su≥r_block
 *
sb
,

107 
nova_öode_öfo_hódî
 *
sih
, 
vm_¨ó_°ru˘
 *
vma
,

108 
nova_fûe_wrôe_íåy
 *
íåy
, 
°¨t_pgoff
,

109 
num_∑ges
)

111 
√wÊags
;

112 
addr
;

113 
size
;

114 
p‚
;

115 
pg¥Ÿ_t
 
√w_¥Ÿ
;

116 
ªt
;

117 
	`INIT_TIMING
(
upd©e_time
);

119 
	`NOVA_START_TIMING
(
upd©e_p‚_t
, 
upd©e_time
);

121 
addr
 = 
vma
->
vm_°¨t
 + ((
°¨t_pgoff
 - vma->
vm_pgoff
Ë<< 
PAGE_SHIFT
);

122 
p‚
 = 
	`nova_gë_p‚
(
sb
, 
íåy
->
block
Ë+ 
°¨t_pgoff
 -É¡ry->
pgoff
;

123 
size
 = 
num_∑ges
 << 
PAGE_SHIFT
;

125 
	`nova_dbgv
("%s:ádd∏0x%lx, sizê0x%lx\n", 
__func__
,

126 
addr
, 
size
);

128 
√wÊags
 = 
vma
->
vm_Êags
 | 
VM_WRITE
;

129 
√w_¥Ÿ
 = 
	`vm_gë_∑ge_¥Ÿ
(
√wÊags
);

131 
ªt
 = 
	`ªm≠_p‚_ønge
(
vma
, 
addr
, 
p‚
, 
size
, 
√w_¥Ÿ
);

133 
	`NOVA_END_TIMING
(
upd©e_p‚_t
, 
upd©e_time
);

134  
ªt
;

135 
	}
}

137 
	$nova_dax_mm≠_upd©e_m≠pög
(
su≥r_block
 *
sb
,

138 
nova_öode_öfo_hódî
 *
sih
, 
vm_¨ó_°ru˘
 *
vma
,

139 
nova_fûe_wrôe_íåy
 *
íåy_d©a
)

141 
°¨t_pgoff
, 
num_∑ges
 = 0;

142 
ªt
;

144 
ªt
 = 
	`nova_gë_vma_ovîœp_ønge
(
sb
, 
sih
, 
vma
, 
íåy_d©a
->
pgoff
,

145 
íåy_d©a
->
num_∑ges
,

146 &
°¨t_pgoff
, &
num_∑ges
);

147 i‡(
ªt
 == 0)

148  
ªt
;

151 
	`NOVA_STATS_ADD
(
m≠pög_upd©ed_∑ges
, 
num_∑ges
);

153 
ªt
 = 
	`nova_upd©e_dax_m≠pög
(
sb
, 
sih
, 
vma
, 
íåy_d©a
,

154 
°¨t_pgoff
, 
num_∑ges
);

155 i‡(
ªt
) {

156 
	`nova_îr
(
sb
, "upd©êDAX m≠pögÑëu∫ %d\n", 
ªt
);

157  
ªt
;

160 
ªt
 = 
	`nova_upd©e_íåy_p‚
(
sb
, 
sih
, 
vma
, 
íåy_d©a
,

161 
°¨t_pgoff
, 
num_∑ges
);

162 i‡(
ªt
)

163 
	`nova_îr
(
sb
, "upd©e_p‚Ñëu∫ %d\n", 
ªt
);

166  
ªt
;

167 
	}
}

169 
	$nova_dax_cow_mm≠_h™dÀr
(
su≥r_block
 *
sb
,

170 
vm_¨ó_°ru˘
 *
vma
, 
nova_öode_öfo_hódî
 *
sih
,

171 
u64
 
begö_èû
)

173 
nova_fûe_wrôe_íåy
 *
íåy
;

174 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

175 
u64
 
cuº_p
 = 
begö_èû
;

176 
size_t
 
íåy_size
 = (
nova_fûe_wrôe_íåy
);

177 
ªt
 = 0;

178 
	`INIT_TIMING
(
upd©e_time
);

180 
	`NOVA_START_TIMING
(
mm≠_h™dÀr_t
, 
upd©e_time
);

181 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

182 
cuº_p
 && cuº_∞!
sih
->
log_èû
) {

183 i‡(
	`is_œ°_íåy
(
cuº_p
, 
íåy_size
))

184 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

186 i‡(
cuº_p
 == 0) {

187 
	`nova_îr
(
sb
, "%s: File inode %luÜog is NULL!\n",

188 
__func__
, 
sih
->
öo
);

189 
ªt
 = -
EINVAL
;

193 
íåy
 = (
nova_fûe_wrôe_íåy
 *)

194 
	`nova_gë_block
(
sb
, 
cuº_p
);

196 i‡(
mëad©a_csum
 == 0)

197 
íåyc
 = 
íåy
;

198 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
)) {

199 
ªt
 = -
EIO
;

200 
cuº_p
 +
íåy_size
;

204 i‡(
	`nova_gë_íåy_ty≥
(
íåyc
Ë!
FILE_WRITE
) {

206 
	`nova_dbg
("%s:ÉntryÅype isÇot write? %d\n",

207 
__func__
, 
	`nova_gë_íåy_ty≥
(
íåy
));

208 
cuº_p
 +
íåy_size
;

212 
ªt
 = 
	`nova_dax_mm≠_upd©e_m≠pög
(
sb
, 
sih
, 
vma
, 
íåyc
);

213 i‡(
ªt
)

216 
cuº_p
 +
íåy_size
;

219 
	`NOVA_END_TIMING
(
mm≠_h™dÀr_t
, 
upd©e_time
);

220  
ªt
;

221 
	}
}

223 
	$nova_gë_dax_cow_ønge
(
su≥r_block
 *
sb
,

224 
vm_¨ó_°ru˘
 *
vma
, 
addªss
,

225 *
°¨t_blk
, *
num_blocks
)

227 
ba£
 = 1;

228 
vma_blocks
;

229 
pgoff
;

230 
°¨t_pgoff
;

232 
vma_blocks
 = (
vma
->
vm_íd
 - vma->
vm_°¨t
Ë>> 
sb
->
s_blocksize_bôs
;

235 i‡(
vma_blocks
 >= 4096)

236 
ba£
 = 4096;

238 
pgoff
 = (
addªss
 - 
vma
->
vm_°¨t
Ë>> 
sb
->
s_blocksize_bôs
;

239 
°¨t_pgoff
 = 
pgoff
 & ~(
ba£
 - 1);

240 *
°¨t_blk
 = 
vma
->
vm_pgoff
 + 
°¨t_pgoff
;

241 *
num_blocks
 = (
ba£
 > 
vma_blocks
 - 
°¨t_pgoff
) ?

242 
vma_blocks
 - 
°¨t_pgoff
 : 
ba£
;

243 
	`nova_dbgv
("%s: start block %lu, %d blocks\n",

244 
__func__
, *
°¨t_blk
, *
num_blocks
);

246 
	}
}

248 
	$nova_mm≠_to_√w_blocks
(
vm_¨ó_°ru˘
 *
vma
,

249 
addªss
)

251 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

252 
öode
 *öodê
m≠pög
->
ho°
;

253 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

254 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

255 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

256 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

257 
nova_öode
 *
pi
;

258 
nova_fûe_wrôe_íåy
 *
íåy
;

259 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

260 
nova_fûe_wrôe_íåy
 
íåy_d©a
;

261 
nova_öode_upd©e
 
upd©e
;

262 
°¨t_blk
, 
íd_blk
;

263 
íåy_pgoff
;

264 
‰om_blockƒ
 = 0;

265 
blockƒ
 = 0;

266 
avaû_blocks
;

267 
c›y_blocks
;

268 
num_blocks
 = 0;

269 
u64
 
‰om_blockoff
, 
to_blockoff
;

270 
size_t
 
c›õd
;

271 
Æloˇãd
 = 0;

272 *
‰om_kmem
;

273 *
to_kmem
;

274 
size_t
 
byãs
;

275 
	`INIT_TIMING
(
mem˝y_time
);

276 
u64
 
begö_èû
 = 0;

277 
u64
 
ïoch_id
;

278 
u64
 
íåy_size
;

279 
u32
 
time
;

280 
	`INIT_TIMING
(
mm≠_cow_time
);

281 
ªt
 = 0;

282 
úq_Êags
 = 0;

284 
	`NOVA_START_TIMING
(
mm≠_cow_t
, 
mm≠_cow_time
);

286 
	`nova_gë_dax_cow_ønge
(
sb
, 
vma
, 
addªss
, &
°¨t_blk
, &
num_blocks
);

288 
íd_blk
 = 
°¨t_blk
 + 
num_blocks
;

289 i‡(
°¨t_blk
 >
íd_blk
) {

290 
	`NOVA_END_TIMING
(
mm≠_cow_t
, 
mm≠_cow_time
);

294 i‡(
sbi
->
¢≠shŸ_èkög
) {

296 
	`NOVA_STATS_ADD
(
dax_cow_durög_¢≠shŸ
, 1);

297 
	`waô_evít_öãºu±ibÀ
(
sbi
->
¢≠shŸ_mm≠_waô
,

298 
sbi
->
¢≠shŸ_èkög
 == 0);

301 
	`öode_lock
(
öode
);

303 
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

305 
	`nova_dbgv
("%s: inode %lu, startÖgoff %lu,ÉndÖgoff %lu\n",

306 
__func__
, 
öode
->
i_öo
, 
°¨t_blk
, 
íd_blk
);

308 
time
 = 
	`cuºít_time
(
öode
).
tv_£c
;

310 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

311 
upd©e
.
èû
 = 
pi
->
log_èû
;

312 
upd©e
.
Æãr_èû
 = 
pi
->
Æãr_log_èû
;

314 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

316 
°¨t_blk
 < 
íd_blk
) {

317 
íåy
 = 
	`nova_gë_wrôe_íåy
(
sb
, 
sih
, 
°¨t_blk
);

318 i‡(!
íåy
) {

319 
	`nova_dbgv
("%s: Found hole:Ögoff %lu\n",

320 
__func__
, 
°¨t_blk
);

323 
íåy
 = 
	`nova_föd_√xt_íåy
(
sb
, 
sih
, 
°¨t_blk
);

324 i‡(!
íåy
)

327 i‡(
mëad©a_csum
 == 0)

328 
íåyc
 = 
íåy
;

329 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

332 
°¨t_blk
 = 
íåyc
->
pgoff
;

333 i‡(
°¨t_blk
 >
íd_blk
)

336 i‡(
mëad©a_csum
 == 0)

337 
íåyc
 = 
íåy
;

338 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

342 i‡(
íåyc
->
ïoch_id
 ==Époch_id) {

347 
‰om_blockƒ
 = 
	`gë_nvmm
(
sb
, 
sih
, 
íåyc
, 
°¨t_blk
);

348 
‰om_blockoff
 = 
	`nova_gë_block_off
(
sb
, 
‰om_blockƒ
,

349 
pi
->
i_blk_ty≥
);

350 
‰om_kmem
 = 
	`nova_gë_block
(
sb
, 
‰om_blockoff
);

352 i‡(
íåyc
->
ªassig√d
 == 0)

353 
avaû_blocks
 = 
íåyc
->
num_∑ges
 -

354 (
°¨t_blk
 - 
íåyc
->
pgoff
);

356 
avaû_blocks
 = 1;

358 i‡(
avaû_blocks
 > 
íd_blk
 - 
°¨t_blk
)

359 
avaû_blocks
 = 
íd_blk
 - 
°¨t_blk
;

361 
Æloˇãd
 = 
	`nova_√w_d©a_blocks
(
sb
, 
sih
, &
blockƒ
, 
°¨t_blk
,

362 
avaû_blocks
, 
ALLOC_NO_INIT
, 
ANY_CPU
,

363 
ALLOC_FROM_HEAD
);

365 
	`nova_dbgv
("%s:áŒo¯%d block†@ %lu\n", 
__func__
,

366 
Æloˇãd
, 
blockƒ
);

368 i‡(
Æloˇãd
 <= 0) {

369 
	`nova_dbg
("%sálloc blocks failed!, %d\n",

370 
__func__
, 
Æloˇãd
);

371 
ªt
 = 
Æloˇãd
;

372 
out
;

375 
to_blockoff
 = 
	`nova_gë_block_off
(
sb
, 
blockƒ
,

376 
pi
->
i_blk_ty≥
);

377 
to_kmem
 = 
	`nova_gë_block
(
sb
, 
to_blockoff
);

378 
íåy_pgoff
 = 
°¨t_blk
;

380 
c›y_blocks
 = 
Æloˇãd
;

382 
byãs
 = 
sb
->
s_blocksize
 * 
c›y_blocks
;

385 
	`NOVA_START_TIMING
(
mem˝y_w_wb_t
, 
mem˝y_time
);

386 
	`nova_memu∆ock_ønge
(
sb
, 
to_kmem
, 
byãs
, &
úq_Êags
);

387 
c›õd
 = 
byãs
 - 
	`mem˝y_to_pmem_noˇche
(
to_kmem
, 
‰om_kmem
,

388 
byãs
);

389 
	`nova_memlock_ønge
(
sb
, 
to_kmem
, 
byãs
, &
úq_Êags
);

390 
	`NOVA_END_TIMING
(
mem˝y_w_wb_t
, 
mem˝y_time
);

392 i‡(
c›õd
 =
byãs
) {

393 
°¨t_blk
 +
c›y_blocks
;

395 
	`nova_dbg
("%s ERROR!: bytes %lu, copied %lu\n",

396 
__func__
, 
byãs
, 
c›õd
);

397 
ªt
 = -
EFAULT
;

398 
out
;

401 
íåy_size
 = 
	`˝u_to_À64
(
öode
->
i_size
);

403 
	`nova_öô_fûe_wrôe_íåy
(
sb
, 
sih
, &
íåy_d©a
,

404 
ïoch_id
, 
íåy_pgoff
, 
c›y_blocks
,

405 
blockƒ
, 
time
, 
íåy_size
);

407 
ªt
 = 
	`nova_≠≥nd_fûe_wrôe_íåy
(
sb
, 
pi
, 
öode
,

408 &
íåy_d©a
, &
upd©e
);

409 i‡(
ªt
) {

410 
	`nova_dbg
("%s:áppend inodeÉntry failed\n",

411 
__func__
);

412 
ªt
 = -
ENOSPC
;

413 
out
;

416 i‡(
begö_èû
 == 0)

417 
begö_èû
 = 
upd©e
.
cuº_íåy
;

420 i‡(
begö_èû
 == 0)

421 
out
;

423 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

424 
	`nova_upd©e_öode
(
sb
, 
öode
, 
pi
, &
upd©e
, 1);

425 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

428 
ªt
 = 
	`nova_ªassign_fûe_åì
(
sb
, 
sih
, 
begö_èû
);

429 i‡(
ªt
)

430 
out
;

434 
ªt
 = 
	`nova_dax_cow_mm≠_h™dÀr
(
sb
, 
vma
, 
sih
, 
begö_èû
);

435 i‡(
ªt
)

436 
out
;

439 
sih
->
å™s_id
++;

441 
out
:

442 i‡(
ªt
 < 0)

443 
	`nova_˛ónup_öcom∂ëe_wrôe
(
sb
, 
sih
, 
blockƒ
, 
Æloˇãd
,

444 
begö_èû
, 
upd©e
.
èû
);

446 
	`öode_u∆ock
(
öode
);

447 
	`NOVA_END_TIMING
(
mm≠_cow_t
, 
mm≠_cow_time
);

448  
ªt
;

449 
	}
}

451 
	$nova_£t_vma_ªad
(
vm_¨ó_°ru˘
 *
vma
)

453 
mm_°ru˘
 *
mm
 = 
vma
->
vm_mm
;

454 
ﬁdÊags
 = 
vma
->
vm_Êags
;

455 
√wÊags
;

457 
mmu_g©hî
 
éb
;

459 
	`mm≠_wrôe_lock
(
mm
);

461 
√wÊags
 = 
ﬁdÊags
 & (~
VM_WRITE
);

462 i‡(
ﬁdÊags
 =
√wÊags
)

463 
out
;

465 
	`nova_dbgv
("Set vma %pÑead, start 0x%lx,Énd 0x%lx\n",

466 
vma
, vma->
vm_°¨t
,

467 
vma
->
vm_íd
);

470 
	`éb_g©hî_mmu
(&
éb
, 
mm
);

473 
	`ch™ge_¥Ÿe˘i⁄
(&
éb
, 
vma
, vma->
vm_°¨t
, vma->
vm_íd
, 
MM_CP_UFFD_WP_ALL
);

474 
	`éb_föish_mmu
(&
éb
);

475 
vma
->
‹igöÆ_wrôe
 = 1;

477 
out
:

478 
	`mm≠_wrôe_u∆ock
(
mm
);

481 
	}
}

483 
ölöe
 
boﬁ
 
	$pgoff_ö_vma
(
vm_¨ó_°ru˘
 *
vma
,

484 
pgoff
)

486 
num_∑ges
;

488 
num_∑ges
 = (
vma
->
vm_íd
 - vma->
vm_°¨t
Ë>> 
PAGE_SHIFT
;

490 i‡(
pgoff
 >
vma
->
vm_pgoff
 &&Ögof‡< vma->vm_pgof‡+ 
num_∑ges
)

491  
åue
;

493  
Ál£
;

494 
	}
}

496 
boﬁ
 
	$nova_föd_pgoff_ö_vma
(
öode
 *öode, 
pgoff
)

498 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

499 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

500 
vma_ôem
 *
ôem
;

501 
rb_node
 *
ãmp
;

502 
boﬁ
 
ªt
 = 
Ál£
;

504 i‡(
sih
->
num_vmas
 == 0)

505  
ªt
;

507 
ãmp
 = 
	`rb_fú°
(&
sih
->
vma_åì
);

508 
ãmp
) {

509 
ôem
 = 
	`c⁄èöî_of
(
ãmp
, 
vma_ôem
, 
node
);

510 
ãmp
 = 
	`rb_√xt
(temp);

511 i‡(
	`pgoff_ö_vma
(
ôem
->
vma
, 
pgoff
)) {

512 
ªt
 = 
åue
;

517  
ªt
;

518 
	}
}

520 
	$nova_£t_sih_vmas_ªad⁄ly
(
nova_öode_öfo_hódî
 *
sih
)

522 
vma_ôem
 *
ôem
;

523 
rb_node
 *
ãmp
;

524 
	`INIT_TIMING
(
£t_ªad_time
);

526 
	`NOVA_START_TIMING
(
£t_vma_ªad_t
, 
£t_ªad_time
);

528 
ãmp
 = 
	`rb_fú°
(&
sih
->
vma_åì
);

529 
ãmp
) {

530 
ôem
 = 
	`c⁄èöî_of
(
ãmp
, 
vma_ôem
, 
node
);

531 
ãmp
 = 
	`rb_√xt
(temp);

532 
	`nova_£t_vma_ªad
(
ôem
->
vma
);

535 
	`NOVA_END_TIMING
(
£t_vma_ªad_t
, 
£t_ªad_time
);

537 
	}
}

539 
	$nova_£t_vmas_ªad⁄ly
(
su≥r_block
 *
sb
)

541 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

542 
nova_öode_öfo_hódî
 *
sih
;

544 
	`nova_dbgv
("%s\n", 
__func__
);

545 
	`muãx_lock
(&
sbi
->
vma_muãx
);

546 
	`li°_f‹_óch_íåy
(
sih
, &
sbi
->
mm≠_sih_li°
, 
li°
)

547 
	`nova_£t_sih_vmas_ªad⁄ly
(
sih
);

548 
	`muãx_u∆ock
(&
sbi
->
vma_muãx
);

551 
	}
}

554 
	$nova_de°roy_vma_åì
(
su≥r_block
 *
sb
)

556 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

557 
vma_ôem
 *
ôem
;

558 
rb_node
 *
ãmp
;

560 
	`nova_dbgv
("%s\n", 
__func__
);

561 
	`muãx_lock
(&
sbi
->
vma_muãx
);

562 
ãmp
 = 
	`rb_fú°
(&
sbi
->
vma_åì
);

563 
ãmp
) {

564 
ôem
 = 
	`c⁄èöî_of
(
ãmp
, 
vma_ôem
, 
node
);

565 
ãmp
 = 
	`rb_√xt
(temp);

566 
	`rb_îa£
(&
ôem
->
node
, &
sbi
->
vma_åì
);

567 
	`k‰ì
(
ôem
);

569 
	`muãx_u∆ock
(&
sbi
->
vma_muãx
);

572 
	}
}

	@mprotect.h

21 #i‚de‡
__WPROTECT_H


22 
	#__WPROTECT_H


	)

24 
	~<löux/fs.h
>

25 
	~"nova_def.h
"

26 
	~"su≥r.h
"

28 
nova_îr‹_mng
(
su≥r_block
 *
sb
, c⁄° *
fmt
, ...);

30 
ölöe
 
	$nova_ønge_check
(
su≥r_block
 *
sb
, *
p
,

31 
Àn
)

33 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

35 i‡(
p
 < 
sbi
->
vút_addr
 ||

36 
p
 + 
Àn
 > 
sbi
->
vút_addr
 + sbi->
öôsize
) {

37 
	`nova_îr
(
sb
, "accessÖmem out ofÑange:ÖmemÑange 0x%lx - 0x%lx, "

39 ()
sbi
->
vút_addr
,

40 ()(
sbi
->
vút_addr
 + sbi->
öôsize
),

41 ()
p
, ()’ + 
Àn
));

42 
	`dump_°ack
();

43  -
EINVAL
;

47 
	}
}

49 
ölöe
 
	$w¥Ÿe˘_dißbÀ
()

51 
¸0_vÆ
;

53 
¸0_vÆ
 = 
	`ªad_¸0
();

54 
¸0_vÆ
 &(~
X86_CR0_WP
);

55 
	`wrôe_¸0
(
¸0_vÆ
);

56 
	}
}

58 
ölöe
 
	$w¥Ÿe˘_íabÀ
()

60 
¸0_vÆ
;

62 
¸0_vÆ
 = 
	`ªad_¸0
();

63 
¸0_vÆ
 |
X86_CR0_WP
;

64 
	`wrôe_¸0
(
¸0_vÆ
);

65 
	}
}

71 
ölöe
 

72 
	$nova_wrôóbÀ
(*
vaddr
, 
size
, 
rw
, *
Êags
)

74 
	`INIT_TIMING
(
w¥Ÿe˘_time
);

76 
	`NOVA_START_TIMING
(
w¥Ÿe˘_t
, 
w¥Ÿe˘_time
);

77 i‡(
rw
) {

78 
	`loˇl_úq_ßve
(*
Êags
);

79 
	`w¥Ÿe˘_dißbÀ
();

81 
	`w¥Ÿe˘_íabÀ
();

82 
	`loˇl_úq_ª°‹e
(*
Êags
);

84 
	`NOVA_END_TIMING
(
w¥Ÿe˘_t
, 
w¥Ÿe˘_time
);

86 
	}
}

88 
ölöe
 
	$nova_is_¥Ÿe˘ed
(
su≥r_block
 *
sb
)

90 
nova_sb_öfo
 *
sbi
 = (nova_sb_öfÿ*)
sb
->
s_fs_öfo
;

92 i‡(
w¥Ÿe˘
)

93  
w¥Ÿe˘
;

95  
sbi
->
s_mou¡_›t
 & 
NOVA_MOUNT_PROTECT
;

96 
	}
}

98 
ölöe
 
	$nova_is_w¥Ÿe˘ed
(
su≥r_block
 *
sb
)

100  
	`nova_is_¥Ÿe˘ed
(
sb
);

101 
	}
}

103 
ölöe
 

104 
	$__nova_memu∆ock_ønge
(*
p
, 
Àn
, *
Êags
)

113 
	`nova_wrôóbÀ
(
p
, 
Àn
, 1, 
Êags
);

114 
	}
}

116 
ölöe
 

117 
	$__nova_memlock_ønge
(*
p
, 
Àn
, *
Êags
)

119 
	`nova_wrôóbÀ
(
p
, 
Àn
, 0, 
Êags
);

120 
	}
}

122 
ölöe
 
	$nova_memu∆ock_ønge
(
su≥r_block
 *
sb
, *
p
,

123 
Àn
, *
Êags
)

125 i‡(
	`nova_ønge_check
(
sb
, 
p
, 
Àn
))

128 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

129 
	`__nova_memu∆ock_ønge
(
p
, 
Àn
, 
Êags
);

130 
	}
}

132 
ölöe
 
	$nova_memlock_ønge
(
su≥r_block
 *
sb
, *
p
,

133 
Àn
, *
Êags
)

135 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

136 
	`__nova_memlock_ønge
(
p
, 
Àn
, 
Êags
);

137 
	}
}

139 
ölöe
 
	$nova_memu∆ock_su≥r
(
su≥r_block
 *
sb
, *
Êags
)

141 
nova_su≥r_block
 *
ps
 = 
	`nova_gë_su≥r
(
sb
);

143 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

144 
	`__nova_memu∆ock_ønge
(
ps
, 
NOVA_SB_SIZE
, 
Êags
);

145 
	}
}

147 
ölöe
 
	$nova_memlock_su≥r
(
su≥r_block
 *
sb
, *
Êags
)

149 
nova_su≥r_block
 *
ps
 = 
	`nova_gë_su≥r
(
sb
);

151 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

152 
	`__nova_memlock_ønge
(
ps
, 
NOVA_SB_SIZE
, 
Êags
);

153 
	}
}

155 
ölöe
 
	$nova_memu∆ock_ª£rved
(
su≥r_block
 *
sb
,

156 
nova_su≥r_block
 *
ps
, *
Êags
)

158 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

160 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

161 
	`__nova_memu∆ock_ønge
(
ps
,

162 
sbi
->
hód_ª£rved_blocks
 * 
NOVA_DEF_BLOCK_SIZE_4K
, 
Êags
);

163 
	}
}

165 
ölöe
 
	$nova_memlock_ª£rved
(
su≥r_block
 *
sb
,

166 
nova_su≥r_block
 *
ps
, *
Êags
)

168 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

170 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

171 
	`__nova_memlock_ønge
(
ps
,

172 
sbi
->
hód_ª£rved_blocks
 * 
NOVA_DEF_BLOCK_SIZE_4K
, 
Êags
);

173 
	}
}

175 
ölöe
 
	$nova_memu∆ock_jou∫Æ
(
su≥r_block
 *
sb
, *
Êags
)

177 *
addr
 = 
	`nova_gë_block
(
sb
, 
NOVA_DEF_BLOCK_SIZE_4K
 * 
JOURNAL_START
);

179 i‡(
	`nova_ønge_check
(
sb
, 
addr
, 
NOVA_DEF_BLOCK_SIZE_4K
))

182 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

183 
	`__nova_memu∆ock_ønge
(
addr
, 
NOVA_DEF_BLOCK_SIZE_4K
, 
Êags
);

184 
	}
}

186 
ölöe
 
	$nova_memlock_jou∫Æ
(
su≥r_block
 *
sb
, *
Êags
)

188 *
addr
 = 
	`nova_gë_block
(
sb
, 
NOVA_DEF_BLOCK_SIZE_4K
 * 
JOURNAL_START
);

190 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

191 
	`__nova_memlock_ønge
(
addr
, 
NOVA_DEF_BLOCK_SIZE_4K
, 
Êags
);

192 
	}
}

194 
ölöe
 
	$nova_memu∆ock_öode
(
su≥r_block
 *
sb
,

195 
nova_öode
 *
pi
, *
Êags
)

197 i‡(
	`nova_ønge_check
(
sb
, 
pi
, 
NOVA_INODE_SIZE
))

200 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

201 
	`__nova_memu∆ock_ønge
(
pi
, 
NOVA_INODE_SIZE
, 
Êags
);

202 
	}
}

204 
ölöe
 
	$nova_memlock_öode
(
su≥r_block
 *
sb
,

205 
nova_öode
 *
pi
, *
Êags
)

208 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

209 
	`__nova_memlock_ønge
(
pi
, 
NOVA_INODE_SIZE
, 
Êags
);

210 
	}
}

212 
ölöe
 
	$nova_memu∆ock_block
(
su≥r_block
 *
sb
, *
bp
, *
Êags
)

214 i‡(
	`nova_ønge_check
(
sb
, 
bp
, sb->
s_blocksize
))

217 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

218 
	`__nova_memu∆ock_ønge
(
bp
, 
sb
->
s_blocksize
, 
Êags
);

219 
	}
}

221 
ölöe
 
	$nova_memlock_block
(
su≥r_block
 *
sb
, *
bp
, *
Êags
)

223 i‡(
	`nova_is_¥Ÿe˘ed
(
sb
))

224 
	`__nova_memlock_ønge
(
bp
, 
sb
->
s_blocksize
, 
Êags
);

225 
	}
}

	@namei.c

17 
	~<löux/fs.h
>

18 
	~<löux/∑gem≠.h
>

19 
	~"nova.h
"

20 
	~"jou∫Æ.h
"

21 
	~"öode.h
"

23 
öo_t
 
	$nova_öode_by_«me
(
öode
 *
dú
, 
q°r
 *
íåy
,

24 
nova_díåy
 **
ªs_íåy
)

26 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

27 
nova_díåy
 *
dúíåy
;

28 
nova_díåy
 *
dúíåyc
, 
íåy_c›y
;

30 
dúíåy
 = 
	`nova_föd_díåy
(
sb
, 
NULL
, 
dú
,

31 
íåy
->
«me
,É¡ry->
Àn
);

32 i‡(
dúíåy
 =
NULL
)

35 i‡(
mëad©a_csum
 == 0)

36 
dúíåyc
 = 
dúíåy
;

38 
dúíåyc
 = &
íåy_c›y
;

39 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
dúíåy
, 
dúíåyc
))

43 *
ªs_íåy
 = 
dúíåy
;

44  
dúíåyc
->
öo
;

45 
	}
}

47 
díåy
 *
	$nova_lookup
(
öode
 *
dú
, 
díåy
 *dentry,

48 
Êags
)

50 
öode
 *öodê
NULL
;

51 
nova_díåy
 *
de
;

52 
öo_t
 
öo
;

53 
	`INIT_TIMING
(
lookup_time
);

55 
	`NOVA_START_TIMING
(
lookup_t
, 
lookup_time
);

56 i‡(
díåy
->
d_«me
.
Àn
 > 
NOVA_NAME_LEN
) {

57 
	`nova_dbg
("%s:Çamelen %uÉxceedsÜimit\n",

58 
__func__
, 
díåy
->
d_«me
.
Àn
);

59  
	`ERR_PTR
(-
ENAMETOOLONG
);

62 
	`nova_dbg_vîbo£
("%s: %s\n", 
__func__
, 
díåy
->
d_«me
.
«me
);

63 
öo
 = 
	`nova_öode_by_«me
(
dú
, &
díåy
->
d_«me
, &
de
);

64 
	`nova_dbg_vîbo£
("%s: inÿ%lu\n", 
__func__
, 
öo
);

65 i‡(
öo
) {

66 
öode
 = 
	`nova_igë
(
dú
->
i_sb
, 
öo
);

67 i‡(
öode
 =
	`ERR_PTR
(-
ESTALE
Ë|| inodê=ERR_PTR(-
ENOMEM
)

68 || 
öode
 =
	`ERR_PTR
(-
EACCES
)) {

69 
	`nova_îr
(
dú
->
i_sb
,

71 
__func__
, ()
öo
);

72  
	`ERR_PTR
(-
EIO
);

76 
	`NOVA_END_TIMING
(
lookup_t
, 
lookup_time
);

77  
	`d_•li˚_Æüs
(
öode
, 
díåy
);

78 
	}
}

80 
	$nova_lôe_å™ß˘i⁄_f‹_√w_öode
(
su≥r_block
 *
sb
,

81 
nova_öode
 *
pi
, nova_öodê*
pidú
, 
öode
 *inode,

82 
öode
 *
dú
, 
nova_öode_upd©e
 *
upd©e
)

84 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

85 
˝u
;

86 
u64
 
jou∫Æ_èû
;

87 
úq_Êags
 = 0;

88 
	`INIT_TIMING
(
å™s_time
);

90 
	`NOVA_START_TIMING
(
¸óã_å™s_t
, 
å™s_time
);

92 
˝u
 = 
	`nova_gë_˝uid
(
sb
);

93 
	`•ö_lock
(&
sbi
->
jou∫Æ_locks
[
˝u
]);

94 
	`nova_memu∆ock_jou∫Æ
(
sb
, &
úq_Êags
);

98 
jou∫Æ_èû
 = 
	`nova_¸óã_öode_å™ß˘i⁄
(
sb
, 
öode
, 
dú
, 
˝u
, 1, 0);

100 
	`nova_upd©e_öode
(
sb
, 
dú
, 
pidú
, 
upd©e
, 0);

102 
pi
->
vÆid
 = 1;

103 
	`nova_upd©e_öode_checksum
(
pi
);

104 
	`PERSISTENT_BARRIER
();

106 
	`nova_commô_lôe_å™ß˘i⁄
(
sb
, 
jou∫Æ_èû
, 
˝u
);

107 
	`nova_memlock_jou∫Æ
(
sb
, &
úq_Êags
);

108 
	`•ö_u∆ock
(&
sbi
->
jou∫Æ_locks
[
˝u
]);

110 i‡(
mëad©a_csum
) {

111 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

112 
	`nova_upd©e_Æãr_öode
(
sb
, 
öode
, 
pi
);

113 
	`nova_upd©e_Æãr_öode
(
sb
, 
dú
, 
pidú
);

114 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

116 
	`NOVA_END_TIMING
(
¸óã_å™s_t
, 
å™s_time
);

117 
	}
}

131 
	$nova_¸óã
(
m¡_idm≠
 *
idm≠
,

132 
öode
 *
dú
, 
díåy
 *dentry,

133 
umode_t
 
mode
, 
boﬁ
 
ex˛
)

135 
öode
 *öodê
NULL
;

136 
îr
 = 
	`PTR_ERR
(
öode
);

137 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

138 
nova_öode
 *
pidú
, *
pi
;

139 
nova_öode_upd©e
 
upd©e
;

140 
u64
 
pi_addr
 = 0;

141 
u64
 
öo
, 
ïoch_id
;

142 
	`INIT_TIMING
(
¸óã_time
);

144 
	`NOVA_START_TIMING
(
¸óã_t
, 
¸óã_time
);

146 
pidú
 = 
	`nova_gë_öode
(
sb
, 
dú
);

147 i‡(!
pidú
)

148 
out_îr
;

150 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

151 
öo
 = 
	`nova_√w_nova_öode
(
sb
, &
pi_addr
);

152 i‡(
öo
 == 0)

153 
out_îr
;

155 
upd©e
.
èû
 = 0;

156 
upd©e
.
Æãr_èû
 = 0;

157 
îr
 = 
	`nova_add_díåy
(
díåy
, 
öo
, 0, &
upd©e
, 
ïoch_id
);

158 i‡(
îr
)

159 
out_îr
;

161 
	`nova_dbgv
("%s: %s\n", 
__func__
, 
díåy
->
d_«me
.
«me
);

162 
	`nova_dbgv
("%s: inodê%Œu, dú %lu\n", 
__func__
, 
öo
, 
dú
->
i_öo
);

163 
öode
 = 
	`nova_√w_vfs_öode
(
TYPE_CREATE
, 
dú
, 
pi_addr
, 
öo
, 
mode
,

164 0, 0, &
díåy
->
d_«me
, 
ïoch_id
);

165 i‡(
	`IS_ERR
(
öode
))

166 
out_îr
;

168 
	`d_ö°™tüã
(
díåy
, 
öode
);

169 
	`u∆ock_√w_öode
(
öode
);

171 
pi
 = 
	`nova_gë_block
(
sb
, 
pi_addr
);

172 
	`nova_lôe_å™ß˘i⁄_f‹_√w_öode
(
sb
, 
pi
, 
pidú
, 
öode
, 
dú
,

173 &
upd©e
);

174 
	`NOVA_END_TIMING
(
¸óã_t
, 
¸óã_time
);

175  
îr
;

176 
out_îr
:

177 
	`nova_îr
(
sb
, "%†ªtu∫ %d\n", 
__func__
, 
îr
);

178 
	`NOVA_END_TIMING
(
¸óã_t
, 
¸óã_time
);

179  
îr
;

180 
	}
}

185 
	$nova_mknod
(
m¡_idm≠
 *
idm≠
,

186 
öode
 *
dú
, 
díåy
 *dentry,

187 
umode_t
 
mode
, 
dev_t
 
rdev
)

189 
öode
 *öodê
NULL
;

190 
îr
 = 
	`PTR_ERR
(
öode
);

191 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

192 
u64
 
pi_addr
 = 0;

193 
nova_öode
 *
pidú
, *
pi
;

194 
nova_öode_upd©e
 
upd©e
;

195 
u64
 
öo
;

196 
u64
 
ïoch_id
;

197 
	`INIT_TIMING
(
mknod_time
);

199 
	`NOVA_START_TIMING
(
mknod_t
, 
mknod_time
);

201 
pidú
 = 
	`nova_gë_öode
(
sb
, 
dú
);

202 i‡(!
pidú
)

203 
out_îr
;

205 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

206 
öo
 = 
	`nova_√w_nova_öode
(
sb
, &
pi_addr
);

207 i‡(
öo
 == 0)

208 
out_îr
;

210 
	`nova_dbgv
("%s: %s\n", 
__func__
, 
díåy
->
d_«me
.
«me
);

211 
	`nova_dbgv
("%s: inodê%Œu, dú %lu\n", 
__func__
, 
öo
, 
dú
->
i_öo
);

213 
upd©e
.
èû
 = 0;

214 
upd©e
.
Æãr_èû
 = 0;

215 
îr
 = 
	`nova_add_díåy
(
díåy
, 
öo
, 0, &
upd©e
, 
ïoch_id
);

216 i‡(
îr
)

217 
out_îr
;

219 
öode
 = 
	`nova_√w_vfs_öode
(
TYPE_MKNOD
, 
dú
, 
pi_addr
, 
öo
, 
mode
,

220 0, 
rdev
, &
díåy
->
d_«me
, 
ïoch_id
);

221 i‡(
	`IS_ERR
(
öode
))

222 
out_îr
;

224 
	`d_ö°™tüã
(
díåy
, 
öode
);

225 
	`u∆ock_√w_öode
(
öode
);

227 
pi
 = 
	`nova_gë_block
(
sb
, 
pi_addr
);

228 
	`nova_lôe_å™ß˘i⁄_f‹_√w_öode
(
sb
, 
pi
, 
pidú
, 
öode
, 
dú
,

229 &
upd©e
);

230 
	`NOVA_END_TIMING
(
mknod_t
, 
mknod_time
);

231  
îr
;

232 
out_îr
:

233 
	`nova_îr
(
sb
, "%†ªtu∫ %d\n", 
__func__
, 
îr
);

234 
	`NOVA_END_TIMING
(
mknod_t
, 
mknod_time
);

235  
îr
;

236 
	}
}

241 
	$nova_symlök
(
m¡_idm≠
 *
idm≠
,

242 
öode
 *
dú
, 
díåy
 *dentry,

243 c⁄° *
sym«me
)

245 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

246 
îr
 = -
ENAMETOOLONG
;

247 
Àn
 = 
	`°æí
(
sym«me
);

248 
öode
 *inode;

249 
nova_öode_öfo
 *
si
;

250 
nova_öode_öfo_hódî
 *
sih
;

251 
u64
 
pi_addr
 = 0;

252 
nova_öode
 *
pidú
, *
pi
;

253 
nova_öode_upd©e
 
upd©e
;

254 
u64
 
öo
;

255 
u64
 
ïoch_id
;

256 
	`INIT_TIMING
(
symlök_time
);

258 
	`NOVA_START_TIMING
(
symlök_t
, 
symlök_time
);

259 i‡(
Àn
 + 1 > 
sb
->
s_blocksize
)

260 
out
;

262 
pidú
 = 
	`nova_gë_öode
(
sb
, 
dú
);

263 i‡(!
pidú
)

264 
out_Áû
;

266 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

267 
öo
 = 
	`nova_√w_nova_öode
(
sb
, &
pi_addr
);

268 i‡(
öo
 == 0)

269 
out_Áû
;

271 
	`nova_dbgv
("%s:Çamê%s, sym«mê%s\n", 
__func__
,

272 
díåy
->
d_«me
.
«me
, 
sym«me
);

273 
	`nova_dbgv
("%s: inodê%Œu, dú %lu\n", 
__func__
, 
öo
, 
dú
->
i_öo
);

275 
upd©e
.
èû
 = 0;

276 
upd©e
.
Æãr_èû
 = 0;

277 
îr
 = 
	`nova_add_díåy
(
díåy
, 
öo
, 0, &
upd©e
, 
ïoch_id
);

278 i‡(
îr
)

279 
out_Áû
;

281 
öode
 = 
	`nova_√w_vfs_öode
(
TYPE_SYMLINK
, 
dú
, 
pi_addr
, 
öo
,

282 
S_IFLNK
|0777, 
Àn
, 0,

283 &
díåy
->
d_«me
, 
ïoch_id
);

284 i‡(
	`IS_ERR
(
öode
)) {

285 
îr
 = 
	`PTR_ERR
(
öode
);

286 
out_Áû
;

289 
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

291 
si
 = 
	`NOVA_I
(
öode
);

292 
sih
 = &
si
->
hódî
;

294 
îr
 = 
	`nova_block_symlök
(
sb
, 
pi
, 
öode
, 
sym«me
, 
Àn
, 
ïoch_id
);

295 i‡(
îr
)

296 
out_Áû
;

298 
	`d_ö°™tüã
(
díåy
, 
öode
);

299 
	`u∆ock_√w_öode
(
öode
);

301 
	`nova_lôe_å™ß˘i⁄_f‹_√w_öode
(
sb
, 
pi
, 
pidú
, 
öode
, 
dú
,

302 &
upd©e
);

303 
out
:

304 
	`NOVA_END_TIMING
(
symlök_t
, 
symlök_time
);

305  
îr
;

307 
out_Áû
:

308 
	`nova_îr
(
sb
, "%†ªtu∫ %d\n", 
__func__
, 
îr
);

309 
out
;

310 
	}
}

312 
	$nova_lôe_å™ß˘i⁄_f‹_time_™d_lök
(
su≥r_block
 *
sb
,

313 
nova_öode
 *
pi
, nova_öodê*
pidú
, 
öode
 *inode,

314 
öode
 *
dú
, 
nova_öode_upd©e
 *
upd©e
,

315 
nova_öode_upd©e
 *
upd©e_dú
, 
övÆid©e
, 
u64
 
ïoch_id
)

317 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

318 
u64
 
jou∫Æ_èû
;

319 
˝u
;

320 
úq_Êags
 = 0;

321 
	`INIT_TIMING
(
å™s_time
);

323 
	`NOVA_START_TIMING
(
lök_å™s_t
, 
å™s_time
);

325 
˝u
 = 
	`nova_gë_˝uid
(
sb
);

326 
	`•ö_lock
(&
sbi
->
jou∫Æ_locks
[
˝u
]);

327 
	`nova_memu∆ock_jou∫Æ
(
sb
, &
úq_Êags
);

331 
jou∫Æ_èû
 = 
	`nova_¸óã_öode_å™ß˘i⁄
(
sb
, 
öode
, 
dú
, 
˝u
,

332 0, 
övÆid©e
);

334 i‡(
övÆid©e
) {

335 
pi
->
vÆid
 = 0;

336 
pi
->
dñëe_ïoch_id
 = 
ïoch_id
;

338 
	`nova_upd©e_öode
(
sb
, 
öode
, 
pi
, 
upd©e
, 0);

340 
	`nova_upd©e_öode
(
sb
, 
dú
, 
pidú
, 
upd©e_dú
, 0);

342 
	`PERSISTENT_BARRIER
();

344 
	`nova_commô_lôe_å™ß˘i⁄
(
sb
, 
jou∫Æ_èû
, 
˝u
);

345 
	`nova_memlock_jou∫Æ
(
sb
, &
úq_Êags
);

346 
	`•ö_u∆ock
(&
sbi
->
jou∫Æ_locks
[
˝u
]);

348 i‡(
mëad©a_csum
) {

349 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

350 
	`nova_upd©e_Æãr_öode
(
sb
, 
öode
, 
pi
);

351 
	`nova_upd©e_Æãr_öode
(
sb
, 
dú
, 
pidú
);

352 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

355 
	`NOVA_END_TIMING
(
lök_å™s_t
, 
å™s_time
);

356 
	}
}

358 
	$nova_lök
(
díåy
 *
de°_díåy
, 
öode
 *
dú
,

359 
díåy
 *dentry)

361 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

362 
öode
 *öodê
de°_díåy
->
d_öode
;

363 
nova_öode
 *
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

364 
nova_öode
 *
pidú
;

365 
nova_öode_upd©e
 
upd©e_dú
;

366 
nova_öode_upd©e
 
upd©e
;

367 
u64
 
ﬁd_lökc
 = 0;

368 
u64
 
ïoch_id
;

369 
îr
 = -
ENOMEM
;

370 
	`INIT_TIMING
(
lök_time
);

372 
	`NOVA_START_TIMING
(
lök_t
, 
lök_time
);

373 i‡(
öode
->
i_∆ök
 >
NOVA_LINK_MAX
) {

374 
îr
 = -
EMLINK
;

375 
out
;

378 
pidú
 = 
	`nova_gë_öode
(
sb
, 
dú
);

379 i‡(!
pidú
) {

380 
îr
 = -
EINVAL
;

381 
out
;

384 
	`ihﬁd
(
öode
);

385 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

387 
	`nova_dbgv
("%s:Çamê%s, de° %s\n", 
__func__
,

388 
díåy
->
d_«me
.
«me
, 
de°_díåy
->d_name.name);

389 
	`nova_dbgv
("%s: inodê%lu, dú %lu\n", 
__func__
,

390 
öode
->
i_öo
, 
dú
->i_ino);

392 
upd©e_dú
.
èû
 = 0;

393 
upd©e_dú
.
Æãr_èû
 = 0;

394 
îr
 = 
	`nova_add_díåy
(
díåy
, 
öode
->
i_öo
, 0, &
upd©e_dú
, 
ïoch_id
);

395 i‡(
îr
) {

396 
	`ùut
(
öode
);

397 
out
;

401 
	`öode_£t_˘ime_cuºít
(
öode
);

403 
	`öc_∆ök
(
öode
);

405 
upd©e
.
èû
 = 0;

406 
upd©e
.
Æãr_èû
 = 0;

407 
îr
 = 
	`nova_≠≥nd_lök_ch™ge_íåy
(
sb
, 
pi
, 
öode
, &
upd©e
,

408 &
ﬁd_lökc
, 
ïoch_id
);

409 i‡(
îr
) {

410 
	`ùut
(
öode
);

411 
out
;

414 
	`d_ö°™tüã
(
díåy
, 
öode
);

415 
	`nova_lôe_å™ß˘i⁄_f‹_time_™d_lök
(
sb
, 
pi
, 
pidú
, 
öode
, 
dú
,

416 &
upd©e
, &
upd©e_dú
, 0, 
ïoch_id
);

418 
	`nova_övÆid©e_lök_ch™ge_íåy
(
sb
, 
ﬁd_lökc
);

420 
out
:

421 
	`NOVA_END_TIMING
(
lök_t
, 
lök_time
);

422  
îr
;

423 
	}
}

425 
	$nova_u∆ök
(
öode
 *
dú
, 
díåy
 *dentry)

427 
öode
 *öodê
díåy
->
d_öode
;

428 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

429 
ªtvÆ
 = -
ENOMEM
;

430 
nova_öode
 *
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

431 
nova_öode
 *
pidú
;

432 
nova_öode_upd©e
 
upd©e_dú
;

433 
nova_öode_upd©e
 
upd©e
;

434 
u64
 
ﬁd_lökc
 = 0;

435 
u64
 
ïoch_id
;

436 
övÆid©e
 = 0;

437 
	`INIT_TIMING
(
u∆ök_time
);

439 
	`NOVA_START_TIMING
(
u∆ök_t
, 
u∆ök_time
);

441 
pidú
 = 
	`nova_gë_öode
(
sb
, 
dú
);

442 i‡(!
pidú
)

443 
out
;

445 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

446 
	`nova_dbgv
("%s: %s\n", 
__func__
, 
díåy
->
d_«me
.
«me
);

447 
	`nova_dbgv
("%s: inodê%lu, dú %lu\n", 
__func__
,

448 
öode
->
i_öo
, 
dú
->i_ino);

450 
upd©e_dú
.
èû
 = 0;

451 
upd©e_dú
.
Æãr_èû
 = 0;

452 
ªtvÆ
 = 
	`nova_ªmove_díåy
(
díåy
, 0, &
upd©e_dú
, 
ïoch_id
);

453 i‡(
ªtvÆ
)

454 
out
;

457 
	`öode_£t_˘ime_to_ts
(
öode
, 
	`öode_gë_˘ime
(
dú
));

459 i‡(
öode
->
i_∆ök
 == 1)

460 
övÆid©e
 = 1;

462 i‡(
öode
->
i_∆ök
)

463 
	`dr›_∆ök
(
öode
);

465 
upd©e
.
èû
 = 0;

466 
upd©e
.
Æãr_èû
 = 0;

467 
ªtvÆ
 = 
	`nova_≠≥nd_lök_ch™ge_íåy
(
sb
, 
pi
, 
öode
, &
upd©e
,

468 &
ﬁd_lökc
, 
ïoch_id
);

469 i‡(
ªtvÆ
)

470 
out
;

472 
	`nova_lôe_å™ß˘i⁄_f‹_time_™d_lök
(
sb
, 
pi
, 
pidú
, 
öode
, 
dú
,

473 &
upd©e
, &
upd©e_dú
, 
övÆid©e
, 
ïoch_id
);

475 
	`nova_övÆid©e_lök_ch™ge_íåy
(
sb
, 
ﬁd_lökc
);

476 
	`nova_övÆid©e_díåõs
(
sb
, &
upd©e_dú
);

478 
	`NOVA_END_TIMING
(
u∆ök_t
, 
u∆ök_time
);

480 
out
:

481 
	`nova_îr
(
sb
, "%†ªtu∫ %d\n", 
__func__
, 
ªtvÆ
);

482 
	`NOVA_END_TIMING
(
u∆ök_t
, 
u∆ök_time
);

483  
ªtvÆ
;

484 
	}
}

488 
	$nova_mkdú
(
m¡_idm≠
 *
idm≠
,

489 
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

491 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

492 
öode
 *inode;

493 
nova_öode
 *
pidú
, *
pi
;

494 
nova_öode_öfo
 *
si
, *
sidú
;

495 
nova_öode_öfo_hódî
 *
sih
 = 
NULL
;

496 
nova_öode_upd©e
 
upd©e
;

497 
u64
 
pi_addr
 = 0;

498 
u64
 
öo
;

499 
u64
 
ïoch_id
;

500 
îr
 = -
EMLINK
;

501 
	`INIT_TIMING
(
mkdú_time
);

503 
	`NOVA_START_TIMING
(
mkdú_t
, 
mkdú_time
);

504 i‡(
dú
->
i_∆ök
 >
NOVA_LINK_MAX
)

505 
out
;

507 
öo
 = 
	`nova_√w_nova_öode
(
sb
, &
pi_addr
);

508 i‡(
öo
 == 0)

509 
out_îr
;

511 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

512 
	`nova_dbgv
("%s:Çamê%s\n", 
__func__
, 
díåy
->
d_«me
.
«me
);

513 
	`nova_dbgv
("%s: inodê%Œu, dú %lu,Üök %d\n", 
__func__
,

514 
öo
, 
dú
->
i_öo
, dú->
i_∆ök
);

516 
upd©e
.
èû
 = 0;

517 
upd©e
.
Æãr_èû
 = 0;

518 
îr
 = 
	`nova_add_díåy
(
díåy
, 
öo
, 1, &
upd©e
, 
ïoch_id
);

519 i‡(
îr
) {

520 
	`nova_dbg
("failedÅoádd dirÉntry\n");

521 
out_îr
;

524 
öode
 = 
	`nova_√w_vfs_öode
(
TYPE_MKDIR
, 
dú
, 
pi_addr
, 
öo
,

525 
S_IFDIR
 | 
mode
, 
sb
->
s_blocksize
,

526 0, &
díåy
->
d_«me
, 
ïoch_id
);

527 i‡(
	`IS_ERR
(
öode
)) {

528 
îr
 = 
	`PTR_ERR
(
öode
);

529 
out_îr
;

532 
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
);

533 
îr
 = 
	`nova_≠≥nd_dú_öô_íåõs
(
sb
, 
pi
, 
öode
->
i_öo
, 
dú
->i_ino,

534 
ïoch_id
);

535 i‡(
îr
 < 0)

536 
out_îr
;

539 
si
 = 
	`NOVA_I
(
öode
);

540 
sih
 = &
si
->
hódî
;

541 
	`nova_ªbuûd_dú_öode_åì
(
sb
, 
pi
, 
pi_addr
, 
sih
);

543 
pidú
 = 
	`nova_gë_öode
(
sb
, 
dú
);

544 
sidú
 = 
	`NOVA_I
(
dú
);

545 
sih
 = &
si
->
hódî
;

546 
dú
->
i_blocks
 = 
sih
->i_blocks;

547 
	`öc_∆ök
(
dú
);

548 
	`d_ö°™tüã
(
díåy
, 
öode
);

549 
	`u∆ock_√w_öode
(
öode
);

551 
	`nova_lôe_å™ß˘i⁄_f‹_√w_öode
(
sb
, 
pi
, 
pidú
, 
öode
, 
dú
,

552 &
upd©e
);

553 
out
:

554 
	`NOVA_END_TIMING
(
mkdú_t
, 
mkdú_time
);

555  
îr
;

557 
out_îr
:

559 
	`nova_îr
(
sb
, "%†ªtu∫ %d\n", 
__func__
, 
îr
);

560 
out
;

561 
	}
}

566 
	$nova_em±y_dú
(
öode
 *inode)

568 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

569 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

570 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

571 
nova_ønge_node
 *
cuº
;

572 
nova_díåy
 *
íåy
;

573 
nova_díåy
 *
íåyc
, 
íåy_c›y
;

574 
rb_node
 *
ãmp
;

576 
íåyc
 = (
mëad©a_csum
 =0Ë? 
íåy
 : &
íåy_c›y
;

578 
ãmp
 = 
	`rb_fú°
(&
sih
->
rb_åì
);

579 
ãmp
) {

580 
cuº
 = 
	`c⁄èöî_of
(
ãmp
, 
nova_ønge_node
, 
node
);

581 
íåy
 = 
cuº
->
dúíåy
;

583 i‡(
mëad©a_csum
 == 0)

584 
íåyc
 = 
íåy
;

585 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

588 i‡(!
	`is_dú_öô_íåy
(
sb
, 
íåyc
))

591 
ãmp
 = 
	`rb_√xt
(temp);

595 
	}
}

597 
	$nova_rmdú
(
öode
 *
dú
, 
díåy
 *dentry)

599 
öode
 *öodê
díåy
->
d_öode
;

600 
nova_díåy
 *
de
;

601 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

602 
nova_öode
 *
pi
 = 
	`nova_gë_öode
(
sb
, 
öode
), *
pidú
;

603 
nova_öode_upd©e
 
upd©e_dú
;

604 
nova_öode_upd©e
 
upd©e
;

605 
u64
 
ﬁd_lökc
 = 0;

606 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

607 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

608 
îr
 = -
ENOTEMPTY
;

609 
u64
 
ïoch_id
;

610 
	`INIT_TIMING
(
rmdú_time
);

612 
	`NOVA_START_TIMING
(
rmdú_t
, 
rmdú_time
);

613 i‡(!
öode
)

614  -
ENOENT
;

616 
	`nova_dbgv
("%s:Çamê%s\n", 
__func__
, 
díåy
->
d_«me
.
«me
);

617 
pidú
 = 
	`nova_gë_öode
(
sb
, 
dú
);

618 i‡(!
pidú
)

619  -
EINVAL
;

621 i‡(
	`nova_öode_by_«me
(
dú
, &
díåy
->
d_«me
, &
de
) == 0)

622  -
ENOENT
;

624 i‡(!
	`nova_em±y_dú
(
öode
))

625  
îr
;

627 
	`nova_dbgv
("%s: inodê%lu, dú %lu,Üök %d\n", 
__func__
,

628 
öode
->
i_öo
, 
dú
->i_öo, dú->
i_∆ök
);

630 i‡(
öode
->
i_∆ök
 != 2)

631 
	`nova_dbg
("empty directory %lu hasÇlink!=2 (%d), dir %lu",

632 
öode
->
i_öo
, inode->
i_∆ök
, 
dú
->i_ino);

634 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

636 
upd©e_dú
.
èû
 = 0;

637 
upd©e_dú
.
Æãr_èû
 = 0;

638 
îr
 = 
	`nova_ªmove_díåy
(
díåy
, -1, &
upd©e_dú
, 
ïoch_id
);

639 i‡(
îr
)

640 
íd_rmdú
;

643 
	`˛ór_∆ök
(
öode
);

645 
	`öode_£t_˘ime_to_ts
(
öode
, 
	`öode_gë_˘ime
(
dú
));

647 i‡(
dú
->
i_∆ök
)

648 
	`dr›_∆ök
(
dú
);

650 
	`nova_dñëe_dú_åì
(
sb
, 
sih
);

652 
upd©e
.
èû
 = 0;

653 
upd©e
.
Æãr_èû
 = 0;

654 
îr
 = 
	`nova_≠≥nd_lök_ch™ge_íåy
(
sb
, 
pi
, 
öode
, &
upd©e
,

655 &
ﬁd_lökc
, 
ïoch_id
);

656 i‡(
îr
)

657 
íd_rmdú
;

659 
	`nova_lôe_å™ß˘i⁄_f‹_time_™d_lök
(
sb
, 
pi
, 
pidú
, 
öode
, 
dú
,

660 &
upd©e
, &
upd©e_dú
, 1, 
ïoch_id
);

662 
	`nova_övÆid©e_lök_ch™ge_íåy
(
sb
, 
ﬁd_lökc
);

663 
	`nova_övÆid©e_díåõs
(
sb
, &
upd©e_dú
);

665 
	`NOVA_END_TIMING
(
rmdú_t
, 
rmdú_time
);

666  
îr
;

668 
íd_rmdú
:

669 
	`nova_îr
(
sb
, "%†ªtu∫ %d\n", 
__func__
, 
îr
);

670 
	`NOVA_END_TIMING
(
rmdú_t
, 
rmdú_time
);

671  
îr
;

672 
	}
}

678 
	$nova_ª«me
(
m¡_idm≠
 *
idm≠
,

679 
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

680 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

681 
Êags
)

683 
öode
 *
ﬁd_öode
 = 
ﬁd_díåy
->
d_öode
;

684 
öode
 *
√w_öode
 = 
√w_díåy
->
d_öode
;

685 
su≥r_block
 *
sb
 = 
ﬁd_öode
->
i_sb
;

686 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

687 
nova_öode
 *
ﬁd_pi
 = 
NULL
, *
√w_pi
 = NULL;

688 
nova_öode
 *
√w_pidú
 = 
NULL
, *
ﬁd_pidú
 = NULL;

689 
nova_díåy
 *
Áthî_íåy
 = 
NULL
;

690 
nova_díåy
 *
Áthî_íåyc
, 
íåy_c›y
;

691 *
hód_addr
 = 
NULL
;

692 
övÆid©e_√w_öode
 = 0;

693 
nova_öode_upd©e
 
upd©e_dú_√w
;

694 
nova_öode_upd©e
 
upd©e_dú_ﬁd
;

695 
nova_öode_upd©e
 
upd©e_√w
;

696 
nova_öode_upd©e
 
upd©e_ﬁd
;

697 
u64
 
ﬁd_lökc1
 = 0, 
ﬁd_lökc2
 = 0;

698 
îr
 = -
ENOENT
;

699 
öc_lök
 = 0, 
dec_lök
 = 0;

700 
˝u
;

701 
ch™ge_∑ª¡
 = 0;

702 
u64
 
jou∫Æ_èû
;

703 
u64
 
ïoch_id
;

704 
úq_Êags
 = 0;

705 
	`INIT_TIMING
(
ª«me_time
);

707 
	`nova_dbgv
("%s:Ñíamê%†tÿ%s,\n", 
__func__
,

708 
ﬁd_díåy
->
d_«me
.
«me
, 
√w_díåy
->d_name.name);

709 
	`nova_dbgv
("%s: %s inode %lu, old dir %lu,Çew dir %lu,Çew inode %lu\n",

710 
__func__
, 
	`S_ISDIR
(
ﬁd_öode
->
i_mode
) ? "dir" : "normal",

711 
ﬁd_öode
->
i_öo
, 
ﬁd_dú
->i_öo, 
√w_dú
->i_ino,

712 
√w_öode
 ?Çew_öode->
i_öo
 : 0);

714 i‡(
Êags
 & ~
RENAME_NOREPLACE
)

715  -
EINVAL
;

717 
	`NOVA_START_TIMING
(
ª«me_t
, 
ª«me_time
);

719 i‡(
√w_öode
) {

720 
îr
 = -
ENOTEMPTY
;

721 i‡(
	`S_ISDIR
(
ﬁd_öode
->
i_mode
Ë&& !
	`nova_em±y_dú
(
√w_öode
))

722 
out
;

724 i‡(
	`S_ISDIR
(
ﬁd_öode
->
i_mode
)) {

725 
îr
 = -
EMLINK
;

726 i‡(
√w_dú
->
i_∆ök
 >
NOVA_LINK_MAX
)

727 
out
;

731 i‡(
	`S_ISDIR
(
ﬁd_öode
->
i_mode
)) {

732 
dec_lök
 = -1;

733 i‡(!
√w_öode
)

734 
öc_lök
 = 1;

741 i‡(
ﬁd_dú
 =
√w_dú
) {

742 
öc_lök
--;

743 i‡(
öc_lök
 == 0)

744 
dec_lök
 = 0;

748 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

749 
√w_pidú
 = 
	`nova_gë_öode
(
sb
, 
√w_dú
);

750 
ﬁd_pidú
 = 
	`nova_gë_öode
(
sb
, 
ﬁd_dú
);

752 
ﬁd_pi
 = 
	`nova_gë_öode
(
sb
, 
ﬁd_öode
);

754 
	`öode_£t_˘ime_cuºít
(
ﬁd_öode
);

756 
upd©e_ﬁd
.
èû
 = 0;

757 
upd©e_ﬁd
.
Æãr_èû
 = 0;

758 
îr
 = 
	`nova_≠≥nd_lök_ch™ge_íåy
(
sb
, 
ﬁd_pi
, 
ﬁd_öode
,

759 &
upd©e_ﬁd
, &
ﬁd_lökc1
, 
ïoch_id
);

760 i‡(
îr
)

761 
out
;

763 i‡(
	`S_ISDIR
(
ﬁd_öode
->
i_mode
Ë&& 
ﬁd_dú
 !
√w_dú
) {

766 
ch™ge_∑ª¡
 = 1;

767 
hód_addr
 = (*)
	`nova_gë_block
(
sb
, 
ﬁd_pi
->
log_hód
);

768 
Áthî_íåy
 = (
nova_díåy
 *)(
hód_addr
 +

769 
	`NOVA_DIR_LOG_REC_LEN
(1));

771 i‡(
mëad©a_csum
 == 0)

772 
Áthî_íåyc
 = 
Áthî_íåy
;

774 
Áthî_íåyc
 = &
íåy_c›y
;

775 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
Áthî_íåy
,

776 
Áthî_íåyc
)) {

777 
îr
 = -
EIO
;

778 
out
;

782 i‡(
	`À64_to_˝u
(
Áthî_íåyc
->
öo
Ë!
ﬁd_dú
->
i_öo
)

783 
	`nova_îr
(
sb
, "%s: dir %luÖarent should be %lu, butáctually %lu\n",

784 
__func__
,

785 
ﬁd_öode
->
i_öo
, 
ﬁd_dú
->i_ino,

786 
	`À64_to_˝u
(
Áthî_íåy
->
öo
));

789 
upd©e_dú_√w
.
èû
 = 0;

790 
upd©e_dú_√w
.
Æãr_èû
 = 0;

791 i‡(
√w_öode
) {

793 
îr
 = 
	`nova_ªmove_díåy
(
√w_díåy
, 0, &
upd©e_dú_√w
,

794 
ïoch_id
);

795 i‡(
îr
)

796 
out
;

800 
îr
 = 
	`nova_add_díåy
(
√w_díåy
, 
ﬁd_öode
->
i_öo
,

801 
öc_lök
, &
upd©e_dú_√w
, 
ïoch_id
);

802 i‡(
îr
)

803 
out
;

805 i‡(
öc_lök
 > 0)

806 
	`öc_∆ök
(
√w_dú
);

808 
upd©e_dú_ﬁd
.
èû
 = 0;

809 
upd©e_dú_ﬁd
.
Æãr_èû
 = 0;

810 i‡(
ﬁd_dú
 =
√w_dú
) {

811 
upd©e_dú_ﬁd
.
èû
 = 
upd©e_dú_√w
.tail;

812 
upd©e_dú_ﬁd
.
Æãr_èû
 = 
upd©e_dú_√w
.alter_tail;

815 
îr
 = 
	`nova_ªmove_díåy
(
ﬁd_díåy
, 
dec_lök
, &
upd©e_dú_ﬁd
,

816 
ïoch_id
);

817 i‡(
îr
)

818 
out
;

820 i‡(
dec_lök
 < 0)

821 
	`dr›_∆ök
(
ﬁd_dú
);

823 i‡(
√w_öode
) {

824 
√w_pi
 = 
	`nova_gë_öode
(
sb
, 
√w_öode
);

826 
	`öode_£t_˘ime_cuºít
(
√w_öode
);

828 i‡(
	`S_ISDIR
(
ﬁd_öode
->
i_mode
)) {

829 i‡(
√w_öode
->
i_∆ök
)

830 
	`dr›_∆ök
(
√w_öode
);

832 i‡(
√w_öode
->
i_∆ök
)

833 
	`dr›_∆ök
(
√w_öode
);

835 
upd©e_√w
.
èû
 = 0;

836 
upd©e_√w
.
Æãr_èû
 = 0;

837 
îr
 = 
	`nova_≠≥nd_lök_ch™ge_íåy
(
sb
, 
√w_pi
, 
√w_öode
,

838 &
upd©e_√w
, &
ﬁd_lökc2
,

839 
ïoch_id
);

840 i‡(
îr
)

841 
out
;

844 
˝u
 = 
	`nova_gë_˝uid
(
sb
);

845 
	`•ö_lock
(&
sbi
->
jou∫Æ_locks
[
˝u
]);

846 
	`nova_memu∆ock_jou∫Æ
(
sb
, &
úq_Êags
);

847 i‡(
√w_öode
 &&Çew_öode->
i_∆ök
 == 0)

848 
övÆid©e_√w_öode
 = 1;

849 
jou∫Æ_èû
 = 
	`nova_¸óã_ª«me_å™ß˘i⁄
(
sb
, 
ﬁd_öode
, 
ﬁd_dú
,

850 
√w_öode
,

851 
ﬁd_dú
 !
√w_dú
 ?Çew_dú : 
NULL
,

852 
Áthî_íåy
,

853 
övÆid©e_√w_öode
,

854 
˝u
);

856 
	`nova_upd©e_öode
(
sb
, 
ﬁd_öode
, 
ﬁd_pi
, &
upd©e_ﬁd
, 0);

857 
	`nova_upd©e_öode
(
sb
, 
ﬁd_dú
, 
ﬁd_pidú
, &
upd©e_dú_ﬁd
, 0);

859 i‡(
ﬁd_pidú
 !
√w_pidú
)

860 
	`nova_upd©e_öode
(
sb
, 
√w_dú
, 
√w_pidú
, &
upd©e_dú_√w
, 0);

862 i‡(
ch™ge_∑ª¡
 && 
Áthî_íåy
) {

863 
Áthî_íåy
->
öo
 = 
	`˝u_to_À64
(
√w_dú
->
i_öo
);

864 
	`nova_upd©e_íåy_csum
(
Áthî_íåy
);

865 
	`nova_upd©e_Æãr_íåy
(
sb
, 
Áthî_íåy
);

868 i‡(
√w_öode
) {

869 i‡(
övÆid©e_√w_öode
) {

870 
√w_pi
->
vÆid
 = 0;

871 
√w_pi
->
dñëe_ïoch_id
 = 
ïoch_id
;

873 
	`nova_upd©e_öode
(
sb
, 
√w_öode
, 
√w_pi
, &
upd©e_√w
, 0);

876 
	`PERSISTENT_BARRIER
();

878 
	`nova_commô_lôe_å™ß˘i⁄
(
sb
, 
jou∫Æ_èû
, 
˝u
);

879 
	`nova_memlock_jou∫Æ
(
sb
, &
úq_Êags
);

880 
	`•ö_u∆ock
(&
sbi
->
jou∫Æ_locks
[
˝u
]);

882 
	`nova_memu∆ock_öode
(
sb
, 
ﬁd_pi
, &
úq_Êags
);

883 
	`nova_upd©e_Æãr_öode
(
sb
, 
ﬁd_öode
, 
ﬁd_pi
);

884 
	`nova_upd©e_Æãr_öode
(
sb
, 
ﬁd_dú
, 
ﬁd_pidú
);

885 i‡(
ﬁd_dú
 !
√w_dú
)

886 
	`nova_upd©e_Æãr_öode
(
sb
, 
√w_dú
, 
√w_pidú
);

887 i‡(
√w_öode
)

888 
	`nova_upd©e_Æãr_öode
(
sb
, 
√w_öode
, 
√w_pi
);

889 
	`nova_memlock_öode
(
sb
, 
ﬁd_pi
, &
úq_Êags
);

891 
	`nova_övÆid©e_lök_ch™ge_íåy
(
sb
, 
ﬁd_lökc1
);

892 
	`nova_övÆid©e_lök_ch™ge_íåy
(
sb
, 
ﬁd_lökc2
);

893 i‡(
√w_öode
)

894 
	`nova_övÆid©e_díåõs
(
sb
, &
upd©e_dú_√w
);

895 
	`nova_övÆid©e_díåõs
(
sb
, &
upd©e_dú_ﬁd
);

897 
	`NOVA_END_TIMING
(
ª«me_t
, 
ª«me_time
);

899 
out
:

900 
	`nova_îr
(
sb
, "%†ªtu∫ %d\n", 
__func__
, 
îr
);

901 
	`NOVA_END_TIMING
(
ª«me_t
, 
ª«me_time
);

902  
îr
;

903 
	}
}

905 
díåy
 *
	$nova_gë_∑ª¡
(
díåy
 *
chûd
)

907 
öode
 *inode;

908 
q°r
 
dŸdŸ
 = 
	`QSTR_INIT
("..", 2);

909 
nova_díåy
 *
de
 = 
NULL
;

910 
öo_t
 
öo
;

912 
	`nova_öode_by_«me
(
chûd
->
d_öode
, &
dŸdŸ
, &
de
);

913 i‡(!
de
)

914  
	`ERR_PTR
(-
ENOENT
);

919 
öo
 = 
	`À64_to_˝u
(
de
->ino);

921 i‡(
öo
)

922 
öode
 = 
	`nova_igë
(
chûd
->
d_öode
->
i_sb
, 
öo
);

924  
	`ERR_PTR
(-
ENOENT
);

926  
	`d_obèö_Æüs
(
öode
);

927 
	}
}

929 c⁄° 
öode_›î©i⁄s
 
	gnova_dú_öode_›î©i⁄s
 = {

930 .
¸óã
 = 
nova_¸óã
,

931 .
	glookup
 = 
nova_lookup
,

932 .
	glök
 = 
nova_lök
,

933 .
	gu∆ök
 = 
nova_u∆ök
,

934 .
	gsymlök
 = 
nova_symlök
,

935 .
	gmkdú
 = 
nova_mkdú
,

936 .
	grmdú
 = 
nova_rmdú
,

937 .
	gmknod
 = 
nova_mknod
,

938 .
	gª«me
 = 
nova_ª«me
,

939 .
	g£èâr
 = 
nova_nŸify_ch™ge
,

940 .
	ggë_a˛
 = 
NULL
,

943 c⁄° 
öode_›î©i⁄s
 
	gnova_•ecül_öode_›î©i⁄s
 = {

944 .
£èâr
 = 
nova_nŸify_ch™ge
,

945 .
	ggë_a˛
 = 
NULL
,

	@nova.h

17 #i‚de‡
__NOVA_H


18 
	#__NOVA_H


	)

20 
	~<löux/fs.h
>

21 
	~<löux/dax.h
>

22 
	~<löux/öô.h
>

23 
	~<löux/time.h
>

24 
	~<löux/πc.h
>

25 
	~<löux/mm.h
>

26 
	~<löux/dñay.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/vmÆloc.h
>

29 
	~<löux/sched.h
>

30 
	~<löux/muãx.h
>

31 
	~<löux/∑gem≠.h
>

32 
	~<löux/backög-dev.h
>

33 
	~<löux/¥oc_fs.h
>

34 
	~<löux/£q_fûe.h
>

35 
	~<löux/rcupd©e.h
>

36 
	~<löux/ty≥s.h
>

37 
	~<löux/rbåì.h
>

38 
	~<löux/ødix-åì.h
>

39 
	~<löux/vîsi⁄.h
>

40 
	~<löux/kthªad.h
>

41 
	~<löux/buf„r_hód.h
>

42 
	~<löux/uio.h
>

43 
	~<löux/iom≠.h
>

44 
	~<löux/¸c32c.h
>

45 
	~<asm/ébÊush.h
>

46 
	~<löux/vîsi⁄.h
>

47 
	~<löux/p‚_t.h
>

48 
	~<löux/∑gevec.h
>

50 
	~"nova_def.h
"

51 
	~"°©s.h
"

52 
	~"¢≠shŸ.h
"

54 
	#PAGE_SHIFT_2M
 21

	)

55 
	#PAGE_SHIFT_1G
 30

	)

61 #ifde‡
¥_fmt


62 #unde‡
¥_fmt


63 
	#¥_fmt
(
fmt
Ë
KBUILD_MODNAME
 ": " 
	)
fmt

67 
	#nova_dbg
(
s
, 
¨gs
 ...Ë
	`¥_öfo
(s, ##árgs)

	)

68 
	#nova_dbg1
(
s
, 
¨gs
 ...)

	)

69 
	#nova_îr
(
sb
, 
s
, 
¨gs
 ...Ë
	`nova_îr‹_mng
(sb, s, ##árgs)

	)

70 
	#nova_w¨n
(
s
, 
¨gs
 ...Ë
	`¥_w¨n
(s, ##árgs)

	)

71 
	#nova_öfo
(
s
, 
¨gs
 ...Ë
	`¥_öfo
(s, ##árgs)

	)

73 
nova_dbgmask
;

74 
	#NOVA_DBGMASK_MMAPHUGE
 (0x00000001)

	)

75 
	#NOVA_DBGMASK_MMAP4K
 (0x00000002)

	)

76 
	#NOVA_DBGMASK_MMAPVERBOSE
 (0x00000004)

	)

77 
	#NOVA_DBGMASK_MMAPVVERBOSE
 (0x00000008)

	)

78 
	#NOVA_DBGMASK_VERBOSE
 (0x00000010)

	)

79 
	#NOVA_DBGMASK_TRANSACTION
 (0x00000020)

	)

81 
	#nova_dbg_mm≠4k
(
s
, 
¨gs
 ...) \

82 ((
nova_dbgmask
 & 
NOVA_DBGMASK_MMAP4K
Ë? 
	`nova_dbg
(
s
, 
¨gs
Ë: 0)

	)

83 
	#nova_dbg_mm≠v
(
s
, 
¨gs
 ...) \

84 ((
nova_dbgmask
 & 
NOVA_DBGMASK_MMAPVERBOSE
Ë? 
	`nova_dbg
(
s
, 
¨gs
Ë: 0)

	)

85 
	#nova_dbg_mm≠vv
(
s
, 
¨gs
 ...) \

86 ((
nova_dbgmask
 & 
NOVA_DBGMASK_MMAPVVERBOSE
Ë? 
	`nova_dbg
(
s
, 
¨gs
Ë: 0)

	)

88 
	#nova_dbg_vîbo£
(
s
, 
¨gs
 ...) \

89 ((
nova_dbgmask
 & 
NOVA_DBGMASK_VERBOSE
Ë? 
	`nova_dbg
(
s
, ##
¨gs
Ë: 0)

	)

90 
	#nova_dbgv
(
s
, 
¨gs
 ...Ë
	`nova_dbg_vîbo£
(s, ##¨gs)

	)

91 
	#nova_dbg_å™s
(
s
, 
¨gs
 ...) \

92 ((
nova_dbgmask
 & 
NOVA_DBGMASK_TRANSACTION
Ë? 
	`nova_dbg
(
s
, ##
¨gs
Ë: 0)

	)

94 
	#NOVA_ASSERT
(
x
) do {\

95 i‡(!(
x
))\

96 
	`nova_w¨n
("assertion failed %s:%d: %s\n", \

97 
__FILE__
, 
__LINE__
, #x);\

98 } 0)

	)

100 
	#nova_£t_bô
 
__ã°_™d_£t_bô_À


	)

101 
	#nova_˛ór_bô
 
__ã°_™d_˛ór_bô_À


	)

102 
	#nova_föd_√xt_zîo_bô
 
föd_√xt_zîo_bô_À


	)

104 
	#˛ór_›t
(
o
, 
›t
Ë(ÿ&~
NOVA_MOUNT_
 ## o±)

	)

105 
	#£t_›t
(
o
, 
›t
Ë(ÿ|
NOVA_MOUNT_
 ## o±)

	)

106 
	#ã°_›t
(
sb
, 
›t
Ë(
	`NOVA_SB
(sb)->
s_mou¡_›t
 & 
NOVA_MOUNT_
 ## o±)

	)

108 
	#NOVA_LARGE_INODE_TABLE_SIZE
 (0x200000)

	)

110 
	#NOVA_LARGE_INODE_TABLE_THREASHOLD
 (0x20000000)

	)

116 
	#NOVA_EOFBLOCKS_FL
 0x20000000

	)

118 
	#NOVA_FL_INHERITED
 (
FS_SECRM_FL
 | 
FS_UNRM_FL
 | 
FS_COMPR_FL
 | \

119 
FS_SYNC_FL
 | 
FS_NODUMP_FL
 | 
FS_NOATIME_FL
 | \

120 
FS_COMPRBLK_FL
 | 
FS_NOCOMP_FL
 | \

121 
FS_JOURNAL_DATA_FL
 | 
FS_NOTAIL_FL
 | 
FS_DIRSYNC_FL
)

	)

123 
	#NOVA_REG_FLMASK
 (~(
FS_DIRSYNC_FL
 | 
FS_TOPDIR_FL
))

	)

125 
	#NOVA_OTHER_FLMASK
 (
FS_NODUMP_FL
 | 
FS_NOATIME_FL
)

	)

126 
	#NOVA_FL_USER_VISIBLE
 (
FS_FL_USER_VISIBLE
 | 
NOVA_EOFBLOCKS_FL
)

	)

129 
	#NOVA_PRINT_TIMING
 0xBCD00010

	)

130 
	#NOVA_CLEAR_STATS
 0xBCD00011

	)

131 
	#NOVA_PRINT_LOG
 0xBCD00013

	)

132 
	#NOVA_PRINT_LOG_BLOCKNODE
 0xBCD00014

	)

133 
	#NOVA_PRINT_LOG_PAGES
 0xBCD00015

	)

134 
	#NOVA_PRINT_FREE_LISTS
 0xBCD00018

	)

137 
	#READDIR_END
 (
ULONG_MAX
)

	)

138 
	#INVALID_CPU
 (-1)

	)

139 
	#ANY_CPU
 (65536)

	)

140 
	#FREE_BATCH
 (16)

	)

141 
	#DEAD_ZONE_BLOCKS
 (256)

	)

143 
mósuª_timög
;

144 
mëad©a_csum
;

145 
unß„_mëad©a
;

146 
w¥Ÿe˘
;

147 
d©a_csum
;

148 
d©a_∑rôy
;

149 
døm_°ru˘_csum
;

151 
blk_ty≥_to_shi·
[
NOVA_BLOCK_TYPE_MAX
];

152 
blk_ty≥_to_size
[
NOVA_BLOCK_TYPE_MAX
];

156 
	#MMAP_WRITE_BIT
 0x20UL

157 
	#IS_MAP_WRITE
(
p
Ë(’Ë& (
MMAP_WRITE_BIT
))

	)

158 
	#MMAP_ADDR
(
p
Ë(’Ë& (
PAGE_MASK
))

	)

162 
ölöe
 
__À32
 
	$nova_mask_Êags
(
umode_t
 
mode
, 
__À32
 
Êags
)

164 
Êags
 &
	`˝u_to_À32
(
NOVA_FL_INHERITED
);

165 i‡(
	`S_ISDIR
(
mode
))

166  
Êags
;

167 i‡(
	`S_ISREG
(
mode
))

168  
Êags
 & 
	`˝u_to_À32
(
NOVA_REG_FLMASK
);

170  
Êags
 & 
	`˝u_to_À32
(
NOVA_OTHER_FLMASK
);

171 
	}
}

174 
	#nova_¸c32c_qw‹d
(
qw‹d
, 
¸c
) do { \

175 
asm
 volatile ("crc32q %1, %0" \

176 : "Ù" (
¸c
) \

177 : "r" (
qw‹d
), "0" (
¸c
)); \

178 } 0)

	)

180 
ölöe
 
u32
 
	$nova_¸c32c
(
u32
 
¸c
, c⁄° 
u8
 *
d©a
, 
size_t
 
Àn
)

182 
u8
 *
±r
 = (u8 *Ë
d©a
;

183 
u64
 
acc
 = 
¸c
;

184 
u32
 
csum
;

187 i‡(
	`°©ic_˝u_has
(
X86_FEATURE_XMM4_2
)) {

192 
Àn
 > 8) {

193 
asm
 volatile(

195 : "Ù" (
acc
)

196 : "r" (
±r
), "0" (
acc
)

198 
±r
 += 8;

199 
Àn
 -= 8;

202 
Àn
 > 0) {

203 
asm
 volatile(

205 : "Ù" (
acc
)

206 : "r" (
±r
), "0" (
acc
)

208 
±r
++;

209 
Àn
--;

212 
csum
 = (
u32
Ë
acc
;

219 
csum
 = 
	`¸c32c
(
¸c
, 
d©a
, 
Àn
);

222  
csum
;

223 
	}
}

226 
ölöe
 
	$nova_mem˝y_©omic
(*
d°
, c⁄° *
§c
, 
u8
 
size
)

228 
size
) {

230 vﬁ©ûê
u8
 *
daddr
 = 
d°
;

231 c⁄° 
u8
 *
ßddr
 = 
§c
;

232 *
daddr
 = *
ßddr
;

236 vﬁ©ûê
__À16
 *
daddr
 = 
d°
;

237 c⁄° 
u16
 *
ßddr
 = 
§c
;

238 *
daddr
 = 
	`˝u_to_À16
(*
ßddr
);

242 vﬁ©ûê
__À32
 *
daddr
 = 
d°
;

243 c⁄° 
u32
 *
ßddr
 = 
§c
;

244 *
daddr
 = 
	`˝u_to_À32
(*
ßddr
);

248 vﬁ©ûê
__À64
 *
daddr
 = 
d°
;

249 c⁄° 
u64
 *
ßddr
 = 
§c
;

250 *
daddr
 = 
	`˝u_to_À64
(*
ßddr
);

254 
	`nova_dbg
("îr‹: mem˝y_©omi¯ˇŒed wôh %d byãs\n", 
size
);

257 
	}
}

259 
ölöe
 
	$mem˝y_to_pmem_noˇche
(*
d°
, c⁄° *
§c
,

260 
size
)

262 
ªt
;

264 
ªt
 = 
	`__c›y_‰om_u£r_ö©omic_noˇche
(
d°
, 
§c
, 
size
);

266  
ªt
;

267 
	}
}

271 
ölöe
 
	$mem£t_¡
(*
de°
, 
uöt32_t
 
dw‹d
, 
size_t
 
Àngth
)

273 
uöt64_t
 
dummy1
, 
dummy2
;

274 
uöt64_t
 
qw‹d
 = ((uöt64_t)
dw‹d
 << 32) | dword;

276 
asm
 volatile ("movl %%edx,%%ecx\n"

304 : "=D"(
dummy1
), "=d" (
dummy2
)

305 : "D" (
de°
), "a" (
qw‹d
), "d" (
Àngth
)

307 
	}
}

310 
	~"su≥r.h
"

317 
ölöe
 *
	$nova_gë_block
(
su≥r_block
 *
sb
, 
u64
 
block
)

319 
nova_su≥r_block
 *
ps
 = 
	`nova_gë_su≥r
(
sb
);

321  
block
 ? ((*)
ps
 + blockË: 
NULL
;

322 
	}
}

324 
ölöe
 
	$nova_gë_ª„ªn˚
(
su≥r_block
 *
sb
, 
u64
 
block
,

325 *
døm
, **
nvmm
, 
size_t
 
size
)

328 *
nvmm
 = 
	`nova_gë_block
(
sb
, 
block
);

329 i‡(
	`mem˝y
(
døm
, *
nvmm
, 
size
Ë=
NULL
)

332 
	}
}

335 
ölöe
 
u64


336 
	$nova_gë_addr_off
(
nova_sb_öfo
 *
sbi
, *
addr
)

338 
	`NOVA_ASSERT
((
addr
 >
sbi
->
vút_addr
) &&

339 (
addr
 < (
sbi
->
vút_addr
 + sbi->
öôsize
)));

340  (
u64
)(
addr
 - 
sbi
->
vút_addr
);

341 
	}
}

343 
ölöe
 
u64


344 
	$nova_gë_block_off
(
su≥r_block
 *
sb
, 
blockƒ
,

345 
bty≥
)

347  (
u64
)
blockƒ
 << 
PAGE_SHIFT
;

348 
	}
}

350 
ölöe
 
	$nova_gë_˝uid
(
su≥r_block
 *
sb
)

352 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

354  
	`smp_¥o˚ss‹_id
(Ë% 
sbi
->
˝us
;

355 
	}
}

357 
ölöe
 
u64
 
	$nova_gë_ïoch_id
(
su≥r_block
 *
sb
)

359 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

361  
sbi
->
s_ïoch_id
;

362 
	}
}

364 
ölöe
 
	$nova_¥öt_cuº_ïoch_id
(
su≥r_block
 *
sb
)

366 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

367 
u64
 
ªt
;

369 
ªt
 = 
sbi
->
s_ïoch_id
;

370 
	`nova_dbg
("Cuºíàïoch id: %Œu\n", 
ªt
);

371 
	}
}

373 
	~"öode.h
"

374 
ölöe
 
	$nova_gë_hód_èû
(
su≥r_block
 *
sb
,

375 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
)

377 
nova_öode
 
Áke_pi
;

379 i‡(
	`mem˝y
(&
Áke_pi
, 
pi
, (
nova_öode
)Ë=
NULL
)

382 
sih
->
i_blk_ty≥
 = 
Áke_pi
.i_blk_type;

383 
sih
->
log_hód
 = 
Áke_pi
.log_head;

384 
sih
->
log_èû
 = 
Áke_pi
.log_tail;

385 
sih
->
Æãr_log_hód
 = 
Áke_pi
.alter_log_head;

386 
sih
->
Æãr_log_èû
 = 
Áke_pi
.alter_log_tail;

389 
	}
}

391 
	snova_ønge_node_lowhigh
 {

392 
__À64
 
	mønge_low
;

393 
__À64
 
	mønge_high
;

396 
	#RANGENODE_PER_PAGE
 254

	)

399 
	snova_ønge_node
 {

400 
rb_node
 
	mnode
;

401 
vm_¨ó_°ru˘
 *
	mvma
;

402 
	mmm≠_íåy
;

406 
	mønge_low
;

407 
	mønge_high
;

411 
	mhash
;

412 *
	mdúíåy
;

415 
u32
 
	mcsum
;

418 
	svma_ôem
 {

420 
rb_node
 
	mnode
;

421 
vm_¨ó_°ru˘
 *
	mvma
;

422 
	mmm≠_íåy
;

425 
ölöe
 
u32
 
	$nova_ˇlcuœã_ønge_node_csum
(
nova_ønge_node
 *
node
)

427 
u32
 
¸c
;

429 
¸c
 = 
	`nova_¸c32c
(~0, (
__u8
 *)&
node
->
vma
,

430 ()&
node
->
csum
 - ()&node->
vma
);

432  
¸c
;

433 
	}
}

435 
ölöe
 
	$nova_upd©e_ønge_node_checksum
(
nova_ønge_node
 *
node
)

437 i‡(
døm_°ru˘_csum
)

438 
node
->
csum
 = 
	`nova_ˇlcuœã_ønge_node_csum
(node);

441 
	}
}

443 
ölöe
 
boﬁ
 
	$nova_ønge_node_checksum_ok
(
nova_ønge_node
 *
node
)

445 
boﬁ
 
ªt
;

447 i‡(
døm_°ru˘_csum
 == 0)

448  
åue
;

450 
ªt
 = 
node
->
csum
 =
	`nova_ˇlcuœã_ønge_node_csum
(node);

451 i‡(!
ªt
) {

452 
	`nova_dbg
("%s: checksum failure, vma %p,ÑangeÜow %lu,Ñange high %lu, csum 0x%x\n",

453 
__func__
, 
node
->
vma
,Çode->
ønge_low
,Çode->
ønge_high
,

454 
node
->
csum
);

457  
ªt
;

458 
	}
}

461 
	ebm_ty≥
 {

462 
	mBM_4K
 = 0,

463 
	mBM_2M
,

464 
	mBM_1G
,

467 
	ssögÀ_sˇn_bm
 {

468 
	mbôm≠_size
;

469 *
	mbôm≠
;

472 
	ssˇn_bôm≠
 {

473 
sögÀ_sˇn_bm
 
	msˇn_bm_4K
;

474 
sögÀ_sˇn_bm
 
	msˇn_bm_2M
;

475 
sögÀ_sˇn_bm
 
	msˇn_bm_1G
;

480 
	söode_m≠
 {

481 
muãx
 
	möode_èbÀ_muãx
;

482 
rb_roŸ
 
	möode_öu£_åì
;

483 
	mnum_ønge_node_öode
;

484 
nova_ønge_node
 *
	mfú°_öode_ønge
;

485 
	mÆloˇãd
;

486 
	m‰ìd
;

496 
ölöe
 
	$ﬁd_íåy_‰ìabÀ
(
su≥r_block
 *
sb
, 
u64
 
ïoch_id
)

498 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

500 i‡(
ïoch_id
 =
sbi
->
s_ïoch_id
)

504 
	}
}

506 
ölöe
 
	$∑ss_mou¡_¢≠shŸ
(
su≥r_block
 *
sb
, 
u64
 
ïoch_id
)

508 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

510 i‡(
ïoch_id
 > 
sbi
->
mou¡_¢≠shŸ_ïoch_id
)

514 
	}
}

518 
ölöe
 
	$BKDRHash
(c⁄° *
°r
, 
Àngth
)

520 
£ed
 = 131;

521 
hash
 = 0;

522 
i
;

524 
i
 = 0; i < 
Àngth
; i++)

525 
hash
 = hash * 
£ed
 + (*
°r
++);

527  
hash
;

528 
	}
}

531 
	~"m¥Ÿe˘.h
"

533 
	~"log.h
"

535 
ölöe
 
nova_fûe_wrôe_íåy
 *

536 
	$nova_gë_wrôe_íåy
(
su≥r_block
 *
sb
,

537 
nova_öode_öfo_hódî
 *
sih
, 
blockƒ
)

539 
nova_fûe_wrôe_íåy
 *
íåy
;

541 
íåy
 = 
	`ødix_åì_lookup
(&
sih
->
åì
, 
blockƒ
);

543  
íåy
;

544 
	}
}

551 
ölöe
 
	$gë_nvmm
(
su≥r_block
 *
sb
,

552 
nova_öode_öfo_hódî
 *
sih
,

553 
nova_fûe_wrôe_íåy
 *
íåy
, 
pgoff
)

559 i‡(
íåy
->
pgoff
 >Ögoff || ()Éntry->pgoff +

560 (Ë
íåy
->
num_∑ges
 <
pgoff
) {

561 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

562 
u64
 
cuº
;

564 
cuº
 = 
	`nova_gë_addr_off
(
sbi
, 
íåy
);

565 
	`nova_dbg
("Entry ERROR: inode %lu, curr 0x%llx,Ögoff %lu,ÉntryÖgoff %llu,Çum %u\n",

566 
sih
->
öo
,

567 
cuº
, 
pgoff
, 
íåy
->pgoff,É¡ry->
num_∑ges
);

568 
	`nova_¥öt_nova_log_∑ges
(
sb
, 
sih
);

569 
	`nova_¥öt_nova_log
(
sb
, 
sih
);

570 
	`NOVA_ASSERT
(0);

573  (Ë(
íåy
->
block
 >> 
PAGE_SHIFT
Ë+ 
pgoff


574 - 
íåy
->
pgoff
;

575 
	}
}

577 
boﬁ
 
nova_vîify_íåy_csum
(
su≥r_block
 *
sb
, *
íåy
, *
íåyc
);

579 
ölöe
 
u64
 
	$nova_föd_nvmm_block
(
su≥r_block
 *
sb
,

580 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

581 
blockƒ
)

583 
nvmm
;

584 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

586 i‡(!
íåy
) {

587 
íåy
 = 
	`nova_gë_wrôe_íåy
(
sb
, 
sih
, 
blockƒ
);

588 i‡(!
íåy
)

595 
íåyc
 = &
íåy_c›y
;

596 i‡(
	`mem˝y
(
íåyc
, 
íåy
,

597 (
nova_fûe_wrôe_íåy
)Ë!
NULL
)

600 
nvmm
 = 
	`gë_nvmm
(
sb
, 
sih
, 
íåyc
, 
blockƒ
);

601  
nvmm
 << 
PAGE_SHIFT
;

602 
	}
}

606 
ölöe
 

607 
	$nova_gë_numblocks
(
bty≥
)

609 
num_blocks
;

611 i‡(
bty≥
 =
NOVA_BLOCK_TYPE_4K
) {

612 
num_blocks
 = 1;

613 } i‡(
bty≥
 =
NOVA_BLOCK_TYPE_2M
) {

614 
num_blocks
 = 512;

617 
num_blocks
 = 0x40000;

619  
num_blocks
;

620 
	}
}

622 
ölöe
 

623 
	$nova_gë_blockƒ
(
su≥r_block
 *
sb
, 
u64
 
block
, 
bty≥
)

625  
block
 >> 
PAGE_SHIFT
;

626 
	}
}

628 
ölöe
 
	$nova_gë_p‚
(
su≥r_block
 *
sb
, 
u64
 
block
)

630  (
	`NOVA_SB
(
sb
)->
phys_addr
 + 
block
Ë>> 
PAGE_SHIFT
;

631 
	}
}

633 
ölöe
 
u64
 
	$√xt_log_∑ge
(
su≥r_block
 *
sb
, 
u64
 
cuº
)

635 
nova_öode_log_∑ge
 *
cuº_∑ge
;

636 
u64
 
√xt
 = 0;

638 
cuº
 = 
	`BLOCK_OFF
(curr);

639 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
	`nova_gë_block
(
sb
, 
cuº
);

640 i‡(
	`mem˝y
(&
√xt
, &
cuº_∑ge
->
∑ge_èû
.
√xt_∑ge
,

641 (
u64
)Ë=
NULL
)

644  
√xt
;

645 
	}
}

647 
ölöe
 
u64
 
	$Æãr_log_∑ge
(
su≥r_block
 *
sb
, 
u64
 
cuº
)

649 
nova_öode_log_∑ge
 *
cuº_∑ge
;

650 
u64
 
√xt
 = 0;

652 i‡(
mëad©a_csum
 == 0)

655 
cuº
 = 
	`BLOCK_OFF
(curr);

656 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
	`nova_gë_block
(
sb
, 
cuº
);

657 i‡(
	`mem˝y
(&
√xt
, &
cuº_∑ge
->
∑ge_èû
.
Æãr_∑ge
, (
u64
)Ë=
NULL
)

660  
√xt
;

661 
	}
}

664 
ölöe
 
u64
 
	$√xt_log_∑ge
(
su≥r_block
 *
sb
, 
u64
 
cuº_p
)

666 *
cuº_addr
 = 
	`nova_gë_block
(
sb
, 
cuº_p
);

667 
∑ge_èû
 = 
	`BLOCK_OFF
(()
cuº_addr
)

668 + 
LOG_BLOCK_TAIL
;

669  ((
nova_öode_∑ge_èû
 *)
∑ge_èû
)->
√xt_∑ge
;

670 
	}
}

672 
ölöe
 
u64
 
	$Æãr_log_∑ge
(
su≥r_block
 *
sb
, 
u64
 
cuº_p
)

674 *
cuº_addr
 = 
	`nova_gë_block
(
sb
, 
cuº_p
);

675 
∑ge_èû
 = 
	`BLOCK_OFF
(()
cuº_addr
)

676 + 
LOG_BLOCK_TAIL
;

677 i‡(
mëad©a_csum
 == 0)

680  ((
nova_öode_∑ge_èû
 *)
∑ge_èû
)->
Æãr_∑ge
;

681 
	}
}

684 
ölöe
 
u64
 
	$Æãr_log_íåy
(
su≥r_block
 *
sb
, 
u64
 
cuº_p
)

686 
u64
 
Æãr_∑ge
;

687 *
cuº_addr
 = 
	`nova_gë_block
(
sb
, 
cuº_p
);

688 
∑ge_èû
 = 
	`BLOCK_OFF
(()
cuº_addr
)

689 + 
LOG_BLOCK_TAIL
;

690 i‡(
mëad©a_csum
 == 0)

693 
Æãr_∑ge
 = ((
nova_öode_∑ge_èû
 *)
∑ge_èû
)->alter_page;

694  
Æãr_∑ge
 + 
	`ENTRY_LOC
(
cuº_p
);

695 
	}
}

697 
ölöe
 
	$nova_£t_√xt_∑ge_Êag
(
su≥r_block
 *
sb
, 
u64
 
cuº_p
)

699 *
p
;

701 i‡(
	`ENTRY_LOC
(
cuº_p
Ë>
LOG_BLOCK_TAIL
)

704 
p
 = 
	`nova_gë_block
(
sb
, 
cuº_p
);

705 
	`nova_£t_íåy_ty≥
(
p
, 
NEXT_PAGE
);

706 
	`nova_Êush_buf„r
(
p
, 
CACHELINE_SIZE
, 1);

707 
	}
}

709 
ölöe
 
	$nova_£t_√xt_∑ge_addªss
(
su≥r_block
 *
sb
,

710 
nova_öode_log_∑ge
 *
cuº_∑ge
, 
u64
 
√xt_∑ge
, 
„n˚
)

712 
cuº_∑ge
->
∑ge_èû
.
√xt_∑ge
 =Çext_page;

713 
	`nova_Êush_buf„r
(&
cuº_∑ge
->
∑ge_èû
,

714 (
nova_öode_∑ge_èû
), 0);

715 i‡(
„n˚
)

716 
	`PERSISTENT_BARRIER
();

717 
	}
}

719 
ölöe
 
	$nova_£t_∑ge_num_íåõs
(
su≥r_block
 *
sb
,

720 
nova_öode_log_∑ge
 *
cuº_∑ge
, 
num
, 
Êush
)

722 
cuº_∑ge
->
∑ge_èû
.
num_íåõs
 = 
num
;

723 i‡(
Êush
)

724 
	`nova_Êush_buf„r
(&
cuº_∑ge
->
∑ge_èû
,

725 (
nova_öode_∑ge_èû
), 0);

726 
	}
}

728 
ölöe
 
	$nova_£t_∑ge_övÆid_íåõs
(
su≥r_block
 *
sb
,

729 
nova_öode_log_∑ge
 *
cuº_∑ge
, 
num
, 
Êush
)

731 
cuº_∑ge
->
∑ge_èû
.
övÆid_íåõs
 = 
num
;

732 i‡(
Êush
)

733 
	`nova_Êush_buf„r
(&
cuº_∑ge
->
∑ge_èû
,

734 (
nova_öode_∑ge_èû
), 0);

735 
	}
}

737 
ölöe
 
	$nova_öc_∑ge_num_íåõs
(
su≥r_block
 *
sb
,

738 
u64
 
cuº
)

740 
nova_öode_log_∑ge
 *
cuº_∑ge
;

742 
cuº
 = 
	`BLOCK_OFF
(curr);

743 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
	`nova_gë_block
(
sb
, 
cuº
);

745 
cuº_∑ge
->
∑ge_èû
.
num_íåõs
++;

746 
	`nova_Êush_buf„r
(&
cuº_∑ge
->
∑ge_èû
,

747 (
nova_öode_∑ge_èû
), 0);

748 
	}
}

750 
u64
 
nova_¥öt_log_íåy
(
su≥r_block
 *
sb
, u64 
cuº
);

752 
ölöe
 
	$nova_öc_∑ge_övÆid_íåõs
(
su≥r_block
 *
sb
,

753 
u64
 
cuº
)

755 
nova_öode_log_∑ge
 *
cuº_∑ge
;

756 
u64
 
ﬁd_cuº
 = 
cuº
;

758 
cuº
 = 
	`BLOCK_OFF
(curr);

759 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
	`nova_gë_block
(
sb
, 
cuº
);

761 
cuº_∑ge
->
∑ge_èû
.
övÆid_íåõs
++;

762 i‡(
cuº_∑ge
->
∑ge_èû
.
övÆid_íåõs
 >

763 
cuº_∑ge
->
∑ge_èû
.
num_íåõs
) {

764 
	`nova_dbg
("Page 0x%llx has %uÉntries, %u invalid\n",

765 
cuº
,

766 
cuº_∑ge
->
∑ge_èû
.
num_íåõs
,

767 
cuº_∑ge
->
∑ge_èû
.
övÆid_íåõs
);

768 
	`nova_¥öt_log_íåy
(
sb
, 
ﬁd_cuº
);

771 
	`nova_Êush_buf„r
(&
cuº_∑ge
->
∑ge_èû
,

772 (
nova_öode_∑ge_èû
), 0);

773 
	}
}

775 
ölöe
 
	$nova_£t_Æãr_∑ge_addªss
(
su≥r_block
 *
sb
,

776 
u64
 
cuº
, u64 
Æãr_cuº
)

778 
nova_öode_log_∑ge
 *
cuº_∑ge
;

779 
nova_öode_log_∑ge
 *
Æãr_∑ge
;

781 i‡(
mëad©a_csum
 == 0)

784 
cuº_∑ge
 = 
	`nova_gë_block
(
sb
, 
	`BLOCK_OFF
(
cuº
));

785 
Æãr_∑ge
 = 
	`nova_gë_block
(
sb
, 
	`BLOCK_OFF
(
Æãr_cuº
));

787 
cuº_∑ge
->
∑ge_èû
.
Æãr_∑ge
 = 
Æãr_cuº
;

788 
	`nova_Êush_buf„r
(&
cuº_∑ge
->
∑ge_èû
,

789 (
nova_öode_∑ge_èû
), 0);

791 
Æãr_∑ge
->
∑ge_èû
.Æãr_∑gê
cuº
;

792 
	`nova_Êush_buf„r
(&
Æãr_∑ge
->
∑ge_èû
,

793 (
nova_öode_∑ge_èû
), 0);

794 
	}
}

796 
	#CACHE_ALIGN
(
p
Ë(’Ë& ~(
CACHELINE_SIZE
 - 1))

	)

798 
ölöe
 
boﬁ
 
	$is_œ°_íåy
(
u64
 
cuº_p
, 
size_t
 
size
)

800 
íåy_íd
;

802 
íåy_íd
 = 
	`ENTRY_LOC
(
cuº_p
Ë+ 
size
;

804  
íåy_íd
 > 
LOG_BLOCK_TAIL
;

805 
	}
}

807 
ölöe
 
boﬁ
 
	$gŸo_√xt_∑ge
(
su≥r_block
 *
sb
, 
u64
 
cuº_p
)

809 *
addr
;

810 
u8
 
ty≥
;

811 
rc
 = 0;

814 i‡(
	`ENTRY_LOC
(
cuº_p
Ë+ 32 > 
LOG_BLOCK_TAIL
)

815  
åue
;

817 
addr
 = 
	`nova_gë_block
(
sb
, 
cuº_p
);

818 i‡(
	`mem˝y
(&
ty≥
, 
addr
, (
u8
)Ë=
NULL
)

819 
rc
 = -1;

821 i‡(
rc
 < 0)

822  
åue
;

824 i‡(
ty≥
 =
NEXT_PAGE
)

825  
åue
;

827  
Ál£
;

828 
	}
}

830 
ölöe
 
	$is_dú_öô_íåy
(
su≥r_block
 *
sb
,

831 
nova_díåy
 *
íåy
)

833 i‡(
íåy
->
«me_Àn
 =1 && 
	`°∫cmp
”¡ry->
«me
, ".", 1) == 0)

835 i‡(
íåy
->
«me_Àn
 =2 && 
	`°∫cmp
”¡ry->
«me
, "..", 2) == 0)

839 
	}
}

841 
	~"bÆloc.h
"

844 
ölöe
 *
	$nova_gë_d©a_csum_addr
(
su≥r_block
 *
sb
, 
u64
 
°Ω_ƒ
,

845 
ª∂iˇ
)

847 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

848 
‰ì_li°
 *free_list;

849 
blockƒ
;

850 *
d©a_csum_addr
;

851 
u64
 
blockoff
;

852 
ödex
;

853 
BLOCK_SHIFT
 = 
PAGE_SHIFT
 - 
NOVA_STRIPE_SHIFT
;

855 i‡(!
d©a_csum
) {

856 
	`nova_dbg
("%s: D©®checksum i†dißbÀd!\n", 
__func__
);

857  
NULL
;

860 
blockƒ
 = 
°Ω_ƒ
 >> 
BLOCK_SHIFT
;

861 
ödex
 = 
blockƒ
 / 
sbi
->
≥r_li°_blocks
;

863 i‡(
ödex
 >
sbi
->
˝us
) {

864 
	`nova_dbg
("%s: InvÆid blockƒ %lu\n", 
__func__
, 
blockƒ
);

865  
NULL
;

868 
°Ω_ƒ
 -(
ödex
 * 
sbi
->
≥r_li°_blocks
Ë<< 
BLOCK_SHIFT
;

869 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
ödex
);

870 i‡(
ª∂iˇ
 == 0)

871 
blockoff
 = 
‰ì_li°
->
csum_°¨t
 << 
PAGE_SHIFT
;

873 
blockoff
 = 
‰ì_li°
->
ª∂iˇ_csum_°¨t
 << 
PAGE_SHIFT
;

876 i‡(((
NOVA_DATA_CSUM_LEN
 * 
°Ω_ƒ
Ë>> 
PAGE_SHIFT
) >=

877 
‰ì_li°
->
num_csum_blocks
) {

878 
	`nova_dbg
("%s: Invalid strpÇumber %llu, freeÜist %d\n",

879 
__func__
, 
°Ω_ƒ
, 
‰ì_li°
->
ödex
);

880  
NULL
;

883 
d©a_csum_addr
 = (
u8
 *Ë
	`nova_gë_block
(
sb
, 
blockoff
)

884 + 
NOVA_DATA_CSUM_LEN
 * 
°Ω_ƒ
;

886  
d©a_csum_addr
;

887 
	}
}

889 
ölöe
 *
	$nova_gë_∑rôy_addr
(
su≥r_block
 *
sb
,

890 
blockƒ
)

892 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

893 
‰ì_li°
 *free_list;

894 *
d©a_csum_addr
;

895 
u64
 
blockoff
;

896 
ödex
;

897 
BLOCK_SHIFT
 = 
PAGE_SHIFT
 - 
NOVA_STRIPE_SHIFT
;

899 i‡(
d©a_∑rôy
 == 0) {

900 
	`nova_dbg
("%s: D©®∑rôy i†dißbÀd!\n", 
__func__
);

901  
NULL
;

904 
ödex
 = 
blockƒ
 / 
sbi
->
≥r_li°_blocks
;

906 i‡(
ödex
 >
sbi
->
˝us
) {

907 
	`nova_dbg
("%s: InvÆid blockƒ %lu\n", 
__func__
, 
blockƒ
);

908  
NULL
;

911 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
ödex
);

912 
blockoff
 = 
‰ì_li°
->
∑rôy_°¨t
 << 
PAGE_SHIFT
;

915 i‡(((
blockƒ
 - 
‰ì_li°
->
block_°¨t
Ë>> 
BLOCK_SHIFT
) >=

916 
‰ì_li°
->
num_∑rôy_blocks
) {

917 
	`nova_dbg
("%s: Invalid blocknr %lu, freeÜist %d\n",

918 
__func__
, 
blockƒ
, 
‰ì_li°
->
ödex
);

919  
NULL
;

922 
d©a_csum_addr
 = (
u8
 *Ë
	`nova_gë_block
(
sb
, 
blockoff
) +

923 ((
blockƒ
 - 
‰ì_li°
->
block_°¨t
)

924 << 
NOVA_STRIPE_SHIFT
);

926  
d©a_csum_addr
;

927 
	}
}

934 
ölöe
 
£t_bm
(
bô
, 
sˇn_bôm≠
 *
bm
,

935 
bm_ty≥
 
ty≥
);

936 
nova_ßve_blocknode_m≠pögs_to_log
(
su≥r_block
 *
sb
);

937 
nova_ßve_öode_li°_to_log
(
su≥r_block
 *
sb
);

938 
nova_öô_hódî
(
su≥r_block
 *
sb
,

939 
nova_öode_öfo_hódî
 *
sih
, 
u16
 
i_mode
);

940 
nova_ªcovîy
(
su≥r_block
 *
sb
);

943 
nova_upd©e_íåy_csum
(*
íåy
);

944 
nova_upd©e_block_csum
(
su≥r_block
 *
sb
,

945 
nova_öode_öfo_hódî
 *
sih
, 
u8
 *
block
, 
blockƒ
,

946 
size_t
 
off£t
, size_à
byãs
, 
zîo
);

947 
nova_upd©e_Æãr_íåy
(
su≥r_block
 *
sb
, *
íåy
);

948 
nova_check_öode_öãgrôy
(
su≥r_block
 *
sb
, 
u64
 
öo
, u64 
pi_addr
,

949 
u64
 
Æãr_pi_addr
, 
nova_öode
 *
pic
, 
check_ª∂iˇ
);

950 
nova_upd©e_pgoff_csum
(
su≥r_block
 *
sb
,

951 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

952 
pgoff
, 
zîo
);

953 
boﬁ
 
nova_vîify_d©a_csum
(
su≥r_block
 *
sb
,

954 
nova_öode_öfo_hódî
 *
sih
, 
blockƒ
,

955 
size_t
 
off£t
, size_à
byãs
);

956 
nova_upd©e_åunˇãd_block_csum
(
su≥r_block
 *
sb
,

957 
öode
 *öode, 
loff_t
 
√wsize
);

964 
nova_˛ónup_öcom∂ëe_wrôe
(
su≥r_block
 *
sb
,

965 
nova_öode_öfo_hódî
 *
sih
, 
blockƒ
,

966 
Æloˇãd
, 
u64
 
begö_èû
, u64 
íd_èû
);

967 
nova_öô_fûe_wrôe_íåy
(
su≥r_block
 *
sb
,

968 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

969 
u64
 
ïoch_id
, u64 
pgoff
, 
num_∑ges
, u64 
blockƒ
, 
u32
 
time
,

970 
u64
 
size
);

971 
nova_ªassign_fûe_åì
(
su≥r_block
 *
sb
,

972 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
begö_èû
);

973 
nova_check_exi°ög_íåy
(
su≥r_block
 *
sb
,

974 
öode
 *öode, 
num_blocks
, 
°¨t_blk
,

975 
nova_fûe_wrôe_íåy
 **
ªt_íåy
,

976 
nova_fûe_wrôe_íåy
 *
ªt_íåyc
, 
check_√xt
, 
u64
 
ïoch_id
,

977 *
ö∂a˚
, 
locked
);

978 
nova_iom≠_begö
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

979 
Êags
, 
iom≠
 *iom≠, 
boﬁ
 
èkög_lock
);

980 
nova_iom≠_íd
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

981 
ssize_t
 
wrôãn
, 
Êags
, 
iom≠
 *iomap);

982 
nova_ö£π_wrôe_vma
(
vm_¨ó_°ru˘
 *
vma
);

984 
nova_check_ovîœp_vmas
(
su≥r_block
 *
sb
,

985 
nova_öode_öfo_hódî
 *
sih
,

986 
pgoff
, 
num_∑ges
);

987 
nova_h™dÀ_hód_èû_blocks
(
su≥r_block
 *
sb
,

988 
öode
 *öode, 
loff_t
 
pos
,

989 
size_t
 
cou¡
, *
kmem
);

990 
nova_¥Ÿe˘_fûe_d©a
(
su≥r_block
 *
sb
, 
öode
 *inode,

991 
loff_t
 
pos
, 
size_t
 
cou¡
, c⁄° 
__u£r
 *
buf
, 
blockƒ
,

992 
boﬁ
 
ö∂a˚
);

993 
ssize_t
 
nova_ö∂a˚_fûe_wrôe
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
,

994 
size_t
 
Àn
, 
loff_t
 *
µos
);

995 
ssize_t
 
do_nova_ö∂a˚_fûe_wrôe
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
,

996 
size_t
 
Àn
, 
loff_t
 *
µos
);

998 c⁄° 
vm_›î©i⁄s_°ru˘
 
nova_dax_vm_›s
;

1002 c⁄° 
fûe_›î©i⁄s
 
nova_dú_›î©i⁄s
;

1003 
nova_ö£π_dú_åì
(
su≥r_block
 *
sb
,

1004 
nova_öode_öfo_hódî
 *
sih
, c⁄° *
«me
,

1005 
«mñí
, 
nova_díåy
 *
dúíåy
);

1006 
nova_ªmove_dú_åì
(
su≥r_block
 *
sb
,

1007 
nova_öode_öfo_hódî
 *
sih
, c⁄° *
«me
, 
«mñí
,

1008 
ª∂ay
, 
nova_díåy
 **
¸óã_díåy
);

1009 
nova_≠≥nd_díåy
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

1010 
öode
 *
dú
, 
díåy
 *díåy, 
u64
 
öo
,

1011 
de_Àn
, 
nova_öode_upd©e
 *
upd©e
,

1012 
lök_ch™ge
, 
u64
 
ïoch_id
);

1013 
nova_≠≥nd_dú_öô_íåõs
(
su≥r_block
 *
sb
,

1014 
nova_öode
 *
pi
, 
u64
 
£lf_öo
, u64 
∑ª¡_öo
, u64 
ïoch_id
);

1015 
nova_add_díåy
(
díåy
 *díåy, 
u64
 
öo
, 
öc_lök
,

1016 
nova_öode_upd©e
 *
upd©e
, 
u64
 
ïoch_id
);

1017 
nova_ªmove_díåy
(
díåy
 *díåy, 
dec_lök
,

1018 
nova_öode_upd©e
 *
upd©e
, 
u64
 
ïoch_id
);

1019 
nova_övÆid©e_díåõs
(
su≥r_block
 *
sb
,

1020 
nova_öode_upd©e
 *
upd©e
);

1021 
nova_¥öt_dú_åì
(
su≥r_block
 *
sb
,

1022 
nova_öode_öfo_hódî
 *
sih
, 
öo
);

1023 
nova_dñëe_dú_åì
(
su≥r_block
 *
sb
,

1024 
nova_öode_öfo_hódî
 *
sih
);

1025 
nova_díåy
 *
nova_föd_díåy
(
su≥r_block
 *
sb
,

1026 
nova_öode
 *
pi
, 
öode
 *öode, c⁄° *
«me
,

1027 
«me_Àn
);

1030 c⁄° 
öode_›î©i⁄s
 
nova_fûe_öode_›î©i⁄s
;

1031 c⁄° 
fûe_›î©i⁄s
 
nova_dax_fûe_›î©i⁄s
;

1032 c⁄° 
fûe_›î©i⁄s
 
nova_wøp_fûe_›î©i⁄s
;

1036 
nova_öode_log_Á°_gc
(
su≥r_block
 *
sb
,

1037 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

1038 
u64
 
cuº_èû
, u64 
√w_block
, u64 
Æãr_√w_block
, 
num_∑ges
,

1039 
f‹˚_th‹ough
);

1042 
nova_io˘l
(
fûe
 *
fûp
, 
cmd
, 
¨g
);

1043 #ifde‡
CONFIG_COMPAT


1044 
nova_com∑t_io˘l
(
fûe
 *fûe, 
cmd
,

1045 
¨g
);

1051 
nova_dax_mem_¥Ÿe˘
(
su≥r_block
 *
sb
,

1052 *
vaddr
, 
size
, 
rw
);

1053 
nova_gë_vma_ovîœp_ønge
(
su≥r_block
 *
sb
,

1054 
nova_öode_öfo_hódî
 *
sih
, 
vm_¨ó_°ru˘
 *
vma
,

1055 
íåy_pgoff
, 
íåy_∑ges
,

1056 *
°¨t_pgoff
, *
num_∑ges
);

1057 
nova_mm≠_to_√w_blocks
(
vm_¨ó_°ru˘
 *
vma
,

1058 
addªss
);

1059 
boﬁ
 
nova_föd_pgoff_ö_vma
(
öode
 *öode, 
pgoff
);

1060 
nova_£t_vmas_ªad⁄ly
(
su≥r_block
 *
sb
);

1063 c⁄° 
öode_›î©i⁄s
 
nova_dú_öode_›î©i⁄s
;

1064 c⁄° 
öode_›î©i⁄s
 
nova_•ecül_öode_›î©i⁄s
;

1065 
díåy
 *
nova_gë_∑ª¡
(díåy *
chûd
);

1068 
nova_upd©e_pgoff_∑rôy
(
su≥r_block
 *
sb
,

1069 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

1070 
pgoff
, 
zîo
);

1071 
nova_upd©e_block_csum_∑rôy
(
su≥r_block
 *
sb
,

1072 
nova_öode_öfo_hódî
 *
sih
, 
u8
 *
block
, 
blockƒ
,

1073 
size_t
 
off£t
, size_à
byãs
);

1074 
nova_ª°‹e_d©a
(
su≥r_block
 *
sb
, 
blockƒ
,

1075 
bad°rù_id
, *
bad°rù
, 
nvmmîr
, 
u32
 
csum0
,

1076 
u32
 
csum1
, u32 *
csum_good
);

1077 
nova_upd©e_åunˇãd_block_∑rôy
(
su≥r_block
 *
sb
,

1078 
öode
 *öode, 
loff_t
 
√wsize
);

1081 
nova_ª£t_csum_∑rôy_ønge
(
su≥r_block
 *
sb
,

1082 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

1083 
°¨t_pgoff
, 
íd_pgoff
, 
zîo
,

1084 
check_íåy
);

1085 
nova_ª£t_m≠pög_csum_∑rôy
(
su≥r_block
 *
sb
,

1086 
öode
 *öode, 
addªss_•a˚
 *
m≠pög
,

1087 
°¨t_pgoff
, 
íd_pgoff
);

1088 
nova_ª£t_vma_csum_∑rôy
(
su≥r_block
 *
sb
,

1089 
vma_ôem
 *
ôem
);

1090 
nova_ªbuûd_dú_öode_åì
(
su≥r_block
 *
sb
,

1091 
nova_öode
 *
pi
, 
u64
 
pi_addr
,

1092 
nova_öode_öfo_hódî
 *
sih
);

1093 
nova_ªbuûd_öode
(
su≥r_block
 *
sb
, 
nova_öode_öfo
 *
si
,

1094 
u64
 
öo
, u64 
pi_addr
, 
ªbuûd_dú
);

1095 
nova_ª°‹e_¢≠shŸ_èbÀ
(
su≥r_block
 *
sb
, 
ju°_öô
);

1098 
nova_ícou¡î_mou¡_¢≠shŸ
(
su≥r_block
 *
sb
, *
addr
,

1099 
u8
 
ty≥
);

1100 
nova_ßve_¢≠shŸs
(
su≥r_block
 *
sb
);

1101 
nova_de°roy_¢≠shŸ_öfos
(
su≥r_block
 *
sb
);

1102 
nova_ª°‹e_¢≠shŸ_íåy
(
su≥r_block
 *
sb
,

1103 
nova_¢≠shŸ_öfo_íåy
 *
íåy
, 
u64
 
cuº_p
, 
ju°_öô
);

1104 
nova_mou¡_¢≠shŸ
(
su≥r_block
 *
sb
);

1105 
nova_≠≥nd_d©a_to_¢≠shŸ
(
su≥r_block
 *
sb
,

1106 
nova_fûe_wrôe_íåy
 *
íåy
, 
u64
 
nvmm
, u64 
num_∑ges
,

1107 
u64
 
dñëe_ïoch_id
);

1108 
nova_≠≥nd_öode_to_¢≠shŸ
(
su≥r_block
 *
sb
,

1109 
nova_öode
 *
pi
);

1110 
nova_¥öt_¢≠shŸs
(
su≥r_block
 *
sb
, 
£q_fûe
 *
£q
);

1111 
nova_¥öt_¢≠shŸ_li°s
(
su≥r_block
 *
sb
, 
£q_fûe
 *
£q
);

1112 
nova_dñëe_dód_öode
(
su≥r_block
 *
sb
, 
u64
 
öo
);

1113 
nova_¸óã_¢≠shŸ
(
su≥r_block
 *
sb
);

1114 
nova_dñëe_¢≠shŸ
(
su≥r_block
 *
sb
, 
u64
 
ïoch_id
);

1115 
nova_¢≠shŸ_öô
(
su≥r_block
 *
sb
);

1119 
nova_block_symlök
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

1120 
öode
 *öode, c⁄° *
sym«me
, 
Àn
, 
u64
 
ïoch_id
);

1121 c⁄° 
öode_›î©i⁄s
 
nova_symlök_öode_›î©i⁄s
;

1124 c⁄° *
¥oc_dú«me
;

1125 
¥oc_dú_íåy
 *
nova_¥oc_roŸ
;

1126 
nova_sysfs_öô
(
su≥r_block
 *
sb
);

1127 
nova_sysfs_exô
(
su≥r_block
 *
sb
);

1130 
nova_gë_timög_°©s
();

1131 
nova_gë_IO_°©s
();

1132 
nova_¥öt_timög_°©s
(
su≥r_block
 *
sb
);

1133 
nova_˛ór_°©s
(
su≥r_block
 *
sb
);

1134 
nova_¥öt_öode
(
nova_öode
 *
pi
);

1135 
nova_¥öt_öode_log
(
su≥r_block
 *
sb
, 
öode
 *inode);

1136 
nova_¥öt_öode_log_∑ges
(
su≥r_block
 *
sb
, 
öode
 *inode);

1137 
nova_check_öode_logs
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
);

1138 
nova_¥öt_‰ì_li°s
(
su≥r_block
 *
sb
);

1141 
nova_ã°_≥rf
(
su≥r_block
 *
sb
, 
func_id
,

1142 
poﬁmb
, 
size_t
 
size
, 
disks
);

	@nova_def.h

20 #i‚de‡
_LINUX_NOVA_DEF_H


21 
	#_LINUX_NOVA_DEF_H


	)

23 
	~<löux/ty≥s.h
>

24 
	~<löux/magic.h
>

26 
	#NOVA_SUPER_MAGIC
 0x4E4F5641

	)

35 
	#NOVA_MOUNT_PROTECT
 0x000001

	)

36 
	#NOVA_MOUNT_XATTR_USER
 0x000002

	)

37 
	#NOVA_MOUNT_POSIX_ACL
 0x000004

	)

38 
	#NOVA_MOUNT_DAX
 0x000008

	)

39 
	#NOVA_MOUNT_ERRORS_CONT
 0x000010

	)

40 
	#NOVA_MOUNT_ERRORS_RO
 0x000020

	)

41 
	#NOVA_MOUNT_ERRORS_PANIC
 0x000040

	)

42 
	#NOVA_MOUNT_HUGEMMAP
 0x000080

	)

43 
	#NOVA_MOUNT_HUGEIOREMAP
 0x000100

	)

44 
	#NOVA_MOUNT_FORMAT
 0x000200

	)

45 
	#NOVA_MOUNT_DATA_COW
 0x000400

	)

50 
	#NOVA_LINK_MAX
 32000

	)

52 
	#NOVA_DEF_BLOCK_SIZE_4K
 4096

	)

54 
	#NOVA_INODE_BITS
 7

	)

55 
	#NOVA_INODE_SIZE
 128

	)

57 
	#NOVA_NAME_LEN
 255

	)

59 
	#MAX_CPUS
 1024

	)

62 
	#NOVA_BLOCK_TYPE_4K
 0

	)

63 
	#NOVA_BLOCK_TYPE_2M
 1

	)

64 
	#NOVA_BLOCK_TYPE_1G
 2

	)

65 
	#NOVA_BLOCK_TYPE_MAX
 3

	)

67 
	#META_BLK_SHIFT
 9

	)

74 
	#NOVA_DEFAULT_BLOCK_TYPE
 
NOVA_BLOCK_TYPE_4K


	)

79 
	#CACHELINE_SIZE
 (64)

	)

80 
	#CACHELINE_MASK
 (~(
CACHELINE_SIZE
 - 1))

	)

81 
	#CACHELINE_ALIGN
(
addr
Ë((◊ddr)+
CACHELINE_SIZE
-1Ë& 
CACHELINE_MASK
)

	)

84 
ölöe
 
boﬁ
 
	$¨ch_has_˛wb
()

86  
	`°©ic_˝u_has
(
X86_FEATURE_CLWB
);

87 
	}
}

89 
suµ‹t_˛wb
;

91 
	#_mm_˛Êush
(
addr
)\

92 
asm
 vﬁ©ûe("˛Êush %0" : "+m" (*(vﬁ©ûê*)(
addr
)))

	)

93 
	#_mm_˛Êush›t
(
addr
)\

94 
asm
 volatile(".byte 0x66; clflush %0" : "+m" \

95 (*(vﬁ©ûê*)(
addr
)))

	)

96 
	#_mm_˛wb
(
addr
)\

97 
asm
 volatile(".byte 0x66; xsaveopt %0" : "+m" \

98 (*(vﬁ©ûê*)(
addr
)))

	)

101 
ölöe
 
	$PERSISTENT_MARK
()

104 
	}
}

106 
ölöe
 
	$PERSISTENT_BARRIER
()

108 
asm
 volatile ("sfence\n" : : );

109 
	}
}

111 
ölöe
 
	$nova_Êush_buf„r
(*
buf
, 
uöt32_t
 
Àn
, 
boﬁ
 
„n˚
)

113 
uöt32_t
 
i
;

115 
Àn
 =Üí + (()(
buf
Ë& (
CACHELINE_SIZE
 - 1));

116 i‡(
suµ‹t_˛wb
) {

117 
i
 = 0; i < 
Àn
; i +
CACHELINE_SIZE
)

118 
	`_mm_˛wb
(
buf
 + 
i
);

120 
i
 = 0; i < 
Àn
; i +
CACHELINE_SIZE
)

121 
	`_mm_˛Êush
(
buf
 + 
i
);

128 i‡(
„n˚
)

129 
	`PERSISTENT_BARRIER
();

130 
	}
}

133 
	#NOVA_META_CSUM_LEN
 (4)

	)

134 
	#NOVA_DATA_CSUM_LEN
 (4)

	)

139 
	#NOVA_INIT_CSUM
 (1)

	)

141 
	#ADDR_ALIGN
(
p
, 
byãs
Ë((*Ë(((ËpË& ~(byã†- 1)))

	)

150 
	#POISON_RADIUS
 (512)

	)

151 
	#POISON_MASK
 (~(
POISON_RADIUS
 - 1))

	)

152 
	#NOVA_STRIPE_SHIFT
 (9Ë

	)

153 
	#NOVA_STRIPE_SIZE
 (1 << 
NOVA_STRIPE_SHIFT
)

	)

	@parity.c

18 
	~"nova.h
"

20 
	$nova_ˇlcuœã_block_∑rôy
(
su≥r_block
 *
sb
, 
u8
 *
∑rôy
,

21 
u8
 *
block
)

23 
°Ω
, 
num_°Ωs
, 
i
, 
j
;

24 
size_t
 
°Ω_size
 = 
NOVA_STRIPE_SIZE
;

25 
°Ω_shi·
 = 
NOVA_STRIPE_SHIFT
;

26 
u64
 
x‹
;

28 
num_°Ωs
 = 
sb
->
s_blocksize
 >> 
°Ω_shi·
;

29 i‡(
	`°©ic_˝u_has
(
X86_FEATURE_XMM2
)) {

30 
i
 = 0; i < 
°Ω_size
; i += 16) {

31 
asm
 vﬁ©ûe("movdq®%0, %%xmm0" : : "m" (
block
[
i
]));

32 
°Ω
 = 1; så∞< 
num_°Ωs
; strp++) {

33 
j
 = (
°Ω
 << 
°Ω_shi·
Ë+ 
i
;

34 
asm
 volatile(

37 : : "m" (
block
[
j
])

40 
asm
 vﬁ©ûe("mov¡dq %%xmm0, %0" : "=m" (
∑rôy
[
i
]));

43 
i
 = 0; i < 
°Ω_size
; i += 8) {

44 
x‹
 = *((
u64
 *Ë&
block
[
i
]);

45 
°Ω
 = 1; så∞< 
num_°Ωs
; strp++) {

46 
j
 = (
°Ω
 << 
°Ω_shi·
Ë+ 
i
;

47 
x‹
 ^*((
u64
 *Ë&
block
[
j
]);

49 *((
u64
 *Ë&
∑rôy
[
i
]Ë
x‹
;

54 
	}
}

75 
	$nova_upd©e_block_∑rôy
(
su≥r_block
 *
sb
, 
u8
 *
block
,

76 
blockƒ
, 
zîo
)

78 
size_t
 
°Ω_size
 = 
NOVA_STRIPE_SIZE
;

79 *
∑rôy
, *
nvmm±r
;

80 
ªt
 = 0;

81 
úq_Êags
 = 0;

82 
	`INIT_TIMING
(
block_∑rôy_time
);

84 
	`NOVA_START_TIMING
(
block_∑rôy_t
, 
block_∑rôy_time
);

86 
∑rôy
 = 
	`kmÆloc
(
°Ω_size
, 
GFP_KERNEL
);

87 i‡(
∑rôy
 =
NULL
) {

88 
ªt
 = -
ENOMEM
;

89 
out
;

92 i‡(
block
 =
NULL
) {

93 
	`nova_dbg
("%s: blockÖoöã∏îr‹\n", 
__func__
);

94 
ªt
 = -
EINVAL
;

95 
out
;

98 i‡(
	`u∆ikñy
(
zîo
))

99 
	`mem£t
(
∑rôy
, 0, 
°Ω_size
);

101 
	`nova_ˇlcuœã_block_∑rôy
(
sb
, 
∑rôy
, 
block
);

103 
nvmm±r
 = 
	`nova_gë_∑rôy_addr
(
sb
, 
blockƒ
);

105 
	`nova_memu∆ock_ønge
(
sb
, 
nvmm±r
, 
°Ω_size
, &
úq_Êags
);

106 
	`mem˝y_to_pmem_noˇche
(
nvmm±r
, 
∑rôy
, 
°Ω_size
);

107 
	`nova_memlock_ønge
(
sb
, 
nvmm±r
, 
°Ω_size
, &
úq_Êags
);

110 
out
:

111 i‡(
∑rôy
 !
NULL
)

112 
	`k‰ì
(
∑rôy
);

114 
	`NOVA_END_TIMING
(
block_∑rôy_t
, 
block_∑rôy_time
);

117 
	}
}

119 
	$nova_upd©e_pgoff_∑rôy
(
su≥r_block
 *
sb
,

120 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

121 
pgoff
, 
zîo
)

123 
blockƒ
;

124 *
dax_mem
 = 
NULL
;

125 
u64
 
blockoff
;

127 
blockoff
 = 
	`nova_föd_nvmm_block
(
sb
, 
sih
, 
íåy
, 
pgoff
);

129 i‡(
blockoff
 == 0)

132 
dax_mem
 = 
	`nova_gë_block
(
sb
, 
blockoff
);

134 
blockƒ
 = 
	`nova_gë_blockƒ
(
sb
, 
blockoff
, 
sih
->
i_blk_ty≥
);

135 
	`nova_upd©e_block_∑rôy
(
sb
, 
dax_mem
, 
blockƒ
, 
zîo
);

138 
	}
}

146 
	#CSUM0
 
NOVA_INIT_CSUM


	)

147 
	$nova_upd©e_block_csum_∑rôy
(
su≥r_block
 *
sb
,

148 
nova_öode_öfo_hódî
 *
sih
, 
u8
 *
block
, 
blockƒ
,

149 
size_t
 
off£t
, size_à
byãs
)

151 
i
, 
°Ω_off£t
, 
num_°Ωs
;

152 
size_t
 
csum_size
 = 
NOVA_DATA_CSUM_LEN
;

153 
size_t
 
°Ω_size
 = 
NOVA_STRIPE_SIZE
;

154 
°Ω_shi·
 = 
NOVA_STRIPE_SHIFT
;

155 
°Ω_ƒ
, 
blockoff
, 
blocksize
 = 
sb
->
s_blocksize
;

156 *
nvmm±r
, *
nvmm±r1
;

157 
u32
 
¸c
[8];

158 
u64
 
qwd
[8], *
∑rôy
 = 
NULL
;

159 
u64
 
acc
[8] = {
CSUM0
, CSUM0, CSUM0, CSUM0, CSUM0, CSUM0, CSUM0, CSUM0};

160 
boﬁ
 
uƒﬁl_csum
 = 
Ál£
, 
uƒﬁl_∑rôy
 = false;

161 
ªt
 = 0;

162 
úq_Êags
 = 0;

163 
	`INIT_TIMING
(
block_csum_∑rôy_time
);

165 
	`NOVA_STATS_ADD
(
block_csum_∑rôy
, 1);

167 
blockoff
 = 
	`nova_gë_block_off
(
sb
, 
blockƒ
, 
sih
->
i_blk_ty≥
);

168 
°Ω_ƒ
 = 
blockoff
 >> 
°Ω_shi·
;

170 
°Ω_off£t
 = 
off£t
 & (
°Ω_size
 - 1);

171 
num_°Ωs
 = ((
°Ω_off£t
 + 
byãs
 - 1Ë>> 
°Ω_shi·
) + 1;

173 
uƒﬁl_∑rôy
 = (
blocksize
 / 
°Ω_size
 =8Ë&& (
num_°Ωs
 == 8);

174 
uƒﬁl_csum
 = 
uƒﬁl_∑rôy
 && 
	`°©ic_˝u_has
(
X86_FEATURE_XMM4_2
);

177 i‡(
uƒﬁl_csum
 || 
uƒﬁl_∑rôy
) {

178 
	`NOVA_START_TIMING
(
block_csum_∑rôy_t
, 
block_csum_∑rôy_time
);

179 i‡(
d©a_∑rôy
 > 0) {

180 
∑rôy
 = 
	`kmÆloc
(
°Ω_size
, 
GFP_KERNEL
);

181 i‡(
∑rôy
 =
NULL
) {

182 
	`nova_îr
(
sb
, "%s: bufferállocationÉrror\n",

183 
__func__
);

184 
ªt
 = -
ENOMEM
;

185 
	`NOVA_END_TIMING
(
block_csum_∑rôy_t
,

186 
block_csum_∑rôy_time
);

187 
out
;

190 
i
 = 0; i < 
°Ω_size
 / 8; i++) {

191 
qwd
[0] = *((
u64
 *Ë(
block
));

192 
qwd
[1] = *((
u64
 *Ë(
block
 + 1 * 
°Ω_size
));

193 
qwd
[2] = *((
u64
 *Ë(
block
 + 2 * 
°Ω_size
));

194 
qwd
[3] = *((
u64
 *Ë(
block
 + 3 * 
°Ω_size
));

195 
qwd
[4] = *((
u64
 *Ë(
block
 + 4 * 
°Ω_size
));

196 
qwd
[5] = *((
u64
 *Ë(
block
 + 5 * 
°Ω_size
));

197 
qwd
[6] = *((
u64
 *Ë(
block
 + 6 * 
°Ω_size
));

198 
qwd
[7] = *((
u64
 *Ë(
block
 + 7 * 
°Ω_size
));

200 i‡(
d©a_csum
 > 0 && 
uƒﬁl_csum
) {

201 
	`nova_¸c32c_qw‹d
(
qwd
[0], 
acc
[0]);

202 
	`nova_¸c32c_qw‹d
(
qwd
[1], 
acc
[1]);

203 
	`nova_¸c32c_qw‹d
(
qwd
[2], 
acc
[2]);

204 
	`nova_¸c32c_qw‹d
(
qwd
[3], 
acc
[3]);

205 
	`nova_¸c32c_qw‹d
(
qwd
[4], 
acc
[4]);

206 
	`nova_¸c32c_qw‹d
(
qwd
[5], 
acc
[5]);

207 
	`nova_¸c32c_qw‹d
(
qwd
[6], 
acc
[6]);

208 
	`nova_¸c32c_qw‹d
(
qwd
[7], 
acc
[7]);

211 i‡(
d©a_∑rôy
 > 0) {

212 
∑rôy
[
i
] = 
qwd
[0] ^ qwd[1] ^ qwd[2] ^ qwd[3] ^

213 
qwd
[4] ^ qwd[5] ^ qwd[6] ^ qwd[7];

216 
block
 += 8;

218 i‡(
d©a_csum
 > 0 && 
uƒﬁl_csum
) {

219 
¸c
[0] = 
	`˝u_to_À32
((
u32
Ë
acc
[0]);

220 
¸c
[1] = 
	`˝u_to_À32
((
u32
Ë
acc
[1]);

221 
¸c
[2] = 
	`˝u_to_À32
((
u32
Ë
acc
[2]);

222 
¸c
[3] = 
	`˝u_to_À32
((
u32
Ë
acc
[3]);

223 
¸c
[4] = 
	`˝u_to_À32
((
u32
Ë
acc
[4]);

224 
¸c
[5] = 
	`˝u_to_À32
((
u32
Ë
acc
[5]);

225 
¸c
[6] = 
	`˝u_to_À32
((
u32
Ë
acc
[6]);

226 
¸c
[7] = 
	`˝u_to_À32
((
u32
Ë
acc
[7]);

228 
nvmm±r
 = 
	`nova_gë_d©a_csum_addr
(
sb
, 
°Ω_ƒ
, 0);

229 
nvmm±r1
 = 
	`nova_gë_d©a_csum_addr
(
sb
, 
°Ω_ƒ
, 1);

230 
	`nova_memu∆ock_ønge
(
sb
, 
nvmm±r
, 
csum_size
 * 8, &
úq_Êags
);

231 
	`mem˝y_to_pmem_noˇche
(
nvmm±r
, 
¸c
, 
csum_size
 * 8);

232 
	`mem˝y_to_pmem_noˇche
(
nvmm±r1
, 
¸c
, 
csum_size
 * 8);

233 
	`nova_memlock_ønge
(
sb
, 
nvmm±r
, 
csum_size
 * 8, &
úq_Êags
);

236 i‡(
d©a_∑rôy
 > 0) {

237 
nvmm±r
 = 
	`nova_gë_∑rôy_addr
(
sb
, 
blockƒ
);

238 
	`nova_memu∆ock_ønge
(
sb
, 
nvmm±r
, 
°Ω_size
, &
úq_Êags
);

239 
	`mem˝y_to_pmem_noˇche
(
nvmm±r
, 
∑rôy
, 
°Ω_size
);

240 
	`nova_memlock_ønge
(
sb
, 
nvmm±r
, 
°Ω_size
, &
úq_Êags
);

243 i‡(
∑rôy
 !
NULL
)

244 
	`k‰ì
(
∑rôy
);

245 
	`NOVA_END_TIMING
(
block_csum_∑rôy_t
, 
block_csum_∑rôy_time
);

248 i‡(
d©a_csum
 > 0 && !
uƒﬁl_csum
)

249 
	`nova_upd©e_block_csum
(
sb
, 
sih
, 
block
, 
blockƒ
,

250 
off£t
, 
byãs
, 0);

251 i‡(
d©a_∑rôy
 > 0 && !
uƒﬁl_∑rôy
)

252 
	`nova_upd©e_block_∑rôy
(
sb
, 
block
, 
blockƒ
, 0);

254 
out
:

256 
	}
}

268 
	$nova_ª°‹e_d©a
(
su≥r_block
 *
sb
, 
blockƒ
,

269 
bad°rù_id
, *
bad°rù
, 
nvmmîr
, 
u32
 
csum0
,

270 
u32
 
csum1
, u32 *
csum_good
)

272 
i
, 
num_°Ωs
;

273 
size_t
 
°Ω_size
 = 
NOVA_STRIPE_SIZE
;

274 
°Ω_shi·
 = 
NOVA_STRIPE_SHIFT
;

275 
size_t
 
blockoff
, 
off£t
;

276 
u8
 *
block±r
, *
°rù±r
, *
block
, *
∑rôy
, *
°rù
;

277 
u32
 
csum_ˇlc
;

278 
boﬁ
 
suc˚ss
 = 
Ál£
;

279 
úq_Êags
 = 0;

280 
	`INIT_TIMING
(
ª°‹e_time
);

281 
ªt
 = 0;

283 
	`NOVA_START_TIMING
(
ª°‹e_d©a_t
, 
ª°‹e_time
);

284 
blockoff
 = 
	`nova_gë_block_off
(
sb
, 
blockƒ
, 
NOVA_BLOCK_TYPE_4K
);

285 
block±r
 = 
	`nova_gë_block
(
sb
, 
blockoff
);

286 
°rù±r
 = 
block±r
 + (
bad°rù_id
 << 
°Ω_shi·
);

288 
block
 = 
	`kmÆloc
(
sb
->
s_blocksize
, 
GFP_KERNEL
);

289 
°rù
 = 
	`kmÆloc
(
°Ω_size
, 
GFP_KERNEL
);

290 i‡(
block
 =
NULL
 || 
°rù
 == NULL) {

291 
	`nova_îr
(
sb
, "%s: buf„∏Æloˇti⁄Éº‹\n", 
__func__
);

292 
ªt
 = -
ENOMEM
;

293 
out
;

296 
∑rôy
 = 
	`nova_gë_∑rôy_addr
(
sb
, 
blockƒ
);

297 i‡(
∑rôy
 =
NULL
) {

298 
	`nova_îr
(
sb
, "%s:Ö¨ôyáddªs†îr‹\n", 
__func__
);

299 
ªt
 = -
EIO
;

300 
out
;

303 
num_°Ωs
 = 
sb
->
s_blocksize
 >> 
°Ω_shi·
;

304 
i
 = 0; i < 
num_°Ωs
; i++) {

305 
off£t
 = 
i
 << 
°Ω_shi·
;

306 i‡(
i
 =
bad°rù_id
) {

308 i‡(
	`mem˝y
(
block
 + 
off£t
, 
∑rôy
, 
°Ω_size
Ë=
NULL
)

309 
ªt
 = -1;

312 i‡(
	`mem˝y
(
block
 + 
off£t
,

313 
block±r
 + 
off£t
, 
°Ω_size
Ë=
NULL
)

314 
ªt
 = -1;

317 i‡(
ªt
 < 0) {

319 
	`nova_îr
(
sb
, "%s: unrecoverable mediaÉrror detected\n",

320 
__func__
);

321 
out
;

325 
	`nova_ˇlcuœã_block_∑rôy
(
sb
, 
°rù
, 
block
);

326 
i
 = 0; i < 
°Ω_size
; i++) {

334 
	`mem˝y
(
°rù
, 
bad°rù
, 
i
);

336 
csum_ˇlc
 = 
	`nova_¸c32c
(
NOVA_INIT_CSUM
, 
°rù
, 
°Ω_size
);

337 i‡(
csum_ˇlc
 =
csum0
 || csum_ˇl¯=
csum1
) {

338 
suc˚ss
 = 
åue
;

343 i‡(
nvmmîr
)

350 i‡(
bad°rù_id
 =
num_°Ωs
 - 1)

354 i‡(
suc˚ss
) {

356 
	`nova_memu∆ock_ønge
(
sb
, 
°rù±r
, 
°Ω_size
, &
úq_Êags
);

357 
	`mem˝y_to_pmem_noˇche
(
°rù±r
, 
°rù
, 
°Ω_size
);

358 
	`nova_memlock_ønge
(
sb
, 
°rù±r
, 
°Ω_size
, &
úq_Êags
);

361 *
csum_good
 = 
csum_ˇlc
;

364 
ªt
 = -
EIO
;

367 
out
:

368 i‡(
block
 !
NULL
)

369 
	`k‰ì
(
block
);

370 i‡(
°rù
 !
NULL
)

371 
	`k‰ì
(
°rù
);

373 
	`NOVA_END_TIMING
(
ª°‹e_d©a_t
, 
ª°‹e_time
);

374  
ªt
;

375 
	}
}

377 
	$nova_upd©e_åunˇãd_block_∑rôy
(
su≥r_block
 *
sb
,

378 
öode
 *öode, 
loff_t
 
√wsize
)

380 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

381 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

382 
pgoff
, 
blockƒ
;

383 
blocksize
 = 
sb
->
s_blocksize
;

384 
u64
 
nvmm
;

385 *
nvmm_addr
, *
block
;

386 
u8
 
bty≥
 = 
sih
->
i_blk_ty≥
;

387 
ªt
 = 0;

389 
pgoff
 = 
√wsize
 >> 
sb
->
s_blocksize_bôs
;

391 
nvmm
 = 
	`nova_föd_nvmm_block
(
sb
, 
sih
, 
NULL
, 
pgoff
);

392 i‡(
nvmm
 == 0)

393  -
EFAULT
;

395 
nvmm_addr
 = (*)
	`nova_gë_block
(
sb
, 
nvmm
);

397 
blockƒ
 = 
	`nova_gë_blockƒ
(
sb
, 
nvmm
, 
bty≥
);

400 
block
 = 
	`kmÆloc
(
blocksize
, 
GFP_KERNEL
);

401 i‡(
block
 =
NULL
) {

402 
ªt
 = -
ENOMEM
;

403 
out
;

406 i‡(
	`mem˝y
(
block
, 
nvmm_addr
, 
blocksize
Ë=
NULL
) {

407 
ªt
 = -
EIO
;

408 
out
;

411 
	`nova_upd©e_block_∑rôy
(
sb
, 
block
, 
blockƒ
, 0);

412 
out
:

413 i‡(
block
 !
NULL
)

414 
	`k‰ì
(
block
);

415  
ªt
;

416 
	}
}

	@perf.c

21 
	~"≥rf.h
"

24 
	$mem˝y_ªad_ˇŒ
(*
d°
, *
§c
, 
size_t
 
off
, size_à
size
)

27 
	`mem˝y
(
d°
, 
§c
 + 
off
, 
size
);

29 
	}
}

31 
	$mem˝y_wrôe_ˇŒ
(*
d°
, *
§c
, 
size_t
 
off
, size_à
size
)

34 
	`mem˝y
(
d°
 + 
off
, 
§c
, 
size
);

36 
	}
}

38 
	$mem˝y_bidú_ˇŒ
(*
d°
, *
§c
, 
size_t
 
off
, size_à
size
)

41 
	`mem˝y
(
d°
 + 
off
, 
§c
 + off, 
size
);

43 
	}
}

45 c⁄° 
mem˝y_ˇŒ_t
 
	gmem˝y_ˇŒs
[] = {

47 { "mem˝y (mo°lyÑód)", 
mem˝y_ªad_ˇŒ
 },

48 { "mem˝y (mo°ly wrôe)", 
mem˝y_wrôe_ˇŒ
 },

49 { "mem˝y (ªad wrôe)", 
mem˝y_bidú_ˇŒ
 }

53 
	$‰om_pmem_ˇŒ
(*
d°
, *
§c
, 
size_t
 
off
, size_à
size
)

57 
rc
 = 0;

58 i‡(
	`mem˝y
(
d°
, 
§c
 + 
off
, 
size
Ë=
NULL
)

59 
rc
 = 1;

60  
rc
;

61 
	}
}

63 c⁄° 
mem˝y_ˇŒ_t
 
	g‰om_pmem_ˇŒs
[] = {

65 { "mem˝y_mcß„", 
‰om_pmem_ˇŒ
 }

69 
	$to_pmem_noˇche_ˇŒ
(*
d°
, *
§c
, 
size_t
 
off
, size_à
size
)

73 
	`mem˝y_to_pmem_noˇche
(
d°
 + 
off
, 
§c
, 
size
);

75 
	}
}

77 
	$to_Êush_ˇŒ
(*
d°
, *
§c
, 
size_t
 
off
, size_à
size
)

81 
	`nova_Êush_buf„r
(
d°
 + 
off
, 
size
, 0);

83 
	}
}

85 
	$to_pmem_Êush_ˇŒ
(*
d°
, *
§c
, 
size_t
 
off
, size_à
size
)

89 
	`mem˝y
(
d°
 + 
off
, 
§c
, 
size
);

90 
	`nova_Êush_buf„r
(
d°
 + 
off
, 
size
, 0);

92 
	}
}

94 c⁄° 
mem˝y_ˇŒ_t
 
	gto_pmem_ˇŒs
[] = {

96 { "mem˝y_to_pmem_noˇche", 
to_pmem_noˇche_ˇŒ
 },

97 { "Êush buf„r", 
to_Êush_ˇŒ
 },

98 { "mem˝y + flush buf„r", 
to_pmem_Êush_ˇŒ
 }

102 
u64
 
	$zlib_adÀr32_ˇŒ
(
u64
 
öô
, *
d©a
, 
size_t
 
size
)

104 
u64
 
csum
;

107 
csum
 = 
	`zlib_adÀr32
(
öô
, 
d©a
, 
size
);

108  
csum
;

109 
	}
}

111 
u64
 
	$nd_Êëchî64_ˇŒ
(
u64
 
öô
, *
d©a
, 
size_t
 
size
)

113 
u64
 
csum
;

116 
csum
 = 
	`nd_Êëchî64
(
d©a
, 
size
, 1);

117  
csum
;

118 
	}
}

120 
u64
 
	$lib¸c32c_ˇŒ
(
u64
 
öô
, *
d©a
, 
size_t
 
size
)

122 
u32
 
¸c
 = (u32Ë
öô
;

124 
¸c
 = 
	`¸c32c
(¸c, 
d©a
, 
size
);

125  (
u64
Ë
¸c
;

126 
	}
}

128 
u64
 
	$nova_¸c32c_ˇŒ
(
u64
 
öô
, *
d©a
, 
size_t
 
size
)

130 
u32
 
¸c
 = (u32Ë
öô
;

132 
¸c
 = 
	`nova_¸c32c
(¸c, 
d©a
, 
size
);

133  (
u64
Ë
¸c
;

134 
	}
}

136 
u64
 
	$∂aö_x‹64_ˇŒ
(
u64
 
öô
, *
d©a
, 
size_t
 
size
)

138 
u64
 
csum
 = 
öô
;

139 
u64
 *
w‹d
 = (u64 *Ë
d©a
;

141 
size
 > 8) {

142 
csum
 ^*
w‹d
;

143 
w‹d
 += 1;

144 
size
 -= 8;

149  
csum
;

150 
	}
}

152 c⁄° 
checksum_ˇŒ_t
 
	gchecksum_ˇŒs
[] = {

154 { "zlib_adÀr32", 
zlib_adÀr32_ˇŒ
 },

155 { "nd_Êëchî64", 
nd_Êëchî64_ˇŒ
 },

156 { "lib¸c32c", 
lib¸c32c_ˇŒ
 },

157 { "nova_¸c32c", 
nova_¸c32c_ˇŒ
 },

158 { "∂aö_x‹64", 
∂aö_x‹64_ˇŒ
 }

162 
u64
 
	$nova_block_∑rôy_ˇŒ
(**
d©a
, *
∑rôy
,

163 
size_t
 
size
, 
disks
)

165 
i
, 
j
, 
°Ω
, 
num_°Ωs
 = 
disks
;

166 
size_t
 
°Ω_size
 = 
size
;

167 *
block
 = *
d©a
;

168 
u64
 
x‹
;

172 i‡(
	`°©ic_˝u_has
(
X86_FEATURE_XMM2
)) {

173 
i
 = 0; i < 
°Ω_size
; i += 16) {

174 
asm
 vﬁ©ûe("movdq®%0, %%xmm0" : : "m" (
block
[
i
]));

175 
°Ω
 = 1; så∞< 
num_°Ωs
; strp++) {

176 
j
 = 
°Ω
 * 
°Ω_size
 + 
i
;

177 
asm
 volatile(

180 : : "m" (
block
[
j
])

183 
asm
 vﬁ©ûe("mov¡dq %%xmm0, %0" : "=m" (
∑rôy
[
i
]));

186 
i
 = 0; i < 
°Ω_size
; i += 8) {

187 
x‹
 = *((
u64
 *Ë&
block
[
i
]);

188 
°Ω
 = 1; så∞< 
num_°Ωs
; strp++) {

189 
j
 = 
°Ω
 * 
°Ω_size
 + 
i
;

190 
x‹
 ^*((
u64
 *Ë&
block
[
j
]);

192 *((
u64
 *Ë&
∑rôy
[
i
]Ë
x‹
;

196  *((
u64
 *Ë
∑rôy
);

197 
	}
}

199 
u64
 
	$nova_block_csum_∑rôy_ˇŒ
(**
d©a
, *
∑rôy
,

200 
size_t
 
size
, 
disks
)

202 
i
;

203 
size_t
 
°Ω_size
 = 
size
;

204 *
block
 = *
d©a
;

205 
u32
 vﬁ©ûê
¸c
[8];

206 
u64
 
qwd
[8];

207 
u64
 
acc
[8] = {0, 0, 0, 0, 0, 0, 0, 0};

211 
i
 = 0; i < 
°Ω_size
 / 8; i++) {

212 
qwd
[0] = *((
u64
 *Ë(
block
));

213 
qwd
[1] = *((
u64
 *Ë(
block
 + 1 * 
°Ω_size
));

214 
qwd
[2] = *((
u64
 *Ë(
block
 + 2 * 
°Ω_size
));

215 
qwd
[3] = *((
u64
 *Ë(
block
 + 3 * 
°Ω_size
));

216 
qwd
[4] = *((
u64
 *Ë(
block
 + 4 * 
°Ω_size
));

217 
qwd
[5] = *((
u64
 *Ë(
block
 + 5 * 
°Ω_size
));

218 
qwd
[6] = *((
u64
 *Ë(
block
 + 6 * 
°Ω_size
));

219 
qwd
[7] = *((
u64
 *Ë(
block
 + 7 * 
°Ω_size
));

222 
	`nova_¸c32c_qw‹d
(
qwd
[0], 
acc
[0]);

223 
	`nova_¸c32c_qw‹d
(
qwd
[1], 
acc
[1]);

224 
	`nova_¸c32c_qw‹d
(
qwd
[2], 
acc
[2]);

225 
	`nova_¸c32c_qw‹d
(
qwd
[3], 
acc
[3]);

226 
	`nova_¸c32c_qw‹d
(
qwd
[4], 
acc
[4]);

227 
	`nova_¸c32c_qw‹d
(
qwd
[5], 
acc
[5]);

228 
	`nova_¸c32c_qw‹d
(
qwd
[6], 
acc
[6]);

229 
	`nova_¸c32c_qw‹d
(
qwd
[7], 
acc
[7]);

233 
∑rôy
[
i
] = 
qwd
[0] ^ qwd[1] ^ qwd[2] ^ qwd[3] ^

234 
qwd
[4] ^ qwd[5] ^ qwd[6] ^ qwd[7];

237 
block
 += 8;

240 
¸c
[0] = 
	`˝u_to_À32
((
u32
Ë
acc
[0]);

241 
¸c
[1] = 
	`˝u_to_À32
((
u32
Ë
acc
[1]);

242 
¸c
[2] = 
	`˝u_to_À32
((
u32
Ë
acc
[2]);

243 
¸c
[3] = 
	`˝u_to_À32
((
u32
Ë
acc
[3]);

244 
¸c
[4] = 
	`˝u_to_À32
((
u32
Ë
acc
[4]);

245 
¸c
[5] = 
	`˝u_to_À32
((
u32
Ë
acc
[5]);

246 
¸c
[6] = 
	`˝u_to_À32
((
u32
Ë
acc
[6]);

247 
¸c
[7] = 
	`˝u_to_À32
((
u32
Ë
acc
[7]);

250  *((
u64
 *Ë
∑rôy
);

251 
	}
}

254 
u64
 
	$x‹_blocks_ˇŒ
(**
d©a
, *
∑rôy
,

255 
size_t
 
size
, 
disks
)

257 
x‹_˙t
, 
disk_id
;

259 
	`mem˝y
(
∑rôy
, 
d©a
[0], 
size
);

260 
disks
--;

261 
disk_id
 = 1;

262 
disks
 > 0) {

264 
x‹_˙t
 = 
	`mö
(
disks
, 
MAX_XOR_BLOCKS
);

266 
	`x‹_blocks
(
x‹_˙t
, 
size
, 
∑rôy
, (**)(
d©a
 + 
disk_id
));

268 
disks
 -
x‹_˙t
;

269 
disk_id
 +
x‹_˙t
;

272  *((
u64
 *Ë
∑rôy
);

273 
	}
}

276 c⁄° 
øid5_ˇŒ_t
 
	gøid5_ˇŒs
[] = {

278 { "nova_block_∑rôy", 
nova_block_∑rôy_ˇŒ
 },

279 { "nova_block_csum_∑rôy", 
nova_block_csum_∑rôy_ˇŒ
 },

284 *
	$nova_Æloc_vmem_poﬁ
(
size_t
 
poﬁsize
)

286 *
poﬁ
 = 
	`vmÆloc
(
poﬁsize
);

288 i‡(
poﬁ
 =
NULL
)

289  
NULL
;

297 
	`Êush_kî√l_vm≠_ønge
(
poﬁ
, 
poﬁsize
);

299  
poﬁ
;

300 
	}
}

302 
	$nova_‰ì_vmem_poﬁ
(*
poﬁ
)

304 i‡(
poﬁ
 !
NULL
)

305 
	`v‰ì
(
poﬁ
);

306 
	}
}

308 *
	$nova_Æloc_pmem_poﬁ
(
su≥r_block
 *
sb
,

309 
nova_öode_öfo_hódî
 *
sih
, 
˝u
, 
size_t
 
poﬁsize
,

310 *
blockƒ
, *
Æloˇãd
)

312 
num
;

313 *
poﬁ
;

314 
size_t
 
blocksize
, 
blockoff
;

315 
u8
 
blockty≥
 = 
NOVA_BLOCK_TYPE_4K
;

317 
blocksize
 = 
blk_ty≥_to_size
[
blockty≥
];

318 
num
 = 
poﬁsize
 / 
blocksize
;

319 i‡(
poﬁsize
 % 
blocksize
)

320 
num
++;

322 
sih
->
öo
 = 
NOVA_TEST_PERF_INO
;

323 
sih
->
i_blk_ty≥
 = 
blockty≥
;

324 
sih
->
log_hód
 = 0;

325 
sih
->
log_èû
 = 0;

327 *
Æloˇãd
 = 
	`nova_√w_d©a_blocks
(
sb
, 
sih
, 
blockƒ
, 0, 
num
,

328 
ALLOC_NO_INIT
, 
˝u
, 
ALLOC_FROM_HEAD
);

329 i‡(*
Æloˇãd
 < 
num
) {

330 
	`nova_dbg
("%s:állocatedÖmem blocks %d <Ñequested blocks %d\n",

331 
__func__
, *
Æloˇãd
, 
num
);

332 i‡(*
Æloˇãd
 > 0)

333 
	`nova_‰ì_d©a_blocks
(
sb
, 
sih
, *
blockƒ
, *
Æloˇãd
);

335  
NULL
;

338 
blockoff
 = 
	`nova_gë_block_off
(
sb
, *
blockƒ
, 
blockty≥
);

339 
poﬁ
 = 
	`nova_gë_block
(
sb
, 
blockoff
);

341  
poﬁ
;

342 
	}
}

344 
	$nova_‰ì_pmem_poﬁ
(
su≥r_block
 *
sb
,

345 
nova_öode_öfo_hódî
 *
sih
, **
pmem
,

346 
blockƒ
, 
num
)

348 i‡(
num
 > 0)

349 
	`nova_‰ì_d©a_blocks
(
sb
, 
sih
, 
blockƒ
, 
num
);

350 *
pmem
 = 
NULL
;

351 
	}
}

353 
	$nova_ã°_func_≥rf
(
su≥r_block
 *
sb
, 
func_id
,

354 
size_t
 
poﬁsize
, size_à
size
, 
disks
)

356 
u64
 
csum
 = 12345, 
x‹
 = 0;

358 
u64
 vﬁ©ûê
ªsu…
;

359 c⁄° *
‚ame
 = 
NULL
;

360 *
§c
 = 
NULL
, *
d°
 = NULL, *
pmem
 = NULL;

361 **
d©a
 = 
NULL
, *
∑rôy
;

362 
size_t
 
off
 = 0;

363 
˝u
, 
i
, 
j
, 
ªps
, 
îr
 = 0, 
Æloˇãd
 = 0;

364 
ˇŒ_id
 = 0, 
ˇŒ_gid
 = 0;

365 
blockƒ
 = 0, 
n£c
, 
œt
, 
thru
;

366 
nova_öode_öfo_hódî
 
≥rf_sih
;

367 c⁄° 
mem˝y_ˇŒ_t
 *
fmem˝y
 = 
NULL
;

368 c⁄° 
checksum_ˇŒ_t
 *
fchecksum
 = 
NULL
;

369 c⁄° 
øid5_ˇŒ_t
 *
‰aid5
 = 
NULL
;

370 
úq_Êags
 = 0;

371 
	`INIT_TIMING
(
≥rf_time
);

373 
˝u
 = 
	`gë_˝u
();

374 
ªps
 = 
poﬁsize
 / 
size
;

375 
ˇŒ_id
 = 
func_id
 - 1;

378 i‡(
ˇŒ_id
 < 
NUM_MEMCPY_CALLS
) {

379 
§c
 = 
	`nova_Æloc_vmem_poﬁ
(
poﬁsize
);

380 
d°
 = 
	`nova_Æloc_vmem_poﬁ
(
poﬁsize
);

381 i‡(
§c
 =
NULL
 || 
d°
 == NULL) {

382 
îr
 = -
ENOMEM
;

383 
out
;

386 
fmem˝y
 = &
mem˝y_ˇŒs
[
ˇŒ_id
];

387 
‚ame
 = 
fmem˝y
->
«me
;

388 
ˇŒ_gid
 = 
mem˝y_gid
;

390 
ã°
;

392 
ˇŒ_id
 -
NUM_MEMCPY_CALLS
;

395 i‡(
ˇŒ_id
 < 
NUM_FROM_PMEM_CALLS
) {

396 
pmem
 = 
	`nova_Æloc_pmem_poﬁ
(
sb
, &
≥rf_sih
, 
˝u
, 
poﬁsize
,

397 &
blockƒ
, &
Æloˇãd
);

398 
d°
 = 
	`nova_Æloc_vmem_poﬁ
(
poﬁsize
);

399 i‡(
pmem
 =
NULL
 || 
d°
 == NULL) {

400 
îr
 = -
ENOMEM
;

401 
out
;

404 
fmem˝y
 = &
‰om_pmem_ˇŒs
[
ˇŒ_id
];

405 
‚ame
 = 
fmem˝y
->
«me
;

406 
ˇŒ_gid
 = 
‰om_pmem_gid
;

408 
ã°
;

410 
ˇŒ_id
 -
NUM_FROM_PMEM_CALLS
;

413 i‡(
ˇŒ_id
 < 
NUM_TO_PMEM_CALLS
) {

414 
§c
 = 
	`nova_Æloc_vmem_poﬁ
(
poﬁsize
);

415 
pmem
 = 
	`nova_Æloc_pmem_poﬁ
(
sb
, &
≥rf_sih
, 
˝u
, 
poﬁsize
,

416 &
blockƒ
, &
Æloˇãd
);

417 i‡(
§c
 =
NULL
 || 
pmem
 == NULL) {

418 
îr
 = -
ENOMEM
;

419 
out
;

422 
fmem˝y
 = &
to_pmem_ˇŒs
[
ˇŒ_id
];

423 
‚ame
 = 
fmem˝y
->
«me
;

424 
ˇŒ_gid
 = 
to_pmem_gid
;

426 
ã°
;

428 
ˇŒ_id
 -
NUM_TO_PMEM_CALLS
;

431 i‡(
ˇŒ_id
 < 
NUM_CHECKSUM_CALLS
) {

432 
§c
 = 
	`nova_Æloc_vmem_poﬁ
(
poﬁsize
);

434 
fchecksum
 = &
checksum_ˇŒs
[
ˇŒ_id
];

435 
‚ame
 = 
fchecksum
->
«me
;

436 
ˇŒ_gid
 = 
checksum_gid
;

438 
ã°
;

440 
ˇŒ_id
 -
NUM_CHECKSUM_CALLS
;

443 i‡(
ˇŒ_id
 < 
NUM_RAID5_CALLS
) {

444 
§c
 = 
	`nova_Æloc_vmem_poﬁ
(
poﬁsize
);

445 
d©a
 = 
	`kˇŒoc
(
disks
, (*), 
GFP_NOFS
);

446 i‡(
d©a
 =
NULL
) {

447 
îr
 = -
ENOMEM
;

448 
out
;

451 
ªps
 = 
poﬁsize
 / ((
disks
 + 1Ë* 
size
);

453 
‰aid5
 = &
øid5_ˇŒs
[
ˇŒ_id
];

454 
‚ame
 = 
‰aid5
->
«me
;

455 
ˇŒ_gid
 = 
øid5_gid
;

457 i‡(
ˇŒ_id
 =
nova_block_csum_∑rôy_id
 && 
disks
 != 8) {

458 
	`nova_dbg
("%†⁄ly f‹ 8 disks, skùÅe°ög\n", 
‚ame
);

459 
out
;

462 
ã°
;

464 
ˇŒ_id
 -
NUM_RAID5_CALLS
;

468 
ã°
:

469 i‡(
fmem˝y
 =
NULL
 && 
fchecksum
 =NULL && 
‰aid5
 == NULL) {

470 
	`nova_dbg
("%s: fun˘i⁄ såu˘Éº‹\n", 
__func__
);

471 
îr
 = -
EFAULT
;

472 
out
;

475 
	`ª£t_≥rf_timî
();

476 
	`NOVA_START_TIMING
(
≥rf_t
, 
≥rf_time
);

478 
ˇŒ_gid
) {

479 
mem˝y_gid
:

480 
i
 = 0; i < 
ªps
; i++, 
off
 +
size
)

481 
îr
 = 
fmem˝y
->
	`ˇŒ
(
d°
, 
§c
, 
off
, 
size
);

483 
‰om_pmem_gid
:

484 
i
 = 0; i < 
ªps
; i++, 
off
 +
size
)

485 
îr
 = 
fmem˝y
->
	`ˇŒ
(
d°
, 
pmem
, 
off
, 
size
);

487 
to_pmem_gid
:

488 
	`nova_memu∆ock_ønge
(
sb
, 
pmem
, 
poﬁsize
, &
úq_Êags
);

489 
i
 = 0; i < 
ªps
; i++, 
off
 +
size
)

490 
îr
 = 
fmem˝y
->
	`ˇŒ
(
pmem
, 
§c
, 
off
, 
size
);

491 
	`nova_memlock_ønge
(
sb
, 
pmem
, 
poﬁsize
, &
úq_Êags
);

493 
checksum_gid
:

494 
i
 = 0; i < 
ªps
; i++, 
off
 +
size
)

496 
csum
 = 
fchecksum
->
	`ˇŒ
(csum, 
§c
 + 
off
, 
size
);

497 
ªsu…
 = 
csum
;

499 
øid5_gid
:

500 
i
 = 0; i < 
ªps
; i++, 
off
 +(
disks
 + 1Ë* 
size
) {

501 
j
 = 0; j < 
disks
; j++)

502 
d©a
[
j
] = &
§c
[
off
 + j * 
size
];

503 
∑rôy
 = 
§c
 + 
off
 + 
disks
 * 
size
;

504 
x‹
 = 
‰aid5
->
	`ˇŒ
(
d©a
, 
∑rôy
, 
size
, 
disks
);

506 
ªsu…
 = 
x‹
;

509 
	`nova_dbg
("%s: invÆid fun˘i⁄ grou∞%d\n", 
__func__
, 
ˇŒ_gid
);

513 
	`NOVA_END_TIMING
(
≥rf_t
, 
≥rf_time
);

514 
n£c
 = 
	`ªad_≥rf_timî
();

518 
œt
 = (
îr
Ë? 0 : 
n£c
 / 
ªps
;

519 i‡(
ˇŒ_gid
 =
øid5_gid
)

520 
thru
 = (
îr
Ë? 0 : 
	`mb_≥r_£c
(
ªps
 * 
disks
 * 
size
, 
n£c
);

522 
thru
 = (
îr
Ë? 0 : 
	`mb_≥r_£c
(
ªps
 * 
size
, 
n£c
);

524 i‡(
˝u
 !
	`smp_¥o˚ss‹_id
())

525 
	`nova_dbg
("˝u wa†%d,Çow %d\n", 
˝u
, 
	`smp_¥o˚ss‹_id
());

527 
	`nova_öfo
("%4u %25†%4u %8lu %8lu\n", 
func_id
, 
‚ame
, 
˝u
, 
œt
, 
thru
);

529 
out
:

530 
	`nova_‰ì_vmem_poﬁ
(
§c
);

531 
	`nova_‰ì_vmem_poﬁ
(
d°
);

532 
	`nova_‰ì_pmem_poﬁ
(
sb
, &
≥rf_sih
, &
pmem
, 
blockƒ
, 
Æloˇãd
);

534 i‡(
d©a
 !
NULL
)

535 
	`k‰ì
(
d©a
);

537 
	`put_˝u
();

539 i‡(
îr
)

540 
	`nova_dbg
("%s:Öîf‹m™˚Åe°áb‹ãd\n", 
__func__
);

541  
îr
;

542 
	}
}

544 
	$nova_ã°_≥rf
(
su≥r_block
 *
sb
, 
func_id
,

545 
poﬁmb
, 
size_t
 
size
, 
disks
)

547 
id
, 
ªt
 = 0;

548 
size_t
 
poﬁsize
 = 
poﬁmb
 * 1024 * 1024;

550 i‡(!
mósuª_timög
) {

551 
	`nova_dbg
("%s: mósuª_timögÇŸ së!\n", 
__func__
);

552 
ªt
 = -
EFAULT
;

553 
out
;

555 i‡(
func_id
 > 
NUM_PERF_CALLS
) {

556 
	`nova_dbg
("%s: invÆid fun˘i⁄ id %d!\n", 
__func__
, 
func_id
);

557 
ªt
 = -
EFAULT
;

558 
out
;

560 i‡(
poﬁmb
 < 1 || 1024 <Öoolmb) {

561 
	`nova_dbg
("%s: invÆidÖoﬁ sizê%u MB!\n", 
__func__
, 
poﬁmb
);

562 
ªt
 = -
EFAULT
;

563 
out
;

565 i‡(
size
 < 64 || 
poﬁsize
 < size || (size % 64)) {

566 
	`nova_dbg
("%s: invÆid d©®sizê%zu!\n", 
__func__
, 
size
);

567 
ªt
 = -
EFAULT
;

568 
out
;

570 i‡(
disks
 < 1 || 32 < disks) {

571 
	`nova_dbg
("%s: invÆid disk cou¡ %u!\n", 
__func__
, 
disks
);

572 
ªt
 = -
EFAULT
;

573 
out
;

576 
	`nova_öfo
("test functionÖerformance\n");

577 
	`nova_öfo
("pool size %u MB, work size %zu, disks %u\n",

578 
poﬁmb
, 
size
, 
disks
);

580 
	`nova_öfo
("%4s %25s %4s %8s %8s\n", "id", "name", "cpu", "ns", "MB/s");

581 
	`nova_öfo
("-------------------------------------------------------\n");

582 i‡(
func_id
 == 0) {

584 
id
 = 1; id <
NUM_PERF_CALLS
; id++) {

585 
ªt
 = 
	`nova_ã°_func_≥rf
(
sb
, 
id
, 
poﬁsize
,

586 
size
, 
disks
);

587 i‡(
ªt
 < 0)

588 
out
;

591 
ªt
 = 
	`nova_ã°_func_≥rf
(
sb
, 
func_id
, 
poﬁsize
, 
size
, 
disks
);

593 
	`nova_öfo
("-------------------------------------------------------\n");

595 
out
:

596  
ªt
;

597 
	}
}

	@perf.h

21 
	~<löux/zutû.h
>

22 
	~<löux/libnvdimm.h
>

23 
	~<löux/øid/x‹.h
>

24 
	~"nova.h
"

26 
	#ª£t_≥rf_timî
(Ë
	`__this_˝u_wrôe
(
Timög°©s_≥r˝u
[
≥rf_t
], 0)

	)

27 
	#ªad_≥rf_timî
(Ë
	`__this_˝u_ªad
(
Timög°©s_≥r˝u
[
≥rf_t
])

	)

29 
	#mb_≥r_£c
(
size
, 
n£c
) (nsec == 0 ? 0 : \

30 (
size
 * (1000000000 / 1024 / 1024Ë/ 
n£c
))

	)

32 
	emem˝y_ˇŒ_id
 {

33 
	mmem˝y_ªad_id
 = 0,

34 
	mmem˝y_wrôe_id
,

35 
	mmem˝y_bidú_id
,

36 
	mNUM_MEMCPY_CALLS


39 
	e‰om_pmem_ˇŒ_id
 {

40 
	mmem˝y_mcß„_id
 = 0,

41 
	mNUM_FROM_PMEM_CALLS


44 
	eto_pmem_ˇŒ_id
 {

45 
	mmem˝y_to_pmem_noˇche_id
 = 0,

46 
	mÊush_buf„r_id
,

47 
	mmem˝y_to_pmem_Êush_id
,

48 
	mNUM_TO_PMEM_CALLS


51 
	echecksum_ˇŒ_id
 {

52 
	mzlib_adÀr32_id
 = 0,

53 
	mnd_Êëchî64_id
,

54 
	mlib¸c32c_id
,

55 
	mnova_¸c32c_id
,

56 
	m∂aö_x‹64_id
,

57 
	mNUM_CHECKSUM_CALLS


60 
	eøid5_ˇŒ_id
 {

61 
	mnova_block_∑rôy_id
 = 0,

62 
	mnova_block_csum_∑rôy_id
,

64 
	mNUM_RAID5_CALLS


67 
	#NUM_PERF_CALLS
 \

68 (
NUM_MEMCPY_CALLS
 + 
NUM_FROM_PMEM_CALLS
 + 
NUM_TO_PMEM_CALLS
 + \

69 
NUM_CHECKSUM_CALLS
 + 
NUM_RAID5_CALLS
)

	)

71 
	eˇŒ_group_id
 {

72 
	mmem˝y_gid
 = 0,

73 
	m‰om_pmem_gid
,

74 
	mto_pmem_gid
,

75 
	mchecksum_gid
,

76 
	møid5_gid


80 c⁄° *
	m«me
;

82 (*
	mˇŒ
)(*, *, 
	msize_t
, size_t);

83 } 
	tmem˝y_ˇŒ_t
;

86 c⁄° *
	m«me
;

88 
u64
 (*
ˇŒ
)(
	mu64
, *, 
	msize_t
);

89 } 
	tchecksum_ˇŒ_t
;

92 c⁄° *
	m«me
;

94 
u64
 (*
ˇŒ
)(**, *,

95 
	msize_t
, );

96 } 
	tøid5_ˇŒ_t
;

	@rebuild.c

18 
	~<löux/∑ge-Êags.h
>

19 
	~"nova.h
"

20 
	~"öode.h
"

23 
	$nova_≠∂y_£èâr_íåy
(
su≥r_block
 *
sb
,

24 
nova_öode_ªbuûd
 *
ªb
, 
nova_öode_öfo_hódî
 *
sih
,

25 
nova_£èâr_logíåy
 *
íåy
)

27 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
sih
->
i_blk_ty≥
];

28 
fú°_blockƒ
, 
œ°_blockƒ
;

29 
loff_t
 
°¨t
, 
íd
;

30 
‰ìd
 = 0;

32 i‡(
íåy
->
íåy_ty≥
 !
SET_ATTR
)

33 
	`BUG
();

35 
ªb
->
i_mode
 = 
íåy
->
mode
;

36 
ªb
->
i_uid
 = 
íåy
->
uid
;

37 
ªb
->
i_gid
 = 
íåy
->
gid
;

38 
ªb
->
i_©ime
 = 
íåy
->
©ime
;

40 i‡(
	`S_ISREG
(
ªb
->
i_mode
)) {

41 
°¨t
 = 
íåy
->
size
;

42 
íd
 = 
ªb
->
i_size
;

44 
fú°_blockƒ
 = (
°¨t
 + (1UL << 
d©a_bôs
) - 1) >> data_bits;

46 i‡(
íd
 > 0)

47 
œ°_blockƒ
 = (
íd
 - 1Ë>> 
d©a_bôs
;

49 
œ°_blockƒ
 = 0;

51 
‰ìd
 = 
	`nova_dñëe_fûe_åì
(
sb
, 
sih
, 
fú°_blockƒ
,

52 
œ°_blockƒ
, 
Ál£
, false, 0);

54 
	}
}

57 
	$nova_≠∂y_lök_ch™ge_íåy
(
su≥r_block
 *
sb
,

58 
nova_öode_ªbuûd
 *
ªb
, 
nova_lök_ch™ge_íåy
 *
íåy
)

60 i‡(
íåy
->
íåy_ty≥
 !
LINK_CHANGE
)

61 
	`BUG
();

63 
ªb
->
i_löks_cou¡
 = 
íåy
->
löks
;

64 
ªb
->
i_˘ime
 = 
íåy
->
˘ime
;

65 
ªb
->
i_Êags
 = 
íåy
->
Êags
;

66 
ªb
->
i_gíî©i⁄
 = 
íåy
->
gíî©i⁄
;

69 
	}
}

71 
	$nova_upd©e_öode_wôh_ªbuûd
(
su≥r_block
 *
sb
,

72 
nova_öode_ªbuûd
 *
ªb
, 
nova_öode
 *
pi
)

74 
pi
->
i_size
 = 
	`˝u_to_À64
(
ªb
->i_size);

75 
pi
->
i_Êags
 = 
	`˝u_to_À32
(
ªb
->i_flags);

76 
pi
->
i_uid
 = 
	`˝u_to_À32
(
ªb
->i_uid);

77 
pi
->
i_gid
 = 
	`˝u_to_À32
(
ªb
->i_gid);

78 
pi
->
i_©ime
 = 
	`˝u_to_À32
(
ªb
->i_atime);

79 
pi
->
i_˘ime
 = 
	`˝u_to_À32
(
ªb
->i_ctime);

80 
pi
->
i_mtime
 = 
	`˝u_to_À32
(
ªb
->i_mtime);

81 
pi
->
i_gíî©i⁄
 = 
	`˝u_to_À32
(
ªb
->i_generation);

82 
pi
->
i_löks_cou¡
 = 
	`˝u_to_À16
(
ªb
->i_links_count);

83 
pi
->
i_mode
 = 
	`˝u_to_À16
(
ªb
->i_mode);

84 
	}
}

86 
	$nova_öô_öode_ªbuûd
(
su≥r_block
 *
sb
,

87 
nova_öode_ªbuûd
 *
ªb
, 
nova_öode
 *
pi
)

89 
nova_öode
 
Áke_pi
;

91 i‡(
	`mem˝y
(&
Áke_pi
, 
pi
, (
nova_öode
)Ë=
NULL
)

94 
ªb
->
i_size
 = 
	`À64_to_˝u
(
Áke_pi
.i_size);

95 
ªb
->
i_Êags
 = 
	`À32_to_˝u
(
Áke_pi
.i_flags);

96 
ªb
->
i_uid
 = 
	`À32_to_˝u
(
Áke_pi
.i_uid);

97 
ªb
->
i_gid
 = 
	`À32_to_˝u
(
Áke_pi
.i_gid);

98 
ªb
->
i_©ime
 = 
	`À32_to_˝u
(
Áke_pi
.i_atime);

99 
ªb
->
i_˘ime
 = 
	`À32_to_˝u
(
Áke_pi
.i_ctime);

100 
ªb
->
i_mtime
 = 
	`À32_to_˝u
(
Áke_pi
.i_mtime);

101 
ªb
->
i_gíî©i⁄
 = 
	`À32_to_˝u
(
Áke_pi
.i_generation);

102 
ªb
->
i_löks_cou¡
 = 
	`À16_to_˝u
(
Áke_pi
.i_links_count);

103 
ªb
->
i_mode
 = 
	`À16_to_˝u
(
Áke_pi
.i_mode);

104 
ªb
->
å™s_id
 = 0;

107 
	}
}

109 
ölöe
 
	$nova_ªbuûd_fûe_time_™d_size
(
su≥r_block
 *
sb
,

110 
nova_öode_ªbuûd
 *
ªb
, 
u32
 
mtime
, u32 
˘ime
, 
u64
 
size
)

112 
ªb
->
i_mtime
 = 
	`˝u_to_À32
(
mtime
);

113 
ªb
->
i_˘ime
 = 
	`˝u_to_À32
(
˘ime
);

114 
ªb
->
i_size
 = 
	`˝u_to_À64
(
size
);

115 
	}
}

117 
	$nova_ªbuûd_öode_°¨t
(
su≥r_block
 *
sb
,

118 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

119 
nova_öode_ªbuûd
 *
ªb
, 
u64
 
pi_addr
)

121 
ªt
;

123 
ªt
 = 
	`nova_gë_hód_èû
(
sb
, 
pi
, 
sih
);

124 i‡(
ªt
)

125  
ªt
;

127 
ªt
 = 
	`nova_öô_öode_ªbuûd
(
sb
, 
ªb
, 
pi
);

128 i‡(
ªt
)

129  
ªt
;

131 
sih
->
pi_addr
 =Öi_addr;

133 
	`nova_dbg_vîbo£
("Log head 0x%llx,Åail 0x%llx\n",

134 
sih
->
log_hód
, sih->
log_èû
);

135 
sih
->
log_∑ges
 = 1;

137  
ªt
;

138 
	}
}

140 
	$nova_ªbuûd_öode_föish
(
su≥r_block
 *
sb
,

141 
nova_öode
 *
pi
, 
nova_öode_öfo_hódî
 *
sih
,

142 
nova_öode_ªbuûd
 *
ªb
, 
u64
 
cuº_p
)

144 
nova_öode
 *
Æãr_pi
;

145 
u64
 
√xt
;

146 
úq_Êags
 = 0;

148 
sih
->
i_size
 = 
	`À64_to_˝u
(
ªb
->i_size);

149 
sih
->
i_mode
 = 
	`À64_to_˝u
(
ªb
->i_mode);

150 
sih
->
i_Êags
 = 
	`À32_to_˝u
(
ªb
->i_flags);

151 
sih
->
å™s_id
 = 
ªb
->trans_id + 1;

153 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

154 
	`nova_upd©e_öode_wôh_ªbuûd
(
sb
, 
ªb
, 
pi
);

155 
	`nova_upd©e_öode_checksum
(
pi
);

156 i‡(
mëad©a_csum
) {

157 
Æãr_pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
,

158 
sih
->
Æãr_pi_addr
);

159 
	`mem˝y_to_pmem_noˇche
(
Æãr_pi
, 
pi
, (
nova_öode
));

161 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

164 
cuº_p
 &
PAGE_MASK
;

165 (
√xt
 = 
	`√xt_log_∑ge
(
sb
, 
cuº_p
)) > 0) {

166 
sih
->
log_∑ges
++;

167 
cuº_p
 = 
√xt
;

170 i‡(
mëad©a_csum
)

171 
sih
->
log_∑ges
 *= 2;

174 
	}
}

176 
	$nova_ª£t_csum_∑rôy_∑ge
(
su≥r_block
 *
sb
,

177 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

178 
pgoff
, 
zîo
)

180 
	`nova_dbgv
("%s: upd©ê∑gêof‡%lu\n", 
__func__
, 
pgoff
);

182 i‡(
d©a_csum
)

183 
	`nova_upd©e_pgoff_csum
(
sb
, 
sih
, 
íåy
, 
pgoff
, 
zîo
);

185 i‡(
d©a_∑rôy
)

186 
	`nova_upd©e_pgoff_∑rôy
(
sb
, 
sih
, 
íåy
, 
pgoff
, 
zîo
);

189 
	}
}

191 
	$nova_ª£t_csum_∑rôy_ønge
(
su≥r_block
 *
sb
,

192 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

193 
°¨t_pgoff
, 
íd_pgoff
, 
zîo
,

194 
check_íåy
)

196 
nova_fûe_wrôe_íåy
 *
cuº
;

197 
pgoff
;

199 i‡(
d©a_csum
 =0 && 
d©a_∑rôy
 == 0)

202 
pgoff
 = 
°¨t_pgoff
;Ögof‡< 
íd_pgoff
;Ögoff++) {

203 i‡(
íåy
 && 
check_íåy
 && 
zîo
 == 0) {

204 
cuº
 = 
	`nova_gë_wrôe_íåy
(
sb
, 
sih
, 
pgoff
);

205 i‡(
cuº
 !
íåy
)

210 
	`nova_ª£t_csum_∑rôy_∑ge
(
sb
, 
sih
, 
íåy
, 
pgoff
, 
zîo
);

214 
	}
}

217 
	$nova_ª£t_d©a_csum_∑rôy
(
su≥r_block
 *
sb
,

218 
nova_öode_öfo_hódî
 *
sih
, 
nova_fûe_wrôe_íåy
 *
íåy
,

219 
nova_fûe_wrôe_íåy
 *
íåyc
)

221 
íd_pgoff
;

223 i‡(
d©a_csum
 =0 && 
d©a_∑rôy
 == 0)

224 
out
;

226 i‡(
íåyc
->
övÆid_∑ges
 =íåyc->
num_∑ges
)

228 
out
;

230 
íd_pgoff
 = 
íåyc
->
pgoff
 +É¡ryc->
num_∑ges
;

231 
	`nova_ª£t_csum_∑rôy_ønge
(
sb
, 
sih
, 
íåy
, 
íåyc
->
pgoff
,

232 
íd_pgoff
, 0, 1);

234 
out
:

235 
	`nova_£t_wrôe_íåy_upd©ög
(
sb
, 
íåy
, 0);

238 
	}
}

241 
	$nova_ª£t_mm≠_csum_∑rôy
(
su≥r_block
 *
sb
,

242 
nova_öode_öfo_hódî
 *
sih
, 
nova_mm≠_íåy
 *
íåy
,

243 
nova_mm≠_íåy
 *
íåyc
)

245 
íd_pgoff
;

246 
ªt
 = 0;

248 i‡(
d©a_csum
 =0 && 
d©a_∑rôy
 == 0)

251 i‡(
íåyc
->
övÆid
 == 1)

255 
íd_pgoff
 = 
íåyc
->
pgoff
 +É¡ryc->
num_∑ges
;

256 
	`nova_ª£t_csum_∑rôy_ønge
(
sb
, 
sih
, 
NULL
, 
íåyc
->
pgoff
,

257 
íd_pgoff
, 0, 0);

259 
ªt
 = 
	`nova_övÆid©e_logíåy
(
sb
, 
íåy
, 
MMAP_WRITE
, 0);

261  
ªt
;

262 
	}
}

268 
	$föd_gë_íåõs_èg
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 
°¨t
,

269 
xa_m¨k_t
 
èg
, 
ƒ_íåõs
,

271 
fﬁio_b©ch
 *
fb©ch
, 
pgoff_t
 *
ödi˚s
)

273 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
°¨t
);

274 
∑ge
 *page;

275 
fﬁio
 *folio;

276 
ªt
 = 0;

278 i‡(!
ƒ_íåõs
)

281 
	`rcu_ªad_lock
();

283 
	`xas_f‹_óch_m¨ked
(&
xas
, 
fﬁio
, 
ULONG_MAX
, 
èg
) {

284 
∑ge
 *
hód
;

286 i‡(
	`xas_ªåy
(&
xas
, 
	`∑ge_fﬁio
(
∑ge
)))

294 i‡(
	`xa_is_vÆue
(
	`∑ge_fﬁio
(
∑ge
)))

295 
exp‹t
;

297 
hód
 = 
	`compound_hód
(
∑ge
);

299 i‡(!
	`fﬁio_åy_gë_rcu
(
	`∑ge_fﬁio
(
hód
)))

300 
ªåy
;

303 i‡(
	`compound_hód
(
∑ge
Ë!
hód
)

304 
put_∑ge
;

307 i‡(
	`u∆ikñy
(
∑ge
 !
	`xas_ªlﬂd
(&
xas
)))

308 
put_∑ge
;

309 
exp‹t
:

311 
ödi˚s
[
fb©ch
->
ƒ
] = 
xas
.
xa_ödex
;

315 if(!
	`fﬁio_b©ch_add
(
fb©ch
, 
fﬁio
))

318 
put_∑ge
:

319 
	`put_∑ge
(
hód
);

320 
ªåy
:

321 
	`xas_ª£t
(&
xas
);

323 
	`rcu_ªad_u∆ock
();

324  
ªt
;

325 
	}
}

327 
	$nova_ª£t_m≠pög_csum_∑rôy
(
su≥r_block
 *
sb
,

328 
öode
 *öode, 
addªss_•a˚
 *
m≠pög
,

329 
°¨t_pgoff
, 
íd_pgoff
)

331 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

332 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

333 
pgoff_t
 
ödi˚s
[
PAGEVEC_SIZE
];

335 
fﬁio_b©ch
 
fb©ch
;

336 
boﬁ
 
d⁄e
 = 
Ál£
;

337 
cou¡
 = 0;

338 
°¨t
 = 0;

339 
	`INIT_TIMING
(
ª£t_time
);

340 
i
;

342 i‡(
d©a_csum
 =0 && 
d©a_∑rôy
 == 0)

345 
	`NOVA_START_TIMING
(
ª£t_m≠pög_t
, 
ª£t_time
);

346 
	`nova_dbgv
("%s:Ögoff %luÅo %lu\n",

347 
__func__
, 
°¨t_pgoff
, 
íd_pgoff
);

349 !
d⁄e
) {

353 
fb©ch
.
ƒ
 = 
	`föd_gë_íåõs_èg
(
m≠pög
, 
°¨t_pgoff
,

354 
PAGECACHE_TAG_DIRTY
, 
PAGEVEC_SIZE
,

355 &
fb©ch
, 
ödi˚s
);

358 i‡(
fb©ch
.
ƒ
 == 0)

361 i‡(
cou¡
 == 0)

362 
°¨t
 = 
ödi˚s
[0];

365 
i
 = 0; i <
fb©ch
.
ƒ
; i++) {

366 i‡(
ödi˚s
[
i
] >
íd_pgoff
) {

367 
d⁄e
 = 
åue
;

371 
	`NOVA_STATS_ADD
(
dúty_∑ges
, 1);

372 
	`nova_ª£t_csum_∑rôy_∑ge
(
sb
, 
sih
, 
NULL
,

373 
ödi˚s
[
i
], 0);

377 
cou¡
 +
fb©ch
.
ƒ
;

379 i‡(
fb©ch
.
ƒ
 < 
PAGEVEC_SIZE
)

383 
°¨t_pgoff
 = 
ödi˚s
[
fb©ch
.
ƒ
 - 1] + 1;

386 i‡(
cou¡
)

387 
	`nova_dbgv
("%s: inode %lu,Ñeset %dÖages, startÖgoff %lu\n",

388 
__func__
, 
sih
->
öo
, 
cou¡
, 
°¨t
);

390 
	`NOVA_END_TIMING
(
ª£t_m≠pög_t
, 
ª£t_time
);

392 
	}
}

394 
	$nova_ª£t_vma_csum_∑rôy
(
su≥r_block
 *
sb
,

395 
vma_ôem
 *
ôem
)

397 
vm_¨ó_°ru˘
 *
vma
 = 
ôem
->vma;

398 
addªss_•a˚
 *
m≠pög
 = 
vma
->
vm_fûe
->
f_m≠pög
;

399 
öode
 *öodê
m≠pög
->
ho°
;

400 
nova_mm≠_íåy
 *
íåy
;

401 
num_∑ges
;

402 
°¨t_ödex
, 
íd_ödex
;

403 
	`INIT_TIMING
(
ª£t_time
);

404 
ªt
 = 0;

406 i‡(
d©a_csum
 =0 && 
d©a_∑rôy
 == 0)

409 
	`NOVA_START_TIMING
(
ª£t_vma_t
, 
ª£t_time
);

410 
num_∑ges
 = (
vma
->
vm_íd
 - vma->
vm_°¨t
Ë>> 
PAGE_SHIFT
;

411 
°¨t_ödex
 = 
vma
->
vm_pgoff
;

412 
íd_ödex
 = 
vma
->
vm_pgoff
 + 
num_∑ges
;

414 
	`nova_dbgv
("%s: inode %lu,Ögoff %lu - %lu\n",

415 
__func__
, 
öode
->
i_öo
, 
°¨t_ödex
, 
íd_ödex
);

417 
ªt
 = 
	`nova_ª£t_m≠pög_csum_∑rôy
(
sb
, 
öode
, 
m≠pög
,

418 
°¨t_ödex
, 
íd_ödex
);

420 i‡(
ôem
->
mm≠_íåy
) {

421 
íåy
 = 
	`nova_gë_block
(
sb
, 
ôem
->
mm≠_íåy
);

422 
ªt
 = 
	`nova_övÆid©e_logíåy
(
sb
, 
íåy
, 
MMAP_WRITE
, 0);

425 
	`NOVA_END_TIMING
(
ª£t_vma_t
, 
ª£t_time
);

426  
ªt
;

427 
	}
}

429 
	$nova_ªbuûd_h™dÀ_wrôe_íåy
(
su≥r_block
 *
sb
,

430 
nova_öode_öfo_hódî
 *
sih
, 
nova_öode_ªbuûd
 *
ªb
,

431 
nova_fûe_wrôe_íåy
 *
íåy
,

432 
nova_fûe_wrôe_íåy
 *
íåyc
)

434 i‡(
íåyc
->
num_∑ges
 !íåyc->
övÆid_∑ges
) {

439 
	`nova_assign_wrôe_íåy
(
sb
, 
sih
, 
íåy
, 
íåyc
, 
Ál£
);

442 i‡(
íåyc
->
å™s_id
 >
sih
->trans_id) {

443 
	`nova_ªbuûd_fûe_time_™d_size
(
sb
, 
ªb
,

444 
íåyc
->
mtime
,Éntryc->mtime,

445 
íåyc
->
size
);

446 
ªb
->
å™s_id
 = 
íåyc
->trans_id;

449 i‡(
íåyc
->
upd©ög
)

450 
	`nova_ª£t_d©a_csum_∑rôy
(
sb
, 
sih
, 
íåy
, 
íåyc
);

453 
sih
->
i_size
 = 
	`À64_to_˝u
(
ªb
->i_size);

454 
	}
}

456 
	$nova_ªbuûd_fûe_öode_åì
(
su≥r_block
 *
sb
,

457 
nova_öode
 *
pi
, 
u64
 
pi_addr
,

458 
nova_öode_öfo_hódî
 *
sih
)

460 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

461 
nova_fûe_wrôe_íåy
 *
íåy
 = 
NULL
;

462 
nova_£èâr_logíåy
 *
©å_íåy
 = 
NULL
;

463 
nova_lök_ch™ge_íåy
 *
lök_ch™ge_íåy
 = 
NULL
;

464 
nova_mm≠_íåy
 *
mm≠_íåy
 = 
NULL
;

465 
íåy_c›y
[
NOVA_MAX_ENTRY_LEN
];

466 
nova_öode_ªbuûd
 
ªbuûd
, *
ªb
;

467 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
sih
->
i_blk_ty≥
];

468 
u64
 
öo
 = 
pi
->
nova_öo
;

469 
	`INIT_TIMING
(
ªbuûd_time
);

470 *
addr
, *
íåyc
;

471 
u64
 
cuº_p
;

472 
u8
 
ty≥
;

473 
ªt
;

475 
	`NOVA_START_TIMING
(
ªbuûd_fûe_t
, 
ªbuûd_time
);

476 
	`nova_dbg_vîbo£
("Rebuûd fûêöodê%ŒuÅªe\n", 
öo
);

478 
ªb
 = &
ªbuûd
;

479 
ªt
 = 
	`nova_ªbuûd_öode_°¨t
(
sb
, 
pi
, 
sih
, 
ªb
, 
pi_addr
);

480 i‡(
ªt
)

481 
out
;

483 
cuº_p
 = 
sih
->
log_hód
;

486 i‡(
cuº_p
 =0 || 
sih
->
log_èû
 == 0) {

487 
	`nova_w¨n
("NULLÜogÖoöãr(sËö fûêöodê%Œu\n", 
öo
);

488 
pi
->
log_hód
 = 0;

489 
pi
->
log_èû
 = 0;

490 
	`nova_Êush_buf„r
(
pi
, (
nova_öode
), 1);

491 
out
;

494 
íåyc
 = (
mëad©a_csum
 =0Ë? 
NULL
 : 
íåy_c›y
;

498 
cuº_p
 !
sih
->
log_èû
) {

499 i‡(
	`gŸo_√xt_∑ge
(
sb
, 
cuº_p
)) {

500 
sih
->
log_∑ges
++;

501 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

504 i‡(
cuº_p
 == 0) {

505 
	`nova_îr
(
sb
, "Fûêöodê%ŒuÜog i†NULL!\n", 
öo
);

506 
	`BUG
();

509 
addr
 = (*)
	`nova_gë_block
(
sb
, 
cuº_p
);

511 i‡(
mëad©a_csum
 == 0)

512 
íåyc
 = 
addr
;

513 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
addr
, 
íåyc
))

516 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
íåyc
);

518 i‡(
sbi
->
mou¡_¢≠shŸ
) {

519 i‡(
	`nova_ícou¡î_mou¡_¢≠shŸ
(
sb
, 
addr
, 
ty≥
))

523 
ty≥
) {

524 
SET_ATTR
:

525 
©å_íåy
 = (
nova_£èâr_logíåy
 *)
íåyc
;

526 
	`nova_≠∂y_£èâr_íåy
(
sb
, 
ªb
, 
sih
, 
©å_íåy
);

527 
sih
->
œ°_£èâr
 = 
cuº_p
;

528 i‡(
©å_íåy
->
å™s_id
 >
ªb
->trans_id) {

529 
	`nova_ªbuûd_fûe_time_™d_size
(
sb
, 
ªb
,

530 
©å_íåy
->
mtime
,

531 
©å_íåy
->
˘ime
,

532 
©å_íåy
->
size
);

533 
ªb
->
å™s_id
 = 
©å_íåy
->trans_id;

537 
sih
->
i_size
 = 
	`À64_to_˝u
(
ªb
->i_size);

538 
cuº_p
 +(
nova_£èâr_logíåy
);

540 
LINK_CHANGE
:

541 
lök_ch™ge_íåy
 =

542 (
nova_lök_ch™ge_íåy
 *)
íåyc
;

543 
	`nova_≠∂y_lök_ch™ge_íåy
(
sb
, 
ªb
,

544 
lök_ch™ge_íåy
);

545 
sih
->
œ°_lök_ch™ge
 = 
cuº_p
;

546 
cuº_p
 +(
nova_lök_ch™ge_íåy
);

548 
FILE_WRITE
:

549 
íåy
 = (
nova_fûe_wrôe_íåy
 *)
addr
;

550 
	`nova_ªbuûd_h™dÀ_wrôe_íåy
(
sb
, 
sih
, 
ªb
,

551 
íåy
, 
	`WENTRY
(
íåyc
));

552 
cuº_p
 +(
nova_fûe_wrôe_íåy
);

554 
MMAP_WRITE
:

555 
mm≠_íåy
 = (
nova_mm≠_íåy
 *)
addr
;

556 
	`nova_ª£t_mm≠_csum_∑rôy
(
sb
, 
sih
,

557 
mm≠_íåy
, 
	`MMENTRY
(
íåyc
));

558 
cuº_p
 +(
nova_mm≠_íåy
);

561 
	`nova_îr
(
sb
, "unknow¿ty≥ %d, 0x%Œx\n", 
ty≥
, 
cuº_p
);

562 
	`NOVA_ASSERT
(0);

563 
cuº_p
 +(
nova_fûe_wrôe_íåy
);

569 
ªt
 = 
	`nova_ªbuûd_öode_föish
(
sb
, 
pi
, 
sih
, 
ªb
, 
cuº_p
);

570 
sih
->
i_blocks
 = sih->
log_∑ges
 + (sih->
i_size
 >> 
d©a_bôs
);

572 
out
:

574 
	`NOVA_END_TIMING
(
ªbuûd_fûe_t
, 
ªbuûd_time
);

575  
ªt
;

576 
	}
}

580 
ölöe
 
	$nova_ªbuûd_dú_time_™d_size
(
su≥r_block
 *
sb
,

581 
nova_öode_ªbuûd
 *
ªb
, 
nova_díåy
 *
íåy
,

582 
nova_díåy
 *
íåyc
)

584 i‡(!
íåy
 || !
ªb
)

587 
ªb
->
i_˘ime
 = 
íåyc
->
mtime
;

588 
ªb
->
i_mtime
 = 
íåyc
->
mtime
;

589 
ªb
->
i_löks_cou¡
 = 
íåyc
->
löks_cou¡
;

591 
	}
}

593 
	$nova_ªassign_œ°_díåy
(
su≥r_block
 *
sb
,

594 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
cuº_p
)

596 
nova_díåy
 *
díåy
, *
ﬁd_díåy
;

598 i‡(
sih
->
œ°_díåy
 == 0) {

599 
sih
->
œ°_díåy
 = 
cuº_p
;

601 
ﬁd_díåy
 = (
nova_díåy
 *)
	`nova_gë_block
(
sb
,

602 
sih
->
œ°_díåy
);

603 
díåy
 = (
nova_díåy
 *)
	`nova_gë_block
(
sb
, 
cuº_p
);

604 i‡(
díåy
->
å™s_id
 >
ﬁd_díåy
->trans_id)

605 
sih
->
œ°_díåy
 = 
cuº_p
;

607 
	}
}

609 
ölöe
 
	$nova_ª∂ay_add_díåy
(
su≥r_block
 *
sb
,

610 
nova_öode_öfo_hódî
 *
sih
, 
nova_díåy
 *
íåy
,

611 
nova_díåy
 *
íåyc
)

613 i‡(!
íåyc
->
«me_Àn
)

614  -
EINVAL
;

616 
	`nova_dbg_vîbo£
("%s:ádd %s\n", 
__func__
, 
íåy
->
«me
);

617  
	`nova_ö£π_dú_åì
(
sb
, 
sih
,

618 
íåyc
->
«me
,É¡ryc->
«me_Àn
, 
íåy
);

619 
	}
}

622 
ölöe
 
	$nova_ª∂ay_ªmove_díåy
(
su≥r_block
 *
sb
,

623 
nova_öode_öfo_hódî
 *
sih
, 
nova_díåy
 *
íåy
)

625 
	`nova_dbg_vîbo£
("%s:Ñemovê%s\n", 
__func__
, 
íåy
->
«me
);

626 
	`nova_ªmove_dú_åì
(
sb
, 
sih
, 
íåy
->
«me
,

627 
íåy
->
«me_Àn
, 1, 
NULL
);

629 
	}
}

631 
	$nova_ªbuûd_h™dÀ_díåy
(
su≥r_block
 *
sb
,

632 
nova_öode_öfo_hódî
 *
sih
, 
nova_öode_ªbuûd
 *
ªb
,

633 
nova_díåy
 *
íåy
, nova_díåy *
íåyc
, 
u64
 
cuº_p
)

635 
ªt
 = 0;

637 
	`nova_dbgv
("curr_p: 0x%llx,Åype %d, ino %llu,Çame %s,Çamelen %u, csum 0x%x,ÑecÜen %u\n",

638 
cuº_p
,

639 
íåy
->
íåy_ty≥
, 
	`À64_to_˝u
”¡ry->
öo
),

640 
íåy
->
«me
,É¡ry->
«me_Àn
,É¡ry->
csum
,

641 
	`À16_to_˝u
(
íåy
->
de_Àn
));

643 
	`nova_ªassign_œ°_díåy
(
sb
, 
sih
, 
cuº_p
);

645 i‡(
íåyc
->
övÆid
 == 0) {

646 i‡(
íåyc
->
öo
 > 0)

647 
ªt
 = 
	`nova_ª∂ay_add_díåy
(
sb
, 
sih
, 
íåy
, 
íåyc
);

649 
ªt
 = 
	`nova_ª∂ay_ªmove_díåy
(
sb
, 
sih
, 
íåyc
);

652 i‡(
ªt
) {

653 
	`nova_îr
(
sb
, "%†ERROR %d\n", 
__func__
, 
ªt
);

654  
ªt
;

657 i‡(
íåyc
->
å™s_id
 >
ªb
->trans_id) {

658 
	`nova_ªbuûd_dú_time_™d_size
(
sb
, 
ªb
, 
íåy
, 
íåyc
);

659 
ªb
->
å™s_id
 = 
íåyc
->trans_id;

662  
ªt
;

663 
	}
}

665 
	$nova_ªbuûd_dú_öode_åì
(
su≥r_block
 *
sb
,

666 
nova_öode
 *
pi
, 
u64
 
pi_addr
,

667 
nova_öode_öfo_hódî
 *
sih
)

669 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

670 
nova_díåy
 *
íåy
 = 
NULL
;

671 
nova_£èâr_logíåy
 *
©å_íåy
 = 
NULL
;

672 
nova_lök_ch™ge_íåy
 *
lc_íåy
 = 
NULL
;

673 
íåy_c›y
[
NOVA_MAX_ENTRY_LEN
];

674 
nova_öode_ªbuûd
 
ªbuûd
, *
ªb
;

675 
u64
 
öo
 = 
pi
->
nova_öo
;

676 
de_Àn
;

677 
	`INIT_TIMING
(
ªbuûd_time
);

678 *
addr
, *
íåyc
;

679 
u64
 
cuº_p
;

680 
u8
 
ty≥
;

681 
ªt
;

683 
	`NOVA_START_TIMING
(
ªbuûd_dú_t
, 
ªbuûd_time
);

684 
	`nova_dbgv
("Rebuûd dú %ŒuÅªe\n", 
öo
);

686 
ªb
 = &
ªbuûd
;

687 
ªt
 = 
	`nova_ªbuûd_öode_°¨t
(
sb
, 
pi
, 
sih
, 
ªb
, 
pi_addr
);

688 i‡(
ªt
)

689 
out
;

691 
cuº_p
 = 
sih
->
log_hód
;

692 i‡(
cuº_p
 == 0) {

693 
	`nova_îr
(
sb
, "Dú %ŒuÜog i†NULL!\n", 
öo
);

694 
ªt
 = -
ENOSPC
;

695 
out
;

698 
íåyc
 = (
mëad©a_csum
 =0Ë? 
NULL
 : 
íåy_c›y
;

700 
cuº_p
 !
sih
->
log_èû
) {

701 i‡(
	`gŸo_√xt_∑ge
(
sb
, 
cuº_p
)) {

702 
sih
->
log_∑ges
++;

703 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

706 i‡(
cuº_p
 == 0) {

707 
	`nova_îr
(
sb
, "Dú %ŒuÜog i†NULL!\n", 
öo
);

708 
	`BUG
();

711 
addr
 = (*)
	`nova_gë_block
(
sb
, 
cuº_p
);

713 i‡(
mëad©a_csum
 == 0)

714 
íåyc
 = 
addr
;

715 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
addr
, 
íåyc
))

718 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
íåyc
);

720 i‡(
sbi
->
mou¡_¢≠shŸ
) {

721 i‡(
	`nova_ícou¡î_mou¡_¢≠shŸ
(
sb
, 
addr
, 
ty≥
))

725 
ty≥
) {

726 
SET_ATTR
:

727 
©å_íåy
 = (
nova_£èâr_logíåy
 *)
íåyc
;

728 
	`nova_≠∂y_£èâr_íåy
(
sb
, 
ªb
, 
sih
, 
©å_íåy
);

729 
sih
->
œ°_£èâr
 = 
cuº_p
;

730 
cuº_p
 +(
nova_£èâr_logíåy
);

732 
LINK_CHANGE
:

733 
lc_íåy
 = (
nova_lök_ch™ge_íåy
 *)
íåyc
;

734 i‡(
lc_íåy
->
å™s_id
 >
ªb
->trans_id) {

735 
	`nova_≠∂y_lök_ch™ge_íåy
(
sb
, 
ªb
, 
lc_íåy
);

736 
ªb
->
å™s_id
 = 
lc_íåy
->trans_id;

738 
sih
->
œ°_lök_ch™ge
 = 
cuº_p
;

739 
cuº_p
 +(
nova_lök_ch™ge_íåy
);

741 
DIR_LOG
:

742 
íåy
 = (
nova_díåy
 *)
addr
;

743 
ªt
 = 
	`nova_ªbuûd_h™dÀ_díåy
(
sb
, 
sih
, 
ªb
,

744 
íåy
, 
	`DENTRY
(
íåyc
), 
cuº_p
);

745 i‡(
ªt
)

746 
out
;

747 
de_Àn
 = 
	`À16_to_˝u
(
	`DENTRY
(
íåyc
)->de_len);

748 
cuº_p
 +
de_Àn
;

751 
	`nova_dbg
("%s: unknownÅype %d, 0x%llx\n",

752 
__func__
, 
ty≥
, 
cuº_p
);

753 
	`NOVA_ASSERT
(0);

758 
ªt
 = 
	`nova_ªbuûd_öode_föish
(
sb
, 
pi
, 
sih
, 
ªb
, 
cuº_p
);

759 
sih
->
i_blocks
 = sih->
log_∑ges
;

761 
out
:

763 
	`NOVA_END_TIMING
(
ªbuûd_dú_t
, 
ªbuûd_time
);

764  
ªt
;

765 
	}
}

768 
	$nova_ªbuûd_öode
(
su≥r_block
 *
sb
, 
nova_öode_öfo
 *
si
,

769 
u64
 
öo
, u64 
pi_addr
, 
ªbuûd_dú
)

771 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

772 
nova_öode
 *
pi
;

773 
nova_öode
 
öode_c›y
;

774 
u64
 
Æãr_pi_addr
 = 0;

775 
ªt
;

777 i‡(
mëad©a_csum
) {

779 
ªt
 = 
	`nova_gë_Æãr_öode_addªss
(
sb
, 
öo
, &
Æãr_pi_addr
);

780 i‡(
ªt
) {

781 
	`nova_dbg
("%s: failedált inoáddr for inode %llu\n",

782 
__func__
, 
öo
);

783  
ªt
;

787 
ªt
 = 
	`nova_check_öode_öãgrôy
(
sb
, 
öo
, 
pi_addr
, 
Æãr_pi_addr
,

788 &
öode_c›y
, 1);

790 i‡(
ªt
)

791  
ªt
;

793 
pi
 = (
nova_öode
 *)
	`nova_gë_block
(
sb
, 
pi_addr
);

796 
	`nova_öô_hódî
(
sb
, 
sih
, 
	`__À16_to_˝u
(
pi
->
i_mode
));

797 
sih
->
pi_addr
 =Öi_addr;

799 i‡(
pi
->
dñëed
 == 1) {

800 
	`nova_dbg
("%s: inodê%Œu ha†bì¿dñëed.\n", 
__func__
, 
öo
);

801  -
ESTALE
;

804 
	`nova_dbgv
("%s: inode %llu,áddr 0x%llx, valid %d, head 0x%llx,Åail 0x%llx\n",

805 
__func__
, 
öo
, 
pi_addr
, 
pi
->
vÆid
,

806 
pi
->
log_hód
,Öi->
log_èû
);

808 
sih
->
öo
 = ino;

809 
sih
->
Æãr_pi_addr
 =álter_pi_addr;

811 
	`__À16_to_˝u
(
pi
->
i_mode
Ë& 
S_IFMT
) {

812 
S_IFLNK
:

815 
S_IFREG
:

816 
	`nova_ªbuûd_fûe_öode_åì
(
sb
, 
pi
, 
pi_addr
, 
sih
);

818 
S_IFDIR
:

819 i‡(
ªbuûd_dú
)

820 
	`nova_ªbuûd_dú_öode_åì
(
sb
, 
pi
, 
pi_addr
, 
sih
);

824 i‡(
pi
->
log_hód
)

825 
	`nova_ªbuûd_fûe_öode_åì
(
sb
, 
pi
, 
pi_addr
, 
sih
);

826 
sih
->
pi_addr
 =Öi_addr;

831 
	}
}

837 
	$nova_ª°‹e_¢≠shŸ_èbÀ
(
su≥r_block
 *
sb
, 
ju°_öô
)

839 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

840 
nova_¢≠shŸ_öfo_íåy
 *
íåy
 = 
NULL
;

841 
nova_öode
 *
pi
;

842 
nova_öode_öfo_hódî
 *
sih
;

843 
nova_öode_ªbuûd
 
ªbuûd
, *
ªb
;

844 
d©a_bôs
;

845 
íåy_c›y
[
NOVA_MAX_ENTRY_LEN
];

846 
size_t
 
size
 = (
nova_¢≠shŸ_öfo_íåy
);

847 
u64
 
öo
 = 
NOVA_SNAPSHOT_INO
;

848 
	`INIT_TIMING
(
ªbuûd_time
);

849 
cou¡
 = 0;

850 *
addr
, *
íåyc
;

851 
u64
 
cuº_p
;

852 
u8
 
ty≥
;

853 
ªt
;

855 
	`NOVA_START_TIMING
(
ªbuûd_¢≠shŸ_t
, 
ªbuûd_time
);

856 
	`nova_dbg_vîbo£
("Rebuild snapshotÅable\n");

858 
íåyc
 = (
mëad©a_csum
 =0Ë? 
NULL
 : 
íåy_c›y
;

860 
pi
 = 
	`nova_gë_ª£rved_öode
(
sb
, 
öo
);

861 
sih
 = &
sbi
->
¢≠shŸ_si
->
hódî
;

862 
d©a_bôs
 = 
blk_ty≥_to_shi·
[
sih
->
i_blk_ty≥
];

863 
ªb
 = &
ªbuûd
;

864 
ªt
 = 
	`nova_ªbuûd_öode_°¨t
(
sb
, 
pi
, 
sih
, 
ªb
, sih->
pi_addr
);

865 i‡(
ªt
)

866 
out
;

868 
cuº_p
 = 
sih
->
log_hód
;

869 i‡(
cuº_p
 =0 && 
sih
->
log_èû
 == 0)

870 
out
;

874 
cuº_p
 !
sih
->
log_èû
) {

875 i‡(
	`gŸo_√xt_∑ge
(
sb
, 
cuº_p
)) {

876 
sih
->
log_∑ges
++;

877 
cuº_p
 = 
	`√xt_log_∑ge
(
sb
, curr_p);

880 i‡(
cuº_p
 == 0) {

881 
	`nova_îr
(
sb
, "Fûêöodê%ŒuÜog i†NULL!\n", 
öo
);

882 
	`BUG
();

885 
addr
 = (*)
	`nova_gë_block
(
sb
, 
cuº_p
);

887 i‡(
mëad©a_csum
 == 0)

888 
íåyc
 = 
addr
;

889 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
addr
, 
íåyc
))

892 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
íåyc
);

894 
ty≥
) {

895 
SNAPSHOT_INFO
:

896 
íåy
 = (
nova_¢≠shŸ_öfo_íåy
 *)
addr
;

897 
ªt
 = 
	`nova_ª°‹e_¢≠shŸ_íåy
(
sb
, 
íåy
,

898 
cuº_p
, 
ju°_öô
);

899 i‡(
ªt
) {

900 
	`nova_îr
(
sb
, "RestoreÉntry %llu failed\n",

901 
íåy
->
ïoch_id
);

902 
out
;

904 i‡(
	`SNENTRY
(
íåyc
)->
dñëed
 == 0)

905 
cou¡
++;

906 
cuº_p
 +
size
;

909 
	`nova_îr
(
sb
, "unknow¿ty≥ %d, 0x%Œx\n", 
ty≥
, 
cuº_p
);

910 
	`NOVA_ASSERT
(0);

911 
cuº_p
 +
size
;

917 
ªt
 = 
	`nova_ªbuûd_öode_föish
(
sb
, 
pi
, 
sih
, 
ªb
, 
cuº_p
);

918 
sih
->
i_blocks
 = sih->
log_∑ges
 + (sih->
i_size
 >> 
d©a_bôs
);

920 
out
:

922 
	`NOVA_END_TIMING
(
ªbuûd_¢≠shŸ_t
, 
ªbuûd_time
);

924 
	`nova_dbg
("Recovered %d snapshots,ÜatestÉpoch ID %llu\n",

925 
cou¡
, 
sbi
->
s_ïoch_id
);

927  
ªt
;

928 
	}
}

	@snapshot.c

21 
	~"nova.h
"

22 
	~"öode.h
"

23 
	~"su≥r.h
"

25 
ölöe
 
u64
 
	$√xt_li°_∑ge
(
u64
 
cuº_p
)

27 *
cuº_addr
 = (*)
cuº_p
;

28 
∑ge_èû
 = (()
cuº_addr
 & ~
PAGE_OFFSET_MASK
)

29 + 
LOG_BLOCK_TAIL
;

30  ((
nova_öode_∑ge_èû
 *)
∑ge_èû
)->
√xt_∑ge
;

31 
	}
}

33 
ölöe
 
boﬁ
 
	$gŸo_√xt_li°_∑ge
(
su≥r_block
 *
sb
, 
u64
 
cuº_p
)

35 *
addr
;

36 
u8
 
ty≥
;

39 i‡(
	`ENTRY_LOC
(
cuº_p
Ë+ 32 > 
LOG_BLOCK_TAIL
)

40  
åue
;

42 
addr
 = (*)
cuº_p
;

43 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
addr
);

44 i‡(
ty≥
 =
NEXT_PAGE
)

45  
åue
;

47  
Ál£
;

48 
	}
}

50 
	$nova_föd_èrgë_¢≠shŸ_öfo
(
su≥r_block
 *
sb
,

51 
u64
 
ïoch_id
, 
¢≠shŸ_öfo
 **
ªt_öfo
)

53 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

54 
¢≠shŸ_öfo
 *
öfos
[1];

55 
ƒ_öfos
;

56 
ªt
 = 0;

58 
ƒ_öfos
 = 
	`ødix_åì_g™g_lookup
(&
sbi
->
¢≠shŸ_öfo_åì
,

59 (**)
öfos
, 
ïoch_id
, 1);

60 i‡(
ƒ_öfos
 == 1) {

61 *
ªt_öfo
 = 
öfos
[0];

62 
ªt
 = 1;

65  
ªt
;

66 
	}
}

68 
¢≠shŸ_öfo
 *

69 
	$nova_föd_√xt_¢≠shŸ_öfo
(
su≥r_block
 *
sb
, 
¢≠shŸ_öfo
 *
öfo
)

71 
¢≠shŸ_öfo
 *
ªt_öfo
 = 
NULL
;

72 
ªt
;

74 
ªt
 = 
	`nova_föd_èrgë_¢≠shŸ_öfo
(
sb
, 
öfo
->
ïoch_id
 + 1, &
ªt_öfo
);

76 i‡(
ªt
 =1 && 
ªt_öfo
->
ïoch_id
 <
öfo
->epoch_id) {

77 
	`nova_îr
(
sb
, "infoÉpoch id %llu,ÇextÉpoch id %llu\n",

78 
öfo
->
ïoch_id
, 
ªt_öfo
->epoch_id);

79 
ªt_öfo
 = 
NULL
;

82  
ªt_öfo
;

83 
	}
}

85 
	$nova_ö£π_¢≠shŸ_öfo
(
su≥r_block
 *
sb
,

86 
¢≠shŸ_öfo
 *
öfo
)

88 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

89 
ªt
;

91 
ªt
 = 
	`ødix_åì_ö£π
(&
sbi
->
¢≠shŸ_öfo_åì
, 
öfo
->
ïoch_id
, info);

92 i‡(
ªt
)

93 
	`nova_dbg
("%†ERROR %d\n", 
__func__
, 
ªt
);

95  
ªt
;

96 
	}
}

99 
ölöe
 
	$nova_£t_lök_∑ge_ïoch_id
(
su≥r_block
 *
sb
,

100 
nova_öode_log_∑ge
 *
cuº_∑ge
, 
u64
 
ïoch_id
)

102 
cuº_∑ge
->
∑ge_èû
.
ïoch_id
 =Époch_id;

103 
	}
}

106 
ölöe
 
	$nova_£t_√xt_lök_∑ge_addªss
(
su≥r_block
 *
sb
,

107 
nova_öode_log_∑ge
 *
cuº_∑ge
, 
u64
 
√xt_∑ge
)

109 
cuº_∑ge
->
∑ge_èû
.
√xt_∑ge
 =Çext_page;

110 
	}
}

112 
	$nova_dñëe_¢≠shŸ_li°_íåõs
(
su≥r_block
 *
sb
,

113 
¢≠shŸ_li°
 *
li°
)

115 
¢≠shŸ_fûe_wrôe_íåy
 *
w_íåy
 = 
NULL
;

116 
¢≠shŸ_öode_íåy
 *
i_íåy
 = 
NULL
;

117 
nova_öode_öfo_hódî
 
sih
;

118 *
addr
;

119 
u64
 
cuº_p
;

120 
u8
 
ty≥
;

122 
sih
.
öo
 = 
NOVA_SNAPSHOT_INO
;

123 
sih
.
i_blk_ty≥
 = 
NOVA_DEFAULT_BLOCK_TYPE
;

124 
sih
.
log_hód
 = sih.
log_èû
 = 0;

126 
cuº_p
 = 
li°
->
hód
;

127 
	`nova_dbg_vîbo£
("SnapshotÜist head 0x%llx,Åail 0x%lx\n",

128 
cuº_p
, 
li°
->
èû
);

129 i‡(
cuº_p
 =0 && 
li°
->
èû
 == 0)

132 
cuº_p
 !
li°
->
èû
) {

133 i‡(
	`gŸo_√xt_li°_∑ge
(
sb
, 
cuº_p
)) {

134 
cuº_p
 = 
	`√xt_li°_∑ge
(curr_p);

135 i‡(
cuº_p
 =
li°
->
èû
)

139 i‡(
cuº_p
 == 0) {

140 
	`nova_îr
(
sb
, "SnapshotÜist is NULL!\n");

141 
	`BUG
();

144 
addr
 = (*)
cuº_p
;

145 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
addr
);

147 
ty≥
) {

148 
SS_INODE
:

149 
i_íåy
 = (
¢≠shŸ_öode_íåy
 *)
addr
;

150 i‡(
i_íåy
->
dñëed
 == 0)

151 
	`nova_dñëe_dód_öode
(
sb
, 
i_íåy
->
nova_öo
);

152 
cuº_p
 +(
¢≠shŸ_öode_íåy
);

154 
SS_FILE_WRITE
:

155 
w_íåy
 = (
¢≠shŸ_fûe_wrôe_íåy
 *)
addr
;

156 i‡(
w_íåy
->
dñëed
 == 0)

157 
	`nova_‰ì_d©a_blocks
(
sb
, &
sih
, 
w_íåy
->
nvmm
,

158 
w_íåy
->
num_∑ges
);

159 
cuº_p
 +(
¢≠shŸ_fûe_wrôe_íåy
);

162 
	`nova_îr
(
sb
, "unknownÅype %d, 0x%llx,Åail 0x%llx\n",

163 
ty≥
, 
cuº_p
, 
li°
->
èû
);

164 
	`NOVA_ASSERT
(0);

165 
cuº_p
 +(
¢≠shŸ_fûe_wrôe_íåy
);

171 
	}
}

173 
ölöe
 
	$nova_background_˛ón_öode_íåy
(
su≥r_block
 *
sb
,

174 
¢≠shŸ_öode_íåy
 *
i_íåy
, 
u64
 
ïoch_id
)

176 i‡(
i_íåy
->
dñëed
 =0 && i_íåy->
dñëe_ïoch_id
 <
ïoch_id
) {

177 
	`nova_dñëe_dód_öode
(
sb
, 
i_íåy
->
nova_öo
);

178 
i_íåy
->
dñëed
 = 1;

182 
	}
}

184 
ölöe
 
	$nova_background_˛ón_wrôe_íåy
(
su≥r_block
 *
sb
,

185 
¢≠shŸ_fûe_wrôe_íåy
 *
w_íåy
,

186 
nova_öode_öfo_hódî
 *
sih
, 
u64
 
ïoch_id
)

188 i‡(
w_íåy
->
dñëed
 =0 && w_íåy->
dñëe_ïoch_id
 <
ïoch_id
) {

189 
	`nova_‰ì_d©a_blocks
(
sb
, 
sih
, 
w_íåy
->
nvmm
,

190 
w_íåy
->
num_∑ges
);

191 
w_íåy
->
dñëed
 = 1;

195 
	}
}

197 
	$nova_background_˛ón_¢≠shŸ_li°
(
su≥r_block
 *
sb
,

198 
¢≠shŸ_li°
 *
li°
, 
u64
 
ïoch_id
)

200 
nova_öode_log_∑ge
 *
cuº_∑ge
;

201 
nova_öode_öfo_hódî
 
sih
;

202 *
addr
;

203 
u64
 
cuº_p
;

204 
u8
 
ty≥
;

206 
sih
.
öo
 = 
NOVA_SNAPSHOT_INO
;

207 
sih
.
i_blk_ty≥
 = 
NOVA_DEFAULT_BLOCK_TYPE
;

208 
sih
.
log_hód
 = sih.
log_èû
 = 0;

210 
cuº_p
 = 
li°
->
hód
;

211 
	`nova_dbg_vîbo£
("SnapshotÜist head 0x%llx,Åail 0x%lx\n",

212 
cuº_p
, 
li°
->
èû
);

213 i‡(
cuº_p
 =0 && 
li°
->
èû
 == 0)

216 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
cuº_p
;

217 
cuº_∑ge
->
∑ge_èû
.
ïoch_id
 <Époch_id &&

218 
cuº_p
 !
li°
->
èû
) {

219 i‡(
	`gŸo_√xt_li°_∑ge
(
sb
, 
cuº_p
)) {

220 
cuº_p
 = 
	`√xt_li°_∑ge
(curr_p);

221 i‡(
cuº_p
 =
li°
->
èû
)

223 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
cuº_p
;

224 i‡(
cuº_∑ge
->
∑ge_èû
.
ïoch_id
 ==Époch_id)

228 i‡(
cuº_p
 == 0) {

229 
	`nova_îr
(
sb
, "SnapshotÜist is NULL!\n");

230 
	`BUG
();

233 
addr
 = (*)
cuº_p
;

234 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
addr
);

236 
ty≥
) {

237 
SS_INODE
:

238 
	`nova_background_˛ón_öode_íåy
(
sb
, 
addr
, 
ïoch_id
);

239 
cuº_p
 +(
¢≠shŸ_öode_íåy
);

241 
SS_FILE_WRITE
:

242 
	`nova_background_˛ón_wrôe_íåy
(
sb
, 
addr
, &
sih
,

243 
ïoch_id
);

244 
cuº_p
 +(
¢≠shŸ_fûe_wrôe_íåy
);

247 
	`nova_îr
(
sb
, "unknownÅype %d, 0x%llx,Åail 0x%llx\n",

248 
ty≥
, 
cuº_p
, 
li°
->
èû
);

249 
	`NOVA_ASSERT
(0);

250 
cuº_p
 +(
¢≠shŸ_fûe_wrôe_íåy
);

256 
	}
}

258 
	$nova_dñëe_¢≠shŸ_li°_∑ges
(
su≥r_block
 *
sb
,

259 
¢≠shŸ_li°
 *
li°
)

261 
nova_öode_log_∑ge
 *
cuº_∑ge
;

262 
u64
 
cuº_block
 = 
li°
->
hód
;

263 
‰ìd
 = 0;

265 
cuº_block
) {

266 i‡(
	`ENTRY_LOC
(
cuº_block
)) {

267 
	`nova_dbg
("%s: ERROR: invalid block %llu\n",

268 
__func__
, 
cuº_block
);

271 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
cuº_block
;

272 
cuº_block
 = 
cuº_∑ge
->
∑ge_èû
.
√xt_∑ge
;

273 
	`k‰ì
(
cuº_∑ge
);

274 
‰ìd
++;

277  
‰ìd
;

278 
	}
}

280 
	$nova_dñëe_¢≠shŸ_li°
(
su≥r_block
 *
sb
,

281 
¢≠shŸ_li°
 *
li°
, 
dñëe_íåõs
)

283 i‡(
dñëe_íåõs
)

284 
	`nova_dñëe_¢≠shŸ_li°_íåõs
(
sb
, 
li°
);

285 
	`nova_dñëe_¢≠shŸ_li°_∑ges
(
sb
, 
li°
);

287 
	}
}

289 
	$nova_dñëe_¢≠shŸ_öfo
(
su≥r_block
 *
sb
,

290 
¢≠shŸ_öfo
 *
öfo
, 
dñëe_íåõs
)

292 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

293 
¢≠shŸ_li°
 *
li°
;

294 
i
;

296 
i
 = 0; i < 
sbi
->
˝us
; i++) {

297 
li°
 = &
öfo
->
li°s
[
i
];

298 
	`muãx_lock
(&
li°
->
li°_muãx
);

299 
	`nova_dñëe_¢≠shŸ_li°
(
sb
, 
li°
, 
dñëe_íåõs
);

300 
	`muãx_u∆ock
(&
li°
->
li°_muãx
);

303 
	`k‰ì
(
öfo
->
li°s
);

305 
	}
}

307 
	$nova_öôülize_¢≠shŸ_öfo_∑ges
(
su≥r_block
 *
sb
,

308 
¢≠shŸ_öfo
 *
öfo
, 
u64
 
ïoch_id
)

310 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

311 
¢≠shŸ_li°
 *
li°
;

312 
√w_∑ge
 = 0;

313 
i
;

315 
i
 = 0; i < 
sbi
->
˝us
; i++) {

316 
li°
 = &
öfo
->
li°s
[
i
];

317 
√w_∑ge
 = ()
	`kmÆloc
(
PAGE_SIZE
,

318 
GFP_KERNEL
);

320 i‡(!
√w_∑ge
 || 
	`ENTRY_LOC
(new_page)) {

321 
	`nova_dbg
("%s: faûed\n", 
__func__
);

322 
	`k‰ì
((*)
√w_∑ge
);

323  -
ENOMEM
;

326 
	`nova_£t_lök_∑ge_ïoch_id
(
sb
, (*)
√w_∑ge
, 
ïoch_id
);

327 
	`nova_£t_√xt_lök_∑ge_addªss
(
sb
, (*)
√w_∑ge
, 0);

328 
li°
->
èû
 =Üi°->
hód
 = 
√w_∑ge
;

329 
li°
->
num_∑ges
 = 1;

333 
	}
}

335 
	$nova_öôülize_¢≠shŸ_öfo
(
su≥r_block
 *
sb
,

336 
¢≠shŸ_öfo
 **
ªt_öfo
, 
öô_∑ges
, 
u64
 
ïoch_id
)

338 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

339 
¢≠shŸ_öfo
 *
öfo
;

340 
¢≠shŸ_li°
 *
li°
;

341 
i
;

342 
ªt
;

343 
	`INIT_TIMING
(
öô_¢≠shŸ_time
);

345 
	`NOVA_START_TIMING
(
öô_¢≠shŸ_öfo_t
, 
öô_¢≠shŸ_time
);

347 
öfo
 = 
	`nova_Æloc_¢≠shŸ_öfo
(
sb
);

348 i‡(!
öfo
) {

349 
ªt
 = -
ENOMEM
;

350 
out
;

353 
öfo
->
li°s
 = 
	`kzÆloc
(
sbi
->
˝us
 * (
¢≠shŸ_li°
),

354 
GFP_KERNEL
);

356 i‡(!
öfo
->
li°s
) {

357 
	`nova_‰ì_¢≠shŸ_öfo
(
öfo
);

358 
ªt
 = -
ENOMEM
;

359 
Áû
;

362 
i
 = 0; i < 
sbi
->
˝us
; i++) {

363 
li°
 = &
öfo
->
li°s
[
i
];

364 
	`muãx_öô
(&
li°
->
li°_muãx
);

367 i‡(
öô_∑ges
) {

368 
ªt
 = 
	`nova_öôülize_¢≠shŸ_öfo_∑ges
(
sb
, 
öfo
, 
ïoch_id
);

369 i‡(
ªt
)

370 
Áû
;

373 *
ªt_öfo
 = 
öfo
;

374 
out
:

375 
	`NOVA_END_TIMING
(
öô_¢≠shŸ_öfo_t
, 
öô_¢≠shŸ_time
);

376  
ªt
;

378 
Áû
:

379 
i
 = 0; i < 
sbi
->
˝us
; i++) {

380 
li°
 = &
öfo
->
li°s
[
i
];

381 i‡(
li°
->
hód
)

382 
	`k‰ì
((*)
li°
->
hód
);

385 
	`k‰ì
(
öfo
->
li°s
);

386 
	`nova_‰ì_¢≠shŸ_öfo
(
öfo
);

388 *
ªt_öfo
 = 
NULL
;

389 
out
;

390 
	}
}

392 
	$nova_wrôe_¢≠shŸ_li°_íåy
(
su≥r_block
 *
sb
,

393 
¢≠shŸ_li°
 *
li°
, 
u64
 
cuº_p
, *
íåy
, 
size_t
 
size
)

395 i‡(
	`is_œ°_íåy
(
cuº_p
, 
size
)) {

396 
	`nova_îr
(
sb
, "%s: writeÅoÖageÉnd? curr 0x%llx, size %lu\n",

397 
__func__
, 
cuº_p
, 
size
);

401 
	`mem˝y
((*)
cuº_p
, 
íåy
, 
size
);

402 
li°
->
èû
 = 
cuº_p
 + 
size
;

403 
	}
}

405 
	$nova_≠≥nd_¢≠shŸ_li°_íåy
(
su≥r_block
 *
sb
,

406 
¢≠shŸ_öfo
 *
öfo
, *
íåy
, 
size_t
 
size
)

408 
¢≠shŸ_li°
 *
li°
;

409 
nova_öode_log_∑ge
 *
cuº_∑ge
;

410 
u64
 
cuº_block
;

411 
˝uid
;

412 
u64
 
cuº_p
;

413 
u64
 
√w_∑ge
 = 0;

415 
˝uid
 = 
	`nova_gë_˝uid
(
sb
);

416 
li°
 = &
öfo
->
li°s
[
˝uid
];

418 
ªåy
:

419 
	`muãx_lock
(&
li°
->
li°_muãx
);

420 
cuº_p
 = 
li°
->
èû
;

422 i‡(
√w_∑ge
) {

424 
cuº_block
 = 
	`BLOCK_OFF
(
cuº_p
);

425 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
cuº_block
;

426 
	`nova_£t_√xt_lök_∑ge_addªss
(
sb
, 
cuº_∑ge
, 
√w_∑ge
);

427 
li°
->
num_∑ges
++;

430 i‡((
	`is_œ°_íåy
(
cuº_p
, 
size
Ë&& 
	`√xt_li°_∑ge
(curr_p) == 0)) {

431 
	`nova_£t_íåy_ty≥
((*)
cuº_p
, 
NEXT_PAGE
);

432 i‡(
√w_∑ge
 == 0) {

433 
	`muãx_u∆ock
(&
li°
->
li°_muãx
);

434 
√w_∑ge
 = ()
	`kmÆloc
(
PAGE_SIZE
,

435 
GFP_KERNEL
);

436 i‡(!
√w_∑ge
 || 
	`ENTRY_LOC
(new_page)) {

437 
	`k‰ì
((*)
√w_∑ge
);

438 
	`nova_îr
(
sb
, "%s:állocation failed\n",

439 
__func__
);

440  -
ENOMEM
;

442 
	`nova_£t_lök_∑ge_ïoch_id
(
sb
, (*)
√w_∑ge
,

443 
öfo
->
ïoch_id
);

444 
	`nova_£t_√xt_lök_∑ge_addªss
(
sb
,

445 (*)
√w_∑ge
, 0);

446 
ªåy
;

450 i‡(
	`is_œ°_íåy
(
cuº_p
, 
size
)) {

451 
	`nova_£t_íåy_ty≥
((*)
cuº_p
, 
NEXT_PAGE
);

452 
cuº_p
 = 
	`√xt_li°_∑ge
(curr_p);

455 
	`nova_wrôe_¢≠shŸ_li°_íåy
(
sb
, 
li°
, 
cuº_p
, 
íåy
, 
size
);

456 
	`muãx_u∆ock
(&
li°
->
li°_muãx
);

459 
	}
}

466 
	$nova_ﬁd_íåy_dñëóbÀ
(
su≥r_block
 *
sb
,

467 
u64
 
¸óã_ïoch_id
, u64 
dñëe_ïoch_id
,

468 
¢≠shŸ_öfo
 **
ªt_öfo
)

470 
¢≠shŸ_öfo
 *
öfo
 = 
NULL
;

471 
ªt
;

473 i‡(
¸óã_ïoch_id
 =
dñëe_ïoch_id
) {

478 
ªt
 = 
	`nova_föd_èrgë_¢≠shŸ_öfo
(
sb
, 
¸óã_ïoch_id
, &
öfo
);

479 i‡(
ªt
 == 0) {

484 i‡(
öfo
->
ïoch_id
 >
dñëe_ïoch_id
) {

489 *
ªt_öfo
 = 
öfo
;

491 
	}
}

493 
	$nova_≠≥nd_¢≠shŸ_fûe_wrôe_íåy
(
su≥r_block
 *
sb
,

494 
¢≠shŸ_öfo
 *
öfo
, 
u64
 
nvmm
, u64 
num_∑ges
,

495 
u64
 
dñëe_ïoch_id
)

497 
¢≠shŸ_fûe_wrôe_íåy
 
íåy
;

498 
ªt
;

499 
	`INIT_TIMING
(
≠≥nd_time
);

501 i‡(!
öfo
) {

502 
	`nova_dbg
("%s: S«pshŸ infÿnŸ found\n", 
__func__
);

503  -
EINVAL
;

506 
	`NOVA_START_TIMING
(
≠≥nd_¢≠shŸ_fûe_t
, 
≠≥nd_time
);

507 
	`nova_dbgv
("Append file writeÉntry: block %llu, %lluÖages, deleteÉpoch ID %lluÅo SnapshotÉpoch ID %llu\n",

508 
nvmm
, 
num_∑ges
, 
dñëe_ïoch_id
,

509 
öfo
->
ïoch_id
);

511 
	`mem£t
(&
íåy
, 0, (
¢≠shŸ_fûe_wrôe_íåy
));

512 
íåy
.
ty≥
 = 
SS_FILE_WRITE
;

513 
íåy
.
dñëed
 = 0;

514 
íåy
.
nvmm
 =Çvmm;

515 
íåy
.
num_∑ges
 =Çum_pages;

516 
íåy
.
dñëe_ïoch_id
 = delete_epoch_id;

518 
ªt
 = 
	`nova_≠≥nd_¢≠shŸ_li°_íåy
(
sb
, 
öfo
, &
íåy
,

519 (
¢≠shŸ_fûe_wrôe_íåy
));

521 
	`NOVA_END_TIMING
(
≠≥nd_¢≠shŸ_fûe_t
, 
≠≥nd_time
);

522  
ªt
;

523 
	}
}

526 
	$nova_≠≥nd_d©a_to_¢≠shŸ
(
su≥r_block
 *
sb
,

527 
nova_fûe_wrôe_íåy
 *
íåy
, 
u64
 
nvmm
, u64 
num_∑ges
,

528 
u64
 
dñëe_ïoch_id
)

530 
¢≠shŸ_öfo
 *
öfo
 = 
NULL
;

531 
ªt
;

533 
ªt
 = 
	`nova_ﬁd_íåy_dñëóbÀ
(
sb
, 
íåy
->
ïoch_id
,

534 
dñëe_ïoch_id
, &
öfo
);

535 i‡(
ªt
 == 0)

536 
	`nova_≠≥nd_¢≠shŸ_fûe_wrôe_íåy
(
sb
, 
öfo
, 
nvmm
,

537 
num_∑ges
, 
dñëe_ïoch_id
);

539  
ªt
;

540 
	}
}

542 
	$nova_≠≥nd_¢≠shŸ_öode_íåy
(
su≥r_block
 *
sb
,

543 
nova_öode
 *
pi
, 
¢≠shŸ_öfo
 *
öfo
)

545 
¢≠shŸ_öode_íåy
 
íåy
;

546 
ªt
;

547 
	`INIT_TIMING
(
≠≥nd_time
);

549 i‡(!
öfo
) {

550 
	`nova_dbg
("%s: S«pshŸ infÿnŸ found\n", 
__func__
);

551  -
EINVAL
;

554 
	`NOVA_START_TIMING
(
≠≥nd_¢≠shŸ_öode_t
, 
≠≥nd_time
);

555 
	`nova_dbgv
("Append inodeÉntry: inode %llu, deleteÉpoch ID %lluÅo SnapshotÉpoch ID %llu\n",

556 
pi
->
nova_öo
,Öi->
dñëe_ïoch_id
,

557 
öfo
->
ïoch_id
);

559 
	`mem£t
(&
íåy
, 0, (
¢≠shŸ_öode_íåy
));

560 
íåy
.
ty≥
 = 
SS_INODE
;

561 
íåy
.
dñëed
 = 0;

562 
íåy
.
nova_öo
 = 
pi
->nova_ino;

563 
íåy
.
dñëe_ïoch_id
 = 
pi
->delete_epoch_id;

565 
ªt
 = 
	`nova_≠≥nd_¢≠shŸ_li°_íåy
(
sb
, 
öfo
, &
íåy
,

566 (
¢≠shŸ_öode_íåy
));

568 
	`NOVA_END_TIMING
(
≠≥nd_¢≠shŸ_öode_t
, 
≠≥nd_time
);

569  
ªt
;

570 
	}
}

572 
	$nova_≠≥nd_öode_to_¢≠shŸ
(
su≥r_block
 *
sb
,

573 
nova_öode
 *
pi
)

575 
¢≠shŸ_öfo
 *
öfo
 = 
NULL
;

576 
ªt
;

578 
ªt
 = 
	`nova_ﬁd_íåy_dñëóbÀ
(
sb
, 
pi
->
¸óã_ïoch_id
,

579 
pi
->
dñëe_ïoch_id
, &
öfo
);

580 i‡(
ªt
 == 0)

581 
	`nova_≠≥nd_¢≠shŸ_öode_íåy
(
sb
, 
pi
, 
öfo
);

583  
ªt
;

584 
	}
}

586 
	$nova_ícou¡î_mou¡_¢≠shŸ
(
su≥r_block
 *
sb
, *
addr
,

587 
u8
 
ty≥
)

589 
nova_díåy
 *
díåy
;

590 
nova_£èâr_logíåy
 *
©å_íåy
;

591 
nova_lök_ch™ge_íåy
 *
lökc_íåy
;

592 
nova_fûe_wrôe_íåy
 *
fw_íåy
;

593 
nova_mm≠_íåy
 *
mm≠_íåy
;

594 
ªt
 = 0;

596 
ty≥
) {

597 
SET_ATTR
:

598 
©å_íåy
 = (
nova_£èâr_logíåy
 *)
addr
;

599 i‡(
	`∑ss_mou¡_¢≠shŸ
(
sb
, 
©å_íåy
->
ïoch_id
))

600 
ªt
 = 1;

602 
LINK_CHANGE
:

603 
lökc_íåy
 = (
nova_lök_ch™ge_íåy
 *)
addr
;

604 i‡(
	`∑ss_mou¡_¢≠shŸ
(
sb
, 
lökc_íåy
->
ïoch_id
))

605 
ªt
 = 1;

607 
DIR_LOG
:

608 
díåy
 = (
nova_díåy
 *)
addr
;

609 i‡(
	`∑ss_mou¡_¢≠shŸ
(
sb
, 
díåy
->
ïoch_id
))

610 
ªt
 = 1;

612 
FILE_WRITE
:

613 
fw_íåy
 = (
nova_fûe_wrôe_íåy
 *)
addr
;

614 i‡(
	`∑ss_mou¡_¢≠shŸ
(
sb
, 
fw_íåy
->
ïoch_id
))

615 
ªt
 = 1;

617 
MMAP_WRITE
:

618 
mm≠_íåy
 = (
nova_mm≠_íåy
 *)
addr
;

619 i‡(
	`∑ss_mou¡_¢≠shŸ
(
sb
, 
mm≠_íåy
->
ïoch_id
))

620 
ªt
 = 1;

626  
ªt
;

627 
	}
}

629 
	$nova_c›y_¢≠shŸ_li°_to_døm
(
su≥r_block
 *
sb
,

630 
¢≠shŸ_li°
 *
li°
, 
¢≠shŸ_nvmm_li°
 *
nvmm_li°
)

632 
nova_öode_log_∑ge
 *
døm_∑ge
;

633 *
cuº_nvmm_addr
;

634 
u64
 
cuº_nvmm_block
;

635 
u64
 
¥ev_døm_addr
;

636 
u64
 
cuº_døm_addr
;

637 
i
;

638 
ªt
 = 0;

640 
cuº_døm_addr
 = 
li°
->
hód
;

641 
¥ev_døm_addr
 = 
li°
->
hód
;

642 
cuº_nvmm_block
 = 
nvmm_li°
->
hód
;

643 
cuº_nvmm_addr
 = 
	`nova_gë_block
(
sb
, 
cuº_nvmm_block
);

645 
i
 = 0; i < 
nvmm_li°
->
num_∑ges
; i++) {

647 i‡(
	`mem˝y
((*)
cuº_døm_addr
, 
cuº_nvmm_addr
,

648 
LOG_BLOCK_TAIL
Ë=
NULL
)

649 
ªt
 = -1;

651 i‡(
ªt
 < 0) {

652 
	`nova_dbg
("%s: CopyÇvmmÖage %lu failed\n",

653 
__func__
, 
i
);

657 
døm_∑ge
 = (
nova_öode_log_∑ge
 *)
cuº_døm_addr
;

658 
¥ev_døm_addr
 = 
cuº_døm_addr
;

659 
cuº_nvmm_block
 = 
	`√xt_log_∑ge
(
sb
, curr_nvmm_block);

660 i‡(
cuº_nvmm_block
 < 0)

662 
cuº_nvmm_addr
 = 
	`nova_gë_block
(
sb
, 
cuº_nvmm_block
);

663 
cuº_døm_addr
 = 
døm_∑ge
->
∑ge_èû
.
√xt_∑ge
;

666 
li°
->
num_∑ges
 = 
nvmm_li°
->num_pages;

667 
li°
->
èû
 = 
¥ev_døm_addr
 + 
	`ENTRY_LOC
(
nvmm_li°
->tail);

670 
	}
}

672 
	$nova_Æloˇã_¢≠shŸ_li°_∑ges
(
su≥r_block
 *
sb
,

673 
¢≠shŸ_li°
 *
li°
, 
¢≠shŸ_nvmm_li°
 *
nvmm_li°
,

674 
u64
 
ïoch_id
)

676 
¥ev_∑ge
 = 0;

677 
√w_∑ge
 = 0;

678 
i
;

680 
i
 = 0; i < 
nvmm_li°
->
num_∑ges
; i++) {

681 
√w_∑ge
 = ()
	`kmÆloc
(
PAGE_SIZE
,

682 
GFP_KERNEL
);

684 i‡(!
√w_∑ge
) {

685 
	`nova_dbg
("%s ERROR: failÅoállocateÜistÖages\n",

686 
__func__
);

687 
Áû
;

690 
	`nova_£t_lök_∑ge_ïoch_id
(
sb
, (*)
√w_∑ge
, 
ïoch_id
);

691 
	`nova_£t_√xt_lök_∑ge_addªss
(
sb
, (*)
√w_∑ge
, 0);

693 i‡(
i
 == 0)

694 
li°
->
hód
 = 
√w_∑ge
;

696 i‡(
¥ev_∑ge
)

697 
	`nova_£t_√xt_lök_∑ge_addªss
(
sb
, (*)
¥ev_∑ge
,

698 
√w_∑ge
);

699 
¥ev_∑ge
 = 
√w_∑ge
;

704 
Áû
:

705 
	`nova_dñëe_¢≠shŸ_li°_∑ges
(
sb
, 
li°
);

706  -
ENOMEM
;

707 
	}
}

709 
	$nova_ª°‹e_¢≠shŸ_öfo_li°s
(
su≥r_block
 *
sb
,

710 
¢≠shŸ_öfo
 *
öfo
, 
nova_¢≠shŸ_öfo_íåy
 *
íåy
,

711 
u64
 
ïoch_id
)

713 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

714 
¢≠shŸ_nvmm_∑ge
 *
nvmm_∑ge
;

715 
¢≠shŸ_li°
 *
li°
;

716 
¢≠shŸ_nvmm_li°
 *
nvmm_li°
;

717 
i
;

718 
ªt
;

720 
nvmm_∑ge
 = (
¢≠shŸ_nvmm_∑ge
 *)
	`nova_gë_block
(
sb
,

721 
íåy
->
nvmm_∑ge_addr
);

723 
i
 = 0; i < 
sbi
->
˝us
; i++) {

724 
li°
 = &
öfo
->
li°s
[
i
];

725 
nvmm_li°
 = &
nvmm_∑ge
->
li°s
[
i
];

726 i‡(!
li°
 || !
nvmm_li°
) {

727 
	`nova_dbg
("%s:Üist NULL?Üist %p,ÇvmmÜist %p\n",

728 
__func__
, 
li°
, 
nvmm_li°
);

732 
ªt
 = 
	`nova_Æloˇã_¢≠shŸ_li°_∑ges
(
sb
, 
li°
,

733 
nvmm_li°
, 
öfo
->
ïoch_id
);

734 i‡(
ªt
) {

735 
	`nova_dbg
("%†Áûuª\n", 
__func__
);

736  
ªt
;

738 
	`nova_c›y_¢≠shŸ_li°_to_døm
(
sb
, 
li°
, 
nvmm_li°
);

742 
	}
}

744 
	$nova_ª°‹e_¢≠shŸ_öfo
(
su≥r_block
 *
sb
,

745 
nova_¢≠shŸ_öfo_íåy
 *
íåy
, 
u64
 
ïoch_id
,

746 
u64
 
time°amp
, u64 
cuº_p
, 
ju°_öô
)

748 
¢≠shŸ_öfo
 *
öfo
 = 
NULL
;

749 
ªt
 = 0;

751 
	`nova_dbg
("Re°‹ê¢≠shŸÉpoch ID %Œu\n", 
ïoch_id
);

754 
ªt
 = 
	`nova_öôülize_¢≠shŸ_öfo
(
sb
, &
öfo
, 
ju°_öô
, 
ïoch_id
);

755 i‡(
ªt
) {

756 
	`nova_dbg
("%s: initialize snapshot info failed %d\n",

757 
__func__
, 
ªt
);

758 
Áû
;

761 
öfo
->
ïoch_id
 =Époch_id;

762 
öfo
->
time°amp
 =Åimestamp;

763 
öfo
->
¢≠shŸ_íåy
 = 
cuº_p
;

765 i‡(
ju°_öô
 == 0) {

766 
ªt
 = 
	`nova_ª°‹e_¢≠shŸ_öfo_li°s
(
sb
, 
öfo
,

767 
íåy
, 
ïoch_id
);

768 i‡(
ªt
)

769 
Áû
;

772 
ªt
 = 
	`nova_ö£π_¢≠shŸ_öfo
(
sb
, 
öfo
);

773  
ªt
;

775 
Áû
:

776 
	`nova_dñëe_¢≠shŸ_öfo
(
sb
, 
öfo
, 0);

777  
ªt
;

778 
	}
}

780 
	$nova_mou¡_¢≠shŸ
(
su≥r_block
 *
sb
)

782 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

783 
u64
 
ïoch_id
;

785 
ïoch_id
 = 
sbi
->
mou¡_¢≠shŸ_ïoch_id
;

786 
	`nova_dbg
("Mou¡ s«pshŸ %Œu\n", 
ïoch_id
);

788 
	}
}

790 
	$nova_‰ì_nvmm_∑ge
(
su≥r_block
 *
sb
,

791 
u64
 
nvmm_∑ge_addr
)

793 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

794 
¢≠shŸ_nvmm_∑ge
 *
nvmm_∑ge
;

795 
¢≠shŸ_nvmm_li°
 *
nvmm_li°
;

796 
nova_öode_öfo_hódî
 
sih
;

797 
nvmm_blockƒ
;

798 
i
;

800 i‡(
nvmm_∑ge_addr
 == 0)

803 
sih
.
öo
 = 
NOVA_SNAPSHOT_INO
;

804 
sih
.
i_blk_ty≥
 = 
NOVA_DEFAULT_BLOCK_TYPE
;

806 
nvmm_∑ge
 = (
¢≠shŸ_nvmm_∑ge
 *)
	`nova_gë_block
(
sb
,

807 
nvmm_∑ge_addr
);

809 
i
 = 0; i < 
sbi
->
˝us
; i++) {

810 
nvmm_li°
 = &
nvmm_∑ge
->
li°s
[
i
];

811 
sih
.
log_hód
 = 
nvmm_li°
->
hód
;

812 
sih
.
log_èû
 = 
nvmm_li°
->
èû
;

813 
sih
.
Æãr_log_hód
 = sih.
Æãr_log_èû
 = 0;

814 
	`nova_‰ì_öode_log
(
sb
, 
NULL
, &
sih
);

817 
nvmm_blockƒ
 = 
	`nova_gë_blockƒ
(
sb
, 
nvmm_∑ge_addr
, 0);

818 
	`nova_‰ì_log_blocks
(
sb
, &
sih
, 
nvmm_blockƒ
, 1);

820 
	}
}

822 
	$nova_£t_nvmm_∑ge_addr
(
su≥r_block
 *
sb
,

823 
nova_¢≠shŸ_öfo_íåy
 *
íåy
, 
u64
 
nvmm_∑ge_addr
)

825 
úq_Êags
 = 0;

826 
	`nova_memu∆ock_ønge
(
sb
, 
íåy
, 
CACHELINE_SIZE
, &
úq_Êags
);

827 
íåy
->
nvmm_∑ge_addr
 =Çvmm_page_addr;

828 
	`nova_upd©e_íåy_csum
(
íåy
);

829 
	`nova_upd©e_Æãr_íåy
(
sb
, 
íåy
);

830 
	`nova_memlock_ønge
(
sb
, 
íåy
, 
CACHELINE_SIZE
, &
úq_Êags
);

833 
	}
}

835 
	$nova_˛ór_nvmm_∑ge
(
su≥r_block
 *
sb
,

836 
nova_¢≠shŸ_öfo_íåy
 *
íåy
, 
ju°_öô
)

838 i‡(
ju°_öô
)

840 
out
;

842 
	`nova_‰ì_nvmm_∑ge
(
sb
, 
íåy
->
nvmm_∑ge_addr
);

844 
out
:

845 
	`nova_£t_nvmm_∑ge_addr
(
sb
, 
íåy
, 0);

847 
	}
}

849 
	$nova_ª°‹e_¢≠shŸ_íåy
(
su≥r_block
 *
sb
,

850 
nova_¢≠shŸ_öfo_íåy
 *
íåy
, 
u64
 
cuº_p
, 
ju°_öô
)

852 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

853 
u64
 
ïoch_id
, 
time°amp
;

854 
ªt
 = 0;

856 i‡(
íåy
->
dñëed
 == 1)

857 
out
;

859 
ïoch_id
 = 
íåy
->epoch_id;

860 
time°amp
 = 
íåy
->timestamp;

862 
ªt
 = 
	`nova_ª°‹e_¢≠shŸ_öfo
(
sb
, 
íåy
, 
ïoch_id
,

863 
time°amp
, 
cuº_p
, 
ju°_öô
);

864 i‡(
ªt
) {

865 
	`nova_dbg
("%s: Restore snapshotÉpoch ID %llu failed\n",

866 
__func__
, 
ïoch_id
);

867 
out
;

870 i‡(
ïoch_id
 > 
sbi
->
s_ïoch_id
)

871 
sbi
->
s_ïoch_id
 = 
ïoch_id
;

873 
out
:

874 
	`nova_˛ór_nvmm_∑ge
(
sb
, 
íåy
, 
ju°_öô
);

876  
ªt
;

877 
	}
}

879 
	$nova_≠≥nd_¢≠shŸ_öfo_log
(
su≥r_block
 *
sb
,

880 
¢≠shŸ_öfo
 *
öfo
, 
u64
 
ïoch_id
, u64 
time°amp
)

882 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

883 
nova_öode_öfo
 *
si
 = 
sbi
->
¢≠shŸ_si
;

884 
nova_öode
 *
pi
 = 
	`nova_gë_ª£rved_öode
(
sb
, 
NOVA_SNAPSHOT_INO
);

885 
nova_öode_upd©e
 
upd©e
;

886 
nova_¢≠shŸ_öfo_íåy
 
íåy_öfo
;

887 
ªt
;

888 
úq_Êags
 = 0;

890 
íåy_öfo
.
ty≥
 = 
SNAPSHOT_INFO
;

891 
íåy_öfo
.
dñëed
 = 0;

892 
íåy_öfo
.
nvmm_∑ge_addr
 = 0;

893 
íåy_öfo
.
ïoch_id
 =Époch_id;

894 
íåy_öfo
.
time°amp
 =Åimestamp;

896 
upd©e
.
èû
 = upd©e.
Æãr_èû
 = 0;

897 
ªt
 = 
	`nova_≠≥nd_¢≠shŸ_öfo_íåy
(
sb
, 
pi
, 
si
, 
öfo
,

898 &
íåy_öfo
, &
upd©e
);

899 i‡(
ªt
) {

900 
	`nova_dbg
("%s:áµíd s«pshŸ infÿíåy faûuª\n", 
__func__
);

901  
ªt
;

904 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

905 
	`nova_upd©e_öode
(
sb
, &
si
->
vfs_öode
, 
pi
, &
upd©e
, 1);

906 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

909 
	}
}

911 
	$nova_¸óã_¢≠shŸ
(
su≥r_block
 *
sb
)

913 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

914 
¢≠shŸ_öfo
 *
öfo
 = 
NULL
;

915 
u64
 
time°amp
 = 0;

916 
u64
 
ïoch_id
;

917 
ªt
;

918 
	`INIT_TIMING
(
¸óã_¢≠shŸ_time
);

919 
time•ec64
 
now
;

921 
	`NOVA_START_TIMING
(
¸óã_¢≠shŸ_t
, 
¸óã_¢≠shŸ_time
);

923 
	`muãx_lock
(&
sbi
->
s_lock
);

924 
sbi
->
¢≠shŸ_èkög
 = 1;

927 
ïoch_id
 = 
sbi
->
s_ïoch_id
++;

935 
	`nova_öfo
("%s:Époch id %Œu\n", 
__func__
, 
ïoch_id
);

938 
	`ktime_gë_cﬂr£_ªÆ_ts64
(&
now
);

939 
time°amp
 = 
now
.
tv_£c
;

941 
ªt
 = 
	`nova_öôülize_¢≠shŸ_öfo
(
sb
, &
öfo
, 1, 
ïoch_id
);

942 i‡(
ªt
) {

943 
	`nova_dbg
("%s: initialize snapshot info failed %d\n",

944 
__func__
, 
ªt
);

945 
	`NOVA_END_TIMING
(
¸óã_¢≠shŸ_t
, 
¸óã_¢≠shŸ_time
);

946 
out
;

949 
öfo
->
ïoch_id
 =Époch_id;

950 
öfo
->
time°amp
 =Åimestamp;

952 
ªt
 = 
	`nova_≠≥nd_¢≠shŸ_öfo_log
(
sb
, 
öfo
, 
ïoch_id
, 
time°amp
);

953 i‡(
ªt
) {

954 
	`nova_‰ì_¢≠shŸ_öfo
(
öfo
);

955 
	`NOVA_END_TIMING
(
¸óã_¢≠shŸ_t
, 
¸óã_¢≠shŸ_time
);

956 
out
;

959 
sbi
->
num_¢≠shŸs
++;

961 
ªt
 = 
	`nova_ö£π_¢≠shŸ_öfo
(
sb
, 
öfo
);

963 
	`nova_£t_vmas_ªad⁄ly
(
sb
);

965 
sbi
->
nova_sb
->
s_wtime
 = 
	`˝u_to_À32
(
	`ktime_gë_£c⁄ds
());

966 
sbi
->
nova_sb
->
s_ïoch_id
 = 
	`˝u_to_À64
(
ïoch_id
);

967 
	`nova_upd©e_su≥r_¸c
(
sb
);

969 
	`nova_sync_su≥r
(
sb
);

971 
out
:

972 
sbi
->
¢≠shŸ_èkög
 = 0;

973 
	`muãx_u∆ock
(&
sbi
->
s_lock
);

974 
	`wake_up_öãºu±ibÀ
(&
sbi
->
¢≠shŸ_mm≠_waô
);

976 
	`NOVA_END_TIMING
(
¸óã_¢≠shŸ_t
, 
¸óã_¢≠shŸ_time
);

977  
ªt
;

978 
	}
}

980 
	$wakeup_¢≠shŸ_˛ó√r
(
nova_sb_öfo
 *
sbi
)

982 i‡(!
	`waôqueue_a˘ive
(&
sbi
->
¢≠shŸ_˛ó√r_waô
))

985 
	`nova_dbg
("Wakeup snapshot cleanerÅhread\n");

986 
	`wake_up_öãºu±ibÀ
(&
sbi
->
¢≠shŸ_˛ó√r_waô
);

987 
	}
}

989 
	$nova_lök_to_√xt_¢≠shŸ
(
su≥r_block
 *
sb
,

990 
¢≠shŸ_öfo
 *
¥ev_öfo
, ¢≠shŸ_öfÿ*
√xt_öfo
)

992 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

993 
¢≠shŸ_li°
 *
¥ev_li°
, *
√xt_li°
;

994 
nova_öode_log_∑ge
 *
cuº_∑ge
;

995 
u64
 
cuº_block
, 
cuº_p
;

996 
i
;

998 
	`nova_dbg
("Link deleted snapshot %lluÅoÇext snapshot %llu\n",

999 
¥ev_öfo
->
ïoch_id
, 
√xt_öfo
->epoch_id);

1001 i‡(
¥ev_öfo
->
ïoch_id
 >
√xt_öfo
->epoch_id)

1002 
	`nova_dbg
("Error:ÖrevÉpoch ID %llu higherÅhanÇextÉpoch ID %llu\n",

1003 
¥ev_öfo
->
ïoch_id
, 
√xt_öfo
->epoch_id);

1005 
i
 = 0; i < 
sbi
->
˝us
; i++) {

1006 
¥ev_li°
 = &
¥ev_öfo
->
li°s
[
i
];

1007 
√xt_li°
 = &
√xt_öfo
->
li°s
[
i
];

1009 
	`muãx_lock
(&
¥ev_li°
->
li°_muãx
);

1010 
	`muãx_lock
(&
√xt_li°
->
li°_muãx
);

1013 
cuº_p
 = 
¥ev_li°
->
èû
;

1014 i‡(!
	`gŸo_√xt_li°_∑ge
(
sb
, 
cuº_p
))

1015 
	`nova_£t_íåy_ty≥
((*)
cuº_p
, 
NEXT_PAGE
);

1018 
cuº_block
 = 
	`BLOCK_OFF
(
¥ev_li°
->
èû
);

1019 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
cuº_block
;

1020 
	`nova_£t_√xt_lök_∑ge_addªss
(
sb
, 
cuº_∑ge
, 
√xt_li°
->
hód
);

1022 
√xt_li°
->
hód
 = 
¥ev_li°
->head;

1023 
√xt_li°
->
num_∑ges
 +
¥ev_li°
->num_pages;

1025 
	`muãx_u∆ock
(&
√xt_li°
->
li°_muãx
);

1026 
	`muãx_u∆ock
(&
¥ev_li°
->
li°_muãx
);

1029 
sbi
->
cuº_˛ón_¢≠shŸ_öfo
 = 
√xt_öfo
;

1030 
	`wakeup_¢≠shŸ_˛ó√r
(
sbi
);

1033 
	}
}

1035 
	$nova_övÆid©e_¢≠shŸ_íåy
(
su≥r_block
 *
sb
,

1036 
¢≠shŸ_öfo
 *
öfo
)

1038 
nova_¢≠shŸ_öfo_íåy
 *
íåy
;

1039 
ªt
;

1041 
íåy
 = 
	`nova_gë_block
(
sb
, 
öfo
->
¢≠shŸ_íåy
);

1042 
ªt
 = 
	`nova_övÆid©e_logíåy
(
sb
, 
íåy
, 
SNAPSHOT_INFO
, 0);

1043  
ªt
;

1044 
	}
}

1046 
	$nova_dñëe_¢≠shŸ
(
su≥r_block
 *
sb
, 
u64
 
ïoch_id
)

1048 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1049 
¢≠shŸ_öfo
 *
öfo
 = 
NULL
;

1050 
¢≠shŸ_öfo
 *
√xt
 = 
NULL
;

1051 
dñëe
 = 0;

1052 
ªt
;

1053 
	`INIT_TIMING
(
dñëe_¢≠shŸ_time
);

1055 
	`NOVA_START_TIMING
(
dñëe_¢≠shŸ_t
, 
dñëe_¢≠shŸ_time
);

1056 
	`muãx_lock
(&
sbi
->
s_lock
);

1057 
	`nova_öfo
("Dñëê¢≠shŸÉpoch ID %Œu\n", 
ïoch_id
);

1059 
ªt
 = 
	`nova_föd_èrgë_¢≠shŸ_öfo
(
sb
, 
ïoch_id
, &
öfo
);

1060 i‡(
ªt
 !1 || 
öfo
->
ïoch_id
 !=Époch_id) {

1061 
	`nova_dbg
("%s: S«pshŸ infÿnŸ found\n", 
__func__
);

1062 
	`muãx_u∆ock
(&
sbi
->
s_lock
);

1063 
	`NOVA_END_TIMING
(
dñëe_¢≠shŸ_t
, 
dñëe_¢≠shŸ_time
);

1067 
√xt
 = 
	`nova_föd_√xt_¢≠shŸ_öfo
(
sb
, 
öfo
);

1069 i‡(
√xt
) {

1070 
	`nova_lök_to_√xt_¢≠shŸ
(
sb
, 
öfo
, 
√xt
);

1073 
dñëe
 = 1;

1076 
	`ødix_åì_dñëe
(&
sbi
->
¢≠shŸ_öfo_åì
, 
ïoch_id
);

1078 
	`nova_övÆid©e_¢≠shŸ_íåy
(
sb
, 
öfo
);

1080 
sbi
->
num_¢≠shŸs
--;

1081 
	`muãx_u∆ock
(&
sbi
->
s_lock
);

1083 i‡(
dñëe
)

1084 
	`nova_dñëe_¢≠shŸ_öfo
(
sb
, 
öfo
, 1);

1086 
	`nova_‰ì_¢≠shŸ_öfo
(
öfo
);

1088 
	`NOVA_END_TIMING
(
dñëe_¢≠shŸ_t
, 
dñëe_¢≠shŸ_time
);

1090 
	}
}

1092 
	$nova_c›y_¢≠shŸ_li°_to_nvmm
(
su≥r_block
 *
sb
,

1093 
¢≠shŸ_li°
 *
li°
, 
¢≠shŸ_nvmm_li°
 *
nvmm_li°
,

1094 
u64
 
√w_block
)

1096 
nova_öode_log_∑ge
 *
døm_∑ge
;

1097 *
cuº_nvmm_addr
;

1098 
u64
 
cuº_nvmm_block
;

1099 
u64
 
¥ev_nvmm_block
;

1100 
u64
 
cuº_døm_addr
;

1101 
i
;

1102 
size_t
 
size
 = (
¢≠shŸ_nvmm_li°
);

1103 
úq_Êags
 = 0;

1105 
cuº_døm_addr
 = 
li°
->
hód
;

1106 
¥ev_nvmm_block
 = 
√w_block
;

1107 
cuº_nvmm_block
 = 
√w_block
;

1108 
cuº_nvmm_addr
 = 
	`nova_gë_block
(
sb
, 
cuº_nvmm_block
);

1110 
i
 = 0; i < 
li°
->
num_∑ges
; i++) {

1112 
	`nova_memu∆ock_block
(
sb
, 
cuº_nvmm_addr
, &
úq_Êags
);

1113 
	`mem˝y_to_pmem_noˇche
(
cuº_nvmm_addr
, (*)
cuº_døm_addr
,

1114 
LOG_BLOCK_TAIL
);

1115 
	`nova_memlock_block
(
sb
, 
cuº_nvmm_addr
, &
úq_Êags
);

1117 
døm_∑ge
 = (
nova_öode_log_∑ge
 *)
cuº_døm_addr
;

1118 
¥ev_nvmm_block
 = 
cuº_nvmm_block
;

1119 
cuº_nvmm_block
 = 
	`√xt_log_∑ge
(
sb
, curr_nvmm_block);

1120 i‡(
cuº_nvmm_block
 < 0)

1122 
cuº_nvmm_addr
 = 
	`nova_gë_block
(
sb
, 
cuº_nvmm_block
);

1123 
cuº_døm_addr
 = 
døm_∑ge
->
∑ge_èû
.
√xt_∑ge
;

1126 
	`nova_memu∆ock_ønge
(
sb
, 
nvmm_li°
, 
size
, &
úq_Êags
);

1127 
nvmm_li°
->
num_∑ges
 = 
li°
->num_pages;

1128 
nvmm_li°
->
èû
 = 
¥ev_nvmm_block
 + 
	`ENTRY_LOC
(
li°
->tail);

1129 
nvmm_li°
->
hód
 = 
√w_block
;

1130 
	`nova_memlock_ønge
(
sb
, 
nvmm_li°
, 
size
, &
úq_Êags
);

1132 
	`nova_Êush_buf„r
(
nvmm_li°
, (
¢≠shŸ_nvmm_li°
), 1);

1135 
	}
}

1137 
	$nova_ßve_¢≠shŸ_öfo
(
su≥r_block
 *
sb
,

1138 
¢≠shŸ_öfo
 *
öfo
)

1140 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1141 
nova_¢≠shŸ_öfo_íåy
 *
íåy
;

1142 
nova_öode_öfo_hódî
 
sih
;

1143 
¢≠shŸ_li°
 *
li°
;

1144 
¢≠shŸ_nvmm_∑ge
 *
nvmm_∑ge
;

1145 
¢≠shŸ_nvmm_li°
 *
nvmm_li°
;

1146 
num_∑ges
;

1147 
i
;

1148 
u64
 
nvmm_∑ge_addr
;

1149 
u64
 
√w_block
;

1150 
Æloˇãd
;

1152 
sih
.
öo
 = 
NOVA_SNAPSHOT_INO
;

1153 
sih
.
i_blk_ty≥
 = 0;

1156 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, &
sih
, 1,

1157 &
nvmm_∑ge_addr
, 
ANY_CPU
, 0);

1158 i‡(
Æloˇãd
 != 1) {

1159 
	`nova_dbg
("Errorállocating NVMM infoÖage\n");

1160  -
ENOSPC
;

1163 
nvmm_∑ge
 = (
¢≠shŸ_nvmm_∑ge
 *)
	`nova_gë_block
(
sb
,

1164 
nvmm_∑ge_addr
);

1166 
i
 = 0; i < 
sbi
->
˝us
; i++) {

1167 
li°
 = &
öfo
->
li°s
[
i
];

1168 
num_∑ges
 = 
li°
->num_pages;

1169 
Æloˇãd
 = 
	`nova_Æloˇã_öode_log_∑ges
(
sb
, &
sih
,

1170 
num_∑ges
, &
√w_block
, 
i
, 0);

1171 i‡(
Æloˇãd
 !
num_∑ges
) {

1172 
	`nova_dbg
("Eº‹ savög s«pshŸÜi°: %d\n", 
Æloˇãd
);

1173  -
ENOSPC
;

1175 
nvmm_li°
 = &
nvmm_∑ge
->
li°s
[
i
];

1176 
	`nova_c›y_¢≠shŸ_li°_to_nvmm
(
sb
, 
li°
, 
nvmm_li°
, 
√w_block
);

1179 
íåy
 = 
	`nova_gë_block
(
sb
, 
öfo
->
¢≠shŸ_íåy
);

1180 
	`nova_£t_nvmm_∑ge_addr
(
sb
, 
íåy
, 
nvmm_∑ge_addr
);

1183 
	}
}

1185 
	$nova_¥öt_¢≠shŸ_öfo
(
¢≠shŸ_öfo
 *
öfo
,

1186 
£q_fûe
 *
£q
)

1188 
tm
Åm;

1189 
u64
 
ïoch_id
;

1190 
u64
 
time°amp
;

1191 
loˇl_time
;

1193 
ïoch_id
 = 
öfo
->epoch_id;

1194 
time°amp
 = 
öfo
->timestamp;

1196 
loˇl_time
 = 
time°amp
 - 
sys_tz
.
tz_möuãswe°
 * 60;

1197 
	`time64_to_tm
(
loˇl_time
, 0, &
tm
);

1198 
	`£q_¥ötf
(
£q
, "%8llu\t%4lu-%02d-%02d\t%02d:%02d:%02d\n",

1199 
öfo
->
ïoch_id
,

1200 
tm
.
tm_yór
 + 1900,Åm.
tm_m⁄
 + 1,

1201 
tm
.
tm_mday
,

1202 
tm
.
tm_hour
,Åm.
tm_mö
,Åm.
tm_£c
);

1204 
	}
}

1206 
	$nova_¥öt_¢≠shŸs
(
su≥r_block
 *
sb
, 
£q_fûe
 *
£q
)

1208 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1209 
¢≠shŸ_öfo
 *
öfo
;

1210 
¢≠shŸ_öfo
 *
öfos
[
FREE_BATCH
];

1211 
ƒ_öfos
;

1212 
u64
 
ïoch_id
 = 0;

1213 
cou¡
 = 0;

1214 
i
;

1216 
	`£q_puts
(
£q
, "========== NOVA snapshotÅable ==========\n");

1217 
	`£q_puts
(
£q
, "Epoch ID\t Date\t Time\n");

1221 
ƒ_öfos
 = 
	`ødix_åì_g™g_lookup
(&
sbi
->
¢≠shŸ_öfo_åì
,

1222 (**)
öfos
, 
ïoch_id
, 
FREE_BATCH
);

1223 
i
 = 0; i < 
ƒ_öfos
; i++) {

1224 
öfo
 = 
öfos
[
i
];

1225 
	`BUG_ON
(!
öfo
);

1226 
ïoch_id
 = 
öfo
->epoch_id;

1227 
	`nova_¥öt_¢≠shŸ_öfo
(
öfo
, 
£q
);

1228 
cou¡
++;

1230 
ïoch_id
++;

1231 } 
ƒ_öfos
 =
FREE_BATCH
);

1233 
	`£q_¥ötf
(
£q
, "==========TŸÆ %d s«pshŸ†===========\n", 
cou¡
);

1235 
	}
}

1237 
	$nova_¥öt_¢≠shŸ_li°s
(
su≥r_block
 *
sb
, 
£q_fûe
 *
£q
)

1239 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1240 
¢≠shŸ_öfo
 *
öfo
;

1241 
¢≠shŸ_li°
 *
li°
;

1242 
¢≠shŸ_öfo
 *
öfos
[
FREE_BATCH
];

1243 
ƒ_öfos
;

1244 
u64
 
ïoch_id
 = 0;

1245 
cou¡
 = 0;

1246 
sum
;

1247 
i
, 
j
;

1249 
	`£q_puts
(
£q
, "========== NOVA snapshot statistics ==========\n");

1253 
ƒ_öfos
 = 
	`ødix_åì_g™g_lookup
(&
sbi
->
¢≠shŸ_öfo_åì
,

1254 (**)
öfos
, 
ïoch_id
, 
FREE_BATCH
);

1255 
i
 = 0; i < 
ƒ_öfos
; i++) {

1256 
öfo
 = 
öfos
[
i
];

1257 
	`BUG_ON
(!
öfo
);

1258 
ïoch_id
 = 
öfo
->epoch_id;

1259 
sum
 = 0;

1260 
j
 = 0; j < 
sbi
->
˝us
; j++) {

1261 
li°
 = &
öfo
->
li°s
[
j
];

1262 
sum
 +
li°
->
num_∑ges
;

1264 
	`£q_¥ötf
(
£q
, "SnapshotÉpoch ID %llu, %dÜistÖages\n",

1265 
ïoch_id
, 
sum
);

1266 
cou¡
++;

1268 
ïoch_id
++;

1269 } 
ƒ_öfos
 =
FREE_BATCH
);

1271 
	`£q_¥ötf
(
£q
, "============= Total %d snapshots =============\n",

1272 
cou¡
);

1274 
	}
}

1276 
	$nova_åavî£_™d_dñëe_¢≠shŸ_öfos
(
su≥r_block
 *
sb
,

1277 
ßve
)

1279 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1280 
¢≠shŸ_öfo
 *
öfo
;

1281 
¢≠shŸ_öfo
 *
öfos
[
FREE_BATCH
];

1282 
ƒ_öfos
;

1283 
u64
 
ïoch_id
 = 0;

1284 
i
;

1287 
ƒ_öfos
 = 
	`ødix_åì_g™g_lookup
(&
sbi
->
¢≠shŸ_öfo_åì
,

1288 (**)
öfos
, 
ïoch_id
, 
FREE_BATCH
);

1289 
i
 = 0; i < 
ƒ_öfos
; i++) {

1290 
öfo
 = 
öfos
[
i
];

1291 
	`BUG_ON
(!
öfo
);

1292 
ïoch_id
 = 
öfo
->epoch_id;

1293 i‡(
ßve
)

1294 
	`nova_ßve_¢≠shŸ_öfo
(
sb
, 
öfo
);

1295 
	`nova_dñëe_¢≠shŸ_öfo
(
sb
, 
öfo
, 0);

1296 
	`ødix_åì_dñëe
(&
sbi
->
¢≠shŸ_öfo_åì
, 
ïoch_id
);

1297 
	`nova_‰ì_¢≠shŸ_öfo
(
öfo
);

1299 
ïoch_id
++;

1300 } 
ƒ_öfos
 =
FREE_BATCH
);

1303 
	}
}

1305 
	$nova_ßve_¢≠shŸs
(
su≥r_block
 *
sb
)

1307 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1309 i‡(
sbi
->
¢≠shŸ_˛ó√r_thªad
)

1310 
	`kthªad_°›
(
sbi
->
¢≠shŸ_˛ó√r_thªad
);

1312 i‡(
sbi
->
mou¡_¢≠shŸ
)

1315  
	`nova_åavî£_™d_dñëe_¢≠shŸ_öfos
(
sb
, 1);

1316 
	}
}

1318 
	$nova_de°roy_¢≠shŸ_öfos
(
su≥r_block
 *
sb
)

1320  
	`nova_åavî£_™d_dñëe_¢≠shŸ_öfos
(
sb
, 0);

1321 
	}
}

1323 
	$¢≠shŸ_˛ó√r_åy_¶ìpög
(
nova_sb_öfo
 *
sbi
)

1325 
	`DEFINE_WAIT
(
waô
);

1327 
	`¥ï¨e_to_waô
(&
sbi
->
¢≠shŸ_˛ó√r_waô
, &
waô
, 
TASK_INTERRUPTIBLE
);

1328 
	`scheduÀ
();

1329 
	`föish_waô
(&
sbi
->
¢≠shŸ_˛ó√r_waô
, &
waô
);

1330 
	}
}

1332 
	$nova_˛ón_¢≠shŸ
(
nova_sb_öfo
 *
sbi
)

1334 
su≥r_block
 *
sb
 = 
sbi
->sb;

1335 
¢≠shŸ_öfo
 *
öfo
;

1336 
¢≠shŸ_li°
 *
li°
;

1337 
i
;

1339 i‡(!
sbi
->
cuº_˛ón_¢≠shŸ_öfo
)

1342 
öfo
 = 
sbi
->
cuº_˛ón_¢≠shŸ_öfo
;

1344 
i
 = 0; i < 
sbi
->
˝us
; i++) {

1345 
li°
 = &
öfo
->
li°s
[
i
];

1347 
	`muãx_lock
(&
li°
->
li°_muãx
);

1348 
	`nova_background_˛ón_¢≠shŸ_li°
(
sb
, 
li°
,

1349 
öfo
->
ïoch_id
);

1350 
	`muãx_u∆ock
(&
li°
->
li°_muãx
);

1353 
sbi
->
cuº_˛ón_¢≠shŸ_öfo
 = 
NULL
;

1355 
	}
}

1357 
	$nova_¢≠shŸ_˛ó√r
(*
¨g
)

1359 
nova_sb_öfo
 *
sbi
 = 
¨g
;

1361 
	`nova_dbg
("Running snapshot cleanerÅhread\n");

1363 
	`¢≠shŸ_˛ó√r_åy_¶ìpög
(
sbi
);

1365 i‡(
	`kthªad_should_°›
())

1368 
	`nova_˛ón_¢≠shŸ
(
sbi
);

1371 i‡(
sbi
->
cuº_˛ón_¢≠shŸ_öfo
)

1372 
	`nova_˛ón_¢≠shŸ
(
sbi
);

1375 
	}
}

1377 
	$nova_¢≠shŸ_˛ó√r_öô
(
nova_sb_öfo
 *
sbi
)

1379 
ªt
 = 0;

1381 
	`öô_waôqueue_hód
(&
sbi
->
¢≠shŸ_˛ó√r_waô
);

1383 
sbi
->
¢≠shŸ_˛ó√r_thªad
 = 
	`kthªad_run
(
nova_¢≠shŸ_˛ó√r
,

1384 
sbi
, "nova_snapshot_cleaner");

1385 i‡(
	`IS_ERR
(
sbi
->
¢≠shŸ_˛ó√r_thªad
)) {

1386 
	`nova_öfo
("FailedÅo start NOVA snapshot cleanerÅhread\n");

1387 
ªt
 = -1;

1389 
	`nova_öfo
("Start NOVA snapshot cleanerÅhread.\n");

1390  
ªt
;

1391 
	}
}

1393 
	$nova_¢≠shŸ_öô
(
su≥r_block
 *
sb
)

1395 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

1396 
nova_öode_öfo_hódî
 *
sih
;

1397 
u64
 
öo
 = 
NOVA_SNAPSHOT_INO
;

1398 
ªt
;

1400 
sih
 = &
sbi
->
¢≠shŸ_si
->
hódî
;

1401 
	`nova_öô_hódî
(
sb
, 
sih
, 0);

1402 
sih
->
pi_addr
 = 
	`nova_gë_ª£rved_öode_addr
(
sb
, 
öo
);

1403 
sih
->
Æãr_pi_addr
 = 
	`nova_gë_Æãr_ª£rved_öode_addr
(
sb
, 
öo
);

1404 
sih
->
öo
 = ino;

1405 
sih
->
i_blk_ty≥
 = 
NOVA_DEFAULT_BLOCK_TYPE
;

1407 
	`INIT_RADIX_TREE
(&
sbi
->
¢≠shŸ_öfo_åì
, 
GFP_ATOMIC
);

1408 
	`öô_waôqueue_hód
(&
sbi
->
¢≠shŸ_mm≠_waô
);

1409 
ªt
 = 
	`nova_¢≠shŸ_˛ó√r_öô
(
sbi
);

1411  
ªt
;

1412 
	}
}

	@snapshot.h

25 
	s¢≠shŸ_li°
 {

26 
muãx
 
	mli°_muãx
;

27 
	mnum_∑ges
;

28 
	mhód
;

29 
	mèû
;

36 
	s¢≠shŸ_öfo
 {

37 
u64
 
	mïoch_id
;

38 
u64
 
	mtime°amp
;

39 
	m¢≠shŸ_íåy
;

44 
¢≠shŸ_li°
 *
	mli°s
;

48 
	enova_¢≠shŸ_íåy_ty≥
 {

49 
	mSS_INODE
 = 1,

50 
	mSS_FILE_WRITE
,

58 
	s¢≠shŸ_öode_íåy
 {

59 
u8
 
	mty≥
;

60 
u8
 
	mdñëed
;

61 
u8
 
	m∑ddög
[6];

62 
u64
 
	m∑ddög64
;

63 
u64
 
	mnova_öo
;

64 
u64
 
	mdñëe_ïoch_id
;

65 } 
__©åibuã
((
__∑cked__
));

72 
	s¢≠shŸ_fûe_wrôe_íåy
 {

73 
u8
 
	mty≥
;

74 
u8
 
	mdñëed
;

75 
u8
 
	m∑ddög
[6];

76 
u64
 
	mnvmm
;

77 
u64
 
	mnum_∑ges
;

78 
u64
 
	mdñëe_ïoch_id
;

79 } 
__©åibuã
((
__∑cked__
));

87 
	s¢≠shŸ_nvmm_li°
 {

88 
__À64
 
	m∑ddög
;

89 
__À64
 
	mnum_∑ges
;

90 
__À64
 
	mhód
;

91 
__À64
 
	mèû
;

92 } 
__©åibuã
((
__∑cked__
));

95 
	s¢≠shŸ_nvmm_∑ge
 {

96 
¢≠shŸ_nvmm_li°
 
	mli°s
[128];

	@stats.c

21 
	~"nova.h
"

23 c⁄° *
	gTimög°rög
[
TIMING_NUM
] = {

164 
u64
 
	gTimög°©s
[
TIMING_NUM
];

165 
DEFINE_PER_CPU
(
u64
[
TIMING_NUM
], 
Timög°©s_≥r˝u
);

166 
u64
 
	gCou¡°©s
[
TIMING_NUM
];

167 
DEFINE_PER_CPU
(
u64
[
TIMING_NUM
], 
Cou¡°©s_≥r˝u
);

168 
u64
 
	gIO°©s
[
STATS_NUM
];

169 
DEFINE_PER_CPU
(
u64
[
STATS_NUM
], 
IO°©s_≥r˝u
);

171 
	$nova_¥öt_Æloc_°©s
(
su≥r_block
 *
sb
)

173 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

174 
‰ì_li°
 *free_list;

175 
Æloc_log_cou¡
 = 0;

176 
Æloc_log_∑ges
 = 0;

177 
Æloc_d©a_cou¡
 = 0;

178 
Æloc_d©a_∑ges
 = 0;

179 
‰ì_log_cou¡
 = 0;

180 
‰ìd_log_∑ges
 = 0;

181 
‰ì_d©a_cou¡
 = 0;

182 
‰ìd_d©a_∑ges
 = 0;

183 
i
;

185 
	`nova_öfo
("=========== NOVAállocation stats ===========\n");

186 
	`nova_öfo
("Alloc %llu,álloc steps %llu,áverage %llu\n",

187 
Cou¡°©s
[
√w_d©a_blocks_t
], 
IO°©s
[
Æloc_°ïs
],

188 
Cou¡°©s
[
√w_d©a_blocks_t
] ?

189 
IO°©s
[
Æloc_°ïs
] / 
Cou¡°©s
[
√w_d©a_blocks_t
]

191 
	`nova_öfo
("Fªê%Œu\n", 
Cou¡°©s
[
‰ì_d©a_t
]);

192 
	`nova_öfo
("Fast GC %llu, checkÖages %llu, freeÖages %llu,áverage %llu\n",

193 
Cou¡°©s
[
Á°_gc_t
], 
IO°©s
[
Á°_checked_∑ges
],

194 
IO°©s
[
Á°_gc_∑ges
], 
Cou¡°©s
[
Á°_gc_t
] ?

195 
IO°©s
[
Á°_gc_∑ges
] / 
Cou¡°©s
[
Á°_gc_t
] : 0);

196 
	`nova_öfo
("Thorough GC %llu, checkedÖages %llu, freeÖages %llu,áverage %llu\n",

197 
Cou¡°©s
[
th‹ough_gc_t
],

198 
IO°©s
[
th‹ough_checked_∑ges
], IO°©s[
th‹ough_gc_∑ges
],

199 
Cou¡°©s
[
th‹ough_gc_t
] ?

200 
IO°©s
[
th‹ough_gc_∑ges
] / 
Cou¡°©s
[
th‹ough_gc_t
]

203 
i
 = 0; i < 
sbi
->
˝us
; i++) {

204 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
i
);

206 
Æloc_log_cou¡
 +
‰ì_li°
->alloc_log_count;

207 
Æloc_log_∑ges
 +
‰ì_li°
->alloc_log_pages;

208 
Æloc_d©a_cou¡
 +
‰ì_li°
->alloc_data_count;

209 
Æloc_d©a_∑ges
 +
‰ì_li°
->alloc_data_pages;

210 
‰ì_log_cou¡
 +
‰ì_li°
->free_log_count;

211 
‰ìd_log_∑ges
 +
‰ì_li°
->freed_log_pages;

212 
‰ì_d©a_cou¡
 +
‰ì_li°
->free_data_count;

213 
‰ìd_d©a_∑ges
 +
‰ì_li°
->freed_data_pages;

216 
	`nova_öfo
("allocÜog count %lu,állocatedÜogÖages %lu,álloc data count %lu,állocated dataÖages %lu, freeÜog count %lu, freedÜogÖages %lu, free data count %lu, freed dataÖages %lu\n",

217 
Æloc_log_cou¡
, 
Æloc_log_∑ges
,

218 
Æloc_d©a_cou¡
, 
Æloc_d©a_∑ges
,

219 
‰ì_log_cou¡
, 
‰ìd_log_∑ges
,

220 
‰ì_d©a_cou¡
, 
‰ìd_d©a_∑ges
);

221 
	}
}

223 
	$nova_¥öt_IO_°©s
(
su≥r_block
 *
sb
)

225 
	`nova_öfo
("=========== NOVA I/O stats ===========\n");

226 
	`nova_öfo
("Read %llu, bytes %llu,áverage %llu\n",

227 
Cou¡°©s
[
dax_ªad_t
], 
IO°©s
[
ªad_byãs
],

228 
Cou¡°©s
[
dax_ªad_t
] ?

229 
IO°©s
[
ªad_byãs
] / 
Cou¡°©s
[
dax_ªad_t
] : 0);

230 
	`nova_öfo
("COW write %llu, bytes %llu,áverage %llu, write breaks %llu,áverage %llu\n",

231 
Cou¡°©s
[
do_cow_wrôe_t
], 
IO°©s
[
cow_wrôe_byãs
],

232 
Cou¡°©s
[
do_cow_wrôe_t
] ?

233 
IO°©s
[
cow_wrôe_byãs
] / 
Cou¡°©s
[
do_cow_wrôe_t
] : 0,

234 
IO°©s
[
cow_wrôe_bªaks
], 
Cou¡°©s
[
do_cow_wrôe_t
] ?

235 
IO°©s
[
cow_wrôe_bªaks
] / 
Cou¡°©s
[
do_cow_wrôe_t
]

237 
	`nova_öfo
("Inplace write %llu, bytes %llu,áverage %llu, write breaks %llu,áverage %llu\n",

238 
Cou¡°©s
[
ö∂a˚_wrôe_t
], 
IO°©s
[
ö∂a˚_wrôe_byãs
],

239 
Cou¡°©s
[
ö∂a˚_wrôe_t
] ?

240 
IO°©s
[
ö∂a˚_wrôe_byãs
] /

241 
Cou¡°©s
[
ö∂a˚_wrôe_t
] : 0,

242 
IO°©s
[
ö∂a˚_wrôe_bªaks
], 
Cou¡°©s
[
ö∂a˚_wrôe_t
] ?

243 
IO°©s
[
ö∂a˚_wrôe_bªaks
] /

244 
Cou¡°©s
[
ö∂a˚_wrôe_t
] : 0);

245 
	}
}

247 
	$nova_gë_timög_°©s
()

249 
i
;

250 
˝u
;

252 
i
 = 0; i < 
TIMING_NUM
; i++) {

253 
Timög°©s
[
i
] = 0;

254 
Cou¡°©s
[
i
] = 0;

255 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

256 
Timög°©s
[
i
] +
	`≥r_˝u
(
Timög°©s_≥r˝u
[i], 
˝u
);

257 
Cou¡°©s
[
i
] +
	`≥r_˝u
(
Cou¡°©s_≥r˝u
[i], 
˝u
);

260 
	}
}

262 
	$nova_gë_IO_°©s
()

264 
i
;

265 
˝u
;

267 
i
 = 0; i < 
STATS_NUM
; i++) {

268 
IO°©s
[
i
] = 0;

269 
	`f‹_óch_possibÀ_˝u
(
˝u
)

270 
IO°©s
[
i
] +
	`≥r_˝u
(
IO°©s_≥r˝u
[i], 
˝u
);

272 
	}
}

274 
	$nova_¥öt_timög_°©s
(
su≥r_block
 *
sb
)

276 
i
;

278 
	`nova_gë_timög_°©s
();

279 
	`nova_gë_IO_°©s
();

281 
	`nova_öfo
("=========== NOVA kernelÅiming stats ============\n");

282 
i
 = 0; i < 
TIMING_NUM
; i++) {

284 i‡(
Timög°rög
[
i
][0] == '=') {

285 
	`nova_öfo
("\n%s\n\n", 
Timög°rög
[
i
]);

289 i‡(
mósuª_timög
 || 
Timög°©s
[
i
]) {

290 
	`nova_öfo
("%s: count %llu,Åiming %llu,áverage %llu\n",

291 
Timög°rög
[
i
],

292 
Cou¡°©s
[
i
],

293 
Timög°©s
[
i
],

294 
Cou¡°©s
[
i
] ?

295 
Timög°©s
[
i
] / 
Cou¡°©s
[i] : 0);

297 
	`nova_öfo
("%s: count %llu\n",

298 
Timög°rög
[
i
],

299 
Cou¡°©s
[
i
]);

303 
	`nova_öfo
("\n");

304 
	`nova_¥öt_Æloc_°©s
(
sb
);

305 
	`nova_¥öt_IO_°©s
(
sb
);

306 
	}
}

308 
	$nova_˛ór_timög_°©s
()

310 
i
;

311 
˝u
;

313 
i
 = 0; i < 
TIMING_NUM
; i++) {

314 
Cou¡°©s
[
i
] = 0;

315 
Timög°©s
[
i
] = 0;

316 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

317 
	`≥r_˝u
(
Timög°©s_≥r˝u
[
i
], 
˝u
) = 0;

318 
	`≥r_˝u
(
Cou¡°©s_≥r˝u
[
i
], 
˝u
) = 0;

321 
	}
}

323 
	$nova_˛ór_IO_°©s
(
su≥r_block
 *
sb
)

325 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

326 
‰ì_li°
 *free_list;

327 
i
;

328 
˝u
;

330 
i
 = 0; i < 
STATS_NUM
; i++) {

331 
IO°©s
[
i
] = 0;

332 
	`f‹_óch_possibÀ_˝u
(
˝u
)

333 
	`≥r_˝u
(
IO°©s_≥r˝u
[
i
], 
˝u
) = 0;

336 
i
 = 0; i < 
sbi
->
˝us
; i++) {

337 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
i
);

339 
‰ì_li°
->
Æloc_log_cou¡
 = 0;

340 
‰ì_li°
->
Æloc_log_∑ges
 = 0;

341 
‰ì_li°
->
Æloc_d©a_cou¡
 = 0;

342 
‰ì_li°
->
Æloc_d©a_∑ges
 = 0;

343 
‰ì_li°
->
‰ì_log_cou¡
 = 0;

344 
‰ì_li°
->
‰ìd_log_∑ges
 = 0;

345 
‰ì_li°
->
‰ì_d©a_cou¡
 = 0;

346 
‰ì_li°
->
‰ìd_d©a_∑ges
 = 0;

348 
	}
}

350 
	$nova_˛ór_°©s
(
su≥r_block
 *
sb
)

352 
	`nova_˛ór_timög_°©s
();

353 
	`nova_˛ór_IO_°©s
(
sb
);

354 
	}
}

356 
	$nova_¥öt_öode
(
nova_öode
 *
pi
)

358 
	`nova_dbg
("%s: NOVA inodê%Œu\n", 
__func__
, 
pi
->
nova_öo
);

359 
	`nova_dbg
("valid %u, deleted %u, blkÅype %u, flags %u\n",

360 
pi
->
vÆid
,Öi->
dñëed
,Öi->
i_blk_ty≥
,Öi->
i_Êags
);

361 
	`nova_dbg
("size %llu, ctime %u, mtime %u,átime %u\n",

362 
pi
->
i_size
,Öi->
i_˘ime
,Öi->
i_mtime
,Öi->
i_©ime
);

363 
	`nova_dbg
("mode %u,Üinks %u, xattr 0x%llx, csum %u\n",

364 
pi
->
i_mode
,Öi->
i_löks_cou¡
,Öi->
i_x©å
,Öi->
csum
);

365 
	`nova_dbg
("uid %u, gid %u, gen %u, createÅime %u\n",

366 
pi
->
i_uid
,Öi->
i_gid
,Öi->
i_gíî©i⁄
,Öi->
i_¸óã_time
);

367 
	`nova_dbg
("head 0x%llx,Åail 0x%llx,álter head 0x%llx,Åail 0x%llx\n",

368 
pi
->
log_hód
,Öi->
log_èû
,Öi->
Æãr_log_hód
,

369 
pi
->
Æãr_log_èû
);

370 
	`nova_dbg
("createÉpoch id %llu, deleteÉpoch id %llu\n",

371 
pi
->
¸óã_ïoch_id
,Öi->
dñëe_ïoch_id
);

372 
	}
}

374 
ölöe
 
	$nova_¥öt_fûe_wrôe_íåy
(
su≥r_block
 *
sb
,

375 
u64
 
cuº
, 
nova_fûe_wrôe_íåy
 *
íåy
)

377 
	`nova_dbg
("file writeÉntry @ 0x%llx:Époch %llu,Årans %llu,Ögoff %llu,Öages %u, blocknr %llu,Ñeassigned %u, updating %u, invalid count %u, size %llu, mtime %u\n",

378 
cuº
, 
íåy
->
ïoch_id
,É¡ry->
å™s_id
,

379 
íåy
->
pgoff
,É¡ry->
num_∑ges
,

380 
íåy
->
block
 >> 
PAGE_SHIFT
,

381 
íåy
->
ªassig√d
,É¡ry->
upd©ög
,

382 
íåy
->
övÆid_∑ges
,É¡ry->
size
,É¡ry->
mtime
);

383 
	}
}

385 
ölöe
 
	$nova_¥öt_£t_©å_íåy
(
su≥r_block
 *
sb
,

386 
u64
 
cuº
, 
nova_£èâr_logíåy
 *
íåy
)

388 
	`nova_dbg
("setáttrÉntry @ 0x%llx:Époch %llu,Årans %llu, invalid %u, mode %u, size %llu,átime %u, mtime %u, ctime %u\n",

389 
cuº
, 
íåy
->
ïoch_id
,É¡ry->
å™s_id
,

390 
íåy
->
övÆid
,É¡ry->
mode
,

391 
íåy
->
size
,É¡ry->
©ime
,É¡ry->
mtime
,É¡ry->
˘ime
);

392 
	}
}

394 
ölöe
 
	$nova_¥öt_lök_ch™ge_íåy
(
su≥r_block
 *
sb
,

395 
u64
 
cuº
, 
nova_lök_ch™ge_íåy
 *
íåy
)

397 
	`nova_dbg
("link changeÉntry @ 0x%llx:Époch %llu,Årans %llu, invalid %u,Üinks %u, flags %u, ctime %u\n",

398 
cuº
, 
íåy
->
ïoch_id
,É¡ry->
å™s_id
,

399 
íåy
->
övÆid
,É¡ry->
löks
,

400 
íåy
->
Êags
,É¡ry->
˘ime
);

401 
	}
}

403 
ölöe
 
	$nova_¥öt_mm≠_íåy
(
su≥r_block
 *
sb
,

404 
u64
 
cuº
, 
nova_mm≠_íåy
 *
íåy
)

406 
	`nova_dbg
("mmap writeÉntry @ 0x%llx:Époch %llu, invalid %u,Ögoff %llu,Öages %llu\n",

407 
cuº
, 
íåy
->
ïoch_id
,É¡ry->
övÆid
,

408 
íåy
->
pgoff
,É¡ry->
num_∑ges
);

409 
	}
}

411 
ölöe
 
	$nova_¥öt_¢≠shŸ_öfo_íåy
(
su≥r_block
 *
sb
,

412 
u64
 
cuº
, 
nova_¢≠shŸ_öfo_íåy
 *
íåy
)

414 
	`nova_dbg
("snapshot infoÉntry @ 0x%llx:Époch %llu, deleted %u,Åimestamp %llu\n",

415 
cuº
, 
íåy
->
ïoch_id
,É¡ry->
dñëed
,

416 
íåy
->
time°amp
);

417 
	}
}

419 
ölöe
 
size_t
 
	$nova_¥öt_díåy
(
su≥r_block
 *
sb
,

420 
u64
 
cuº
, 
nova_díåy
 *
íåy
)

422 
	`nova_dbg
("dirÜogentry @ 0x%llx:Époch %llu,Årans %llu,Ñeassigned %u, invalid %u, inode %llu,Üinks %u,Çamelen %u,ÑecÜen %u,Çame %s, mtime %u\n",

423 
cuº
, 
íåy
->
ïoch_id
,É¡ry->
å™s_id
,

424 
íåy
->
ªassig√d
,É¡ry->
övÆid
,

425 
	`À64_to_˝u
(
íåy
->
öo
),

426 
íåy
->
löks_cou¡
,É¡ry->
«me_Àn
,

427 
	`À16_to_˝u
(
íåy
->
de_Àn
),É¡ry->
«me
,

428 
íåy
->
mtime
);

430  
	`À16_to_˝u
(
íåy
->
de_Àn
);

431 
	}
}

433 
u64
 
	$nova_¥öt_log_íåy
(
su≥r_block
 *
sb
, 
u64
 
cuº
)

435 *
addr
;

436 
size_t
 
size
;

437 
u8
 
ty≥
;

439 
addr
 = (*)
	`nova_gë_block
(
sb
, 
cuº
);

440 
ty≥
 = 
	`nova_gë_íåy_ty≥
(
addr
);

441 
ty≥
) {

442 
SET_ATTR
:

443 
	`nova_¥öt_£t_©å_íåy
(
sb
, 
cuº
, 
addr
);

444 
cuº
 +(
nova_£èâr_logíåy
);

446 
LINK_CHANGE
:

447 
	`nova_¥öt_lök_ch™ge_íåy
(
sb
, 
cuº
, 
addr
);

448 
cuº
 +(
nova_lök_ch™ge_íåy
);

450 
MMAP_WRITE
:

451 
	`nova_¥öt_mm≠_íåy
(
sb
, 
cuº
, 
addr
);

452 
cuº
 +(
nova_mm≠_íåy
);

454 
SNAPSHOT_INFO
:

455 
	`nova_¥öt_¢≠shŸ_öfo_íåy
(
sb
, 
cuº
, 
addr
);

456 
cuº
 +(
nova_¢≠shŸ_öfo_íåy
);

458 
FILE_WRITE
:

459 
	`nova_¥öt_fûe_wrôe_íåy
(
sb
, 
cuº
, 
addr
);

460 
cuº
 +(
nova_fûe_wrôe_íåy
);

462 
DIR_LOG
:

463 
size
 = 
	`nova_¥öt_díåy
(
sb
, 
cuº
, 
addr
);

464 
cuº
 +
size
;

465 i‡(
size
 == 0) {

466 
	`nova_dbg
("%s: dentry with size 0 @ 0x%llx\n",

467 
__func__
, 
cuº
);

468 
cuº
 +(
nova_fûe_wrôe_íåy
);

469 
	`NOVA_ASSERT
(0);

472 
NEXT_PAGE
:

473 
	`nova_dbg
("%s:Çexà∑gêsig¿@ 0x%Œx\n", 
__func__
, 
cuº
);

474 
cuº
 = 
	`PAGE_TAIL
(curr);

477 
	`nova_dbg
("%s: unknow¿ty≥ %d, 0x%Œx\n", 
__func__
, 
ty≥
, 
cuº
);

478 
cuº
 = 0;

479 
	`NOVA_ASSERT
(0);

483  
cuº
;

484 
	}
}

486 
	$nova_¥öt_cuº_log_∑ge
(
su≥r_block
 *
sb
, 
u64
 
cuº
)

488 
nova_öode_∑ge_èû
 *
èû
;

489 
u64
 
°¨t
, 
íd
;

491 
°¨t
 = 
	`BLOCK_OFF
(
cuº
);

492 
íd
 = 
	`PAGE_TAIL
(
cuº
);

494 
°¨t
 < 
íd
 && start != 0)

495 
°¨t
 = 
	`nova_¥öt_log_íåy
(
sb
, start);

497 
èû
 = 
	`nova_gë_block
(
sb
, 
íd
);

498 
	`nova_dbg
("PageÅail. curr 0x%llx,ÇextÖage 0x%llx, %uÉntries, %u invalid\n",

499 
°¨t
, 
èû
->
√xt_∑ge
,

500 
èû
->
num_íåõs
,Åaû->
övÆid_íåõs
);

501 
	}
}

503 
	$nova_¥öt_nova_log
(
su≥r_block
 *
sb
,

504 
nova_öode_öfo_hódî
 *
sih
)

506 
u64
 
cuº
;

508 i‡(
sih
->
log_èû
 =0 || sih->
log_hód
 == 0)

511 
cuº
 = 
sih
->
log_hód
;

512 
	`nova_dbg
("Pi %lu:Üog head 0x%llx,Åail 0x%llx\n",

513 
sih
->
öo
, 
cuº
, sih->
log_èû
);

515 i‡(
sih
->
öo
 !
NOVA_ROOT_INO
 && sih->öÿ< 
NOVA_NORMAL_INODE_START
) {

516 
	`nova_dbg
("Special inode,Ñeturn\n");

520 
cuº
 !
sih
->
log_èû
) {

521 i‡((
cuº
 & (
PAGE_SIZE
 - 1)Ë=
LOG_BLOCK_TAIL
) {

522 
nova_öode_∑ge_èû
 *
èû
 =

523 
	`nova_gë_block
(
sb
, 
cuº
);

524 
	`nova_dbg
("LogÅail, curr 0x%llx,ÇextÖage 0x%llx, %uÉntries, %u invalid\n",

525 
cuº
, 
èû
->
√xt_∑ge
,

526 
èû
->
num_íåõs
,

527 
èû
->
övÆid_íåõs
);

528 
cuº
 = 
èû
->
√xt_∑ge
;

530 
cuº
 = 
	`nova_¥öt_log_íåy
(
sb
, curr);

532 i‡(
cuº
 == 0)

535 
	}
}

537 
	$nova_¥öt_öode_log
(
su≥r_block
 *
sb
, 
öode
 *inode)

539 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

540 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

542 
	`nova_¥öt_nova_log
(
sb
, 
sih
);

543 
	}
}

545 
	$nova_gë_nova_log_∑ges
(
su≥r_block
 *
sb
,

546 
nova_öode_öfo_hódî
 *
sih
, 
nova_öode
 *
pi
)

548 
nova_öode_log_∑ge
 *
cuº_∑ge
;

549 
u64
 
cuº
, 
√xt
;

550 
cou¡
 = 1;

552 i‡(
pi
->
log_hód
 =0 ||Öi->
log_èû
 == 0) {

553 
	`nova_dbg
("Pò%lu ha†nÿlog\n", 
sih
->
öo
);

557 
cuº
 = 
pi
->
log_hód
;

558 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
	`nova_gë_block
(
sb
, 
cuº
);

559 (
√xt
 = 
cuº_∑ge
->
∑ge_èû
.
√xt_∑ge
) != 0) {

560 
cuº
 = 
√xt
;

561 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)

562 
	`nova_gë_block
(
sb
, 
cuº
);

563 
cou¡
++;

566  
cou¡
;

567 
	}
}

569 
	$nova_¥öt_nova_log_∑ges
(
su≥r_block
 *
sb
,

570 
nova_öode_öfo_hódî
 *
sih
)

572 
nova_öode_log_∑ge
 *
cuº_∑ge
;

573 
u64
 
cuº
, 
√xt
;

574 
cou¡
 = 1;

575 
u£d
 = 
cou¡
;

577 i‡(
sih
->
log_hód
 =0 || sih->
log_èû
 == 0) {

578 
	`nova_dbg
("Pò%lu ha†nÿlog\n", 
sih
->
öo
);

582 
cuº
 = 
sih
->
log_hód
;

583 
	`nova_dbg
("Pi %lu:Üog head @ 0x%llx,Åail @ 0x%llx\n",

584 
sih
->
öo
, 
cuº
, sih->
log_èû
);

585 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)
	`nova_gë_block
(
sb
, 
cuº
);

586 (
√xt
 = 
cuº_∑ge
->
∑ge_èû
.
√xt_∑ge
) != 0) {

587 
	`nova_dbg
("CurrentÖage 0x%llx,ÇextÖage 0x%llx, %uÉntries, %u invalid\n",

588 
cuº
 >> 
PAGE_SHIFT
, 
√xt
 >> PAGE_SHIFT,

589 
cuº_∑ge
->
∑ge_èû
.
num_íåõs
,

590 
cuº_∑ge
->
∑ge_èû
.
övÆid_íåõs
);

591 i‡(
sih
->
log_èû
 >> 
PAGE_SHIFT
 =
cuº
 >> PAGE_SHIFT)

592 
u£d
 = 
cou¡
;

593 
cuº
 = 
√xt
;

594 
cuº_∑ge
 = (
nova_öode_log_∑ge
 *)

595 
	`nova_gë_block
(
sb
, 
cuº
);

596 
cou¡
++;

598 i‡(
sih
->
log_èû
 >> 
PAGE_SHIFT
 =
cuº
 >> PAGE_SHIFT)

599 
u£d
 = 
cou¡
;

600 
	`nova_dbg
("Pi %lu:Üog used %dÖages, has %dÖages, siÑeports %luÖages\n",

601 
sih
->
öo
, 
u£d
, 
cou¡
,

602 
sih
->
log_∑ges
);

603 
	}
}

605 
	$nova_¥öt_öode_log_∑ges
(
su≥r_block
 *
sb
, 
öode
 *inode)

607 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

608 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

610 
	`nova_¥öt_nova_log_∑ges
(
sb
, 
sih
);

611 
	}
}

613 
	$nova_check_öode_logs
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
)

615 
cou¡1
 = 0;

616 
cou¡2
 = 0;

617 
èû1_©
 = 0;

618 
èû2_©
 = 0;

619 
u64
 
cuº
, 
Æãr_cuº
;

621 
cuº
 = 
pi
->
log_hód
;

622 
Æãr_cuº
 = 
pi
->
Æãr_log_hód
;

624 
cuº
 && 
Æãr_cuº
) {

625 i‡(
	`Æãr_log_∑ge
(
sb
, 
cuº
Ë!
Æãr_cuº
 ||

626 
	`Æãr_log_∑ge
(
sb
, 
Æãr_cuº
Ë!
cuº
)

627 
	`nova_dbg
("Inode %lluÖage %d: curr 0x%llx,álter 0x%llx,álter_curr 0x%llx,álter 0x%llx\n",

628 
pi
->
nova_öo
, 
cou¡1
,

629 
cuº
, 
	`Æãr_log_∑ge
(
sb
, curr),

630 
Æãr_cuº
,

631 
	`Æãr_log_∑ge
(
sb
, 
Æãr_cuº
));

633 
cou¡1
++;

634 
cou¡2
++;

635 i‡((
cuº
 >> 
PAGE_SHIFT
Ë=(
pi
->
log_èû
 >> PAGE_SHIFT))

636 
èû1_©
 = 
cou¡1
;

637 i‡((
Æãr_cuº
 >> 
PAGE_SHIFT
) ==

638 (
pi
->
Æãr_log_èû
 >> 
PAGE_SHIFT
))

639 
èû2_©
 = 
cou¡2
;

640 
cuº
 = 
	`√xt_log_∑ge
(
sb
, curr);

641 
Æãr_cuº
 = 
	`√xt_log_∑ge
(
sb
,álter_curr);

644 
cuº
) {

645 
cou¡1
++;

646 i‡((
cuº
 >> 
PAGE_SHIFT
Ë=(
pi
->
log_èû
 >> PAGE_SHIFT))

647 
èû1_©
 = 
cou¡1
;

648 
cuº
 = 
	`√xt_log_∑ge
(
sb
, curr);

651 
Æãr_cuº
) {

652 
cou¡2
++;

653 i‡((
Æãr_cuº
 >> 
PAGE_SHIFT
) ==

654 (
pi
->
Æãr_log_èû
 >> 
PAGE_SHIFT
))

655 
èû2_©
 = 
cou¡2
;

656 
Æãr_cuº
 = 
	`√xt_log_∑ge
(
sb
,álter_curr);

659 
	`nova_dbg
("Log1 %dÖages,Åaû @Öagê%d\n", 
cou¡1
, 
èû1_©
);

660 
	`nova_dbg
("Log2 %dÖages,Åaû @Öagê%d\n", 
cou¡2
, 
èû2_©
);

663 
	}
}

665 
	$nova_¥öt_‰ì_li°s
(
su≥r_block
 *
sb
)

667 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

668 
‰ì_li°
 *free_list;

669 
i
;

671 
	`nova_dbg
("======== NOVAÖer-CPU freeÜistállocation stats ========\n");

672 
i
 = 0; i < 
sbi
->
˝us
; i++) {

673 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
i
);

674 
	`nova_dbg
("FreeÜist %d: block start %lu, blockÉnd %lu,Çum_blocks %lu,Çum_free_blocks %lu, blocknode %lu\n",

675 
i
, 
‰ì_li°
->
block_°¨t
, fªe_li°->
block_íd
,

676 
‰ì_li°
->
block_íd
 - fªe_li°->
block_°¨t
 + 1,

677 
‰ì_li°
->
num_‰ì_blocks
, fªe_li°->
num_blocknode
);

679 
	`nova_dbg
("FreeÜist %d: csum start %lu,Ñeplica csum start %lu, csum blocks %lu,Öarity start %lu,Öarity blocks %lu\n",

680 
i
, 
‰ì_li°
->
csum_°¨t
, fªe_li°->
ª∂iˇ_csum_°¨t
,

681 
‰ì_li°
->
num_csum_blocks
,

682 
‰ì_li°
->
∑rôy_°¨t
, fªe_li°->
num_∑rôy_blocks
);

684 
	`nova_dbg
("FreeÜist %d:állocÜog count %lu,állocatedÜogÖages %lu,álloc data count %lu,állocated dataÖages %lu, freeÜog count %lu, freedÜogÖages %lu, free data count %lu, freed dataÖages %lu\n",

685 
i
,

686 
‰ì_li°
->
Æloc_log_cou¡
,

687 
‰ì_li°
->
Æloc_log_∑ges
,

688 
‰ì_li°
->
Æloc_d©a_cou¡
,

689 
‰ì_li°
->
Æloc_d©a_∑ges
,

690 
‰ì_li°
->
‰ì_log_cou¡
,

691 
‰ì_li°
->
‰ìd_log_∑ges
,

692 
‰ì_li°
->
‰ì_d©a_cou¡
,

693 
‰ì_li°
->
‰ìd_d©a_∑ges
);

695 
	}
}

	@stats.h

21 #i‚de‡
__STATS_H


22 
	#__STATS_H


	)

24 
	~"löux/time64.h
"

27 
	etimög_ˇãg‹y
 {

29 
	möô_tôÀ_t
,

30 
	möô_t
,

31 
	mmou¡_t
,

32 
	mi‹em≠_t
,

33 
	m√w_öô_t
,

34 
	mªcovîy_t
,

37 
	m«mei_tôÀ_t
,

38 
	m¸óã_t
,

39 
	mlookup_t
,

40 
	mlök_t
,

41 
	mu∆ök_t
,

42 
	msymlök_t
,

43 
	mmkdú_t
,

44 
	mrmdú_t
,

45 
	mmknod_t
,

46 
	mª«me_t
,

47 
	mªaddú_t
,

48 
	madd_díåy_t
,

49 
	mªmove_díåy_t
,

50 
	m£èâr_t
,

51 
	m£tsize_t
,

54 
	mio_tôÀ_t
,

55 
	mdax_ªad_t
,

56 
	mdo_cow_wrôe_t
,

57 
	mcow_wrôe_t
,

58 
	mö∂a˚_wrôe_t
,

59 
	mc›y_to_nvmm_t
,

60 
	mdax_gë_block_t
,

61 
	mªad_ôî_t
,

62 
	mwrôe_ôî_t
,

63 
	mwøp_ôî_t
,

66 
	mmem‹y_tôÀ_t
,

67 
	mmem˝y_r_nvmm_t
,

68 
	mmem˝y_w_nvmm_t
,

69 
	mmem˝y_w_wb_t
,

70 
	m∑πül_block_t
,

73 
	mmm_tôÀ_t
,

74 
	m√w_blocks_t
,

75 
	m√w_d©a_blocks_t
,

76 
	m√w_log_blocks_t
,

77 
	m‰ì_blocks_t
,

78 
	m‰ì_d©a_t
,

79 
	m‰ì_log_t
,

82 
	må™s_tôÀ_t
,

83 
	m¸óã_å™s_t
,

84 
	mlök_å™s_t
,

85 
	mupd©e_èû_t
,

88 
	mloggög_tôÀ_t
,

89 
	m≠≥nd_dú_íåy_t
,

90 
	m≠≥nd_fûe_íåy_t
,

91 
	m≠≥nd_mm≠_íåy_t
,

92 
	m≠≥nd_lök_ch™ge_t
,

93 
	m≠≥nd_£èâr_t
,

94 
	m≠≥nd_¢≠shŸ_öfo_t
,

95 
	mupd©e_íåy_t
,

98 
	måì_tôÀ_t
,

99 
	mcheck_íåy_t
,

100 
	massign_t
,

103 
	mgc_tôÀ_t
,

104 
	mÁ°_gc_t
,

105 
	mth‹ough_gc_t
,

106 
	mcheck_övÆid_t
,

109 
	möãgrôy_tôÀ_t
,

110 
	mblock_csum_t
,

111 
	mblock_∑rôy_t
,

112 
	mblock_csum_∑rôy_t
,

113 
	m¥Ÿe˘_mem˝y_t
,

114 
	m¥Ÿe˘_fûe_d©a_t
,

115 
	mvîify_íåy_csum_t
,

116 
	mvîify_d©a_csum_t
,

117 
	mˇlc_íåy_csum_t
,

118 
	mª°‹e_d©a_t
,

119 
	mª£t_m≠pög_t
,

120 
	mª£t_vma_t
,

123 
	mŸhîs_tôÀ_t
,

124 
	mföd_ˇche_t
,

125 
	mfsync_t
,

126 
	mwrôe_∑ges_t
,

127 
	mÁŒoˇã_t
,

128 
	mdúe˘_IO_t
,

129 
	m‰ì_ﬁd_t
,

130 
	mdñëe_fûe_åì_t
,

131 
	mdñëe_dú_åì_t
,

132 
	m√w_vfs_öode_t
,

133 
	m√w_nova_öode_t
,

134 
	m‰ì_öode_t
,

135 
	m‰ì_öode_log_t
,

136 
	mevi˘_öode_t
,

137 
	m≥rf_t
,

138 
	mw¥Ÿe˘_t
,

141 
	mmm≠_tôÀ_t
,

142 
	mmm≠_Áu…_t
,

143 
	mpmd_Áu…_t
,

144 
	mp‚_mkwrôe_t
,

145 
	mö£π_vma_t
,

146 
	mªmove_vma_t
,

147 
	m£t_vma_ªad_t
,

148 
	mmm≠_cow_t
,

149 
	mupd©e_m≠pög_t
,

150 
	mupd©e_p‚_t
,

151 
	mmm≠_h™dÀr_t
,

154 
	mªbuûd_tôÀ_t
,

155 
	mªbuûd_dú_t
,

156 
	mªbuûd_fûe_t
,

157 
	mªbuûd_¢≠shŸ_t
,

160 
	m¢≠shŸ_tôÀ_t
,

161 
	m¸óã_¢≠shŸ_t
,

162 
	möô_¢≠shŸ_öfo_t
,

163 
	mdñëe_¢≠shŸ_t
,

164 
	m≠≥nd_¢≠shŸ_fûe_t
,

165 
	m≠≥nd_¢≠shŸ_öode_t
,

168 
	mTIMING_NUM
,

171 
	e°©s_ˇãg‹y
 {

172 
	mÆloc_°ïs
,

173 
	mcow_wrôe_bªaks
,

174 
	mö∂a˚_wrôe_bªaks
,

175 
	mªad_byãs
,

176 
	mcow_wrôe_byãs
,

177 
	mö∂a˚_wrôe_byãs
,

178 
	mÁ°_checked_∑ges
,

179 
	mth‹ough_checked_∑ges
,

180 
	mÁ°_gc_∑ges
,

181 
	mth‹ough_gc_∑ges
,

182 
	mdúty_∑ges
,

183 
	m¥Ÿe˘_hód
,

184 
	m¥Ÿe˘_èû
,

185 
	mblock_csum_∑rôy
,

186 
	mdax_cow_durög_¢≠shŸ
,

187 
	mm≠pög_upd©ed_∑ges
,

188 
	mcow_ovîœp_mm≠
,

189 
	mdax_√w_blocks
,

190 
	mö∂a˚_√w_blocks
,

191 
	mfd©async
,

194 
	mSTATS_NUM
,

197 c⁄° *
Timög°rög
[
TIMING_NUM
];

198 
u64
 
Timög°©s
[
TIMING_NUM
];

199 
DECLARE_PER_CPU
(
u64
[
TIMING_NUM
], 
Timög°©s_≥r˝u
);

200 
u64
 
Cou¡°©s
[
TIMING_NUM
];

201 
DECLARE_PER_CPU
(
u64
[
TIMING_NUM
], 
Cou¡°©s_≥r˝u
);

202 
u64
 
IO°©s
[
STATS_NUM
];

203 
DECLARE_PER_CPU
(
u64
[
STATS_NUM
], 
IO°©s_≥r˝u
);

205 
	#INIT_TIMING
(
X
Ë
time•ec64
 X = {0, 0}

	)

207 
	#NOVA_START_TIMING
(
«me
, 
°¨t
) \

208 {i‡(
mósuª_timög
Ë
	`ktime_gë_ts64
(&
°¨t
); }

	)

210 
	#NOVA_END_TIMING
(
«me
, 
°¨t
) \

211 {i‡(
mósuª_timög
) { \

212 
	`INIT_TIMING
(
íd
); \

213 
	`ktime_gë_ts64
(&
íd
); \

214 
	`__this_˝u_add
(
Timög°©s_≥r˝u
[
«me
], \

215 (
íd
.
tv_£c
 - 
°¨t
.tv_sec) * 1000000000 + \

216 (
íd
.
tv_n£c
 - 
°¨t
.tv_nsec)); \

218 
	`__this_˝u_add
(
Cou¡°©s_≥r˝u
[
«me
], 1); \

219 }

	)

221 
	#NOVA_STATS_ADD
(
«me
, 
vÆue
) \

222 {
	`__this_˝u_add
(
IO°©s_≥r˝u
[
«me
], 
vÆue
); }

	)

	@super.c

21 
	~<löux/moduÀ.h
>

22 
	~<löux/°rög.h
>

23 
	~<löux/¶ab.h
>

24 
	~<löux/öô.h
>

25 
	~<löux/∑r£r.h
>

26 
	~<löux/vfs.h
>

27 
	~<löux/uac˚ss.h
>

28 
	~<löux/io.h
>

29 
	~<löux/£q_fûe.h
>

30 
	~<löux/mou¡.h
>

31 
	~<u≠i/löux/mou¡.h
>

32 
	~<löux/mm.h
>

33 
	~<löux/˘y≥.h
>

34 
	~<löux/bô›s.h
>

35 
	~<löux/magic.h
>

36 
	~<löux/exp‹tfs.h
>

37 
	~<löux/øndom.h
>

38 
	~<löux/¸ed.h
>

39 
	~<löux/li°.h
>

40 
	~<löux/dax.h
>

41 
	~"nova.h
"

42 
	~"jou∫Æ.h
"

43 
	~"su≥r.h
"

44 
	~"öode.h
"

46 
	gmósuª_timög
;

47 
	gmëad©a_csum
;

48 
	gw¥Ÿe˘
;

49 
	gd©a_csum
;

50 
	gd©a_∑rôy
;

51 
	gdøm_°ru˘_csum
;

52 
	gsuµ‹t_˛wb
;

54 
moduÀ_∑øm
(
mósuª_timög
, , 0444);

55 
MODULE_PARM_DESC
(
mósuª_timög
, "Timing measurement");

57 
moduÀ_∑øm
(
mëad©a_csum
, , 0444);

58 
MODULE_PARM_DESC
(
mëad©a_csum
, "Protect metadata structures withÑeplicationánd checksums");

60 
moduÀ_∑øm
(
w¥Ÿe˘
, , 0444);

61 
MODULE_PARM_DESC
(
w¥Ÿe˘
, "Write-protectÖmemÑegionánd use CR0.WPÅoállow updates");

63 
moduÀ_∑øm
(
d©a_csum
, , 0444);

64 
MODULE_PARM_DESC
(
d©a_csum
, "Detect corruption of dataÖages using checksum");

66 
moduÀ_∑øm
(
d©a_∑rôy
, , 0444);

67 
MODULE_PARM_DESC
(
d©a_∑rôy
, "Protect file data using RAID-5 styleÖarity.");

69 
moduÀ_∑øm
(
døm_°ru˘_csum
, , 0444);

70 
MODULE_PARM_DESC
(
døm_°ru˘_csum
, "Protect key DRAM data structures with checksums");

72 
moduÀ_∑øm
(
nova_dbgmask
, , 0444);

73 
MODULE_PARM_DESC
(
nova_dbgmask
, "Control debugging output");

75 
su≥r_›î©i⁄s
 
	gnova_s›s
;

76 c⁄° 
exp‹t_›î©i⁄s
 
	gnova_exp‹t_›s
;

77 
kmem_ˇche
 *
	gnova_öode_ˇchï
;

78 
kmem_ˇche
 *
	gnova_ønge_node_ˇchï
;

79 
kmem_ˇche
 *
	gnova_¢≠shŸ_öfo_ˇchï
;

82 
	gnova_dbgmask
;

84 
	$nova_îr‹_mng
(
su≥r_block
 *
sb
, c⁄° *
fmt
, ...)

86 
va_li°
 
¨gs
;

88 
	`¥ötk
(
KERN_CRIT
 "novaÉrror: ");

89 
	`va_°¨t
(
¨gs
, 
fmt
);

90 
	`v¥ötk
(
fmt
, 
¨gs
);

91 
	`va_íd
(
¨gs
);

93 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
))

94 
	`∑nic
("nova:Öanic fromÖreviousÉrror\n");

95 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
)) {

96 
	`¥ötk
(
KERN_CRIT
 "novaÉrr:Ñemounting filesystemÑead-only");

97 
sb
->
s_Êags
 |
MS_RDONLY
;

99 
	}
}

101 
	$nova_£t_blocksize
(
su≥r_block
 *
sb
, 
size
)

103 
bôs
;

110 
bôs
 = 
	`Ês
(
size
) - 1;

111 
sb
->
s_blocksize_bôs
 = 
bôs
;

112 
sb
->
s_blocksize
 = (1 << 
bôs
);

113 
	}
}

115 
	$nova_gë_nvmm_öfo
(
su≥r_block
 *
sb
,

116 
nova_sb_öfo
 *
sbi
)

118 *
vút_addr
 = 
NULL
;

119 
p‚_t
 
__p‚_t
;

120 
size
;

121 
dax_devi˚
 *
dax_dev
;

122 
ªt
 = ()
åue
;

123 
u64
 
dax_∑π_off
;

148 
sbi
->
s_bdev
 = 
sb
->s_bdev;

152 
dax_dev
 = 
	`fs_dax_gë_by_bdev
(
sb
->
s_bdev
, &
dax_∑π_off
, 
NULL
, NULL);

154 i‡(!
dax_dev
) {

155 
	`nova_îr
(
sb
, "Couldn'tÑetrieve DAX device.\n");

156  -
EINVAL
;

158 
sbi
->
s_dax_dev
 = 
dax_dev
;

160 
size
 = 
	`dax_dúe˘_ac˚ss
(
sbi
->
s_dax_dev
, 0, 
LONG_MAX
/
PAGE_SIZE
,

162 
DAX_ACCESS
, &
vút_addr
, &
__p‚_t
Ë* 
PAGE_SIZE
;

163 i‡(
size
 <= 0) {

164 
	`nova_îr
(
sb
, "direct_access failed\n");

165  -
EINVAL
;

168 
sbi
->
vút_addr
 = virt_addr;

170 i‡(!
sbi
->
vút_addr
) {

171 
	`nova_îr
(
sb
, "ioremap ofÅheÇova image failed(1)\n");

172  -
EINVAL
;

175 
sbi
->
phys_addr
 = 
	`p‚_t_to_p‚
(
__p‚_t
Ë<< 
PAGE_SHIFT
;

176 
sbi
->
öôsize
 = 
size
;

177 
sbi
->
ª∂iˇ_ª£rved_öodes_addr
 = 
vút_addr
 + 
size
 -

178 (
sbi
->
èû_ª£rved_blocks
 << 
PAGE_SHIFT
);

179 
sbi
->
ª∂iˇ_sb_addr
 = 
vút_addr
 + 
size
 - 
PAGE_SIZE
;

181 
	`nova_dbg
("%s: dev %s,Öhys_addr 0x%llx, virt_addr 0x%lx, size %ld\n",

182 
__func__
, 
sbi
->
s_bdev
->
bd_disk
->
disk_«me
,

183 
sbi
->
phys_addr
, ()sbi->
vút_addr
, sbi->
öôsize
);

186 
	}
}

188 
loff_t
 
	$nova_max_size
(
bôs
)

190 
loff_t
 
ªs
;

192 
ªs
 = (1ULL << 63) - 1;

194 i‡(
ªs
 > 
MAX_LFS_FILESIZE
)

195 
ªs
 = 
MAX_LFS_FILESIZE
;

197 
	`nova_dbg_vîbo£
("max fûêsizê%Œu byãs\n", 
ªs
);

198  
ªs
;

199 
	}
}

202 
	mO±_bpi
, 
	mO±_öô
, 
	mO±_¢≠shŸ
, 
	mO±_mode
, 
	mO±_uid
,

203 
	mO±_gid
, 
	mO±_dax
, 
	mO±_d©a_cow
, 
	mO±_w¥Ÿe˘
,

204 
	mO±_îr_c⁄t
, 
	mO±_îr_∑nic
, 
	mO±_îr_ro
,

205 
	mO±_dbgmask
, 
	mO±_îr


208 c⁄° 
m©ch_èbÀ_t
 
	gtokís
 = {

209 { 
O±_bpi
, "bpi=%u" },

210 { 
O±_öô
, "init" },

211 { 
O±_¢≠shŸ
, "snapshot=%u" },

212 { 
O±_mode
, "mode=%o" },

213 { 
O±_uid
, "uid=%u" },

214 { 
O±_gid
, "gid=%u" },

215 { 
O±_dax
, "dax" },

216 { 
O±_d©a_cow
, "data_cow" },

217 { 
O±_w¥Ÿe˘
, "wprotect" },

218 { 
O±_îr_c⁄t
, "errors=continue" },

219 { 
O±_îr_∑nic
, "errors=panic" },

220 { 
O±_îr_ro
, "errors=remount-ro" },

221 { 
O±_dbgmask
, "dbgmask=%u" },

222 { 
O±_îr
, 
NULL
 },

225 
	$nova_∑r£_›ti⁄s
(*
›ti⁄s
, 
nova_sb_öfo
 *
sbi
,

226 
boﬁ
 
ªmou¡
)

228 *
p
;

229 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

230 
›ti⁄
;

231 
kuid_t
 
uid
;

233 i‡(!
›ti⁄s
)

236 (
p
 = 
	`°r£p
(&
›ti⁄s
, ",")Ë!
NULL
) {

237 
tokí
;

239 i‡(!*
p
)

242 
tokí
 = 
	`m©ch_tokí
(
p
, 
tokís
, 
¨gs
);

243 
tokí
) {

244 
O±_bpi
:

245 i‡(
	`m©ch_öt
(&
¨gs
[0], &
›ti⁄
))

246 
bad_vÆ
;

247 i‡(
ªmou¡
 && 
sbi
->
bpi
)

248 
bad_›t
;

249 
sbi
->
bpi
 = 
›ti⁄
;

251 
O±_uid
:

252 i‡(
	`m©ch_öt
(&
¨gs
[0], &
›ti⁄
))

253 
bad_vÆ
;

254 
uid
 = 
	`make_kuid
(
	`cuºít_u£r_ns
(), 
›ti⁄
);

255 i‡(
ªmou¡
 && !
	`uid_eq
(
sbi
->
uid
, uid))

256 
bad_›t
;

257 
sbi
->
uid
 = uid;

259 
O±_gid
:

260 i‡(
	`m©ch_öt
(&
¨gs
[0], &
›ti⁄
))

261 
bad_vÆ
;

262 
sbi
->
gid
 = 
	`make_kgid
(
	`cuºít_u£r_ns
(), 
›ti⁄
);

264 
O±_mode
:

265 i‡(
	`m©ch_o˘Æ
(&
¨gs
[0], &
›ti⁄
))

266 
bad_vÆ
;

267 
sbi
->
mode
 = 
›ti⁄
 & 01777U;

269 
O±_öô
:

270 i‡(
ªmou¡
)

271 
bad_›t
;

272 
	`£t_›t
(
sbi
->
s_mou¡_›t
, 
FORMAT
);

274 
O±_¢≠shŸ
:

275 i‡(
	`m©ch_öt
(&
¨gs
[0], &
›ti⁄
))

276 
bad_vÆ
;

277 
sbi
->
mou¡_¢≠shŸ
 = 1;

278 
sbi
->
mou¡_¢≠shŸ_ïoch_id
 = 
›ti⁄
;

280 
O±_îr_∑nic
:

281 
	`˛ór_›t
(
sbi
->
s_mou¡_›t
, 
ERRORS_CONT
);

282 
	`˛ór_›t
(
sbi
->
s_mou¡_›t
, 
ERRORS_RO
);

283 
	`£t_›t
(
sbi
->
s_mou¡_›t
, 
ERRORS_PANIC
);

285 
O±_îr_ro
:

286 
	`˛ór_›t
(
sbi
->
s_mou¡_›t
, 
ERRORS_CONT
);

287 
	`˛ór_›t
(
sbi
->
s_mou¡_›t
, 
ERRORS_PANIC
);

288 
	`£t_›t
(
sbi
->
s_mou¡_›t
, 
ERRORS_RO
);

290 
O±_îr_c⁄t
:

291 
	`˛ór_›t
(
sbi
->
s_mou¡_›t
, 
ERRORS_RO
);

292 
	`˛ór_›t
(
sbi
->
s_mou¡_›t
, 
ERRORS_PANIC
);

293 
	`£t_›t
(
sbi
->
s_mou¡_›t
, 
ERRORS_CONT
);

295 
O±_dax
:

296 
	`£t_›t
(
sbi
->
s_mou¡_›t
, 
DAX
);

298 
O±_d©a_cow
:

299 
	`£t_›t
(
sbi
->
s_mou¡_›t
, 
DATA_COW
);

300 
	`nova_öfo
("Enable copy-on-write updates\n");

302 
O±_w¥Ÿe˘
:

303 i‡(
ªmou¡
)

304 
bad_›t
;

305 
	`£t_›t
(
sbi
->
s_mou¡_›t
, 
PROTECT
);

306 
	`nova_öfo
("NOVA: EnablingÇew Write Protection (CR0.WP)\n");

308 
O±_dbgmask
:

309 i‡(
	`m©ch_öt
(&
¨gs
[0], &
›ti⁄
))

310 
bad_vÆ
;

311 
nova_dbgmask
 = 
›ti⁄
;

314 
bad_›t
;

321 
bad_vÆ
:

322 
	`nova_öfo
("Bad vÆuê'%s' f‹ mou¡ o±i⁄ '%s'\n", 
¨gs
[0].
‰om
,

323 
p
);

324  -
EINVAL
;

325 
bad_›t
:

326 
	`nova_öfo
("Bad mou¡ o±i⁄: \"%s\"\n", 
p
);

327  -
EINVAL
;

328 
	}
}

332 
boﬁ
 
	$nova_check_size
(
su≥r_block
 *
sb
, 
size
)

334 
möimum_size
;

337 
möimum_size
 = (
HEAD_RESERVED_BLOCKS
 + 
TAIL_RESERVED_BLOCKS
 + 1)

338 << 
sb
->
s_blocksize_bôs
;

340 i‡(
size
 < 
möimum_size
)

341  
Ál£
;

343  
åue
;

344 
	}
}

346 
ölöe
 
	$nova_check_su≥r_checksum
(
su≥r_block
 *
sb
)

348 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

349 
u32
 
¸c
 = 0;

352 
¸c
 = 
	`nova_¸c32c
(~0, (
__u8
 *)
sbi
->
nova_sb
 + (
__À32
),

353 (
nova_su≥r_block
Ë- (
__À32
));

355 i‡(
sbi
->
nova_sb
->
s_sum
 =
	`˝u_to_À32
(
¸c
))

359 
	}
}

361 
ölöe
 
	$nova_sync_su≥r
(
su≥r_block
 *
sb
)

363 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

364 
nova_su≥r_block
 *
su≥r
 = 
	`nova_gë_su≥r
(
sb
);

365 
nova_su≥r_block
 *
su≥r_ªdund
;

366 
úq_Êags
 = 0;

368 
	`nova_memu∆ock_su≥r
(
sb
, &
úq_Êags
);

370 
su≥r_ªdund
 = 
	`nova_gë_ªdund_su≥r
(
sb
);

372 
	`mem˝y_to_pmem_noˇche
((*)
su≥r
, (*)
sbi
->
nova_sb
,

373 (
nova_su≥r_block
));

374 
	`PERSISTENT_BARRIER
();

376 
	`mem˝y_to_pmem_noˇche
((*)
su≥r_ªdund
, (*)
sbi
->
nova_sb
,

377 (
nova_su≥r_block
));

378 
	`PERSISTENT_BARRIER
();

380 
	`nova_memlock_su≥r
(
sb
, &
úq_Êags
);

381 
	}
}

384 
ölöe
 
	$nova_upd©e_su≥r_¸c
(
su≥r_block
 *
sb
)

386 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

387 
u32
 
¸c
 = 0;

389 
sbi
->
nova_sb
->
s_wtime
 = 
	`˝u_to_À32
(
	`ktime_gë_£c⁄ds
());

390 
sbi
->
nova_sb
->
s_sum
 = 0;

391 
¸c
 = 
	`nova_¸c32c
(~0, (
__u8
 *)
sbi
->
nova_sb
 + (
__À32
),

392 (
nova_su≥r_block
Ë- (
__À32
));

393 
sbi
->
nova_sb
->
s_sum
 = 
	`˝u_to_À32
(
¸c
);

394 
	}
}

397 
ölöe
 
	$nova_upd©e_mou¡_time
(
su≥r_block
 *
sb
)

399 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

400 
u64
 
m¡_wrôe_time
;

402 
m¡_wrôe_time
 = (
	`ktime_gë_£c⁄ds
() & 0xFFFFFFFF);

403 
m¡_wrôe_time
 = mnt_write_time | (mnt_write_time << 32);

405 
sbi
->
nova_sb
->
s_mtime
 = 
	`˝u_to_À64
(
m¡_wrôe_time
);

406 
	`nova_upd©e_su≥r_¸c
(
sb
);

408 
	`nova_sync_su≥r
(
sb
);

409 
	}
}

411 
nova_öode
 *
	$nova_öô
(
su≥r_block
 *
sb
,

412 
size
)

414 
blocksize
;

415 
nova_öode
 *
roŸ_i
, *
pi
;

416 
nova_su≥r_block
 *
su≥r
;

417 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

418 
nova_öode_upd©e
 
upd©e
;

419 
u64
 
ïoch_id
;

420 
úq_Êags
 = 0;

421 
	`INIT_TIMING
(
öô_time
);

423 
	`NOVA_START_TIMING
(
√w_öô_t
, 
öô_time
);

424 
	`nova_öfo
("¸ótögá¿em±yÇov®o‡sizê%lu\n", 
size
);

425 
sbi
->
num_blocks
 = (()(
size
Ë>> 
PAGE_SHIFT
);

427 
	`nova_dbgv
("nova: Default block size setÅo 4K\n");

428 
sbi
->
blocksize
 = blocksizê
NOVA_DEF_BLOCK_SIZE_4K
;

429 
	`nova_£t_blocksize
(
sb
, 
sbi
->
blocksize
);

431 i‡(!
	`nova_check_size
(
sb
, 
size
)) {

432 
	`nova_w¨n
("S≥cifõd NOVA sizêtoÿsmÆ»0x%lx.\n", 
size
);

433  
	`ERR_PTR
(-
EINVAL
);

436 
	`nova_dbgv
("max fûê«mêÀ¿%d\n", ()
NOVA_NAME_LEN
);

438 
su≥r
 = 
	`nova_gë_su≥r
(
sb
);

440 
	`nova_memu∆ock_ª£rved
(
sb
, 
su≥r
, &
úq_Êags
);

442 
	`mem£t_¡
(
su≥r
, 0, 
sbi
->
hód_ª£rved_blocks
 * sbi->
blocksize
);

444 
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_BLOCKNODE_INO
);

445 
pi
->
nova_öo
 = 
NOVA_BLOCKNODE_INO
;

446 
	`nova_Êush_buf„r
(
pi
, 
CACHELINE_SIZE
, 1);

448 
pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_SNAPSHOT_INO
);

449 
pi
->
nova_öo
 = 
NOVA_SNAPSHOT_INO
;

450 
	`nova_Êush_buf„r
(
pi
, 
CACHELINE_SIZE
, 1);

452 
	`mem£t
(&
upd©e
, 0, (
nova_öode_upd©e
));

453 
	`nova_upd©e_öode
(
sb
, &
sbi
->
¢≠shŸ_si
->
vfs_öode
, 
pi
, &
upd©e
, 1);

455 
	`nova_memlock_ª£rved
(
sb
, 
su≥r
, &
úq_Êags
);

457 
	`nova_öô_blockm≠
(
sb
, 0);

459 i‡(
	`nova_lôe_jou∫Æ_h¨d_öô
(
sb
) < 0) {

460 
	`nova_îr
(
sb
, "Lite journal hard initialization failed\n");

461  
	`ERR_PTR
(-
EINVAL
);

464 i‡(
	`nova_öô_öode_öu£_li°
(
sb
) < 0)

465  
	`ERR_PTR
(-
EINVAL
);

467 i‡(
	`nova_öô_öode_èbÀ
(
sb
) < 0)

468  
	`ERR_PTR
(-
EINVAL
);

471 
sbi
->
nova_sb
->
s_size
 = 
	`˝u_to_À64
(
size
);

472 
sbi
->
nova_sb
->
s_blocksize
 = 
	`˝u_to_À32
(
blocksize
);

473 
sbi
->
nova_sb
->
s_magic
 = 
	`˝u_to_À32
(
NOVA_SUPER_MAGIC
);

474 
sbi
->
nova_sb
->
s_ïoch_id
 = 0;

475 
sbi
->
nova_sb
->
s_mëad©a_csum
 = 
mëad©a_csum
;

476 
sbi
->
nova_sb
->
s_d©a_csum
 = 
d©a_csum
;

477 
sbi
->
nova_sb
->
s_d©a_∑rôy
 = 
d©a_∑rôy
;

478 
	`nova_upd©e_su≥r_¸c
(
sb
);

480 
	`nova_sync_su≥r
(
sb
);

482 
roŸ_i
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_ROOT_INO
);

483 
	`nova_dbgv
("%s: AŒoˇãÑoŸ inodê@ 0x%p\n", 
__func__
, 
roŸ_i
);

485 
	`nova_memu∆ock_öode
(
sb
, 
roŸ_i
, &
úq_Êags
);

486 
roŸ_i
->
i_mode
 = 
	`˝u_to_À16
(
sbi
->
mode
 | 
S_IFDIR
);

487 
roŸ_i
->
i_uid
 = 
	`˝u_to_À32
(
	`‰om_kuid
(&
öô_u£r_ns
, 
sbi
->
uid
));

488 
roŸ_i
->
i_gid
 = 
	`˝u_to_À32
(
	`‰om_kgid
(&
öô_u£r_ns
, 
sbi
->
gid
));

489 
roŸ_i
->
i_löks_cou¡
 = 
	`˝u_to_À16
(2);

490 
roŸ_i
->
i_blk_ty≥
 = 
NOVA_BLOCK_TYPE_4K
;

491 
roŸ_i
->
i_Êags
 = 0;

492 
roŸ_i
->
i_size
 = 
	`˝u_to_À64
(
sb
->
s_blocksize
);

493 
roŸ_i
->
i_©ime
 =ÑoŸ_i->
i_mtime
 =ÑoŸ_i->
i_˘ime
 =

494 
	`˝u_to_À32
(
	`ktime_gë_£c⁄ds
());

495 
roŸ_i
->
nova_öo
 = 
	`˝u_to_À64
(
NOVA_ROOT_INO
);

496 
roŸ_i
->
vÆid
 = 1;

498 
	`nova_Êush_buf„r
(
roŸ_i
, (*roŸ_i), 
Ál£
);

499 
	`nova_memlock_öode
(
sb
, 
roŸ_i
, &
úq_Êags
);

501 
ïoch_id
 = 
	`nova_gë_ïoch_id
(
sb
);

502 
	`nova_≠≥nd_dú_öô_íåõs
(
sb
, 
roŸ_i
, 
NOVA_ROOT_INO
,

503 
NOVA_ROOT_INO
, 
ïoch_id
);

505 
	`PERSISTENT_MARK
();

506 
	`PERSISTENT_BARRIER
();

507 
	`NOVA_END_TIMING
(
√w_öô_t
, 
öô_time
);

508 
	`nova_öfo
("NOVA initialization finish\n");

509  
roŸ_i
;

510 
	}
}

512 
ölöe
 
	$£t_deÁu…_›ts
(
nova_sb_öfo
 *
sbi
)

514 
	`£t_›t
(
sbi
->
s_mou¡_›t
, 
HUGEIOREMAP
);

515 
	`£t_›t
(
sbi
->
s_mou¡_›t
, 
ERRORS_CONT
);

516 
sbi
->
hód_ª£rved_blocks
 = 
HEAD_RESERVED_BLOCKS
;

517 
sbi
->
èû_ª£rved_blocks
 = 
TAIL_RESERVED_BLOCKS
;

518 
sbi
->
˝us
 = 
	`num_⁄löe_˝us
();

519 
	`nova_öfo
("%d cpu†⁄löe\n", 
sbi
->
˝us
);

520 
sbi
->
m≠_id
 = 0;

521 
sbi
->
¢≠shŸ_si
 = 
NULL
;

522 
	}
}

524 
	$nova_roŸ_check
(
su≥r_block
 *
sb
, 
nova_öode
 *
roŸ_pi
)

526 i‡(!
	`S_ISDIR
(
	`À16_to_˝u
(
roŸ_pi
->
i_mode
)))

527 
	`nova_w¨n
("root isÇotá directory!\n");

528 
	}
}

531 
	$nova_check_su≥r
(
su≥r_block
 *
sb
,

532 
nova_su≥r_block
 *
ps
)

534 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

535 
rc
 = 0;

537 i‡(
	`mem˝y
(
sbi
->
nova_sb
, 
ps
, (
nova_su≥r_block
))

538 =
NULL
)

539 
rc
 = -1;

541 i‡(
rc
 < 0)

542  
rc
;

544 i‡(
	`À32_to_˝u
(
sbi
->
nova_sb
->
s_magic
Ë!
NOVA_SUPER_MAGIC
)

545  -
EIO
;

547 i‡(
	`nova_check_su≥r_checksum
(
sb
))

548  -
EIO
;

551 
	}
}

555 
	$nova_check_moduÀ_∑øms
(
su≥r_block
 *
sb
)

557 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

559 i‡(
sbi
->
nova_sb
->
s_mëad©a_csum
 !
mëad©a_csum
) {

560 
	`nova_dbg
("%s metadata checksum\n",

561 
sbi
->
nova_sb
->
s_mëad©a_csum
 ? "Enable" : "Disable");

562 
mëad©a_csum
 = 
sbi
->
nova_sb
->
s_mëad©a_csum
;

565 i‡(
sbi
->
nova_sb
->
s_d©a_csum
 !
d©a_csum
) {

566 
	`nova_dbg
("%s data checksum\n",

567 
sbi
->
nova_sb
->
s_d©a_csum
 ? "Enable" : "Disable");

568 
d©a_csum
 = 
sbi
->
nova_sb
->
s_d©a_csum
;

571 i‡(
sbi
->
nova_sb
->
s_d©a_∑rôy
 !
d©a_∑rôy
) {

572 
	`nova_dbg
("%s dataÖarity\n",

573 
sbi
->
nova_sb
->
s_d©a_∑rôy
 ? "Enable" : "Disable");

574 
d©a_∑rôy
 = 
sbi
->
nova_sb
->
s_d©a_∑rôy
;

578 
	}
}

580 
	$nova_check_öãgrôy
(
su≥r_block
 *
sb
)

582 
nova_su≥r_block
 *
su≥r
 = 
	`nova_gë_su≥r
(
sb
);

583 
nova_su≥r_block
 *
su≥r_ªdund
;

584 
rc
;

586 
su≥r_ªdund
 = 
	`nova_gë_ªdund_su≥r
(
sb
);

589 
rc
 = 
	`nova_check_su≥r
(
sb
, 
su≥r
);

590 i‡(
rc
 < 0) {

591 
rc
 = 
	`nova_check_su≥r
(
sb
, 
su≥r_ªdund
);

592 i‡(
rc
 < 0) {

593 
	`nova_îr
(
sb
, "Can't findá validÇovaÖartition\n");

594  
rc
;

596 
	`nova_w¨n
("Error in super block:ÅryÅoÑepair it withÅhe other copy\n");

600 
	`nova_sync_su≥r
(
sb
);

602 
	`nova_check_moduÀ_∑øms
(
sb
);

604 
	}
}

606 
	$nova_fûl_su≥r
(
su≥r_block
 *
sb
, *
d©a
, 
sûít
)

608 
nova_öode
 *
roŸ_pi
;

609 
nova_sb_öfo
 *
sbi
 = 
NULL
;

610 
öode
 *
roŸ_i
 = 
NULL
;

611 
öode_m≠
 *inode_map;

612 
blocksize
;

613 
size_t
 
°Ω_size
 = 
NOVA_STRIPE_SIZE
;

614 
u32
 
øndom
 = 0;

615 
ªtvÆ
 = -
EINVAL
;

616 
i
;

617 
	`INIT_TIMING
(
mou¡_time
);

619 
	`NOVA_START_TIMING
(
mou¡_t
, 
mou¡_time
);

621 
	`BUILD_BUG_ON
((
nova_su≥r_block
Ë> 
NOVA_SB_SIZE
);

622 
	`BUILD_BUG_ON
((
nova_öode
Ë> 
NOVA_INODE_SIZE
);

623 
	`BUILD_BUG_ON
((
nova_öode_log_∑ge
Ë!
PAGE_SIZE
);

625 
	`BUILD_BUG_ON
((
jou∫Æ_±r_∑ú
Ë> 
CACHELINE_SIZE
);

626 
	`BUILD_BUG_ON
(
PAGE_SIZE
/(
nova_lôe_jou∫Æ_íåy
) <

627 
NOVA_MAX_JOURNAL_LENGTH
);

629 
	`BUILD_BUG_ON
((
nova_öode_∑ge_èû
) +

630 
LOG_BLOCK_TAIL
 !
PAGE_SIZE
);

632 
sbi
 = 
	`kzÆloc
((
nova_sb_öfo
), 
GFP_KERNEL
);

633 i‡(!
sbi
)

634  -
ENOMEM
;

635 
sbi
->
nova_sb
 = 
	`kzÆloc
((
nova_su≥r_block
), 
GFP_KERNEL
);

636 i‡(!
sbi
->
nova_sb
) {

637 
	`k‰ì
(
sbi
);

638  -
ENOMEM
;

641 
sb
->
s_fs_öfo
 = 
sbi
;

642 
sbi
->
sb
 = sb;

644 
	`£t_deÁu…_›ts
(
sbi
);

647 i‡(
sbi
->
˝us
 > 
MAX_CPUS
) {

648 
	`nova_îr
(
sb
, "NOVAÇeeds moreÜogÖointerÖagesÅo support moreÅhan "

649 
	`__°rögify
(
MAX_CPUS
) " cpus.\n");

650 
out
;

653 
ªtvÆ
 = 
	`nova_gë_nvmm_öfo
(
sb
, 
sbi
);

654 i‡(
ªtvÆ
) {

655 
	`nova_îr
(
sb
, "%s: FailedÅo getÇvmm info.",

656 
__func__
);

657 
out
;

661 
	`nova_dbg
("measureÅiming %d, metadata checksum %d, wprotect %d, data checksum %d, dataÖarity %d, DRAM checksum %d\n",

662 
mósuª_timög
, 
mëad©a_csum
,

663 
w¥Ÿe˘
, 
d©a_csum
,

664 
d©a_∑rôy
, 
døm_°ru˘_csum
);

666 
	`gë_øndom_byãs
(&
øndom
, (
u32
));

667 
	`©omic_£t
(&
sbi
->
√xt_gíî©i⁄
, 
øndom
);

670 
sbi
->
mode
 = (0755);

671 
sbi
->
uid
 = 
	`cuºít_fsuid
();

672 
sbi
->
gid
 = 
	`cuºít_fsgid
();

673 
	`£t_›t
(
sbi
->
s_mou¡_›t
, 
HUGEIOREMAP
);

675 
	`muãx_öô
(&
sbi
->
vma_muãx
);

676 
	`INIT_LIST_HEAD
(&
sbi
->
mm≠_sih_li°
);

678 
sbi
->
öode_m≠s
 = 
	`kˇŒoc
(sbi->
˝us
, (
öode_m≠
),

679 
GFP_KERNEL
);

680 i‡(!
sbi
->
öode_m≠s
) {

681 
ªtvÆ
 = -
ENOMEM
;

682 
	`nova_dbg
("%s: Allocating inode maps failed.",

683 
__func__
);

684 
out
;

687 
i
 = 0; i < 
sbi
->
˝us
; i++) {

688 
öode_m≠
 = &
sbi
->
öode_m≠s
[
i
];

689 
	`muãx_öô
(&
öode_m≠
->
öode_èbÀ_muãx
);

690 
öode_m≠
->
öode_öu£_åì
 = 
RB_ROOT
;

693 
	`muãx_öô
(&
sbi
->
s_lock
);

695 
sbi
->
zî€d_∑ge
 = 
	`kzÆloc
(
PAGE_SIZE
, 
GFP_KERNEL
);

696 i‡(!
sbi
->
zî€d_∑ge
) {

697 
ªtvÆ
 = -
ENOMEM
;

698 
	`nova_dbg
("%s: sbi->zeroed_page failed.",

699 
__func__
);

700 
out
;

703 
i
 = 0; i < 8; i++)

704 
sbi
->
zîo_csum
[
i
] = 
	`nova_¸c32c
(
NOVA_INIT_CSUM
,

705 
sbi
->
zî€d_∑ge
, 
°Ω_size
);

706 
sbi
->
zîo_∑rôy
 = 
	`kzÆloc
(
°Ω_size
, 
GFP_KERNEL
);

708 i‡(!
sbi
->
zîo_∑rôy
) {

709 
ªtvÆ
 = -
ENOMEM
;

710 
	`nova_îr
(
sb
, "%s: sbi->zero_parity failed.",

711 
__func__
);

712 
out
;

715 
sbi
->
¢≠shŸ_si
 = 
	`kmem_ˇche_Æloc
(
nova_öode_ˇchï
, 
GFP_NOFS
);

716 
	`nova_¢≠shŸ_öô
(
sb
);

718 
ªtvÆ
 = 
	`nova_∑r£_›ti⁄s
(
d©a
, 
sbi
, 0);

719 i‡(
ªtvÆ
) {

720 
	`nova_îr
(
sb
, "%s: FailedÅoÖarseÇova commandÜine options.",

721 
__func__
);

722 
out
;

725 i‡(
sbi
->
mou¡_¢≠shŸ
) {

726 
sb
->
s_Êags
 |
MS_RDONLY
;

727 
	`nova_öfo
("Snapshot: mount NOVAÑead-only\n");

730 i‡(
	`nova_Æloc_block_‰ì_li°s
(
sb
)) {

731 
ªtvÆ
 = -
ENOMEM
;

732 
	`nova_îr
(
sb
, "%s: FailedÅoállocate block freeÜists.",

733 
__func__
);

734 
out
;

737 
	`nova_sysfs_öô
(
sb
);

740 i‡(
sbi
->
s_mou¡_›t
 & 
NOVA_MOUNT_FORMAT
) {

741 
roŸ_pi
 = 
	`nova_öô
(
sb
, 
sbi
->
öôsize
);

742 
ªtvÆ
 = -
ENOMEM
;

743 i‡(
	`IS_ERR
(
roŸ_pi
)) {

744 
	`nova_îr
(
sb
, "%s:Ñoot_piÉrror.",

745 
__func__
);

747 
out
;

749 
£tup_sb
;

752 
	`nova_dbg_vîbo£
("checkingÖhysicaláddress 0x%016llx forÇova image\n",

753 (
u64
)
sbi
->
phys_addr
);

755 i‡(
	`nova_check_öãgrôy
(
sb
) < 0) {

756 
ªtvÆ
 = -
EINVAL
;

757 
	`nova_dbg
("Memory contains invalidÇova %x:%x\n",

758 
	`À32_to_˝u
(
sbi
->
nova_sb
->
s_magic
), 
NOVA_SUPER_MAGIC
);

759 
out
;

762 i‡(
	`nova_lôe_jou∫Æ_so·_öô
(
sb
)) {

763 
ªtvÆ
 = -
EINVAL
;

764 
	`nova_îr
(
sb
, "Lite journal initialization failed\n");

765 
out
;

768 i‡(
sbi
->
mou¡_¢≠shŸ
) {

769 
ªtvÆ
 = 
	`nova_mou¡_¢≠shŸ
(
sb
);

770 i‡(
ªtvÆ
) {

771 
	`nova_îr
(
sb
, "Mount snapshot failed\n");

772 
out
;

776 
blocksize
 = 
	`À32_to_˝u
(
sbi
->
nova_sb
->
s_blocksize
);

777 
	`nova_£t_blocksize
(
sb
, 
blocksize
);

779 
	`nova_dbg_vîbo£
("blocksizê%lu\n", 
blocksize
);

782 
roŸ_pi
 = 
	`nova_gë_öode_by_öo
(
sb
, 
NOVA_ROOT_INO
);

785 
	`nova_roŸ_check
(
sb
, 
roŸ_pi
);

788 
£tup_sb
:

789 
sb
->
s_magic
 = 
	`À32_to_˝u
(
sbi
->
nova_sb
->s_magic);

790 
sb
->
s_›
 = &
nova_s›s
;

791 
sb
->
s_maxbyãs
 = 
	`nova_max_size
(sb->
s_blocksize_bôs
);

792 
sb
->
s_time_gøn
 = 1000000000;

793 
sb
->
s_exp‹t_›
 = &
nova_exp‹t_›s
;

794 
sb
->
s_x©å
 = 
NULL
;

795 
sb
->
s_Êags
 |
MS_NOSEC
;

800 i‡((
sbi
->
s_mou¡_›t
 & 
NOVA_MOUNT_FORMAT
) == 0) {

801 
ªtvÆ
 = 
	`nova_ªcovîy
(
sb
);

802 i‡(
ªtvÆ
 < 0) {

803 
	`nova_îr
(
sb
, "%s:ÇovaÑecovery failed withÑeturn code %d\n",

804 
__func__
, 
ªtvÆ
);

805 
out
;

809 
roŸ_i
 = 
	`nova_igë
(
sb
, 
NOVA_ROOT_INO
);

810 i‡(
	`IS_ERR
(
roŸ_i
)) {

811 
ªtvÆ
 = 
	`PTR_ERR
(
roŸ_i
);

812 
	`nova_îr
(
sb
, "%s: failedÅo getÑoot inode",

813 
__func__
);

815 
out
;

818 
sb
->
s_roŸ
 = 
	`d_make_roŸ
(
roŸ_i
);

819 i‡(!
sb
->
s_roŸ
) {

820 
	`nova_îr
(
sb
, "getÇovaÑoot inode failed\n");

821 
ªtvÆ
 = -
ENOMEM
;

822 
out
;

825 i‡(!(
sb
->
s_Êags
 & 
MS_RDONLY
))

826 
	`nova_upd©e_mou¡_time
(
sb
);

828 
	`nova_¥öt_cuº_ïoch_id
(
sb
);

830 
ªtvÆ
 = 0;

831 
	`NOVA_END_TIMING
(
mou¡_t
, 
mou¡_time
);

832  
ªtvÆ
;

834 
out
:

835 i‡(
sbi
->
¢≠shŸ_si
) {

836 
	`kmem_ˇche_‰ì
(
nova_öode_ˇchï
, 
sbi
->
¢≠shŸ_si
);

837 
sbi
->
¢≠shŸ_si
 = 
NULL
;

840 
	`k‰ì
(
sbi
->
zî€d_∑ge
);

841 
sbi
->
zî€d_∑ge
 = 
NULL
;

843 
	`k‰ì
(
sbi
->
zîo_∑rôy
);

844 
sbi
->
zîo_∑rôy
 = 
NULL
;

846 
	`k‰ì
(
sbi
->
‰ì_li°s
);

847 
sbi
->
‰ì_li°s
 = 
NULL
;

849 
	`k‰ì
(
sbi
->
jou∫Æ_locks
);

850 
sbi
->
jou∫Æ_locks
 = 
NULL
;

852 
	`k‰ì
(
sbi
->
öode_m≠s
);

853 
sbi
->
öode_m≠s
 = 
NULL
;

855 
	`nova_sysfs_exô
(
sb
);

857 
	`k‰ì
(
sbi
->
nova_sb
);

858 
	`k‰ì
(
sbi
);

859 
	`nova_dbg
("%†Áûed:Ñëu∫ %d\n", 
__func__
, 
ªtvÆ
);

860  
ªtvÆ
;

861 
	}
}

863 
	$nova_°©fs
(
díåy
 *
d
, 
k°©fs
 *
buf
)

865 
su≥r_block
 *
sb
 = 
d
->
d_sb
;

866 
nova_sb_öfo
 *
sbi
 = (nova_sb_öfÿ*)
sb
->
s_fs_öfo
;

868 
buf
->
f_ty≥
 = 
NOVA_SUPER_MAGIC
;

869 
buf
->
f_bsize
 = 
sb
->
s_blocksize
;

871 
buf
->
f_blocks
 = 
sbi
->
num_blocks
;

872 
buf
->
f_b‰ì
 = buf->
f_bavaû
 = 
	`nova_cou¡_‰ì_blocks
(
sb
);

873 
buf
->
f_fûes
 = 
LONG_MAX
;

874 
buf
->
f_f‰ì
 = 
LONG_MAX
 - 
sbi
->
s_öodes_u£d_cou¡
;

875 
buf
->
f_«mñí
 = 
NOVA_NAME_LEN
;

876 
	`nova_dbg_vîbo£
("nova_stats:Åotal 4k free blocks 0x%llx\n",

877 
buf
->
f_b‰ì
);

879 
	}
}

881 
	$nova_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
)

883 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
roŸ
->
d_sb
);

892 i‡(
sbi
->
mode
 !(0777 | 
S_ISVTX
))

893 
	`£q_¥ötf
(
£q
, ",mode=%03o", 
sbi
->
mode
);

894 i‡(
	`uid_vÆid
(
sbi
->
uid
))

895 
	`£q_¥ötf
(
£q
, ",uid=%u", 
	`‰om_kuid
(&
öô_u£r_ns
, 
sbi
->
uid
));

896 i‡(
	`gid_vÆid
(
sbi
->
gid
))

897 
	`£q_¥ötf
(
£q
, ",gid=%u", 
	`‰om_kgid
(&
öô_u£r_ns
, 
sbi
->
gid
));

898 i‡(
	`ã°_›t
(
roŸ
->
d_sb
, 
ERRORS_RO
))

899 
	`£q_puts
(
£q
, ",errors=remount-ro");

900 i‡(
	`ã°_›t
(
roŸ
->
d_sb
, 
ERRORS_PANIC
))

901 
	`£q_puts
(
£q
, ",errors=panic");

903 i‡(
	`ã°_›t
(
roŸ
->
d_sb
, 
PROTECT
))

904 
	`£q_puts
(
£q
, ",wprotect");

905 i‡(
	`ã°_›t
(
roŸ
->
d_sb
, 
DAX
))

906 
	`£q_puts
(
£q
, ",dax");

909 
	}
}

911 
	$nova_ªmou¡
(
su≥r_block
 *
sb
, *
m¡Êags
, *
d©a
)

913 
ﬁd_sb_Êags
;

914 
ﬁd_mou¡_›t
;

915 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

916 
ªt
 = -
EINVAL
;

919 
	`muãx_lock
(&
sbi
->
s_lock
);

920 
ﬁd_sb_Êags
 = 
sb
->
s_Êags
;

921 
ﬁd_mou¡_›t
 = 
sbi
->
s_mou¡_›t
;

923 i‡(
	`nova_∑r£_›ti⁄s
(
d©a
, 
sbi
, 1))

924 
ª°‹e_›t
;

926 
sb
->
s_Êags
 = (sb->s_Êag†& ~
MS_POSIXACL
) |

927 ((
sbi
->
s_mou¡_›t
 & 
NOVA_MOUNT_POSIX_ACL
) ?

928 
MS_POSIXACL
 : 0);

930 i‡((*
m¡Êags
 & 
MS_RDONLY
Ë!(
sb
->
s_Êags
 & MS_RDONLY))

931 
	`nova_upd©e_mou¡_time
(
sb
);

933 
	`muãx_u∆ock
(&
sbi
->
s_lock
);

934 
ªt
 = 0;

935  
ªt
;

937 
ª°‹e_›t
:

938 
sb
->
s_Êags
 = 
ﬁd_sb_Êags
;

939 
sbi
->
s_mou¡_›t
 = 
ﬁd_mou¡_›t
;

940 
	`muãx_u∆ock
(&
sbi
->
s_lock
);

941  
ªt
;

942 
	}
}

944 
	$nova_put_su≥r
(
su≥r_block
 *
sb
)

946 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

947 
öode_m≠
 *inode_map;

948 
i
;

950 
	`nova_¥öt_cuº_ïoch_id
(
sb
);

954 i‡(
sbi
->
vút_addr
) {

955 
	`nova_ßve_¢≠shŸs
(
sb
);

956 
	`kmem_ˇche_‰ì
(
nova_öode_ˇchï
, 
sbi
->
¢≠shŸ_si
);

957 
	`nova_ßve_öode_li°_to_log
(
sb
);

959 
	`nova_ßve_blocknode_m≠pögs_to_log
(
sb
);

960 
sbi
->
vút_addr
 = 
NULL
;

963 
	`nova_dñëe_‰ì_li°s
(
sb
);

965 
	`k‰ì
(
sbi
->
zî€d_∑ge
);

966 
	`k‰ì
(
sbi
->
zîo_∑rôy
);

967 
nova_dbgmask
 = 0;

968 
	`k‰ì
(
sbi
->
‰ì_li°s
);

969 
	`k‰ì
(
sbi
->
jou∫Æ_locks
);

971 
i
 = 0; i < 
sbi
->
˝us
; i++) {

972 
öode_m≠
 = &
sbi
->
öode_m≠s
[
i
];

973 
	`nova_dbgv
("CPU %d: inodeállocated %d, freed %d\n",

974 
i
, 
öode_m≠
->
Æloˇãd
, inode_m≠->
‰ìd
);

977 
	`k‰ì
(
sbi
->
öode_m≠s
);

979 
	`nova_sysfs_exô
(
sb
);

981 
	`k‰ì
(
sbi
->
nova_sb
);

982 
	`k‰ì
(
sbi
);

983 
sb
->
s_fs_öfo
 = 
NULL
;

984 
	}
}

986 
	$nova_‰ì_ønge_node
(
nova_ønge_node
 *
node
)

988 
	`kmem_ˇche_‰ì
(
nova_ønge_node_ˇchï
, 
node
);

989 
	}
}

992 
	$nova_‰ì_öode_node
(
nova_ønge_node
 *
node
)

994 
	`nova_‰ì_ønge_node
(
node
);

995 
	}
}

997 
	$nova_‰ì_dú_node
(
nova_ønge_node
 *
node
)

999 
	`nova_‰ì_ønge_node
(
node
);

1000 
	}
}

1002 
	$nova_‰ì_vma_ôem
(
su≥r_block
 *
sb
,

1003 
vma_ôem
 *
ôem
)

1005 
	`nova_‰ì_ønge_node
((
nova_ønge_node
 *)
ôem
);

1006 
	}
}

1008 
¢≠shŸ_öfo
 *
	$nova_Æloc_¢≠shŸ_öfo
(
su≥r_block
 *
sb
)

1010 
¢≠shŸ_öfo
 *
p
;

1012 
p
 = (
¢≠shŸ_öfo
 *)

1013 
	`kmem_ˇche_Æloc
(
nova_¢≠shŸ_öfo_ˇchï
, 
GFP_NOFS
);

1014  
p
;

1015 
	}
}

1017 
	$nova_‰ì_¢≠shŸ_öfo
(
¢≠shŸ_öfo
 *
öfo
)

1019 
	`kmem_ˇche_‰ì
(
nova_¢≠shŸ_öfo_ˇchï
, 
öfo
);

1020 
	}
}

1022 
nova_ønge_node
 *
	$nova_Æloc_ønge_node_©omic
(
su≥r_block
 *
sb
)

1024 
nova_ønge_node
 *
p
;

1026 
p
 = (
nova_ønge_node
 *)

1027 
	`kmem_ˇche_zÆloc
(
nova_ønge_node_ˇchï
, 
GFP_ATOMIC
);

1028  
p
;

1029 
	}
}

1031 
nova_ønge_node
 *
	$nova_Æloc_ønge_node
(
su≥r_block
 *
sb
)

1033 
nova_ønge_node
 *
p
;

1035 
p
 = (
nova_ønge_node
 *)

1036 
	`kmem_ˇche_zÆloc
(
nova_ønge_node_ˇchï
, 
GFP_NOFS
);

1037  
p
;

1038 
	}
}

1041 
nova_ønge_node
 *
	$nova_Æloc_öode_node
(
su≥r_block
 *
sb
)

1043  
	`nova_Æloc_ønge_node
(
sb
);

1044 
	}
}

1046 
nova_ønge_node
 *
	$nova_Æloc_dú_node
(
su≥r_block
 *
sb
)

1048  
	`nova_Æloc_ønge_node
(
sb
);

1049 
	}
}

1051 
vma_ôem
 *
	$nova_Æloc_vma_ôem
(
su≥r_block
 *
sb
)

1053  (
vma_ôem
 *)
	`nova_Æloc_ønge_node
(
sb
);

1054 
	}
}

1057 
öode
 *
	$nova_Æloc_öode
(
su≥r_block
 *
sb
)

1059 
nova_öode_öfo
 *
vi
;

1061 
vi
 = 
	`kmem_ˇche_Æloc
(
nova_öode_ˇchï
, 
GFP_NOFS
);

1062 i‡(!
vi
)

1063  
NULL
;

1065 
	`©omic64_£t
(&
vi
->
vfs_öode
.
i_vîsi⁄
, 1);

1067  &
vi
->
vfs_öode
;

1068 
	}
}

1070 
	$nova_i_ˇŒback
(
rcu_hód
 *
hód
)

1072 
öode
 *öodê
	`c⁄èöî_of
(
hód
, öode, 
i_rcu
);

1073 
nova_öode_öfo
 *
vi
 = 
	`NOVA_I
(
öode
);

1075 
	`nova_dbg_vîbo£
("%s: inÿ%lu\n", 
__func__
, 
öode
->
i_öo
);

1076 
	`kmem_ˇche_‰ì
(
nova_öode_ˇchï
, 
vi
);

1077 
	}
}

1079 
	$nova_de°roy_öode
(
öode
 *inode)

1081 
	`nova_dbgv
("%s: %lu\n", 
__func__
, 
öode
->
i_öo
);

1082 
	`ˇŒ_rcu
(&
öode
->
i_rcu
, 
nova_i_ˇŒback
);

1083 
	}
}

1085 
	$öô_⁄˚
(*
foo
)

1087 
nova_öode_öfo
 *
vi
 = 
foo
;

1089 
	`öode_öô_⁄˚
(&
vi
->
vfs_öode
);

1090 
	}
}

1093 
__öô
 
	$öô_øngíode_ˇche
()

1095 
nova_ønge_node_ˇchï
 = 
	`kmem_ˇche_¸óã
("nova_range_node_cache",

1096 (
nova_ønge_node
),

1097 0, (
SLAB_RECLAIM_ACCOUNT
 |

1098 
SLAB_MEM_SPREAD
), 
NULL
);

1099 i‡(
nova_ønge_node_ˇchï
 =
NULL
)

1100  -
ENOMEM
;

1102 
	}
}

1104 
__öô
 
	$öô_¢≠shŸ_öfo_ˇche
()

1106 
nova_¢≠shŸ_öfo_ˇchï
 = 
	`kmem_ˇche_¸óã
(

1108 (
¢≠shŸ_öfo
),

1109 0, (
SLAB_RECLAIM_ACCOUNT
 |

1110 
SLAB_MEM_SPREAD
), 
NULL
);

1111 i‡(
nova_¢≠shŸ_öfo_ˇchï
 =
NULL
)

1112  -
ENOMEM
;

1114 
	}
}

1116 
__öô
 
	$öô_öodeˇche
()

1118 
nova_öode_ˇchï
 = 
	`kmem_ˇche_¸óã
("nova_inode_cache",

1119 (
nova_öode_öfo
),

1120 0, (
SLAB_RECLAIM_ACCOUNT
 |

1121 
SLAB_MEM_SPREAD
), 
öô_⁄˚
);

1122 i‡(
nova_öode_ˇchï
 =
NULL
)

1123  -
ENOMEM
;

1125 
	}
}

1127 
	$de°roy_öodeˇche
()

1133 
	`rcu_b¨rõr
();

1134 
	`kmem_ˇche_de°roy
(
nova_öode_ˇchï
);

1135 
	}
}

1137 
	$de°roy_øngíode_ˇche
()

1139 
	`kmem_ˇche_de°roy
(
nova_ønge_node_ˇchï
);

1140 
	}
}

1142 
	$de°roy_¢≠shŸ_öfo_ˇche
()

1144 
	`kmem_ˇche_de°roy
(
nova_¢≠shŸ_öfo_ˇchï
);

1145 
	}
}

1152 
su≥r_›î©i⁄s
 
	gnova_s›s
 = {

1153 .
Æloc_öode
 = 
nova_Æloc_öode
,

1154 .
	gde°roy_öode
 = 
nova_de°roy_öode
,

1155 .
	gwrôe_öode
 = 
nova_wrôe_öode
,

1156 .
	gdúty_öode
 = 
nova_dúty_öode
,

1157 .
	gevi˘_öode
 = 
nova_evi˘_öode
,

1158 .
	gput_su≥r
 = 
nova_put_su≥r
,

1159 .
	g°©fs
 = 
nova_°©fs
,

1160 .
	gªmou¡_fs
 = 
nova_ªmou¡
,

1161 .
	gshow_›ti⁄s
 = 
nova_show_›ti⁄s
,

1164 
díåy
 *
	$nova_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
,

1165 
Êags
, c⁄° *
dev_«me
, *
d©a
)

1167  
	`mou¡_bdev
(
fs_ty≥
, 
Êags
, 
dev_«me
, 
d©a
, 
nova_fûl_su≥r
);

1168 
	}
}

1170 
fûe_sy°em_ty≥
 
	gnova_fs_ty≥
 = {

1171 .
ow√r
 = 
THIS_MODULE
,

1172 .
	g«me
 = "NOVA",

1173 .
	gmou¡
 = 
nova_mou¡
,

1174 .
	gkûl_sb
 = 
kûl_block_su≥r
,

1177 
öode
 *
	$nova_nfs_gë_öode
(
su≥r_block
 *
sb
,

1178 
u64
 
öo
, 
u32
 
gíî©i⁄
)

1180 
öode
 *inode;

1182 i‡(
öo
 < 
NOVA_ROOT_INO
)

1183  
	`ERR_PTR
(-
ESTALE
);

1185 i‡(
öo
 > 
LONG_MAX
)

1186  
	`ERR_PTR
(-
ESTALE
);

1188 
öode
 = 
	`nova_igë
(
sb
, 
öo
);

1189 i‡(
	`IS_ERR
(
öode
))

1190  
	`ERR_CAST
(
öode
);

1192 i‡(
gíî©i⁄
 && 
öode
->
i_gíî©i⁄
 != generation) {

1194 
	`ùut
(
öode
);

1195  
	`ERR_PTR
(-
ESTALE
);

1198  
öode
;

1199 
	}
}

1201 
díåy
 *
	$nova_fh_to_díåy
(
su≥r_block
 *
sb
,

1202 
fid
 *fid, 
fh_Àn
,

1203 
fh_ty≥
)

1205  
	`gíîic_fh_to_díåy
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1206 
nova_nfs_gë_öode
);

1207 
	}
}

1209 
díåy
 *
	$nova_fh_to_∑ª¡
(
su≥r_block
 *
sb
,

1210 
fid
 *fid, 
fh_Àn
,

1211 
fh_ty≥
)

1213  
	`gíîic_fh_to_∑ª¡
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1214 
nova_nfs_gë_öode
);

1215 
	}
}

1217 c⁄° 
exp‹t_›î©i⁄s
 
	gnova_exp‹t_›s
 = {

1218 .
fh_to_díåy
 = 
nova_fh_to_díåy
,

1219 .
	gfh_to_∑ª¡
 = 
nova_fh_to_∑ª¡
,

1220 .
	ggë_∑ª¡
 = 
nova_gë_∑ª¡
,

1223 
__öô
 
	$öô_nova_fs
()

1225 
rc
 = 0;

1226 
	`INIT_TIMING
(
öô_time
);

1228 
	`NOVA_START_TIMING
(
öô_t
, 
öô_time
);

1229 i‡(
	`¨ch_has_˛wb
())

1230 
suµ‹t_˛wb
 = 1;

1232 
	`nova_öfo
("ArchÇew instructions support: CLWB %s\n",

1233 
suµ‹t_˛wb
 ? "YES" : "NO");

1235 
nova_¥oc_roŸ
 = 
	`¥oc_mkdú
(
¥oc_dú«me
, 
NULL
);

1237 
	`nova_dbg
("Data structure size: inode %lu,Üog_page %lu, file_write_entry %lu, dir_entry(max) %d, setattr_entry %lu,Üink_change_entry %lu\n",

1238 (
nova_öode
),

1239 (
nova_öode_log_∑ge
),

1240 (
nova_fûe_wrôe_íåy
),

1241 
	`NOVA_DIR_LOG_REC_LEN
(
NOVA_NAME_LEN
),

1242 (
nova_£èâr_logíåy
),

1243 (
nova_lök_ch™ge_íåy
));

1245 
rc
 = 
	`öô_øngíode_ˇche
();

1246 i‡(
rc
)

1247  
rc
;

1249 
rc
 = 
	`öô_öodeˇche
();

1250 i‡(
rc
)

1251 
out1
;

1253 
rc
 = 
	`öô_¢≠shŸ_öfo_ˇche
();

1254 i‡(
rc
)

1255 
out2
;

1257 
rc
 = 
	`ªgi°î_fûesy°em
(&
nova_fs_ty≥
);

1258 i‡(
rc
)

1259 
out3
;

1261 
	`NOVA_END_TIMING
(
öô_t
, 
öô_time
);

1264 
out3
:

1265 
	`de°roy_¢≠shŸ_öfo_ˇche
();

1266 
out2
:

1267 
	`de°roy_öodeˇche
();

1268 
out1
:

1269 
	`de°roy_øngíode_ˇche
();

1270  
rc
;

1271 
	}
}

1273 
__exô
 
	$exô_nova_fs
()

1275 
	`uƒegi°î_fûesy°em
(&
nova_fs_ty≥
);

1276 
	`ªmove_¥oc_íåy
(
¥oc_dú«me
, 
NULL
);

1277 
	`de°roy_¢≠shŸ_öfo_ˇche
();

1278 
	`de°roy_öodeˇche
();

1279 
	`de°roy_øngíode_ˇche
();

1280 
	}
}

1282 
MODULE_AUTHOR
("Andiry Xu <jix024@cs.ucsd.edu>");

1283 
MODULE_DESCRIPTION
("NOVA: A Persistent Memory File System");

1284 
MODULE_LICENSE
("GPL");

1286 
	$moduÀ_öô
(
öô_nova_fs
)

1287 
	`moduÀ_exô
(
exô_nova_fs
)

	@super.h

1 #i‚de‡
__SUPER_H


2 
	#__SUPER_H


	)

15 
	snova_su≥r_block
 {

19 
__À32
 
	ms_sum
;

20 
__À32
 
	ms_magic
;

21 
__À32
 
	ms_∑ddög32
;

22 
__À32
 
	ms_blocksize
;

23 
__À64
 
	ms_size
;

24 
	ms_vﬁume_«me
[16];

27 
__À64
 
	ms_ïoch_id
;

32 
__À32
 
	ms_mtime
;

33 
__À32
 
	ms_wtime
;

36 
u8
 
	ms_∑ddög8
;

37 
u8
 
	ms_mëad©a_csum
;

38 
u8
 
	ms_d©a_csum
;

39 
u8
 
	ms_d©a_∑rôy
;

40 } 
__©åibuã
((
__∑cked__
));

42 
	#NOVA_SB_SIZE
 512

	)

57 
	#HEAD_RESERVED_BLOCKS
 64

	)

58 
	#NUM_JOURNAL_PAGES
 16

	)

60 
	#SUPER_BLOCK_START
 0

61 
	#RESERVE_INODE_START
 1

62 
	#INODE_TABLE0_START
 16

63 
	#INODE_TABLE1_START
 32

64 
	#JOURNAL_START
 48

65 

	)

67 
	#TAIL_RESERVED_BLOCKS
 2

	)

72 
	#NOVA_ROOT_INO
 (1)

	)

73 
	#NOVA_INODETABLE_INO
 (2Ë

	)

79 
	#NOVA_BLOCKNODE_INO
 (3Ë

	)

80 
	#NOVA_LITEJOURNAL_INO
 (4Ë

	)

81 
	#NOVA_INODELIST_INO
 (5Ë

	)

82 
	#NOVA_SNAPSHOT_INO
 (6Ë

	)

83 
	#NOVA_TEST_PERF_INO
 (7)

	)

87 
	#NOVA_NORMAL_INODE_START
 (32)

	)

94 
	snova_sb_öfo
 {

95 
su≥r_block
 *
	msb
;

96 
nova_su≥r_block
 *
	mnova_sb
;

97 
block_devi˚
 *
	ms_bdev
;

98 
dax_devi˚
 *
	ms_dax_dev
;

104 
phys_addr_t
 
	mphys_addr
;

105 *
	mvút_addr
;

106 *
	mª∂iˇ_ª£rved_öodes_addr
;

107 *
	mª∂iˇ_sb_addr
;

109 
	mnum_blocks
;

117 
	mnova_backög_›ti⁄
;

120 
	mbpi
;

121 
	mblocksize
;

122 
	möôsize
;

123 
	ms_mou¡_›t
;

124 
kuid_t
 
	muid
;

125 
kgid_t
 
	mgid
;

126 
umode_t
 
	mmode
;

127 
©omic_t
 
	m√xt_gíî©i⁄
;

129 
	ms_öodes_u£d_cou¡
;

130 
	mhód_ª£rved_blocks
;

131 
	mèû_ª£rved_blocks
;

133 
muãx
 
	ms_lock
;

135 
	m˝us
;

136 
¥oc_dú_íåy
 *
	ms_¥oc
;

139 
nova_öode_öfo
 *
	m¢≠shŸ_si
;

140 
ødix_åì_roŸ
 
	m¢≠shŸ_öfo_åì
;

141 
	mnum_¢≠shŸs
;

143 vﬁ©ûê
u64
 
	ms_ïoch_id
;

144 vﬁ©ûê
	m¢≠shŸ_èkög
;

146 
	mmou¡_¢≠shŸ
;

147 
u64
 
	mmou¡_¢≠shŸ_ïoch_id
;

149 
èsk_°ru˘
 *
	m¢≠shŸ_˛ó√r_thªad
;

150 
waô_queue_hód_t
 
	m¢≠shŸ_˛ó√r_waô
;

151 
waô_queue_hód_t
 
	m¢≠shŸ_mm≠_waô
;

152 *
	mcuº_˛ón_¢≠shŸ_öfo
;

155 
muãx
 
	mvma_muãx
;

156 
li°_hód
 
	mmm≠_sih_li°
;

159 *
	mzî€d_∑ge
;

162 
u32
 
	mzîo_csum
[8];

163 *
	mzîo_∑rôy
;

166 
•ölock_t
 *
	mjou∫Æ_locks
;

169 
öode_m≠
 *
	möode_m≠s
;

172 
	mm≠_id
;

175 
‰ì_li°
 *
	m‰ì_li°s
;

176 
	m≥r_li°_blocks
;

179 
ölöe
 
nova_sb_öfo
 *
	$NOVA_SB
(
su≥r_block
 *
sb
)

181  
sb
->
s_fs_öfo
;

182 
	}
}

186 
ölöe
 
nova_su≥r_block


187 *
	$nova_gë_ªdund_su≥r
(
su≥r_block
 *
sb
)

189 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

191  (
nova_su≥r_block
 *)(
sbi
->
ª∂iˇ_sb_addr
);

192 
	}
}

198 
ölöe
 
nova_su≥r_block
 *
	$nova_gë_su≥r
(
su≥r_block
 *
sb
)

200 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

202  (
nova_su≥r_block
 *)
sbi
->
vút_addr
;

203 
	}
}

205 
su≥r_block
 *
nova_ªad_su≥r
(su≥r_block *
sb
, *
d©a
,

206 
sûít
);

207 
nova_°©fs
(
díåy
 *
d
, 
k°©fs
 *
buf
);

208 
nova_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
);

209 *
nova_i‹em≠
(
su≥r_block
 *
sb
, 
phys_addr_t
 
phys_addr
,

210 
ssize_t
 
size
);

211 
nova_ønge_node
 *
nova_Æloc_ønge_node_©omic
(
su≥r_block
 *
sb
);

212 
nova_ønge_node
 *
nova_Æloc_ønge_node
(
su≥r_block
 *
sb
);

213 
nova_‰ì_ønge_node
(
nova_ønge_node
 *
node
);

214 
nova_upd©e_su≥r_¸c
(
su≥r_block
 *
sb
);

215 
nova_sync_su≥r
(
su≥r_block
 *
sb
);

217 
¢≠shŸ_öfo
 *
nova_Æloc_¢≠shŸ_öfo
(
su≥r_block
 *
sb
);

	@symlink.c

21 
	~<löux/fs.h
>

22 
	~<löux/«mei.h
>

23 
	~<löux/vîsi⁄.h
>

24 
	~"nova.h
"

25 
	~"öode.h
"

27 
	$nova_block_symlök
(
su≥r_block
 *
sb
, 
nova_öode
 *
pi
,

28 
öode
 *öode, c⁄° *
sym«me
, 
Àn
, 
u64
 
ïoch_id
)

30 
nova_fûe_wrôe_íåy
 
íåy_d©a
;

31 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

32 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

33 
nova_öode_upd©e
 
upd©e
;

34 
«me_blockƒ
 = 0;

35 
Æloˇãd
;

36 
u64
 
block
;

37 *
blockp
;

38 
u32
 
time
;

39 
ªt
;

40 
úq_Êags
 = 0;

42 
upd©e
.
èû
 = 
sih
->
log_èû
;

43 
upd©e
.
Æãr_èû
 = 
sih
->
Æãr_log_èû
;

45 
Æloˇãd
 = 
	`nova_√w_d©a_blocks
(
sb
, 
sih
, &
«me_blockƒ
, 0, 1,

46 
ALLOC_INIT_ZERO
, 
ANY_CPU
, 
ALLOC_FROM_TAIL
);

47 i‡(
Æloˇãd
 !1 || 
«me_blockƒ
 == 0) {

48 
ªt
 = 
Æloˇãd
;

49  
ªt
;

53 
block
 = 
	`nova_gë_block_off
(
sb
, 
«me_blockƒ
, 
NOVA_BLOCK_TYPE_4K
);

54 
blockp
 = (*)
	`nova_gë_block
(
sb
, 
block
);

56 
	`nova_memu∆ock_block
(
sb
, 
blockp
, &
úq_Êags
);

57 
	`mem˝y_to_pmem_noˇche
(
blockp
, 
sym«me
, 
Àn
);

58 
blockp
[
Àn
] = '\0';

59 
	`nova_memlock_block
(
sb
, 
blockp
, &
úq_Êags
);

62 
time
 = 
	`cuºít_time
(
öode
).
tv_£c
;

63 
	`nova_öô_fûe_wrôe_íåy
(
sb
, 
sih
, &
íåy_d©a
, 
ïoch_id
, 0, 1,

64 
«me_blockƒ
, 
time
, 
Àn
 + 1);

66 
ªt
 = 
	`nova_≠≥nd_fûe_wrôe_íåy
(
sb
, 
pi
, 
öode
, &
íåy_d©a
, &
upd©e
);

67 i‡(
ªt
) {

68 
	`nova_dbg
("%s:áppend file writeÉntry failed %d\n",

69 
__func__
, 
ªt
);

70 
	`nova_‰ì_d©a_blocks
(
sb
, 
sih
, 
«me_blockƒ
, 1);

71  
ªt
;

74 
	`nova_memu∆ock_öode
(
sb
, 
pi
, &
úq_Êags
);

75 
	`nova_upd©e_öode
(
sb
, 
öode
, 
pi
, &
upd©e
, 1);

76 
	`nova_memlock_öode
(
sb
, 
pi
, &
úq_Êags
);

77 
sih
->
å™s_id
++;

80 
	}
}

83 
	$nova_ªadlök_c›y
(
__u£r
 *
buf„r
, 
buÊí
, c⁄° *
lök
)

85 
Àn
 = 
	`PTR_ERR
(
lök
);

87 i‡(
	`IS_ERR
(
lök
))

88 
out
;

90 
Àn
 = 
	`°æí
(
lök
);

91 i‡(
Àn
 > (Ë
buÊí
)

92 
Àn
 = 
buÊí
;

93 i‡(
	`c›y_to_u£r
(
buf„r
, 
lök
, 
Àn
))

94 
Àn
 = -
EFAULT
;

95 
out
:

96  
Àn
;

97 
	}
}

99 
	$nova_ªadlök
(
díåy
 *díåy, 
__u£r
 *
buf„r
, 
buÊí
)

101 
nova_fûe_wrôe_íåy
 *
íåy
;

102 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

103 
öode
 *öodê
díåy
->
d_öode
;

104 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

105 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

106 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

107 *
blockp
;

109 
íåy
 = (
nova_fûe_wrôe_íåy
 *)
	`nova_gë_block
(
sb
,

110 
sih
->
log_hód
);

112 i‡(
mëad©a_csum
 == 0)

113 
íåyc
 = 
íåy
;

115 
íåyc
 = &
íåy_c›y
;

116 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

117  -
EIO
;

120 
blockp
 = (*)
	`nova_gë_block
(
sb
, 
	`BLOCK_OFF
(
íåyc
->
block
));

122  
	`nova_ªadlök_c›y
(
buf„r
, 
buÊí
, 
blockp
);

123 
	}
}

125 c⁄° *
	$nova_gë_lök
(
díåy
 *díåy, 
öode
 *inode,

126 
dñayed_ˇŒ
 *
d⁄e
)

128 
nova_fûe_wrôe_íåy
 *
íåy
;

129 
nova_fûe_wrôe_íåy
 *
íåyc
, 
íåy_c›y
;

130 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

131 
nova_öode_öfo
 *
si
 = 
	`NOVA_I
(
öode
);

132 
nova_öode_öfo_hódî
 *
sih
 = &
si
->
hódî
;

133 *
blockp
;

135 
íåy
 = (
nova_fûe_wrôe_íåy
 *)
	`nova_gë_block
(
sb
,

136 
sih
->
log_hód
);

137 i‡(
mëad©a_csum
 == 0)

138 
íåyc
 = 
íåy
;

140 
íåyc
 = &
íåy_c›y
;

141 i‡(!
	`nova_vîify_íåy_csum
(
sb
, 
íåy
, 
íåyc
))

142  
NULL
;

145 
blockp
 = (*)
	`nova_gë_block
(
sb
, 
	`BLOCK_OFF
(
íåyc
->
block
));

147  
blockp
;

148 
	}
}

150 c⁄° 
öode_›î©i⁄s
 
	gnova_symlök_öode_›î©i⁄s
 = {

151 .
ªadlök
 = 
nova_ªadlök
,

152 .
	ggë_lök
 = 
nova_gë_lök
,

153 .
	g£èâr
 = 
nova_nŸify_ch™ge
,

	@sysfs.c

21 
	~"nova.h
"

22 
	~"öode.h
"

24 c⁄° *
	g¥oc_dú«me
 = "fs/NOVA";

25 
¥oc_dú_íåy
 *
	gnova_¥oc_roŸ
;

28 
	$nova_£q_timög_show
(
£q_fûe
 *
£q
, *
v
)

30 
i
;

32 
	`nova_gë_timög_°©s
();

34 
	`£q_puts
(
£q
, "=========== NOVA kernelÅiming stats ===========\n");

35 
i
 = 0; i < 
TIMING_NUM
; i++) {

37 i‡(
Timög°rög
[
i
][0] == '=') {

38 
	`£q_¥ötf
(
£q
, "\n%s\n\n", 
Timög°rög
[
i
]);

42 i‡(
mósuª_timög
 || 
Timög°©s
[
i
]) {

43 
	`£q_¥ötf
(
£q
, "%s: count %llu,Åiming %llu,áverage %llu\n",

44 
Timög°rög
[
i
],

45 
Cou¡°©s
[
i
],

46 
Timög°©s
[
i
],

47 
Cou¡°©s
[
i
] ?

48 
Timög°©s
[
i
] / 
Cou¡°©s
[i] : 0);

50 
	`£q_¥ötf
(
£q
, "%s: count %llu\n",

51 
Timög°rög
[
i
],

52 
Cou¡°©s
[
i
]);

56 
	`£q_puts
(
£q
, "\n");

58 
	}
}

60 
	$nova_£q_timög_›í
(
öode
 *öode, 
fûe
 *file)

63  
	`sögÀ_›í
(
fûe
, 
nova_£q_timög_show
, 
	`pde_d©a
(
öode
));

64 
	}
}

66 
ssize_t
 
	$nova_£q_˛ór_°©s
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
,

67 
size_t
 
Àn
, 
loff_t
 *
µos
)

69 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

70 
öode
 *öodê
m≠pög
->
ho°
;

72 
su≥r_block
 *
sb
 = 
	`pde_d©a
(
öode
);

74 
	`nova_˛ór_°©s
(
sb
);

75  
Àn
;

76 
	}
}

78 c⁄° 
¥oc_›s
 
	gnova_£q_timög_f›s
 = {

79 .
¥oc_›í
 = 
nova_£q_timög_›í
,

80 .
	g¥oc_ªad
 = 
£q_ªad
,

81 .
	g¥oc_wrôe
 = 
nova_£q_˛ór_°©s
,

82 .
	g¥oc_l£ek
 = 
£q_l£ek
,

83 .
	g¥oc_ªÀa£
 = 
sögÀ_ªÀa£
,

86 
	$nova_£q_IO_show
(
£q_fûe
 *
£q
, *
v
)

88 
su≥r_block
 *
sb
 = 
£q
->
¥iv©e
;

89 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

90 
‰ì_li°
 *free_list;

91 
Æloc_log_cou¡
 = 0;

92 
Æloc_log_∑ges
 = 0;

93 
Æloc_d©a_cou¡
 = 0;

94 
Æloc_d©a_∑ges
 = 0;

95 
‰ì_log_cou¡
 = 0;

96 
‰ìd_log_∑ges
 = 0;

97 
‰ì_d©a_cou¡
 = 0;

98 
‰ìd_d©a_∑ges
 = 0;

99 
i
;

101 
	`nova_gë_timög_°©s
();

102 
	`nova_gë_IO_°©s
();

104 
	`£q_puts
(
£q
, "============ NOVAállocation stats ============\n\n");

106 
i
 = 0; i < 
sbi
->
˝us
; i++) {

107 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
i
);

109 
Æloc_log_cou¡
 +
‰ì_li°
->alloc_log_count;

110 
Æloc_log_∑ges
 +
‰ì_li°
->alloc_log_pages;

111 
Æloc_d©a_cou¡
 +
‰ì_li°
->alloc_data_count;

112 
Æloc_d©a_∑ges
 +
‰ì_li°
->alloc_data_pages;

113 
‰ì_log_cou¡
 +
‰ì_li°
->free_log_count;

114 
‰ìd_log_∑ges
 +
‰ì_li°
->freed_log_pages;

115 
‰ì_d©a_cou¡
 +
‰ì_li°
->free_data_count;

116 
‰ìd_d©a_∑ges
 +
‰ì_li°
->freed_data_pages;

119 
	`£q_¥ötf
(
£q
, "allocÜog count %lu,állocatedÜogÖages %lu\n"

123 
Æloc_log_cou¡
, 
Æloc_log_∑ges
,

124 
Æloc_d©a_cou¡
, 
Æloc_d©a_∑ges
,

125 
‰ì_log_cou¡
, 
‰ìd_log_∑ges
,

126 
‰ì_d©a_cou¡
, 
‰ìd_d©a_∑ges
);

128 
	`£q_¥ötf
(
£q
, "Fast GC %llu, checkÖages %llu, freeÖages %llu,áverage %llu\n",

129 
Cou¡°©s
[
Á°_gc_t
], 
IO°©s
[
Á°_checked_∑ges
],

130 
IO°©s
[
Á°_gc_∑ges
], 
Cou¡°©s
[
Á°_gc_t
] ?

131 
IO°©s
[
Á°_gc_∑ges
] / 
Cou¡°©s
[
Á°_gc_t
] : 0);

132 
	`£q_¥ötf
(
£q
, "Thorough GC %llu, checkedÖages %llu, freeÖages %llu,áverage %llu\n",

133 
Cou¡°©s
[
th‹ough_gc_t
],

134 
IO°©s
[
th‹ough_checked_∑ges
], IO°©s[
th‹ough_gc_∑ges
],

135 
Cou¡°©s
[
th‹ough_gc_t
] ?

136 
IO°©s
[
th‹ough_gc_∑ges
] / 
Cou¡°©s
[
th‹ough_gc_t
]

139 
	`£q_puts
(
£q
, "\n");

141 
	`£q_puts
(
£q
, "================ NOVA I/O stats ================\n\n");

142 
	`£q_¥ötf
(
£q
, "Read %llu, bytes %llu,áverage %llu\n",

143 
Cou¡°©s
[
dax_ªad_t
], 
IO°©s
[
ªad_byãs
],

144 
Cou¡°©s
[
dax_ªad_t
] ?

145 
IO°©s
[
ªad_byãs
] / 
Cou¡°©s
[
dax_ªad_t
] : 0);

146 
	`£q_¥ötf
(
£q
, "COW write %llu, bytes %llu,áverage %llu, write breaks %llu,áverage %llu\n",

147 
Cou¡°©s
[
do_cow_wrôe_t
], 
IO°©s
[
cow_wrôe_byãs
],

148 
Cou¡°©s
[
do_cow_wrôe_t
] ?

149 
IO°©s
[
cow_wrôe_byãs
] / 
Cou¡°©s
[
do_cow_wrôe_t
] : 0,

150 
IO°©s
[
cow_wrôe_bªaks
], 
Cou¡°©s
[
do_cow_wrôe_t
] ?

151 
IO°©s
[
cow_wrôe_bªaks
] / 
Cou¡°©s
[
do_cow_wrôe_t
]

153 
	`£q_¥ötf
(
£q
, "Inplace write %llu, bytes %llu,áverage %llu, write breaks %llu,áverage %llu\n",

154 
Cou¡°©s
[
ö∂a˚_wrôe_t
], 
IO°©s
[
ö∂a˚_wrôe_byãs
],

155 
Cou¡°©s
[
ö∂a˚_wrôe_t
] ?

156 
IO°©s
[
ö∂a˚_wrôe_byãs
] /

157 
Cou¡°©s
[
ö∂a˚_wrôe_t
] : 0,

158 
IO°©s
[
ö∂a˚_wrôe_bªaks
], 
Cou¡°©s
[
ö∂a˚_wrôe_t
] ?

159 
IO°©s
[
ö∂a˚_wrôe_bªaks
] /

160 
Cou¡°©s
[
ö∂a˚_wrôe_t
] : 0);

161 
	`£q_¥ötf
(
£q
, "Inplace write %llu,állocateÇew blocks %llu\n",

162 
Cou¡°©s
[
ö∂a˚_wrôe_t
],

163 
IO°©s
[
ö∂a˚_√w_blocks
]);

164 
	`£q_¥ötf
(
£q
, "DAX get blocks %llu,állocateÇew blocks %llu\n",

165 
Cou¡°©s
[
dax_gë_block_t
], 
IO°©s
[
dax_√w_blocks
]);

166 
	`£q_¥ötf
(
£q
, "DútyÖage†%Œu\n", 
IO°©s
[
dúty_∑ges
]);

167 
	`£q_¥ötf
(
£q
, "Protect head %llu,Åail %llu\n",

168 
IO°©s
[
¥Ÿe˘_hód
], IO°©s[
¥Ÿe˘_èû
]);

169 
	`£q_¥ötf
(
£q
, "Block csumÖ¨ôy %Œu\n", 
IO°©s
[
block_csum_∑rôy
]);

170 
	`£q_¥ötf
(
£q
, "Page fault %llu, dax cow fault %llu, dax cow fault during snapshot creation %llu\n"

172 
Cou¡°©s
[
mm≠_Áu…_t
], Cou¡°©s[
mm≠_cow_t
],

173 
IO°©s
[
dax_cow_durög_¢≠shŸ
],

174 
IO°©s
[
cow_ovîœp_mm≠
],

175 
IO°©s
[
m≠pög_upd©ed_∑ges
]);

176 
	`£q_¥ötf
(
£q
, "fsync %llu, fdatasync %llu\n",

177 
Cou¡°©s
[
fsync_t
], 
IO°©s
[
fd©async
]);

179 
	`£q_puts
(
£q
, "\n");

181 
	`nova_¥öt_¢≠shŸ_li°s
(
sb
, 
£q
);

182 
	`£q_puts
(
£q
, "\n");

185 
	}
}

187 
	$nova_£q_IO_›í
(
öode
 *öode, 
fûe
 *file)

190  
	`sögÀ_›í
(
fûe
, 
nova_£q_IO_show
, 
	`pde_d©a
(
öode
));

191 
	}
}

193 c⁄° 
¥oc_›s
 
	gnova_£q_IO_f›s
 = {

194 .
¥oc_›í
 = 
nova_£q_IO_›í
,

195 .
	g¥oc_ªad
 = 
£q_ªad
,

196 .
	g¥oc_wrôe
 = 
nova_£q_˛ór_°©s
,

197 .
	g¥oc_l£ek
 = 
£q_l£ek
,

198 .
	g¥oc_ªÀa£
 = 
sögÀ_ªÀa£
,

201 
	$nova_£q_show_Æloˇt‹
(
£q_fûe
 *
£q
, *
v
)

203 
su≥r_block
 *
sb
 = 
£q
->
¥iv©e
;

204 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

205 
‰ì_li°
 *free_list;

206 
i
;

207 
log_∑ges
 = 0;

208 
d©a_∑ges
 = 0;

210 
	`£q_puts
(
£q
, "======== NOVAÖer-CPUállocator stats ========\n");

211 
i
 = 0; i < 
sbi
->
˝us
; i++) {

212 
‰ì_li°
 = 
	`nova_gë_‰ì_li°
(
sb
, 
i
);

213 
	`£q_¥ötf
(
£q
, "FreeÜist %d: block start %lu, blockÉnd %lu,Çum_blocks %lu,Çum_free_blocks %lu, blocknode %lu\n",

214 
i
, 
‰ì_li°
->
block_°¨t
, fªe_li°->
block_íd
,

215 
‰ì_li°
->
block_íd
 - fªe_li°->
block_°¨t
 + 1,

216 
‰ì_li°
->
num_‰ì_blocks
, fªe_li°->
num_blocknode
);

218 i‡(
‰ì_li°
->
fú°_node
) {

219 
	`£q_¥ötf
(
£q
, "FirstÇode %lu - %lu\n",

220 
‰ì_li°
->
fú°_node
->
ønge_low
,

221 
‰ì_li°
->
fú°_node
->
ønge_high
);

224 i‡(
‰ì_li°
->
œ°_node
) {

225 
	`£q_¥ötf
(
£q
, "LastÇode %lu - %lu\n",

226 
‰ì_li°
->
œ°_node
->
ønge_low
,

227 
‰ì_li°
->
œ°_node
->
ønge_high
);

230 
	`£q_¥ötf
(
£q
, "FreeÜist %d: csum start %lu,Ñeplica csum start %lu, csum blocks %lu,Öarity start %lu,Öarity blocks %lu\n",

231 
i
, 
‰ì_li°
->
csum_°¨t
, fªe_li°->
ª∂iˇ_csum_°¨t
,

232 
‰ì_li°
->
num_csum_blocks
,

233 
‰ì_li°
->
∑rôy_°¨t
, fªe_li°->
num_∑rôy_blocks
);

235 
	`£q_¥ötf
(
£q
, "FreeÜist %d:állocÜog count %lu,állocatedÜogÖages %lu,álloc data count %lu,állocated dataÖages %lu, freeÜog count %lu, freedÜogÖages %lu, free data count %lu, freed dataÖages %lu\n",

236 
i
,

237 
‰ì_li°
->
Æloc_log_cou¡
,

238 
‰ì_li°
->
Æloc_log_∑ges
,

239 
‰ì_li°
->
Æloc_d©a_cou¡
,

240 
‰ì_li°
->
Æloc_d©a_∑ges
,

241 
‰ì_li°
->
‰ì_log_cou¡
,

242 
‰ì_li°
->
‰ìd_log_∑ges
,

243 
‰ì_li°
->
‰ì_d©a_cou¡
,

244 
‰ì_li°
->
‰ìd_d©a_∑ges
);

246 
log_∑ges
 +
‰ì_li°
->
Æloc_log_∑ges
;

247 
log_∑ges
 -
‰ì_li°
->
‰ìd_log_∑ges
;

249 
d©a_∑ges
 +
‰ì_li°
->
Æloc_d©a_∑ges
;

250 
d©a_∑ges
 -
‰ì_li°
->
‰ìd_d©a_∑ges
;

253 
	`£q_¥ötf
(
£q
, "\nCurrently usedÖmemÖages:Üog %lu, data %lu\n",

254 
log_∑ges
, 
d©a_∑ges
);

257 
	}
}

259 
	$nova_£q_Æloˇt‹_›í
(
öode
 *öode, 
fûe
 *file)

261  
	`sögÀ_›í
(
fûe
, 
nova_£q_show_Æloˇt‹
,

263 
	`pde_d©a
(
öode
));

264 
	}
}

266 c⁄° 
¥oc_›s
 
	gnova_£q_Æloˇt‹_f›s
 = {

267 .
¥oc_›í
 = 
nova_£q_Æloˇt‹_›í
,

268 .
	g¥oc_ªad
 = 
£q_ªad
,

269 .
	g¥oc_l£ek
 = 
£q_l£ek
,

270 .
	g¥oc_ªÀa£
 = 
sögÀ_ªÀa£
,

274 
	$nova_£q_¸óã_¢≠shŸ_show
(
£q_fûe
 *
£q
, *
v
)

276 
	`£q_puts
(
£q
, "WriteÅo createá snapshot\n");

278 
	}
}

280 
	$nova_£q_¸óã_¢≠shŸ_›í
(
öode
 *öode, 
fûe
 *file)

282  
	`sögÀ_›í
(
fûe
, 
nova_£q_¸óã_¢≠shŸ_show
,

284 
	`pde_d©a
(
öode
));

285 
	}
}

287 
ssize_t
 
	$nova_£q_¸óã_¢≠shŸ
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
,

288 
size_t
 
Àn
, 
loff_t
 *
µos
)

290 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

291 
öode
 *öodê
m≠pög
->
ho°
;

293 
su≥r_block
 *
sb
 = 
	`pde_d©a
(
öode
);

295 
	`nova_¸óã_¢≠shŸ
(
sb
);

296  
Àn
;

297 
	}
}

299 c⁄° 
¥oc_›s
 
	gnova_£q_¸óã_¢≠shŸ_f›s
 = {

300 .
¥oc_›í
 = 
nova_£q_¸óã_¢≠shŸ_›í
,

301 .
	g¥oc_ªad
 = 
£q_ªad
,

302 .
	g¥oc_wrôe
 = 
nova_£q_¸óã_¢≠shŸ
,

303 .
	g¥oc_l£ek
 = 
£q_l£ek
,

304 .
	g¥oc_ªÀa£
 = 
sögÀ_ªÀa£
,

307 
	$nova_£q_dñëe_¢≠shŸ_show
(
£q_fûe
 *
£q
, *
v
)

309 
	`£q_puts
(
£q
, "Echo indexÅo deleteá snapshot\n");

311 
	}
}

313 
	$nova_£q_dñëe_¢≠shŸ_›í
(
öode
 *öode, 
fûe
 *file)

315  
	`sögÀ_›í
(
fûe
, 
nova_£q_dñëe_¢≠shŸ_show
,

317 
	`pde_d©a
(
öode
));

318 
	}
}

320 
ssize_t
 
	$nova_£q_dñëe_¢≠shŸ
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
,

321 
size_t
 
Àn
, 
loff_t
 *
µos
)

323 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

324 
öode
 *öodê
m≠pög
->
ho°
;

326 
su≥r_block
 *
sb
 = 
	`pde_d©a
(
öode
);

327 
u64
 
ïoch_id
;

329 
	`ssˇnf
(
buf
, "%Œu", &
ïoch_id
);

330 
	`nova_dñëe_¢≠shŸ
(
sb
, 
ïoch_id
);

332  
Àn
;

333 
	}
}

335 c⁄° 
¥oc_›s
 
	gnova_£q_dñëe_¢≠shŸ_f›s
 = {

336 .
¥oc_›í
 = 
nova_£q_dñëe_¢≠shŸ_›í
,

337 .
	g¥oc_ªad
 = 
£q_ªad
,

338 .
	g¥oc_wrôe
 = 
nova_£q_dñëe_¢≠shŸ
,

339 .
	g¥oc_l£ek
 = 
£q_l£ek
,

340 .
	g¥oc_ªÀa£
 = 
sögÀ_ªÀa£
,

343 
	$nova_£q_show_¢≠shŸs
(
£q_fûe
 *
£q
, *
v
)

345 
su≥r_block
 *
sb
 = 
£q
->
¥iv©e
;

347 
	`nova_¥öt_¢≠shŸs
(
sb
, 
£q
);

349 
	}
}

351 
	$nova_£q_show_¢≠shŸs_›í
(
öode
 *öode, 
fûe
 *file)

353  
	`sögÀ_›í
(
fûe
, 
nova_£q_show_¢≠shŸs
,

355 
	`pde_d©a
(
öode
));

356 
	}
}

358 c⁄° 
¥oc_›s
 
	gnova_£q_show_¢≠shŸs_f›s
 = {

359 .
¥oc_›í
 = 
nova_£q_show_¢≠shŸs_›í
,

360 .
	g¥oc_ªad
 = 
£q_ªad
,

361 .
	g¥oc_l£ek
 = 
£q_l£ek
,

362 .
	g¥oc_ªÀa£
 = 
sögÀ_ªÀa£
,

366 
	$nova_£q_ã°_≥rf_show
(
£q_fûe
 *
£q
, *
v
)

368 
	`£q_¥ötf
(
£q
, "Echo function:poolmb:size:disksÅoÅest functionÖerformance working on size of data.\n"

373 
	}
}

375 
	$nova_£q_ã°_≥rf_›í
(
öode
 *öode, 
fûe
 *file)

378  
	`sögÀ_›í
(
fûe
, 
nova_£q_ã°_≥rf_show
, 
	`pde_d©a
(
öode
));

379 
	}
}

381 
ssize_t
 
	$nova_£q_ã°_≥rf
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
,

382 
size_t
 
Àn
, 
loff_t
 *
µos
)

384 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

385 
öode
 *öodê
m≠pög
->
ho°
;

387 
su≥r_block
 *
sb
 = 
	`pde_d©a
(
öode
);

388 
size_t
 
size
;

389 
func_id
, 
poﬁmb
, 
disks
;

391 i‡(
	`ssˇnf
(
buf
, "%u:%u:%zu:%u", &
func_id
, &
poﬁmb
, &
size
, &
disks
) == 4)

392 
	`nova_ã°_≥rf
(
sb
, 
func_id
, 
poﬁmb
, 
size
, 
disks
);

394 
	`nova_w¨n
("Couldn'à∑r£Åe°_≥r‡ªque°: %s", 
buf
);

396  
Àn
;

397 
	}
}

399 c⁄° 
¥oc_›s
 
	gnova_£q_ã°_≥rf_f›s
 = {

400 .
¥oc_›í
 = 
nova_£q_ã°_≥rf_›í
,

401 .
	g¥oc_ªad
 = 
£q_ªad
,

402 .
	g¥oc_wrôe
 = 
nova_£q_ã°_≥rf
,

403 .
	g¥oc_l£ek
 = 
£q_l£ek
,

404 .
	g¥oc_ªÀa£
 = 
sögÀ_ªÀa£
,

411 
	$nova_£q_gc_show
(
£q_fûe
 *
£q
, *
v
)

413 
	`£q_¥ötf
(
£q
, "Echo inodeÇumberÅoÅrigger garbage collection\n"

416 
	}
}

418 
	$nova_£q_gc_›í
(
öode
 *öode, 
fûe
 *file)

421  
	`sögÀ_›í
(
fûe
, 
nova_£q_gc_show
, 
	`pde_d©a
(
öode
));

422 
	}
}

424 
ssize_t
 
	$nova_£q_gc
(
fûe
 *
fûp
, c⁄° 
__u£r
 *
buf
,

425 
size_t
 
Àn
, 
loff_t
 *
µos
)

427 
u64
 
èrgë_öode_numbî
;

428 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

429 
öode
 *öodê
m≠pög
->
ho°
;

431 
su≥r_block
 *
sb
 = 
	`pde_d©a
(
öode
);

432 
öode
 *
èrgë_öode
;

433 
nova_öode
 *
èrgë_pi
;

434 
nova_öode_öfo
 *
èrgë_sih
;

436 *
_buf
;

437 
ªtvÆ
 = 
Àn
;

439 
_buf
 = 
	`kmÆloc
(
Àn
, 
GFP_KERNEL
);

440 i‡(
_buf
 =
NULL
) {

441 
ªtvÆ
 = -
ENOMEM
;

442 
	`nova_dbg
("%s: kmÆlo¯Áûed\n", 
__func__
);

443 
out
;

446 i‡(
	`c›y_‰om_u£r
(
_buf
, 
buf
, 
Àn
)) {

447 
ªtvÆ
 = -
EFAULT
;

448 
out
;

451 
_buf
[
Àn
] = 0;

452 
	`ssˇnf
(
_buf
, "%Œu", &
èrgë_öode_numbî
);

453 
	`nova_öfo
("%s:Å¨gë_öode_numbî=%Œu.", 
__func__
,

454 
èrgë_öode_numbî
);

457 i‡(
èrgë_öode_numbî
 < 
NOVA_NORMAL_INODE_START
 &&

458 
èrgë_öode_numbî
 !
NOVA_ROOT_INO
) {

459 
	`nova_öfo
("%s: invÆid inodê%Œu.", 
__func__
,

460 
èrgë_öode_numbî
);

461 
ªtvÆ
 = -
ENOENT
;

462 
out
;

465 
èrgë_öode
 = 
	`nova_igë
(
sb
, 
èrgë_öode_numbî
);

466 i‡(
èrgë_öode
 =
NULL
) {

467 
	`nova_öfo
("%s: inodê%Œu d€†nŸÉxi°.", 
__func__
,

468 
èrgë_öode_numbî
);

469 
ªtvÆ
 = -
ENOENT
;

470 
out
;

473 
èrgë_pi
 = 
	`nova_gë_öode
(
sb
, 
èrgë_öode
);

474 i‡(
èrgë_pi
 =
NULL
) {

475 
	`nova_öfo
("%s: couldn'àgëÇov®öodê%Œu.", 
__func__
,

476 
èrgë_öode_numbî
);

477 
ªtvÆ
 = -
ENOENT
;

478 
out
;

481 
èrgë_sih
 = 
	`NOVA_I
(
èrgë_öode
);

483 
	`nova_öfo
("%s: gŸ inodê%Œu @ 0x%p;Öi=0x%p\n", 
__func__
,

484 
èrgë_öode_numbî
, 
èrgë_öode
, 
èrgë_pi
);

486 
	`nova_öode_log_Á°_gc
(
sb
, 
èrgë_pi
, &
èrgë_sih
->
hódî
,

488 
	`ùut
(
èrgë_öode
);

490 
out
:

491 
	`k‰ì
(
_buf
);

492  
ªtvÆ
;

493 
	}
}

495 c⁄° 
¥oc_›s
 
	gnova_£q_gc_f›s
 = {

496 .
¥oc_›í
 = 
nova_£q_gc_›í
,

497 .
	g¥oc_ªad
 = 
£q_ªad
,

498 .
	g¥oc_wrôe
 = 
nova_£q_gc
,

499 .
	g¥oc_l£ek
 = 
£q_l£ek
,

500 .
	g¥oc_ªÀa£
 = 
sögÀ_ªÀa£
,

504 
	$nova_sysfs_öô
(
su≥r_block
 *
sb
)

506 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

507 c⁄° 
¥oc_›s
 *
›s
;

509 i‡(
nova_¥oc_roŸ
)

510 
sbi
->
s_¥oc
 = 
	`¥oc_mkdú
(sbi->
s_bdev
->
bd_disk
->
disk_«me
,

511 
nova_¥oc_roŸ
);

513 i‡(
sbi
->
s_¥oc
) {

514 
›s
 = &
nova_£q_timög_f›s
;

515 
	`¥oc_¸óã_d©a
("timög_°©s", 0444, 
sbi
->
s_¥oc
, 
›s
, 
sb
);

517 
›s
 = &
nova_£q_IO_f›s
;

518 
	`¥oc_¸óã_d©a
("IO_°©s", 0444, 
sbi
->
s_¥oc
, 
›s
, 
sb
);

520 
›s
 = &
nova_£q_Æloˇt‹_f›s
;

521 
	`¥oc_¸óã_d©a
("Æloˇt‹", 0444, 
sbi
->
s_¥oc
, 
›s
, 
sb
);

523 
›s
 = &
nova_£q_¸óã_¢≠shŸ_f›s
;

524 
	`¥oc_¸óã_d©a
("¸óã_¢≠shŸ", 0444, 
sbi
->
s_¥oc
, 
›s
, 
sb
);

526 
›s
 = &
nova_£q_dñëe_¢≠shŸ_f›s
;

527 
	`¥oc_¸óã_d©a
("dñëe_¢≠shŸ", 0444, 
sbi
->
s_¥oc
, 
›s
, 
sb
);

529 
›s
 = &
nova_£q_show_¢≠shŸs_f›s
;

530 
	`¥oc_¸óã_d©a
("¢≠shŸs", 0444, 
sbi
->
s_¥oc
, 
›s
, 
sb
);

532 
›s
 = &
nova_£q_ã°_≥rf_f›s
;

533 
	`¥oc_¸óã_d©a
("ã°_≥rf", 0444, 
sbi
->
s_¥oc
, 
›s
, 
sb
);

535 
›s
 = &
nova_£q_gc_f›s
;

536 
	`¥oc_¸óã_d©a
("gc", 0444, 
sbi
->
s_¥oc
, 
›s
, 
sb
);

538 
	}
}

540 
	$nova_sysfs_exô
(
su≥r_block
 *
sb
)

542 
nova_sb_öfo
 *
sbi
 = 
	`NOVA_SB
(
sb
);

544 i‡(
sbi
->
s_¥oc
) {

545 
	`ªmove_¥oc_íåy
("timög_°©s", 
sbi
->
s_¥oc
);

546 
	`ªmove_¥oc_íåy
("IO_°©s", 
sbi
->
s_¥oc
);

547 
	`ªmove_¥oc_íåy
("Æloˇt‹", 
sbi
->
s_¥oc
);

548 
	`ªmove_¥oc_íåy
("¸óã_¢≠shŸ", 
sbi
->
s_¥oc
);

549 
	`ªmove_¥oc_íåy
("dñëe_¢≠shŸ", 
sbi
->
s_¥oc
);

550 
	`ªmove_¥oc_íåy
("¢≠shŸs", 
sbi
->
s_¥oc
);

551 
	`ªmove_¥oc_íåy
("ã°_≥rf", 
sbi
->
s_¥oc
);

552 
	`ªmove_¥oc_íåy
("gc", 
sbi
->
s_¥oc
);

553 
	`ªmove_¥oc_íåy
(
sbi
->
s_bdev
->
bd_disk
->
disk_«me
,

554 
nova_¥oc_roŸ
);

556 
	}
}

	@/usr/include/linux/capability.h

14 #i‚de‡
_LINUX_CAPABILITY_H


15 
	#_LINUX_CAPABILITY_H


	)

17 
	~<löux/ty≥s.h
>

30 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

31 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

33 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

34 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

36 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

37 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

39 
	s__u£r_ˇp_hódî_°ru˘
 {

40 
__u32
 
	mvîsi⁄
;

41 
	mpid
;

42 } *
	tˇp_u£r_hódî_t
;

44 
	s__u£r_ˇp_d©a_°ru˘
 {

45 
__u32
 
	mef„˘ive
;

46 
__u32
 
	m≥rmôãd
;

47 
__u32
 
	möhîôabÀ
;

48 } *
	tˇp_u£r_d©a_t
;

51 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

52 
	#VFS_CAP_REVISION_SHIFT
 24

	)

53 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

54 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

56 
	#VFS_CAP_REVISION_1
 0x01000000

	)

57 
	#VFS_CAP_U32_1
 1

	)

58 
	#XATTR_CAPS_SZ_1
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

60 
	#VFS_CAP_REVISION_2
 0x02000000

	)

61 
	#VFS_CAP_U32_2
 2

	)

62 
	#XATTR_CAPS_SZ_2
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

64 
	#VFS_CAP_REVISION_3
 0x03000000

	)

65 
	#VFS_CAP_U32_3
 2

	)

66 
	#XATTR_CAPS_SZ_3
 ((
__À32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

68 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

69 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

70 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

72 
	svfs_ˇp_d©a
 {

73 
__À32
 
	mmagic_ëc
;

75 
__À32
 
	m≥rmôãd
;

76 
__À32
 
	möhîôabÀ
;

77 } 
	md©a
[
VFS_CAP_U32
];

83 
	svfs_ns_ˇp_d©a
 {

84 
__À32
 
	mmagic_ëc
;

86 
__À32
 
	m≥rmôãd
;

87 
__À32
 
	möhîôabÀ
;

88 } 
	md©a
[
VFS_CAP_U32
];

89 
__À32
 
	mroŸid
;

98 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

99 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

111 
	#CAP_CHOWN
 0

	)

117 
	#CAP_DAC_OVERRIDE
 1

	)

123 
	#CAP_DAC_READ_SEARCH
 2

	)

129 
	#CAP_FOWNER
 3

	)

138 
	#CAP_FSETID
 4

	)

144 
	#CAP_KILL
 5

	)

150 
	#CAP_SETGID
 6

	)

155 
	#CAP_SETUID
 7

	)

172 
	#CAP_SETPCAP
 8

	)

176 
	#CAP_LINUX_IMMUTABLE
 9

	)

181 
	#CAP_NET_BIND_SERVICE
 10

	)

185 
	#CAP_NET_BROADCAST
 11

	)

201 
	#CAP_NET_ADMIN
 12

	)

207 
	#CAP_NET_RAW
 13

	)

213 
	#CAP_IPC_LOCK
 14

	)

217 
	#CAP_IPC_OWNER
 15

	)

220 
	#CAP_SYS_MODULE
 16

	)

225 
	#CAP_SYS_RAWIO
 17

	)

229 
	#CAP_SYS_CHROOT
 18

	)

233 
	#CAP_SYS_PTRACE
 19

	)

237 
	#CAP_SYS_PACCT
 20

	)

276 
	#CAP_SYS_ADMIN
 21

	)

280 
	#CAP_SYS_BOOT
 22

	)

291 
	#CAP_SYS_NICE
 23

	)

306 
	#CAP_SYS_RESOURCE
 24

	)

312 
	#CAP_SYS_TIME
 25

	)

317 
	#CAP_SYS_TTY_CONFIG
 26

	)

321 
	#CAP_MKNOD
 27

	)

325 
	#CAP_LEASE
 28

	)

329 
	#CAP_AUDIT_WRITE
 29

	)

333 
	#CAP_AUDIT_CONTROL
 30

	)

338 
	#CAP_SETFCAP
 31

	)

346 
	#CAP_MAC_OVERRIDE
 32

	)

355 
	#CAP_MAC_ADMIN
 33

	)

359 
	#CAP_SYSLOG
 34

	)

363 
	#CAP_WAKE_ALARM
 35

	)

367 
	#CAP_BLOCK_SUSPEND
 36

	)

371 
	#CAP_AUDIT_READ
 37

	)

378 
	#CAP_PERFMON
 38

	)

409 
	#CAP_BPF
 39

	)

416 
	#CAP_CHECKPOINT_RESTORE
 40

	)

418 
	#CAP_LAST_CAP
 
CAP_CHECKPOINT_RESTORE


	)

420 
	#ˇp_vÆid
(
x
Ë((xË>0 && (xË<
CAP_LAST_CAP
)

	)

426 
	#CAP_TO_INDEX
(
x
Ë((xË>> 5Ë

	)

427 
	#CAP_TO_MASK
(
x
Ë(1U << ((xË& 31)Ë

	)

	@/usr/include/linux/falloc.h

2 #i‚de‡
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fs.h

2 #i‚de‡
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<löux/limôs.h
>

14 
	~<löux/io˘l.h
>

15 
	~<löux/ty≥s.h
>

16 
	~<löux/fs¸y±.h
>

19 
	~<löux/mou¡.h
>

32 #unde‡
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0Ë

	)

47 
	#RENAME_EXCHANGE
 (1 << 1Ë

	)

48 
	#RENAME_WHITEOUT
 (1 << 2Ë

	)

50 
	sfûe_˛⁄e_ønge
 {

51 
__s64
 
	m§c_fd
;

52 
__u64
 
	m§c_off£t
;

53 
__u64
 
	m§c_Àngth
;

54 
__u64
 
	mde°_off£t
;

57 
	sf°rim_ønge
 {

58 
__u64
 
	m°¨t
;

59 
__u64
 
	mÀn
;

60 
__u64
 
	mmöÀn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfûe_dedu≥_ønge_öfo
 {

69 
__s64
 
	mde°_fd
;

70 
__u64
 
	mde°_off£t
;

71 
__u64
 
	mbyãs_dedu≥d
;

78 
__s32
 
	m°©us
;

79 
__u32
 
	mª£rved
;

83 
	sfûe_dedu≥_ønge
 {

84 
__u64
 
	m§c_off£t
;

85 
__u64
 
	m§c_Àngth
;

86 
__u16
 
	mde°_cou¡
;

87 
__u16
 
	mª£rved1
;

88 
__u32
 
	mª£rved2
;

89 
fûe_dedu≥_ønge_öfo
 
	möfo
[0];

93 
	sfûes_°©_°ru˘
 {

94 
	mƒ_fûes
;

95 
	mƒ_‰ì_fûes
;

96 
	mmax_fûes
;

99 
	söodes_°©_t
 {

100 
	mƒ_öodes
;

101 
	mƒ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©å
 {

112 
__u32
 
	mfsx_xÊags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_√xã¡s
;

115 
__u32
 
	mfsx_¥ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_∑d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

183 
	#BLKGETDISKSEQ
 
	`_IOR
(0x12,128,
__u64
)

	)

189 
	#BMAP_IOCTL
 1

	)

190 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

191 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

192 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

193 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

194 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

195 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

196 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fûe_˛⁄e_ønge
)

	)

197 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fûe_dedu≥_ønge
)

	)

199 
	#FSLABEL_MAX
 256

	)

201 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

202 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

203 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

204 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

205 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

206 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

207 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

208 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

209 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

210 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©å
)

	)

211 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©å
)

	)

212 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

213 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

235 
	#FS_SECRM_FL
 0x00000001

	)

236 
	#FS_UNRM_FL
 0x00000002

	)

237 
	#FS_COMPR_FL
 0x00000004

	)

238 
	#FS_SYNC_FL
 0x00000008

	)

239 
	#FS_IMMUTABLE_FL
 0x00000010

	)

240 
	#FS_APPEND_FL
 0x00000020

	)

241 
	#FS_NODUMP_FL
 0x00000040

	)

242 
	#FS_NOATIME_FL
 0x00000080

	)

244 
	#FS_DIRTY_FL
 0x00000100

	)

245 
	#FS_COMPRBLK_FL
 0x00000200

	)

246 
	#FS_NOCOMP_FL
 0x00000400

	)

248 
	#FS_ENCRYPT_FL
 0x00000800

	)

249 
	#FS_BTREE_FL
 0x00001000

	)

250 
	#FS_INDEX_FL
 0x00001000

	)

251 
	#FS_IMAGIC_FL
 0x00002000

	)

252 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

253 
	#FS_NOTAIL_FL
 0x00008000

	)

254 
	#FS_DIRSYNC_FL
 0x00010000

	)

255 
	#FS_TOPDIR_FL
 0x00020000

	)

256 
	#FS_HUGE_FILE_FL
 0x00040000

	)

257 
	#FS_EXTENT_FL
 0x00080000

	)

258 
	#FS_VERITY_FL
 0x00100000

	)

259 
	#FS_EA_INODE_FL
 0x00200000

	)

260 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

261 
	#FS_NOCOW_FL
 0x00800000

	)

262 
	#FS_DAX_FL
 0x02000000

	)

263 
	#FS_INLINE_DATA_FL
 0x10000000

	)

264 
	#FS_PROJINHERIT_FL
 0x20000000

	)

265 
	#FS_CASEFOLD_FL
 0x40000000

	)

266 
	#FS_RESERVED_FL
 0x80000000

	)

268 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

269 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

272 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

273 
	#SYNC_FILE_RANGE_WRITE
 2

	)

274 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

275 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

276 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

277 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

283 
	t__bôwi£
 
	t__kî√l_rwf_t
;

286 
	#RWF_HIPRI
 ((
__kî√l_rwf_t
)0x00000001)

	)

289 
	#RWF_DSYNC
 ((
__kî√l_rwf_t
)0x00000002)

	)

292 
	#RWF_SYNC
 ((
__kî√l_rwf_t
)0x00000004)

	)

295 
	#RWF_NOWAIT
 ((
__kî√l_rwf_t
)0x00000008)

	)

298 
	#RWF_APPEND
 ((
__kî√l_rwf_t
)0x00000010)

	)

301 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

302 
RWF_APPEND
)

	)

	@/usr/include/linux/magic.h

2 #i‚de‡
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EROFS_SUPER_MAGIC_V1
 0xE0F5E1E2

	)

23 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

24 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

25 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

26 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

27 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

28 
	#NILFS_SUPER_MAGIC
 0x3434

	)

29 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

30 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

31 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

32 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

33 
	#XFS_SUPER_MAGIC
 0x58465342

	)

34 
	#PSTOREFS_MAGIC
 0x6165676C

	)

35 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

36 
	#HOSTFS_SUPER_MAGIC
 0x00c0f„e

	)

37 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

39 
	#MINIX_SUPER_MAGIC
 0x137F

	)

40 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

41 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

42 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

43 
	#MINIX3_SUPER_MAGIC
 0x4d5®

	)

45 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

46 
	#NCP_SUPER_MAGIC
 0x564¯

	)

47 
	#NFS_SUPER_MAGIC
 0x6969

	)

48 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

49 
	#OPENPROM_SUPER_MAGIC
 0x9Á1

	)

50 
	#QNX4_SUPER_MAGIC
 0x002‡

	)

51 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

52 
	#AFS_FS_MAGIC
 0x6B414653

	)

54 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

57 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

58 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

59 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

61 
	#SMB_SUPER_MAGIC
 0x517B

	)

62 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

63 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

65 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

67 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

69 
	#TRACEFS_MAGIC
 0x74726163

	)

71 
	#V9FS_MAGIC
 0x01021997

	)

73 
	#BDEVFS_MAGIC
 0x62646576

	)

74 
	#DAXFS_MAGIC
 0x64646178

	)

75 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

76 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

77 
	#BINDERFS_SUPER_MAGIC
 0x6c6f6f70

	)

78 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

79 
	#PIPEFS_MAGIC
 0x50495045

	)

80 
	#PROC_SUPER_MAGIC
 0x9Á0

	)

81 
	#SOCKFS_MAGIC
 0x534F434B

	)

82 
	#SYSFS_MAGIC
 0x62656572

	)

83 
	#USBDEVICE_SUPER_MAGIC
 0x9Á2

	)

84 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

85 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

86 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

87 
	#NSFS_MAGIC
 0x6e736673

	)

88 
	#BPF_FS_MAGIC
 0xˇ„4a11

	)

89 
	#AAFS_MAGIC
 0x5a3c69f0

	)

90 
	#ZONEFS_MAGIC
 0x5a4f4653

	)

93 
	#UDF_SUPER_MAGIC
 0x15013346

	)

94 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

95 
	#ZSMALLOC_MAGIC
 0x58295829

	)

96 
	#DMA_BUF_MAGIC
 0x444d4142

	)

97 
	#DEVMEM_MAGIC
 0x454d444d

	)

98 
	#Z3FOLD_MAGIC
 0x33

	)

99 
	#PPC_CMM_MAGIC
 0xc7571590

	)

100 
	#SECRETMEM_MAGIC
 0x5345434d

	)

102 
	#SHIFTFS_MAGIC
 0x6a656a62

	)

	@/usr/include/linux/module.h

2 #i‚de‡
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/mount.h

1 #i‚de‡
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

4 
	~<löux/ty≥s.h
>

13 
	#MS_RDONLY
 1

	)

14 
	#MS_NOSUID
 2

	)

15 
	#MS_NODEV
 4

	)

16 
	#MS_NOEXEC
 8

	)

17 
	#MS_SYNCHRONOUS
 16

	)

18 
	#MS_REMOUNT
 32

	)

19 
	#MS_MANDLOCK
 64

	)

20 
	#MS_DIRSYNC
 128

	)

21 
	#MS_NOSYMFOLLOW
 256

	)

22 
	#MS_NOATIME
 1024

	)

23 
	#MS_NODIRATIME
 2048

	)

24 
	#MS_BIND
 4096

	)

25 
	#MS_MOVE
 8192

	)

26 
	#MS_REC
 16384

	)

27 
	#MS_VERBOSE
 32768

	)

29 
	#MS_SILENT
 32768

	)

30 
	#MS_POSIXACL
 (1<<16Ë

	)

31 
	#MS_UNBINDABLE
 (1<<17Ë

	)

32 
	#MS_PRIVATE
 (1<<18Ë

	)

33 
	#MS_SLAVE
 (1<<19Ë

	)

34 
	#MS_SHARED
 (1<<20Ë

	)

35 
	#MS_RELATIME
 (1<<21Ë

	)

36 
	#MS_KERNMOUNT
 (1<<22Ë

	)

37 
	#MS_I_VERSION
 (1<<23Ë

	)

38 
	#MS_STRICTATIME
 (1<<24Ë

	)

39 
	#MS_LAZYTIME
 (1<<25Ë

	)

42 
	#MS_SUBMOUNT
 (1<<26)

	)

43 
	#MS_NOREMOTELOCK
 (1<<27)

	)

44 
	#MS_NOSEC
 (1<<28)

	)

45 
	#MS_BORN
 (1<<29)

	)

46 
	#MS_ACTIVE
 (1<<30)

	)

47 
	#MS_NOUSER
 (1<<31)

	)

52 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

53 
MS_LAZYTIME
)

	)

58 
	#MS_MGC_VAL
 0xC0ED0000

	)

59 
	#MS_MGC_MSK
 0xffff0000

	)

64 
	#OPEN_TREE_CLONE
 1

	)

65 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

70 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

71 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

72 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

73 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

74 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

75 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

76 
	#MOVE_MOUNT_SET_GROUP
 0x00000100

	)

77 
	#MOVE_MOUNT__MASK
 0x00000177

	)

82 
	#FSOPEN_CLOEXEC
 0x00000001

	)

87 
	#FSPICK_CLOEXEC
 0x00000001

	)

88 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

89 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

90 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

95 
	efsc⁄fig_comm™d
 {

96 
	mFSCONFIG_SET_FLAG
 = 0,

97 
	mFSCONFIG_SET_STRING
 = 1,

98 
	mFSCONFIG_SET_BINARY
 = 2,

99 
	mFSCONFIG_SET_PATH
 = 3,

100 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

101 
	mFSCONFIG_SET_FD
 = 5,

102 
	mFSCONFIG_CMD_CREATE
 = 6,

103 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

109 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

114 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

115 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

116 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

117 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

118 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

119 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

120 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

121 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

122 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

123 
	#MOUNT_ATTR_IDMAP
 0x00100000

	)

124 
	#MOUNT_ATTR_NOSYMFOLLOW
 0x00200000

	)

129 
	smou¡_©å
 {

130 
__u64
 
	m©å_£t
;

131 
__u64
 
	m©å_˛r
;

132 
__u64
 
	m¥›ag©i⁄
;

133 
__u64
 
	mu£∫s_fd
;

137 
	#MOUNT_ATTR_SIZE_VER0
 32

	)

	@/usr/include/linux/random.h

8 #i‚de‡
_LINUX_RANDOM_H


9 
	#_LINUX_RANDOM_H


	)

11 
	~<löux/ty≥s.h
>

12 
	~<löux/io˘l.h
>

13 
	~<löux/úqƒ.h
>

18 
	#RNDGETENTCNT
 
	`_IOR
–'R', 0x00, )

	)

21 
	#RNDADDTOENTCNT
 
	`_IOW
–'R', 0x01, )

	)

24 
	#RNDGETPOOL
 
	`_IOR
–'R', 0x02, [2] )

	)

30 
	#RNDADDENTROPY
 
	`_IOW
–'R', 0x03, [2] )

	)

33 
	#RNDZAPENTCNT
 
	`_IO
–'R', 0x04 )

	)

36 
	#RNDCLEARPOOL
 
	`_IO
–'R', 0x06 )

	)

39 
	#RNDRESEEDCRNG
 
	`_IO
–'R', 0x07 )

	)

41 
	sønd_poﬁ_öfo
 {

42 
	míå›y_cou¡
;

43 
	mbuf_size
;

44 
__u32
 
	mbuf
[0];

54 
	#GRND_NONBLOCK
 0x0001

	)

55 
	#GRND_RANDOM
 0x0002

	)

56 
	#GRND_INSECURE
 0x0004

	)

	@/usr/include/linux/rtc.h

12 #i‚de‡
_LINUX_RTC_H_


13 
	#_LINUX_RTC_H_


	)

15 
	~<löux/c⁄°.h
>

16 
	~<löux/io˘l.h
>

24 
	sπc_time
 {

25 
	mtm_£c
;

26 
	mtm_mö
;

27 
	mtm_hour
;

28 
	mtm_mday
;

29 
	mtm_m⁄
;

30 
	mtm_yór
;

31 
	mtm_wday
;

32 
	mtm_yday
;

33 
	mtm_isd°
;

40 
	sπc_wkÆrm
 {

41 
	míabÀd
;

42 
	m≥ndög
;

43 
πc_time
 
	mtime
;

59 
	sπc_∂l_öfo
 {

60 
	m∂l_˘æ
;

61 
	m∂l_vÆue
;

62 
	m∂l_max
;

63 
	m∂l_mö
;

64 
	m∂l_posmu…
;

65 
	m∂l_√gmu…
;

66 
	m∂l_˛ock
;

74 
	#RTC_AIE_ON
 
	`_IO
('p', 0x01Ë

	)

75 
	#RTC_AIE_OFF
 
	`_IO
('p', 0x02Ë

	)

76 
	#RTC_UIE_ON
 
	`_IO
('p', 0x03Ë

	)

77 
	#RTC_UIE_OFF
 
	`_IO
('p', 0x04Ë

	)

78 
	#RTC_PIE_ON
 
	`_IO
('p', 0x05Ë

	)

79 
	#RTC_PIE_OFF
 
	`_IO
('p', 0x06Ë

	)

80 
	#RTC_WIE_ON
 
	`_IO
('p', 0x0fË

	)

81 
	#RTC_WIE_OFF
 
	`_IO
('p', 0x10Ë

	)

83 
	#RTC_ALM_SET
 
	`_IOW
('p', 0x07, 
πc_time
Ë

	)

84 
	#RTC_ALM_READ
 
	`_IOR
('p', 0x08, 
πc_time
Ë

	)

85 
	#RTC_RD_TIME
 
	`_IOR
('p', 0x09, 
πc_time
Ë

	)

86 
	#RTC_SET_TIME
 
	`_IOW
('p', 0x0a, 
πc_time
Ë

	)

87 
	#RTC_IRQP_READ
 
	`_IOR
('p', 0x0b, Ë

	)

88 
	#RTC_IRQP_SET
 
	`_IOW
('p', 0x0c, Ë

	)

89 
	#RTC_EPOCH_READ
 
	`_IOR
('p', 0x0d, Ë

	)

90 
	#RTC_EPOCH_SET
 
	`_IOW
('p', 0x0e, Ë

	)

92 
	#RTC_WKALM_SET
 
	`_IOW
('p', 0x0f, 
πc_wkÆrm
)

	)

93 
	#RTC_WKALM_RD
 
	`_IOR
('p', 0x10, 
πc_wkÆrm
)

	)

95 
	#RTC_PLL_GET
 
	`_IOR
('p', 0x11, 
πc_∂l_öfo
Ë

	)

96 
	#RTC_PLL_SET
 
	`_IOW
('p', 0x12, 
πc_∂l_öfo
Ë

	)

98 
	#RTC_VL_DATA_INVALID
 
	`_BITUL
(0Ë

	)

99 
	#RTC_VL_BACKUP_LOW
 
	`_BITUL
(1Ë

	)

100 
	#RTC_VL_BACKUP_EMPTY
 
	`_BITUL
(2Ë

	)

101 
	#RTC_VL_ACCURACY_LOW
 
	`_BITUL
(3Ë

	)

102 
	#RTC_VL_BACKUP_SWITCH
 
	`_BITUL
(4Ë

	)

104 
	#RTC_VL_READ
 
	`_IOR
('p', 0x13, Ë

	)

105 
	#RTC_VL_CLR
 
	`_IO
('p', 0x14Ë

	)

108 
	#RTC_IRQF
 0x80

	)

109 
	#RTC_PF
 0x40

	)

110 
	#RTC_AF
 0x20

	)

111 
	#RTC_UF
 0x10

	)

114 
	#RTC_FEATURE_ALARM
 0

	)

115 
	#RTC_FEATURE_ALARM_RES_MINUTE
 1

	)

116 
	#RTC_FEATURE_NEED_WEEK_DAY
 2

	)

117 
	#RTC_FEATURE_CNT
 3

	)

119 
	#RTC_MAX_FREQ
 8192

	)

	@/usr/include/linux/sched.h

2 #i‚de‡
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

5 
	~<löux/ty≥s.h
>

10 
	#CSIGNAL
 0x000000f‡

	)

11 
	#CLONE_VM
 0x00000100

	)

12 
	#CLONE_FS
 0x00000200

	)

13 
	#CLONE_FILES
 0x00000400

	)

14 
	#CLONE_SIGHAND
 0x00000800

	)

15 
	#CLONE_PIDFD
 0x00001000

	)

16 
	#CLONE_PTRACE
 0x00002000

	)

17 
	#CLONE_VFORK
 0x00004000

	)

18 
	#CLONE_PARENT
 0x00008000

	)

19 
	#CLONE_THREAD
 0x00010000

	)

20 
	#CLONE_NEWNS
 0x00020000

	)

21 
	#CLONE_SYSVSEM
 0x00040000

	)

22 
	#CLONE_SETTLS
 0x00080000

	)

23 
	#CLONE_PARENT_SETTID
 0x00100000

	)

24 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

25 
	#CLONE_DETACHED
 0x00400000

	)

26 
	#CLONE_UNTRACED
 0x00800000

	)

27 
	#CLONE_CHILD_SETTID
 0x01000000

	)

28 
	#CLONE_NEWCGROUP
 0x02000000

	)

29 
	#CLONE_NEWUTS
 0x04000000

	)

30 
	#CLONE_NEWIPC
 0x08000000

	)

31 
	#CLONE_NEWUSER
 0x10000000

	)

32 
	#CLONE_NEWPID
 0x20000000

	)

33 
	#CLONE_NEWNET
 0x40000000

	)

34 
	#CLONE_IO
 0x80000000

	)

37 
	#CLONE_CLEAR_SIGHAND
 0x100000000ULL

	)

38 
	#CLONE_INTO_CGROUP
 0x200000000ULL

	)

44 
	#CLONE_NEWTIME
 0x00000080

	)

46 #i‚de‡
__ASSEMBLY__


92 
	s˛⁄e_¨gs
 {

93 
__Æig√d_u64
 
	mÊags
;

94 
__Æig√d_u64
 
	mpidfd
;

95 
__Æig√d_u64
 
	mchûd_tid
;

96 
__Æig√d_u64
 
	m∑ª¡_tid
;

97 
__Æig√d_u64
 
	mexô_sig«l
;

98 
__Æig√d_u64
 
	m°ack
;

99 
__Æig√d_u64
 
	m°ack_size
;

100 
__Æig√d_u64
 
	més
;

101 
__Æig√d_u64
 
	m£t_tid
;

102 
__Æig√d_u64
 
	m£t_tid_size
;

103 
__Æig√d_u64
 
	mcgroup
;

107 
	#CLONE_ARGS_SIZE_VER0
 64

	)

108 
	#CLONE_ARGS_SIZE_VER1
 80

	)

109 
	#CLONE_ARGS_SIZE_VER2
 88

	)

114 
	#SCHED_NORMAL
 0

	)

115 
	#SCHED_FIFO
 1

	)

116 
	#SCHED_RR
 2

	)

117 
	#SCHED_BATCH
 3

	)

119 
	#SCHED_IDLE
 5

	)

120 
	#SCHED_DEADLINE
 6

	)

123 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

128 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

129 
	#SCHED_FLAG_RECLAIM
 0x02

	)

130 
	#SCHED_FLAG_DL_OVERRUN
 0x04

	)

131 
	#SCHED_FLAG_KEEP_POLICY
 0x08

	)

132 
	#SCHED_FLAG_KEEP_PARAMS
 0x10

	)

133 
	#SCHED_FLAG_UTIL_CLAMP_MIN
 0x20

	)

134 
	#SCHED_FLAG_UTIL_CLAMP_MAX
 0x40

	)

136 
	#SCHED_FLAG_KEEP_ALL
 (
SCHED_FLAG_KEEP_POLICY
 | \

137 
SCHED_FLAG_KEEP_PARAMS
)

	)

139 
	#SCHED_FLAG_UTIL_CLAMP
 (
SCHED_FLAG_UTIL_CLAMP_MIN
 | \

140 
SCHED_FLAG_UTIL_CLAMP_MAX
)

	)

142 
	#SCHED_FLAG_ALL
 (
SCHED_FLAG_RESET_ON_FORK
 | \

143 
SCHED_FLAG_RECLAIM
 | \

144 
SCHED_FLAG_DL_OVERRUN
 | \

145 
SCHED_FLAG_KEEP_ALL
 | \

146 
SCHED_FLAG_UTIL_CLAMP
)

	)

	@/usr/include/linux/string.h

2 #i‚de‡
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<°rög.h
>

	@/usr/include/linux/time.h

2 #i‚de‡
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<löux/ty≥s.h
>

6 
	~<löux/time_ty≥s.h
>

8 #i‚de‡
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime•ec
 {

11 
__kî√l_ﬁd_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimevÆ
 {

17 
__kî√l_ﬁd_time_t
 
	mtv_£c
;

18 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

21 
	sôimî•ec
 {

22 
time•ec
 
	mô_öãrvÆ
;

23 
time•ec
 
	mô_vÆue
;

26 
	sôimîvÆ
 {

27 
timevÆ
 
	mô_öãrvÆ
;

28 
timevÆ
 
	mô_vÆue
;

31 
	stimez⁄e
 {

32 
	mtz_möuãswe°
;

33 
	mtz_d°time
;

40 
	#ITIMER_REAL
 0

	)

41 
	#ITIMER_VIRTUAL
 1

	)

42 
	#ITIMER_PROF
 2

	)

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

61 
	#CLOCK_SGI_CYCLE
 10

	)

62 
	#CLOCK_TAI
 11

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

2 #i‚de‡
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty≥s.h
>

7 #i‚de‡
__ASSEMBLY__


9 
	~<löux/posix_ty≥s.h
>

17 #ifde‡
__CHECKER__


18 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

20 
	#__bôwi£__


	)

22 
	#__bôwi£
 
__bôwi£__


	)

24 
__u16
 
	t__bôwi£
 
	t__À16
;

25 
__u16
 
	t__bôwi£
 
	t__be16
;

26 
__u32
 
	t__bôwi£
 
	t__À32
;

27 
__u32
 
	t__bôwi£
 
	t__be32
;

28 
__u64
 
	t__bôwi£
 
	t__À64
;

29 
__u64
 
	t__bôwi£
 
	t__be64
;

31 
__u16
 
	t__bôwi£
 
	t__sum16
;

32 
__u32
 
	t__bôwi£
 
	t__wsum
;

43 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

44 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

45 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	t__bôwi£
 
	t__pﬁl_t
;

	@/usr/include/linux/uio.h

10 #i‚de‡
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<löux/ty≥s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__kî√l_size_t
 
	miov_Àn
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 331687

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
Ë((◊Ë<< 16Ë+ ((bË<< 8Ë+ ((cË> 255 ? 255 : (c)))

	)

3 
	#LINUX_VERSION_MAJOR
 5

	)

4 
	#LINUX_VERSION_PATCHLEVEL
 15

	)

5 
	#LINUX_VERSION_SUBLEVEL
 167

	)

	@/usr/include/linux/const.h

4 #i‚de‡
_LINUX_CONST_H


5 
	#_LINUX_CONST_H


	)

16 #ifde‡
__ASSEMBLY__


17 
	#_AC
(
X
,
Y
Ë
	)
X

18 
	#_AT
(
T
,
X
Ë
	)
X

20 
	#__AC
(
X
,
Y
Ë(X##Y)

	)

21 
	#_AC
(
X
,
Y
Ë
	`__AC
(X,Y)

	)

22 
	#_AT
(
T
,
X
Ë((T)(X))

	)

25 
	#_UL
(
x
Ë(
	`_AC
(x, 
UL
))

	)

26 
	#_ULL
(
x
Ë(
	`_AC
(x, 
ULL
))

	)

28 
	#_BITUL
(
x
Ë(
	`_UL
(1Ë<< (x))

	)

29 
	#_BITULL
(
x
Ë(
	`_ULL
(1Ë<< (x))

	)

31 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`__ty≥of__
(x))◊Ë- 1)

	)

32 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

34 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
Ë((“Ë+ (dË- 1Ë/ (d))

	)

	@/usr/include/linux/fscrypt.h

8 #i‚de‡
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<löux/io˘l.h
>

12 
	~<löux/ty≥s.h
>

15 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

20 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

21 
	#FSCRYPT_POLICY_FLAG_IV_INO_LBLK_64
 0x08

	)

22 
	#FSCRYPT_POLICY_FLAG_IV_INO_LBLK_32
 0x10

	)

25 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

26 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

27 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

28 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

29 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

38 
	#FSCRYPT_POLICY_V1
 0

	)

39 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

40 
	sfs¸y±_pﬁicy_v1
 {

41 
__u8
 
	mvîsi⁄
;

42 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

43 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

44 
__u8
 
	mÊags
;

45 
__u8
 
	mma°î_key_des¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

52 
	#FSCRYPT_KEY_DESC_PREFIX
 "fs¸y±:"

	)

53 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

54 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

55 
	sfs¸y±_key
 {

56 
__u32
 
	mmode
;

57 
__u8
 
	møw
[
FSCRYPT_MAX_KEY_SIZE
];

58 
__u32
 
	msize
;

64 
	#FSCRYPT_POLICY_V2
 2

	)

65 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

66 
	sfs¸y±_pﬁicy_v2
 {

67 
__u8
 
	mvîsi⁄
;

68 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

69 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

70 
__u8
 
	mÊags
;

71 
__u8
 
	m__ª£rved
[4];

72 
__u8
 
	mma°î_key_idítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

76 
	sfs¸y±_gë_pﬁicy_ex_¨g
 {

77 
__u64
 
	mpﬁicy_size
;

79 
__u8
 
	mvîsi⁄
;

80 
fs¸y±_pﬁicy_v1
 
	mv1
;

81 
fs¸y±_pﬁicy_v2
 
	mv2
;

82 } 
	mpﬁicy
;

89 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

96 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

102 
	sfs¸y±_key_•ecifõr
 {

103 
__u32
 
	mty≥
;

104 
__u32
 
	m__ª£rved
;

106 
__u8
 
	m__ª£rved
[32];

107 
__u8
 
	mdes¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

108 
__u8
 
	midítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

109 } 
	mu
;

116 
	sfs¸y±_¥ovisi⁄ög_key_∑ylﬂd
 {

117 
__u32
 
	mty≥
;

118 
__u32
 
	m__ª£rved
;

119 
__u8
 
	møw
[];

123 
	sfs¸y±_add_key_¨g
 {

124 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

125 
__u32
 
	møw_size
;

126 
__u32
 
	mkey_id
;

127 
__u32
 
	m__ª£rved
[8];

128 
__u8
 
	møw
[];

132 
	sfs¸y±_ªmove_key_¨g
 {

133 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

134 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

135 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

136 
__u32
 
	mªmovÆ_°©us_Êags
;

137 
__u32
 
	m__ª£rved
[5];

141 
	sfs¸y±_gë_key_°©us_¨g
 {

143 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

144 
__u32
 
	m__ª£rved
[6];

147 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

148 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

149 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

150 
__u32
 
	m°©us
;

151 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

152 
__u32
 
	m°©us_Êags
;

153 
__u32
 
	mu£r_cou¡
;

154 
__u32
 
	m__out_ª£rved
[13];

157 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fs¸y±_pﬁicy_v1
)

	)

158 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

159 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fs¸y±_pﬁicy_v1
)

	)

160 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]Ë

	)

161 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fs¸y±_add_key_¨g
)

	)

162 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fs¸y±_ªmove_key_¨g
)

	)

163 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fs¸y±_ªmove_key_¨g
)

	)

164 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fs¸y±_gë_key_°©us_¨g
)

	)

165 
	#FS_IOC_GET_ENCRYPTION_NONCE
 
	`_IOR
('f', 27, 
__u8
[16])

	)

170 
	#fs¸y±_pﬁicy
 
fs¸y±_pﬁicy_v1


	)

171 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

172 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

173 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

174 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

175 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

176 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

177 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

178 
	#FS_POLICY_FLAGS_VALID
 0x07

	)

179 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

180 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

181 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

182 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

183 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

184 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

185 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

186 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

187 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

188 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

189 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

190 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

191 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/ioctl.h

2 #i‚de‡
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/io˘l.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/limits.h

2 #i‚de‡
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #i‚de‡
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<löux/°ddef.h
>

22 #unde‡
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__kî√l_fd_£t
;

30 (*
	t__kî√l_sigh™dÀr_t
)();

33 
	t__kî√l_key_t
;

34 
	t__kî√l_mqd_t
;

36 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/time_types.h

2 #i‚de‡
_LINUX_TIME_TYPES_H


3 
	#_LINUX_TIME_TYPES_H


	)

5 
	~<löux/ty≥s.h
>

7 
	s__kî√l_time•ec
 {

8 
__kî√l_time64_t
 
	mtv_£c
;

9 
	mtv_n£c
;

12 
	s__kî√l_ôimî•ec
 {

13 
__kî√l_time•ec
 
	mô_öãrvÆ
;

14 
__kî√l_time•ec
 
	mô_vÆue
;

24 #i‚de‡
__kî√l_ﬁd_timevÆ


25 
	s__kî√l_ﬁd_timevÆ
 {

26 
__kî√l_l⁄g_t
 
	mtv_£c
;

27 
__kî√l_l⁄g_t
 
	mtv_u£c
;

31 
	s__kî√l_ﬁd_time•ec
 {

32 
__kî√l_ﬁd_time_t
 
	mtv_£c
;

33 
	mtv_n£c
;

36 
	s__kî√l_ﬁd_ôimîvÆ
 {

37 
__kî√l_ﬁd_timevÆ
 
	mô_öãrvÆ
;

38 
__kî√l_ﬁd_timevÆ
 
	mô_vÆue
;

41 
	s__kî√l_sock_timevÆ
 {

42 
__s64
 
	mtv_£c
;

43 
__s64
 
	mtv_u£c
;

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<bôs/libc-hódî-°¨t.h
>

28 
	g__BEGIN_DECLS


31 
	#__√ed_size_t


	)

32 
	#__√ed_NULL


	)

33 
	~<°ddef.h
>

36 #i‡
deföed
 
__˝lu•lus
 && (
__GNUC_PREREQ
 (4, 4) \

37 || 
	$__glibc_˛™g_¥îeq
 (3, 5))

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

43 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

44 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

47 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

48 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

53 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN
 || 
	`__GLIBC_USE
 (
ISOC2X
)

54 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__n⁄nuŒ
 ((1, 2)Ë
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 1, 4));

61 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

64 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

65 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

80 
	$__memcm≥q
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

81 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

84 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


87 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

88 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

89 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

90 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

92 #ifde‡
__OPTIMIZE__


93 
__exã∫_Æways_ölöe
 *

94 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


96  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

99 
__exã∫_Æways_ölöe
 const *

100 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


102  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

105 
	}
}

107 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

108 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

111 #ifde‡
__USE_GNU


114 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


115 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

116 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

117 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

118 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

120 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

121 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

125 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


126 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

127 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1))

128 
	`__©å_ac˚ss
 ((
__ªad_⁄ly__
, 1, 3));

129 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

130 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1))

131 
	`__©å_ac˚ss
 ((
__ªad_⁄ly__
, 1, 3));

133 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

134 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1))

135 
	`__©å_ac˚ss
 ((
__ªad_⁄ly__
, 1, 3));

141 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

142 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

144 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

145 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

146 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

149 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

150 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

152 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

153 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

156 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

157 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

159 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

160 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

163 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

164 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

166 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

167 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

168 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 1, 3));

170 #ifde‡
__USE_XOPEN2K8


172 
	~<bôs/ty≥s/loˇÀ_t.h
>

175 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__l
)

176 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

179 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

180 
loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4))

181 
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 1, 3));

184 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8
 \

185 || 
	`__GLIBC_USE
 (
LIB_EXT2
Ë|| 
	$__GLIBC_USE
 (
ISOC2X
))

187 *
	$°rdup
 (c⁄° *
__s
)

188 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

194 #i‡
deföed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
Ë|| __GLIBC_USE (
ISOC2X
)

195 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

196 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

199 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


201 
	#°rdu∑
(
s
) \

202 (
__exãnsi⁄__
 \

204 c⁄° *
__ﬁd
 = (
s
); \

205 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

206 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

207 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

208 
	}
}))

	)

211 
	#°∫du∑
(
s
, 
n
) \

212 (
__exãnsi⁄__
 \

214 c⁄° *
__ﬁd
 = (
s
); \

215 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

216 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

217 
__√w
[
__Àn
] = '\0'; \

218 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

219 }))

	)

223 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


226 *
°rchr
 (*
__s
, 
__c
)

227 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

228 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

229 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

231 #ifde‡
__OPTIMIZE__


232 
__exã∫_Æways_ölöe
 *

233 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


235  
__buûtö_°rchr
 (
__s
, 
__c
);

238 
__exã∫_Æways_ölöe
 const *

239 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


241  
__buûtö_°rchr
 (
__s
, 
__c
);

246 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

247 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

250 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


253 *
	`°ºchr
 (*
__s
, 
__c
)

254 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

255 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

256 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

258 #ifde‡
__OPTIMIZE__


259 
__exã∫_Æways_ölöe
 *

260 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


262  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

265 
__exã∫_Æways_ölöe
 const *

266 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


268  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

271 
	}
}

273 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

274 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

277 #ifde‡
__USE_GNU


280 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


281 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

282 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

283 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

284 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

286 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

287 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

293 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

294 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

297 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

298 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

300 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


303 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

304 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

305 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

306 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

308 #ifde‡
__OPTIMIZE__


309 
__exã∫_Æways_ölöe
 *

310 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


312  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

315 
__exã∫_Æways_ölöe
 const *

316 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


318  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

321 
	}
}

323 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

324 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

327 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


330 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

331 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

332 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

333 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

335 #ifde‡
__OPTIMIZE__


336 
__exã∫_Æways_ölöe
 *

337 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


339  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

342 
__exã∫_Æways_ölöe
 const *

343 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


345  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

348 
	}
}

350 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

351 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

356 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

357 
__THROW
 
	`__n⁄nuŒ
 ((2));

361 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

362 c⁄° *
__ª°ri˘
 
__dñim
,

363 **
__ª°ri˘
 
__ßve_±r
)

364 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

365 #ifde‡
__USE_POSIX


366 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

367 **
__ª°ri˘
 
__ßve_±r
)

368 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

371 #ifde‡
__USE_GNU


373 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


374 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

375 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

376 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

377 c⁄° *
__√edÀ
)

378 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

380 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

381 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

385 #ifde‡
__USE_GNU


389 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

390 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

391 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3))

392 
	`__©å_ac˚ss
 ((
__ªad_⁄ly__
, 1, 2))

393 
	`__©å_ac˚ss
 ((
__ªad_⁄ly__
, 3, 4));

397 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

398 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

399 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

400 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

401 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

402 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

407 
size_t
 
	$°æí
 (c⁄° *
__s
)

408 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

410 #ifdef 
__USE_XOPEN2K8


413 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

414 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

419 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

420 #ifde‡
__USE_XOPEN2K


428 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


431 #ifde‡
__REDIRECT_NTH


432 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

433 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

434 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2))

435 
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 2, 3));

437 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

438 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 2, 3));

439 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

444 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

445 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
 
	`__©å_ac˚ss
 ((
__wrôe_⁄ly__
, 2, 3));

448 #ifde‡
__USE_GNU


450 c⁄° *
	$°ªº‹desc_≈
 (
__îr
Ë
__THROW
;

452 c⁄° *
	$°ªº‹«me_≈
 (
__îr
Ë
__THROW
;

456 #ifde‡
__USE_XOPEN2K8


458 *
	$°ªº‹_l
 (
__î∫um
, 
loˇÀ_t
 
__l
Ë
__THROW
;

461 #ifde‡
__USE_MISC


462 
	~<°rögs.h
>

466 
	$ex∂icô_bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1))

467 
	`__f‹tifõd_©å_ac˚ss
 (
__wrôe_⁄ly__
, 1, 2);

471 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

472 c⁄° *
__ª°ri˘
 
__dñim
)

473 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

476 #ifdef 
__USE_XOPEN2K8


478 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

480 #ifde‡
__USE_GNU


482 c⁄° *
	$sigabbªv_≈
 (
__sig
Ë
__THROW
;

485 c⁄° *
	$sigdes¸_≈
 (
__sig
Ë
__THROW
;

489 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

490 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

491 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

492 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

496 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

497 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

498 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

499 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

500 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

501 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

504 #ifdef 
__USE_GNU


506 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

507 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

510 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

513 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1))

514 
	`__©å_ac˚ss
 ((
__ªad_wrôe__
, 1, 2));

516 #i‚de‡
ba£«me


521 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


522 "C++" *
	$ba£«me
 (*
__fûíame
)

523 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

524 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

525 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

527 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

532 #i‡
	`__GNUC_PREREQ
 (3,4)

533 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


535 
	~<bôs/°rög_f‹tifõd.h
>

539 
__END_DECLS


	@/usr/include/linux/stddef.h

2 #i‚de‡
_LINUX_STDDEF_H


3 
	#_LINUX_STDDEF_H


	)

7 #i‚de‡
__Æways_ölöe


8 
	#__Æways_ölöe
 
__ölöe__


	)

26 
	#__°ru˘_group
(
TAG
, 
NAME
, 
ATTRS
, 
MEMBERS
...) \

28 °ru˘ { 
MEMBERS
 } 
ATTRS
; \

29 
	sTAG
 { 
MEMBERS
 } 
ATTRS
 
NAME
; \

30 } 
ATTRS


	)

42 
	#__DECLARE_FLEX_ARRAY
(
TYPE
, 
NAME
) \

44 °ru˘ { } 
__em±y_
 ## 
NAME
; \

45 
TYPE
 
NAME
[]; \

46 }

	)

	@/usr/include/strings.h

18 #i‚def 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<„©uªs.h
>

22 
	#__√ed_size_t


	)

23 
	~<°ddef.h
>

26 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


34 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

38 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

39 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

42 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

45 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`ödex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

50 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

53 #i‡
deföed
 
__OPTIMIZE__


54 
__exã∫_Æways_ölöe
 *

55 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


57  
	`__buûtö_ödex
 (
__s
, 
__c
);

60 
__exã∫_Æways_ölöe
 const *

61 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


63  
	`__buûtö_ödex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$ödex
 (c⁄° *
__s
, 
__c
)

69 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

73 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`rödex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

81 #i‡
deföed
 
__OPTIMIZE__


82 
__exã∫_Æways_ölöe
 *

83 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


85  
	`__buûtö_rödex
 (
__s
, 
__c
);

88 
__exã∫_Æways_ölöe
 const *

89 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


91  
	`__buûtö_rödex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$rödex
 (c⁄° *
__s
, 
__c
)

97 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

101 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8
 || deföed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
Ë
__THROW
 
__©åibuã_c⁄°__
;

109 #ifdef 
__USE_MISC


110 
	$ff¶
 (
__l
Ë
__THROW
 
__©åibuã_c⁄°__
;

111 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

112 
__THROW
 
__©åibuã_c⁄°__
;

116 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

117 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

120 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<bôs/ty≥s/loˇÀ_t.h
>

128 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__loc
)

129 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

133 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

134 
size_t
 
__n
, 
loˇÀ_t
 
__loc
)

135 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

138 
__END_DECLS


140 #i‡
	`__GNUC_PREREQ
 (3,4Ë&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
deföed
 
__f‹tify_fun˘i⁄


143 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


144 
	~<bôs/°rögs_f‹tifõd.h
>

	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

126 #unde‡
__USE_ISOC11


127 #unde‡
__USE_ISOC99


128 #unde‡
__USE_ISOC95


129 #unde‡
__USE_ISOCXX11


130 #unde‡
__USE_POSIX


131 #unde‡
__USE_POSIX2


132 #unde‡
__USE_POSIX199309


133 #unde‡
__USE_POSIX199506


134 #unde‡
__USE_XOPEN


135 #unde‡
__USE_XOPEN_EXTENDED


136 #unde‡
__USE_UNIX98


137 #unde‡
__USE_XOPEN2K


138 #unde‡
__USE_XOPEN2KXSI


139 #unde‡
__USE_XOPEN2K8


140 #unde‡
__USE_XOPEN2K8XSI


141 #unde‡
__USE_LARGEFILE


142 #unde‡
__USE_LARGEFILE64


143 #unde‡
__USE_FILE_OFFSET64


144 #unde‡
__USE_MISC


145 #unde‡
__USE_ATFILE


146 #unde‡
__USE_DYNAMIC_STACK_SIZE


147 #unde‡
__USE_GNU


148 #unde‡
__USE_FORTIFY_LEVEL


149 #unde‡
__KERNEL_STRICT_NAMES


150 #unde‡
__GLIBC_USE_ISOC2X


151 #unde‡
__GLIBC_USE_DEPRECATED_GETS


152 #unde‡
__GLIBC_USE_DEPRECATED_SCANF


156 #i‚de‡
_LOOSE_KERNEL_NAMES


157 
	#__KERNEL_STRICT_NAMES


	)

167 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


168 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

169 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

171 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

178 #i‡
deföed
 
__˛™g_maj‹__
 && deföed 
__˛™g_mö‹__


179 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
) \

180 ((
__˛™g_maj‹__
 << 16Ë+ 
__˛™g_mö‹__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

182 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
Ë0

	)

186 
	#__GLIBC_USE
(
F
Ë
__GLIBC_USE_
 ## 
	)
F

192 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

193 && !
deföed
 
	g_DEFAULT_SOURCE


195 #unde‡
_DEFAULT_SOURCE


196 
	#_DEFAULT_SOURCE
 1

	)

200 #ifde‡
_GNU_SOURCE


201 #unde‡
_ISOC95_SOURCE


202 
	#_ISOC95_SOURCE
 1

	)

203 #unde‡
_ISOC99_SOURCE


204 
	#_ISOC99_SOURCE
 1

	)

205 #unde‡
_ISOC11_SOURCE


206 
	#_ISOC11_SOURCE
 1

	)

207 #unde‡
_ISOC2X_SOURCE


208 
	#_ISOC2X_SOURCE
 1

	)

209 #unde‡
_POSIX_SOURCE


210 
	#_POSIX_SOURCE
 1

	)

211 #unde‡
_POSIX_C_SOURCE


212 
	#_POSIX_C_SOURCE
 200809L

	)

213 #unde‡
_XOPEN_SOURCE


214 
	#_XOPEN_SOURCE
 700

	)

215 #unde‡
_XOPEN_SOURCE_EXTENDED


216 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

217 #unde‡
_LARGEFILE64_SOURCE


218 
	#_LARGEFILE64_SOURCE
 1

	)

219 #unde‡
_DEFAULT_SOURCE


220 
	#_DEFAULT_SOURCE
 1

	)

221 #unde‡
_ATFILE_SOURCE


222 
	#_ATFILE_SOURCE
 1

	)

223 #unde‡
_DYNAMIC_STACK_SIZE_SOURCE


224 
	#_DYNAMIC_STACK_SIZE_SOURCE
 1

	)

229 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

230 || (!
deföed
 
	g__STRICT_ANSI__
 \

231 && !
deföed
 
	g_ISOC99_SOURCE
 && !deföed 
	g_ISOC11_SOURCE
 \

232 && !
deföed
 
	g_ISOC2X_SOURCE
 \

233 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

234 && !
deföed
 
	g_XOPEN_SOURCE
))

235 #unde‡
_DEFAULT_SOURCE


236 
	#_DEFAULT_SOURCE
 1

	)

240 #i‡(
deföed
 
_ISOC2X_SOURCE
 \

241 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ > 201710L))

242 
	#__GLIBC_USE_ISOC2X
 1

	)

244 
	#__GLIBC_USE_ISOC2X
 0

	)

248 #i‡(
deföed
 
_ISOC11_SOURCE
 || deföed 
_ISOC2X_SOURCE
 \

249 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

250 
	#__USE_ISOC11
 1

	)

254 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

255 || 
deföed
 
_ISOC2X_SOURCE
 \

256 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

257 
	#__USE_ISOC99
 1

	)

261 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

262 || 
deföed
 
_ISOC2X_SOURCE
 \

263 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

264 
	#__USE_ISOC95
 1

	)

267 #ifde‡
__˝lu•lus


269 #i‡
__˝lu•lus
 >= 201703L

270 
	#__USE_ISOC11
 1

	)

274 #i‡
__˝lu•lus
 >201103L || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__


275 
	#__USE_ISOCXX11
 1

	)

276 
	#__USE_ISOC99
 1

	)

283 #ifde‡
_DEFAULT_SOURCE


284 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


285 
	#__USE_POSIX_IMPLICITLY
 1

	)

287 #unde‡
_POSIX_SOURCE


288 
	#_POSIX_SOURCE
 1

	)

289 #unde‡
_POSIX_C_SOURCE


290 
	#_POSIX_C_SOURCE
 200809L

	)

293 #i‡((!
deföed
 
__STRICT_ANSI__
 \

294 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

295 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

296 
	#_POSIX_SOURCE
 1

	)

297 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

298 
	#_POSIX_C_SOURCE
 2

	)

299 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

300 
	#_POSIX_C_SOURCE
 199506L

	)

301 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

302 
	#_POSIX_C_SOURCE
 200112L

	)

304 
	#_POSIX_C_SOURCE
 200809L

	)

306 
	#__USE_POSIX_IMPLICITLY
 1

	)

315 #i‡((!
deföed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

316 && (
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE
))

317 
	#_POSIX_SOURCE
 1

	)

318 #unde‡
_POSIX_C_SOURCE


319 
	#_POSIX_C_SOURCE
 199506L

	)

322 #i‡(
deföed
 
_POSIX_SOURCE
 \

323 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

324 || 
deföed
 
_XOPEN_SOURCE
)

325 
	#__USE_POSIX
 1

	)

328 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


329 
	#__USE_POSIX2
 1

	)

332 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

333 
	#__USE_POSIX199309
 1

	)

336 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

337 
	#__USE_POSIX199506
 1

	)

340 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

341 
	#__USE_XOPEN2K
 1

	)

342 #unde‡
__USE_ISOC95


343 
	#__USE_ISOC95
 1

	)

344 #unde‡
__USE_ISOC99


345 
	#__USE_ISOC99
 1

	)

348 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

349 
	#__USE_XOPEN2K8
 1

	)

350 #unde‡
_ATFILE_SOURCE


351 
	#_ATFILE_SOURCE
 1

	)

354 #ifdef 
_XOPEN_SOURCE


355 
	#__USE_XOPEN
 1

	)

356 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

357 
	#__USE_XOPEN_EXTENDED
 1

	)

358 
	#__USE_UNIX98
 1

	)

359 #unde‡
_LARGEFILE_SOURCE


360 
	#_LARGEFILE_SOURCE
 1

	)

361 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

362 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

363 
	#__USE_XOPEN2K8
 1

	)

364 
	#__USE_XOPEN2K8XSI
 1

	)

366 
	#__USE_XOPEN2K
 1

	)

367 
	#__USE_XOPEN2KXSI
 1

	)

368 #unde‡
__USE_ISOC95


369 
	#__USE_ISOC95
 1

	)

370 #unde‡
__USE_ISOC99


371 
	#__USE_ISOC99
 1

	)

374 #ifde‡
_XOPEN_SOURCE_EXTENDED


375 
	#__USE_XOPEN_EXTENDED
 1

	)

380 #ifde‡
_LARGEFILE_SOURCE


381 
	#__USE_LARGEFILE
 1

	)

384 #ifde‡
_LARGEFILE64_SOURCE


385 
	#__USE_LARGEFILE64
 1

	)

388 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

389 
	#__USE_FILE_OFFSET64
 1

	)

392 
	~<„©uªs-time64.h
>

394 #i‡
deföed
 
_DEFAULT_SOURCE


395 
	#__USE_MISC
 1

	)

398 #ifdef 
_ATFILE_SOURCE


399 
	#__USE_ATFILE
 1

	)

402 #ifdef 
_DYNAMIC_STACK_SIZE_SOURCE


403 
	#__USE_DYNAMIC_STACK_SIZE
 1

	)

406 #ifdef 
_GNU_SOURCE


407 
	#__USE_GNU
 1

	)

410 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0

411 #i‡!
deföed
 
__OPTIMIZE__
 || __OPTIMIZE__ <= 0

412 #ñi‡!
__GNUC_PREREQ
 (4, 1)

413 #ñi‡
_FORTIFY_SOURCE
 > 2 && (
__glibc_˛™g_¥îeq
 (9, 0) \

414 || 
	$__GNUC_PREREQ
 (12, 0))

416 #i‡
_FORTIFY_SOURCE
 > 3

418 
	#__USE_FORTIFY_LEVEL
 3

	)

419 #ñi‡
_FORTIFY_SOURCE
 > 1

420 #i‡
_FORTIFY_SOURCE
 > 2

422 
	#__USE_FORTIFY_LEVEL
 2

	)

424 
	#__USE_FORTIFY_LEVEL
 1

	)

427 #i‚de‡
__USE_FORTIFY_LEVEL


428 
	#__USE_FORTIFY_LEVEL
 0

	)

435 #i‡
deföed
 
__˝lu•lus
 ? __˝lu•lu†>201402L : deföed 
__USE_ISOC11


436 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

438 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

453 #i‡(
deföed
 
__USE_GNU
 \

454 && (
deföed
 
__˝lu•lus
 \

455 ? (
__˝lu•lus
 < 201103L && !
deföed
 
__GXX_EXPERIMENTAL_CXX0X__
) \

456 : (!
deföed
 
__STDC_VERSION__
 || __STDC_VERSION__ < 199901L)))

457 
	#__GLIBC_USE_DEPRECATED_SCANF
 1

	)

459 
	#__GLIBC_USE_DEPRECATED_SCANF
 0

	)

464 
	~<°dc-¥edef.h
>

472 #unde‡
__GNU_LIBRARY__


473 
	#__GNU_LIBRARY__
 6

	)

477 
	#__GLIBC__
 2

	)

478 
	#__GLIBC_MINOR__
 35

	)

480 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

481 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

484 #i‚de‡
__ASSEMBLER__


485 #i‚de‡
_SYS_CDEFS_H


486 
	~<sys/cdefs.h
>

491 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


492 
	#__USE_LARGEFILE
 1

	)

493 
	#__USE_LARGEFILE64
 1

	)

499 #i‡
	`__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

500 && !
deföed
 
__OPTIMIZE_SIZE__
 && !deföed 
__NO_INLINE__
 \

501 && 
deföed
 
__exã∫_ölöe


502 
	#__USE_EXTERN_INLINES
 1

	)

510 
	~<gnu/°ubs.h
>

	@/usr/include/features-time64.h

20 
	~<bôs/w‹dsize.h
>

21 
	~<bôs/timesize.h
>

23 #i‡
deföed
 
_TIME_BITS


24 #i‡
_TIME_BITS
 == 64

25 #i‡! 
deföed
 (
_FILE_OFFSET_BITS
) || _FILE_OFFSET_BITS != 64

27 #ñi‡
__TIMESIZE
 == 32

28 
	#__USE_TIME_BITS64
 1

	)

30 #ñi‡
_TIME_BITS
 == 32

31 #i‡
__TIMESIZE
 > 32

35 #îr‹ 
InvÆid
 
_TIME_BITS
 
vÆue
 (
ˇn
 
⁄ly
 
be
 32 
‹
 64-
bô
)

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

39 
	#__STDC_IEC_60559_BFP__
 201404L

	)

42 
	#__STDC_IEC_559__
 1

	)

43 
	#__STDC_IEC_60559_BFP__
 201404L

	)

46 #ifde‡
__GCC_IEC_559_COMPLEX


47 #i‡
__GCC_IEC_559_COMPLEX
 > 0

48 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_60559_COMPLEX__
 201404L

	)

52 
	#__STDC_IEC_559_COMPLEX__
 1

	)

53 
	#__STDC_IEC_60559_COMPLEX__
 201404L

	)

62 
	#__STDC_ISO_10646__
 201706L

	)

	@
1
.
1
/usr/include
59
1010
balloc.c
balloc.h
bbuild.c
checksum.c
dax.c
dir.c
file.c
gc.c
inode.c
inode.h
ioctl.c
journal.c
journal.h
log.c
log.h
mprotect.c
mprotect.h
namei.c
nova.h
nova_def.h
parity.c
perf.c
perf.h
rebuild.c
snapshot.c
snapshot.h
stats.c
stats.h
super.c
super.h
symlink.c
sysfs.c
/usr/include/linux/capability.h
/usr/include/linux/falloc.h
/usr/include/linux/fs.h
/usr/include/linux/magic.h
/usr/include/linux/module.h
/usr/include/linux/mount.h
/usr/include/linux/random.h
/usr/include/linux/rtc.h
/usr/include/linux/sched.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/version.h
/usr/include/linux/const.h
/usr/include/linux/fscrypt.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/time_types.h
/usr/include/string.h
/usr/include/linux/stddef.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/features-time64.h
/usr/include/stdc-predef.h
